<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/21/some-tests-about-perl" title="perl小测试题(转自CU)" rel="bookmark">perl小测试题(转自CU)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-21 00:00:00 +0800">21 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>原贴地址：http://bbs.chinaunix.net/thread-3563215-1-1.html
flw回帖里有翻译，我试答如下：
1. Perl 5 中变量名开头的那个字符（sigils）有哪几种、分别都有什么含义？
$标量@数组%散列&amp;函数
2. 访问一个数组元素时，用 $items[$index] 和用 @items[$index] 有什么区别？
$是标量，@是数组切片
3. 请问 == 和 eq 之间的区别是什么？
分别是数值和字符的比较
4. 在列表上下文中对一个 hash 求值，会得到什么？
应该是得到一个数组？
5. 如何查看关键字的 Perl 文档？
perldoc -f 
6. Perl 5 中的函数和方法有什么不同？
方法是bless后的函数调用？
7. Perl 5 什么时候对一个变量所使用的内存进行回收？
引用计数器清空后？（好像记得是）或者执行完成退出的时候
8. 如何做才能够确保一个变量的缺省作用域是词法作用域？
my local？
9. 如何加载模块并且从中导入符号？
use Module;
符号是啥？
10. 是什么在控制 Perl 如何加载模块？有什么办法可以指定一个目录清单告诉 Perl 从这些地方尝试加载模块？
不知道。
use lib qw();或者perl -I或者export PERL5LIB=
11. 你怎么在 Perl 5 的文档中中查看一条错误信息说明？（加分项：了解如何为所有遇到过的错误信息启用解释）
汗，这个用|less然后/搜索……有好办法么？
12. 试着阐述一下把数组传递给函数的时候会发生什么事。
应该是复制一个数组副本出来，然后赋值到@<em>给函数用？
13. 如何传递多个独立的数组给函数？
分别传递数组引用。
14. 对于调用方来说，return 和 return undef 有什么区别？
return的应该是上一个的结果吧？
15. Where do tests go in a standard CPAN distribution?
module里头都有t/目录可以test吧，然后cpan.org上有志愿者？
16. 拿到一个 CPAN 模块后怎样进行测试？
make test
17. 你用什么命令从 CPAN 上安装新模块？
cpanm Module
18. 为什么要使用 open 函数的三参数形式？
预防文件名带有&gt;等特殊字符串
19. 如何检测（和报告）像 open 这样的系统调用产生的错误？（加分项: 知道如何开启自动检测和报告）
在open的时候接上or die $@；
use autodie;
20. 如何在 Perl 5 中抛出一个异常？
die
21. 如何在 Perl 5 中捕获一个异常？
eval {}
22. 用 for 读文件和用 while 读文件有什么不同吗？
for一次性读入；while一次一行
23. 在 Perl 5 的函数或者方法中，你分别是如何处理参数的？
my $abc = shift;
my ($abc, $def) = @</em>;
24. my ($value) = @_; 中的小括号有什么用？如果删掉会发生什么？
强制为列表环境；
删掉之后变成标量环境就是@_的元素个数了。
25. new 是 Perl 5 的内置函数或者关键字吗？
不是，模块里要自己写new方法。
26. 你怎么看 Perl 的核心模块的文档？如果是 CPAN 模块的话又该如何看？
perldoc查看，不过核心模块和一般模块方法有区别么？
27. 怎样只访问 hash 的值？
values函数</p>
      <a href="/2011/07/21/some-tests-about-perl" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/08/mysql_history_monitor" title="mysql_history_monitor" rel="bookmark">mysql_history_monitor</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-08 00:00:00 +0800">08 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上篇加了bash_history的监控，这篇说mysql_history的监控。不像bash4，mysql自始至终没有提供过syslog的代码，只能自己通过守护进程去实时获取~/.mysql_history的记录了。一个小脚本如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="n">POE</span> <span class="sx">qw(Wheel::FollowTail)</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Log::Syslog::</span><span class="n">Fast</span> <span class="sx">qw(:all)</span><span class="p">;</span>
<span class="nb">defined</span><span class="p">(</span><span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="nb">fork</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cant fork:$!&quot;</span><span class="p">;</span>
<span class="k">unless</span><span class="p">(</span><span class="nv">$pid</span><span class="p">){</span>  
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
         <span class="nb">exit</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="nn">POE::</span><span class="n">Session</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span>
    <span class="n">inline_states</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="n">_start</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]{</span><span class="n">tailor</span><span class="p">}</span> <span class="o">=</span> <span class="nn">POE::Wheel::</span><span class="n">FollowTail</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
          <span class="n">Filename</span> <span class="o">=&gt;</span> <span class="s">&quot;/root/.mysql_history&quot;</span><span class="p">,</span>
          <span class="n">InputEvent</span> <span class="o">=&gt;</span> <span class="s">&quot;got_log_line&quot;</span><span class="p">,</span>
          <span class="n">ResetEvent</span> <span class="o">=&gt;</span> <span class="s">&quot;got_log_rollover&quot;</span><span class="p">,</span>
        <span class="p">);</span>
      <span class="p">},</span>
      <span class="n">got_log_line</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
<span class="c1">#通过Data::Dumper看到实际是$_[10]，不过在POE::Session里定义了sub ARG0 () { 10 };这样写起来简单了</span>
        <span class="n">to_rsyslog</span><span class="p">(</span><span class="nv">$_</span><span class="p">[</span><span class="n">ARG0</span><span class="p">]);</span>
      <span class="p">},</span>
      <span class="n">got_log_rollover</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="n">to_rsyslog</span><span class="p">(</span><span class="s">&#39;roll&#39;</span><span class="p">);</span>
      <span class="p">},</span>
    <span class="p">}</span>
<span class="p">);</span>
<span class="nn">POE::</span><span class="n">Kernel</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
<span class="nb">exit</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">to_rsyslog</span> <span class="p">{</span>
  <span class="nv">$message</span> <span class="o">=</span> <span class="nb">join</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="nv">@_</span><span class="p">;</span>
<span class="c1">#rsyslog开的是UDP的514端口；而LOG_LOCAL0和LOG_INFO都是syslog定义的，乱写的话会自动归入kernel | alert</span>
  <span class="k">my</span> <span class="nv">$logger</span> <span class="o">=</span> <span class="nn">Log::Syslog::</span><span class="n">Fast</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="n">LOG_UDP</span><span class="p">,</span> <span class="s">&quot;10.0.0.123&quot;</span><span class="p">,</span> <span class="mi">514</span><span class="p">,</span> <span class="n">LOG_LOCAL0</span><span class="p">,</span> <span class="n">LOG_INFO</span><span class="p">,</span> <span class="s">&quot;mysql_231&quot;</span><span class="p">,</span> <span class="s">&quot;mysql_monitor&quot;</span><span class="p">);</span>
  <span class="nv">$logger</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="nv">$message</span> <span class="p">,</span><span class="nb">time</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>当然，mysql的history其实不止一个位置，需要判断~</p>
      <a href="/2011/07/08/mysql_history_monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/08/bash_syslog_history" title="bash_syslog_history" rel="bookmark">bash_syslog_history</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-08 00:00:00 +0800">08 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>@钚钉钬影 童鞋要试验系统日志收集处理，采用rsyslog+loganalyzer做界面，因为需求有把bash_history也带上，所以采用修改bash源码的方式。最先采用了bash4.2（bash4.2已经带了这个功能，但是默认不开启，删掉哪个/**/就行了），不过因为这个bash4.+跟redhat的network-functions脚本有点小矛盾，重启的时候报个错——虽然改起来也很简单，就是加一个./的事情——不过本着尽量改动少的原则，换回bash3.1。
bash3.1里默认没有记录syslog的代码，所以从bash4.2/bashhist.c里复制有关bash_syslog_history代码段到bash3.1中——注意不是原样复制到bashhist.c，那样不顶用——需要复制到lib/readline/history.c中，如下：</p>
<div class="highlight"><pre><code class="c"><span class="o">+</span>   <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">syslog</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="err">……</span>
<span class="kt">void</span>
<span class="n">add_history</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span>
     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>
<span class="p">{</span>
<span class="n">HIST_ENTRY</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
<span class="o">+</span><span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">600</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>   <span class="n">syslog</span><span class="p">(</span><span class="n">LOG_LOCAL5</span> <span class="o">|</span> <span class="n">LOG_INFO</span><span class="p">,</span> <span class="s">&quot;%s %s %s %s&quot;</span><span class="p">,</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;LOGNAME&quot;</span><span class="p">),</span><span class="n">getlogin</span><span class="p">(),</span><span class="n">ttyname</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">string</span><span class="p">);</span>
<span class="o">+</span>    <span class="p">}</span>
<span class="o">+</span>    <span class="k">else</span> <span class="p">{</span>
<span class="o">+</span>      <span class="kt">char</span> <span class="n">trunc</span><span class="p">[</span><span class="mi">600</span><span class="p">];</span>
<span class="o">+</span>      <span class="n">strncpy</span><span class="p">(</span><span class="n">trunc</span><span class="p">,</span><span class="n">string</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">trunc</span><span class="p">));</span>
<span class="o">+</span>      <span class="n">trunc</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">trunc</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="o">+</span>    <span class="n">syslog</span><span class="p">(</span><span class="n">LOG_LOCAL5</span><span class="p">,</span> <span class="n">LOG_INFO</span><span class="p">,</span> <span class="s">&quot;%s %s %s %s(++TRUNC)&quot;</span><span class="p">,</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;LOGNAME&quot;</span><span class="p">),</span><span class="n">getlogin</span><span class="p">(),</span><span class="n">ttyname</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">trunc</span><span class="p">);</span>
<span class="o">+</span>    <span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">history_stifled</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">history_length</span> <span class="o">==</span> <span class="n">history_max_entries</span><span class="p">))</span>
</code></pre></div>
<p>上面的LOG_LOCAL5和LOG_INFO都是syslog.h里的定义，所以要include进来。
然后编译使用，就能记录进/var/log/messages里了。</p>
<hr />
<p>话说网上关于上面的说明中，大多数没有提到需要include<syslog.h>，但是make的时候居然只报LOG_INFO和LOG_LOCAL5的未定义错误，随便把这两个改成一个已经defined过的变量，比如HISTORY，编译一样成功；而且也一样记录系统日志。唯一体现不同的地方就是loganalyzer页面上看到所有的history操作都是alert级别。
之前没了解过程的时候，还采用了mysql触发器，自动修改这个报警级别，也记录一下，毕竟是自己第一次用触发器~~</syslog.h></p>
<div class="highlight"><pre><code class="mysql"><span class="k">USE</span> <span class="n">Syslog</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TRIGGER</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">trig_bash_prior</span><span class="p">;</span>
<span class="n">DELIMITER</span> <span class="o">|</span>
<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">trig_bash_prior</span> <span class="k">BEFORE</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="n">Syslog</span><span class="p">.</span><span class="n">SystemEvents</span>
 <span class="k">FOR</span> <span class="k">EACH</span> <span class="n">ROW</span> <span class="n">BEGIN</span>
  <span class="k">IF</span> <span class="n">NEW</span><span class="p">.</span><span class="n">SysLogTag</span><span class="o">=</span><span class="s1">&#39;-bash:&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">NEW</span><span class="p">.</span><span class="n">Priority</span><span class="o">=</span><span class="s1">&#39;1&#39;</span> <span class="k">THEN</span>
   <span class="kt">SET</span> <span class="n">NEW</span><span class="p">.</span><span class="n">Priority</span><span class="o">=</span><span class="s1">&#39;6&#39;</span><span class="p">;</span>
  <span class="n">END</span> <span class="k">IF</span><span class="p">;</span>
 <span class="n">END</span>
<span class="o">|</span>
</code></pre></div>
<p>这个库很简单，基本数据就是记在这个单表里~~</p>
      <a href="/2011/07/08/bash_syslog_history" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/28/a-dancer-demo-of-monitor-squid" title="squid监控+dancer小试验" rel="bookmark">squid监控+dancer小试验</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-28 00:00:00 +0800">28 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>squid监控之前有一篇关于snmp的内容，不过这次是真要用上了，所以细细挑出来几个做监控。碰巧凯哥更新了一把modern perl的东西，我亦步亦趋，也试试dancer。不过花了两天时间，DBIx::Class::Schema还是没搞出来，最终还是简单的用DBI跳过了……
用的database就是之前nmap试验时生成的数据，有application/channel/intranet等column。
首先安装：</p>
<div class="highlight"><pre><code class="perl"><span class="n">cpanm</span> <span class="n">Dancer</span> <span class="n">DBI</span> <span class="n">DBD:mysql</span> <span class="n">Template</span> <span class="nn">Dancer::Session::</span><span class="n">YAML</span>
<span class="n">dancer</span> <span class="o">-</span><span class="n">a</span> <span class="n">cachemoni</span>
</code></pre></div>
<p>然后修改cachemoni/lib/cachemoni.pm如下：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="n">cachemoni</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">Database</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Net::</span><span class="n">SNMP</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Digest::</span><span class="n">MD5</span> <span class="sx">qw(md5_hex)</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$VERSION</span> <span class="o">=</span> <span class="s">&#39;0.1&#39;</span><span class="p">;</span>
<span class="n">get</span> <span class="s">&#39;/monitor&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$app</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">app</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;squid&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="s">&#39;Only support squid now&#39;</span> <span class="k">unless</span> <span class="nv">$app</span> <span class="ow">eq</span> <span class="s">&#39;squid&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$checkstat</span> <span class="o">=</span> <span class="n">_snmp_check</span><span class="p">(</span><span class="nv">$app</span><span class="p">);</span>
    <span class="n">template</span> <span class="s">&#39;monitor&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">status</span> <span class="o">=&gt;</span> <span class="nv">$checkstat</span><span class="p">,</span>
                          <span class="n">name</span>   <span class="o">=&gt;</span> <span class="p">[</span><span class="s">&#39;IP地址&#39;</span><span class="p">,</span><span class="s">&#39;流量命中率&#39;</span><span class="p">,</span><span class="s">&#39;请求数命中率&#39;</span><span class="p">,</span><span class="s">&#39;回源请求响应毫秒&#39;</span><span class="p">,</span><span class="s">&#39;当前客户端数&#39;</span><span class="p">,</span><span class="s">&#39;剩余文件描述符数&#39;</span><span class="p">,</span><span class="s">&#39;已缓存文件数&#39;</span><span class="p">,</span><span class="s">&#39;平均每秒请求数&#39;</span><span class="p">],</span>
                        <span class="p">};</span>
<span class="p">};</span>
<span class="n">any</span><span class="p">[</span><span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="s">&#39;post&#39;</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="s">&#39;/login&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$err</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">()</span> <span class="ow">eq</span> <span class="s">&#39;POST&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">username</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$passwd</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">password</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span>
            <span class="s">&#39;select audit,passwd from ops_user where name = ?&#39;</span>
        <span class="p">);</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchrow_arrayref</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$ref</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">redirect</span> <span class="s">&#39;/register&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">ne</span> <span class="s">&#39;yes&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$err</span> <span class="o">=</span> <span class="s">&#39;你的帐户还没通过审核&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="n">md5_hex</span><span class="p">(</span><span class="s">&quot;$passwd&quot;</span><span class="p">)</span> <span class="ow">ne</span> <span class="s">&quot;$ref-&gt;[1]&quot;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$err</span> <span class="o">=</span> <span class="s">&#39;密码错误&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">session</span> <span class="s">&#39;logged_in&#39;</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">;</span>
            <span class="n">redirect</span> <span class="s">&#39;/&#39;</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="n">template</span> <span class="s">&#39;login&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#39;err&#39;</span> <span class="o">=&gt;</span> <span class="nv">$err</span><span class="p">,</span> <span class="p">};</span>
<span class="p">};</span>
<span class="n">any</span><span class="p">[</span><span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="s">&#39;post&#39;</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="s">&#39;/register&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$err</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">()</span> <span class="ow">eq</span> <span class="s">&#39;POST&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">username</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$passwd</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">password</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$check_sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span>
            <span class="s">&#39;select count(name) from ops_user where name = ?&#39;</span>
        <span class="p">);</span>
        <span class="nv">$check_sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$check_sth</span><span class="o">-&gt;</span><span class="n">fetchrow_arrayref</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="s">&quot;$ref-&gt;[0]&quot;</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$insert_sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span>
                <span class="s">&#39;insert into ops_user (name,passwd) value(?,?)&#39;</span>
            <span class="p">);</span>
            <span class="nv">$insert_sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="n">md5_hex</span><span class="p">(</span><span class="nv">$passwd</span><span class="p">));</span>
            <span class="nv">$err</span> <span class="o">=</span> <span class="s">&#39;等待人工审核通过,3Q&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$err</span> <span class="o">=</span> <span class="s">&#39;该用户名已注册&#39;</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="n">template</span> <span class="s">&#39;register&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#39;err&#39;</span> <span class="o">=&gt;</span> <span class="nv">$err</span><span class="p">,</span> <span class="p">};</span>
<span class="p">};</span>
<span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">template</span> <span class="s">&#39;index&#39;</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">get</span> <span class="s">&#39;/logout&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">session</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">;</span>
    <span class="n">redirect</span> <span class="s">&#39;/&#39;</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">_snmp_check</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$app</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$list</span> <span class="o">=</span> <span class="p">{};</span>
<span class="c1">#之前通过use加载了plugin::database，所以直接有database对象引用了</span>
    <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span>
        <span class="s">&#39;select channel,intranet from myhost where application = ?&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$app</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$list</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$ref-&gt;{&#39;channel&#39;}&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span> <span class="k">unless</span> <span class="nb">exists</span> <span class="nv">$list</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$ref-&gt;{&#39;channel&#39;}&quot;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;intranet&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">@snmpstat</span> <span class="o">=</span> <span class="n">_snmp_walk</span><span class="p">(</span><span class="s">&quot;$ip&quot;</span><span class="p">);</span>
<span class="c1">#这里第一是没想到比较好的把每个ip的各项检查结果导出的办法；所以干脆采用固定次序输出；</span>
<span class="c1">#第二是因为unshift很耗资源，所以先push再reverse</span>
        <span class="nb">push</span> <span class="nv">@snmpstat</span><span class="p">,</span> <span class="nv">$ip</span><span class="p">;</span>
        <span class="nv">@snmpstat</span> <span class="o">=</span> <span class="nb">reverse</span> <span class="nv">@snmpstat</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$list</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$ref-&gt;{&#39;channel&#39;}&quot;</span><span class="p">}},</span> <span class="o">\</span><span class="nv">@snmpstat</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">push</span> <span class="k">my</span> <span class="nv">@checkstat</span><span class="p">,</span> <span class="nb">map</span><span class="p">{</span>
        <span class="p">{</span> <span class="n">channel</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="p">,</span>
          <span class="n">host</span>    <span class="o">=&gt;</span> <span class="nv">$list</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$_&quot;</span><span class="p">},</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$list</span><span class="p">};</span>
    <span class="k">return</span> <span class="o">\</span><span class="nv">@checkstat</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">_snmp_walk</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$o_host</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$o_community</span> <span class="o">=</span> <span class="s">&#39;public&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$result</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">my</span> <span class="nv">%oids</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s">&#39;cacheUptime&#39;</span>                  <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.1.3.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheProtoClientHttpRequests&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.2.1.1.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheNumObjCount&#39;</span>             <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.1.7.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheCurrentUnusedFDescrCnt&#39;</span>  <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.1.10.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheClients&#39;</span>                 <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.2.1.15.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheHttpMissSvcTime&#39;</span>         <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.2.2.1.3.1&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheRequestHitRatio&#39;</span>         <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.2.2.1.9.1&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheRequestByteRatio&#39;</span>        <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.2.2.1.10.1&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$session</span><span class="p">,</span> <span class="nv">$error</span><span class="p">)</span> <span class="o">=</span> <span class="nn">Net::</span><span class="n">SNMP</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">(</span>
        <span class="o">-</span><span class="n">hostname</span>  <span class="o">=&gt;</span> <span class="nv">$o_host</span><span class="p">,</span>
        <span class="o">-</span><span class="n">community</span> <span class="o">=&gt;</span> <span class="nv">$o_community</span><span class="p">,</span>
<span class="c1">#默认是5秒超时，如果有没开snmp的，这页面打开时间一下就上去了，所以要调短</span>
        <span class="o">-</span><span class="n">timeout</span>   <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$session</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$session</span><span class="o">-&gt;</span><span class="n">translate</span><span class="p">(</span><span class="nn">Net::</span><span class="n">SNMP</span><span class="o">-&gt;</span><span class="n">TRANSLATE_NONE</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$squid_status</span> <span class="o">=</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="n">get_request</span><span class="p">(</span> <span class="o">-</span><span class="n">varbindlist</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheUptime&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheProtoClientHttpRequests&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheNumObjCount&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheCurrentUnusedFDescrCnt&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheClients&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheHttpMissSvcTime&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheRequestHitRatio&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheRequestByteRatio&#39;</span><span class="p">},</span> <span class="p">],</span> <span class="p">);</span>
        <span class="nv">$session</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$squid_status</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">#如果要算当前的rps，那得sleep 1再取一次，对几十台集群监控来说不可取；</span>
<span class="c1">#姑且用总的平均值做个衡量，或许可以采用二八法则估算一个高峰时间的rps；</span>
<span class="c1">#注意这个cacheUptime是保留两位ms的，所以算rps的时候要除以100；</span>
<span class="c1">#上述原因也是一般大家对单机squid监控采用rrd的原因，采用COUNTER32数据源，直接递增显示。</span>
            <span class="k">my</span> <span class="nv">$request_sum</span> <span class="o">=</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheProtoClientHttpRequests&#39;}&quot;</span><span class="p">};</span>
            <span class="k">my</span> <span class="nv">$uptime</span> <span class="o">=</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheUptime&#39;}&quot;</span><span class="p">};</span>
            <span class="k">return</span> <span class="nv">$request_sum</span> <span class="o">/</span> <span class="nv">$uptime</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheNumObjCount&#39;}&quot;</span><span class="p">},</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheCurrentUnusedFDescrCnt&#39;}&quot;</span><span class="p">},</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheClients&#39;}&quot;</span><span class="p">},</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheHttpMissSvcTime&#39;}&quot;</span><span class="p">},</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheRequestHitRatio&#39;}&quot;</span><span class="p">},</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheRequestByteRatio&#39;}&quot;</span><span class="p">};</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>修改cachemoni/config.yml如下：</p>
<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">appname</span><span class="p-Indicator">:</span> <span class="s">&quot;cachemoni&quot;</span>
<span class="l-Scalar-Plain">layout</span><span class="p-Indicator">:</span> <span class="s">&quot;main&quot;</span>
<span class="l-Scalar-Plain">charset</span><span class="p-Indicator">:</span> <span class="s">&quot;UTF-8&quot;</span>
<span class="c1">#采用TT作为view模板，注意tt默认是[%%]，而dancer里是&lt;%%&gt;，所以另外要定义标签</span>
<span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="s">&quot;template_toolkit&quot;</span>
<span class="l-Scalar-Plain">engines</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">template_toolkit</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span>  <span class="s">&#39;utf8&#39;</span>
    <span class="l-Scalar-Plain">start_tag</span><span class="p-Indicator">:</span> <span class="s">&#39;[%&#39;</span>
    <span class="l-Scalar-Plain">end_tag</span><span class="p-Indicator">:</span>   <span class="s">&#39;%]&#39;</span>
<span class="c1">#用默认的Simple，即存在内存的一个hash里，实际效果很不稳定，改用yaml，但也有yml文件在关闭浏览器后依旧存在的问题。</span>
<span class="l-Scalar-Plain">session</span><span class="p-Indicator">:</span> <span class="s">&quot;YAML&quot;</span>
<span class="l-Scalar-Plain">session_dir</span><span class="p-Indicator">:</span> <span class="s">&quot;/tmp/dancer_session_dir&quot;</span>
<span class="l-Scalar-Plain">session_expires</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">300</span>
<span class="l-Scalar-Plain">plugins</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">Database</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&#39;mysql&#39;</span>
    <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="s">&#39;myops&#39;</span>
    <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="s">&#39;10.1.1.25&#39;</span>
    <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&#39;user&#39;</span>
    <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">&#39;password&#39;</span>
    <span class="l-Scalar-Plain">connection_check_threshold</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
    <span class="l-Scalar-Plain">dbi_params</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">RaiseError</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
      <span class="l-Scalar-Plain">AutoCommit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
    <span class="l-Scalar-Plain">on_connect_do</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;SET</span><span class="nv"> </span><span class="s">NAMES</span><span class="nv"> </span><span class="s">&#39;utf8&#39;&quot;</span><span class="p-Indicator">,</span> <span class="s">&quot;SET</span><span class="nv"> </span><span class="s">CHARACTER</span><span class="nv"> </span><span class="s">SET</span><span class="nv"> </span><span class="s">&#39;utf8&#39;&quot;</span> <span class="p-Indicator">]</span>
    <span class="l-Scalar-Plain">log_queries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</code></pre></div>
<p>创建cachemoni/views/monitor.tt如下：</p>
<div class="highlight"><pre><code class="html">[% IF session.logged_in %]
[% FOREACH stat IN status %]
  <span class="nt">&lt;hr&gt;</span> channel: [% stat.channel %]
  <span class="nt">&lt;table</span> <span class="na">width=</span><span class="s">&quot;100%&quot;</span> <span class="na">cellspacing=</span><span class="s">&quot;0&quot;</span> <span class="na">cellpadding=</span><span class="s">&quot;0&quot;</span> <span class="na">border=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
  [% FOREACH col IN name %] 
    <span class="nt">&lt;th&gt;&lt;center&gt;</span>
    [% col %]
    <span class="nt">&lt;/center&gt;&lt;/th&gt;</span>
  [% END %]
  <span class="nt">&lt;/tr&gt;</span>
  [% FOREACH host IN stat.host %]
    <span class="nt">&lt;tr&gt;</span>
    [% FOREACH list IN host %]
      <span class="nt">&lt;td&gt;</span>
      [% list %]
      <span class="nt">&lt;/td&gt;</span>
    [% END %]
  [% END %]
  <span class="nt">&lt;/tr&gt;&lt;/table&gt;</span>
[% END %]
[% ELSE %]
  内部信息，请登陆后查看
[% END %]
</code></pre></div>
<p>创建cachemoni/views/login.tt如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;center&gt;</span>
<span class="nt">&lt;h2&gt;</span>登陆页面<span class="nt">&lt;/h2&gt;</span>
[% IF err %]<span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">error</span><span class="nt">&gt;&lt;strong&gt;</span>Error:<span class="nt">&lt;/strong&gt;</span> [% err %][% END %]
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/login&quot;</span> <span class="na">method=</span><span class="s">post</span><span class="nt">&gt;</span>
  <span class="nt">&lt;dl&gt;</span>
    <span class="nt">&lt;dt&gt;</span>用户名:
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">text</span> <span class="na">name=</span><span class="s">username</span><span class="nt">&gt;</span>
    <span class="nt">&lt;dt&gt;</span>密  码:
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">password</span> <span class="na">name=</span><span class="s">password</span><span class="nt">&gt;</span>
    <span class="nt">&lt;dd&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">login</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/dl&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/center&gt;</span>
</code></pre></div>
<p>注册页面类似，不贴了。
然后是layout层的共用部分，之前定义了是views/layouts/main.tt，如下：</p>
<div class="highlight"><pre><code class="html">……
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">metanav</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>首页<span class="nt">&lt;/a&gt;</span> | 
  [% IF not session.logged_in %]
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/register&quot;</span><span class="nt">&gt;</span>注册<span class="nt">&lt;/a&gt;</span> | 
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/login&quot;</span><span class="nt">&gt;</span>登陆<span class="nt">&lt;/a&gt;</span>
  [% ELSE %]
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/logout&quot;</span><span class="nt">&gt;</span>退出<span class="nt">&lt;/a&gt;</span>
  [% END %]
[% content %]
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;footer&quot;</span><span class="nt">&gt;</span>
Powered by <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://perldancer.org/&quot;</span><span class="nt">&gt;</span>Dancer<span class="nt">&lt;/a&gt;</span> [% dancer_version %]
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>这里修改了&lt;%%&gt;为[%%]，其他的tt模版也要改。
然后运行perl cachemoni/bin/app.pl，启动3000端口的监听，访问一下如下：
<img src="/images/uploads/squid-monitor-demo.jpg" alt="" title="123" width="571" height="401" class="alignnone size-full wp-image-2505" />&lt;/a&gt;
这就算完成一个小的网页了，然后开始配置进apache：</p>
<div class="highlight"><pre><code class="bash">cpanm Plack::Handler::Apache2
wget http://search.cpan.org/CPAN/authors/id/P/PH/PHRED/mod_perl-2.0.5.tar.gz
tar zxvf mod_perl-2.0.5.tar.gz
<span class="nb">cd </span>mod_perl-2.0.5
perl Makefile.PL
然后会提示输入apxs的全路径：/usr/local/apache2/bin/apxs
make <span class="o">&amp;&amp;</span> make install
sed -i s<span class="err">&#39;</span>/LoadModule/i<span class="se">\L</span>oadModule perl_module modules/mod_perl.so<span class="se">\&#39;</span> /usr/local/apache2/conf/httpd.conf
cat &gt;&gt; /usr/local/apache2/conf/httpd.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">&lt;VirtualHost *:80&gt;</span>
<span class="s">        ServerName dancer.test.china.com</span>
<span class="s">        DocumentRoot /www/html/cachemoni</span>
<span class="s">        &lt;Directory /www/html/cachemoni&gt;</span>
<span class="s">            AllowOverride None</span>
<span class="s">            Order allow,deny</span>
<span class="s">            Allow from all</span>
<span class="s">        &lt;/Directory&gt;</span>
<span class="s">        &lt;Location /&gt;</span>
<span class="s">            SetHandler perl-script</span>
<span class="s">            PerlHandler Plack::Handler::Apache2</span>
<span class="s">            PerlSetVar psgi_app /www/html/cachemoni/bin/app.pl</span>
<span class="s">        &lt;/Location&gt;</span>
<span class="s">&lt;/VirtualHost&gt;</span>
<span class="s">EOF</span>
/usr/local/apache2/bin/apachectl restart
</code></pre></div>
<p>访问一下，OK~
各种和webserver搭配的方法（其实就是两种：mod_perl和各种cgi）详见：<a href="http://search.cpan.org/~sukria/Dancer-1.3060/lib/Dancer/Deployment.pod">CPAN文档</a></p>
      <a href="/2011/06/28/a-dancer-demo-of-monitor-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/23/make-patch-of-squid-snmp" title="patch制作和使用" rel="bookmark">patch制作和使用</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-23 00:00:00 +0800">23 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>做运维几年没用过patch，说来也怪了~~趁着上一篇自己的小改动，熟悉一下这个命令的简单用法。
首先是patch的制作，用diff命令。</p>
<div class="highlight"><pre><code class="bash">tar zxvf squid-2.7.STABLE9.tar.gz
cp squid-2.7.STABLE9 squid-2.7.STABLE9-old <span class="o">&amp;&amp;</span> mv squid-2.7.STABLE9 squid-2.7.STABLE9-new
<span class="c">#然后按照上篇的内容修改squid-2.7.STABLE9-new/里的文件</span>
diff -uNr squid-2.7.STABLE9-old squid-2.7.STABLE9-new &gt; squid-snmp.patch
</code></pre></div>
<p>这就完成了，好简单啊~来看看patch文件的内容吧：</p>
<div class="highlight"><pre><code class="c"><span class="n">diff</span> <span class="o">-</span><span class="n">uNr</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">cache_snmp</span><span class="p">.</span><span class="n">h</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">cache_snmp</span><span class="p">.</span><span class="n">h</span>
<span class="o">---</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">cache_snmp</span><span class="p">.</span><span class="n">h</span>	<span class="mi">2006</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">22</span> <span class="mi">10</span><span class="o">:</span><span class="mi">49</span><span class="o">:</span><span class="mf">24.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="o">+++</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">cache_snmp</span><span class="p">.</span><span class="n">h</span>	<span class="mi">2011</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">23</span> <span class="mi">13</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mf">04.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">125</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">125</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
     <span class="n">MESH_PTBL_KEEPAL_S</span><span class="p">,</span>
     <span class="n">MESH_PTBL_KEEPAL_R</span><span class="p">,</span>
     <span class="n">MESH_PTBL_INDEX</span><span class="p">,</span>
<span class="o">+</span>    <span class="n">MESH_PTBL_CONN_OPEN</span><span class="p">,</span>
     <span class="n">MESH_PTBL_HOST</span><span class="p">,</span>
     <span class="n">MESH_PTBL_END</span>
 <span class="p">};</span>
<span class="n">diff</span> <span class="o">-</span><span class="n">uNr</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_agent</span><span class="p">.</span><span class="n">c</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_agent</span><span class="p">.</span><span class="n">c</span>
<span class="o">---</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_agent</span><span class="p">.</span><span class="n">c</span>	<span class="mi">2009</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">26</span> <span class="mo">06</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mf">10.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="o">+++</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_agent</span><span class="p">.</span><span class="n">c</span>	<span class="mi">2011</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">23</span> <span class="mi">13</span><span class="o">:</span><span class="mi">27</span><span class="o">:</span><span class="mf">31.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">264</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">264</span><span class="p">,</span><span class="mi">11</span> <span class="err">@@</span>
 	    <span class="n">index</span><span class="p">,</span>
 	    <span class="n">ASN_INTEGER</span><span class="p">);</span>
 	<span class="k">break</span><span class="p">;</span>
<span class="o">+</span>    <span class="k">case</span> <span class="n">MESH_PTBL_CONN_OPEN</span>:
<span class="o">+</span>        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new_integer</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">,</span>
<span class="o">+</span>            <span class="n">p</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">conn_open</span><span class="p">,</span>
<span class="o">+</span>            <span class="n">ASN_INTEGER</span><span class="p">);</span>
<span class="o">+</span>        <span class="k">break</span><span class="p">;</span>
     <span class="nl">default:</span>
 	<span class="o">*</span><span class="n">ErrP</span> <span class="o">=</span> <span class="n">SNMP_ERR_NOSUCHNAME</span><span class="p">;</span>
 	<span class="k">break</span><span class="p">;</span>
<span class="n">diff</span> <span class="o">-</span><span class="n">uNr</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_core</span><span class="p">.</span><span class="n">c</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_core</span><span class="p">.</span><span class="n">c</span>
<span class="o">---</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_core</span><span class="p">.</span><span class="n">c</span>	<span class="mi">2008</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">05</span> <span class="mo">07</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span><span class="mf">13.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="o">+++</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_core</span><span class="p">.</span><span class="n">c</span>	<span class="mi">2011</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">23</span> <span class="mi">20</span><span class="o">:</span><span class="mi">36</span><span class="o">:</span><span class="mf">54.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">321</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">321</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
 						<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
 						    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_Inst</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
 					    <span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="o">-</span>						<span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
<span class="o">+</span>						<span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
 						<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
 						    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
 						<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">351</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">351</span><span class="p">,</span><span class="mi">8</span> <span class="err">@@</span>
 						<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
 						    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
 						<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
<span class="o">+</span>                                                    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="o">+</span>                                                <span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
 						    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">))),</span>
 					<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
 					    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
</code></pre></div>
<p>制作练完了，再练一次使用：</p>
<div class="highlight"><pre><code class="bash"><span class="nb">cd </span>squid-2.7.STABLE9-old
mv ../squid-snmp.patch .
patch -p1 &lt; squid-snmp.patch
</code></pre></div>
<p>-p指定从那层目录开始，因为之前diff的时候顶层目录分别叫old和new，如果在其他地方时候的话，别人的目录肯定不会这么命名的，所以就往里进一层，然后用-p1来patch。
然后more一下那三个文件，确认都修改了~
最后回退patch：</p>
<div class="highlight"><pre><code class="bash">patch -R -p1 &lt; squid-snmp.patch
</code></pre></div>
<p>完成~</p>
      <a href="/2011/06/23/make-patch-of-squid-snmp" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/22/extend-open_conn-output-support-to-squid-snmp" title="给squid的snmp增加open_conn输出" rel="bookmark">给squid的snmp增加open_conn输出</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-22 00:00:00 +0800">22 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>做反向代理的squid集群监控，在单机维护时，squidclient mgr:server_list里的OPEN CONNS是经常看的一项数据，不过在开启snmp支持后，在mib里却没有找到相关的数据。还一度怀疑是不是cachePeerKeepAlRecv或者cachePeerKeepSent。今天想起来去src里grep了一把源码，顺利的在squid/src/neighbors.c里看到了OPEN CONNS等数据的来源，如下：</p>
<div class="highlight"><pre><code class="c"><span class="k">static</span> <span class="kt">void</span>
<span class="nf">dump_peers</span><span class="p">(</span><span class="n">StoreEntry</span> <span class="o">*</span> <span class="n">sentry</span><span class="p">,</span> <span class="n">peer</span> <span class="o">*</span> <span class="n">peers</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">peer</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="err">……</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">peers</span><span class="p">;</span> <span class="n">e</span><span class="p">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<span class="err">……</span>
        <span class="n">storeAppendPrintf</span><span class="p">(</span><span class="n">sentry</span><span class="p">,</span> <span class="s">&quot;OPEN CONNS : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">conn_open</span><span class="p">);</span>
<span class="err">……</span>
        <span class="n">storeAppendPrintf</span><span class="p">(</span><span class="n">sentry</span><span class="p">,</span> <span class="s">&quot;keep-alive ratio: %d%%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">percent</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">n_keepalives_recv</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">n_keepalives_sent</span><span class="p">));</span>
</code></pre></div>
<p>然后在squid/src/snmp_agent.c里看到了这些数据的snmp输出，如下：</p>
<div class="highlight"><pre><code class="c"><span class="n">variable_list</span> <span class="o">*</span>
<span class="nf">snmp_meshPtblFn</span><span class="p">(</span><span class="n">variable_list</span> <span class="o">*</span> <span class="n">Var</span><span class="p">,</span> <span class="n">snint</span> <span class="o">*</span> <span class="n">ErrP</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">variable_list</span> <span class="o">*</span><span class="n">Answer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="n">laddr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">loop</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">peer</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="err">……</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">MESH_PTBL_NAME</span>:
        <span class="n">cp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">);</span>
<span class="err">……</span>
    <span class="k">case</span> <span class="n">MESH_PTBL_KEEPAL_R</span>:
        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new_integer</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">,</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">n_keepalives_recv</span><span class="p">,</span>
            <span class="n">SMI_COUNTER32</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">MESH_PTBL_INDEX</span>:
        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new_integer</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">,</span>
            <span class="n">index</span><span class="p">,</span>
            <span class="n">ASN_INTEGER</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
        <span class="o">*</span><span class="n">ErrP</span> <span class="o">=</span> <span class="n">SNMP_ERR_NOSUCHNAME</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">Answer</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>一对比，发现确实没有stats.conn_open输出……
好在这个比较简单，稍微改一下，就能搞出来：
1、修改squid/include/cache_snmp.h如下：</p>
<div class="highlight"><pre><code class="c"><span class="k">enum</span> <span class="p">{</span>                          <span class="cm">/* cachePeerTable */</span>
<span class="err">……</span>
    <span class="n">MESH_PTBL_CONN_OPEN</span><span class="p">,</span>   <span class="cm">/*新增这个*/</span>
    <span class="n">MESH_PTBL_HOST</span><span class="p">,</span>
    <span class="n">MESH_PTBL_END</span>
<span class="p">};</span>
</code></pre></div>
<p>2、修改squid/src/snmp_core.c如下：</p>
<div class="highlight"><pre><code class="c"><span class="kt">void</span>
<span class="nf">snmpInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="err">……</span>
                                            <span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="cm">/* LEN_SQ_MESH + 2, NULL, NULL, 15,这里改成16，大概在324行，通过原来的MIB知道有15的地方就两个，peer的是后一个 */</span>
                                                <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
<span class="err">……</span>
                                                <span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
                                                    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                                <span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="cm">/*新增这个16*/</span>
                                                    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">))),</span>
</code></pre></div>
<p>3、修改squid/src/snmp_agent.c如下：</p>
<div class="highlight"><pre><code class="c"><span class="err">……</span>
    <span class="k">case</span> <span class="n">MESH_PTBL_INDEX</span>:
        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new_integer</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">,</span>
            <span class="n">index</span><span class="p">,</span>
            <span class="n">ASN_INTEGER</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
<span class="cm">/*新增下面这段，case的内容在第1步cache_snmp.h里增加了；stats.conn_open由之前grep的结果得知；INTEGER是数值类型，照抄RTT的即可*/</span>
    <span class="k">case</span> <span class="n">MESH_PTBL_CONN_OPEN</span>:
        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new_integer</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">,</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">conn_open</span><span class="p">,</span>
            <span class="n">ASN_INTEGER</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
</code></pre></div>
<p>4、重新编译squid，然后用snmpwalk获取数据观察：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@naigos myops<span class="o">]</span><span class="c"># snmpwalk -v 2c -c cacti_china 10.168.168.69 .1.3.6.1.4.1.3495.1.5.1.2  -Cc  | tail</span>
SNMPv2-SMI::enterprises.3495.1.5.1.2.13.3 <span class="o">=</span> Counter32: 0
SNMPv2-SMI::enterprises.3495.1.5.1.2.14.1 <span class="o">=</span> INTEGER: 1
SNMPv2-SMI::enterprises.3495.1.5.1.2.14.2 <span class="o">=</span> INTEGER: 2
SNMPv2-SMI::enterprises.3495.1.5.1.2.14.3 <span class="o">=</span> INTEGER: 3
SNMPv2-SMI::enterprises.3495.1.5.1.2.15.1 <span class="o">=</span> INTEGER: 3
SNMPv2-SMI::enterprises.3495.1.5.1.2.15.2 <span class="o">=</span> INTEGER: 5
SNMPv2-SMI::enterprises.3495.1.5.1.2.15.3 <span class="o">=</span> INTEGER: 6
SNMPv2-SMI::enterprises.3495.1.5.1.2.16.1 <span class="o">=</span> STRING: <span class="s2">&quot;10.168.170.43&quot;</span>
SNMPv2-SMI::enterprises.3495.1.5.1.2.16.2 <span class="o">=</span> STRING: <span class="s2">&quot;10.168.168.73&quot;</span>
SNMPv2-SMI::enterprises.3495.1.5.1.2.16.3 <span class="o">=</span> STRING: <span class="s2">&quot;10.168.168.122&quot;</span>
</code></pre></div>
<p>原来的SNMPv2-SMI::enterprises.3495.1.5.1.2.15.1 = STRING: &ldquo;10.168.170.43&rdquo;变成了SNMPv2-SMI::enterprises.3495.1.5.1.2.16.1 = STRING: &ldquo;10.168.170.43&rdquo;，而SNMPv2-SMI::enterprises.3495.1.5.1.2.15.1 = INTEGER: 3就是需要的open_conn数据了！</p>
      <a href="/2011/06/22/extend-open_conn-output-support-to-squid-snmp" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/14/intro-mybench" title="mysql测试小工具mybench试用" rel="bookmark">mysql测试小工具mybench试用</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-14 00:00:00 +0800">14 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#testing-ref" title="testing" rel="category tag">testing</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>小型的mysql测试工具，主要有自带的mysqlslap、super-smack和mybench。嗯，我这里的小型的意思是指工具安装过程简单。
mysqlslap的使用方法遍地都是，就不先详细写了。根据个人偏好写写mybench吧，毕竟是perl的。
安装很简单，如下：</p>
<div class="highlight"><pre><code class="bash">cpanm DBI DBD::mysql Time::HiRes
wget http://jeremy.zawodny.com/mysql/mybench/mybench-1.0.tar.gz
tar zxvf mybench-1.0.tar.gz
<span class="nb">cd </span>mybench-1.0
perl MakeFile.PL <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make install
</code></pre></div>
<p>但是使用就不是太简单了——mysqlslap会自己生成（-a选项）sql，super-smack则带了一个gen-data程序生成数据然后自动导入，但是mybench没有，所以只能自己搞定数据。
不过mybench还是自己生成了一个测试模版的脚本在/usr/bin/bench_example，很简单的就知道怎么做了。
example如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="nb">eval</span> <span class="s">&#39;exec /usr/bin/perl -w -S $0 ${1+&quot;$@&quot;}&#39;</span>
    <span class="k">if</span> <span class="mi">0</span><span class="p">;</span> <span class="c1"># not running under some shell</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">MyBench</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Std</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Time::</span><span class="n">HiRes</span> <span class="sx">qw(gettimeofday tv_interval)</span><span class="p">;</span>
<span class="k">use</span> <span class="n">DBI</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%opt</span><span class="p">;</span>
<span class="nn">Getopt::Std::</span><span class="n">getopt</span><span class="p">(</span><span class="s">&#39;n:r:h:&#39;</span><span class="p">,</span> <span class="o">\</span><span class="nv">%opt</span><span class="p">);</span>
<span class="c1">#这是我见过的最hardcode的perl脚本了（呃，除了我自己写的垃圾），连db库、用户名、密码都不给运行参数的</span>
<span class="k">my</span> <span class="nv">$num_kids</span>  <span class="o">=</span> <span class="nv">$opt</span><span class="p">{</span><span class="n">n</span><span class="p">}</span> <span class="o">||</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$num_runs</span>  <span class="o">=</span> <span class="nv">$opt</span><span class="p">{</span><span class="n">r</span><span class="p">}</span> <span class="o">||</span> <span class="mi">100</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$db</span>        <span class="o">=</span> <span class="s">&quot;test&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$user</span>      <span class="o">=</span> <span class="s">&quot;test&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$pass</span>      <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$port</span>      <span class="o">=</span> <span class="mi">3306</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$host</span>      <span class="o">=</span> <span class="nv">$opt</span><span class="p">{</span><span class="n">h</span><span class="p">}</span> <span class="o">||</span> <span class="s">&quot;192.168.0.1&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$dsn</span>       <span class="o">=</span> <span class="s">&quot;DBI:mysql:$db:$host;port=$port&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$callback</span> <span class="o">=</span> <span class="k">sub</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$id</span>  <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$dbh</span> <span class="o">=</span> <span class="n">DBI</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span><span class="nv">$dsn</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$pass</span><span class="p">,</span> <span class="p">{</span> <span class="n">RaiseError</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">});</span>
<span class="c1">#为测试准备的请求，测select就写select，测insert就写insert呗~</span>
<span class="c1">#如果不修改，也就是说测试用的是test.mytable表，而且必须有一个列叫id</span>
    <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&quot;SELECT * FROM mytable WHERE ID = ?&quot;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@times</span> <span class="o">=</span> <span class="p">();</span>
    <span class="c1">## wait for the parent to HUP me</span>
    <span class="nb">local</span> <span class="nv">$SIG</span><span class="p">{</span><span class="n">HUP</span><span class="p">}</span> <span class="o">=</span> <span class="k">sub </span><span class="p">{</span> <span class="p">};</span>
    <span class="nb">sleep</span> <span class="mi">600</span><span class="p">;</span>
<span class="c1">#脚本定义的每个进程执行多少次请求</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">$cnt</span> <span class="o">&lt;</span> <span class="nv">$num_runs</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">100_000</span><span class="p">));</span>
        <span class="c1">## time the query</span>
        <span class="k">my</span> <span class="nv">$t0</span> <span class="o">=</span> <span class="p">[</span><span class="n">gettimeofday</span><span class="p">];</span>
<span class="c1">#真正的执行sql请求，通过上面的rand知道，之前准备的test.mytable的id列必须是int格式，同时不少于10w行（又一处hard）</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$v</span><span class="p">);</span>
<span class="c1">#通过前后两次gettimeofday获得sql的exec耗时</span>
        <span class="k">my</span> <span class="nv">$t1</span> <span class="o">=</span> <span class="n">tv_interval</span><span class="p">(</span><span class="nv">$t0</span><span class="p">,</span> <span class="p">[</span><span class="n">gettimeofday</span><span class="p">]);</span>
<span class="c1">#完成一次请求执行，加入数组</span>
        <span class="nb">push</span> <span class="nv">@times</span><span class="p">,</span> <span class="nv">$t1</span><span class="p">;</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">();</span>
        <span class="nv">$cnt</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">## cleanup</span>
    <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">();</span>
<span class="c1">#计算本进程全部请求的各项数据，几个大小和均来自MyBench模块</span>
    <span class="k">my</span> <span class="nv">@r</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nb">scalar</span><span class="p">(</span><span class="nv">@times</span><span class="p">),</span> <span class="n">min</span><span class="p">(</span><span class="nv">@times</span><span class="p">),</span> <span class="n">max</span><span class="p">(</span><span class="nv">@times</span><span class="p">),</span> <span class="n">avg</span><span class="p">(</span><span class="nv">@times</span><span class="p">),</span> <span class="n">tot</span><span class="p">(</span><span class="nv">@times</span><span class="p">));</span>
    <span class="k">return</span> <span class="nv">@r</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">#将上面这个函数交给MyBench模块的fork_and_work执行，即并发指定数量请求，返回总的结果</span>
<span class="k">my</span> <span class="nv">@results</span> <span class="o">=</span> <span class="nn">MyBench::</span><span class="n">fork_and_work</span><span class="p">(</span><span class="nv">$num_kids</span><span class="p">,</span> <span class="nv">$callback</span><span class="p">);</span>
<span class="c1">#计算总的数据</span>
<span class="nn">MyBench::</span><span class="n">compute_results</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="nv">@results</span><span class="p">);</span>
<span class="nb">exit</span><span class="p">;</span>
<span class="cp">__END__</span>
</code></pre></div>
<p>然后看看/usr/lib/perl5/site_perl/5.8.8/MyBench.pm，主要内容就是fork和compute：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="n">MyBench</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="nv">$</span><span class="nn">main::</span><span class="nv">VERSION</span> <span class="o">=</span> <span class="s">&#39;1.0&#39;</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Exporter</span><span class="p">;</span>
<span class="nv">@</span><span class="nn">MyBench::</span><span class="nv">ISA</span> <span class="o">=</span> <span class="s">&#39;Exporter&#39;</span><span class="p">;</span>
<span class="c1">#导出求最大值、最小值、平均值、综合值的函数给外面用</span>
<span class="nv">@</span><span class="nn">MyBench::</span><span class="nv">EXPORT</span> <span class="o">=</span> <span class="sx">qw(max min avg tot)</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">fork_and_work</span><span class="p">($$)</span>
<span class="p">{</span>
<span class="c1">#关闭输出缓冲</span>
    <span class="vg">$|</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">IO::</span><span class="n">Pipe</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">IO::</span><span class="n">Select</span><span class="p">;</span>
    <span class="nv">$SIG</span><span class="p">{</span><span class="n">CHLD</span><span class="p">}</span> <span class="o">=</span> <span class="s">&#39;IGNORE&#39;</span><span class="p">;</span>      <span class="c1">## let the kids die</span>
    <span class="k">my</span> <span class="nv">$kids_to_fork</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$callback</span>     <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$num_kids</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@pipes</span>        <span class="o">=</span> <span class="p">();</span>
    <span class="k">my</span> <span class="nv">@pids</span>         <span class="o">=</span> <span class="p">();</span>
    <span class="k">my</span> <span class="nv">$pid</span>          <span class="o">=</span> <span class="nb">undef</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;forking: &quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">$num_kids</span> <span class="o">&lt;</span> <span class="nv">$kids_to_fork</span><span class="p">)</span>
    <span class="p">{</span>
<span class="c1">#用IO::Pipe管道方式来传递父子进程的信息</span>
        <span class="k">my</span> <span class="nv">$pipe</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">IO::</span><span class="n">Pipe</span><span class="p">;</span>
<span class="c1">#fork进程开始</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$pid</span> <span class="o">=</span> <span class="nb">fork</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="c1">## parent</span>
            <span class="nv">$num_kids</span><span class="o">++</span><span class="p">;</span>
<span class="c1">#每fork完成一个打印一个+号</span>
            <span class="k">print</span> <span class="s">&quot;+&quot;</span><span class="p">;</span>
<span class="c1">#从管道中读取数据</span>
            <span class="nv">$pipe</span><span class="o">-&gt;</span><span class="n">reader</span><span class="p">();</span>
            <span class="nb">push</span> <span class="nv">@pipes</span><span class="p">,</span> <span class="nv">$pipe</span><span class="p">;</span>
            <span class="nb">push</span> <span class="nv">@pids</span><span class="p">,</span>  <span class="nv">$pid</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">elsif</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$pid</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">## child</span>
<span class="c1">#打开管道写入数据的功能</span>
            <span class="nv">$pipe</span><span class="o">-&gt;</span><span class="n">writer</span><span class="p">();</span>
<span class="c1">#执行select_example脚本传入的mysql请求测试函数</span>
            <span class="k">my</span> <span class="nv">@result</span> <span class="o">=</span> <span class="nv">$callback</span><span class="o">-&gt;</span><span class="p">(</span><span class="nv">$num_kids</span><span class="p">);</span>
<span class="c1">#把结果写入管道</span>
            <span class="k">print</span> <span class="nv">$pipe</span> <span class="s">&quot;@result\n&quot;</span><span class="p">;</span>
<span class="c1">#关闭管道</span>
            <span class="nv">$pipe</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">();</span>
            <span class="nb">exit</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">print</span> <span class="s">&quot;fork failed: $!\n&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">print</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
    <span class="c1">## give them a bit of time to setup</span>
    <span class="k">my</span> <span class="nv">$time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nv">$num_kids</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;sleeping for $time seconds while kids get ready\n&quot;</span><span class="p">;</span>
    <span class="nb">sleep</span> <span class="nv">$time</span><span class="p">;</span>
 <span class="c1">#发送SIGHUP信号给callback函数</span>
    <span class="nb">kill</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">@pids</span><span class="p">;</span>
    <span class="c1">## collect the results</span>
    <span class="k">my</span> <span class="nv">@results</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;waiting: &quot;</span><span class="p">;</span>
<span class="c1">#从管道中读取数据到数组</span>
    <span class="k">for</span> <span class="k">my</span> <span class="nv">$pipe</span> <span class="p">(</span><span class="nv">@pipes</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="sr">&lt;$pipe&gt;</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@results</span><span class="p">,</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="nv">$pipe</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">();</span>
        <span class="k">print</span> <span class="s">&quot;-&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">print</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">@results</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">compute_results</span><span class="p">(@)</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$recs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$Cnt</span><span class="p">,</span> <span class="nv">$Min</span><span class="p">,</span> <span class="nv">$Max</span><span class="p">,</span> <span class="nv">$Avg</span><span class="p">,</span> <span class="nv">$Tot</span><span class="p">,</span> <span class="nv">@Min</span><span class="p">,</span> <span class="nv">@Max</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">@_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">## 6 elements per record</span>
        <span class="k">my</span> <span class="nv">$rec</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span> <span class="nb">chomp</span> <span class="nv">$rec</span><span class="p">;</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$cnt</span><span class="p">,</span> <span class="nv">$min</span><span class="p">,</span> <span class="nv">$max</span><span class="p">,</span> <span class="nv">$avg</span><span class="p">,</span> <span class="nv">$tot</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span> <span class="sr">/\s+/</span><span class="p">,</span> <span class="nv">$rec</span><span class="p">;</span>
        <span class="nv">$Cnt</span> <span class="o">+=</span> <span class="nv">$cnt</span><span class="p">;</span>
        <span class="nv">$Avg</span> <span class="o">+=</span> <span class="nv">$avg</span><span class="p">;</span>
        <span class="nv">$Tot</span> <span class="o">+=</span> <span class="nv">$tot</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@Min</span><span class="p">,</span> <span class="nv">$min</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@Max</span><span class="p">,</span> <span class="nv">$max</span><span class="p">;</span>
        <span class="nv">$recs</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$Avg</span> <span class="o">=</span> <span class="nv">$Avg</span> <span class="o">/</span> <span class="nv">$recs</span><span class="p">;</span>
    <span class="nv">$Min</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="nv">@Min</span><span class="p">);</span>
    <span class="nv">$Max</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="nv">@Max</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$Qps</span> <span class="o">=</span> <span class="nv">$Cnt</span> <span class="sr">/ ($Tot /</span> <span class="nv">$recs</span><span class="p">);</span>
    <span class="k">print</span> <span class="s">&quot;$name: $Cnt $Min $Max $Avg $Tot $Qps\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  clients : $recs\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  queries : $Cnt\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  fastest : $Min\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  slowest : $Max\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  average : $Avg\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  serial  : $Tot\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  q/sec   : $Qps\n&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">## some numerical helper functions for arrays</span>
<span class="k">sub </span><span class="nf">max</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">@_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span> <span class="o">&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$val</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">min</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">@_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span> <span class="o">&lt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$val</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">avg</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$tot</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">@_</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$tot</span> <span class="o">+=</span> <span class="nv">$_</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$tot</span> <span class="o">/</span> <span class="nv">@_</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">tot</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$tot</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">@_</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$tot</span> <span class="o">+=</span> <span class="nv">$_</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$tot</span><span class="p">;</span>
<span class="p">}</span>
<span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>好了，开始准备数据，比较懒，直接用super-smack的gen-data先出了一些./gen-data  -n 100000 -f %n,%80-12s%12n,%512-512s,%d &gt; /root/data，然后进mysql里执行：</p>
<div class="highlight"><pre><code class="mysql"><span class="k">USE</span> <span class="n">test</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nf">mytable</span> <span class="p">(</span><span class="n">id</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="kp">AUTO_INCREMENT</span><span class="p">,</span> <span class="n">col1</span> <span class="kt">CHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">col2</span> <span class="kt">CHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">col3</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">)</span><span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="k">LOAD</span> <span class="n">DATA</span> <span class="n">LOCAL</span> <span class="k">INFILE</span> <span class="s1">&#39;data&#39;</span> <span class="k">REPLACE</span> <span class="k">INTO</span> <span class="k">TABLE</span> <span class="s1">&#39;mytable&#39;</span> <span class="n">FIELDS</span> <span class="k">TERMINATED</span> <span class="k">BY</span> <span class="s1">&#39;,&#39;</span> <span class="k">LINES</span> <span class="k">TERMINATED</span> <span class="k">BY</span> <span class="s1">&#39;\n&#39;</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="nf">mytable</span> <span class="p">(</span><span class="n">col1</span><span class="p">,</span><span class="n">col2</span><span class="p">,</span><span class="n">col3</span><span class="p">)</span> <span class="k">SELECT</span> <span class="n">col1</span><span class="p">,</span><span class="n">col2</span><span class="p">,</span><span class="n">col3</span> <span class="k">FROM</span> <span class="n">mytable</span><span class="p">;</span>
</code></pre></div>
<p>最后执行./select_bench -h 10.168.170.92 -n 10 -r 1000就能看到结果了：
forking: ++++++++++
sleeping for 2 seconds while kids get ready
waiting: &mdash;&mdash;&mdash;-
test: 10000 0.00017 0.006809 0.0010413514 10.413514 9602.9063772325
  clients : 10
  queries : 10000
  fastest : 0.00017
  slowest : 0.006809
  average : 0.0010413514
  serial  : 10.413514
  q/sec   : 9602.9063772325</p>
      <a href="/2011/06/14/intro-mybench" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/10/java-chinese-support" title="java的中文支持" rel="bookmark">java的中文支持</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-10 00:00:00 +0800">10 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>往论坛上传图片，有的图片上有中文字，却显示成方框。求助了一下度娘，快速解决。记录一下：
* 第一步，在windows下找到simsun.ttc文件，嗯，ntfs系统下强力推荐everything小工具一个；
* 第二步，上传simsun.ttc到服务器的/usr/share/fonts/zh_CN/下，其他路径也行，不过这个路径比较通用；
* 第三步，在$JAVA_HOME/jrp/lib/下创建fontconfig.properties.zh文件，原型格式可见同目录下的fontconfig.properties.src。
fontconfig.properties.zh文件相关内容如下：</p>
<div class="highlight"><pre><code class="java"><span class="n">allfonts</span><span class="o">.</span><span class="na">chinese</span><span class="o">-</span><span class="n">gbk</span><span class="o">=-</span><span class="n">misc</span><span class="o">-</span><span class="n">simsun</span><span class="o">-</span><span class="n">medium</span><span class="o">-</span><span class="n">r</span><span class="o">-</span><span class="n">normal</span><span class="o">--*-%</span><span class="n">d</span><span class="o">-*-*-</span><span class="n">p</span><span class="o">-*-</span><span class="n">gbk</span><span class="o">-</span><span class="mi">0</span>
<span class="n">allfonts</span><span class="o">.</span><span class="na">chinese</span><span class="o">-</span><span class="n">gb2312</span><span class="o">=-</span><span class="n">misc</span><span class="o">-</span><span class="n">simsun</span><span class="o">-</span><span class="n">medium</span><span class="o">-</span><span class="n">r</span><span class="o">-</span><span class="n">normal</span><span class="o">--*-%</span><span class="n">d</span><span class="o">-*-*-</span><span class="n">p</span><span class="o">-*-</span><span class="n">gb2312</span><span class="o">.</span><span class="mi">1980</span><span class="o">-</span><span class="mi">0</span>
<span class="n">sequence</span><span class="o">.</span><span class="na">allfonts</span><span class="o">.</span><span class="na">GB18030</span><span class="o">=</span><span class="n">latin</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">gbk</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">cn</span><span class="o">-</span><span class="n">iso10646</span>
<span class="n">sequence</span><span class="o">.</span><span class="na">allfonts</span><span class="o">.</span><span class="na">GBK</span><span class="o">=</span><span class="n">latin</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">gbk</span>
<span class="n">sequence</span><span class="o">.</span><span class="na">allfonts</span><span class="o">.</span><span class="na">GB2312</span><span class="o">=</span><span class="n">latin</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">gb2312</span>
<span class="n">sequence</span><span class="o">.</span><span class="na">allfonts</span><span class="o">.</span><span class="na">UTF</span><span class="o">-</span><span class="mi">8</span><span class="o">.</span><span class="na">ko</span><span class="o">.</span><span class="na">KR</span><span class="o">=</span><span class="n">latin</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">korean</span><span class="o">,</span><span class="n">japanese</span><span class="o">-</span><span class="n">x0208</span><span class="o">,</span><span class="n">japanese</span><span class="o">-</span><span class="n">x0201</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">gbk</span>
<span class="n">sequence</span><span class="o">.</span><span class="na">allfonts</span><span class="o">.</span><span class="na">UTF</span><span class="o">-</span><span class="mi">8</span><span class="o">.</span><span class="na">ja</span><span class="o">.</span><span class="na">JP</span><span class="o">=</span><span class="n">latin</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">japanese</span><span class="o">-</span><span class="n">x0208</span><span class="o">,</span><span class="n">japanese</span><span class="o">-</span><span class="n">x0201</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">gbk</span><span class="o">,</span><span class="n">korean</span>
<span class="n">sequence</span><span class="o">.</span><span class="na">fallback</span><span class="o">=</span><span class="n">lucida</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">big5</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">gbk</span><span class="o">,</span><span class="n">japanese</span><span class="o">-</span><span class="n">x0208</span><span class="o">,</span><span class="n">korean</span>
<span class="n">filename</span><span class="o">.-</span><span class="n">misc</span><span class="o">-</span><span class="n">simsun</span><span class="o">-</span><span class="n">medium</span><span class="o">-</span><span class="n">r</span><span class="o">-</span><span class="n">normal</span><span class="o">--*-%</span><span class="n">d</span><span class="o">-*-*-</span><span class="n">p</span><span class="o">-*-</span><span class="n">gbk</span><span class="o">-</span><span class="mi">0</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">fonts</span><span class="o">/</span><span class="n">zh_CN</span><span class="o">/</span><span class="n">simsun</span><span class="o">.</span><span class="na">ttc</span>
<span class="n">filename</span><span class="o">.-</span><span class="n">misc</span><span class="o">-</span><span class="n">simsun</span><span class="o">-</span><span class="n">medium</span><span class="o">-</span><span class="n">r</span><span class="o">-</span><span class="n">normal</span><span class="o">--*-%</span><span class="n">d</span><span class="o">-*-*-</span><span class="n">p</span><span class="o">-*-</span><span class="n">gb2312</span><span class="o">.</span><span class="mi">1980</span><span class="o">-</span><span class="mi">0</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">fonts</span><span class="o">/</span><span class="n">zh_CN</span><span class="o">/</span><span class="n">simsun</span><span class="o">.</span><span class="na">ttc</span>
<span class="n">awtfontpath</span><span class="o">.</span><span class="na">chinese</span><span class="o">-</span><span class="n">gb2312</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">fonts</span><span class="o">/</span><span class="n">zh_CN</span>
<span class="n">awtfontpath</span><span class="o">.</span><span class="na">chinese</span><span class="o">-</span><span class="n">gbk</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">fonts</span><span class="o">/</span><span class="n">zh_CN</span>
</code></pre></div>
<p>很简单的一件小事儿，一来作个记录，二来测试微博同步——从百度统计看我可怜的一点点访问都来自微博……</p>
      <a href="/2011/06/10/java-chinese-support" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/09/statistics-descriptive-module-of-perl" title="perl模块Statistics::Descriptive" rel="bookmark">perl模块Statistics::Descriptive</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-09 00:00:00 +0800">09 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>今天写基调测试报告，需要从原始的ping延时和丢包率数据中自己计算标准方差以评估波动性（直接运行ping命令可见，不过基调报告里没有）。
方差是各个数据与其平均数的差的平方的平均数。标准差（均方差）则是方差的算术平方根。
这个时候可以打开excel……不过作为excel只会填文字的人，只好打开CPAN来解决问题了~</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">Statistics::</span><span class="n">Descriptive</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="nb">open</span> <span class="n">FH</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&#39;data&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$data</span><span class="o">=</span><span class="p">{};</span>
<span class="k">while</span><span class="p">(</span><span class="sr">&lt;FH&gt;</span><span class="p">){</span>
   <span class="k">my</span> <span class="nv">@F</span> <span class="o">=</span> <span class="nb">split</span><span class="p">;</span>
   <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;快网延时&quot;</span><span class="p">}},</span> <span class="nv">$F</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
   <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;快网丢包&quot;</span><span class="p">}},</span> <span class="nv">$F</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
   <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;森华延时&quot;</span><span class="p">}},</span> <span class="nv">$F</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
   <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;森华丢包&quot;</span><span class="p">}},</span> <span class="nv">$F</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
   <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;帝联延时&quot;</span><span class="p">}},</span> <span class="nv">$F</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
   <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;帝联丢包&quot;</span><span class="p">}},</span> <span class="nv">$F</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="p">}</span>
<span class="nb">close</span> <span class="n">FH</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$stat</span> <span class="o">=</span> <span class="nn">Statistics::Descriptive::</span><span class="n">Full</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$key</span> <span class="p">(</span><span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$data</span><span class="p">})</span> <span class="p">{</span>
    <span class="nv">$stat</span><span class="o">-&gt;</span><span class="n">add_data</span><span class="p">(</span><span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$key&quot;</span><span class="p">}});</span>
    <span class="k">print</span> <span class="nv">$key</span><span class="o">.</span><span class="s">&quot;\t&quot;</span><span class="o">.</span><span class="nv">$stat</span><span class="o">-&gt;</span><span class="n">standard_deviation</span><span class="p">(),</span><span class="s">&quot;\n&quot;</span><span class="p">;</span>
    <span class="nv">$stat</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>记住一定要clear，不然的话add_data会接着上一次的加，然后数据就错了。</p>
      <a href="/2011/06/09/statistics-descriptive-module-of-perl" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/09/intro-spread" title="spread试验" rel="bookmark">spread试验</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-09 00:00:00 +0800">09 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>spread还是半年前的时候偶然看到的，一直没有试过。前段时间用gearman收集集群日志时，发现gearman的方式，worker不会知道client来自哪里，一条job只会一个worker来做，比较适合做分布式计算，但相比我最初设想的实时系统管理需求，还是有一定距离。于是重新翻出来spread，感觉可以根据应用系统设置不同的group，然后统一再由一个回收结果的group即可。于是有了如下试验：</p>
<ul>
  <li>spread安装配置：</li>
</ul>
<div class="highlight"><pre><code class="bash">wget http://www.spread.org/download/spread-src-4.1.0.tar.gz
tar zxvf spread-src-4.1.0.tar.gz
<span class="nb">cd </span>spread-src-4.1.0
./configure --prefix<span class="o">=</span>/usr/local/spread <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make install
cat &gt; /usr/local/spread/etc/spread.conf <span class="s">&lt;&lt; EOF</span>
<span class="s">Spread_Segment  10.1.171.255:4804 {</span>
<span class="s">        ct-142                  10.1.168.142</span>
<span class="s">        ct-94                   10.1.168.94</span>
<span class="s">        ct-241                  10.1.168.241</span>
<span class="s">        ct-156                  10.1.168.156</span>
<span class="s">        ct-70                   10.1.170.70</span>
<span class="s">        cnc-64                  10.1.169.64</span>
<span class="s">        cnc-80                  10.1.169.80</span>
<span class="s">        cnc-72                  10.1.169.72</span>
<span class="s">        cnc-58                  10.1.169.58</span>
<span class="s">}</span>
<span class="s">EOF</span>
groupadd spread
useradd -g spread spread
mkdir -p /var/run/spread
chown spread:spread /var/run/spread
<span class="nb">echo</span> <span class="s1">&#39;/usr/local/spread/lib&#39;</span> &gt; /etc/ld.conf.d/spread.conf <span class="o">&amp;&amp;</span> ldconfig
<span class="c">#必须用-n指定配置文件中定义好了的servername；</span>
<span class="c">#奇怪的是网上别的文章都指出这些配置要同时写入hosts，但我没写也一样用了</span>
/usr/local/spread/sbin/spread -c /usr/local/spread/etc/spread.conf -n ct-156 &amp;
</code></pre></div>
<ul>
  <li>perl的spread使用</li>
</ul>
<p>CPAN上有很多关于spread的模块，试了几个后，选中了Spread::Messaging::Content。使用如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">Spread::Messaging::</span><span class="n">Content</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Event</span><span class="p">;</span>
<span class="nv">$spread</span> <span class="o">=</span> <span class="nn">Spread::Messaging::</span><span class="n">Content</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
     <span class="o">-</span><span class="n">port</span> <span class="o">=&gt;</span> <span class="s">&quot;4804&quot;</span><span class="p">,</span>
     <span class="o">-</span><span class="n">timeout</span> <span class="o">=&gt;</span> <span class="s">&quot;10&quot;</span><span class="p">,</span>
     <span class="o">-</span><span class="n">host</span> <span class="o">=&gt;</span> <span class="s">&quot;10.1.168.156&quot;</span><span class="p">,</span>
 <span class="p">);</span>
<span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">join_group</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">);</span>
<span class="c1">#当spread的group存在了filedescriptor后，执行子函数；</span>
<span class="c1">#$spread-&gt;fd来自Spread::Messaging::Transport，这个module是Spread::Messaging::Content自动加载调用的</span>
<span class="n">Event</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">(</span><span class="n">fd</span> <span class="o">=&gt;</span> <span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=&gt;</span> <span class="o">\&amp;</span><span class="n">put_output</span><span class="p">);</span>
<span class="nn">Event::</span><span class="n">loop</span><span class="p">();</span>
<span class="k">sub </span><span class="nf">put_output</span> <span class="p">{</span>
    <span class="nv">$spread</span><span class="o">-&gt;</span><span class="nb">recv</span><span class="p">();</span>
    <span class="nb">printf</span><span class="p">(</span><span class="s">&quot;Sender      : %s\n&quot;</span><span class="p">,</span> <span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">sender</span><span class="p">);</span>
    <span class="nb">printf</span><span class="p">(</span><span class="s">&quot;Groups      : %s\n&quot;</span><span class="p">,</span> <span class="nb">join</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">}));</span>
    <span class="nb">printf</span><span class="p">(</span><span class="s">&quot;Message     : %s\n&quot;</span><span class="p">,</span> <span class="nb">ref</span><span class="p">(</span><span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">)</span> <span class="ow">eq</span> <span class="s">&quot;ARRAY&quot;</span> <span class="p">?</span> 
                                     <span class="nb">join</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">})</span> <span class="p">:</span>
                                     <span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">Spread::Messaging::</span><span class="n">Content</span><span class="p">;</span>
<span class="nv">$spread</span> <span class="o">=</span> <span class="nn">Spread::Messaging::</span><span class="n">Content</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
     <span class="o">-</span><span class="n">port</span> <span class="o">=&gt;</span> <span class="s">&quot;4804&quot;</span><span class="p">,</span>
     <span class="o">-</span><span class="n">timeout</span> <span class="o">=&gt;</span> <span class="s">&quot;10&quot;</span><span class="p">,</span>
     <span class="o">-</span><span class="n">host</span> <span class="o">=&gt;</span> <span class="s">&quot;10.1.168.156&quot;</span><span class="p">,</span>
 <span class="p">);</span>
 <span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">(</span><span class="s">&quot;test2&quot;</span><span class="p">);</span>
 <span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">);</span>
 <span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">(</span><span class="s">&quot;cooking with fire&quot;</span><span class="p">);</span>
 <span class="nv">$spread</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">();</span>
</code></pre></div>
<ul>
  <li>spread自带的spuser使用</li>
</ul>
<div class="highlight"><pre><code class="bash">/usr/local/spread/bin/spuser -s 4804
j <span class="nb">test</span>
m <span class="nb">test</span>
</code></pre></div>
      <a href="/2011/06/09/intro-spread" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/09/inode-problem-of-tmpfs" title="tmpfs的inode问题" rel="bookmark">tmpfs的inode问题</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-09 00:00:00 +0800">09 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一些squid服务器为了强调加速效果，使用tmpfs来做cache_dir。刚开始运行的时候也嗖嗖的，不过没过一两天，mgr:info就看到缓存命中率急剧下降，字节命中率甚至只剩下10%左右！检查了多次配置，绝对没有问题，但同样的url，曾经一分钟几百次的HIT，现在一分钟几百次MISS……
df看，不管是tmpfs，还是logs所在的目录，都才用了不到30%。最后想起来df -i看了下，果然，tmpfs的inode使用率100%了！
赶紧remount了一次，解决了问题。但不是根本出路。还是得想办法搞定这个inode。
在linux代码说明里找到了关于tmpfs的文档（/usr/src/linux/Documentation/filesystems/tmpfs.txt）：
    tmpfs has three mount options for sizing:
    ……
    nr_inodes: The maximum number of inodes for this instance. <strong>The default
               is half of the number of your physical RAM pages</strong>, or (on a
               machine with highmem) the number of lowmem RAM pages,
               whichever is the lower.
    These parameters accept a suffix k, m or g for kilo, mega and giga and
    can be changed on remount.  The size parameter also accepts a suffix %
    to limit this tmpfs instance to that percentage of your physical RAM:
    <strong>the default, when neither size nor nr_blocks is specified, is size=50%</strong></p>
<pre><code>If nr_blocks=0 (or size=0), blocks will not be limited in that instance;
&lt;strong&gt;if nr_inodes=0, inodes will not be limited.&lt;/strong&gt;  It is generally unwise to
mount with such options, since it allows any user with write access to
use up all the memory on the machine; but enhances the scalability of
that instance in a system with many cpus making intensive use of it. linux默认的RAM page大小是4k，好了来计算一下吧。
</code></pre>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@bbs_squid4 ~<span class="o">]</span><span class="c"># df -i|awk &#39;/tmpfs/{print $2}&#39;</span>
504912
<span class="o">[</span>root@bbs_squid4 ~<span class="o">]</span><span class="c"># free -k|awk &#39;/Mem/{print $2/4/2}&#39;</span>
504912
</code></pre></div>
<p>果然如此！
那么真正的解决办法也就有了：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c"># mount -t tmpfs -o size=2000M,mode=777,nr_inodes=0 tmpfs /tmpfs</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c"># df -i|grep tmpfs</span>
tmpfs                      0       0       0    -  /tmpfs
</code></pre></div>
      <a href="/2011/06/09/inode-problem-of-tmpfs" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/03/aggregate-multi-servers-rollback-log-by-gearmand" title="用gearman汇总多台服务器的回滚日志" rel="bookmark">用gearman汇总多台服务器的回滚日志</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-03 00:00:00 +0800">03 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>gearman其实不是重点，因为我就是抄了一遍perldoc的样例而已。关键在服务器上的log4j日志是回滚的，所以需要配合回滚（猜测log4j的DailyRollingFile回滚方式类似mv resin.log resin.log-ymd &amp;&amp; reload，这样在回滚后，FH还在resin.log-ymd上，就读不到新日志了）重启FH。
另：tail命令有个参数-F/&ndash;follow=name，可以锁定文件名而不是文件描述符，不知道这个功能是怎么做到的？
一步一步来：</p>
<ul>
  <li>jobserver</li>
</ul>
<div class="highlight"><pre><code class="bash">cpan -i Gearman::Server
gearmand -d -L 10.168.170.25 -p 7003
</code></pre></div>
<ul>
  <li>worker</li>
</ul>
<div class="highlight"><pre><code class="bash">cpan -i Gearman::Worker
</code></pre></div>
<p>然后看日志的脚本，其实也就是样例：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">Gearman::</span><span class="n">Worker</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$worker</span> <span class="o">=</span> <span class="nn">Gearman::</span><span class="n">Worker</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
<span class="nv">$worker</span><span class="o">-&gt;</span><span class="n">job_servers</span><span class="p">(</span><span class="s">&#39;10.1.1.25:7003&#39;</span><span class="p">);</span>
<span class="nv">$worker</span><span class="o">-&gt;</span><span class="n">register_function</span><span class="p">(</span> <span class="n">watchlog</span> <span class="o">=&gt;</span> <span class="o">\&amp;</span><span class="n">watchlog</span> <span class="p">);</span>
<span class="nv">$worker</span><span class="o">-&gt;</span><span class="n">work</span> <span class="k">while</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">watchlog</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$job</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">print</span> <span class="nv">$job</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span><span class="s">&quot;\n&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ul>
  <li>client（也就是多台resin服务器上）</li>
</ul>
<div class="highlight"><pre><code class="bash">cpan -i Gearman::Client
</code></pre></div>
<p>然后是脚本：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">Gearman::</span><span class="n">Client</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(strftime)</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$client</span> <span class="o">=</span> <span class="nn">Gearman::</span><span class="n">Client</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="n">job_servers</span><span class="p">(</span><span class="s">&#39;10.1.1.25:7003&#39;</span><span class="p">);</span>
<span class="o">&amp;</span><span class="nb">read</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">open</span> <span class="n">FH1</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&#39;/tmp/pid.txt&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$childpid</span> <span class="o">=</span> <span class="sr">&lt;FH1&gt;</span><span class="p">;</span>
    <span class="nb">close</span> <span class="n">FH1</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$date</span><span class="o">=</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span><span class="nb">localtime</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$date</span> <span class="ow">eq</span> <span class="s">&#39;00:00:00&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">kill</span> <span class="mi">9</span><span class="p">,</span><span class="nv">$childpid</span><span class="p">;</span>
        <span class="nb">sleep</span> <span class="mi">1</span><span class="p">;</span>
        <span class="o">&amp;</span><span class="nb">read</span><span class="p">;</span>   
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">read</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="nb">fork</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">#这个$$不能直接赋值出去，所以采用文件方式，以后研究一下pipe啊之类的办法。</span>
    <span class="nb">open</span> <span class="n">FH</span><span class="p">,</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span><span class="s">&#39;/tmp/pid.txt&#39;</span><span class="p">;</span>
    <span class="k">print</span> <span class="n">FH</span> <span class="vg">$$</span><span class="p">;</span>
    <span class="nb">close</span> <span class="n">FH</span><span class="p">;</span>
    <span class="nb">open</span> <span class="p">(</span><span class="n">FD</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&#39;resin.log&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">die</span> <span class="vg">$!</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">my</span> <span class="nv">$log</span> <span class="o">=</span> <span class="sr">&lt;FD&gt;</span><span class="p">;</span>
       <span class="nb">sleep</span> <span class="mi">1</span> <span class="ow">and</span> <span class="k">next</span> <span class="k">unless</span> <span class="nv">$log</span><span class="p">;</span>
       <span class="nb">chomp</span> <span class="nv">$log</span><span class="p">;</span>
       <span class="nv">$client</span><span class="o">-&gt;</span><span class="n">dispatch_background</span><span class="p">(</span><span class="s">&#39;watchlog&#39;</span><span class="p">,</span><span class="nv">$log</span><span class="p">);</span>
       <span class="p">}</span>
    <span class="nb">close</span> <span class="n">FD</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
      <a href="/2011/06/03/aggregate-multi-servers-rollback-log-by-gearmand" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/01/intro-html-template" title="HTML::Template试用" rel="bookmark">HTML::Template试用</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-01 00:00:00 +0800">01 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>给我自己的学习计划做个开头，从html::template开始试用。
首先利用上上篇的nmap.pl脚本，提取一些数据，然后展示在页面上。
cgi脚本如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">HTML::</span><span class="n">Template</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">XML::</span><span class="n">Simple</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Net::</span><span class="n">MySQL</span><span class="p">;</span>
<span class="c1">#定期执行这个</span>
<span class="c1">#system(&quot;nmap -n -p 22,5666 10.168.168.0/23 10.168.170.0/24 -oX output.xml&quot;);</span>
<span class="k">my</span> <span class="nv">$text</span> <span class="o">=</span> <span class="n">XMLin</span><span class="p">(</span><span class="s">&quot;output.xml&quot;</span><span class="p">);</span>
<span class="c1">#读取html模版</span>
<span class="k">my</span> <span class="nv">$temp</span> <span class="o">=</span> <span class="nn">HTML::</span><span class="n">Template</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="n">filename</span> <span class="o">=&gt;</span> <span class="s">&#39;../template/html/server.tmpl&#39;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$localhost</span> <span class="o">=</span> <span class="s">&#39;127.0.0.1&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@array</span> <span class="o">=</span> <span class="p">();</span>
<span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$hash</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">while</span> <span class="p">(</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
<span class="c1">#因为新增了ssh端口扫描，所以xml解析和前例稍有不同</span>
    <span class="k">my</span> <span class="nv">$ssh_state</span> <span class="o">=</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ports</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">port</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$nrpe_state</span> <span class="o">=</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ports</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">port</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="nb">ref</span><span class="p">(</span><span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">})</span> <span class="ow">eq</span> <span class="s">&#39;ARRAY&#39;</span> <span class="p">?</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">addr</span><span class="p">}</span> <span class="p">:</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">addr</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$mac</span> <span class="o">=</span> <span class="nb">ref</span><span class="p">(</span><span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">})</span> <span class="ow">eq</span> <span class="s">&#39;ARRAY&#39;</span> <span class="p">?</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">addr</span><span class="p">}</span> <span class="p">:</span> <span class="s">&#39;00:1E:C9:E6:E1:7C&#39;</span><span class="p">;</span>
    <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$channel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">mysql_query</span><span class="p">(</span><span class="nv">$mac</span><span class="p">);</span>
<span class="c1">#将ip按照频道排成列表，每个ip存有ssh和nrpe状态</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nb">exists</span> <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$channel</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$channel</span><span class="p">}},</span> <span class="p">{</span> <span class="s">&#39;IP&#39;</span> <span class="o">=&gt;</span> <span class="nv">$ip</span><span class="p">,</span> <span class="s">&#39;SSH&#39;</span> <span class="o">=&gt;</span> <span class="nv">$ssh_state</span><span class="p">,</span> <span class="s">&#39;NRPE&#39;</span> <span class="o">=&gt;</span> <span class="nv">$nrpe_state</span><span class="p">,</span> <span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$channel</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;IP&#39;</span> <span class="o">=&gt;</span> <span class="nv">$ip</span><span class="p">,</span> <span class="s">&#39;SSH&#39;</span> <span class="o">=&gt;</span> <span class="nv">$ssh_state</span><span class="p">,</span> <span class="s">&#39;NRPE&#39;</span> <span class="o">=&gt;</span> <span class="nv">$nrpe_state</span><span class="p">,</span> <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">#将上面while生成的hash转成HTML::Template认可的array，不过array的单个元素可以是hash</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$key</span><span class="p">(</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$hash</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$onechannel</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nv">$onechannel</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;CHANNEL&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$key</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$ip</span><span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$key</span><span class="p">}}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$onechannel</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;IP_LOOP&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$ip</span><span class="p">;</span>
        <span class="nv">$j</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">push</span> <span class="nv">@array</span><span class="p">,</span> <span class="nv">$onechannel</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">#将array传递给之前定义的html模版</span>
<span class="c1">#注意：不管是param还是@array里，所有的key必须都在tmpl里使用，冗余也会报错</span>
<span class="nv">$temp</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="n">CHANNEL_LOOP</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@array</span><span class="p">);</span>
<span class="c1">#输出成html格式</span>
<span class="k">print</span> <span class="s">&quot;Content-Type: text/html\n\n&quot;</span><span class="p">,</span> <span class="nv">$temp</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">;</span>
<span class="c1">#这段没什么说的，根据mac获取频道</span>
<span class="k">sub </span><span class="nf">mysql_query</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$mac</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$mysql</span> <span class="o">=</span> <span class="nn">Net::</span><span class="n">MySQL</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">hostname</span> <span class="o">=&gt;</span> <span class="nv">$localhost</span><span class="p">,</span>
                                 <span class="n">database</span> <span class="o">=&gt;</span> <span class="s">&#39;myops&#39;</span><span class="p">,</span>
                                 <span class="n">user</span>     <span class="o">=&gt;</span> <span class="s">&#39;myops&#39;</span><span class="p">,</span>
                                 <span class="n">password</span> <span class="o">=&gt;</span> <span class="s">&#39;myops&#39;</span><span class="p">,</span>
                               <span class="p">);</span>
    <span class="nv">$mysql</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">(</span><span class="s">&quot;select channel from myhost where mac=&#39;$mac&#39;&quot;</span><span class="p">);</span>
    <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">alert</span><span class="p">(</span><span class="s">&quot;New server&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="nv">$mysql</span><span class="o">-&gt;</span><span class="n">has_selected_record</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$a_record_iterator</span> <span class="o">=</span> <span class="nv">$mysql</span><span class="o">-&gt;</span><span class="n">create_record_iterator</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$record</span> <span class="o">=</span> <span class="nv">$a_record_iterator</span><span class="o">-&gt;</span><span class="nb">each</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$record</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">};</span>
<span class="p">}</span>
<span class="c1">#留着后续继续处理</span>
<span class="k">sub </span><span class="nf">alert</span> <span class="p">{</span>
    <span class="k">print</span> <span class="nv">@_</span><span class="p">,</span><span class="s">&quot;\n&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>然后是template文件server.tmpl：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Server Plate<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;table</span> <span class="na">width=</span><span class="s">&quot;100%&quot;</span> <span class="na">cellspacing=</span><span class="s">&quot;0&quot;</span> <span class="na">cellpadding=</span><span class="s">&quot;0&quot;</span> <span class="na">border=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
<span class="c">&lt;!--TMPL_LOOP循环格式，使用的是array里channel_loop的每个元素--&gt;</span>
<span class="nt">&lt;TMPL</span><span class="na">_LOOP</span> <span class="na">NAME=</span><span class="s">&quot;CHANNEL_LOOP&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="c">&lt;!--根据本层loop中的某个元素的channel的value开始表格的一行--&gt;</span>
<span class="nt">&lt;th&gt;&lt;center&gt;&lt;TMPL</span><span class="na">_VAR</span> <span class="na">NAME=</span><span class="s">&quot;CHANNEL&quot;</span><span class="nt">&gt;&lt;/center&gt;&lt;/th&gt;</span>
<span class="c">&lt;!--本层loop中另一个元素ip_loop，也是array格式，所以继续循环，每个元素使用一列--&gt;</span>
<span class="nt">&lt;TMPL</span><span class="na">_LOOP</span> <span class="na">NAME=</span><span class="s">&quot;IP_LOOP&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">top</span><span class="nt">&gt;&lt;center&gt;</span>
//根据本层loop的ssh情况选择显示哪个图标；TMPL_IF只能判断key的真假，所以用js
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&lt;TMPL_VAR NAME=&quot;SSH&quot;&gt;&#39;</span> <span class="o">==</span> <span class="s1">&#39;open&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;&lt;img src=&#39;../template/images/unlock_server.png&#39;&gt;&quot;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;&lt;img src=&#39;../template/images/desable_server.png&#39;&gt;&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
<span class="c">&lt;!--显示第二层loop里元素的几个value--&gt;</span>
<span class="nt">&lt;hr&gt;</span>nrpe:<span class="nt">&lt;TMPL</span><span class="na">_VAR</span> <span class="na">NAME=</span><span class="s">&quot;NRPE&quot;</span><span class="nt">&gt;&lt;hr&gt;</span>ssh :<span class="nt">&lt;TMPL</span><span class="na">_VAR</span> <span class="na">NAME=</span><span class="s">&quot;SSH&quot;</span><span class="nt">&gt;&lt;hr&gt;&lt;TMPL</span><span class="na">_VAR</span> <span class="na">NAME=</span><span class="s">&quot;IP&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/center&gt;&lt;/td&gt;</span>
<span class="c">&lt;!--结束里层loop，即完成一行表格--&gt;</span>
<span class="err">&lt;</span>/TMPL_LOOP&gt;
<span class="nt">&lt;/tr&gt;</span>
<span class="c">&lt;!--结束顶层loop，即完成表格--&gt;</span>
<span class="err">&lt;</span>/TMPL_LOOP&gt;
<span class="nt">&lt;/table&gt;&lt;/center&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;center&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>用apache分别发布cgi目录和静态目录。然后访问一下；OK。</p>
      <a href="/2011/06/01/intro-html-template" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/05/30/intro-perl_set-image_filter" title="nginx两个小测试(perl_set/image_filter)" rel="bookmark">nginx两个小测试(perl_set/image_filter)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-05-30 00:00:00 +0800">30 May 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>第一个测试，关于http_perl_module。之前写过一篇关于nginx忽略大小写的博文，今天被朋友问上门来，url是类似/Upload/Dir/2011/123_D.jpg的形式。如果单纯的lc($r-&gt;uri)，得到的url会变成/upload/dir/2011/123_d.jpg，目录是不存在的。所以要稍微改进一下。如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">perl_set</span> <span class="nv">$url</span> <span class="s">&#39;</span>
<span class="s">        sub {</span>
<span class="s">            my $r = shift;</span>
<span class="s">            return $1.lc($2) if ($r-&gt;uri =~ m/^(.+\/)([^\/]+)$/);</span>
<span class="s">            return $r-&gt;uri;</span>
<span class="s">        }</span>
<span class="s">    &#39;</span><span class="p">;</span>
</code></pre></div>
<p>这样就行了。</p>
<p>另一个测试，关于http_image_filter_module。配置语句很简单，就一行image_filter [size|resize|corp] wight height;就行了——如果图片太大，那还要加大image_filter_buffer，默认1M，大于这个大小的图片就不会缩略了。
比如配置如下：</p>
<div class="highlight"><pre><code class="nginx">        <span class="k">location</span> <span class="s">/</span> <span class="p">{</span>
            <span class="kn">root</span>   <span class="s">/var/www/html</span><span class="p">;</span>
            <span class="kn">index</span>  <span class="s">index.html</span> <span class="s">index.htm</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">location</span> <span class="p">~</span><span class="sr">*</span> <span class="s">^/small/w_(\d+)/h_(\d+)/(.*)</span>$ <span class="p">{</span>
            <span class="kn">rewrite</span> <span class="s">/small/w_(\d+)/h_(\d+)/(.*)</span>$ <span class="s">/</span><span class="nv">$3</span> <span class="s">break</span><span class="p">;</span>
            <span class="kn">image_filter</span> <span class="s">resize</span> <span class="nv">$1</span> <span class="nv">$2</span><span class="p">;</span>
            <span class="kn">root</span>   <span class="s">/var/www/html</span><span class="p">;</span>
            <span class="kn">index</span>  <span class="s">index.html</span> <span class="s">index.htm</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div>
<p>这样通过/small/w<em>100/h</em>50/path/to/text.jpg，就能访问到/path/to/text.jpg的100*50大小的缩略图了。
如果只需要修改h或者w，其他的等比缩略，把另一项写成&rsquo;-&lsquo;即可。
其他参数介绍：test，返回是否真的是图片；corp，截取图片的一部分；size，以json格式返回图片的长宽数据。</p>
      <a href="/2011/05/30/intro-perl_set-image_filter" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/05/27/analyze-the-xml-which-nmap-output" title="nmap扫描结果xml解析脚本" rel="bookmark">nmap扫描结果xml解析脚本</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-05-27 00:00:00 +0800">27 May 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">XML::</span><span class="n">Simple</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Net::</span><span class="n">MySQL</span><span class="p">;</span>
<span class="nb">system</span><span class="p">(</span><span class="s">&quot;nmap -n -p 5666 10.1.1.0/23 10.1.3.0/24 -oX output.xml&quot;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$text</span> <span class="o">=</span> <span class="n">XMLin</span><span class="p">(</span><span class="s">&quot;output.xml&quot;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$nrpe</span> <span class="o">=</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ports</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">port</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">};</span>
<span class="c1">#因为在扫描到本机的时候，是没有mac的，所以到本机时不是ARRAY而是HASH</span>
    <span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="nb">ref</span><span class="p">(</span><span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">})</span> <span class="ow">eq</span> <span class="s">&#39;ARRAY&#39;</span> <span class="p">?</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">addr</span><span class="p">}</span> <span class="p">:</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">addr</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$mac</span> <span class="o">=</span> <span class="nb">ref</span><span class="p">(</span><span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">})</span> <span class="ow">eq</span> <span class="s">&#39;ARRAY&#39;</span> <span class="p">?</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">addr</span><span class="p">}</span> <span class="p">:</span> <span class="s">&#39;00:1E:C9:E6:E1:7C&#39;</span><span class="p">;</span>
    <span class="o">&amp;</span><span class="n">mysql_query</span><span class="p">(</span><span class="nv">$ip</span><span class="p">,</span> <span class="nv">$mac</span><span class="p">,</span> <span class="nv">$nrpe</span><span class="p">);</span>
    <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">mysql_query</span> <span class="p">{</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$ip</span><span class="p">,</span> <span class="nv">$mac</span><span class="p">,</span> <span class="nv">$nrpe</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$mysql</span> <span class="o">=</span> <span class="nn">Net::</span><span class="n">MySQL</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">hostname</span> <span class="o">=&gt;</span> <span class="s">&#39;10.1.1.25&#39;</span><span class="p">,</span>
                             <span class="n">database</span> <span class="o">=&gt;</span> <span class="s">&#39;myops&#39;</span><span class="p">,</span>
                             <span class="n">user</span>     <span class="o">=&gt;</span> <span class="s">&#39;myops&#39;</span><span class="p">,</span>
                             <span class="n">password</span> <span class="o">=&gt;</span> <span class="s">&#39;myops&#39;</span><span class="p">,</span>
                           <span class="p">);</span>
<span class="nv">$mysql</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">(</span>
<span class="s">&quot;insert into myhost (intranet, mac, monitorstatus) values (&#39;$ip&#39;, &#39;$mac&#39;, &#39;$nrpe&#39;)&quot;</span>
<span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>小脚本一个，扫描内网网段内存活的机器，获取其MAC地址，以及nrpe端口情况。后期再配合myhost里的system，如果是linux（其实用nmap -O也可以获取system，但是结果不准，耗时还特别长，200台机器花10分钟），但monitorstatus还是closed的，就expect上去安装nrpe，嗯~~</p>
      <a href="/2011/05/27/analyze-the-xml-which-nmap-output" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/05/20/merge-iplist-of-qqwry" title="续上：合并纯真ip段" rel="bookmark">续上：合并纯真ip段</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-05-20 00:00:00 +0800">20 May 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上篇提到纯真ip库有很多行是浪费的，比如下面这种：
&lt;div class="highlight"&gt;&lt;pre&gt;<code class="yaml"><span class="l-Scalar-Plain">223.214.0.0     223.215.255.255 安徽省 电信</span>
<span class="l-Scalar-Plain">223.216.0.0     223.219.255.255 日本</span>
<span class="l-Scalar-Plain">223.220.0.0     223.220.162.1   青海省 电信</span>
<span class="l-Scalar-Plain">223.220.162.2   223.220.162.2   青海省海东地区 平安县九歌网吧</span>
<span class="l-Scalar-Plain">223.220.162.3   223.221.255.255 青海省 电信</span>
</code>&lt;/pre&gt;&lt;/div&gt;</p>
<p>很简单的223.220.0.0-223.221.255.255段，却被拆成了三行。于是在通过起始ip结束ip计算子网之前，还需要合并一下这些ip段。
因为涉及ip比对，所以第一反应想到了mysql里有的inet_aton函数，去CPAN上搜了一下，发现有NetAddr::IP::Util模块有inet_aton函数，结果一用，发现居然生成的不是数字……于是从网上找到了pack的办法，如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">while</span><span class="p">(</span><span class="o">&lt;&gt;</span><span class="p">){</span>
    <span class="k">next</span> <span class="k">unless</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(\S+)\s+(\S+)\s+(\S+)/</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$low</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s">&#39;N&#39;</span><span class="p">,(</span><span class="nb">pack</span><span class="p">(</span><span class="s">&#39;C4&#39;</span><span class="p">,(</span><span class="nb">split</span><span class="p">(</span><span class="sr"> /\./</span><span class="p">,</span><span class="nv">$1</span><span class="p">)))));</span>
<span class="c1">#下面这行是IP::QQWry模块里的写法</span>
<span class="c1">#    print $1 * 256**3 + $2 * 256**2 + $3 * 256 + $4 if $1 =~ /(\d+)\.(\d+)\.(\d+)\.(\d+)/;;</span>
    <span class="k">my</span> <span class="nv">$high</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s">&#39;N&#39;</span><span class="p">,(</span><span class="nb">pack</span><span class="p">(</span><span class="s">&#39;C4&#39;</span><span class="p">,(</span><span class="nb">split</span><span class="p">(</span><span class="sr"> /\./</span><span class="p">,</span><span class="nv">$2</span><span class="p">)))));</span>
    <span class="k">next</span> <span class="k">if</span> <span class="nv">$low</span> <span class="o">==</span> <span class="nv">$high</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$addr</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
    <span class="k">unless</span> <span class="p">(</span> <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">high</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">low</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$low</span><span class="p">;</span>
        <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">high</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$high</span><span class="p">;</span>
        <span class="k">next</span><span class="p">;</span>
    <span class="p">};</span>
<span class="c1">#如果中间就隔几个ip的，可以无视之，合并就是了……</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$low</span> <span class="o">-</span> <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">high</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">high</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$high</span><span class="p">;</span>
        <span class="k">next</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nb">unshift</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">low</span><span class="p">}},</span> <span class="nv">$low</span><span class="p">;</span>
    <span class="nb">unshift</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">high</span><span class="p">}},</span> <span class="nv">$high</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">foreach</span> <span class="nv">$addr</span> <span class="p">(</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$hash</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span> <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">low</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">print</span> <span class="nv">$addr</span> <span class="o">.</span> <span class="s">&quot;\t&quot;</span> <span class="o">.</span> <span class="o">&amp;</span><span class="n">nota</span><span class="p">(</span><span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">low</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">.</span> <span class="s">&quot;\t&quot;</span> <span class="o">.</span> <span class="o">&amp;</span><span class="n">nota</span><span class="p">(</span><span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">high</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="p">,</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
        <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">nota</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$aton</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="nv">@a</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s">&#39;C4&#39;</span><span class="p">,(</span><span class="nb">pack</span><span class="p">(</span><span class="s">&#39;N&#39;</span><span class="p">,</span><span class="nv">$aton</span><span class="p">)));</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">join</span> <span class="s">&quot;\.&quot;</span><span class="p">,</span><span class="nv">@a</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>pack真复杂，基本看不懂perldoc，唉……</p>
<p>最后汇报一下运行结果：
合并前一共428452行，合并后103008行。</p>
      <a href="/2011/05/20/merge-iplist-of-qqwry" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/05/19/get-iplist-from-qqwry" title="从纯真数据库里获取ip列表" rel="bookmark">从纯真数据库里获取ip列表</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-05-19 00:00:00 +0800">19 May 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>首先申明只是一个简单的方式，因为打算的是提取总列表成bind9使用的acl格式，所以不在乎性能问题。
第一步、从CZ88.NET下载QQWry数据库，然后运行IP.exe，选择“解压”，然后会在桌面生成一个qqwry.txt，这里就有四十多万行的ip记录。格式如下：
起始ip    结束ip   大区域     小区域
但是这个大区域也不是想像中的那么整齐，比如清华大学宿舍楼也是大区域的……
好在我们DNS只需要一个大概的南北指向，根据电信占主流的现实，只要取出来联通的，其他都算电信就行了~
第二步、把起始ip-结束ip改成acl需要的子网掩码格式，这一步用perl完成，全文如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">Net::IPAddress::Util::</span><span class="n">Range</span><span class="p">;</span>
<span class="k">while</span><span class="p">(</span><span class="o">&lt;&gt;</span><span class="p">){</span>
    <span class="k">next</span> <span class="k">unless</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(\S+)\s+(\S+)\s+(.+)/</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$range</span> <span class="o">=</span> <span class="nn">Net::IPAddress::Util::</span><span class="n">Range</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">({</span> <span class="n">lower</span> <span class="o">=&gt;</span> <span class="nv">$1</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=&gt;</span> <span class="nv">$2</span> <span class="p">});</span>
    <span class="nb">map</span> <span class="p">{</span><span class="nb">printf</span> <span class="s">&quot;%s\t%s\n&quot;</span><span class="p">,</span> <span class="nv">$_</span><span class="p">,</span> <span class="nv">$3</span> <span class="p">}</span> <span class="nv">$range</span><span class="o">-&gt;</span><span class="n">tight</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">as_cidrs</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>其中tight()-&gt;as_cidrs()其实是Net::IPAddress::Util::Collection的函数（Range.pm里use了这个函数）。tight将不规律的ip段划分成规律的子网，cidrs将类似(1.1.1.0 .. .1.1.1.255)改成1.1.1.0/24。
如果直接采用Net::IPAddress::Util::Range的$range-&gt;as_cidr()的话，它会把一个不规律的ip段取一个最近的规律子网来显示……比方1.59.0.0-1.60.149.255会被计算成1.57.0.0/13！！
不过这个还有一个问题，就是没有多行合并，导致条目太多~~这个之后再看吧~</p>
      <a href="/2011/05/19/get-iplist-from-qqwry" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/05/12/script-process-link-failure" title="链路故障应急处理脚本" rel="bookmark">链路故障应急处理脚本</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-05-12 00:00:00 +0800">12 May 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>话接上篇，继续完成这个perl脚本。花了今天一天的时间，基本定稿如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">Net::Ping::</span><span class="n">External</span> <span class="sx">qw(ping)</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Tie::</span><span class="n">File</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Long</span><span class="p">;</span>
<span class="nn">Getopt::Long::</span><span class="n">Configure</span> <span class="p">(</span><span class="s">&quot;bundling&quot;</span><span class="p">);</span>
<span class="n">GetOptions</span><span class="p">(</span>
     <span class="s">&#39;H:s&#39;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$ct_host</span><span class="p">,</span>  <span class="s">&#39;host:s&#39;</span>   <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$ct_host</span><span class="p">,</span>
     <span class="s">&#39;T:i&#39;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$time</span><span class="p">,</span>     <span class="s">&#39;time:i&#39;</span>   <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$time</span><span class="p">,</span>
     <span class="s">&#39;N:i&#39;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$fork_num</span><span class="p">,</span> <span class="s">&#39;number:i&#39;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$fork_num</span><span class="p">,</span>
     <span class="s">&#39;h&#39;</span>   <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$help</span><span class="p">,</span>     <span class="s">&#39;help&#39;</span>     <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$help</span><span class="p">,</span>
<span class="p">);</span>
<span class="k">if</span><span class="p">(</span> <span class="nv">$help</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&quot;Usage: ping_check.pl -H 10.168.168.251 -T 30 -N 10\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;       -H/host:   The switch ip address to be checked in china telecom;\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;       -T/time:   The seconds used for pinging;\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;       -N/number: The number of fork processes to expect the remote hosts;\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;       -h/help:   The usage just you see now.\n&quot;</span><span class="p">;</span>
    <span class="nb">exit</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">my</span> <span class="nv">$mark_file</span> <span class="o">=</span> <span class="s">&#39;/tmp/mark_file&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@last</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$result</span> <span class="o">=</span> <span class="n">ping</span><span class="p">(</span> <span class="n">hostname</span> <span class="o">=&gt;</span> <span class="s">&quot;$ct_host&quot;</span><span class="p">,</span>
                   <span class="n">count</span>    <span class="o">=&gt;</span> <span class="nv">$time</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span>
                   <span class="n">size</span>     <span class="o">=&gt;</span> <span class="s">&#39;128&#39;</span><span class="p">,</span>
                   <span class="n">timeout</span>  <span class="o">=&gt;</span> <span class="s">&#39;1&#39;</span><span class="p">,</span>
<span class="c1">#原生的Net::Ping模块需要自己while来控制sleep；</span>
<span class="c1">#现在采用的Net::Ping::External是直接调用的外部ping命令，但默认也没有-i参数；</span>
<span class="c1">#package中sub ping{}里把未定义的@_都给到了%args，</span>
<span class="c1">#所以只需要在199行（即sub _ping_linux{}中）添加上-i $args{interval}就能用了。</span>
                   <span class="n">interval</span> <span class="o">=&gt;</span> <span class="s">&#39;0.2&#39;</span><span class="p">,</span>
                 <span class="p">);</span>
<span class="c1">#用tie将数组@last锁定到文件上——我曾经想过直接锁个变量，但是似乎没有，只能数组或哈希？</span>
<span class="nb">tie</span> <span class="nv">@last</span><span class="p">,</span> <span class="s">&#39;Tie::File&#39;</span><span class="p">,</span> <span class="nv">$mark_file</span> <span class="ow">or</span> <span class="nb">die</span> <span class="vg">$!</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span> <span class="nv">$result</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$last</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&quot;ok\n&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">elsif</span> <span class="p">(</span> <span class="nv">$result</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$last</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&quot;Beginning recovery\n&quot;</span><span class="p">;</span>
    <span class="o">&amp;</span><span class="n">parallel_manage</span><span class="p">(</span><span class="s">&quot;recovery&quot;</span><span class="p">,</span> <span class="s">&quot;$fork_num&quot;</span><span class="p">);</span>
    <span class="o">&amp;</span><span class="n">sms_alarm</span><span class="p">(</span><span class="s">&#39;CNC recovery peer to intranet&#39;</span><span class="p">);</span>
    <span class="o">&amp;</span><span class="n">email_alarm</span><span class="p">(</span><span class="s">&#39;CNC recovery peer to intranet&#39;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&quot;Error! Beginning change to template configuration\n&quot;</span><span class="p">;</span>
    <span class="o">&amp;</span><span class="n">parallel_manage</span><span class="p">(</span><span class="s">&quot;change&quot;</span><span class="p">,</span> <span class="s">&quot;$fork_num&quot;</span><span class="p">);</span>
    <span class="o">&amp;</span><span class="n">sms_alarm</span><span class="p">(</span><span class="s">&#39;CNC change peer to CT&#39;</span><span class="p">);</span>
    <span class="o">&amp;</span><span class="n">email_alarm</span><span class="p">(</span><span class="s">&#39;CNC change peer to CT&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="nv">$last</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$result</span><span class="p">;</span>
<span class="nb">untie</span> <span class="nv">@last</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">email_alarm</span> <span class="p">{</span>
    <span class="k">use</span> <span class="nn">Net::</span><span class="n">SMTP_auth</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$email_message</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$smtp</span> <span class="o">=</span> <span class="nn">Net::</span><span class="n">SMTP_auth</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">Host</span>    <span class="o">=&gt;</span> <span class="s">&#39;smtp.domain.com&#39;</span><span class="p">,</span>
                                    <span class="n">Timeout</span> <span class="o">=&gt;</span> <span class="s">&#39;30&#39;</span><span class="p">,</span>
<span class="c1">#                                    Debug   =&gt; &#39;1&#39;,</span>
                              <span class="p">);</span>
    <span class="nv">$smtp</span><span class="o">-&gt;</span><span class="n">auth</span><span class="p">(</span><span class="s">&#39;LOGIN&#39;</span><span class="p">,</span> <span class="s">&#39;alarm@domain.com&#39;</span><span class="p">,</span> <span class="s">&#39;password&#39;</span><span class="p">);</span>
    <span class="nv">$smtp</span><span class="o">-&gt;</span><span class="n">mail</span><span class="p">(</span><span class="s">&#39;alarm@domain.com&#39;</span><span class="p">);</span>
    <span class="nv">$smtp</span><span class="o">-&gt;</span><span class="n">to</span><span class="p">(</span> <span class="s">&#39;netadmin@domain.com&#39;</span> <span class="p">);</span>
    <span class="nv">$smtp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">();</span>
    <span class="nv">$smtp</span><span class="o">-&gt;</span><span class="n">datasend</span><span class="p">(</span><span class="s">&quot;To: Netadmin\@domain.com\n&quot;</span><span class="p">);</span>
    <span class="nv">$smtp</span><span class="o">-&gt;</span><span class="n">datasend</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">);</span>
    <span class="nv">$smtp</span><span class="o">-&gt;</span><span class="n">datasend</span><span class="p">(</span><span class="s">&quot;${email_message}\n&quot;</span><span class="p">);</span>
    <span class="nv">$smtp</span><span class="o">-&gt;</span><span class="n">dataend</span><span class="p">();</span>
    <span class="nv">$smtp</span><span class="o">-&gt;</span><span class="n">quit</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">sms_alarm</span> <span class="p">{</span>
    <span class="k">use</span> <span class="nn">Net::</span><span class="n">MySQL</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$sms_message</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">%contacts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get_contacts</span><span class="p">();</span>
    <span class="k">my</span> <span class="nv">$mysql</span> <span class="o">=</span> <span class="nn">Net::</span><span class="n">MySQL</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">hostname</span> <span class="o">=&gt;</span> <span class="s">&#39;10.1.1.45&#39;</span><span class="p">,</span>
                                 <span class="n">database</span> <span class="o">=&gt;</span> <span class="s">&#39;smsd&#39;</span><span class="p">,</span>
                                 <span class="n">user</span>     <span class="o">=&gt;</span> <span class="s">&#39;smsd&#39;</span><span class="p">,</span>
                                 <span class="n">password</span> <span class="o">=&gt;</span> <span class="s">&#39;smsd&#39;</span><span class="p">,</span>
                               <span class="p">);</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$send_number</span> <span class="p">(</span><span class="nb">values</span> <span class="nv">%contacts</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$mysql</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">(</span>
            <span class="s">&quot;INSERT INTO outbox (number, text) VALUES ( $send_number, &#39;$sms_message&#39;)&quot;</span>
        <span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$mysql</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">parallel_manage</span> <span class="p">{</span>
<span class="c1">#因为Expect模块本身使用了fork();要求运行在主进程中，所以在并发的时候不能采用多线程而得用多进程</span>
    <span class="k">use</span> <span class="n">Expect</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Parallel::</span><span class="n">ForkManager</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$command</span> <span class="o">=</span> <span class="nb">shift</span> <span class="o">||</span> <span class="s">&#39;id&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$max_fork</span> <span class="o">=</span> <span class="nb">shift</span> <span class="o">||</span> <span class="s">&#39;10&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@remote_list</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;10.1.1.64&#39;</span><span class="p">,</span>
                       <span class="s">&#39;10.1.1.50&#39;</span><span class="p">,</span>
                       <span class="s">&#39;10.1.1.35&#39;</span><span class="p">,</span>
                      <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$remote_host</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">%remote_result</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$pm</span> <span class="o">=</span> <span class="nn">Parallel::</span><span class="n">ForkManager</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="nv">$max_fork</span><span class="p">,</span> <span class="s">&#39;/tmp/&#39;</span><span class="p">);</span>
<span class="c1">#采用Parallel::ForkManager模块时，如果需要子进程返回数据结果给父进程，必须把run_on_finish()放在fork之前</span>
<span class="c1">#Parallel::ForkManager模块实际上是采用文件存储的方式进行父子进程的数据通信，所以上面new的时候定义一个临时文件路径</span>
    <span class="nv">$pm</span><span class="o">-&gt;</span><span class="n">run_on_finish</span> <span class="p">(</span>
        <span class="k">sub </span><span class="p">{</span>
<span class="c1">#主要有用的是子进程pid，子进程退出状态，返回数据的引用</span>
            <span class="k">my</span> <span class="p">(</span><span class="nv">$pid</span><span class="p">,</span> <span class="nv">$exit_code</span><span class="p">,</span> <span class="nv">$ident</span><span class="p">,</span> <span class="nv">$exit_signal</span><span class="p">,</span> <span class="nv">$core_dump</span><span class="p">,</span> <span class="nv">$reference</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$reference</span><span class="p">))</span> <span class="p">{</span>
<span class="c1">#解引用后复制到数组并转存成哈希</span>
                <span class="k">my</span> <span class="nv">@data</span> <span class="o">=</span>  <span class="nv">@$reference</span><span class="p">;</span>
                <span class="nv">$remote_result</span><span class="p">{</span><span class="s">&quot;$data[0]&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">print</span> <span class="sx">qq|No message received from child process $pid!\n|</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">);</span>
    <span class="k">foreach</span> <span class="nv">$remote_host</span> <span class="p">(</span><span class="nv">@remote_list</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$pm</span><span class="o">-&gt;</span><span class="n">start</span> <span class="ow">and</span> <span class="k">next</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">@check</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$remote_host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssh_expect</span><span class="p">(</span><span class="nv">$remote_host</span><span class="p">,</span> <span class="nv">$command</span><span class="p">));</span>
<span class="c1">#默认参数就是finish(0);需要返回数据时才加上引用</span>
        <span class="nv">$pm</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">\</span><span class="nv">@check</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$pm</span><span class="o">-&gt;</span><span class="n">wait_all_children</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$key</span> <span class="p">(</span><span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%remote_result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">print</span> <span class="nv">$remote_result</span><span class="p">{</span><span class="nv">$key</span><span class="p">},</span><span class="s">&quot;\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">ssh_expect</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$host</span><span class="p">,</span> <span class="nv">$shell</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$exp</span> <span class="o">=</span> <span class="n">Expect</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$password</span> <span class="o">=</span> <span class="s">&#39;password&#39;</span><span class="p">;</span>
    <span class="nv">$exp</span> <span class="o">=</span> <span class="n">Expect</span><span class="o">-&gt;</span><span class="n">spawn</span><span class="p">(</span><span class="s">&quot;ssh -l monitor -i /usr/local/monitor/conf/id_rsa -o ConnectTimeout=5 $host&quot;</span><span class="p">);</span>
<span class="c1">#    $ENV{TERM}=&quot;xterm&quot;;</span>
<span class="c1">#    $exp-&gt;exp_internal(1);</span>
    <span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">raw_pty</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="c1">#关闭输出，不然expect会把整个session都print出来（实际是到STDERR）</span>
    <span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">log_stdout</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">(</span><span class="mi">2</span><span class="p">,[</span>
                    <span class="s">&#39;\$&#39;</span><span class="p">,</span>
                    <span class="k">sub </span><span class="p">{</span>
                            <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
                            <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;su -\n&quot;</span><span class="p">);</span>
                        <span class="p">}</span>
                   <span class="p">],</span>
                   <span class="p">[</span>
                    <span class="s">&#39;\(yes/no\)\?&#39;</span><span class="p">,</span>
                    <span class="k">sub </span><span class="p">{</span>
                            <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
                            <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;yes\n&quot;</span><span class="p">);</span>
			    <span class="n">exp_continue</span><span class="p">;</span>
                         <span class="p">}</span>
                   <span class="p">]</span>
               <span class="p">);</span>
    <span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span>
		    <span class="s">&#39;Password:&#39;</span><span class="p">,</span>
		    <span class="k">sub </span><span class="p">{</span>
			    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
			    <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;${password}\n&quot;</span><span class="p">);</span>
			    <span class="n">exp_continue</span><span class="p">;</span>
		        <span class="p">}</span>
		   <span class="p">],</span>
		   <span class="p">[</span>
		    <span class="s">&#39;#&#39;</span><span class="p">,</span>
		    <span class="k">sub </span><span class="p">{</span>
			    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
			    <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;${shell}\n&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		   <span class="p">]</span>
	       <span class="p">);</span>
    <span class="nv">$exp</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;exit\n&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">(</span><span class="nb">undef</span><span class="p">,</span><span class="s">&#39;#&#39;</span><span class="p">));</span>
<span class="c1">#expect有before/match/after来返回相应的数据</span>
    <span class="k">my</span> <span class="nv">$read</span> <span class="o">=</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">before</span><span class="p">();</span>
    <span class="nv">$exp</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;exit\n&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">(</span><span class="nb">undef</span><span class="p">,</span><span class="s">&#39;$&#39;</span><span class="p">));</span>
    <span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">soft_close</span><span class="p">();</span>
    <span class="k">return</span> <span class="nv">$read</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">get_contact</span> <span class="p">{</span>
    <span class="nb">open</span> <span class="k">my</span> <span class="n">FH</span><span class="p">,</span> <span class="s">&quot;/usr/local/nagios/etc/objects/contacts.cfg&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">%hash</span><span class="p">;</span>
    <span class="nb">local</span> <span class="vg">$/</span> <span class="o">=</span> <span class="s">&#39;define&#39;</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="sr">&lt;FH&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">next</span> <span class="k">unless</span> <span class="sr">/pager\s+(\d{11})/</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$sms_num</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
        <span class="nv">$hash</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span><span class="o">=</span><span class="nv">$sms_num</span> <span class="k">if</span> <span class="sr">/email\s+([a-z\.]+?)\@bj.china.com/</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">%hash</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
      <a href="/2011/05/12/script-process-link-failure" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/05/12/learning-bless-and-write-pm-demo" title="学习pm和bless的写法" rel="bookmark">学习pm和bless的写法</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-05-12 00:00:00 +0800">12 May 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>考虑到公司环境必须先rsa_auth再su的问题，一般的pssh啊mussh啊sshbatch啊，都不能直接用，决定把上篇脚本里的相关部分抽出来成为一个模块，借机学习一下package和bless的简单概念：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#包名，如果做pm的话，必须和(.*).pm的名字一样</span>
<span class="nb">package</span> <span class="n">raocl</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Parallel::</span><span class="n">ForkManager</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Expect</span><span class="p">;</span>
<span class="c1">#Exporter模块是perl提供的导入模块方法的工具</span>
<span class="k">use</span> <span class="n">base</span> <span class="s">&#39;Exporter&#39;</span><span class="p">;</span>
<span class="c1">#Exporter有两个数组，@EXPORT里存的是模块的sub，@EXPORT_OK里存的是模块的var；</span>
<span class="c1">#使用模块时只能调用这些数组里有定义的东西</span>
<span class="k">our</span> <span class="nv">@EXPORT</span> <span class="o">=</span> <span class="sx">qw/new cluster/</span><span class="p">;</span>
<span class="c1">#一般模块都有一个new方法来进行初始化定义</span>
<span class="k">sub </span><span class="nf">new</span> <span class="p">{</span>
<span class="c1">#所有sub传入的第一个参数都是本身，所以要先shift出来，然后才是脚本显式传入的参数</span>
<span class="k">my</span> <span class="nv">$class</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
<span class="c1">#将参数转成哈希方式，并返回一个引用；</span>
<span class="c1">#正规做法应该在这里指定一些必须要有的参数，比如passwd =&gt; %args{&#39;passwd&#39;} || &#39;123456&#39;</span>
<span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="p">{</span><span class="nv">@_</span><span class="p">};</span>
<span class="c1">#bless上面返回的哈希引用到自己，再传递出去；以后在这之外的地方，使用被bless过的$self时自动就关联上new里的数据了。</span>
<span class="c1">#这里我写的极简单，看比较正式的模块写发，这里对$class还要用ref();判断是不是引用等</span>
<span class="k">return</span> <span class="nb">bless</span> <span class="nv">$self</span><span class="p">,</span><span class="nv">$class</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">cluster</span> <span class="p">{</span>
<span class="c1">#这里的$self就是上面被bless过的了</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$command</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">%remote_result</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$pm</span> <span class="o">=</span> <span class="nn">Parallel::</span><span class="n">ForkManager</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="nb">fork</span><span class="p">},</span> <span class="s">&#39;/tmp/&#39;</span><span class="p">);</span>
    <span class="nv">$pm</span><span class="o">-&gt;</span><span class="n">run_on_finish</span> <span class="p">(</span>
    <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$pid</span><span class="p">,</span> <span class="nv">$exit_code</span><span class="p">,</span> <span class="nv">$ident</span><span class="p">,</span> <span class="nv">$exit_signal</span><span class="p">,</span> <span class="nv">$core_dump</span><span class="p">,</span> <span class="nv">$reference</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$reference</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">@data</span> <span class="o">=</span> <span class="nv">@$reference</span><span class="p">;</span>
            <span class="nv">$remote_result</span><span class="p">{</span><span class="s">&quot;$data[0]&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">print</span> <span class="sx">qq|No message received from child process $pid!\n|</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">);</span>
<span class="c1">#直接使用bless过的$self解引用出来的hosts列表</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$remote_host</span> <span class="p">(</span><span class="nv">@</span><span class="p">{</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">hosts</span><span class="p">}})</span> <span class="p">{</span>
    <span class="nv">$pm</span><span class="o">-&gt;</span><span class="n">start</span> <span class="ow">and</span> <span class="k">next</span><span class="p">;</span>
<span class="c1">#使用bless过的$self的sub完成expect功能</span>
    <span class="k">my</span> <span class="nv">@check</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$remote_host</span><span class="p">,</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">pexpect</span><span class="p">(</span><span class="nv">$remote_host</span><span class="p">,</span> <span class="nv">$command</span><span class="p">));</span>
    <span class="nv">$pm</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">\</span><span class="nv">@check</span><span class="p">);</span>
<span class="p">}</span>
<span class="nv">$pm</span><span class="o">-&gt;</span><span class="n">wait_all_children</span><span class="p">;</span>
<span class="k">return</span> <span class="nv">%remote_result</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">pexpect</span> <span class="p">{</span>
<span class="c1">#还是同样的$self，然后才是上面调用时传递的$host和$shell</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$host</span><span class="p">,</span> <span class="nv">$shell</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
<span class="c1">#使用new里提供的passwd</span>
<span class="k">my</span> <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">passwd</span><span class="p">};</span>
<span class="k">my</span> <span class="nv">$exp</span> <span class="o">=</span> <span class="n">Expect</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
<span class="nv">$exp</span> <span class="o">=</span> <span class="n">Expect</span><span class="o">-&gt;</span><span class="n">spawn</span><span class="p">(</span><span class="s">&quot;ssh -l admin -i /usr/local/admin/conf/id_rsa -o ConnectTimeout=5 $host&quot;</span><span class="p">);</span>
<span class="nv">$ENV</span><span class="p">{</span><span class="n">TERM</span><span class="p">}</span><span class="o">=</span><span class="s">&quot;xterm&quot;</span><span class="p">;</span>
<span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">raw_pty</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="c1">#使用new里提供的开关</span>
<span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">exp_internal</span><span class="p">(</span><span class="s">&quot;$self-&gt;{debug}&quot;</span><span class="p">);</span>
<span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">log_stdout</span><span class="p">(</span><span class="s">&quot;$self-&gt;{output}&quot;</span><span class="p">);</span>
<span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">(</span><span class="mi">2</span><span class="p">,[</span>
                    <span class="s">&#39;\$&#39;</span><span class="p">,</span>
                    <span class="k">sub </span><span class="p">{</span>
                            <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
                            <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;su -\n&quot;</span><span class="p">);</span>
                        <span class="p">}</span>
                <span class="p">],</span>
                <span class="p">[</span>
                    <span class="s">&#39;\(yes/no\)\?&#39;</span><span class="p">,</span>
                    <span class="k">sub </span><span class="p">{</span>
                            <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
                            <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;yes\n&quot;</span><span class="p">);</span>
			    <span class="n">exp_continue</span><span class="p">;</span>
                         <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">);</span>
<span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span>
		    <span class="s">&#39;Password:&#39;</span><span class="p">,</span>
		    <span class="k">sub </span><span class="p">{</span>
			    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
			    <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;${password}\n&quot;</span><span class="p">);</span>
			    <span class="n">exp_continue</span><span class="p">;</span>
		        <span class="p">}</span>
		<span class="p">],</span>
		<span class="p">[</span>
		    <span class="s">&#39;#&#39;</span><span class="p">,</span>
		    <span class="k">sub </span><span class="p">{</span>
			    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
			    <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;${shell}\n&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">]</span>
	    <span class="p">);</span>
<span class="nv">$exp</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;exit\n&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">(</span><span class="nb">undef</span><span class="p">,</span><span class="s">&#39;#&#39;</span><span class="p">));</span>
<span class="c1">#因为shell命令执行的输出可能有滞后，所以将前后都输出</span>
<span class="k">my</span> <span class="nv">$read</span> <span class="o">=</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">before</span><span class="p">()</span> <span class="o">.</span> <span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">after</span><span class="p">();</span>
<span class="nv">$read</span> <span class="o">=~</span> <span class="sr">s/\[.+\@.+\]//</span><span class="p">;</span>
<span class="nv">$exp</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;exit\n&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">(</span><span class="nb">undef</span><span class="p">,</span><span class="s">&#39;$&#39;</span><span class="p">));</span>
<span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">soft_close</span><span class="p">();</span>
<span class="k">return</span> <span class="nv">$read</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">#package结尾，必须return一个1，原因未知……</span>
<span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>使用如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="c1">#可以在/usr/lib/perl5下，也可以在pl脚本的同目录下</span>
<span class="k">use</span> <span class="n">raocl</span><span class="p">;</span>
<span class="c1">#从文件中读取host列表为数组</span>
<span class="nb">open</span> <span class="n">FH</span><span class="p">,</span> <span class="s">&quot;./list&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@hosts</span> <span class="o">=</span> <span class="sr">&lt;FH&gt;</span><span class="p">;</span>
<span class="c1">#使用new初始化，传递host列表的引用给函数</span>
<span class="nv">$raocl</span><span class="o">=</span><span class="k">new</span> <span class="n">raocl</span><span class="p">(</span><span class="n">hosts</span><span class="o">=&gt;\</span><span class="nv">@hosts</span><span class="p">,</span>
    <span class="nb">fork</span> <span class="o">=&gt;</span> <span class="s">&#39;10&#39;</span><span class="p">,</span>
    <span class="n">output</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">debug</span>  <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">passwd</span> <span class="o">=&gt;</span> <span class="s">&#39;123456&#39;</span><span class="p">,);</span>
<span class="nv">%result</span> <span class="o">=</span> <span class="nv">$raocl</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">(</span><span class="s">&quot;$shell&quot;</span><span class="p">);</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$host</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span> <span class="nv">$host</span><span class="o">.</span><span class="s">&quot;\t&quot;</span><span class="o">.</span><span class="nv">$result</span><span class="p">{</span><span class="nv">$key</span><span class="p">},</span><span class="s">&quot;##############\n&quot;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
      <a href="/2011/05/12/learning-bless-and-write-pm-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/05/09/expect-module-of-perl" title="perl的Expect模块" rel="bookmark">perl的Expect模块</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-05-09 00:00:00 +0800">09 May 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>手头一批机器，因为历史的原因，有些密码登录、有些密钥登录，有些wheel组免密码su - root、有些又不行。为了统一管理操作，得想办法找一个能适应这四种情况的自动登录方法。</p>
<p>先看的Net::SSH2模块，用户、主机、密钥都支持列表，也有$ssh-&gt;exec();，但是最后这步su - root密码还是没法完成；
然后看的Net::SSH::Expect模块，其实就是在Expect模块外面加一层shell调用ssh命令。没有独立的参数指定密钥等，而是写在ssh_option=&gt;&rsquo; -i id_rsa &lsquo;里，更糟糕的情况是：在无密码登陆时，只能使用$ssh-&gt;run_ssh();而不能用$ssh-&gt;login();——但关于初次登陆的(yes/no)?的问题，却只在login()里有处理，run_ssh()里没有！可以修改Net/SSH/Expect.pm文件，在sub run_ssh()的return之前添加相关处理的语句：</p>
<div class="highlight"><pre><code class="perl"><span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
<span class="p">[</span><span class="err"> </span><span class="sx">qr/\(yes\/</span><span class="nb">no</span><span class="o">\</span><span class="p">)</span><span class="o">\</span><span class="p">?</span><span class="o">\</span><span class="n">s</span><span class="o">*</span><span class="vg">$/</span><span class="err"> </span><span class="o">=&gt;</span><span class="err"> </span><span class="n">sub</span><span class="err"> </span><span class="p">{</span><span class="err"> </span><span class="nv">$exp</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;yes\n&quot;</span><span class="p">);</span><span class="err"> </span><span class="n">exp_continue</span><span class="p">;</span><span class="err"> </span><span class="p">}</span><span class="err"> </span><span class="p">],</span>
<span class="p">);</span>
</code></pre></div>
<p>但运行的时候，一台内网机器，完成一次su -后ls的操作，居然平均需要消耗3s的时间。
于是干脆使用原版的Expect模块，平均单次运行时间缩短到了1.3s，如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span><span class="err"> </span><span class="n">Expect</span><span class="p">;</span>
<span class="c1">#本来还打算用cgi模块改成web界面的，但运行时不时爆出“(70007)The timeout specified has expired:</span>
<span class="c1">#ap_content_length_filter: apr_bucket_read() failed”的error_log，</span>
<span class="c1">#百度谷歌的各种结果，如$|、STDOUT、Timeout、version都查了一遍，没有结果，只好暂时放弃</span>
<span class="c1">#use CGI::Simple;</span>
<span class="c1">#my $q = new CGI::Simple;</span>
<span class="c1">#my $host = $q-&gt;param(&#39;host&#39;);</span>
<span class="c1">#my $command = $q-&gt;param(&#39;command&#39;);</span>
<span class="c1">#print $q-&gt;header;</span>
<span class="k">my</span><span class="err"> </span><span class="nv">$host</span><span class="err"> </span><span class="o">=</span><span class="err"> </span><span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="k">my</span> <span class="nv">$command</span> <span class="o">=</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="k">my</span><span class="err"> </span><span class="nv">$password</span><span class="err"> </span><span class="o">=</span><span class="err"> </span><span class="s">&#39;1234!@#$&#39;</span><span class="p">;</span>
<span class="k">my</span><span class="err"> </span><span class="nv">$exp</span><span class="err"> </span><span class="o">=</span><span class="err"> </span><span class="n">Expect</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
<span class="nv">$exp</span><span class="err"> </span><span class="o">=</span><span class="err"> </span><span class="n">Expect</span><span class="o">-&gt;</span><span class="n">spawn</span><span class="p">(</span><span class="s">&quot;ssh -l monitor -i /usr/local/monitor/etc/id_rsa $host&quot;</span><span class="p">);</span>
<span class="c1">#Expect模块的debug分析</span>
<span class="c1">#$exp-&gt;exp_internal(1);</span>
<span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span>
                 <span class="s">&#39;\$&#39;</span><span class="p">,</span>
                 <span class="n">sub</span><span class="err"> </span><span class="p">{</span>
                  <span class="k">my</span><span class="err"> </span><span class="nv">$self</span><span class="err"> </span><span class="o">=</span><span class="err"> </span><span class="nb">shift</span><span class="p">;</span>
                  <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;su -\n&quot;</span><span class="p">);</span>
                 <span class="p">}</span>
                <span class="p">],</span>
                <span class="p">[</span>
<span class="c1">#凯哥三年前的博客复制的perldoc内容，都没有\号，实际必须有！</span>
<span class="c1">#perldoc说不加-re时就是完全匹配，这很容易让人理解为==的效果，但debug告诉我不是这样滴……</span>
<span class="c1">#Net::SSH::Expect里sub login()里也用了\号，见上。</span>
                 <span class="s">&#39;\(yes/no\)\?&#39;</span><span class="p">,</span>
                 <span class="n">sub</span><span class="err"> </span><span class="p">{</span>
                  <span class="k">my</span><span class="err"> </span><span class="nv">$self</span><span class="err"> </span><span class="o">=</span><span class="err"> </span><span class="nb">shift</span><span class="p">;</span>
                  <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;yes\n&quot;</span><span class="p">);</span>
                  <span class="n">exp_continue</span><span class="p">;</span>
                  <span class="p">}</span>
                <span class="p">]</span>
<span class="p">);</span>
<span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="err"> </span><span class="p">[</span>
                 <span class="s">&#39;Password:&#39;</span><span class="p">,</span>
                 <span class="n">sub</span><span class="err"> </span><span class="p">{</span>
                  <span class="k">my</span><span class="err"> </span><span class="nv">$self</span><span class="err"> </span><span class="o">=</span><span class="err"> </span><span class="nb">shift</span><span class="p">;</span>
<span class="c1">#perldoc推荐使用$self-&gt;send_slow($timeout,&quot;command\r&quot;);的方式，不过试了下，好慢啊，算了</span>
                  <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;${password}\n&quot;</span><span class="p">);</span>
                  <span class="n">exp_continue</span><span class="p">;</span>
                  <span class="p">}</span>
                <span class="p">],</span>
                <span class="p">[</span>
                  <span class="s">&#39;#&#39;</span><span class="p">,</span>
                 <span class="n">sub</span><span class="err"> </span><span class="p">{</span>
                  <span class="k">my</span><span class="err"> </span><span class="nv">$self</span><span class="err"> </span><span class="o">=</span><span class="err"> </span><span class="nb">shift</span><span class="p">;</span>
                  <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;${command}\n&quot;</span><span class="p">);</span>
                  <span class="p">}</span>
                <span class="p">]</span>
<span class="p">);</span>
<span class="nv">$exp</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;exit\n&quot;</span><span class="p">)</span><span class="err"> </span><span class="k">if</span><span class="err"> </span><span class="p">(</span><span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">(</span><span class="nb">undef</span><span class="p">,</span><span class="s">&#39;#&#39;</span><span class="p">));</span>
<span class="nv">$exp</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;exit\n&quot;</span><span class="p">)</span><span class="err"> </span><span class="k">if</span><span class="err"> </span><span class="p">(</span><span class="nv">$exp</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">(</span><span class="nb">undef</span><span class="p">,</span><span class="s">&#39;$&#39;</span><span class="p">));</span>
</code></pre></div>
      <a href="/2011/05/09/expect-module-of-perl" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/05/06/awk_variable_example_in_linux_system_script" title="linux系统脚本中的awk一例" rel="bookmark">linux系统脚本中的awk一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-05-06 00:00:00 +0800">06 May 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>感谢@snowave童鞋，摘取了/usr/bin/run-parts最后一段的awk内容给我看：</p>
<table>
  <tbody>
    <tr>
      <td>$i 2&gt;&amp;1</td>
      <td>awk -v &ldquo;progname=$i&rdquo; &lsquo;progname {print progname &ldquo;:\n&rdquo;;progname=&rdquo;&rdquo;;} { print; }&rsquo;</td>
    </tr>
  </tbody>
</table>
<table>
  <tbody>
    <tr>
      <td>上面这行其实相当于$i 2&gt;&amp;1</td>
      <td>awk &lsquo;BEGIN{print &ldquo;&lsquo;$i&rsquo;:\n&rdquo;}{print}&rsquo; ，解释一下原版的用法：</td>
    </tr>
  </tbody>
</table>
<p>-v是定义一个awk内的变量，用来传递外面的shell变量到awk里；
progname是就是如果存在这个变量执行下面语句段；
然后在第一次print了之后把progname变量清空了，之后就不会再执行了。
最后的print就是显示管道出来的结果了。</p>
<p>不过在我的理解和实验中，每次都经过一次if判断，执行效率远远不如begin处理。不知道为什么系统脚本会采用这种写法~~</p>
      <a href="/2011/05/06/awk_variable_example_in_linux_system_script" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/04/13/test-inode-support-of-reiserfs-xfs" title="reiserfs和xfs的inode测试" rel="bookmark">reiserfs和xfs的inode测试</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-04-13 00:00:00 +0800">13 Apr 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#testing-ref" title="testing" rel="category tag">testing</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>某应用的碎文件生成太多，大量消耗inode，不得不做迁移调整。
原先的使用的NetApp存储，虽然可以调节inode，但是有一个上限，最高就是40000000——说实话真的挺小的啊~~
一个同样大小的普通服务器ext3文件系统，在没有强行指定的情况下，inode都有将近3个亿，是netapp的7倍。
了解了一下ext3文件系统在分区时指定inode最大可用数的情况，大致可以理解为小于可用空间大小/256。详细分析测试情况见：http://blog.wgzhao.com/2008/04/13/how-much-inodes-do-you-need.html，大意是inode个数由block大小和单个inode的字节决定。理论上最小block是1024，实际（采用-N强行指定的话）可能是256左右。</p>
<p>之前在做sersync的时候，发现开启xfs支持就可以对netapp使用inotify功能。因此可以认为netapp使用是（至少在inode上）类似xfs的文件系统。最终决定测试一个reiserfs和xfs在inode方面的情况——这两个文件系统都是非分布式的动态inode的文件系统。
RHEL5默认是不支持这两个fs的。需要plus一下。方法见http://www.gnutoolbox.com/reiserfs-centos/和http://wiki.centos.org/AdditionalResources/Repositories/CentOSPlus的说明。一步一步照做即可。
随后在vmware上添加一块10G的硬盘sdb，fdisk分区成sdb1和sdb2，分别mkfs.reiser和mkfs.xfs两个分区，挂载在/mnt1和/mnt2上。
这个时候df -h和df -i查看如下：
[root@localhost ~]# df -i
Filesystem            Inodes   IUsed   IFree IUse% Mounted on
/dev/sda3            1240320  144694 1095626   12% /
/dev/sda1              26104      40   26064    1% /boot
/tmpfs                 64314       1   64313    1% /dev/shm
/dev/sdb1                  0       0       0    -  /mnt1
/dev/sdb2             562240    2368  559872    1% /mnt2
[root@localhost ~]# df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/sda3              19G  4.8G   14G  27% /
/dev/sda1              99M   17M   77M  18% /boot
/tmpfs                252M     0  252M   0% /dev/shm
/dev/sdb1             471M  33M  438M   7% /mnt1
/dev/sdb2             545M   28M  517M   6% /mnt2
另开窗口，分别运行for((i=1;i&lt;562240;i++));do touch /mnt1/a<em>$i;done和for((i=1;i&lt;562240;i++));do touch /mnt2/b</em>$i;done——为了加速，实际开了四个窗口，每个命令都是同时运行两个。
一段时间后，mnt2的终端显示No space。于是中止。
此时df -i和df -h的结果如下：
[root@localhost ~]# df -i
Filesystem            Inodes   IUsed   IFree IUse% Mounted on
/dev/sda3            1240320  144694 1095626   12% /
/dev/sda1              26104      40   26064    1% /boot
/tmpfs                 64314       1   64313    1% /dev/shm
/dev/sdb1                  0       0       0    -  /mnt1
/dev/sdb2             124032  123397     635  100% /mnt2
[root@localhost ~]# df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/sda3              19G  4.8G   14G  27% /
/dev/sda1              99M   17M   77M  18% /boot
/tmpfs                252M     0  252M   0% /dev/shm
/dev/sdb1             471M   60M  411M  13% /mnt1
/dev/sdb2             545M  545M  144K 100% /mnt2
可以发现，xfs的空间没有变化（说这句是因为ext3在强制inode数变大的时候，可用空间会变小），但inode总数“神奇”的缩水了4倍！！
继续等待，直到mnt1的for循环执行完成，这时候df -h结果如下：[root@localhost ~]# df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/sda3              19G  4.8G   14G  27% /
/dev/sda1              99M   17M   77M  18% /boot
/tmpfs                252M     0  252M   0% /dev/shm
/dev/sdb1             471M  134M  338M  29% /mnt
根据最后的结果算471<em>1024/562240/2=0.43K， 545</em>1024/124032=4.5K。看来对于空文件，reiserfs很压缩，而xfs则老老实实的做block了。</p>
      <a href="/2011/04/13/test-inode-support-of-reiserfs-xfs" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/04/05/learning-suse-linux-enterprise-desktop-system-analysis-and-tuning-guide" title="《SUSE Linux Enterprise Desktop System Analysis and Tuning Guide》读书笔记" rel="bookmark">《SUSE Linux Enterprise Desktop System Analysis and Tuning Guide》读书笔记</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-04-05 00:00:00 +0800">05 Apr 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>这是一本比上篇提到的老书新很多、厚很多的调优指南。虽然至今没用过suse，但同是linux内核，与redhat差距不算太大。目前只打印并看到了systemtap章节，感觉很多内容说的比上本书细致的多，继续做笔记~
<!--more-->
1 General Notes on System Tuning
1.2 Rule Out Common Problems
检查/var/log/warn和/var/log/messages中的异常条目；
用top或ps命令检查是否有进程吃了太多CPU和内存；
通过/proc/net/dev检查网络问题；
用smartmontools检查硬盘IO问题；
确认后台进程都是在系统负载较低的时候运行的，可以通过nice命令调整其优先级；
一台服务器运行太多使用相同资源的服务的话，考虑拆分；
升级软件。
2 System Monitoring Utilities
2.1 Multi-Purpose Tools
2.1.1 vmstat
第一行输出显示的从最近一次重启以来的平均值
各列说明：
r 运行队列中的进程数。这些进程等待cpu的空闲以便执行。如果该数值长期大于cpu核数，说明cpu不足；
b 等待除了cpu以外的其他资源的进程数。通常是IO不足；
swpd 已用swap空间，单位KB；
free 未用内存空间，单位KB；
inact 可以回收的未用内存空间，只有当使用-a参数时才显示——建议使用该参数；
active 使用中且没有回收的内存空间，同样只在-a时显示；
buff 内存中的文件缓冲空间；相反，-a时不显示；
cache 内存中的页缓存空间；-a不显示；
si 每秒从内存移动到swap的数据大小，单位KB；
so 每秒从swap移动到内存的数据大小，单位KB，以上两个数长期偏大的话，机器需要加内存；
bi 每秒从块设备中获取的块数量——注意swap也是块设备，包含在内！
bo 每秒发送到块设备的块数量，同样包括swap；
in 每秒中断数，数值越大说明IO级别越高；
cs 每秒文本交换数，这个代表内核从内存中某进程中提取替换掉另一个进程的可执行代码——茫然？？
us 用户空间的cpu使用率；
sy 系统空间的cpu使用率；
id cpu时间中的空闲比——就算它是0，也不一定就是什么坏事，还得看r和b两个数值来判断；
wa 如果这个数不等于0，那说明系统吞吐在等待IO。这或许是不可避免的。比如如果一个文件是第一次被读取（即没有缓存），那同时的后台写必然挂起。这个数也是硬件瓶颈的一个指标（网络或者磁盘）。最后，还有可能是虚拟内存管理上的问题；
st cpu用在虚拟管理上的比例。
2.1.2 System Activity Information: sar and sadc
sadc其实就是在/etc/cron.d中添加的任务。原始数据写入/var/log/sa/saDD中，报告数据写入/var/logs/sar/sarDD中。默认配置，数据每10分钟一收集；报告每6小时一收集。详见/etc/sysstat/sysstat.cron；数据收集脚本是/usr/lib64/sa/sa1；数据报告脚本是/usr/lib64/sa/sa2；有必要的话可以自己用这两个脚本收集性能数据。
sar -f指定特定的数据文件出报告
sar -P指定某一个CPU出报告
sar -r显示内存信息：kbcommit和%commit显示了当前工作负载下可能需要的最大内存（含swap）；
sar -B显示内核页信息：majflt/s显示了每秒钟有多少页从硬盘（含swap）读入内存，这个数太大意味着系统很慢，而且内存不足；%vmeff显示了页扫描(pascand/s)及其相关的缓冲重用率(pgsteal/s),用以衡量页面回收的效率，数值接近100说明所有so的页都重用了，接近0说明没有被扫描的页，这都很好，但不要在0-30%之间。
sar -d显示块设备信息，最好加上-p显示设备名；
sar -n显示网络信息，包括DEV/EDEV/NFS/NFSD/SOCK/ALL
2.2 System Information
2.2.1 iostat
-n显示nfs；
-x显示增强型信息；
2.2.3 pidstat
-C &ldquo;top&rdquo;显示命令名中包括top字符串的目标。
2.2.5 lsof
无参数：打开的所有文件
-i：网络文件
2.2.6 udevadm
本工具只有root可以使用
2.3 Processes
2.3.2 ps
显示具体某进程：ps -p $(pidof ssh)
显示格式和排序：ps ax &ndash;format pid,rss,cmd &ndash;sort rss
显示单独进程：ps axo pid,$cpu,rss,vsz,args,wchan,etime
显示进程树：ps axfo pid,args
2.3.4 top
默认每2秒钟一刷新；
显示一次即退出：-n 1
shift+p——以CPU使用率排列(默认)；
shift+m——以常驻内存排列；
shift+n——以进程号排列；
shift+t——以时间排列；
2.4 Memory
2.4.1 free
free -d 1.5——每1.5秒一刷新数据
2.4.3 smaps
在/proc/${pid}/smaps中看到的是进程当前的内存页数量，即除掉共享内存以外的真正进程使用的内存大小。
2.5 Networking
2.5.1 netstat
-r路由；-i网卡；-M伪装链接；-g广播成员；-s信息
2.5.2 iptraf
iptraf -i eth0 -t 1 -B -L iptraf.log
eth0网卡一分钟内的信息，后台收集，记入iptraf.log中。
2.6 The /proc File System
/proc/devices 可用设备
/proc/modules 已加载内核模块
/proc/cmdline 内核命令行
/proc/meminfo 内存使用详细信息
/proc/config.gz 内核当前运行配置的压缩文件
详细说明见/usr/src/linux/Documentation/filesystems/proc.txt
执行的进程和库文件以及他们在内存的地址信息见/proc/***/maps文件。</p>
      <a href="/2011/04/05/learning-suse-linux-enterprise-desktop-system-analysis-and-tuning-guide" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/04/01/learning-tuning-red-hat-enterprise-linux-on-ibm-server-xseries-servers" title="《Tuning Red Hat Enterprise Linux on IBM server xSeries Servers》读书笔记" rel="bookmark">《Tuning Red Hat Enterprise Linux on IBM server xSeries Servers》读书笔记</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-04-01 00:00:00 +0800">01 Apr 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一本很老的书，还是RHEL3时代的，在陪GF的空隙一点点读完，把笔记整理一下发在这里，只包括自己不知道或者说容易忘记的内容，不代表调优指南。<!--more-->
1 Tuning the operating system
1.1 Disabling daemons
关闭不必要的后台进程。RHEL3中，默认启动的后台进程有：
apmd 高级电源管理
autofs 自动挂载
cups 通用UNIX打印机系统
hpoj 惠普打印机支持
isdn 调制解调器
netfs nfslock portmap NFS支持
pcmcia PCMCIA支持
rhnsd 自动升级
sendmail 邮件转发程序
xfs 桌面程序
1.2 Shutting down the GUI
runlevel:
0 halt立刻关机immediately shut down
1 single单人
2 multi-user without NFS（这个说明和一般的说法不太一样~）
3 full multi-user
5 X11
6 reboot
修改/etc/inittab如下：
id:3:initdefault:		#runlevel
#4:2345:respawn:/sbin/mingetty tty4		#关闭多余控制台
注意：留3个，以免在被攻击的时候自己反而进不去了！
1.4 Changing kernel parameters
/proc/loadavg 系统负载1/5/15分钟
/proc/stat 内核状态：进程/swap/磁盘IO
/proc/cpuinfo CPU信息
/proc/meminfoo 内存信息
/proc/sys/fs/* linux可用文件数及磁盘配额
/proc/sys/kernel/* 进程号范围/系统日志级别
/proc/sys/net/* 网络细节
/proc/sys/vm/* 内存缓冲管理
1.7 Tuning the processor subsystem
CPU超线程注意事项:
注意使用SMP的kernel
实际CPU数越多，超线程意义越小：
2核：提升15-25%
4核：提升1-1%
8核：提升0-5%
1.8 Tuning the memory subsystem
如果决定调整/proc/sys/vm/*的参数，最好一次只调整一个。
vm.dbflush前3个参数分别为：
nfract 在buffer被转存到disk前允许的最大buffer比率
ndirty 将buffer转到disk时一次允许操作最大的buffer数
nfract_sync 转存时允许buffer中dirty数据的最大比率
vm.kswapd
tries_base 一次swap传输时的pages数。如果swapping较大，适当增加该值
tries_min kswapd运行时交换的pages的最小数
swap_cluster kswapd一次写入pages的数。太小会增加IO次数，太大又要等待请求队列
1.9 Tuning the file subsystem
磁盘访问速度是ms级别的，而内存是ns，PCI是us。
磁盘IO是最关键的问题服务器举例：
文件/打印服务器：所有数据从磁盘读取
数据库服务器：大量IO，在内存和磁盘间交换数据
磁盘IO不是最关键的问题服务器举例：
邮件服务器：网络状况才是最关键的。
web服务器：网络和内存才是最关键的&hellip;..
1.9.5 The swap partition
创建多个swap区有助于提升swap性能
通常情况，多个swap采用顺序读写，即只有/etc/fstab中排名在前的swap区耗尽的情况下，才会使用下一个swap区；
可以在fstab中定义优先级，类似&rdquo;/dev/sda2 swap swap sw,pri=5 0 0&rdquo;的格式；
相同优先级的swap区，系统会并发使用，不同优先级之间依然要等待耗尽！——另外，如果相同优先级的swap区有一个性能较差，会连带影响整个swap性能。
1.10 Tuning the network subsystem
网络问题经常会导致其他伴生问题。比如：块大小太小会给CPU利用率带来显著影响；TCP连接数过多会带来内存使用率的急速上升……
经常被打开的net.ipv4.tcp_tw_reuse和net.ipv4.tcp_tw_recycle的作用：缓存TCP交互中的客户端信息，包括交互时间、最大段大小，阻塞窗口。详见RFC1644。
net.ipv4.tcp_fin_timeout可以缩短TCP建连时最后发送FIN序列的时间，以便快速释放内存提供给新进连接请求。但是修改这个的时候也要谨慎，因为由此导致的死套接字数量可能引起内存溢出！
net.core.wmem_max/net.core.rmem_max定义在每个TCP套接字创建时划分的内存大小，推荐设置8MB。
net.ipv4.tcp_wmem/net.ipv4.tcp_rmem的最后一个数字不能大于上面core的定义。
net.ipv4.tcp_max_syn_backlog队列存放半连接。这些连接可能是因为客户端的连接异常，也可能仅仅是因为服务器负载太高导致。除了半连接，这个配置对防范拒绝服务攻击也有效。
net.ipv4.ipfrag_low_thresh/net.ipv4.ipfrag_high_thresh规范ip碎片，一旦触底，内核会开始丢包。这对于NFS和samba等文件服务器很重要，建议设置为256和384MB。
2 Tuning tools
2.3 top
STAT:S=SLEEPING,R=RUNNING,T=TRACED/STOPPED,D=INTERRUPTIBLE SLEEP,Z=ZOMBIE
2.3.1 Process priority and nice levels
优先级从19（最低）到-19（最高），默认是0。启动进程时指定nice -n 19 command，启动后改变renice 19 command
2.4 iostat
tps:transfers per second,多个单独的IO请求，可以组合在一次transfer请求中。
Blk_read/s,Blk_wrtn/s:每秒的读写块个数。block大小和transfer大小一样各不相同。一般是1、2、4KB，采用如下命令查看：dumpe2fs -h /dev/sda1 | grep -F &lsquo;Block Size&rsquo;
2.5 vmstat
Process：r:等待运行的进程数，b:不可中断睡眠中的进程数
Swap：单位是KBps
CPU：us:非内核时间，包括user和nice，id:在linux2.5.41前，这个数值包括了IOwait时间在内……
2.11 ulimit
-H和-S分别是hard和soft，开机启动指定的话，修改/etc/security/limits.conf即可。
2.12 mpstat
用来在多CPU的机器上查看每个CPU的情况。
3. Analyzing performance bottlenecks
3.1 Identifying bottlenecks
快速调优策略：
a. 了解你的系统；
b. 备份系统；
c. 监控、分析系统性能；
d. 缩小瓶颈，找出根源；
e. 解决瓶颈的时候一次只修改一个地方；
f. 返回c步骤继续，直到满意。
3.1.1 Gathering information
在收到“服务器出问题了”的报警时，提出下列问题，可以更加有效地收集信息进行故障定位：
Q:服务器的完整描述？包括：模块、使用时长、配置、外围设备、操作系统版本号……
Q:能准确描述一下问题所在么？包括：症状表现、各种错误日志记录……
Q:问题是谁碰到/发现的？一个人、某些特定的人群，还是所有的用户？由此可以大概猜测问题是网络、应用还是客户电脑。另外：性能问题可能不会立刻从服务器反应到客户端上来，因为网络延迟经常会覆盖掉其他问题。这个延迟包括网络设备，也包括其他服务器提供的网络服务，比如域名解析~
Q:问题可以再现么？所有可以再现的问题都是可以解决的！
重现故障的步骤是什么？这可以协助你在测试环境完成调优工作。
问题是持续发生的么？如果是断续发生的，赶紧找出让它重现的办法，最好就是能按你的剧本指令重现……
问题是不是周期性的固定某个时间发生？查查那时候是不是有人登陆了？尝试梗概系统，看问题会重现么？
问题真的很不常见？如果真是如此，那只能说rp有问题了，事实上，绝大多数问题都是可重现的~对没法重现的，那就出网管绝招：reboot、然后更新升级驱动和补丁。
Q:问题什么时候开始的？逐渐显现还是突然爆发？如果是逐渐，那应该是积累出来的；如果是突然，那考虑是不是外设做了改动。
Q:服务器是不是有变动，或者客户端的使用方法变了？
Q:事情紧急么？要求几分钟内搞定还是未来几天？
3.1.2 Analyzing the server&rsquo;s performance
在任何排障动作前，牢记备份！！
有必要为服务器创建一份性能日志，内容包括：进程、系统、工作队列、内存、交换页、磁盘、重定向、网卡……
3.2 CPU bottlenecks
动态应用/数据库服务器，CPU常常是瓶颈，但实际经常是CPU在等待其他方面的响应。
3.2.1 Finding CPU boottlenecks
注意：同时不要运行多个工具，以免给CPU增加负载
3.2.2 SMP
进程在CPU之间进行切换时需要消耗一点的时间，所以绑定CPU比较有用。
3.2.3 Performance tuning options
关闭非必须进程；调成优先级；绑定CPU；CPU主频，是否多核；更新驱动；
3.3 Memory bottlenecks
free命令参数-l -t -o，分别表示low/high，total，old（不显示buffer信息）
3.3.2 Performance tuning options
调整页大小，默认是4/8KB；限定user资源limits.conf；……
3.4 Disk bottlenecks
常见问题：一、硬盘数太少；二、分区数太多，导致磁头寻址时间变大。
3.4.1 Finding disk bottlenecks
写缓冲；磁盘控制器负载；网络延时导致响应慢；IO等待队列
随机读写还是顺序读写？单次IO大还是小？
表3-2
磁盘转速 latency seek-time random-access-time IOPS Throughout
15000    2ms      3.8ms      6.8ms                    147  1.15MBps
10000    3ms      4.9ms      8.9ms                    112  900KBps
7200     4.2ms    9ms        13.2ms                    75   600KBps
在一个大概70%读30%写的随机IO型正常负载的服务器上，采用RAID10比RAID5能提高50-60%的性能。
 打开文件太多时，会因为寻址时间太长导致响应的变慢
iostat的指标：
%util 被IO请求消耗的CPU比例
svctm 完成一个请求的平均时间，单位ms
await 一个IO请求等待服务的平均时间，单位ms
avgqu-sz 平均队列长度
avgrq-sz 平均请求大小
rrqm/s 发送到磁盘的每秒合并读请求数
wrqm/s 发送到磁盘的每秒合并写请求数
3.4.2 Performance tuning options
顺序读写换磁头；随机读写加磁盘；用硬件RAID卡；加内存
3.5 Network bottlenecks
    3.5.2 Performance tuning options
    检查路由配置；子网；网卡速率；TCP内核参数；换网卡；bonding
4 Tuning Apache
4.1 Gathering a baseline
吞吐量：每秒请求数和每秒传输字节数；请求处理响应时间……
4.5 Operating system optimization
文件打开数；进程数；文件访问时间——不记录atime的作用是消减IO峰值！
4.6 Apache 2 optimizations
如果文件是通过NFS方式发布的，apache不会采用sendfile方式缓存文件，配置文件请选择“EnableSendfile Off”！
4.6.1 Multi-processing module directives
经常需要重启的，加大StartServer；
负载较大的，加大MinSpareServers到25，MaxSpareServers到125；
MaxClients最大只能是256，内存不足时应该减少；
4.6.2 Compression of data
默认的6级压缩比，可以带来72%的带宽减小。太高级别压缩，对CPU有影响。
在测试中，启用压缩的apache带宽减小70%；cpu负载上升87%到饱和状态，能同时处理的客户端请求数降到三分之一。
vary头的作用：告知代理服务器对支持压缩的客户端只发送压缩后的内容。
apache2只在客户端请求包含Accept-encoding: gzip和Accept-encoding: gzip, deflate的时候才压缩数据。
4.6.3 Logging
使用WebBench的时候，一般会有2%的请求是404的，这可能导致error_log迅速变大！
5 Tuning database servers
5.1 Important subsystems
CPU：
数据库都是多线程的，最好使用16核以上CPU，2级缓存相当重要，命中率最好在90%以上；
内存：
缓冲是数据库最重要的部分。编译内核时请确认CONFIG_HIGHMEM64G_HIGHPTE=y这项。
磁盘：
数据库会有大量的磁盘IO以完成数据在内存和硬盘的交换。一般每个xeon的CPU需要对应10块高速硬盘，最好能有50块10000转的磁盘。IBM的xSeries 370使用450块10000转磁盘以达到最大吞吐量——每分钟40000次交换。</p>
<p>笔记到此为止。之后的内容是DB2的调优，samba、ldap、lotus章节，就没看了……</p>
      <a href="/2011/04/01/learning-tuning-red-hat-enterprise-linux-on-ibm-server-xseries-servers" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/31/problem-of-php-compile-option" title="php编译参数问题一例" rel="bookmark">php编译参数问题一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-31 00:00:00 +0800">31 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#php-ref" title="php" rel="category tag">php</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>某php应用在给图片加水印的时候，显示的中文全都成了乱码，而开发同事在它本机(ubuntu)上apt安装的lamp上显示没有问题。仔细检查过了从env到encoding到phpinfo，都没有发现问题——都符合GD函数imagettftext()的utf8要求。
还好有google，发现一个类似的文章，提出是php的编译参数中有一个&ndash;enable-gd-jis-conv，会把ttf字库中非标准拉丁文的部分，按照日文顺序映射，imagettftext()的默认编码其实被隐形指定成了日文编码euc-jp，中文自然就不正常了！
然后赶紧重新看phpinfo，真有这个参数。重新编译php，随后恢复正常显示了。
编译参数还真是不能大意啊～～</p>
      <a href="/2011/03/31/problem-of-php-compile-option" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page5">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page active">
      <a href="#">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li>
      <a href="/page7">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.icylife.net/blog/" title="">心路</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://dbahacker.com/" title="TB 杨德华">DBA Hacker</a></li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.laird-sa.com/" title="">Laird-SA</a></li>
              <li><a href="http://www.linuxsee.com/" title="">LinuxSEE</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://www.puppeter.cn/" title="">piol</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.sanote.org/" title="">sa note</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://blog.ops.tudou.com/wp/" title="">土豆运营团队</a></li>
              <li><a href="http://www.91tuanfang.com/" title="安居客运维">家欣的天空</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://www.opboy.com" title="">运维小子</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://l09.me/" title="风声">风声</a></li>
              <li><a href="http://moyan.tk/" title="莫言">莫言</a></li>
              <li><a href="http://mooser.me/" title="牛氓">牛氓</a></li>
              <li><a href="http://http://www.yinwang.org/" title="当然我在扯淡">当然我在扯淡</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://muxueqz.laou.me" title="muxueqz">聊逍遥兮容与</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://paperplane.ruhoh.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
          </ul>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
