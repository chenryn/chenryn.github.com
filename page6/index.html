<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
      	<li><a href="/tags.html">Tags</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://feed.feedsky.com/chenlinux" rel="alternate" /><a href="http://feed.feedsky.com/chenlinux" target="_blank">RSS订阅</a></li>
            <li><a href="/links.html">友情链接</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/04/13/test-inode-support-of-reiserfs-xfs" title="reiserfs和xfs的inode测试" rel="bookmark">reiserfs和xfs的inode测试</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-04-13 00:00:00 +0800">13 Apr 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#testing-ref" title="testing" rel="category tag">testing</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body><p>某应用的...</p></body></html>
      <a href="/2011/04/13/test-inode-support-of-reiserfs-xfs" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/04/05/learning-suse-linux-enterprise-desktop-system-analysis-and-tuning-guide" title="《SUSE Linux Enterprise Desktop System Analysis and Tuning Guide》读书笔记" rel="bookmark">《SUSE Linux Enterprise Desktop System Analysis and Tuning Guide》读书笔记</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-04-05 00:00:00 +0800">05 Apr 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body><p>这是一本比上篇提到的老书新很多、厚很多的调优指南。虽然至今没用过suse，但同是linux内核，与redhat差距不算太大。目前只打印并看到了systemtap章节，感觉很多内容说的比上本书细致的多，继续做笔记~
<!--more-->
1 General Notes on System Tuning
1.2 Rule Out Common Problems
检查/var/log/warn和/var/log/messages中的异常条目；
用top或ps命令检查是否有进程吃了太多CPU和内存；
通过/proc/net/dev检查网络问题；
用smartmontools检查硬盘IO问题；
确认后台进程都是在系统负载较低的时候运行的，可以通过nice命令调整其优先级；
一台服务器运行太多使用相同资源的服务的话，考虑拆分；
升级软件。
2 System Monitoring Utilities
2.1 Multi-Purpose Tools
2.1.1 vmstat
第一行输出显示的从最近一次重启以来的平均值
各列说明：
r 运行队列中的进程数。这些进程等待cpu的空闲以便执行。如果该数值长期大于cpu核数，说明cpu不足；
b 等待除了cpu以外的其他资源的进程数。通常是IO不足；
swpd 已用swap空间，单位KB；
free 未用内存空间，单位KB；
inact 可以回收的未用内存空间，只有当使用-a参数时才显示——建议使用该参数；
active 使用中且没有回收的内存空间，同样只在-a时显示；
buff 内存中的文件缓冲空间；相反，-a时不显示；
cache 内存中的页缓存空间；-a不显示；
si 每秒从内存移动到swap的数据大小，单位KB；
so 每秒从swap移动到内存的数据大小，单位KB，以上两个数长期偏大的话，机器需要加内存；
bi 每秒从块设备中获取的块数量——注意swap也是块设备，包含在内！
bo 每秒发送到块设备的块数量，同样包括swap；
in 每秒中断数，数值越大说明IO级别越高；
cs 每秒文本交换数，这个代表内核从内存中某进程中提取替换掉另一个进程的可执行代码——茫然？？
us 用户空间的cpu使用率；
sy 系统空间的cpu使用率；
id cpu时间中的空闲比——就算它是0，也不一定就是什么坏事，还得看r和b两个数值来判断；
wa 如果这个数不等于0，那说明系统吞吐在等待IO。这或许是不可避免的。比如如果一个文件是第一次被读取（即没有缓存），那同时的后台写必然挂起。这个数也是硬件瓶颈的一个指标（网络或者磁盘）。最后，还有可能是虚拟内存管理上的问题；
st cpu用在虚拟管理上的比例。
2.1.2 System Activity Information: sar and sadc
sadc其实就是在/etc/cron.d中添加的任务。原始数据写入/var/log/sa/saDD中，报告数据写入/var/logs/sar/sarDD中。默认配置，数据每10分钟一收集；报告每6小时一收集。详见/etc/sysstat/sysstat.cron；数据收集脚本是/usr/lib64/sa/sa1；数据报告脚本是/usr/lib64/sa/sa2；有必要的话可以自己用这两个脚本收集性能数据。
sar -f指定特定的数据文件出报告
sar -P指定某一个CPU出报告
sar -r显示内存信息：kbcommit和%commit显示了当前工作负载下可能需要的最大内存（含swap）；
sar -B显示内核页信息：majflt/s显示了每秒钟有多少页从硬盘（含swap）读入内存，这个数太大意味着系统很慢，而且内存不足；%vmeff显示了页扫描(pascand/s)及其相关的缓冲重用率(pgsteal/s),用以衡量页面回收的效率，数值接近100说明所有so的页都重用了，接近0说明没有被扫描的页，这都很好，但不要在0-30%之间。
sar -d显示块设备信息，最好加上-p显示设备名；
sar -n显示网络信息，包括DEV/EDEV/NFS/NFSD/SOCK/ALL
2.2 System Information
2.2.1 iostat
-n显示nfs；
-x显示增强型信息；
2.2.3 pidstat
-C “top”显示命令名中包括top字符串的目标。
2.2.5 lsof
无参数：打开的所有文件
-i：网络文件
2.2.6 udevadm
本工具只有root可以使用
2.3 Processes
2.3.2 ps
显示具体某进程：ps -p $(pidof ssh)
显示格式和排序：ps ax –format pid,rss,cmd –sort rss
显示单独进程：ps axo pid,$cpu,rss,vsz,args,wchan,etime
显示进程树：ps axfo pid,args
2.3.4 top
默认每2秒钟一刷新；
显示一次即退出：-n 1
shift+p——以CPU使用率排列(默认)；
shift+m——以常驻内存排列；
shift+n——以进程号排列；
shift+t——以时间排列；
2.4 Memory
2.4.1 free
free -d 1.5——每1.5秒一刷新数据
2.4.3 smaps
在/proc/${pid}/smaps中看到的是进程当前的内存页数量，即除掉共享内存以外的真正进程使用的内存大小。
2.5 Networking
2.5.1 netstat
-r路由；-i网卡；-M伪装链接；-g广播成员；-s信息
2.5.2 iptraf
iptraf -i eth0 -t 1 -B -L iptraf.log
eth0网卡一分钟内的信息，后台收集，记入iptraf...</p></body></html>
      <a href="/2011/04/05/learning-suse-linux-enterprise-desktop-system-analysis-and-tuning-guide" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/04/01/learning-tuning-red-hat-enterprise-linux-on-ibm-server-xseries-servers" title="《Tuning Red Hat Enterprise Linux on IBM server xSeries Servers》读书笔记" rel="bookmark">《Tuning Red Hat Enterprise Linux on IBM server xSeries Servers》读书笔记</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-04-01 00:00:00 +0800">01 Apr 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body><p>一本很老的书，还是RHEL3时代的，在陪GF的空隙一点点读完，把笔记整理一下发在这里，只包括自己不知道或者说容易忘记的内容，不代表调优指南。<!--more-->
1 Tuning the operating system
1.1 Disabling daemons
关闭不必要的后台进程。RHEL3中，默认启动的后台进程有：
apmd 高级电源管理
autofs 自动挂载
cups 通用UNIX打印机系统
hpoj 惠普打印机支持
isdn 调制解调器
netfs nfslock portmap NFS支持
pcmcia PCMCIA支持
rhnsd 自动升级
sendmail 邮件转发程序
xfs 桌面程序
1.2 Shutting down the GUI
runlevel:
0 halt立刻关机immediately shut down
1 single单人
2 multi-user without NFS（这个说明和一般的说法不太一样~）
3 full multi-user
5 X11
6 reboot
修改/etc/inittab如下：
id:3:initdefault:		#runlevel
#4:2345:respawn:/sbin/mingetty tty4		#关闭多余控制台
注意：留3个，以免在被攻击的时候自己反而进不去了！
1.4 Changing kernel parameters
/proc/loadavg 系统负载1/5/15分钟
/proc/stat 内核状态：进程/swap/磁盘IO
/proc/cpuinfo CPU信息
/proc/meminfoo 内存信息
/proc/sys/fs/* linux可用文件数及磁盘配额
/proc/sys/kernel/* 进程号范围/系统日志级别
/proc/sys/net/* 网络细节
/proc/sys/vm/* 内存缓冲管理
1.7 Tuning the processor subsystem
CPU超线程注意事项:
注意使用SMP的kernel
实际CPU数越多，超线程意义越小：
2核：提升15-25%
4核：提升1-1%
8核：提升0-5%
1.8 Tuning the memory subsystem
如果决定调整/proc/sys/vm/*的参数，最好一次只调整一个。
vm.dbflush前3个参数分别为：
nfract 在buffer被转存到disk前允许的最大buffer比率
ndirty 将buffer转到disk时一次允许操作最大的buffer数
nfract_sync 转存时允许buffer中dirty数据的最大比率
vm.kswapd
tries_base 一次swap传输时的pages数。如果swapping较大，适当增加该值
tries_min kswapd运行时交换的pages的最小数
swap_cluster kswapd一次写入pages的数。太小会增加IO次数，太大又要等待请求队列
1.9 Tuning the file subsystem
磁盘访问速度是ms级别的，而内存是ns，PCI是us。
磁盘IO是最关键的问题服务器举例：
文件/打印服务器：所有数据从磁盘读取
数据库服务器：大量IO，在内存和磁盘间交换数据
磁盘IO不是最关键的问题服务器举例：
邮件服务器：网络状况才是最关键的。
web服务器：网络和内存才是最关键的…..
1.9.5 The swap partition
创建多个swap区有助于提升swap性能
通常情况，多个swap采用顺序读写，即只有/etc/fstab中排名在前的swap区耗尽的情况下，才会使用下一个swap区；
可以在fstab中定义优先级，类似”/dev/sda2 swap swap sw,pri=5 0 0”的格式；
相同优先级的swap区，系统会并发使用，不同优先级之间依然要等待耗尽！——另外，如果相同优先级的swap区有一个性能较差，会连带影响整个swap性能。
1.10 Tuning the network subsystem
网络问题经常会导致其他伴生问题。比如：块大小太小会给CPU利用率带来显著影响；TCP连接数过多会带来内存使用率的急速上升……
经常被打开的net.ipv4.tcp_tw_reuse和net.ipv4.tcp_tw_recycle的作用：缓存TCP交互中的客户端信息，包括交互时间、最大段大小，阻塞窗口。详见RFC1644。
net.ipv4.tcp_fin_timeout可以缩短TCP建连时最后发送FIN序列的时间，以便快速释放内存提供给新进连接请求。但是修改这个的时候也要谨慎，因为由此导致的死套接字数量可能引起内存溢出！
net.core.wmem_max/net.core.rmem_max定义在每个TCP套接字创建时划分的内存大小，推荐设置8MB。
net.ipv4.tcp_wmem/net.ipv4.tcp_rmem的最后一个数字不能大于上面core的定义。
net.ipv4.tcp_max_syn_backlog队列存放半连接。这些连接可能是因为客户端的连接异常，也可能仅仅是因为服务器负载太高导致。除了半连接，这个配置对防范拒绝服务攻击也有效。
net.ipv4.ipfrag_low_thresh/net.ipv4.ipfrag_high_thresh规范ip碎片，一旦触底，内核会开始丢包。这对于NFS和samba等文件服务器很重要，建议设置为256和384MB。
2 Tuning tools
2.3 top
STAT:S=SLEEPING,R=RUNNING,T=TRACED/STOPPED,D=INTERRUPTIBLE SLEEP,Z=ZOMBIE
2.3.1 Process priority and nice levels
优先级从19（最低）到-19（最高），默认是0。启动进程时指定nice -n 19 command，启动后改变renice 19 command
2.4 iostat
tps:transfers per second,多个单独的IO请求，可以组合在一次transfer请求中。
Blk_read/s,Blk_wrtn/s:每秒的读写块个数。block大小和transfer大小一样各不相同。一般是1、2、4KB，采用如下命令查看：dumpe2fs -h /dev/sda1 | grep -F ‘Block Size’
2.5 vmstat
Process：r:等待运行的进程数，b:不可中断睡眠中的进程数
Swap：单位是KBps
CPU：us:非内核时间，包括user和nice，id:在linux2.5.41前，这个数值包括了IOwait时间在内……
2.11 ulimit
-H和-S分别是hard和soft，开机启动指定的话，修改/etc/security/limits.conf即可。
2.12 mpstat
用来在多CPU的机器上查看每个CPU的情况。
3. Analyzing performance bottlenecks
3.1 Identifying bottlenecks
快速调优策略：
a. 了解你的系统；
b. 备份系统；
c. 监控、分析系统性能；
d. 缩小瓶颈，找出根源；
e. 解决瓶颈的时候一次只修改一个地方；
f. 返回c步骤继续，直到满意。
3.1.1 Gathering information
在收到“服务器出问题了”的报警时，提出下列问题，可以更加有效地收集信息进行故障定位：
Q:服务器的完整描述？包括：模块、使用时长、配置、外围设备、操作系统版本号……
Q:能准确描述一下问题所在么？包括：症状表现、各种错误日志记录……
Q:问题是谁碰到/发现的？一个人、某些特定的人群，还是所有的用户？由此可以大概猜测问题是网络、应用还是客户电脑。另外：性能问题可能不会立刻从服务器反应到客户端上来，因为网络延迟经常会覆盖掉其他问题。这个延迟包括网络设备，也包括其他服务器提供的网络服务，比如域名解析~
Q:问题可以再现么？所有可以再现的问题都是可以解决的！
重现故障的步骤是什么？这可以协助你在测试环境完成调优工作。
问题是持续发生的么？如果是断续发生的，赶紧找出让它重现的办法，最好就是能按你的剧本指令重现……
问题是不是周期性的固定某个时间发生？查查那时候是不是有人登陆了？尝试梗概系统，看问题会重现么？
问题真的很不常见？如果真是如此，那只能说rp有问题了，事实上，绝大多数问题都是可重现的~对没法重现的，那就出网管绝招：reboot、然后更新升级驱动和补丁。
Q:问题什么时候开始的？逐渐显现还是突然爆发？如果是逐渐，那应该是积累出来的；如果是突然，那考虑是不是外设做了改动。
Q:服务器是不是有变动，或者客户端的使用方法变了？
Q:事情紧急么？要求几分钟内搞定还是未来几天？
3.1.2 Analyzing the server’s performance
在任何排障动作前，牢记备份！！
有必要为服务器创建一份性能日志，内容包括：进程、系统、工作队列、内存、交换页、磁盘、重定向、网卡……
3.2 CPU bottlenecks
动态应用/数据库服务器，CPU常常是瓶颈，但实际经常是CPU在等待其他方面的响应。
3.2.1 Finding CPU boottlenecks
注意：同时不要运行多个工具，以免给CPU增加负载
3.2.2 SMP
进程在CPU之间进行切换时需要消耗一点的时间，所以绑定CPU比较有用。
3.2.3 Performance tuning options
关闭非必须进程；调成优先级；绑定CPU；CPU主频，是否多核；更新驱动；
3.3 Memory bottlenecks
free命令参数-l -t -o，分别表示low/high，total，old（不显示buffer信息）
3.3.2 Performance tuning options
调整页大小，默认是4/8KB；限定user资源limits.conf；……
3.4 Disk bottlenecks
常见问题：一、硬盘数太少；二、分区数太多，导致磁头寻址时间变大。
3.4.1 Finding disk bottlenecks
写缓冲；磁盘控制器负载；网络延时导致响应慢；IO等待队列
随机读写还是顺序读写？单次IO大还是小？
表3-2
磁盘转速 latency seek-time random-access-time IOPS Throughout
15000    2ms      3.8ms      6.8ms                    147  1.15MBps
10000    3ms      4.9ms      8.9ms                    112  900KBps
7200     4.2ms    9ms        13.2ms                    75   600KBps
在一个大概70%读30%写的随机IO型正常负载的服务器上，采用RAID10比RAID5能提高50-60%的性能。
 打开文件太多时，会因为寻址时间太长导致响应的变慢
iostat的指标：
%util 被IO请求消耗的CPU比例
svctm 完成一个请求的平均时间，单位ms
await 一个IO请求等待服务的平均时间，单位ms
avgqu-sz 平均队列长度
avgrq-sz 平均请求大小
rrqm/s 发送到磁盘的每秒合并读请求数
wrqm/s 发送到磁盘的每秒合并写请求数
3.4.2 Performance tuning options
顺序读写换磁头；随机读写加磁盘；用硬件RAID卡；加内存
3.5 Network bottlenecks
    3.5.2 Performance tuning options
    检查路由配置；子网；网卡速率；TCP内核参数；换网卡；bonding
4 Tuning Apache
4.1 Gathering a baseline
吞吐量：每秒请求数和每秒传输字节数；请求处理响应时间……
4.5 Operating system optimization
文件打开数；进程数；文件访问时间——不记录atime的作用是消减IO峰值！
4.6 Apache 2 optimizations
如果文件是通过NFS方式发布的，apache不会采用sendfile方式缓存文件，配置文件请选择“EnableSendfile Off”！
4.6.1 Multi-processing module directives
经常需要重启的，加大StartServer；
负载较大的，加大MinSpareServers到25，MaxSpareServers到125；
MaxClients最大只能是256，内存不足时应该减少；
4.6.2 Compression of data
默认的6级压缩比，可以带来72%的带宽减小。太高级别压缩，对CPU有影响。
在测试中，启用压缩的apache带宽减小70%；cpu负载上升87%到饱和状态，能同时处理的客户端请求数降到三分之一。
vary头的作用：告知代理服务器对支持压缩的客户端只发送压缩后的内容。
apache2只在客户端请求包含Accept-encoding: gzip和Accept-encoding: gzip, deflate的时候才压缩数据。
4.6.3 Logging
使用WebBench的时候，一般会有2%的请求是404的，这可能导致error_log迅速变大！
5 ...</p></body></html>
      <a href="/2011/04/01/learning-tuning-red-hat-enterprise-linux-on-ibm-server-xseries-servers" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/31/problem-of-php-compile-option" title="php编译参数问题一例" rel="bookmark">php编译参数问题一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-31 00:00:00 +0800">31 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#php-ref" title="php" rel="category tag">php</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body><p>某php应用在给图片加水印的时候，显示的中文全都成了乱码，而开发同事在它本机(ubuntu)上apt安装的lamp上显示没有问题。仔细检查过了从env到encoding到phpinfo，都没有发现问题——都符合GD函数imagettftext()的utf8要求。
还好有google，发现一个类似的文章，提出是php的编译参数中有一个–enable-gd-jis-conv，会把ttf字库中非标准拉丁文的部分，按照日文顺序映射，imagettftext()的默认编码其实被隐形指定成了日文编码euc-jp，中文自然就不正常了！
然后赶紧重新看phpinfo，真有这个参数。重新编译php，随后恢复正常显示了。
编译参数还真是不能大意啊～～</p></body></html>
      <a href="/2011/03/31/problem-of-php-compile-option" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/28/using-awk-as-one-line-command" title="awk单行命令" rel="bookmark">awk单行命令</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-28 00:00:00 +0800">28 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>一眨眼又几天没更新，中午在Q群里聊到一个单行命令，随手记录下。
A需求：某文件如下
aaa
bbb
aaa
aaa
ccc
aaa
ddd
……
通过命令改成如下格式：
1
bbb
3
5
ccc
7
ddd
……
方法如下：</p>
<div class="highlight"><pre><code class="bash"><span class="nb">echo</span> -en <span class="s1">'aaa\nbbb\naaa\naaa\ndddd'</span>|awk <span class="s1">'BEGIN{tag=1}{if(/aaa/){print tag;tag+=2}else{print}}'</span>
</code></pre></div>
<p>或者更短一点：</p>
<div class="highlight"><pre><code class="bash"><span class="nb">echo</span> -en <span class="s1">'aaa\nbbb\naaa\naaa\ndddd'</span>|awk <span class="s1">'BEGIN{tag=1}{if(/aaa/){$0=tag;tag+=2};print}'</span>
</code></pre></div>
<p>B需求：
aaa不是文件一行的全部内容，而只是一部分。
方法如下：</p>
<div class="highlight"><pre><code class="bash"><span class="nb">echo</span> -en ...</code></pre></div>
</body></html>
      <a href="/2011/03/28/using-awk-as-one-line-command" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/21/bsd_flow_monitor_by_awk" title="BSD上的流量监控脚本" rel="bookmark">BSD上的流量监控脚本</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-21 00:00:00 +0800">21 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body><p>之前有过一篇linux上的流量监控脚本的博文，是利用procfs进行数据运算。但BSD上的procfs和linux有所不同，它只包含了进程的信息，没有系统的统计。所以只能通过其他方法。
linux上另一种获取网卡总流量的方法是ifconfig命令，这个命令其实也是读取proc；但是BSD上的ifconfig输出里也没有……
不过BSD上倒不是没法查流量上，事实上另外有两个命令，在实时观测中更加好用，一个是systat...</p></body></html>
      <a href="/2011/03/21/bsd_flow_monitor_by_awk" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/18/gearmand-test-on-single-server" title="gearman单机试验" rel="bookmark">gearman单机试验</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-18 00:00:00 +0800">18 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>想把前端缓存几十台服务器的访问日志数据计入数据库中，以便核算各频道带宽。按照一般流量统计的惯例，在服务器上设定crontab每5分钟rotate一次access.log。但是想到一个问题——当A服务器select了数据库里的数据但还没来得及update时，B服务器也开始执行任务select数据来了，最后的结果就不准确了——我相信这个问题对coder来说很低级，不过我是op，搞不来……</p>
<p>不过op有op的思路——咱把所有的数据汇总由一台服务器来写数据库。考虑scp或者rsync可能会出现的各种未知失败（这个失败太普遍了，相信所有的op都有体会），打算试试gearman。</p>
<p>gearman出现的本意，是由jobserver来派发client的jobs到workers完成，比如张宴提到金山用它来分发上传图片的缩略裁剪（这也正是LiveJourna发明gearman的初始用途）；比如TimYang提到用它来分发监控任务；OSC...</p>
</body></html>
      <a href="/2011/03/18/gearmand-test-on-single-server" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/17/initctl-error" title="linux小报错一例" rel="bookmark">linux小报错一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-17 00:00:00 +0800">17 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body><p>需要给某台服务器加内存，准备关机的时候，却一直报错。考虑直接断电危害比较大，还是找找原因，报错如下：
shutdown: timeout opening/writing control channel /dev/initctl 
init: timeout opening/writing control channel /dev/initctl 
从messages日志里没有发现任何附加信息。只能求助百度。好在解答很多：
是原有的initscripts和SysVinit找不到了导致的。
传上去initscripts-8.45.19.EL-1.x86<em>64.rpm和SysVinit-2.86-14.x86</em>64.rpm两个包，rpm -ivh安装。
重新poweroff还是报错；但强制-f跳过shutdown...</p></body></html>
      <a href="/2011/03/17/initctl-error" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/15/simple-test-between-squid-varnish-ats" title="squid/varnish/ats简单测试" rel="bookmark">squid/varnish/ats简单测试</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-15 00:00:00 +0800">15 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#CDN-ref" title="CDN" rel="category tag">CDN</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body><p>简单的试试varnish和apache traffic server。跟squid进行一下对比。
介于varnish和ats都是出现不太久的东西...</p></body></html>
      <a href="/2011/03/15/simple-test-between-squid-varnish-ats" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/03/zz-a-day-in-the-life-of-facebook-operations" title="Facebook运维工程师的一天" rel="bookmark">Facebook运维工程师的一天</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-03 00:00:00 +0800">03 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body><p>原文地址：http://linuxsysadminblog.com/2010/09/a-day-in-the-life-of-facebook-operations/
顺便说一句，这个linuxsysadminblog.com确实不错。
文章是笔者在现场听Facebook系统工程师汤姆·库克在2010年的surge可扩展和性能大会上的讲演时记录下来的——
这是到目前为止最火爆的讲座了，还没开始就只剩下点站着的空间……
Facebook运维需要支持多大的应用环境：
1、在facebook花上每个月7亿分钟（不太明白这个意思，一个月明明只有43200分钟）
2、60亿次内容更新；
3、30亿张图片；
4、实现100万连接；
5、5亿活跃用户。
基础设施建设的发展：
1、租用IDC达到瓶颈；
2、开始自建；
3、目前已为加利福尼亚和弗吉尼亚两州服务。
发展历程：
从LAMP起步，然后拆分负载均衡，web服务器，app服务器，memcached，数据库。
最早的Facebook是一个单纯的发布在apache上的php站点。但后来php不足以支持Facebook的访问了，现在，Facebook已经开始编译一些php功能成C++程序，这就是业界闻名的HipHop。
Facebook大概拥有世上最大的memcached集群，超过300TB的数据存储在memcached内存中。
使用flashcache来改善mysql性能。
已实现支持的服务：
新闻feed、搜索、缓存。
服务使用中的编程语言：
C++、php（前台）、python、ruby、java、erlang（聊天室）
各种编程语言间如何交互数据？json？soap？都不是。Facebook专用一个为各编程语言开发服务的软件框架。所有的Facebook系统后面，都是统一的一个平台。
Facebook每天都在担心：
开发、监控、数据管理、代码上线。
Facebook使用centos操作系统！
系统管理：
配置管理；
系统管理——用CFengine；
按需管理。
开发：
前台部分——每天都有新代码上线。代码统一协调，所有人都在IRC的频道里交流。每个人都可以知道发生了什么，而不单单是工程师自己。
1、程序推送按需分发；
2、代码分发通过BT的方式；
3、php是经过编译的，数百MB的二进制文件通过极小的BT种子迅速下发；
4、完成全网更新只需要1分钟。
后台部分——只有开发和运维。开发工程师写代码、测试、演示。
1、这样能迅速得到性能数据；
2、揭露各环节的真实交互（这里翻译的应该不对，看不懂……）；
3、没有所谓的“提交、退出”；
4、全面参与应用变成产品的过程；
5、运维被“嵌入”每个开发团队。
代码的每一处修改和推送，都必须详细记录。
Facebook的服务器性能指标在线监控
ganglia监控系统：快速、便捷、超过500万的监控指标、可以通过网格和池的方式进行规划。
自主的监控...</p></body></html>
      <a href="/2011/03/03/zz-a-day-in-the-life-of-facebook-operations" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/01/perl-game-of-chinaunix" title="CU的perl大赛" rel="bookmark">CU的perl大赛</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-01 00:00:00 +0800">01 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>原帖地址：http://bbs.chinaunix.net/thread-1860259-1-1.html
刚看到帖子，试着自己做做，首先必须承认做的过程是重新去翻过资料了……</p>
<ol>
<li>
    <div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl  myfunc {</span>
<span class="c1"># $x = ...</span>
<span class="k">return</span> <span class="nv">$x</span><span class="p">?</span><span class="mi">1</span><span class="p">:</span><span class="nb">undef</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
  </li>
  <li>
    <p>$x=()就是给$x赋了个undef；列表在标量上下文中取列表的最后一个元素；()是创建一个空列表；至于为啥取最后一个的原因，我猜测是采用的pop操作，所以从列表最后取值吧。</p>
  </li>
  <li>
    <div class="highlight"><pre><code class="perl"><span class="nv">@x</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
<span class="nv">@y</span><span class="o">=</span><span class="nv">@z</span><span class="o">=</span><span class="p">();</span>
<span class="k">for</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="nv">$#x</span><span class="p">)</span> <span class="p">{</span>
<span class="nb">push</span> <span class="nv">@y</span><span class="p">,</span> <span class="nv">$x</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="k">if</span> <span class="nv">$x</span><span class="p">[</span><span class="nv">$_</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="nv">$x</span><span class="p">[</span><span class="nv">$_</span><span class="p">];</span>
<span class="nb">push...</span></code></pre></div>
</li>
</ol>
</body></html>
      <a href="/2011/03/01/perl-game-of-chinaunix" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/02/24/delete-rt-attachment-from-mysql" title="RT故障处理操作一例" rel="bookmark">RT故障处理操作一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-02-24 00:00:00 +0800">24 Feb 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#database-ref" title="database" rel="category tag">database</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>公司RT系统某工单页面无法打开。通过httpwatch发现是图片附件比较大，卡住了页面加载最终导致。
询问当事人后，决定把图片删除掉。
右键菜单查看图片url，是http://rt.domain.com/Ticket/Attachment/123456/654321/12.jpg这样的格式~
于是在服务器的DocumentRoot下查找相关路径，发现Ticket/Attachment下只有一个文件dhandler，这是一段perl程序。
相关部分如下：</p>
<div class="highlight"><pre><code class="perl"><span class="k">my</span> <span class="nv">$arg</span> <span class="o">=</span> <span class="nv">$m</span><span class="o">-&gt;</span><span class="n">dhandler_arg</span><span class="p">;</span>                <span class="c1"># get rest of path</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$arg</span> <span class="o">=~</span> <span class="s">'^(\d+)/(\d+)'</span><span class="p">)</span> <span class="p">{</span>
<span class="nv">$trans</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
<span class="nv">$attach</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
<span class="p">}</span>
...</code></pre></div>
</body></html>
      <a href="/2011/02/24/delete-rt-attachment-from-mysql" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/02/24/a-awk-example-about-gsub-function" title="awk一例" rel="bookmark">awk一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-02-24 00:00:00 +0800">24 Feb 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>一个小需求，某目录下有五万多个模板文件，其中大概两万个是链接文件。当碰到如下情况：
lrwxrwxrwx  1 nobody nobody       59 Dec 27 15:06 10000053.mod -&gt; /var/www/html/category/model/10000050.mod
就需要创建同名的另一个模板文件10000053.wap文件，指向10000050.wap。
怎么做？
我用了如下命令：</p>
<div class="highlight"><pre><code class="bash">ls -l /var/www/html/category/model | awk <span class="s1">'$1~/^l/ &amp;&amp; $...</span></code></pre></div>
</body></html>
      <a href="/2011/02/24/a-awk-example-about-gsub-function" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/02/22/redhat-tech-questions" title="没事试试RH的技能测试" rel="bookmark">没事试试RH的技能测试</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-02-22 00:00:00 +0800">22 Feb 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>上redhat官网看资料的时候想起来上面有RHCE报名前的技能水平测试（用来预估水平，省掉一些基础课程的）。然后做了一下试试。地址如右：<a href="http://www.redhat.com/explore/pre-assessment">http://www.redhat.com/explore/pre-assessment</a>
结果如下：</p>
<table border="0" cellspacing="0">
<thead><tr>
<th>Topic</th>
<th>Evaluation</th>
</tr></thead>
<tbody>
<tr>
<td>Essential Command-Line Operations</td>
<td>Deep Understanding</td>
</tr>
<tr>
<td>Managing Simple Partitions and Filesystems</td>
<td>Some Understanding</td>
</tr>
<tr>
<td>Managing User Accounts</td>
<td>Substantial Knowledge</td>
</tr>
<tr>
<td>Tuning and Maintaining the Kernel</td>
<td>Some Understanding</td>
</tr>
<tr><td>Enhance User Security...</td></tr>
</tbody>
</table>
</body></html>
      <a href="/2011/02/22/redhat-tech-questions" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/02/19/conns-diff-between-browsers" title="浏览器连接数的小区别" rel="bookmark">浏览器连接数的小区别</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-02-19 00:00:00 +0800">19 Feb 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#CDN-ref" title="CDN" rel="category tag">CDN</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>读百度UEO博客的文章《<a href="http://www.baiduux.com/blog/2011/02/15/browser-loading/" target="_blank">浏览器的加载与页面性能优化</a>》，其中关于浏览器对单个域名连接数有一段描述，与一般的概述稍有差别。由此可见像百度这种级别的公司，对性能细节抓到什么程度——让我想起之前在腾讯大讲堂里看到的”页面代码大小要求是MTU倍数”。</p>
<p>这段文字如下：
在HTTP/1.1协议下，单个域名的最大连接数在IE6中是2个，而在其它浏览器中一般4-8个，而整体最大链接数在30左右</p>
<p>而在HTTP/1.0协议下，IE6、7单个域名的最大链接数可以达到4个，在Even Faster Web Sites一书中的11章还推荐了对静态文件服务使用HTTP/1.0协议来提高IE6、7浏览器的速度</p>
</body></html>
      <a href="/2011/02/19/conns-diff-between-browsers" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/02/16/pseudo-static-problem-of-js-rewrite" title="apache的rewrite伪静态化问题一例" rel="bookmark">apache的rewrite伪静态化问题一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-02-16 00:00:00 +0800">16 Feb 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#apache-ref" title="apache" rel="category tag">apache</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>某应用系统有一个产品翻页浏览，为了利于搜索引擎，准备把/search.html?param=1-2-3-4-5做伪静态化，变成/search/1-2-3-4-5.html的url显示。</p>
<p>想来很简单，确认apache有mod_rewrite后，加入如下配置，重启即可：</p>
<div class="highlight"><pre><code class="apache"><span class="nt">&lt;IfModule</span> <span class="s">mod_rewrite.c</span><span class="nt">&gt;</span>
<span class="nb">RewriteEngine</span> <span class="k">on</span>
<span class="nb">RewriteCond</span> %{HTTP_HOST} ^example\.domain\.com [NC]
<span class="nb">RewriteCond</span> %{REQUEST_URI} ^/search/.*\.html
<span class="nb">RewriteRule</span> ^/search/(.*)\.html <span class="sx">/search.html</span>?param=$1 [P,L]
<span class="nt">&lt;/IfModule&gt;</span>
</code></pre></div>
<p>不过很不幸的事情出现了：不管点击页面搜索结果的哪个页码，看到的永远都是第一页的内容！！...</p>
</body></html>
      <a href="/2011/02/16/pseudo-static-problem-of-js-rewrite" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/02/14/compile-and-upgrading-of-the-linux-kernel" title="linux内核编译升级" rel="bookmark">linux内核编译升级</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-02-14 00:00:00 +0800">14 Feb 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>N年没更新的ipvsadm终于在今年春节前更新了，正好手头有lvs的任务，赶紧试试。lvs上说的很清楚，ipvsadm的1.2.26版仅工作于linux kernel2.6.28以上版本。所以首先要把现有的2.6.18的linux kernel升级。</p>
<ol>
<li>
    <p>从kernel.org上获取高版本的kernel原文件：
wget http://www.kernel.org/pub/linux/kernel/v2.6/linux-2.6.37.tar.bz2
tar jxvf linux-2.6.37.tar.bz2 -C /usr/src</p>
  </li>
  <li>
    <p>做好源代码连接
ln -s /usr/src/linux-2.6.37 /usr/src/linux</p>
  </li>
  <li>
    <p>开始选择编译参数
cd /usr/src/linux
make mrproper #这一步是清除可能存在的其他内核编译结果
make menuconfig #采用字符界面选择，初次操作的就别改什么了。
make bzImage #生成vmlinuz
make modules
make modules_install #生成模块
make install  #把生成的System.map/initrd/vmlinuz等都mv到/boot下，并修改gr...</p>
</li>
</ol>
</body></html>
      <a href="/2011/02/14/compile-and-upgrading-of-the-linux-kernel" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/26/direct-operate-xen-vm-image" title="直接操作xen虚拟机镜像的办法" rel="bookmark">直接操作xen虚拟机镜像的办法</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-26 00:00:00 +0800">26 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cloud-ref" title="cloud" rel="category tag">cloud</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>一台xen虚拟机，root密码忘记了，必须进入single模式修改root密码。步骤很熟练，xm shutdown domain &amp;&amp; xm create -c domain——但是出问题了——没出现grub的启动界面，直接进入系统启动过程了！</p>
<p>无法从正常操作流程上搞定，那么换一个思路，直接操作镜像文件（谢天谢地，还好是虚拟机），采用loop方式挂载镜像，然后上去改文件好了~</p>
<p>方法如下：</p>
<p>mount -o loop,offset=32256 /xen/disk.img /mnt
然后看/mnt/下的grub.conf，timeout=0，修改成timeout=5，保存退出。umount /mnt后重新使用xm cre -c就可以看到grub界面了~~</p>
<p>现在解释一下这个offset=32256是怎么来的。因为如果不加这串会报出“mount: you must specify the files...</p>
</body></html>
      <a href="/2011/01/26/direct-operate-xen-vm-image" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/20/problem-about-move-crossing-partition" title="图片分离小故障一例" rel="bookmark">图片分离小故障一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-20 00:00:00 +0800">20 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>有需求对某应用的图片和页面内容进行拆分。计划进行的很顺利，存储设备上成功分成了/vol/html和/vol/image，然后分别挂载在应用服务器上发布为html.domain.com和image.domain.com。但在恢复应用运行后出现一个问题：新图片的上传总是提示失败。</p>
<p>查看服务器上的日志，还好jvm-default.log记录的相当详细。上传程序首先在html.domain.com/dynamic/domain<em>/下创建一个tmp/，上传的图片</em>.jpg和缩略图s_<em>.jpg就暂存在该tmp/下。然后再mv到相应的image.domain.com/domain</em>/$date下。图片上传到tmp是成功的，...</p>
</body></html>
      <a href="/2011/01/20/problem-about-move-crossing-partition" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/20/awk-efficiency" title="awk的效率" rel="bookmark">awk的效率</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-20 00:00:00 +0800">20 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>偶然和某人谈到日志处理。最简单常见的需求，日志中访问量最大的前十个IP及其访问次数。</p>
<table><tbody><tr>
<td>最常见的shell命令：cat access.log</td>
      <td> cut -d ‘ ‘ -f 4 </td>
      <td>sort</td>
      <td>uniq -c</td>
      <td>sort -nr</td>
      <td>head</td>
    </tr></tbody></table>
<table><tbody><tr>
<td>我最常用的awk命令：awk ‘{a[$4]++}END{for(i in a){print a[i],i}}’ access.log</td>
      <td>sort -nr</td>
      <td>head</td>
    </tr></tbody></table>
<p>对方表示上一种速度最快，而我说是下一种。</p>
<p>最后找到一个13G大小的access.log，用time命令分别检测命令用时。结果处理一个13GB的日志，shell花了13分钟，awk花了1分半钟……</p>
</body></html>
      <a href="/2011/01/20/awk-efficiency" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/13/learning-accel-dynamic-data" title="读《基于动态内容的缓存加速技术》笔记" rel="bookmark">读《基于动态内容的缓存加速技术》笔记</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-13 00:00:00 +0800">13 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#CDN-ref" title="CDN" rel="category tag">CDN</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>《程序员》2010年11月刊的86-89四页，刊登了F5售前技术顾问，原VIACDN(TOM的CDN部门，后来独立运营)架构师徐超的文章《基于动态内容的缓存加速技术——F5 Web Accelerator产品技术剖析》。</p>
<p>文章的前三分之一内容，主要是讲述RFC2616和一般浏览器、服务器的具体实现。已经比较熟悉了，略过……</p>
<p>然后进入关键内容。</p>
<p>“让浏览器缓存能够为动态页面工作”：
A. 修改Transfer-Encoding: chunked的内容输出Content-Length。
这个squid已经做到了。其实质就是在获取url的body时，累加每个chunk的size，直到碰上MSB为0的last-chunk标记。
B. 添加Last-Modified。
这个squid差一步。squid实质已经获取了文件在本地的mtime，但只在源header不存在last-modified的时候才用于LM-factor算法。
C. 删除Expires。
大概是为了统一成HT...</p>
</body></html>
      <a href="/2011/01/13/learning-accel-dynamic-data" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/12/resin-status" title="resin-status" rel="bookmark">resin-status</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-12 00:00:00 +0800">12 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>和apache、nginx一样，resin也自带了一个比较简易的status模块，只需要在resin.conf里配置就行了。在里添加如下一段：</p>
<div class="highlight"><pre><code class="xml">    <span class="nt">&lt;servlet-mapping</span> <span class="na">servlet-class=</span><span class="s">'com.caucho.servlets.ResinStatusServlet'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;url-pattern&gt;</span>/resin-status<span class="nt">&lt;/url-pattern&gt;</span>
      <span class="nt">&lt;init</span> <span class="na">enable=</span><span class="s">"read"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
</code></pre></div>
<p>重启resin即可。</p>
<p>然后curl访问http://127.0.0.1:8080/resin-status就可以看到输出了。</p>
<p>用浏览器的话，大致如下图：
<img src="/images/uploads/resin.jpg" alt="resin"></p>
<p>可以关注线程数、...</p>
</body></html>
      <a href="/2011/01/12/resin-status" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/11/construct-http-auth-header" title="HTTP的auth请求模拟" rel="bookmark">HTTP的auth请求模拟</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-11 00:00:00 +0800">11 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>开发同事需要在程序中调用一个“安全级别比较高”的url，起初没觉得有啥问题，我们wget或者curl的时候，按照标准url的格式（即’请求方法://用户名:密码@域名/文件路径’）写就完全OK了。不过很快同事转来了报错：</p>
<p><span style="color:#000000;font-family:Verdana;font-size:x-small;"><span style="font-family:Verdana;font-size:x-small;"><span style="font-family:Verdana;font-size:x-small;">java.io.IOException: Server returned HTTP response code: 401 for URL: <a href="http://gundong:gdxw6354@editornew.china.com/interface/addcategory.php?parentid=2&amp;id=2&amp;name=gbox_%D0%C7%BC%CA%D5%F9%B0%D4&amp;groupname=game&amp;code=satrcraft&amp;m=09286f9d135d5debe7052bea42a27eef">http://test:...</a></span></span></span></p>
</body></html>
      <a href="/2011/01/11/construct-http-auth-header" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/10/mysqlreport-guide" title="mysqlreport指南" rel="bookmark">mysqlreport指南</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-10 00:00:00 +0800">10 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#database-ref" title="database" rel="category tag">database</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>mysqlreport是mysql性能监测时最常用的工具，对了解mysql运行状态和配置调整都有很大的帮助。找了一些mysql的资料，发现大多数是关于php+mysql开发的，服务配置基本就是固定的几条。干脆找上mysqlreport的官网，啃下来这篇指南。翻译都是随着我个人的语言习惯，对直接能用mysql命令上看到结果的英文则保留下来。方便以后查找：</p>
<p>原文地址：http://hackmysql.com/mysqlreportguide</p>
<p>《mysqlreport指南》</p>
<p>本指南的写作目的是解释mysqlr...</p>
</body></html>
      <a href="/2011/01/10/mysqlreport-guide" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/07/compute-flow-from-access_log-by-awk-2" title="日志计算(awk进阶)" rel="bookmark">日志计算(awk进阶)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-07 00:00:00 +0800">07 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<table><tbody><tr>
<td>曾经用awk写过一个日志流量计算的单行命令。因为awk中没有sort函数，所以在中途采用了</td>
      <td>sort</td>
      <td>的方式，导致效率很低。在计算50GB+的日志时，运算时间慢的不可忍受。</td>
    </tr></tbody></table>
<p>设想了很多方法来加快运算，比如舍弃awk改用perl来完成，如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$access_log</span> <span class="o">=</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="k">my</span> <span class="nv">$log_pattern</span> <span class="o">=</span> <span class="sx">qr'^.*?:(\d\d:\d\d):(\S+\s){5}\d+\s(\d+).+'</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%flow</span><span class="p">;</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$traffic</span><span class="p">,</span> <span class="nv">$result</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nb">open</span> <span class="n">FH</span><span class="p">,</span><span class="s">"&lt; $access_log"</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">"Cannot open access_...</span></code></pre></div>
</body></html>
      <a href="/2011/01/07/compute-flow-from-access_log-by-awk-2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page5">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page active">
      <a href="#">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li>
      <a href="/page7">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
