<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/08/18/learning-cloudfarecast-2" title="CloudForecast学习笔记(二)" rel="bookmark">CloudForecast学习笔记(二)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-18 00:00:00 +0800">18 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>接下来看radar部分，也就是探测主程序cloudforecast_radar，其中主要就是调用CloudForecast::Radar中的run()函数。
首先还是惯例，调用ConfigLoader模块加载配置文件；
然后是%SIG信号的定义，用来之后自动重运行的；
然后一个while true死循环：
1、循环里用select(undef,undef,undef,0.5)实现一个0.5秒的sleep；
2、第一个if语句，用来判断是否是父进程，并使用无阻塞的waitpid($pid,WNOHANG)等待子进程完成——即$kid==-1；
3、第二个if语句，用来强制退出死循环，条件是收到%SIG信号；
4、第三个if语句，确认当前时间超过计划中的执行时间（即离上次执行时间最近的整5分钟点），开始执行探测——采用fork()派生子进程。
5、子进程内容是从之前获取的配置文件内，轮询每一台设备，最终调用run_host()函数执行。
然后又是两个if语句，接在while里的last之后，等待子进程全部完成的。</p>
<p>接下来看run_host()函数，其实就是new了一个CloudForecast::Host对象，并调用其run()函数。
这个run()函数，就是根据config里的resource调用相应的CloudForecast::Data::*，最后到CloudForecast::Data里的call_fetch()函数。ok，这个函数上一篇已经看过了。</p>
      <a href="/2011/08/18/learning-cloudfarecast-2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/08/17/learning-cloudfarecast-1" title="CloudForecast学习笔记(一)" rel="bookmark">CloudForecast学习笔记(一)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-17 00:00:00 +0800">17 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>近三天学习cloudforecast，这是一个日本SA写的分布式监控的perl项目。日本的运维水平和perl水平，都让人羡慕啊……
项目介绍：
http://blog.riywo.com/2011/02/27/043646
demo网址:
http://editnuki.info:5000/
下载地址：
https://github.com/kazeburo/cloudforecast
粗略的看了主要文件，主要是用Class::<em>完成的OO，Plack::MiddleWare::</em>完成的web，Gearman::Worker调用Data::*里的具体模块完成对服务器的监控抓取，然后调用RRDs完成监控数据图像的更新，在启动分布式的情况下，则用Gearman::Client传输监控数据给调用RRDs的worker。</p>
<p>第一篇主要记录一下监控数据在服务器上流程，cloudforecast是怎么去抓取数据，怎么传递给rrd的。
不过，先看看Class::*的用法：
在CloudForecast::Data中，有如下一段代码：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">base</span> <span class="sx">qw/Class::Data::Inheritable Class::Accessor::Fast/</span><span class="p">;</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">mk_accessors</span><span class="p">(</span><span class="sx">qw/hostname address details args</span>
<span class="sx">                             component_config _component_instance</span>
<span class="sx">                             global_config/</span><span class="p">);</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">mk_classdata</span><span class="p">(</span><span class="s">&#39;rrd_schema&#39;</span><span class="p">);</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">mk_classdata</span><span class="p">(</span><span class="s">&#39;fetcher_func&#39;</span><span class="p">);</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">mk_classdata</span><span class="p">(</span><span class="s">&#39;graph_key_list&#39;</span><span class="p">);</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">mk_classdata</span><span class="p">(</span><span class="s">&#39;graph_defs&#39;</span><span class="p">);</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">mk_classdata</span><span class="p">(</span><span class="s">&#39;title_func&#39;</span><span class="p">);</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">mk_classdata</span><span class="p">(</span><span class="s">&#39;sysinfo_func&#39;</span><span class="p">);</span>
</code></pre></div>
<p>这里，先用use base()加载两个父类继承关系。然后用Class::Accessor::Fast的mk_accessors方法创建了一堆可读写的变量，这里有另一种写法，看起来更舒服一些：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Class::</span><span class="n">Accessor</span> <span class="s">&quot;moose-like&quot;</span><span class="p">;</span>
<span class="n">has</span> <span class="n">hostname</span> <span class="o">=&gt;</span> <span class="p">(</span> <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;rw&#39;</span><span class="p">,</span> <span class="n">isa</span> <span class="o">=&gt;</span> <span class="s">&#39;Str&#39;</span> <span class="p">);</span>
</code></pre></div>
<p>然后是Class::Data::Inheritable的mk_classdata方法创建了一堆可继承的方法。
在CPAN上看到另外有一个模块叫Class::Data::Accessor的，是上面这两个模块的合集，不过作者声明说已经废弃，推荐大家使用Moose了……</p>
<p>现在来跟踪一下fetch_worker的流程：
先看cf_fetcher_worker脚本里new一个worker出来后，执行的是fetcher_worker()；</p>
<p>然后看lib/CloudForecast/Gearman/Worker.pm里的fetcher_worker()，在连接上gearmand上的fetcher任务后，执行的是$self-&gt;load_resource();</p>
<p>然后看lib/CloudForecast/Gearman/Worker.pm里的load_resource()，其实就是根据具体监控项require并且new一个CloudFarecast::Data::*（这个new方法是通过use base和SUPER::new最终到的CloudFarecast.pm上的）。</p>
<p>然后看fetcher_worker()的下一句&rdquo;$resource-&gt;exec_fetch;&rdquo;，先去找CloudFarecast::Data::*，发现没有exec_fetch()，那往base的CloudFarecast::Data上看，果然有了。其中的主要两行&rdquo;$ret = $self-&gt;do_fetch();&rdquo;和&rdquo;$self-&gt;call_updater($ret);&rdquo;。</p>
<p>然后看do_fetch()。其中主要两行&rdquo;my $ret = $self-&gt;fetcher_func-&gt;($self);&rdquo;和&rdquo;my $schema = $self-&gt;rrd_schema;&rdquo;。这两个fetcher_func和rrd_schema都是前面mk_classdata出来的方法。而这里的$self，则一直追溯到最前面Worker.pm里的$resource，即CloudForecast::Data::*。</p>
<p>选一个CloudForecast::Data::Basic看，其中分别调用了Data.pm里的rrds/graph/title/fetcher函数。</p>
<p>返回Data.pm看fetcher()函数如下：</p>
<div class="highlight"><pre><code class="perl"><span class="k">sub </span><span class="nf">fetcher</span><span class="p">(&amp;) {</span>
    <span class="k">my</span> <span class="nv">$class</span> <span class="o">=</span> <span class="nb">caller</span><span class="p">;</span>
    <span class="nn">Carp::</span><span class="n">croak</span><span class="p">(</span><span class="s">&quot;already seted fetcher_func&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nv">$class</span><span class="o">-&gt;</span><span class="n">fetcher_func</span><span class="p">;</span>
    <span class="nv">$class</span><span class="o">-&gt;</span><span class="n">fetcher_func</span><span class="p">(</span><span class="nb">shift</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>学习一下，这里新出现的一个caller函数，这是perl自带的函数，可以使用perldoc -f caller查看详细说明。默认返回三个值，分别是调用的package/file/linenumber。显然这里就是获取package，也就是$class = &lsquo;CloudFarecast::Data::Basic&rsquo;了。然后返回的&rdquo;$class-&gt;fetcher_func(shift);&rdquo;，这个shift也就是(&amp;)里的内容，即Basic.pm里的{my $c = shift;my @map = &hellip;;my $ret = $c-&gt;component(&lsquo;SNMP&rsquo;)-&gt;get(@map);return $ret;}这个匿名函数。
这样前面Worker里的$resource就有了自己的fetcher_func函数了，就此执行并且返回$ret。完成！</p>
<p>然后把$ret传递给call_updater()函数。这个函数中先对配置文件做一次判断，是否enable了gearmand。如果没有，直接调用exec_updater()完成本地rrd图像的初始化init_rrd()或更新update_rrd()。如果有，则连接上gearmand，new一个CloudForecast::Gearman对象，使用updater方法提交数据。</p>
<p>然后看Gearman.pm中的updater()，其实就是Gearman::Client的dispatch_background()连接上updater任务，发送数据。</p>
      <a href="/2011/08/17/learning-cloudfarecast-1" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/08/02/calendar-select-html-for-self-monitor" title="cdn自主监控(六):数据展示页面" rel="bookmark">cdn自主监控(六):数据展示页面</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-02 00:00:00 +0800">02 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>接下来进入我不擅长的页面部分了。规划页面分为side和main，side中提供时间选择框/类型下拉选择框和提交按钮；main中展示最后形成的chart。
时间选择框是用js和css完成的，这个网上有很多，不过要同时支持多浏览器和分钟级别的选项的，目前就发现一个好用的。下载地址如下：<a href="http://chenlinux.com/images/uploads/Calendar.zip">http://chenlinux.com/images/uploads/Calendar.zip</a>
然后创建cachemoni/public/cdn.html如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;HTML&gt;</span>
<span class="nt">&lt;HEAD&gt;</span>
<span class="nt">&lt;META</span> <span class="na">NAME=</span><span class="s">&quot;ROBOTS&quot;</span> <span class="na">CONTENT=</span><span class="s">&quot;NOINDEX, NOFOLLOW&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;TITLE&gt;</span>CDN Monitor<span class="nt">&lt;/TITLE&gt;</span>
<span class="nt">&lt;/HEAD&gt;</span>
<span class="nt">&lt;FRAMESET</span> <span class="na">BORDER=</span><span class="s">&quot;0&quot;</span> <span class="na">FRAMEBORDER=</span><span class="s">&quot;0&quot;</span> <span class="na">FRAMESPACING=</span><span class="s">&quot;0&quot;</span> <span class="na">COLS=</span><span class="s">&quot;270,*&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;FRAME</span> <span class="na">SRC=</span><span class="s">&quot;side.html&quot;</span> <span class="na">NAME=</span><span class="s">&quot;side&quot;</span> <span class="na">TARGET=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;FRAME</span> <span class="na">SRC=</span><span class="s">&quot;main.html&quot;</span> <span class="na">NAME=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/FRAMESET&gt;</span>
<span class="nt">&lt;/HTML&gt;</span>
</code></pre></div>
<p>cachemoni/public/side.html如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;link</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;css/calendar.css&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;script </span><span class="na">language=</span><span class="s">&quot;javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/calendar.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
select_time<span class="nt">&lt;HR&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/cdncharts&quot;</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">target=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;LI&gt;</span>begin<span class="nt">&lt;/LI&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;timefrom&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">id=</span><span class="s">&quot;timefrom&quot;</span> <span class="na">style=</span><span class="s">&quot;width:100%;&quot;</span> <span class="na">onclick=</span><span class="s">&quot;displayCalendar(this, &#39;yyyy-mm-dd hh:ii&#39;, this, true, &#39;&#39;);&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;LI&gt;</span>end<span class="nt">&lt;/LI&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;timeto&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">id=</span><span class="s">&quot;timeto&quot;</span> <span class="na">style=</span><span class="s">&quot;width:100%;&quot;</span> <span class="na">onclick=</span><span class="s">&quot;displayCalendar(this, &#39;yyyy-mm-dd hh:ii&#39;, this, true, &#39;&#39;);&quot;</span><span class="nt">/&gt;&lt;HR&gt;</span>
<span class="nt">&lt;select</span> <span class="na">name=</span><span class="s">&quot;chartstype&quot;</span> <span class="na">id=</span><span class="s">&quot;chartstype&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;area&quot;</span><span class="nt">&gt;</span>area<span class="nt">&lt;/option&gt;</span>
<span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;isp&quot;</span><span class="nt">&gt;</span>isp<span class="nt">&lt;/option&gt;</span>
<span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;time&quot;</span> <span class="na">selected</span><span class="nt">&gt;</span>time<span class="nt">&lt;/option&gt;</span>
<span class="nt">&lt;/select&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div>
<p>cachemoni/views/charts.tt如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>FusionCharts Free Documentation<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;css/chartstyle.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;script </span><span class="na">language=</span><span class="s">&quot;JavaScript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/FusionCharts.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;table</span> <span class="na">width=</span><span class="s">&quot;98%&quot;</span> <span class="na">border=</span><span class="s">&quot;0&quot;</span> <span class="na">cellspacing=</span><span class="s">&quot;0&quot;</span> <span class="na">cellpadding=</span><span class="s">&quot;3&quot;</span> <span class="na">align=</span><span class="s">&quot;center&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tr&gt;</span> 
    <span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span> <span class="na">class=</span><span class="s">&quot;text&quot;</span> <span class="na">align=</span><span class="s">&quot;center&quot;</span><span class="nt">&gt;</span> <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chartdiv&quot;</span> <span class="na">align=</span><span class="s">&quot;center&quot;</span><span class="nt">&gt;</span> 
        FusionCharts. 
      <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
		   <span class="kd">var</span> <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FusionCharts</span><span class="p">(</span><span class="s2">&quot;[% IF line %]chartswf/FCF_MSLine.swf[% ELSE %]chartswf/FCF_MSBar2D.swf[% END %]&quot;</span><span class="p">,</span> <span class="s2">&quot;ChartId&quot;</span><span class="p">,</span> <span class="s2">&quot;400&quot;</span><span class="p">,</span> <span class="s2">&quot;350&quot;</span><span class="p">);</span>
		   <span class="nx">chart</span><span class="p">.</span><span class="nx">setDataURL</span><span class="p">(</span><span class="nx">escape</span><span class="p">(</span><span class="s2">&quot;[% url %]&quot;</span><span class="p">));</span>
		   <span class="nx">chart</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s2">&quot;chartdiv&quot;</span><span class="p">);</span>
		<span class="nt">&lt;/script&gt;</span> <span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>cachemoni/lib/cachemoni.pm中相关函数如下：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Time::</span><span class="n">Local</span><span class="p">;</span>
<span class="n">get</span> <span class="s">&#39;/cdncharts&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$type</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">chartstype</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$begin</span> <span class="o">=</span> <span class="n">unix_time_format</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">timefrom</span><span class="p">});</span>
    <span class="k">my</span> <span class="nv">$end</span> <span class="o">=</span> <span class="n">unix_time_format</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">timeto</span><span class="p">});</span>
    <span class="k">my</span> <span class="nv">$req_url</span> <span class="o">=</span> <span class="s">&quot;/xml?begin=${begin}&amp;end=${end}&amp;type=${type}&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;time&#39;</span><span class="p">;</span>
    <span class="n">template</span> <span class="s">&#39;charts&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">line</span> <span class="o">=&gt;</span> <span class="nv">$line</span><span class="p">,</span> <span class="n">url</span> <span class="o">=&gt;</span> <span class="s">&quot;$req_url&quot;</span><span class="p">,</span> <span class="p">};</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">unix_time_format</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$time</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$time</span> <span class="o">=~</span> <span class="sr">m/^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2})/</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">timelocal</span><span class="p">(</span><span class="s">&#39;00&#39;</span><span class="p">,</span><span class="nv">$5</span><span class="p">,</span><span class="nv">$4</span><span class="p">,</span><span class="nv">$3</span><span class="p">,</span><span class="nv">$2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nv">$1</span><span class="o">-</span><span class="mi">1900</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>这里比较怪的是，如果setDataURL里传的arg是直接2011-08-01 11:00的格式，fusionchart.js不会发起请求，只有1311111111才行，所以只能在用Time::Local模块转换时间了。
最终访问结果如下：
<img src="/images/uploads/calendar.png" alt="" title="QQ截图20110802191306" width="697" height="370" class="alignnone size-full wp-image-2555" /></p>
      <a href="/2011/08/02/calendar-select-html-for-self-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/08/01/fusioncharts-for-self-monitor" title="cdn自主监控(五):生成charts图像" rel="bookmark">cdn自主监控(五):生成charts图像</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-01 00:00:00 +0800">01 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上篇完成了xml的输出，这篇开始说charts图像的生成。我们采用fusioncharts的免费版，之前博客有提到另一个amcharts，不过amcharts的免费版会在图像左上角加上自己amcharts.com的广告标识……
从fusioncharts官网下载free版的压缩包，有20MB大，不过其中对我们这个小项目有用的只有MSLine.swf/MSBar2D.swf/fusioncharts.js等。
说明：
1、官网介绍上写了支持perl，不过下载包里只有php/asp/jsp/rails的class，没有perl的。所以还是得采用js的方式；
2、js下有setDataURL和setDataXML两个方法，不过官方强烈建议使用setDataURL方法，这种方法可接受的数据量比setDataXML大很多。
页面html很简单，加如下js代码即可：</p>
<div class="highlight"><pre><code class="javascript"><span class="o">&lt;</span><span class="err">/script&gt;</span>
<span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;</span>
<span class="kd">var</span> <span class="nx">myChart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FusionCharts</span><span class="p">(</span><span class="s2">&quot;/Charts/MSBar2D.swf&quot;</span><span class="p">,</span> <span class="s2">&quot;myChartId&quot;</span><span class="p">,</span> <span class="s2">&quot;600&quot;</span><span class="p">,</span> <span class="s2">&quot;500&quot;</span><span class="p">);</span>
<span class="nx">myChart</span><span class="p">.</span><span class="nx">setDataURL</span><span class="p">(</span><span class="nx">escape</span><span class="p">(</span><span class="s2">&quot;/xml?begin=***&amp;end=***&amp;type=area&quot;</span><span class="p">));</span>
<span class="nx">myChart</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s2">&quot;chartdiv&quot;</span><span class="p">);</span>
<span class="o">&lt;</span><span class="err">/script&gt;</span>
</code></pre></div>
<p>要点在这个escape()，如果URL里带参数的话，必须用escape()转码，不然的话第一个&amp;之后的所有参数都会丢失掉！
在调试中注意到，为了忽略缓存，setDataURL()会在url最后跟上一个随机1-4位数字参数&amp;curr=1234然后再发起请求。
现在就可以访问页面看看了～嗯，可以看到图像中的中文字有问题。这是因为fusioncharts不认utf8的中文，必须输出gbk或者gb2312的xml数据才行。所以需要修改一些dancer的charset配置，把config.yml里的charset: UTF-8改成charset: GBK。然后重新请求，中文就正确显示了。
如下图：
<img src="/images/uploads/fusioncharts.jpg" alt="" title="MSBar2D" width="400" height="350" class="alignnone size-full wp-image-2548" /></p>
<hr />
<p>题外话：因为数据是自己insert的，结果写了个区号0751，在quhao.txt里不存在，导致输出category的时候总有问题……难怪总看人说程序本身很好写，各种错误处理才是麻烦事……</p>
      <a href="/2011/08/01/fusioncharts-for-self-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/28/output-xml-for-funsioncharts" title="cdn自主监控(四):输出xml数据" rel="bookmark">cdn自主监控(四):输出xml数据</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-28 00:00:00 +0800">28 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>准备使用funsioncharts绘图，其采用xml数据，在绘制line图的时候，就要从mysql里读取数据，并输出成xml格式，相关配置如下：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="n">cachemoni</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">Database</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(strftime)</span><span class="p">;</span>
<span class="n">get</span> <span class="s">&#39;/xml&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$begin_time</span> <span class="o">=</span> <span class="n">date_format</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">begin</span><span class="p">});</span>
    <span class="k">my</span> <span class="nv">$end_time</span> <span class="o">=</span> <span class="n">date_format</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">end</span><span class="p">});</span>
    <span class="k">my</span> <span class="nv">$type</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">type</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$color</span> <span class="o">=</span> <span class="p">{</span> <span class="n">chinacache</span> <span class="o">=&gt;</span> <span class="s">&#39;1D8BD1&#39;</span><span class="p">,</span>
                  <span class="n">dnion</span>      <span class="o">=&gt;</span> <span class="s">&#39;F1683C&#39;</span><span class="p">,</span>
                  <span class="n">fastweb</span>    <span class="o">=&gt;</span> <span class="s">&#39;2AD62A&#39;</span><span class="p">,</span>
                <span class="p">};</span>
    <span class="k">my</span> <span class="nv">$xml_head</span> <span class="o">=</span> <span class="s">&quot;&lt;graph caption=&#39;Response Time&#39; subcaption=&#39;from $begin_time to $end_time&#39; hovercapbg=&#39;FFECAA&#39; hovercapborder=&#39;F47E00&#39; formatNumberScale=&#39;0&#39; decimalPrecision=&#39;0&#39; showvalues=&#39;0&#39; numdivlines=&#39;3&#39; numVdivlines=&#39;0&#39; yaxisminvalue=&#39;1000&#39; yaxismaxvalue=&#39;1800&#39;  rotateNames=&#39;1&#39;&gt;\n&lt;categories &gt;\n&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$group</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;time&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$group</span> <span class="o">=</span> <span class="s">&#39;cur_date&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;isp&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$group</span> <span class="o">=</span> <span class="s">&#39;isp&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;area&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$group</span> <span class="o">=</span> <span class="s">&#39;area&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#39;Error&#39;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">my</span> <span class="nv">$xml</span> <span class="o">=</span> <span class="n">cdn_select</span><span class="p">(</span><span class="nv">$begin_time</span><span class="p">,</span> <span class="nv">$end_time</span><span class="p">,</span> <span class="nv">$group</span><span class="p">,</span> <span class="nv">$color</span><span class="p">,</span> <span class="nv">$xml_head</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$xml</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">get_area_code</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$area_code</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;0000&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;其他&#39;</span> <span class="p">};</span>
    <span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&quot;$file&quot;</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cannot open $file&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$fh&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">chomp</span><span class="p">;</span>
        <span class="k">my</span><span class="p">(</span><span class="nv">$area</span><span class="p">,</span><span class="nv">$code</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">;</span>
	<span class="nv">$area_code</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$code&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;$area&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">close</span> <span class="nv">$fh</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$area_code</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">cdn_select</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$begin_time</span><span class="p">,</span> <span class="nv">$end_time</span><span class="p">,</span> <span class="nv">$group</span><span class="p">,</span> <span class="nv">$color</span><span class="p">,</span> <span class="nv">$xml</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$sql</span> <span class="o">=</span> <span class="s">&quot;SELECT ${group},AVG(avg_time) avg FROM cdn_cron_record WHERE cdn = ? AND cur_date BETWEEN ? AND ? GROUP BY ${group} ORDER BY ${group}&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="k">my</span> <span class="nv">$cdn</span> <span class="p">(</span><span class="sx">qw{chinacache dnion fastweb}</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$cdn</span><span class="p">,</span> <span class="nv">$begin_time</span><span class="p">,</span> <span class="nv">$end_time</span><span class="p">);</span>
        <span class="k">unless</span><span class="p">(</span><span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">@values</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span> <span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">my</span> <span class="p">(</span><span class="nv">$avg_time</span><span class="p">,</span> <span class="nv">$type</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;avg&#39;</span><span class="p">},</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$group&quot;</span><span class="p">});</span>
                <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;category name=&#39;convert_group($group, $type)&#39; /&gt;\n&quot;</span><span class="p">;</span>
                <span class="nb">push</span> <span class="nv">@values</span><span class="p">,</span> <span class="nv">$avg_time</span><span class="p">;</span>
            <span class="p">};</span>
            <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;/category&gt;\n&quot;</span><span class="p">;</span>
            <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;dataset seriesName=&#39;$cdn&#39; color=&#39;$color-&gt;{$cdn}&#39;&gt;\n&quot;</span><span class="p">;</span>
            <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;set value=&#39;$_&#39; /&gt;\n&quot;</span> <span class="k">for</span> <span class="nv">@values</span><span class="p">;</span>
            <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;/dataset&gt;\n&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;dataset seriesName=&#39;$cdn&#39; color=&#39;$color-&gt;{$cdn}&#39;&gt;\n&quot;</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span> <span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;set value=&#39;$ref-&gt;{avg}&#39; /&gt;\n&quot;</span><span class="p">;</span>
            <span class="p">};</span>
            <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;/dataset&gt;\n&quot;</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&#39;&lt;/graph&gt;&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$xml</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">convert_group</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$group</span><span class="p">,</span> <span class="nv">$origin</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$group</span> <span class="ow">eq</span> <span class="s">&#39;cur_date&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$origin</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$group</span> <span class="ow">eq</span> <span class="s">&#39;isp&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">@isplist</span> <span class="o">=</span> <span class="sx">qw(其他 电信 联通 移动 教育网)</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$isplist</span><span class="p">[</span><span class="nv">$origin</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$group</span> <span class="ow">eq</span> <span class="s">&#39;area&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$arealist</span> <span class="o">=</span> <span class="n">get_area_code</span><span class="p">(</span><span class="s">&#39;quhao.txt&#39;</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$code</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s">&quot;%04s&quot;</span><span class="p">,</span><span class="nv">$origin</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$arealist</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$code</span><span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#39;Error&#39;</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">date_format</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$time</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%F %H:%M&quot;</span><span class="p">,</span><span class="nb">localtime</span><span class="p">(</span><span class="nv">$time</span><span class="p">))</span> <span class="k">if</span> <span class="nv">$time</span> <span class="o">=~</span> <span class="sr">m/\d+/</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>用curl请求一下，如下：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@naigos ~<span class="o">]</span><span class="c"># curl &#39;http://cache.monitor.china.com/xml?begin=1311739200&amp;end=1311840000&amp;type=time&#39;</span>
&lt;graph <span class="nv">caption</span><span class="o">=</span><span class="s1">&#39;Daily Visits&#39;</span> <span class="nv">subcaption</span><span class="o">=</span><span class="s1">&#39;from 2011-07-27 12:00 to 2011-07-28 16:00&#39;</span> <span class="nv">hovercapbg</span><span class="o">=</span><span class="s1">&#39;FFECAA&#39;</span> <span class="nv">hovercapborder</span><span class="o">=</span><span class="s1">&#39;F47E00&#39;</span> <span class="nv">formatNumberScale</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">decimalPrecision</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">showvalues</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">numdivlines</span><span class="o">=</span><span class="s1">&#39;3&#39;</span> <span class="nv">numVdivlines</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">yaxisminvalue</span><span class="o">=</span><span class="s1">&#39;1000&#39;</span> <span class="nv">yaxismaxvalue</span><span class="o">=</span><span class="s1">&#39;1800&#39;</span>  <span class="nv">rotateNames</span><span class="o">=</span><span class="s1">&#39;1&#39;</span>&gt;&lt;categories &gt;&lt;category <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;2011-07-27 17:27:12&#39;</span> /&gt;
&lt;category <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;2011-07-27 17:32:12&#39;</span> /&gt;
&lt;category <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;2011-07-27 17:37:01&#39;</span> /&gt;
&lt;/category&gt;&lt;dataset <span class="nv">seriesName</span><span class="o">=</span><span class="s1">&#39;chinacache&#39;</span> <span class="nv">color</span><span class="o">=</span><span class="s1">&#39;1D8BD1&#39;</span>&gt;&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;300.0000&#39;</span> /&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;511.0000&#39;</span> /&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;482.0000&#39;</span> /&gt;
&lt;/dataset&gt;&lt;dataset <span class="nv">seriesName</span><span class="o">=</span><span class="s1">&#39;dnion&#39;</span> <span class="nv">color</span><span class="o">=</span><span class="s1">&#39;F1683C&#39;</span>&gt;&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;595.6667&#39;</span> /&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;432.0000&#39;</span> /&gt;
&lt;/dataset&gt;&lt;dataset <span class="nv">seriesName</span><span class="o">=</span><span class="s1">&#39;fastweb&#39;</span> <span class="nv">color</span><span class="o">=</span><span class="s1">&#39;2AD62A&#39;</span>&gt;&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;471.0000&#39;</span> /&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;431.5000&#39;</span> /&gt;
&lt;/dataset&gt;&lt;/graph&gt;
</code></pre></div>
<p>换个area参数试试：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@naigos lib<span class="o">]</span><span class="c"># curl &#39;http://cache.monitor.china.com/xml?begin=1311739200&amp;end=1312169668&amp;type=area&#39;</span>
&lt;graph <span class="nv">caption</span><span class="o">=</span><span class="s1">&#39;Response Time&#39;</span> <span class="nv">subcaption</span><span class="o">=</span><span class="s1">&#39;from 2011-07-27 12:00 to 2011-08-01 11:34&#39;</span> <span class="nv">hovercapbg</span><span class="o">=</span><span class="s1">&#39;FFECAA&#39;</span> <span class="nv">hovercapborder</span><span class="o">=</span><span class="s1">&#39;F47E00&#39;</span> <span class="nv">formatNumberScale</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">decimalPrecision</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">showvalues</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">numdivlines</span><span class="o">=</span><span class="s1">&#39;3&#39;</span> <span class="nv">numVdivlines</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">yaxisminvalue</span><span class="o">=</span><span class="s1">&#39;1000&#39;</span> <span class="nv">yaxismaxvalue</span><span class="o">=</span><span class="s1">&#39;1800&#39;</span>  <span class="nv">rotateNames</span><span class="o">=</span><span class="s1">&#39;1&#39;</span>&gt;
&lt;categories &gt;
&lt;category <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;四川&#39;</span> /&gt;
&lt;category <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;江西&#39;</span> /&gt;
&lt;/category&gt;&lt;dataset <span class="nv">seriesName</span><span class="o">=</span><span class="s1">&#39;chinacache&#39;</span> <span class="nv">color</span><span class="o">=</span><span class="s1">&#39;1D8BD1&#39;</span>&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;511.0000&#39;</span> /&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;421.3333&#39;</span> /&gt;
&lt;/dataset&gt;&lt;dataset <span class="nv">seriesName</span><span class="o">=</span><span class="s1">&#39;dnion&#39;</span> <span class="nv">color</span><span class="o">=</span><span class="s1">&#39;F1683C&#39;</span>&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;482.5000&#39;</span> /&gt;
&lt;/dataset&gt;&lt;dataset <span class="nv">seriesName</span><span class="o">=</span><span class="s1">&#39;fastweb&#39;</span> <span class="nv">color</span><span class="o">=</span><span class="s1">&#39;2AD62A&#39;</span>&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;431.3333&#39;</span> /&gt;
&lt;/dataset&gt;&lt;/graph&gt;
</code></pre></div>
<p>呃，上面用的数据只是我自己insert的，所以出现了比较囧的条数不一致……</p>
      <a href="/2011/07/28/output-xml-for-funsioncharts" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/27/prepare-mysql-for-self-monitor" title="cdn自主监控(三):数据库准备工作" rel="bookmark">cdn自主监控(三):数据库准备工作</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-27 00:00:00 +0800">27 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>准备两个表，一个存储原始数据，另一个存储每5分钟归总一次的数据。之后根据时间段绘制省份运营商性能图的时候，就直接从汇总表里获取数据；原始表留给详细查询。
数据库准备脚本如下：</p>
<div class="highlight"><pre><code class="mysql"><span class="k">USE</span> <span class="n">myops</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="nf">cdn_ori_record</span> <span class="p">(</span>
	<span class="n">id</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="kp">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="n">ip</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0000000000&#39;</span><span class="p">,</span>
	<span class="n">isp</span> <span class="kt">ENUM</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">),</span>
	<span class="n">area</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0000&#39;</span><span class="p">,</span>
	<span class="n">cur_date</span> <span class="kt">TIMESTAMP</span> <span class="k">DEFAULT</span> <span class="nf">NOW</span><span class="p">(),</span>
	<span class="n">cdn_time</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
	<span class="n">cdn</span> <span class="kt">ENUM</span><span class="p">(</span><span class="s1">&#39;CHINACACHE&#39;</span><span class="p">,</span><span class="s1">&#39;DNION&#39;</span><span class="p">,</span><span class="s1">&#39;FASTWEB&#39;</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
	<span class="k">KEY</span> <span class="nf">time_key</span> <span class="p">(</span><span class="n">cur_date</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="nf">cdn_cron_record</span> <span class="p">(</span>
	<span class="n">id</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="kp">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="n">isp</span> <span class="kt">TINYINT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
	<span class="n">area</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0000&#39;</span><span class="p">,</span>
	<span class="n">cur_date</span> <span class="kt">TIMESTAMP</span> <span class="k">DEFAULT</span> <span class="nf">NOW</span><span class="p">(),</span>
	<span class="n">cdn</span> <span class="kt">ENUM</span><span class="p">(</span><span class="s1">&#39;CHINACACHE&#39;</span><span class="p">,</span><span class="s1">&#39;DNION&#39;</span><span class="p">,</span><span class="s1">&#39;FASTWEB&#39;</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
	<span class="n">avg_time</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
	<span class="k">KEY</span> <span class="nf">time_area_isp_key</span> <span class="p">(</span><span class="n">cur_date</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
<span class="p">);</span>
<span class="n">DELIMITER</span> <span class="o">|</span>
<span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">cdn_cron</span> <span class="o">|</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="nf">cdn_cron</span><span class="p">()</span>
<span class="n">BEGIN</span>
	<span class="k">INSERT</span> <span class="k">INTO</span> <span class="nf">cdn_cron_record</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span><span class="n">area</span><span class="p">,</span><span class="n">cdn</span><span class="p">,</span><span class="n">avg_time</span><span class="p">)</span> 
	<span class="k">SELECT</span> <span class="n">isp</span><span class="p">,</span><span class="n">area</span><span class="p">,</span><span class="n">cdn</span><span class="p">,</span><span class="nf">AVG</span><span class="p">(</span><span class="n">cdn_time</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">cdn_ori_record</span> 
	<span class="k">WHERE</span> <span class="n">cur_date</span> <span class="o">&gt;</span> <span class="nf">FROM_UNIXTIME</span><span class="p">(</span><span class="nf">UNIX_TIMESTAMP</span><span class="p">()</span><span class="o">-</span><span class="mi">300</span><span class="p">)</span>
	<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">cdn</span><span class="p">,</span><span class="n">area</span><span class="p">,</span><span class="n">isp</span><span class="p">;</span>
<span class="n">END</span> <span class="o">|</span>
<span class="n">DELIMITER</span> <span class="p">;</span>
<span class="kt">SET</span> <span class="n">GLOBAL</span> <span class="n">event_scheduler</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="n">EVENT</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">event_cdn</span> <span class="k">ON</span> <span class="n">SCHEDULE</span> <span class="n">EVERY</span> <span class="mi">300</span> <span class="n">SECOND</span> <span class="k">ON</span> <span class="n">COMPLETION</span> <span class="n">PRESERVE</span> <span class="n">DO</span> <span class="k">CALL</span> <span class="nf">cdn_cron</span><span class="p">();</span>
<span class="k">ALTER</span> <span class="n">EVENT</span> <span class="n">event_cdn</span> <span class="k">ON</span> <span class="n">COMPLETION</span> <span class="n">PRESERVE</span> <span class="n">ENABLE</span><span class="p">;</span>
</code></pre></div>
      <a href="/2011/07/27/prepare-mysql-for-self-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/26/seek-iplist-for-self-monitor" title="cdn自主监控(二):快速查找ip对应信息" rel="bookmark">cdn自主监控(二):快速查找ip对应信息</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-26 00:00:00 +0800">26 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>话接上篇，ip整理出来，然后就是接一个ip地址，快速定位查找到它属于哪个ip段，然后返回具体的省份和运营商。因为之前的ip已经转换成数字，而且是顺序排列的，所以可以采用折半算法(二分法)。perl脚本如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="c1">#my $ip = inet_aton(&quot;$ARGV[0]&quot;);</span>
<span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="n">inet_aton</span><span class="p">(</span><span class="n">get_test_ip</span><span class="p">());</span>
<span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="s">&#39;iplist.txt&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$length</span> <span class="o">=</span> <span class="sb">`cat $file | wc -l`</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$code</span> <span class="o">=</span> <span class="n">get_area_code</span><span class="p">(</span><span class="s">&#39;quhao.txt&#39;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">@isplist</span> <span class="o">=</span> <span class="sx">qw(&#39;其他&#39; &#39;电信&#39; &#39;联通&#39; &#39;移动&#39; &#39;教育网&#39;)</span><span class="p">;</span>
<span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&quot;$file&quot;</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cannot open $file\n&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$line_len</span> <span class="o">=</span> <span class="s">&#39;26&#39;</span><span class="p">;</span>                       <span class="c1">#=10+10+4+1+1，包括回车符(注意上篇输出为了好看多了空格，可以删掉) </span>
<span class="k">my</span> <span class="nv">$first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$last</span> <span class="o">=</span> <span class="nv">$length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>                    <span class="c1">#统一使用SEEK_SET,所以最后一行的起始位置是length-1 </span>
<span class="k">my</span> <span class="nv">$result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$middle</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s">&quot;%.0f&quot;</span><span class="p">,(</span><span class="nv">$last</span><span class="o">-</span><span class="nv">$first</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="nv">$first</span><span class="p">);</span>    <span class="c1">#折半位置，除法取整时采用sprintf比直接int精确</span>
    <span class="nb">seek</span> <span class="nv">$fh</span><span class="p">,</span> <span class="nv">$line_len</span> <span class="o">*</span> <span class="nv">$middle</span><span class="p">,</span> <span class="mi">0</span><span class="p">;</span>                            <span class="c1">#移动到折半位置 </span>
    <span class="nb">sysread</span> <span class="nv">$fh</span><span class="p">,</span> <span class="nv">$begin_ip</span><span class="p">,</span> <span class="mi">10</span><span class="p">;</span>                                  <span class="c1">#从折半处读取10位 </span>
    <span class="nb">sysread</span> <span class="nv">$fh</span><span class="p">,</span> <span class="nv">$end_ip</span><span class="p">,</span> <span class="mi">10</span><span class="p">;</span>                                    <span class="c1">#接着再读10位,如果没删空格,还要先seek移动1位,麻烦 </span>
    <span class="c1">#根据比大小决定下次向哪个方向折半</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$ip</span> <span class="o">&lt;</span> <span class="nv">$begin_ip</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$last</span> <span class="o">=</span> <span class="nv">$middle</span><span class="p">;</span>
        <span class="k">next</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$ip</span> <span class="o">&gt;</span> <span class="nv">$end_ip</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$first</span> <span class="o">=</span> <span class="nv">$middle</span><span class="p">;</span>
        <span class="k">next</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">#找到相应区间，读取区号和运营商号</span>
        <span class="nb">sysread</span> <span class="nv">$fh</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="mi">4</span><span class="p">;</span>
        <span class="nb">sysread</span> <span class="nv">$fh</span><span class="p">,</span> <span class="nv">$isp</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nb">printf</span> <span class="s">&quot;%010s %s %s\n&quot;</span><span class="p">,</span> <span class="nv">$ip</span><span class="p">,</span> <span class="nv">$code</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$area&quot;</span><span class="p">},</span> <span class="nv">$isplist</span><span class="p">[</span><span class="nv">$isp</span><span class="p">];</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                             <span class="c1">#设定$result为假，退出循环 </span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="nb">close</span> <span class="nv">$fh</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">inet_aton</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$short</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%010s&quot;</span><span class="p">,</span> <span class="nv">$1</span> <span class="o">*</span> <span class="mi">256</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="nv">$2</span> <span class="o">*</span> <span class="mi">256</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="nv">$3</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="nv">$4</span> <span class="k">if</span> <span class="nv">$ip</span> <span class="o">=~</span><span class="sr"> /(\d+)\.(\d+)\.(\d+)\.(\d+)/</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$short</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">#对应区号和省份，跟上篇的kv相反</span>
<span class="k">sub </span><span class="nf">get_area_code</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$area_code</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;0000&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;other&#39;</span> <span class="p">};</span>
    <span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&quot;$file&quot;</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cannot open $file&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$fh&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">chomp</span><span class="p">;</span>
        <span class="k">my</span><span class="p">(</span><span class="nv">$area</span><span class="p">,</span><span class="nv">$code</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">;</span>
	<span class="nv">$area_code</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$code&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;$area&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">close</span> <span class="nv">$fh</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$area_code</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">#生成一个随机的合法ip地址</span>
<span class="k">sub </span><span class="nf">get_test_ip</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">join</span> <span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="nb">map</span> <span class="nb">int</span> <span class="nb">rand</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="o">..</span><span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
      <a href="/2011/07/26/seek-iplist-for-self-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/25/overwrite-qqwry-for-self-monitor" title="cdn自主监控(一):整理一个可用范围内的尽可能小的ip库" rel="bookmark">cdn自主监控(一):整理一个可用范围内的尽可能小的ip库</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-25 00:00:00 +0800">25 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>为了跟第三方监控做对比和作为备用，准备自己通过页面js返回数据做个监控。首先第一步，整理一个足够自己用的ip库。
首先，考虑调用会比较频繁，打算把内容尽可能归并，到省级运营商即可；
其次，未知归并完会有多大的情况下，考虑到qqwry的地区都是中文，打算统一使用电话区号代替地区，运营商也有一位数字代替，ip采用inet-aton网络值代替；这样每条记录的字节数固定，可以方便采用seek和sysread提高读取某条记录的速度。</p>
<hr />
<p>前几步工作和之前整理ip库给dns用的时候一样，导出qqwry.txt，约42w条，24MB大小。
然后从网上搜一下全国电话区号，以各省省会(首府)的区号为准，存成一个quhao.txt，为了之后处理方便，只保留前两个中文，好在中国的省份里也只有内蒙古和黑龙江是三个字，留两位不至于影响阅读，txt内容如下：</p>
<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">北京 0010</span> 
<span class="l-Scalar-Plain">上海 0021</span>
<span class="l-Scalar-Plain">天津 0022</span>
<span class="l-Scalar-Plain">重庆 0023</span>
<span class="l-Scalar-Plain">安徽 0551</span>
<span class="l-Scalar-Plain">福建 0591</span>
<span class="l-Scalar-Plain">甘肃 0931</span>
<span class="l-Scalar-Plain">广东 0020</span>
<span class="l-Scalar-Plain">广西 0771</span>
<span class="l-Scalar-Plain">贵州 0851</span>
<span class="l-Scalar-Plain">海南 0898</span>
<span class="l-Scalar-Plain">河北 0311</span>
<span class="l-Scalar-Plain">河南 0371</span>
<span class="l-Scalar-Plain">黑龙 0451</span>
<span class="l-Scalar-Plain">湖北 0027</span>
<span class="l-Scalar-Plain">湖南 0731</span>
<span class="l-Scalar-Plain">吉林 0431</span>
<span class="l-Scalar-Plain">江苏 0025</span>
<span class="l-Scalar-Plain">江西 0791</span>
<span class="l-Scalar-Plain">辽宁 0024</span>
<span class="l-Scalar-Plain">内蒙 0471</span>
<span class="l-Scalar-Plain">宁夏 0951</span>
<span class="l-Scalar-Plain">青海 0971</span>
<span class="l-Scalar-Plain">山东 0531</span>
<span class="l-Scalar-Plain">山西 0351</span>
<span class="l-Scalar-Plain">陕西 0029</span>
<span class="l-Scalar-Plain">四川 0028</span>
<span class="l-Scalar-Plain">西藏 0891</span>
<span class="l-Scalar-Plain">新疆 0991</span>
<span class="l-Scalar-Plain">云南 0871</span>
<span class="l-Scalar-Plain">浙江 0571</span>
</code></pre></div>
<p>然后用如下perl脚本归并：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">my</span><span class="p">(</span><span class="nv">$quhao</span><span class="p">,</span> <span class="nv">$qqwry</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@ARGV</span><span class="p">;</span>
<span class="nv">$code</span> <span class="o">=</span> <span class="n">read_area_code</span><span class="p">(</span><span class="nv">$quhao</span><span class="p">);</span>
<span class="n">overwrite_iplist</span><span class="p">(</span><span class="nv">$qqwry</span><span class="p">,</span> <span class="nv">$code</span><span class="p">);</span>
<span class="k">sub </span><span class="nf">inet_aton</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$short</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%010s&quot;</span><span class="p">,</span> <span class="nv">$1</span> <span class="o">*</span> <span class="mi">256</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="nv">$2</span> <span class="o">*</span> <span class="mi">256</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="nv">$3</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="nv">$4</span> <span class="k">if</span> <span class="nv">$ip</span> <span class="o">=~</span><span class="sr"> /(\d+)\.(\d+)\.(\d+)\.(\d+)/</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$short</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">read_area_code</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$area_code</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&quot;$file&quot;</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cannot open $file&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$fh&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">chomp</span><span class="p">;</span>
        <span class="k">my</span><span class="p">(</span><span class="nv">$area</span><span class="p">,</span><span class="nv">$code</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">;</span>
	<span class="nv">$area_code</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$area&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;$code&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">close</span> <span class="nv">$fh</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$area_code</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">overwrite_iplist</span> <span class="p">{</span>
    <span class="k">my</span><span class="p">(</span><span class="nv">$iplist</span><span class="p">,</span> <span class="nv">$area_code</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span><span class="p">(</span><span class="nv">$last_begin_ip_n</span><span class="p">,</span> <span class="nv">$last_end_ip_n</span><span class="p">,</span> <span class="nv">$last_province_n</span><span class="p">,</span> <span class="nv">$last_isp_n</span><span class="p">);</span>
    <span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&quot;$iplist&quot;</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cannoet open $iplist&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$fh&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">chomp</span><span class="p">;</span>
	<span class="k">my</span><span class="p">(</span><span class="nv">$begin_ip</span><span class="p">,</span> <span class="nv">$end_ip</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="nv">$isp</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">;</span>
	<span class="k">my</span><span class="p">(</span><span class="nv">$province_n</span><span class="p">,</span> <span class="nv">$isp_n</span><span class="p">);</span>
	<span class="k">my</span> <span class="nv">$begin_ip_n</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inet_aton</span><span class="p">(</span><span class="s">&quot;$begin_ip&quot;</span><span class="p">);</span>
	<span class="k">my</span> <span class="nv">$end_ip_n</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inet_aton</span><span class="p">(</span><span class="s">&quot;$end_ip&quot;</span><span class="p">);</span>
        <span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$end_ip_n</span> <span class="o">-</span> <span class="nv">$begin_ip_n</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="nv">$area</span> <span class="o">=~</span><span class="sr"> /学/</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$isp_n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>                                          <span class="c1">#教育网, 因为清华北大等学校记录在area里了，所以这步提前设定 </span>
	<span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span> <span class="nv">$isp</span> <span class="o">=~</span> <span class="sr">m/电信/</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$isp_n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                                          <span class="c1">#电信 </span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$isp</span> <span class="o">=~</span> <span class="sr">m/联通/</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$isp_n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>                                          <span class="c1">#联通(包括原网通) </span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$isp</span> <span class="o">=~</span> <span class="sr">m/铁通|移动/</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$isp_n</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>                                          <span class="c1">#移动(包括原铁通) </span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$isp</span> <span class="o">=~</span> <span class="sr">m/学/</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$isp_n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>                                          <span class="c1">#教育网 </span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nv">$isp_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                          <span class="c1">#国外地址及其他未能识别的国内运营商 </span>
	<span class="p">};</span>
        <span class="k">my</span> <span class="nv">$province</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>                      <span class="c1">#中文用2字节，所以对原始记录获取前四字节即为省份名</span>
	<span class="k">if</span> <span class="p">(</span> <span class="nb">exists</span> <span class="nv">$area_code</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$province&quot;</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$province_n</span> <span class="o">=</span> <span class="nv">$area_code</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$province&quot;</span><span class="p">};</span>             <span class="c1">#国内已知电话区号的省份 </span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nv">$province_n</span> <span class="o">=</span> <span class="s">&#39;0000&#39;</span><span class="p">;</span>                                <span class="c1">#港澳台及外国，可能有其他未能识别的国内地址 </span>
	<span class="p">};</span>
        <span class="c1">#下段为合并网段，之前dns时也用过</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$last_province_n</span><span class="p">)</span> <span class="p">{</span>
	    <span class="p">(</span><span class="nv">$last_begin_ip_n</span><span class="p">,</span> <span class="nv">$last_end_ip_n</span><span class="p">,</span> <span class="nv">$last_province_n</span><span class="p">,</span> <span class="nv">$last_isp_n</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$begin_ip_n</span><span class="p">,</span> <span class="nv">$end_ip_n</span><span class="p">,</span> <span class="nv">$province_n</span><span class="p">,</span> <span class="nv">$isp_n</span><span class="p">);</span>
	<span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$last_province_n</span> <span class="o">==</span> <span class="nv">$province_n</span> <span class="o">&amp;&amp;</span> <span class="nv">$last_isp_n</span> <span class="o">==</span> <span class="nv">$isp_n</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$last_end_ip_n</span> <span class="o">=</span> <span class="nv">$end_ip_n</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nb">printf</span> <span class="s">&quot;%010s %010s %04s %s\n&quot;</span><span class="p">,</span> <span class="nv">$last_begin_ip</span><span class="p">,</span> <span class="nv">$last_end_ip</span><span class="p">,</span> <span class="nv">$last_province_n</span><span class="p">,</span> <span class="nv">$last_isp_n</span><span class="p">;</span>
	    <span class="p">(</span><span class="nv">$last_begin_ip_n</span><span class="p">,</span> <span class="nv">$last_end_ip_n</span><span class="p">,</span> <span class="nv">$last_province_n</span><span class="p">,</span> <span class="nv">$last_isp_n</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$begin_ip_n</span><span class="p">,</span> <span class="nv">$end_ip_n</span><span class="p">,</span> <span class="nv">$province_n</span><span class="p">,</span> <span class="nv">$isp_n</span><span class="p">);</span>
	<span class="p">};</span>
    <span class="p">};</span>
    <span class="nb">close</span> <span class="nv">$fh</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>最后运行如下命令即可获得精简ip库：</p>
<div class="highlight"><pre><code class="bash">perl overwrite.pl quhao.txt qqwry.txt &gt; newip.txt
</code></pre></div>
<p>对比一下大小和行数：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@cdn2 ~<span class="o">]</span><span class="c"># ll</span>
-rw-r--r-- 1 root root   539226 Jul 25 18:18 newer.txt
-rw-r--r-- 1 root root  9058928 May 15 13:13 QQWry.dat
-rw-r--r-- 1 root root 24753935 Jul 25 15:26 qqwry.txt
-rw-r--r-- 1 root root      340 Jul 25 15:03 quhao.txt
-rw-r--r-- 1 root root     2439 Jul 25 18:17 test.pl
<span class="o">[</span>root@cdn2 ~<span class="o">]</span><span class="c"># wc -l *</span>
   18594 newer.txt
   34727 QQWry.dat
  428454 qqwry.txt
      30 quhao.txt
      72 test.pl
</code></pre></div>
<p>好了，一天一天来，明天实现在这527KB的文件里快速定位ip……</p>
      <a href="/2011/07/25/overwrite-qqwry-for-self-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/21/some-tests-about-perl" title="perl小测试题(转自CU)" rel="bookmark">perl小测试题(转自CU)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-21 00:00:00 +0800">21 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>原贴地址：http://bbs.chinaunix.net/thread-3563215-1-1.html
flw回帖里有翻译，我试答如下：
1. Perl 5 中变量名开头的那个字符（sigils）有哪几种、分别都有什么含义？
$标量@数组%散列&amp;函数
2. 访问一个数组元素时，用 $items[$index] 和用 @items[$index] 有什么区别？
$是标量，@是数组切片
3. 请问 == 和 eq 之间的区别是什么？
分别是数值和字符的比较
4. 在列表上下文中对一个 hash 求值，会得到什么？
应该是得到一个数组？
5. 如何查看关键字的 Perl 文档？
perldoc -f 
6. Perl 5 中的函数和方法有什么不同？
方法是bless后的函数调用？
7. Perl 5 什么时候对一个变量所使用的内存进行回收？
引用计数器清空后？（好像记得是）或者执行完成退出的时候
8. 如何做才能够确保一个变量的缺省作用域是词法作用域？
my local？
9. 如何加载模块并且从中导入符号？
use Module;
符号是啥？
10. 是什么在控制 Perl 如何加载模块？有什么办法可以指定一个目录清单告诉 Perl 从这些地方尝试加载模块？
不知道。
use lib qw();或者perl -I或者export PERL5LIB=
11. 你怎么在 Perl 5 的文档中中查看一条错误信息说明？（加分项：了解如何为所有遇到过的错误信息启用解释）
汗，这个用|less然后/搜索……有好办法么？
12. 试着阐述一下把数组传递给函数的时候会发生什么事。
应该是复制一个数组副本出来，然后赋值到@<em>给函数用？
13. 如何传递多个独立的数组给函数？
分别传递数组引用。
14. 对于调用方来说，return 和 return undef 有什么区别？
return的应该是上一个的结果吧？
15. Where do tests go in a standard CPAN distribution?
module里头都有t/目录可以test吧，然后cpan.org上有志愿者？
16. 拿到一个 CPAN 模块后怎样进行测试？
make test
17. 你用什么命令从 CPAN 上安装新模块？
cpanm Module
18. 为什么要使用 open 函数的三参数形式？
预防文件名带有&gt;等特殊字符串
19. 如何检测（和报告）像 open 这样的系统调用产生的错误？（加分项: 知道如何开启自动检测和报告）
在open的时候接上or die $@；
use autodie;
20. 如何在 Perl 5 中抛出一个异常？
die
21. 如何在 Perl 5 中捕获一个异常？
eval {}
22. 用 for 读文件和用 while 读文件有什么不同吗？
for一次性读入；while一次一行
23. 在 Perl 5 的函数或者方法中，你分别是如何处理参数的？
my $abc = shift;
my ($abc, $def) = @</em>;
24. my ($value) = @_; 中的小括号有什么用？如果删掉会发生什么？
强制为列表环境；
删掉之后变成标量环境就是@_的元素个数了。
25. new 是 Perl 5 的内置函数或者关键字吗？
不是，模块里要自己写new方法。
26. 你怎么看 Perl 的核心模块的文档？如果是 CPAN 模块的话又该如何看？
perldoc查看，不过核心模块和一般模块方法有区别么？
27. 怎样只访问 hash 的值？
values函数</p>
      <a href="/2011/07/21/some-tests-about-perl" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/08/mysql_history_monitor" title="mysql_history_monitor" rel="bookmark">mysql_history_monitor</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-08 00:00:00 +0800">08 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上篇加了bash_history的监控，这篇说mysql_history的监控。不像bash4，mysql自始至终没有提供过syslog的代码，只能自己通过守护进程去实时获取~/.mysql_history的记录了。一个小脚本如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="n">POE</span> <span class="sx">qw(Wheel::FollowTail)</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Log::Syslog::</span><span class="n">Fast</span> <span class="sx">qw(:all)</span><span class="p">;</span>
<span class="nb">defined</span><span class="p">(</span><span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="nb">fork</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cant fork:$!&quot;</span><span class="p">;</span>
<span class="k">unless</span><span class="p">(</span><span class="nv">$pid</span><span class="p">){</span>  
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
         <span class="nb">exit</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="nn">POE::</span><span class="n">Session</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span>
    <span class="n">inline_states</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="n">_start</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]{</span><span class="n">tailor</span><span class="p">}</span> <span class="o">=</span> <span class="nn">POE::Wheel::</span><span class="n">FollowTail</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
          <span class="n">Filename</span> <span class="o">=&gt;</span> <span class="s">&quot;/root/.mysql_history&quot;</span><span class="p">,</span>
          <span class="n">InputEvent</span> <span class="o">=&gt;</span> <span class="s">&quot;got_log_line&quot;</span><span class="p">,</span>
          <span class="n">ResetEvent</span> <span class="o">=&gt;</span> <span class="s">&quot;got_log_rollover&quot;</span><span class="p">,</span>
        <span class="p">);</span>
      <span class="p">},</span>
      <span class="n">got_log_line</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
<span class="c1">#通过Data::Dumper看到实际是$_[10]，不过在POE::Session里定义了sub ARG0 () { 10 };这样写起来简单了</span>
        <span class="n">to_rsyslog</span><span class="p">(</span><span class="nv">$_</span><span class="p">[</span><span class="n">ARG0</span><span class="p">]);</span>
      <span class="p">},</span>
      <span class="n">got_log_rollover</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="n">to_rsyslog</span><span class="p">(</span><span class="s">&#39;roll&#39;</span><span class="p">);</span>
      <span class="p">},</span>
    <span class="p">}</span>
<span class="p">);</span>
<span class="nn">POE::</span><span class="n">Kernel</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
<span class="nb">exit</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">to_rsyslog</span> <span class="p">{</span>
  <span class="nv">$message</span> <span class="o">=</span> <span class="nb">join</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="nv">@_</span><span class="p">;</span>
<span class="c1">#rsyslog开的是UDP的514端口；而LOG_LOCAL0和LOG_INFO都是syslog定义的，乱写的话会自动归入kernel | alert</span>
  <span class="k">my</span> <span class="nv">$logger</span> <span class="o">=</span> <span class="nn">Log::Syslog::</span><span class="n">Fast</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="n">LOG_UDP</span><span class="p">,</span> <span class="s">&quot;10.0.0.123&quot;</span><span class="p">,</span> <span class="mi">514</span><span class="p">,</span> <span class="n">LOG_LOCAL0</span><span class="p">,</span> <span class="n">LOG_INFO</span><span class="p">,</span> <span class="s">&quot;mysql_231&quot;</span><span class="p">,</span> <span class="s">&quot;mysql_monitor&quot;</span><span class="p">);</span>
  <span class="nv">$logger</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="nv">$message</span> <span class="p">,</span><span class="nb">time</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>当然，mysql的history其实不止一个位置，需要判断~</p>
      <a href="/2011/07/08/mysql_history_monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/08/bash_syslog_history" title="bash_syslog_history" rel="bookmark">bash_syslog_history</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-08 00:00:00 +0800">08 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>@钚钉钬影 童鞋要试验系统日志收集处理，采用rsyslog+loganalyzer做界面，因为需求有把bash_history也带上，所以采用修改bash源码的方式。最先采用了bash4.2（bash4.2已经带了这个功能，但是默认不开启，删掉哪个/**/就行了），不过因为这个bash4.+跟redhat的network-functions脚本有点小矛盾，重启的时候报个错——虽然改起来也很简单，就是加一个./的事情——不过本着尽量改动少的原则，换回bash3.1。
bash3.1里默认没有记录syslog的代码，所以从bash4.2/bashhist.c里复制有关bash_syslog_history代码段到bash3.1中——注意不是原样复制到bashhist.c，那样不顶用——需要复制到lib/readline/history.c中，如下：</p>
<div class="highlight"><pre><code class="c"><span class="o">+</span>   <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">syslog</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="err">……</span>
<span class="kt">void</span>
<span class="n">add_history</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span>
     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>
<span class="p">{</span>
<span class="n">HIST_ENTRY</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
<span class="o">+</span><span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">600</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>   <span class="n">syslog</span><span class="p">(</span><span class="n">LOG_LOCAL5</span> <span class="o">|</span> <span class="n">LOG_INFO</span><span class="p">,</span> <span class="s">&quot;%s %s %s %s&quot;</span><span class="p">,</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;LOGNAME&quot;</span><span class="p">),</span><span class="n">getlogin</span><span class="p">(),</span><span class="n">ttyname</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">string</span><span class="p">);</span>
<span class="o">+</span>    <span class="p">}</span>
<span class="o">+</span>    <span class="k">else</span> <span class="p">{</span>
<span class="o">+</span>      <span class="kt">char</span> <span class="n">trunc</span><span class="p">[</span><span class="mi">600</span><span class="p">];</span>
<span class="o">+</span>      <span class="n">strncpy</span><span class="p">(</span><span class="n">trunc</span><span class="p">,</span><span class="n">string</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">trunc</span><span class="p">));</span>
<span class="o">+</span>      <span class="n">trunc</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">trunc</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="o">+</span>    <span class="n">syslog</span><span class="p">(</span><span class="n">LOG_LOCAL5</span><span class="p">,</span> <span class="n">LOG_INFO</span><span class="p">,</span> <span class="s">&quot;%s %s %s %s(++TRUNC)&quot;</span><span class="p">,</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;LOGNAME&quot;</span><span class="p">),</span><span class="n">getlogin</span><span class="p">(),</span><span class="n">ttyname</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">trunc</span><span class="p">);</span>
<span class="o">+</span>    <span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">history_stifled</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">history_length</span> <span class="o">==</span> <span class="n">history_max_entries</span><span class="p">))</span>
</code></pre></div>
<p>上面的LOG_LOCAL5和LOG_INFO都是syslog.h里的定义，所以要include进来。
然后编译使用，就能记录进/var/log/messages里了。</p>
<hr />
<p>话说网上关于上面的说明中，大多数没有提到需要include<syslog.h>，但是make的时候居然只报LOG_INFO和LOG_LOCAL5的未定义错误，随便把这两个改成一个已经defined过的变量，比如HISTORY，编译一样成功；而且也一样记录系统日志。唯一体现不同的地方就是loganalyzer页面上看到所有的history操作都是alert级别。
之前没了解过程的时候，还采用了mysql触发器，自动修改这个报警级别，也记录一下，毕竟是自己第一次用触发器~~</syslog.h></p>
<div class="highlight"><pre><code class="mysql"><span class="k">USE</span> <span class="n">Syslog</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TRIGGER</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">trig_bash_prior</span><span class="p">;</span>
<span class="n">DELIMITER</span> <span class="o">|</span>
<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">trig_bash_prior</span> <span class="k">BEFORE</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="n">Syslog</span><span class="p">.</span><span class="n">SystemEvents</span>
 <span class="k">FOR</span> <span class="k">EACH</span> <span class="n">ROW</span> <span class="n">BEGIN</span>
  <span class="k">IF</span> <span class="n">NEW</span><span class="p">.</span><span class="n">SysLogTag</span><span class="o">=</span><span class="s1">&#39;-bash:&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">NEW</span><span class="p">.</span><span class="n">Priority</span><span class="o">=</span><span class="s1">&#39;1&#39;</span> <span class="k">THEN</span>
   <span class="kt">SET</span> <span class="n">NEW</span><span class="p">.</span><span class="n">Priority</span><span class="o">=</span><span class="s1">&#39;6&#39;</span><span class="p">;</span>
  <span class="n">END</span> <span class="k">IF</span><span class="p">;</span>
 <span class="n">END</span>
<span class="o">|</span>
</code></pre></div>
<p>这个库很简单，基本数据就是记在这个单表里~~</p>
      <a href="/2011/07/08/bash_syslog_history" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/28/a-dancer-demo-of-monitor-squid" title="squid监控+dancer小试验" rel="bookmark">squid监控+dancer小试验</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-28 00:00:00 +0800">28 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>squid监控之前有一篇关于snmp的内容，不过这次是真要用上了，所以细细挑出来几个做监控。碰巧凯哥更新了一把modern perl的东西，我亦步亦趋，也试试dancer。不过花了两天时间，DBIx::Class::Schema还是没搞出来，最终还是简单的用DBI跳过了……
用的database就是之前nmap试验时生成的数据，有application/channel/intranet等column。
首先安装：</p>
<div class="highlight"><pre><code class="perl"><span class="n">cpanm</span> <span class="n">Dancer</span> <span class="n">DBI</span> <span class="n">DBD:mysql</span> <span class="n">Template</span> <span class="nn">Dancer::Session::</span><span class="n">YAML</span>
<span class="n">dancer</span> <span class="o">-</span><span class="n">a</span> <span class="n">cachemoni</span>
</code></pre></div>
<p>然后修改cachemoni/lib/cachemoni.pm如下：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="n">cachemoni</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">Database</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Net::</span><span class="n">SNMP</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Digest::</span><span class="n">MD5</span> <span class="sx">qw(md5_hex)</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$VERSION</span> <span class="o">=</span> <span class="s">&#39;0.1&#39;</span><span class="p">;</span>
<span class="n">get</span> <span class="s">&#39;/monitor&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$app</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">app</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;squid&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="s">&#39;Only support squid now&#39;</span> <span class="k">unless</span> <span class="nv">$app</span> <span class="ow">eq</span> <span class="s">&#39;squid&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$checkstat</span> <span class="o">=</span> <span class="n">_snmp_check</span><span class="p">(</span><span class="nv">$app</span><span class="p">);</span>
    <span class="n">template</span> <span class="s">&#39;monitor&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">status</span> <span class="o">=&gt;</span> <span class="nv">$checkstat</span><span class="p">,</span>
                          <span class="n">name</span>   <span class="o">=&gt;</span> <span class="p">[</span><span class="s">&#39;IP地址&#39;</span><span class="p">,</span><span class="s">&#39;流量命中率&#39;</span><span class="p">,</span><span class="s">&#39;请求数命中率&#39;</span><span class="p">,</span><span class="s">&#39;回源请求响应毫秒&#39;</span><span class="p">,</span><span class="s">&#39;当前客户端数&#39;</span><span class="p">,</span><span class="s">&#39;剩余文件描述符数&#39;</span><span class="p">,</span><span class="s">&#39;已缓存文件数&#39;</span><span class="p">,</span><span class="s">&#39;平均每秒请求数&#39;</span><span class="p">],</span>
                        <span class="p">};</span>
<span class="p">};</span>
<span class="n">any</span><span class="p">[</span><span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="s">&#39;post&#39;</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="s">&#39;/login&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$err</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">()</span> <span class="ow">eq</span> <span class="s">&#39;POST&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">username</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$passwd</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">password</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span>
            <span class="s">&#39;select audit,passwd from ops_user where name = ?&#39;</span>
        <span class="p">);</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchrow_arrayref</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$ref</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">redirect</span> <span class="s">&#39;/register&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">ne</span> <span class="s">&#39;yes&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$err</span> <span class="o">=</span> <span class="s">&#39;你的帐户还没通过审核&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="n">md5_hex</span><span class="p">(</span><span class="s">&quot;$passwd&quot;</span><span class="p">)</span> <span class="ow">ne</span> <span class="s">&quot;$ref-&gt;[1]&quot;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$err</span> <span class="o">=</span> <span class="s">&#39;密码错误&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">session</span> <span class="s">&#39;logged_in&#39;</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">;</span>
            <span class="n">redirect</span> <span class="s">&#39;/&#39;</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="n">template</span> <span class="s">&#39;login&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#39;err&#39;</span> <span class="o">=&gt;</span> <span class="nv">$err</span><span class="p">,</span> <span class="p">};</span>
<span class="p">};</span>
<span class="n">any</span><span class="p">[</span><span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="s">&#39;post&#39;</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="s">&#39;/register&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$err</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">()</span> <span class="ow">eq</span> <span class="s">&#39;POST&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">username</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$passwd</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">password</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$check_sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span>
            <span class="s">&#39;select count(name) from ops_user where name = ?&#39;</span>
        <span class="p">);</span>
        <span class="nv">$check_sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$check_sth</span><span class="o">-&gt;</span><span class="n">fetchrow_arrayref</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="s">&quot;$ref-&gt;[0]&quot;</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$insert_sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span>
                <span class="s">&#39;insert into ops_user (name,passwd) value(?,?)&#39;</span>
            <span class="p">);</span>
            <span class="nv">$insert_sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="n">md5_hex</span><span class="p">(</span><span class="nv">$passwd</span><span class="p">));</span>
            <span class="nv">$err</span> <span class="o">=</span> <span class="s">&#39;等待人工审核通过,3Q&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$err</span> <span class="o">=</span> <span class="s">&#39;该用户名已注册&#39;</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="n">template</span> <span class="s">&#39;register&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#39;err&#39;</span> <span class="o">=&gt;</span> <span class="nv">$err</span><span class="p">,</span> <span class="p">};</span>
<span class="p">};</span>
<span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">template</span> <span class="s">&#39;index&#39;</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">get</span> <span class="s">&#39;/logout&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">session</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">;</span>
    <span class="n">redirect</span> <span class="s">&#39;/&#39;</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">_snmp_check</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$app</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$list</span> <span class="o">=</span> <span class="p">{};</span>
<span class="c1">#之前通过use加载了plugin::database，所以直接有database对象引用了</span>
    <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span>
        <span class="s">&#39;select channel,intranet from myhost where application = ?&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$app</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$list</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$ref-&gt;{&#39;channel&#39;}&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span> <span class="k">unless</span> <span class="nb">exists</span> <span class="nv">$list</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$ref-&gt;{&#39;channel&#39;}&quot;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;intranet&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">@snmpstat</span> <span class="o">=</span> <span class="n">_snmp_walk</span><span class="p">(</span><span class="s">&quot;$ip&quot;</span><span class="p">);</span>
<span class="c1">#这里第一是没想到比较好的把每个ip的各项检查结果导出的办法；所以干脆采用固定次序输出；</span>
<span class="c1">#第二是因为unshift很耗资源，所以先push再reverse</span>
        <span class="nb">push</span> <span class="nv">@snmpstat</span><span class="p">,</span> <span class="nv">$ip</span><span class="p">;</span>
        <span class="nv">@snmpstat</span> <span class="o">=</span> <span class="nb">reverse</span> <span class="nv">@snmpstat</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$list</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$ref-&gt;{&#39;channel&#39;}&quot;</span><span class="p">}},</span> <span class="o">\</span><span class="nv">@snmpstat</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">push</span> <span class="k">my</span> <span class="nv">@checkstat</span><span class="p">,</span> <span class="nb">map</span><span class="p">{</span>
        <span class="p">{</span> <span class="n">channel</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="p">,</span>
          <span class="n">host</span>    <span class="o">=&gt;</span> <span class="nv">$list</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$_&quot;</span><span class="p">},</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$list</span><span class="p">};</span>
    <span class="k">return</span> <span class="o">\</span><span class="nv">@checkstat</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">_snmp_walk</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$o_host</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$o_community</span> <span class="o">=</span> <span class="s">&#39;public&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$result</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">my</span> <span class="nv">%oids</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s">&#39;cacheUptime&#39;</span>                  <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.1.3.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheProtoClientHttpRequests&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.2.1.1.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheNumObjCount&#39;</span>             <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.1.7.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheCurrentUnusedFDescrCnt&#39;</span>  <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.1.10.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheClients&#39;</span>                 <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.2.1.15.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheHttpMissSvcTime&#39;</span>         <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.2.2.1.3.1&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheRequestHitRatio&#39;</span>         <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.2.2.1.9.1&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheRequestByteRatio&#39;</span>        <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.2.2.1.10.1&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$session</span><span class="p">,</span> <span class="nv">$error</span><span class="p">)</span> <span class="o">=</span> <span class="nn">Net::</span><span class="n">SNMP</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">(</span>
        <span class="o">-</span><span class="n">hostname</span>  <span class="o">=&gt;</span> <span class="nv">$o_host</span><span class="p">,</span>
        <span class="o">-</span><span class="n">community</span> <span class="o">=&gt;</span> <span class="nv">$o_community</span><span class="p">,</span>
<span class="c1">#默认是5秒超时，如果有没开snmp的，这页面打开时间一下就上去了，所以要调短</span>
        <span class="o">-</span><span class="n">timeout</span>   <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$session</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$session</span><span class="o">-&gt;</span><span class="n">translate</span><span class="p">(</span><span class="nn">Net::</span><span class="n">SNMP</span><span class="o">-&gt;</span><span class="n">TRANSLATE_NONE</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$squid_status</span> <span class="o">=</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="n">get_request</span><span class="p">(</span> <span class="o">-</span><span class="n">varbindlist</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheUptime&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheProtoClientHttpRequests&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheNumObjCount&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheCurrentUnusedFDescrCnt&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheClients&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheHttpMissSvcTime&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheRequestHitRatio&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheRequestByteRatio&#39;</span><span class="p">},</span> <span class="p">],</span> <span class="p">);</span>
        <span class="nv">$session</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$squid_status</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">#如果要算当前的rps，那得sleep 1再取一次，对几十台集群监控来说不可取；</span>
<span class="c1">#姑且用总的平均值做个衡量，或许可以采用二八法则估算一个高峰时间的rps；</span>
<span class="c1">#注意这个cacheUptime是保留两位ms的，所以算rps的时候要除以100；</span>
<span class="c1">#上述原因也是一般大家对单机squid监控采用rrd的原因，采用COUNTER32数据源，直接递增显示。</span>
            <span class="k">my</span> <span class="nv">$request_sum</span> <span class="o">=</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheProtoClientHttpRequests&#39;}&quot;</span><span class="p">};</span>
            <span class="k">my</span> <span class="nv">$uptime</span> <span class="o">=</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheUptime&#39;}&quot;</span><span class="p">};</span>
            <span class="k">return</span> <span class="nv">$request_sum</span> <span class="o">/</span> <span class="nv">$uptime</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheNumObjCount&#39;}&quot;</span><span class="p">},</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheCurrentUnusedFDescrCnt&#39;}&quot;</span><span class="p">},</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheClients&#39;}&quot;</span><span class="p">},</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheHttpMissSvcTime&#39;}&quot;</span><span class="p">},</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheRequestHitRatio&#39;}&quot;</span><span class="p">},</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheRequestByteRatio&#39;}&quot;</span><span class="p">};</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>修改cachemoni/config.yml如下：</p>
<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">appname</span><span class="p-Indicator">:</span> <span class="s">&quot;cachemoni&quot;</span>
<span class="l-Scalar-Plain">layout</span><span class="p-Indicator">:</span> <span class="s">&quot;main&quot;</span>
<span class="l-Scalar-Plain">charset</span><span class="p-Indicator">:</span> <span class="s">&quot;UTF-8&quot;</span>
<span class="c1">#采用TT作为view模板，注意tt默认是[%%]，而dancer里是&lt;%%&gt;，所以另外要定义标签</span>
<span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="s">&quot;template_toolkit&quot;</span>
<span class="l-Scalar-Plain">engines</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">template_toolkit</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span>  <span class="s">&#39;utf8&#39;</span>
    <span class="l-Scalar-Plain">start_tag</span><span class="p-Indicator">:</span> <span class="s">&#39;[%&#39;</span>
    <span class="l-Scalar-Plain">end_tag</span><span class="p-Indicator">:</span>   <span class="s">&#39;%]&#39;</span>
<span class="c1">#用默认的Simple，即存在内存的一个hash里，实际效果很不稳定，改用yaml，但也有yml文件在关闭浏览器后依旧存在的问题。</span>
<span class="l-Scalar-Plain">session</span><span class="p-Indicator">:</span> <span class="s">&quot;YAML&quot;</span>
<span class="l-Scalar-Plain">session_dir</span><span class="p-Indicator">:</span> <span class="s">&quot;/tmp/dancer_session_dir&quot;</span>
<span class="l-Scalar-Plain">session_expires</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">300</span>
<span class="l-Scalar-Plain">plugins</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">Database</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&#39;mysql&#39;</span>
    <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="s">&#39;myops&#39;</span>
    <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="s">&#39;10.1.1.25&#39;</span>
    <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&#39;user&#39;</span>
    <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">&#39;password&#39;</span>
    <span class="l-Scalar-Plain">connection_check_threshold</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
    <span class="l-Scalar-Plain">dbi_params</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">RaiseError</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
      <span class="l-Scalar-Plain">AutoCommit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
    <span class="l-Scalar-Plain">on_connect_do</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;SET</span><span class="nv"> </span><span class="s">NAMES</span><span class="nv"> </span><span class="s">&#39;utf8&#39;&quot;</span><span class="p-Indicator">,</span> <span class="s">&quot;SET</span><span class="nv"> </span><span class="s">CHARACTER</span><span class="nv"> </span><span class="s">SET</span><span class="nv"> </span><span class="s">&#39;utf8&#39;&quot;</span> <span class="p-Indicator">]</span>
    <span class="l-Scalar-Plain">log_queries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</code></pre></div>
<p>创建cachemoni/views/monitor.tt如下：</p>
<div class="highlight"><pre><code class="html">[% IF session.logged_in %]
[% FOREACH stat IN status %]
  <span class="nt">&lt;hr&gt;</span> channel: [% stat.channel %]
  <span class="nt">&lt;table</span> <span class="na">width=</span><span class="s">&quot;100%&quot;</span> <span class="na">cellspacing=</span><span class="s">&quot;0&quot;</span> <span class="na">cellpadding=</span><span class="s">&quot;0&quot;</span> <span class="na">border=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
  [% FOREACH col IN name %] 
    <span class="nt">&lt;th&gt;&lt;center&gt;</span>
    [% col %]
    <span class="nt">&lt;/center&gt;&lt;/th&gt;</span>
  [% END %]
  <span class="nt">&lt;/tr&gt;</span>
  [% FOREACH host IN stat.host %]
    <span class="nt">&lt;tr&gt;</span>
    [% FOREACH list IN host %]
      <span class="nt">&lt;td&gt;</span>
      [% list %]
      <span class="nt">&lt;/td&gt;</span>
    [% END %]
  [% END %]
  <span class="nt">&lt;/tr&gt;&lt;/table&gt;</span>
[% END %]
[% ELSE %]
  内部信息，请登陆后查看
[% END %]
</code></pre></div>
<p>创建cachemoni/views/login.tt如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;center&gt;</span>
<span class="nt">&lt;h2&gt;</span>登陆页面<span class="nt">&lt;/h2&gt;</span>
[% IF err %]<span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">error</span><span class="nt">&gt;&lt;strong&gt;</span>Error:<span class="nt">&lt;/strong&gt;</span> [% err %][% END %]
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/login&quot;</span> <span class="na">method=</span><span class="s">post</span><span class="nt">&gt;</span>
  <span class="nt">&lt;dl&gt;</span>
    <span class="nt">&lt;dt&gt;</span>用户名:
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">text</span> <span class="na">name=</span><span class="s">username</span><span class="nt">&gt;</span>
    <span class="nt">&lt;dt&gt;</span>密  码:
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">password</span> <span class="na">name=</span><span class="s">password</span><span class="nt">&gt;</span>
    <span class="nt">&lt;dd&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">login</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/dl&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/center&gt;</span>
</code></pre></div>
<p>注册页面类似，不贴了。
然后是layout层的共用部分，之前定义了是views/layouts/main.tt，如下：</p>
<div class="highlight"><pre><code class="html">……
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">metanav</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>首页<span class="nt">&lt;/a&gt;</span> | 
  [% IF not session.logged_in %]
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/register&quot;</span><span class="nt">&gt;</span>注册<span class="nt">&lt;/a&gt;</span> | 
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/login&quot;</span><span class="nt">&gt;</span>登陆<span class="nt">&lt;/a&gt;</span>
  [% ELSE %]
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/logout&quot;</span><span class="nt">&gt;</span>退出<span class="nt">&lt;/a&gt;</span>
  [% END %]
[% content %]
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;footer&quot;</span><span class="nt">&gt;</span>
Powered by <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://perldancer.org/&quot;</span><span class="nt">&gt;</span>Dancer<span class="nt">&lt;/a&gt;</span> [% dancer_version %]
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>这里修改了&lt;%%&gt;为[%%]，其他的tt模版也要改。
然后运行perl cachemoni/bin/app.pl，启动3000端口的监听，访问一下如下：
<img src="/images/uploads/squid-monitor-demo.jpg" alt="" title="123" width="571" height="401" class="alignnone size-full wp-image-2505" />&lt;/a&gt;
这就算完成一个小的网页了，然后开始配置进apache：</p>
<div class="highlight"><pre><code class="bash">cpanm Plack::Handler::Apache2
wget http://search.cpan.org/CPAN/authors/id/P/PH/PHRED/mod_perl-2.0.5.tar.gz
tar zxvf mod_perl-2.0.5.tar.gz
<span class="nb">cd </span>mod_perl-2.0.5
perl Makefile.PL
然后会提示输入apxs的全路径：/usr/local/apache2/bin/apxs
make <span class="o">&amp;&amp;</span> make install
sed -i s<span class="err">&#39;</span>/LoadModule/i<span class="se">\L</span>oadModule perl_module modules/mod_perl.so<span class="se">\&#39;</span> /usr/local/apache2/conf/httpd.conf
cat &gt;&gt; /usr/local/apache2/conf/httpd.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">&lt;VirtualHost *:80&gt;</span>
<span class="s">        ServerName dancer.test.china.com</span>
<span class="s">        DocumentRoot /www/html/cachemoni</span>
<span class="s">        &lt;Directory /www/html/cachemoni&gt;</span>
<span class="s">            AllowOverride None</span>
<span class="s">            Order allow,deny</span>
<span class="s">            Allow from all</span>
<span class="s">        &lt;/Directory&gt;</span>
<span class="s">        &lt;Location /&gt;</span>
<span class="s">            SetHandler perl-script</span>
<span class="s">            PerlHandler Plack::Handler::Apache2</span>
<span class="s">            PerlSetVar psgi_app /www/html/cachemoni/bin/app.pl</span>
<span class="s">        &lt;/Location&gt;</span>
<span class="s">&lt;/VirtualHost&gt;</span>
<span class="s">EOF</span>
/usr/local/apache2/bin/apachectl restart
</code></pre></div>
<p>访问一下，OK~
各种和webserver搭配的方法（其实就是两种：mod_perl和各种cgi）详见：<a href="http://search.cpan.org/~sukria/Dancer-1.3060/lib/Dancer/Deployment.pod">CPAN文档</a></p>
      <a href="/2011/06/28/a-dancer-demo-of-monitor-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/23/make-patch-of-squid-snmp" title="patch制作和使用" rel="bookmark">patch制作和使用</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-23 00:00:00 +0800">23 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>做运维几年没用过patch，说来也怪了~~趁着上一篇自己的小改动，熟悉一下这个命令的简单用法。
首先是patch的制作，用diff命令。</p>
<div class="highlight"><pre><code class="bash">tar zxvf squid-2.7.STABLE9.tar.gz
cp squid-2.7.STABLE9 squid-2.7.STABLE9-old <span class="o">&amp;&amp;</span> mv squid-2.7.STABLE9 squid-2.7.STABLE9-new
<span class="c">#然后按照上篇的内容修改squid-2.7.STABLE9-new/里的文件</span>
diff -uNr squid-2.7.STABLE9-old squid-2.7.STABLE9-new &gt; squid-snmp.patch
</code></pre></div>
<p>这就完成了，好简单啊~来看看patch文件的内容吧：</p>
<div class="highlight"><pre><code class="c"><span class="n">diff</span> <span class="o">-</span><span class="n">uNr</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">cache_snmp</span><span class="p">.</span><span class="n">h</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">cache_snmp</span><span class="p">.</span><span class="n">h</span>
<span class="o">---</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">cache_snmp</span><span class="p">.</span><span class="n">h</span>	<span class="mi">2006</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">22</span> <span class="mi">10</span><span class="o">:</span><span class="mi">49</span><span class="o">:</span><span class="mf">24.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="o">+++</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">cache_snmp</span><span class="p">.</span><span class="n">h</span>	<span class="mi">2011</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">23</span> <span class="mi">13</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mf">04.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">125</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">125</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
     <span class="n">MESH_PTBL_KEEPAL_S</span><span class="p">,</span>
     <span class="n">MESH_PTBL_KEEPAL_R</span><span class="p">,</span>
     <span class="n">MESH_PTBL_INDEX</span><span class="p">,</span>
<span class="o">+</span>    <span class="n">MESH_PTBL_CONN_OPEN</span><span class="p">,</span>
     <span class="n">MESH_PTBL_HOST</span><span class="p">,</span>
     <span class="n">MESH_PTBL_END</span>
 <span class="p">};</span>
<span class="n">diff</span> <span class="o">-</span><span class="n">uNr</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_agent</span><span class="p">.</span><span class="n">c</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_agent</span><span class="p">.</span><span class="n">c</span>
<span class="o">---</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_agent</span><span class="p">.</span><span class="n">c</span>	<span class="mi">2009</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">26</span> <span class="mo">06</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mf">10.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="o">+++</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_agent</span><span class="p">.</span><span class="n">c</span>	<span class="mi">2011</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">23</span> <span class="mi">13</span><span class="o">:</span><span class="mi">27</span><span class="o">:</span><span class="mf">31.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">264</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">264</span><span class="p">,</span><span class="mi">11</span> <span class="err">@@</span>
 	    <span class="n">index</span><span class="p">,</span>
 	    <span class="n">ASN_INTEGER</span><span class="p">);</span>
 	<span class="k">break</span><span class="p">;</span>
<span class="o">+</span>    <span class="k">case</span> <span class="n">MESH_PTBL_CONN_OPEN</span>:
<span class="o">+</span>        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new_integer</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">,</span>
<span class="o">+</span>            <span class="n">p</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">conn_open</span><span class="p">,</span>
<span class="o">+</span>            <span class="n">ASN_INTEGER</span><span class="p">);</span>
<span class="o">+</span>        <span class="k">break</span><span class="p">;</span>
     <span class="nl">default:</span>
 	<span class="o">*</span><span class="n">ErrP</span> <span class="o">=</span> <span class="n">SNMP_ERR_NOSUCHNAME</span><span class="p">;</span>
 	<span class="k">break</span><span class="p">;</span>
<span class="n">diff</span> <span class="o">-</span><span class="n">uNr</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_core</span><span class="p">.</span><span class="n">c</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_core</span><span class="p">.</span><span class="n">c</span>
<span class="o">---</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_core</span><span class="p">.</span><span class="n">c</span>	<span class="mi">2008</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">05</span> <span class="mo">07</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span><span class="mf">13.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="o">+++</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_core</span><span class="p">.</span><span class="n">c</span>	<span class="mi">2011</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">23</span> <span class="mi">20</span><span class="o">:</span><span class="mi">36</span><span class="o">:</span><span class="mf">54.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">321</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">321</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
 						<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
 						    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_Inst</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
 					    <span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="o">-</span>						<span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
<span class="o">+</span>						<span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
 						<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
 						    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
 						<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">351</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">351</span><span class="p">,</span><span class="mi">8</span> <span class="err">@@</span>
 						<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
 						    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
 						<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
<span class="o">+</span>                                                    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="o">+</span>                                                <span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
 						    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">))),</span>
 					<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
 					    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
</code></pre></div>
<p>制作练完了，再练一次使用：</p>
<div class="highlight"><pre><code class="bash"><span class="nb">cd </span>squid-2.7.STABLE9-old
mv ../squid-snmp.patch .
patch -p1 &lt; squid-snmp.patch
</code></pre></div>
<p>-p指定从那层目录开始，因为之前diff的时候顶层目录分别叫old和new，如果在其他地方时候的话，别人的目录肯定不会这么命名的，所以就往里进一层，然后用-p1来patch。
然后more一下那三个文件，确认都修改了~
最后回退patch：</p>
<div class="highlight"><pre><code class="bash">patch -R -p1 &lt; squid-snmp.patch
</code></pre></div>
<p>完成~</p>
      <a href="/2011/06/23/make-patch-of-squid-snmp" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/22/extend-open_conn-output-support-to-squid-snmp" title="给squid的snmp增加open_conn输出" rel="bookmark">给squid的snmp增加open_conn输出</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-22 00:00:00 +0800">22 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>做反向代理的squid集群监控，在单机维护时，squidclient mgr:server_list里的OPEN CONNS是经常看的一项数据，不过在开启snmp支持后，在mib里却没有找到相关的数据。还一度怀疑是不是cachePeerKeepAlRecv或者cachePeerKeepSent。今天想起来去src里grep了一把源码，顺利的在squid/src/neighbors.c里看到了OPEN CONNS等数据的来源，如下：</p>
<div class="highlight"><pre><code class="c"><span class="k">static</span> <span class="kt">void</span>
<span class="nf">dump_peers</span><span class="p">(</span><span class="n">StoreEntry</span> <span class="o">*</span> <span class="n">sentry</span><span class="p">,</span> <span class="n">peer</span> <span class="o">*</span> <span class="n">peers</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">peer</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="err">……</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">peers</span><span class="p">;</span> <span class="n">e</span><span class="p">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<span class="err">……</span>
        <span class="n">storeAppendPrintf</span><span class="p">(</span><span class="n">sentry</span><span class="p">,</span> <span class="s">&quot;OPEN CONNS : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">conn_open</span><span class="p">);</span>
<span class="err">……</span>
        <span class="n">storeAppendPrintf</span><span class="p">(</span><span class="n">sentry</span><span class="p">,</span> <span class="s">&quot;keep-alive ratio: %d%%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">percent</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">n_keepalives_recv</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">n_keepalives_sent</span><span class="p">));</span>
</code></pre></div>
<p>然后在squid/src/snmp_agent.c里看到了这些数据的snmp输出，如下：</p>
<div class="highlight"><pre><code class="c"><span class="n">variable_list</span> <span class="o">*</span>
<span class="nf">snmp_meshPtblFn</span><span class="p">(</span><span class="n">variable_list</span> <span class="o">*</span> <span class="n">Var</span><span class="p">,</span> <span class="n">snint</span> <span class="o">*</span> <span class="n">ErrP</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">variable_list</span> <span class="o">*</span><span class="n">Answer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="n">laddr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">loop</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">peer</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="err">……</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">MESH_PTBL_NAME</span>:
        <span class="n">cp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">);</span>
<span class="err">……</span>
    <span class="k">case</span> <span class="n">MESH_PTBL_KEEPAL_R</span>:
        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new_integer</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">,</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">n_keepalives_recv</span><span class="p">,</span>
            <span class="n">SMI_COUNTER32</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">MESH_PTBL_INDEX</span>:
        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new_integer</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">,</span>
            <span class="n">index</span><span class="p">,</span>
            <span class="n">ASN_INTEGER</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
        <span class="o">*</span><span class="n">ErrP</span> <span class="o">=</span> <span class="n">SNMP_ERR_NOSUCHNAME</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">Answer</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>一对比，发现确实没有stats.conn_open输出……
好在这个比较简单，稍微改一下，就能搞出来：
1、修改squid/include/cache_snmp.h如下：</p>
<div class="highlight"><pre><code class="c"><span class="k">enum</span> <span class="p">{</span>                          <span class="cm">/* cachePeerTable */</span>
<span class="err">……</span>
    <span class="n">MESH_PTBL_CONN_OPEN</span><span class="p">,</span>   <span class="cm">/*新增这个*/</span>
    <span class="n">MESH_PTBL_HOST</span><span class="p">,</span>
    <span class="n">MESH_PTBL_END</span>
<span class="p">};</span>
</code></pre></div>
<p>2、修改squid/src/snmp_core.c如下：</p>
<div class="highlight"><pre><code class="c"><span class="kt">void</span>
<span class="nf">snmpInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="err">……</span>
                                            <span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="cm">/* LEN_SQ_MESH + 2, NULL, NULL, 15,这里改成16，大概在324行，通过原来的MIB知道有15的地方就两个，peer的是后一个 */</span>
                                                <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
<span class="err">……</span>
                                                <span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
                                                    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                                <span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="cm">/*新增这个16*/</span>
                                                    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">))),</span>
</code></pre></div>
<p>3、修改squid/src/snmp_agent.c如下：</p>
<div class="highlight"><pre><code class="c"><span class="err">……</span>
    <span class="k">case</span> <span class="n">MESH_PTBL_INDEX</span>:
        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new_integer</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">,</span>
            <span class="n">index</span><span class="p">,</span>
            <span class="n">ASN_INTEGER</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
<span class="cm">/*新增下面这段，case的内容在第1步cache_snmp.h里增加了；stats.conn_open由之前grep的结果得知；INTEGER是数值类型，照抄RTT的即可*/</span>
    <span class="k">case</span> <span class="n">MESH_PTBL_CONN_OPEN</span>:
        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new_integer</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">,</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">conn_open</span><span class="p">,</span>
            <span class="n">ASN_INTEGER</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
</code></pre></div>
<p>4、重新编译squid，然后用snmpwalk获取数据观察：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@naigos myops<span class="o">]</span><span class="c"># snmpwalk -v 2c -c cacti_china 10.168.168.69 .1.3.6.1.4.1.3495.1.5.1.2  -Cc  | tail</span>
SNMPv2-SMI::enterprises.3495.1.5.1.2.13.3 <span class="o">=</span> Counter32: 0
SNMPv2-SMI::enterprises.3495.1.5.1.2.14.1 <span class="o">=</span> INTEGER: 1
SNMPv2-SMI::enterprises.3495.1.5.1.2.14.2 <span class="o">=</span> INTEGER: 2
SNMPv2-SMI::enterprises.3495.1.5.1.2.14.3 <span class="o">=</span> INTEGER: 3
SNMPv2-SMI::enterprises.3495.1.5.1.2.15.1 <span class="o">=</span> INTEGER: 3
SNMPv2-SMI::enterprises.3495.1.5.1.2.15.2 <span class="o">=</span> INTEGER: 5
SNMPv2-SMI::enterprises.3495.1.5.1.2.15.3 <span class="o">=</span> INTEGER: 6
SNMPv2-SMI::enterprises.3495.1.5.1.2.16.1 <span class="o">=</span> STRING: <span class="s2">&quot;10.168.170.43&quot;</span>
SNMPv2-SMI::enterprises.3495.1.5.1.2.16.2 <span class="o">=</span> STRING: <span class="s2">&quot;10.168.168.73&quot;</span>
SNMPv2-SMI::enterprises.3495.1.5.1.2.16.3 <span class="o">=</span> STRING: <span class="s2">&quot;10.168.168.122&quot;</span>
</code></pre></div>
<p>原来的SNMPv2-SMI::enterprises.3495.1.5.1.2.15.1 = STRING: &ldquo;10.168.170.43&rdquo;变成了SNMPv2-SMI::enterprises.3495.1.5.1.2.16.1 = STRING: &ldquo;10.168.170.43&rdquo;，而SNMPv2-SMI::enterprises.3495.1.5.1.2.15.1 = INTEGER: 3就是需要的open_conn数据了！</p>
      <a href="/2011/06/22/extend-open_conn-output-support-to-squid-snmp" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/14/intro-mybench" title="mysql测试小工具mybench试用" rel="bookmark">mysql测试小工具mybench试用</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-14 00:00:00 +0800">14 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#testing-ref" title="testing" rel="category tag">testing</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>小型的mysql测试工具，主要有自带的mysqlslap、super-smack和mybench。嗯，我这里的小型的意思是指工具安装过程简单。
mysqlslap的使用方法遍地都是，就不先详细写了。根据个人偏好写写mybench吧，毕竟是perl的。
安装很简单，如下：</p>
<div class="highlight"><pre><code class="bash">cpanm DBI DBD::mysql Time::HiRes
wget http://jeremy.zawodny.com/mysql/mybench/mybench-1.0.tar.gz
tar zxvf mybench-1.0.tar.gz
<span class="nb">cd </span>mybench-1.0
perl MakeFile.PL <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make install
</code></pre></div>
<p>但是使用就不是太简单了——mysqlslap会自己生成（-a选项）sql，super-smack则带了一个gen-data程序生成数据然后自动导入，但是mybench没有，所以只能自己搞定数据。
不过mybench还是自己生成了一个测试模版的脚本在/usr/bin/bench_example，很简单的就知道怎么做了。
example如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="nb">eval</span> <span class="s">&#39;exec /usr/bin/perl -w -S $0 ${1+&quot;$@&quot;}&#39;</span>
    <span class="k">if</span> <span class="mi">0</span><span class="p">;</span> <span class="c1"># not running under some shell</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">MyBench</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Std</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Time::</span><span class="n">HiRes</span> <span class="sx">qw(gettimeofday tv_interval)</span><span class="p">;</span>
<span class="k">use</span> <span class="n">DBI</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%opt</span><span class="p">;</span>
<span class="nn">Getopt::Std::</span><span class="n">getopt</span><span class="p">(</span><span class="s">&#39;n:r:h:&#39;</span><span class="p">,</span> <span class="o">\</span><span class="nv">%opt</span><span class="p">);</span>
<span class="c1">#这是我见过的最hardcode的perl脚本了（呃，除了我自己写的垃圾），连db库、用户名、密码都不给运行参数的</span>
<span class="k">my</span> <span class="nv">$num_kids</span>  <span class="o">=</span> <span class="nv">$opt</span><span class="p">{</span><span class="n">n</span><span class="p">}</span> <span class="o">||</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$num_runs</span>  <span class="o">=</span> <span class="nv">$opt</span><span class="p">{</span><span class="n">r</span><span class="p">}</span> <span class="o">||</span> <span class="mi">100</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$db</span>        <span class="o">=</span> <span class="s">&quot;test&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$user</span>      <span class="o">=</span> <span class="s">&quot;test&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$pass</span>      <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$port</span>      <span class="o">=</span> <span class="mi">3306</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$host</span>      <span class="o">=</span> <span class="nv">$opt</span><span class="p">{</span><span class="n">h</span><span class="p">}</span> <span class="o">||</span> <span class="s">&quot;192.168.0.1&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$dsn</span>       <span class="o">=</span> <span class="s">&quot;DBI:mysql:$db:$host;port=$port&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$callback</span> <span class="o">=</span> <span class="k">sub</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$id</span>  <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$dbh</span> <span class="o">=</span> <span class="n">DBI</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span><span class="nv">$dsn</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$pass</span><span class="p">,</span> <span class="p">{</span> <span class="n">RaiseError</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">});</span>
<span class="c1">#为测试准备的请求，测select就写select，测insert就写insert呗~</span>
<span class="c1">#如果不修改，也就是说测试用的是test.mytable表，而且必须有一个列叫id</span>
    <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&quot;SELECT * FROM mytable WHERE ID = ?&quot;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@times</span> <span class="o">=</span> <span class="p">();</span>
    <span class="c1">## wait for the parent to HUP me</span>
    <span class="nb">local</span> <span class="nv">$SIG</span><span class="p">{</span><span class="n">HUP</span><span class="p">}</span> <span class="o">=</span> <span class="k">sub </span><span class="p">{</span> <span class="p">};</span>
    <span class="nb">sleep</span> <span class="mi">600</span><span class="p">;</span>
<span class="c1">#脚本定义的每个进程执行多少次请求</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">$cnt</span> <span class="o">&lt;</span> <span class="nv">$num_runs</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">100_000</span><span class="p">));</span>
        <span class="c1">## time the query</span>
        <span class="k">my</span> <span class="nv">$t0</span> <span class="o">=</span> <span class="p">[</span><span class="n">gettimeofday</span><span class="p">];</span>
<span class="c1">#真正的执行sql请求，通过上面的rand知道，之前准备的test.mytable的id列必须是int格式，同时不少于10w行（又一处hard）</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$v</span><span class="p">);</span>
<span class="c1">#通过前后两次gettimeofday获得sql的exec耗时</span>
        <span class="k">my</span> <span class="nv">$t1</span> <span class="o">=</span> <span class="n">tv_interval</span><span class="p">(</span><span class="nv">$t0</span><span class="p">,</span> <span class="p">[</span><span class="n">gettimeofday</span><span class="p">]);</span>
<span class="c1">#完成一次请求执行，加入数组</span>
        <span class="nb">push</span> <span class="nv">@times</span><span class="p">,</span> <span class="nv">$t1</span><span class="p">;</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">();</span>
        <span class="nv">$cnt</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">## cleanup</span>
    <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">();</span>
<span class="c1">#计算本进程全部请求的各项数据，几个大小和均来自MyBench模块</span>
    <span class="k">my</span> <span class="nv">@r</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nb">scalar</span><span class="p">(</span><span class="nv">@times</span><span class="p">),</span> <span class="n">min</span><span class="p">(</span><span class="nv">@times</span><span class="p">),</span> <span class="n">max</span><span class="p">(</span><span class="nv">@times</span><span class="p">),</span> <span class="n">avg</span><span class="p">(</span><span class="nv">@times</span><span class="p">),</span> <span class="n">tot</span><span class="p">(</span><span class="nv">@times</span><span class="p">));</span>
    <span class="k">return</span> <span class="nv">@r</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">#将上面这个函数交给MyBench模块的fork_and_work执行，即并发指定数量请求，返回总的结果</span>
<span class="k">my</span> <span class="nv">@results</span> <span class="o">=</span> <span class="nn">MyBench::</span><span class="n">fork_and_work</span><span class="p">(</span><span class="nv">$num_kids</span><span class="p">,</span> <span class="nv">$callback</span><span class="p">);</span>
<span class="c1">#计算总的数据</span>
<span class="nn">MyBench::</span><span class="n">compute_results</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="nv">@results</span><span class="p">);</span>
<span class="nb">exit</span><span class="p">;</span>
<span class="cp">__END__</span>
</code></pre></div>
<p>然后看看/usr/lib/perl5/site_perl/5.8.8/MyBench.pm，主要内容就是fork和compute：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="n">MyBench</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="nv">$</span><span class="nn">main::</span><span class="nv">VERSION</span> <span class="o">=</span> <span class="s">&#39;1.0&#39;</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Exporter</span><span class="p">;</span>
<span class="nv">@</span><span class="nn">MyBench::</span><span class="nv">ISA</span> <span class="o">=</span> <span class="s">&#39;Exporter&#39;</span><span class="p">;</span>
<span class="c1">#导出求最大值、最小值、平均值、综合值的函数给外面用</span>
<span class="nv">@</span><span class="nn">MyBench::</span><span class="nv">EXPORT</span> <span class="o">=</span> <span class="sx">qw(max min avg tot)</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">fork_and_work</span><span class="p">($$)</span>
<span class="p">{</span>
<span class="c1">#关闭输出缓冲</span>
    <span class="vg">$|</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">IO::</span><span class="n">Pipe</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">IO::</span><span class="n">Select</span><span class="p">;</span>
    <span class="nv">$SIG</span><span class="p">{</span><span class="n">CHLD</span><span class="p">}</span> <span class="o">=</span> <span class="s">&#39;IGNORE&#39;</span><span class="p">;</span>      <span class="c1">## let the kids die</span>
    <span class="k">my</span> <span class="nv">$kids_to_fork</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$callback</span>     <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$num_kids</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@pipes</span>        <span class="o">=</span> <span class="p">();</span>
    <span class="k">my</span> <span class="nv">@pids</span>         <span class="o">=</span> <span class="p">();</span>
    <span class="k">my</span> <span class="nv">$pid</span>          <span class="o">=</span> <span class="nb">undef</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;forking: &quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">$num_kids</span> <span class="o">&lt;</span> <span class="nv">$kids_to_fork</span><span class="p">)</span>
    <span class="p">{</span>
<span class="c1">#用IO::Pipe管道方式来传递父子进程的信息</span>
        <span class="k">my</span> <span class="nv">$pipe</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">IO::</span><span class="n">Pipe</span><span class="p">;</span>
<span class="c1">#fork进程开始</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$pid</span> <span class="o">=</span> <span class="nb">fork</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="c1">## parent</span>
            <span class="nv">$num_kids</span><span class="o">++</span><span class="p">;</span>
<span class="c1">#每fork完成一个打印一个+号</span>
            <span class="k">print</span> <span class="s">&quot;+&quot;</span><span class="p">;</span>
<span class="c1">#从管道中读取数据</span>
            <span class="nv">$pipe</span><span class="o">-&gt;</span><span class="n">reader</span><span class="p">();</span>
            <span class="nb">push</span> <span class="nv">@pipes</span><span class="p">,</span> <span class="nv">$pipe</span><span class="p">;</span>
            <span class="nb">push</span> <span class="nv">@pids</span><span class="p">,</span>  <span class="nv">$pid</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">elsif</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$pid</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">## child</span>
<span class="c1">#打开管道写入数据的功能</span>
            <span class="nv">$pipe</span><span class="o">-&gt;</span><span class="n">writer</span><span class="p">();</span>
<span class="c1">#执行select_example脚本传入的mysql请求测试函数</span>
            <span class="k">my</span> <span class="nv">@result</span> <span class="o">=</span> <span class="nv">$callback</span><span class="o">-&gt;</span><span class="p">(</span><span class="nv">$num_kids</span><span class="p">);</span>
<span class="c1">#把结果写入管道</span>
            <span class="k">print</span> <span class="nv">$pipe</span> <span class="s">&quot;@result\n&quot;</span><span class="p">;</span>
<span class="c1">#关闭管道</span>
            <span class="nv">$pipe</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">();</span>
            <span class="nb">exit</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">print</span> <span class="s">&quot;fork failed: $!\n&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">print</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
    <span class="c1">## give them a bit of time to setup</span>
    <span class="k">my</span> <span class="nv">$time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nv">$num_kids</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;sleeping for $time seconds while kids get ready\n&quot;</span><span class="p">;</span>
    <span class="nb">sleep</span> <span class="nv">$time</span><span class="p">;</span>
 <span class="c1">#发送SIGHUP信号给callback函数</span>
    <span class="nb">kill</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">@pids</span><span class="p">;</span>
    <span class="c1">## collect the results</span>
    <span class="k">my</span> <span class="nv">@results</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;waiting: &quot;</span><span class="p">;</span>
<span class="c1">#从管道中读取数据到数组</span>
    <span class="k">for</span> <span class="k">my</span> <span class="nv">$pipe</span> <span class="p">(</span><span class="nv">@pipes</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="sr">&lt;$pipe&gt;</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@results</span><span class="p">,</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="nv">$pipe</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">();</span>
        <span class="k">print</span> <span class="s">&quot;-&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">print</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">@results</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">compute_results</span><span class="p">(@)</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$recs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$Cnt</span><span class="p">,</span> <span class="nv">$Min</span><span class="p">,</span> <span class="nv">$Max</span><span class="p">,</span> <span class="nv">$Avg</span><span class="p">,</span> <span class="nv">$Tot</span><span class="p">,</span> <span class="nv">@Min</span><span class="p">,</span> <span class="nv">@Max</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">@_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">## 6 elements per record</span>
        <span class="k">my</span> <span class="nv">$rec</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span> <span class="nb">chomp</span> <span class="nv">$rec</span><span class="p">;</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$cnt</span><span class="p">,</span> <span class="nv">$min</span><span class="p">,</span> <span class="nv">$max</span><span class="p">,</span> <span class="nv">$avg</span><span class="p">,</span> <span class="nv">$tot</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span> <span class="sr">/\s+/</span><span class="p">,</span> <span class="nv">$rec</span><span class="p">;</span>
        <span class="nv">$Cnt</span> <span class="o">+=</span> <span class="nv">$cnt</span><span class="p">;</span>
        <span class="nv">$Avg</span> <span class="o">+=</span> <span class="nv">$avg</span><span class="p">;</span>
        <span class="nv">$Tot</span> <span class="o">+=</span> <span class="nv">$tot</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@Min</span><span class="p">,</span> <span class="nv">$min</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@Max</span><span class="p">,</span> <span class="nv">$max</span><span class="p">;</span>
        <span class="nv">$recs</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$Avg</span> <span class="o">=</span> <span class="nv">$Avg</span> <span class="o">/</span> <span class="nv">$recs</span><span class="p">;</span>
    <span class="nv">$Min</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="nv">@Min</span><span class="p">);</span>
    <span class="nv">$Max</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="nv">@Max</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$Qps</span> <span class="o">=</span> <span class="nv">$Cnt</span> <span class="sr">/ ($Tot /</span> <span class="nv">$recs</span><span class="p">);</span>
    <span class="k">print</span> <span class="s">&quot;$name: $Cnt $Min $Max $Avg $Tot $Qps\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  clients : $recs\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  queries : $Cnt\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  fastest : $Min\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  slowest : $Max\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  average : $Avg\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  serial  : $Tot\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  q/sec   : $Qps\n&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">## some numerical helper functions for arrays</span>
<span class="k">sub </span><span class="nf">max</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">@_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span> <span class="o">&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$val</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">min</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">@_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span> <span class="o">&lt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$val</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">avg</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$tot</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">@_</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$tot</span> <span class="o">+=</span> <span class="nv">$_</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$tot</span> <span class="o">/</span> <span class="nv">@_</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">tot</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$tot</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">@_</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$tot</span> <span class="o">+=</span> <span class="nv">$_</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$tot</span><span class="p">;</span>
<span class="p">}</span>
<span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>好了，开始准备数据，比较懒，直接用super-smack的gen-data先出了一些./gen-data  -n 100000 -f %n,%80-12s%12n,%512-512s,%d &gt; /root/data，然后进mysql里执行：</p>
<div class="highlight"><pre><code class="mysql"><span class="k">USE</span> <span class="n">test</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nf">mytable</span> <span class="p">(</span><span class="n">id</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="kp">AUTO_INCREMENT</span><span class="p">,</span> <span class="n">col1</span> <span class="kt">CHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">col2</span> <span class="kt">CHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">col3</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">)</span><span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="k">LOAD</span> <span class="n">DATA</span> <span class="n">LOCAL</span> <span class="k">INFILE</span> <span class="s1">&#39;data&#39;</span> <span class="k">REPLACE</span> <span class="k">INTO</span> <span class="k">TABLE</span> <span class="s1">&#39;mytable&#39;</span> <span class="n">FIELDS</span> <span class="k">TERMINATED</span> <span class="k">BY</span> <span class="s1">&#39;,&#39;</span> <span class="k">LINES</span> <span class="k">TERMINATED</span> <span class="k">BY</span> <span class="s1">&#39;\n&#39;</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="nf">mytable</span> <span class="p">(</span><span class="n">col1</span><span class="p">,</span><span class="n">col2</span><span class="p">,</span><span class="n">col3</span><span class="p">)</span> <span class="k">SELECT</span> <span class="n">col1</span><span class="p">,</span><span class="n">col2</span><span class="p">,</span><span class="n">col3</span> <span class="k">FROM</span> <span class="n">mytable</span><span class="p">;</span>
</code></pre></div>
<p>最后执行./select_bench -h 10.168.170.92 -n 10 -r 1000就能看到结果了：
forking: ++++++++++
sleeping for 2 seconds while kids get ready
waiting: &mdash;&mdash;&mdash;-
test: 10000 0.00017 0.006809 0.0010413514 10.413514 9602.9063772325
  clients : 10
  queries : 10000
  fastest : 0.00017
  slowest : 0.006809
  average : 0.0010413514
  serial  : 10.413514
  q/sec   : 9602.9063772325</p>
      <a href="/2011/06/14/intro-mybench" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/10/java-chinese-support" title="java的中文支持" rel="bookmark">java的中文支持</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-10 00:00:00 +0800">10 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>往论坛上传图片，有的图片上有中文字，却显示成方框。求助了一下度娘，快速解决。记录一下：
* 第一步，在windows下找到simsun.ttc文件，嗯，ntfs系统下强力推荐everything小工具一个；
* 第二步，上传simsun.ttc到服务器的/usr/share/fonts/zh_CN/下，其他路径也行，不过这个路径比较通用；
* 第三步，在$JAVA_HOME/jrp/lib/下创建fontconfig.properties.zh文件，原型格式可见同目录下的fontconfig.properties.src。
fontconfig.properties.zh文件相关内容如下：</p>
<div class="highlight"><pre><code class="java"><span class="n">allfonts</span><span class="o">.</span><span class="na">chinese</span><span class="o">-</span><span class="n">gbk</span><span class="o">=-</span><span class="n">misc</span><span class="o">-</span><span class="n">simsun</span><span class="o">-</span><span class="n">medium</span><span class="o">-</span><span class="n">r</span><span class="o">-</span><span class="n">normal</span><span class="o">--*-%</span><span class="n">d</span><span class="o">-*-*-</span><span class="n">p</span><span class="o">-*-</span><span class="n">gbk</span><span class="o">-</span><span class="mi">0</span>
<span class="n">allfonts</span><span class="o">.</span><span class="na">chinese</span><span class="o">-</span><span class="n">gb2312</span><span class="o">=-</span><span class="n">misc</span><span class="o">-</span><span class="n">simsun</span><span class="o">-</span><span class="n">medium</span><span class="o">-</span><span class="n">r</span><span class="o">-</span><span class="n">normal</span><span class="o">--*-%</span><span class="n">d</span><span class="o">-*-*-</span><span class="n">p</span><span class="o">-*-</span><span class="n">gb2312</span><span class="o">.</span><span class="mi">1980</span><span class="o">-</span><span class="mi">0</span>
<span class="n">sequence</span><span class="o">.</span><span class="na">allfonts</span><span class="o">.</span><span class="na">GB18030</span><span class="o">=</span><span class="n">latin</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">gbk</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">cn</span><span class="o">-</span><span class="n">iso10646</span>
<span class="n">sequence</span><span class="o">.</span><span class="na">allfonts</span><span class="o">.</span><span class="na">GBK</span><span class="o">=</span><span class="n">latin</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">gbk</span>
<span class="n">sequence</span><span class="o">.</span><span class="na">allfonts</span><span class="o">.</span><span class="na">GB2312</span><span class="o">=</span><span class="n">latin</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">gb2312</span>
<span class="n">sequence</span><span class="o">.</span><span class="na">allfonts</span><span class="o">.</span><span class="na">UTF</span><span class="o">-</span><span class="mi">8</span><span class="o">.</span><span class="na">ko</span><span class="o">.</span><span class="na">KR</span><span class="o">=</span><span class="n">latin</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">korean</span><span class="o">,</span><span class="n">japanese</span><span class="o">-</span><span class="n">x0208</span><span class="o">,</span><span class="n">japanese</span><span class="o">-</span><span class="n">x0201</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">gbk</span>
<span class="n">sequence</span><span class="o">.</span><span class="na">allfonts</span><span class="o">.</span><span class="na">UTF</span><span class="o">-</span><span class="mi">8</span><span class="o">.</span><span class="na">ja</span><span class="o">.</span><span class="na">JP</span><span class="o">=</span><span class="n">latin</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">japanese</span><span class="o">-</span><span class="n">x0208</span><span class="o">,</span><span class="n">japanese</span><span class="o">-</span><span class="n">x0201</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">gbk</span><span class="o">,</span><span class="n">korean</span>
<span class="n">sequence</span><span class="o">.</span><span class="na">fallback</span><span class="o">=</span><span class="n">lucida</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">big5</span><span class="o">,</span><span class="n">chinese</span><span class="o">-</span><span class="n">gbk</span><span class="o">,</span><span class="n">japanese</span><span class="o">-</span><span class="n">x0208</span><span class="o">,</span><span class="n">korean</span>
<span class="n">filename</span><span class="o">.-</span><span class="n">misc</span><span class="o">-</span><span class="n">simsun</span><span class="o">-</span><span class="n">medium</span><span class="o">-</span><span class="n">r</span><span class="o">-</span><span class="n">normal</span><span class="o">--*-%</span><span class="n">d</span><span class="o">-*-*-</span><span class="n">p</span><span class="o">-*-</span><span class="n">gbk</span><span class="o">-</span><span class="mi">0</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">fonts</span><span class="o">/</span><span class="n">zh_CN</span><span class="o">/</span><span class="n">simsun</span><span class="o">.</span><span class="na">ttc</span>
<span class="n">filename</span><span class="o">.-</span><span class="n">misc</span><span class="o">-</span><span class="n">simsun</span><span class="o">-</span><span class="n">medium</span><span class="o">-</span><span class="n">r</span><span class="o">-</span><span class="n">normal</span><span class="o">--*-%</span><span class="n">d</span><span class="o">-*-*-</span><span class="n">p</span><span class="o">-*-</span><span class="n">gb2312</span><span class="o">.</span><span class="mi">1980</span><span class="o">-</span><span class="mi">0</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">fonts</span><span class="o">/</span><span class="n">zh_CN</span><span class="o">/</span><span class="n">simsun</span><span class="o">.</span><span class="na">ttc</span>
<span class="n">awtfontpath</span><span class="o">.</span><span class="na">chinese</span><span class="o">-</span><span class="n">gb2312</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">fonts</span><span class="o">/</span><span class="n">zh_CN</span>
<span class="n">awtfontpath</span><span class="o">.</span><span class="na">chinese</span><span class="o">-</span><span class="n">gbk</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">fonts</span><span class="o">/</span><span class="n">zh_CN</span>
</code></pre></div>
<p>很简单的一件小事儿，一来作个记录，二来测试微博同步——从百度统计看我可怜的一点点访问都来自微博……</p>
      <a href="/2011/06/10/java-chinese-support" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/09/statistics-descriptive-module-of-perl" title="perl模块Statistics::Descriptive" rel="bookmark">perl模块Statistics::Descriptive</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-09 00:00:00 +0800">09 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>今天写基调测试报告，需要从原始的ping延时和丢包率数据中自己计算标准方差以评估波动性（直接运行ping命令可见，不过基调报告里没有）。
方差是各个数据与其平均数的差的平方的平均数。标准差（均方差）则是方差的算术平方根。
这个时候可以打开excel……不过作为excel只会填文字的人，只好打开CPAN来解决问题了~</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">Statistics::</span><span class="n">Descriptive</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="nb">open</span> <span class="n">FH</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&#39;data&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$data</span><span class="o">=</span><span class="p">{};</span>
<span class="k">while</span><span class="p">(</span><span class="sr">&lt;FH&gt;</span><span class="p">){</span>
   <span class="k">my</span> <span class="nv">@F</span> <span class="o">=</span> <span class="nb">split</span><span class="p">;</span>
   <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;快网延时&quot;</span><span class="p">}},</span> <span class="nv">$F</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
   <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;快网丢包&quot;</span><span class="p">}},</span> <span class="nv">$F</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
   <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;森华延时&quot;</span><span class="p">}},</span> <span class="nv">$F</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
   <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;森华丢包&quot;</span><span class="p">}},</span> <span class="nv">$F</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
   <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;帝联延时&quot;</span><span class="p">}},</span> <span class="nv">$F</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
   <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;帝联丢包&quot;</span><span class="p">}},</span> <span class="nv">$F</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="p">}</span>
<span class="nb">close</span> <span class="n">FH</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$stat</span> <span class="o">=</span> <span class="nn">Statistics::Descriptive::</span><span class="n">Full</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$key</span> <span class="p">(</span><span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$data</span><span class="p">})</span> <span class="p">{</span>
    <span class="nv">$stat</span><span class="o">-&gt;</span><span class="n">add_data</span><span class="p">(</span><span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$key&quot;</span><span class="p">}});</span>
    <span class="k">print</span> <span class="nv">$key</span><span class="o">.</span><span class="s">&quot;\t&quot;</span><span class="o">.</span><span class="nv">$stat</span><span class="o">-&gt;</span><span class="n">standard_deviation</span><span class="p">(),</span><span class="s">&quot;\n&quot;</span><span class="p">;</span>
    <span class="nv">$stat</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>记住一定要clear，不然的话add_data会接着上一次的加，然后数据就错了。</p>
      <a href="/2011/06/09/statistics-descriptive-module-of-perl" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/09/intro-spread" title="spread试验" rel="bookmark">spread试验</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-09 00:00:00 +0800">09 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>spread还是半年前的时候偶然看到的，一直没有试过。前段时间用gearman收集集群日志时，发现gearman的方式，worker不会知道client来自哪里，一条job只会一个worker来做，比较适合做分布式计算，但相比我最初设想的实时系统管理需求，还是有一定距离。于是重新翻出来spread，感觉可以根据应用系统设置不同的group，然后统一再由一个回收结果的group即可。于是有了如下试验：</p>
<ul>
  <li>spread安装配置：</li>
</ul>
<div class="highlight"><pre><code class="bash">wget http://www.spread.org/download/spread-src-4.1.0.tar.gz
tar zxvf spread-src-4.1.0.tar.gz
<span class="nb">cd </span>spread-src-4.1.0
./configure --prefix<span class="o">=</span>/usr/local/spread <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make install
cat &gt; /usr/local/spread/etc/spread.conf <span class="s">&lt;&lt; EOF</span>
<span class="s">Spread_Segment  10.1.171.255:4804 {</span>
<span class="s">        ct-142                  10.1.168.142</span>
<span class="s">        ct-94                   10.1.168.94</span>
<span class="s">        ct-241                  10.1.168.241</span>
<span class="s">        ct-156                  10.1.168.156</span>
<span class="s">        ct-70                   10.1.170.70</span>
<span class="s">        cnc-64                  10.1.169.64</span>
<span class="s">        cnc-80                  10.1.169.80</span>
<span class="s">        cnc-72                  10.1.169.72</span>
<span class="s">        cnc-58                  10.1.169.58</span>
<span class="s">}</span>
<span class="s">EOF</span>
groupadd spread
useradd -g spread spread
mkdir -p /var/run/spread
chown spread:spread /var/run/spread
<span class="nb">echo</span> <span class="s1">&#39;/usr/local/spread/lib&#39;</span> &gt; /etc/ld.conf.d/spread.conf <span class="o">&amp;&amp;</span> ldconfig
<span class="c">#必须用-n指定配置文件中定义好了的servername；</span>
<span class="c">#奇怪的是网上别的文章都指出这些配置要同时写入hosts，但我没写也一样用了</span>
/usr/local/spread/sbin/spread -c /usr/local/spread/etc/spread.conf -n ct-156 &amp;
</code></pre></div>
<ul>
  <li>perl的spread使用</li>
</ul>
<p>CPAN上有很多关于spread的模块，试了几个后，选中了Spread::Messaging::Content。使用如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">Spread::Messaging::</span><span class="n">Content</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Event</span><span class="p">;</span>
<span class="nv">$spread</span> <span class="o">=</span> <span class="nn">Spread::Messaging::</span><span class="n">Content</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
     <span class="o">-</span><span class="n">port</span> <span class="o">=&gt;</span> <span class="s">&quot;4804&quot;</span><span class="p">,</span>
     <span class="o">-</span><span class="n">timeout</span> <span class="o">=&gt;</span> <span class="s">&quot;10&quot;</span><span class="p">,</span>
     <span class="o">-</span><span class="n">host</span> <span class="o">=&gt;</span> <span class="s">&quot;10.1.168.156&quot;</span><span class="p">,</span>
 <span class="p">);</span>
<span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">join_group</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">);</span>
<span class="c1">#当spread的group存在了filedescriptor后，执行子函数；</span>
<span class="c1">#$spread-&gt;fd来自Spread::Messaging::Transport，这个module是Spread::Messaging::Content自动加载调用的</span>
<span class="n">Event</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">(</span><span class="n">fd</span> <span class="o">=&gt;</span> <span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=&gt;</span> <span class="o">\&amp;</span><span class="n">put_output</span><span class="p">);</span>
<span class="nn">Event::</span><span class="n">loop</span><span class="p">();</span>
<span class="k">sub </span><span class="nf">put_output</span> <span class="p">{</span>
    <span class="nv">$spread</span><span class="o">-&gt;</span><span class="nb">recv</span><span class="p">();</span>
    <span class="nb">printf</span><span class="p">(</span><span class="s">&quot;Sender      : %s\n&quot;</span><span class="p">,</span> <span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">sender</span><span class="p">);</span>
    <span class="nb">printf</span><span class="p">(</span><span class="s">&quot;Groups      : %s\n&quot;</span><span class="p">,</span> <span class="nb">join</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">}));</span>
    <span class="nb">printf</span><span class="p">(</span><span class="s">&quot;Message     : %s\n&quot;</span><span class="p">,</span> <span class="nb">ref</span><span class="p">(</span><span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">)</span> <span class="ow">eq</span> <span class="s">&quot;ARRAY&quot;</span> <span class="p">?</span> 
                                     <span class="nb">join</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">})</span> <span class="p">:</span>
                                     <span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">Spread::Messaging::</span><span class="n">Content</span><span class="p">;</span>
<span class="nv">$spread</span> <span class="o">=</span> <span class="nn">Spread::Messaging::</span><span class="n">Content</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
     <span class="o">-</span><span class="n">port</span> <span class="o">=&gt;</span> <span class="s">&quot;4804&quot;</span><span class="p">,</span>
     <span class="o">-</span><span class="n">timeout</span> <span class="o">=&gt;</span> <span class="s">&quot;10&quot;</span><span class="p">,</span>
     <span class="o">-</span><span class="n">host</span> <span class="o">=&gt;</span> <span class="s">&quot;10.1.168.156&quot;</span><span class="p">,</span>
 <span class="p">);</span>
 <span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">(</span><span class="s">&quot;test2&quot;</span><span class="p">);</span>
 <span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">);</span>
 <span class="nv">$spread</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">(</span><span class="s">&quot;cooking with fire&quot;</span><span class="p">);</span>
 <span class="nv">$spread</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">();</span>
</code></pre></div>
<ul>
  <li>spread自带的spuser使用</li>
</ul>
<div class="highlight"><pre><code class="bash">/usr/local/spread/bin/spuser -s 4804
j <span class="nb">test</span>
m <span class="nb">test</span>
</code></pre></div>
      <a href="/2011/06/09/intro-spread" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/09/inode-problem-of-tmpfs" title="tmpfs的inode问题" rel="bookmark">tmpfs的inode问题</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-09 00:00:00 +0800">09 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一些squid服务器为了强调加速效果，使用tmpfs来做cache_dir。刚开始运行的时候也嗖嗖的，不过没过一两天，mgr:info就看到缓存命中率急剧下降，字节命中率甚至只剩下10%左右！检查了多次配置，绝对没有问题，但同样的url，曾经一分钟几百次的HIT，现在一分钟几百次MISS……
df看，不管是tmpfs，还是logs所在的目录，都才用了不到30%。最后想起来df -i看了下，果然，tmpfs的inode使用率100%了！
赶紧remount了一次，解决了问题。但不是根本出路。还是得想办法搞定这个inode。
在linux代码说明里找到了关于tmpfs的文档（/usr/src/linux/Documentation/filesystems/tmpfs.txt）：
    tmpfs has three mount options for sizing:
    ……
    nr_inodes: The maximum number of inodes for this instance. <strong>The default
               is half of the number of your physical RAM pages</strong>, or (on a
               machine with highmem) the number of lowmem RAM pages,
               whichever is the lower.
    These parameters accept a suffix k, m or g for kilo, mega and giga and
    can be changed on remount.  The size parameter also accepts a suffix %
    to limit this tmpfs instance to that percentage of your physical RAM:
    <strong>the default, when neither size nor nr_blocks is specified, is size=50%</strong></p>
<pre><code>If nr_blocks=0 (or size=0), blocks will not be limited in that instance;
&lt;strong&gt;if nr_inodes=0, inodes will not be limited.&lt;/strong&gt;  It is generally unwise to
mount with such options, since it allows any user with write access to
use up all the memory on the machine; but enhances the scalability of
that instance in a system with many cpus making intensive use of it. linux默认的RAM page大小是4k，好了来计算一下吧。
</code></pre>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@bbs_squid4 ~<span class="o">]</span><span class="c"># df -i|awk &#39;/tmpfs/{print $2}&#39;</span>
504912
<span class="o">[</span>root@bbs_squid4 ~<span class="o">]</span><span class="c"># free -k|awk &#39;/Mem/{print $2/4/2}&#39;</span>
504912
</code></pre></div>
<p>果然如此！
那么真正的解决办法也就有了：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c"># mount -t tmpfs -o size=2000M,mode=777,nr_inodes=0 tmpfs /tmpfs</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c"># df -i|grep tmpfs</span>
tmpfs                      0       0       0    -  /tmpfs
</code></pre></div>
      <a href="/2011/06/09/inode-problem-of-tmpfs" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/03/aggregate-multi-servers-rollback-log-by-gearmand" title="用gearman汇总多台服务器的回滚日志" rel="bookmark">用gearman汇总多台服务器的回滚日志</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-03 00:00:00 +0800">03 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>gearman其实不是重点，因为我就是抄了一遍perldoc的样例而已。关键在服务器上的log4j日志是回滚的，所以需要配合回滚（猜测log4j的DailyRollingFile回滚方式类似mv resin.log resin.log-ymd &amp;&amp; reload，这样在回滚后，FH还在resin.log-ymd上，就读不到新日志了）重启FH。
另：tail命令有个参数-F/&ndash;follow=name，可以锁定文件名而不是文件描述符，不知道这个功能是怎么做到的？
一步一步来：</p>
<ul>
  <li>jobserver</li>
</ul>
<div class="highlight"><pre><code class="bash">cpan -i Gearman::Server
gearmand -d -L 10.168.170.25 -p 7003
</code></pre></div>
<ul>
  <li>worker</li>
</ul>
<div class="highlight"><pre><code class="bash">cpan -i Gearman::Worker
</code></pre></div>
<p>然后看日志的脚本，其实也就是样例：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">Gearman::</span><span class="n">Worker</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$worker</span> <span class="o">=</span> <span class="nn">Gearman::</span><span class="n">Worker</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
<span class="nv">$worker</span><span class="o">-&gt;</span><span class="n">job_servers</span><span class="p">(</span><span class="s">&#39;10.1.1.25:7003&#39;</span><span class="p">);</span>
<span class="nv">$worker</span><span class="o">-&gt;</span><span class="n">register_function</span><span class="p">(</span> <span class="n">watchlog</span> <span class="o">=&gt;</span> <span class="o">\&amp;</span><span class="n">watchlog</span> <span class="p">);</span>
<span class="nv">$worker</span><span class="o">-&gt;</span><span class="n">work</span> <span class="k">while</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">watchlog</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$job</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">print</span> <span class="nv">$job</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span><span class="s">&quot;\n&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ul>
  <li>client（也就是多台resin服务器上）</li>
</ul>
<div class="highlight"><pre><code class="bash">cpan -i Gearman::Client
</code></pre></div>
<p>然后是脚本：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">Gearman::</span><span class="n">Client</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(strftime)</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$client</span> <span class="o">=</span> <span class="nn">Gearman::</span><span class="n">Client</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="n">job_servers</span><span class="p">(</span><span class="s">&#39;10.1.1.25:7003&#39;</span><span class="p">);</span>
<span class="o">&amp;</span><span class="nb">read</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">open</span> <span class="n">FH1</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&#39;/tmp/pid.txt&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$childpid</span> <span class="o">=</span> <span class="sr">&lt;FH1&gt;</span><span class="p">;</span>
    <span class="nb">close</span> <span class="n">FH1</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$date</span><span class="o">=</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span><span class="nb">localtime</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$date</span> <span class="ow">eq</span> <span class="s">&#39;00:00:00&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">kill</span> <span class="mi">9</span><span class="p">,</span><span class="nv">$childpid</span><span class="p">;</span>
        <span class="nb">sleep</span> <span class="mi">1</span><span class="p">;</span>
        <span class="o">&amp;</span><span class="nb">read</span><span class="p">;</span>   
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">read</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="nb">fork</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">#这个$$不能直接赋值出去，所以采用文件方式，以后研究一下pipe啊之类的办法。</span>
    <span class="nb">open</span> <span class="n">FH</span><span class="p">,</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span><span class="s">&#39;/tmp/pid.txt&#39;</span><span class="p">;</span>
    <span class="k">print</span> <span class="n">FH</span> <span class="vg">$$</span><span class="p">;</span>
    <span class="nb">close</span> <span class="n">FH</span><span class="p">;</span>
    <span class="nb">open</span> <span class="p">(</span><span class="n">FD</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&#39;resin.log&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">die</span> <span class="vg">$!</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">my</span> <span class="nv">$log</span> <span class="o">=</span> <span class="sr">&lt;FD&gt;</span><span class="p">;</span>
       <span class="nb">sleep</span> <span class="mi">1</span> <span class="ow">and</span> <span class="k">next</span> <span class="k">unless</span> <span class="nv">$log</span><span class="p">;</span>
       <span class="nb">chomp</span> <span class="nv">$log</span><span class="p">;</span>
       <span class="nv">$client</span><span class="o">-&gt;</span><span class="n">dispatch_background</span><span class="p">(</span><span class="s">&#39;watchlog&#39;</span><span class="p">,</span><span class="nv">$log</span><span class="p">);</span>
       <span class="p">}</span>
    <span class="nb">close</span> <span class="n">FD</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
      <a href="/2011/06/03/aggregate-multi-servers-rollback-log-by-gearmand" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/01/intro-html-template" title="HTML::Template试用" rel="bookmark">HTML::Template试用</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-01 00:00:00 +0800">01 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>给我自己的学习计划做个开头，从html::template开始试用。
首先利用上上篇的nmap.pl脚本，提取一些数据，然后展示在页面上。
cgi脚本如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">HTML::</span><span class="n">Template</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">XML::</span><span class="n">Simple</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Net::</span><span class="n">MySQL</span><span class="p">;</span>
<span class="c1">#定期执行这个</span>
<span class="c1">#system(&quot;nmap -n -p 22,5666 10.168.168.0/23 10.168.170.0/24 -oX output.xml&quot;);</span>
<span class="k">my</span> <span class="nv">$text</span> <span class="o">=</span> <span class="n">XMLin</span><span class="p">(</span><span class="s">&quot;output.xml&quot;</span><span class="p">);</span>
<span class="c1">#读取html模版</span>
<span class="k">my</span> <span class="nv">$temp</span> <span class="o">=</span> <span class="nn">HTML::</span><span class="n">Template</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="n">filename</span> <span class="o">=&gt;</span> <span class="s">&#39;../template/html/server.tmpl&#39;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$localhost</span> <span class="o">=</span> <span class="s">&#39;127.0.0.1&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@array</span> <span class="o">=</span> <span class="p">();</span>
<span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$hash</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">while</span> <span class="p">(</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
<span class="c1">#因为新增了ssh端口扫描，所以xml解析和前例稍有不同</span>
    <span class="k">my</span> <span class="nv">$ssh_state</span> <span class="o">=</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ports</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">port</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$nrpe_state</span> <span class="o">=</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ports</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">port</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="nb">ref</span><span class="p">(</span><span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">})</span> <span class="ow">eq</span> <span class="s">&#39;ARRAY&#39;</span> <span class="p">?</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">addr</span><span class="p">}</span> <span class="p">:</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">addr</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$mac</span> <span class="o">=</span> <span class="nb">ref</span><span class="p">(</span><span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">})</span> <span class="ow">eq</span> <span class="s">&#39;ARRAY&#39;</span> <span class="p">?</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">addr</span><span class="p">}</span> <span class="p">:</span> <span class="s">&#39;00:1E:C9:E6:E1:7C&#39;</span><span class="p">;</span>
    <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$channel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">mysql_query</span><span class="p">(</span><span class="nv">$mac</span><span class="p">);</span>
<span class="c1">#将ip按照频道排成列表，每个ip存有ssh和nrpe状态</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nb">exists</span> <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$channel</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$channel</span><span class="p">}},</span> <span class="p">{</span> <span class="s">&#39;IP&#39;</span> <span class="o">=&gt;</span> <span class="nv">$ip</span><span class="p">,</span> <span class="s">&#39;SSH&#39;</span> <span class="o">=&gt;</span> <span class="nv">$ssh_state</span><span class="p">,</span> <span class="s">&#39;NRPE&#39;</span> <span class="o">=&gt;</span> <span class="nv">$nrpe_state</span><span class="p">,</span> <span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$channel</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;IP&#39;</span> <span class="o">=&gt;</span> <span class="nv">$ip</span><span class="p">,</span> <span class="s">&#39;SSH&#39;</span> <span class="o">=&gt;</span> <span class="nv">$ssh_state</span><span class="p">,</span> <span class="s">&#39;NRPE&#39;</span> <span class="o">=&gt;</span> <span class="nv">$nrpe_state</span><span class="p">,</span> <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">#将上面while生成的hash转成HTML::Template认可的array，不过array的单个元素可以是hash</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$key</span><span class="p">(</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$hash</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$onechannel</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nv">$onechannel</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;CHANNEL&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$key</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$ip</span><span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$key</span><span class="p">}}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$onechannel</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;IP_LOOP&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$ip</span><span class="p">;</span>
        <span class="nv">$j</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">push</span> <span class="nv">@array</span><span class="p">,</span> <span class="nv">$onechannel</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">#将array传递给之前定义的html模版</span>
<span class="c1">#注意：不管是param还是@array里，所有的key必须都在tmpl里使用，冗余也会报错</span>
<span class="nv">$temp</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="n">CHANNEL_LOOP</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@array</span><span class="p">);</span>
<span class="c1">#输出成html格式</span>
<span class="k">print</span> <span class="s">&quot;Content-Type: text/html\n\n&quot;</span><span class="p">,</span> <span class="nv">$temp</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">;</span>
<span class="c1">#这段没什么说的，根据mac获取频道</span>
<span class="k">sub </span><span class="nf">mysql_query</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$mac</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$mysql</span> <span class="o">=</span> <span class="nn">Net::</span><span class="n">MySQL</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">hostname</span> <span class="o">=&gt;</span> <span class="nv">$localhost</span><span class="p">,</span>
                                 <span class="n">database</span> <span class="o">=&gt;</span> <span class="s">&#39;myops&#39;</span><span class="p">,</span>
                                 <span class="n">user</span>     <span class="o">=&gt;</span> <span class="s">&#39;myops&#39;</span><span class="p">,</span>
                                 <span class="n">password</span> <span class="o">=&gt;</span> <span class="s">&#39;myops&#39;</span><span class="p">,</span>
                               <span class="p">);</span>
    <span class="nv">$mysql</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">(</span><span class="s">&quot;select channel from myhost where mac=&#39;$mac&#39;&quot;</span><span class="p">);</span>
    <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">alert</span><span class="p">(</span><span class="s">&quot;New server&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="nv">$mysql</span><span class="o">-&gt;</span><span class="n">has_selected_record</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$a_record_iterator</span> <span class="o">=</span> <span class="nv">$mysql</span><span class="o">-&gt;</span><span class="n">create_record_iterator</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$record</span> <span class="o">=</span> <span class="nv">$a_record_iterator</span><span class="o">-&gt;</span><span class="nb">each</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$record</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">};</span>
<span class="p">}</span>
<span class="c1">#留着后续继续处理</span>
<span class="k">sub </span><span class="nf">alert</span> <span class="p">{</span>
    <span class="k">print</span> <span class="nv">@_</span><span class="p">,</span><span class="s">&quot;\n&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>然后是template文件server.tmpl：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Server Plate<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;table</span> <span class="na">width=</span><span class="s">&quot;100%&quot;</span> <span class="na">cellspacing=</span><span class="s">&quot;0&quot;</span> <span class="na">cellpadding=</span><span class="s">&quot;0&quot;</span> <span class="na">border=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
<span class="c">&lt;!--TMPL_LOOP循环格式，使用的是array里channel_loop的每个元素--&gt;</span>
<span class="nt">&lt;TMPL</span><span class="na">_LOOP</span> <span class="na">NAME=</span><span class="s">&quot;CHANNEL_LOOP&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="c">&lt;!--根据本层loop中的某个元素的channel的value开始表格的一行--&gt;</span>
<span class="nt">&lt;th&gt;&lt;center&gt;&lt;TMPL</span><span class="na">_VAR</span> <span class="na">NAME=</span><span class="s">&quot;CHANNEL&quot;</span><span class="nt">&gt;&lt;/center&gt;&lt;/th&gt;</span>
<span class="c">&lt;!--本层loop中另一个元素ip_loop，也是array格式，所以继续循环，每个元素使用一列--&gt;</span>
<span class="nt">&lt;TMPL</span><span class="na">_LOOP</span> <span class="na">NAME=</span><span class="s">&quot;IP_LOOP&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">top</span><span class="nt">&gt;&lt;center&gt;</span>
//根据本层loop的ssh情况选择显示哪个图标；TMPL_IF只能判断key的真假，所以用js
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&lt;TMPL_VAR NAME=&quot;SSH&quot;&gt;&#39;</span> <span class="o">==</span> <span class="s1">&#39;open&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;&lt;img src=&#39;../template/images/unlock_server.png&#39;&gt;&quot;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;&lt;img src=&#39;../template/images/desable_server.png&#39;&gt;&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
<span class="c">&lt;!--显示第二层loop里元素的几个value--&gt;</span>
<span class="nt">&lt;hr&gt;</span>nrpe:<span class="nt">&lt;TMPL</span><span class="na">_VAR</span> <span class="na">NAME=</span><span class="s">&quot;NRPE&quot;</span><span class="nt">&gt;&lt;hr&gt;</span>ssh :<span class="nt">&lt;TMPL</span><span class="na">_VAR</span> <span class="na">NAME=</span><span class="s">&quot;SSH&quot;</span><span class="nt">&gt;&lt;hr&gt;&lt;TMPL</span><span class="na">_VAR</span> <span class="na">NAME=</span><span class="s">&quot;IP&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/center&gt;&lt;/td&gt;</span>
<span class="c">&lt;!--结束里层loop，即完成一行表格--&gt;</span>
<span class="err">&lt;</span>/TMPL_LOOP&gt;
<span class="nt">&lt;/tr&gt;</span>
<span class="c">&lt;!--结束顶层loop，即完成表格--&gt;</span>
<span class="err">&lt;</span>/TMPL_LOOP&gt;
<span class="nt">&lt;/table&gt;&lt;/center&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;center&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>用apache分别发布cgi目录和静态目录。然后访问一下；OK。</p>
      <a href="/2011/06/01/intro-html-template" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/05/30/intro-perl_set-image_filter" title="nginx两个小测试(perl_set/image_filter)" rel="bookmark">nginx两个小测试(perl_set/image_filter)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-05-30 00:00:00 +0800">30 May 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>第一个测试，关于http_perl_module。之前写过一篇关于nginx忽略大小写的博文，今天被朋友问上门来，url是类似/Upload/Dir/2011/123_D.jpg的形式。如果单纯的lc($r-&gt;uri)，得到的url会变成/upload/dir/2011/123_d.jpg，目录是不存在的。所以要稍微改进一下。如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">perl_set</span> <span class="nv">$url</span> <span class="s">&#39;</span>
<span class="s">        sub {</span>
<span class="s">            my $r = shift;</span>
<span class="s">            return $1.lc($2) if ($r-&gt;uri =~ m/^(.+\/)([^\/]+)$/);</span>
<span class="s">            return $r-&gt;uri;</span>
<span class="s">        }</span>
<span class="s">    &#39;</span><span class="p">;</span>
</code></pre></div>
<p>这样就行了。</p>
<p>另一个测试，关于http_image_filter_module。配置语句很简单，就一行image_filter [size|resize|corp] wight height;就行了——如果图片太大，那还要加大image_filter_buffer，默认1M，大于这个大小的图片就不会缩略了。
比如配置如下：</p>
<div class="highlight"><pre><code class="nginx">        <span class="k">location</span> <span class="s">/</span> <span class="p">{</span>
            <span class="kn">root</span>   <span class="s">/var/www/html</span><span class="p">;</span>
            <span class="kn">index</span>  <span class="s">index.html</span> <span class="s">index.htm</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">location</span> <span class="p">~</span><span class="sr">*</span> <span class="s">^/small/w_(\d+)/h_(\d+)/(.*)</span>$ <span class="p">{</span>
            <span class="kn">rewrite</span> <span class="s">/small/w_(\d+)/h_(\d+)/(.*)</span>$ <span class="s">/</span><span class="nv">$3</span> <span class="s">break</span><span class="p">;</span>
            <span class="kn">image_filter</span> <span class="s">resize</span> <span class="nv">$1</span> <span class="nv">$2</span><span class="p">;</span>
            <span class="kn">root</span>   <span class="s">/var/www/html</span><span class="p">;</span>
            <span class="kn">index</span>  <span class="s">index.html</span> <span class="s">index.htm</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div>
<p>这样通过/small/w<em>100/h</em>50/path/to/text.jpg，就能访问到/path/to/text.jpg的100*50大小的缩略图了。
如果只需要修改h或者w，其他的等比缩略，把另一项写成&rsquo;-&lsquo;即可。
其他参数介绍：test，返回是否真的是图片；corp，截取图片的一部分；size，以json格式返回图片的长宽数据。</p>
      <a href="/2011/05/30/intro-perl_set-image_filter" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/05/27/analyze-the-xml-which-nmap-output" title="nmap扫描结果xml解析脚本" rel="bookmark">nmap扫描结果xml解析脚本</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-05-27 00:00:00 +0800">27 May 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">XML::</span><span class="n">Simple</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Net::</span><span class="n">MySQL</span><span class="p">;</span>
<span class="nb">system</span><span class="p">(</span><span class="s">&quot;nmap -n -p 5666 10.1.1.0/23 10.1.3.0/24 -oX output.xml&quot;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$text</span> <span class="o">=</span> <span class="n">XMLin</span><span class="p">(</span><span class="s">&quot;output.xml&quot;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$nrpe</span> <span class="o">=</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ports</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">port</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">};</span>
<span class="c1">#因为在扫描到本机的时候，是没有mac的，所以到本机时不是ARRAY而是HASH</span>
    <span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="nb">ref</span><span class="p">(</span><span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">})</span> <span class="ow">eq</span> <span class="s">&#39;ARRAY&#39;</span> <span class="p">?</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">addr</span><span class="p">}</span> <span class="p">:</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">addr</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$mac</span> <span class="o">=</span> <span class="nb">ref</span><span class="p">(</span><span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">})</span> <span class="ow">eq</span> <span class="s">&#39;ARRAY&#39;</span> <span class="p">?</span> <span class="nv">$text</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">host</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">address</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">addr</span><span class="p">}</span> <span class="p">:</span> <span class="s">&#39;00:1E:C9:E6:E1:7C&#39;</span><span class="p">;</span>
    <span class="o">&amp;</span><span class="n">mysql_query</span><span class="p">(</span><span class="nv">$ip</span><span class="p">,</span> <span class="nv">$mac</span><span class="p">,</span> <span class="nv">$nrpe</span><span class="p">);</span>
    <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">mysql_query</span> <span class="p">{</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$ip</span><span class="p">,</span> <span class="nv">$mac</span><span class="p">,</span> <span class="nv">$nrpe</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$mysql</span> <span class="o">=</span> <span class="nn">Net::</span><span class="n">MySQL</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">hostname</span> <span class="o">=&gt;</span> <span class="s">&#39;10.1.1.25&#39;</span><span class="p">,</span>
                             <span class="n">database</span> <span class="o">=&gt;</span> <span class="s">&#39;myops&#39;</span><span class="p">,</span>
                             <span class="n">user</span>     <span class="o">=&gt;</span> <span class="s">&#39;myops&#39;</span><span class="p">,</span>
                             <span class="n">password</span> <span class="o">=&gt;</span> <span class="s">&#39;myops&#39;</span><span class="p">,</span>
                           <span class="p">);</span>
<span class="nv">$mysql</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">(</span>
<span class="s">&quot;insert into myhost (intranet, mac, monitorstatus) values (&#39;$ip&#39;, &#39;$mac&#39;, &#39;$nrpe&#39;)&quot;</span>
<span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>小脚本一个，扫描内网网段内存活的机器，获取其MAC地址，以及nrpe端口情况。后期再配合myhost里的system，如果是linux（其实用nmap -O也可以获取system，但是结果不准，耗时还特别长，200台机器花10分钟），但monitorstatus还是closed的，就expect上去安装nrpe，嗯~~</p>
      <a href="/2011/05/27/analyze-the-xml-which-nmap-output" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/05/20/merge-iplist-of-qqwry" title="续上：合并纯真ip段" rel="bookmark">续上：合并纯真ip段</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-05-20 00:00:00 +0800">20 May 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上篇提到纯真ip库有很多行是浪费的，比如下面这种：
&lt;div class="highlight"&gt;&lt;pre&gt;<code class="yaml"><span class="l-Scalar-Plain">223.214.0.0     223.215.255.255 安徽省 电信</span>
<span class="l-Scalar-Plain">223.216.0.0     223.219.255.255 日本</span>
<span class="l-Scalar-Plain">223.220.0.0     223.220.162.1   青海省 电信</span>
<span class="l-Scalar-Plain">223.220.162.2   223.220.162.2   青海省海东地区 平安县九歌网吧</span>
<span class="l-Scalar-Plain">223.220.162.3   223.221.255.255 青海省 电信</span>
</code>&lt;/pre&gt;&lt;/div&gt;</p>
<p>很简单的223.220.0.0-223.221.255.255段，却被拆成了三行。于是在通过起始ip结束ip计算子网之前，还需要合并一下这些ip段。
因为涉及ip比对，所以第一反应想到了mysql里有的inet_aton函数，去CPAN上搜了一下，发现有NetAddr::IP::Util模块有inet_aton函数，结果一用，发现居然生成的不是数字……于是从网上找到了pack的办法，如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">while</span><span class="p">(</span><span class="o">&lt;&gt;</span><span class="p">){</span>
    <span class="k">next</span> <span class="k">unless</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(\S+)\s+(\S+)\s+(\S+)/</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$low</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s">&#39;N&#39;</span><span class="p">,(</span><span class="nb">pack</span><span class="p">(</span><span class="s">&#39;C4&#39;</span><span class="p">,(</span><span class="nb">split</span><span class="p">(</span><span class="sr"> /\./</span><span class="p">,</span><span class="nv">$1</span><span class="p">)))));</span>
<span class="c1">#下面这行是IP::QQWry模块里的写法</span>
<span class="c1">#    print $1 * 256**3 + $2 * 256**2 + $3 * 256 + $4 if $1 =~ /(\d+)\.(\d+)\.(\d+)\.(\d+)/;;</span>
    <span class="k">my</span> <span class="nv">$high</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s">&#39;N&#39;</span><span class="p">,(</span><span class="nb">pack</span><span class="p">(</span><span class="s">&#39;C4&#39;</span><span class="p">,(</span><span class="nb">split</span><span class="p">(</span><span class="sr"> /\./</span><span class="p">,</span><span class="nv">$2</span><span class="p">)))));</span>
    <span class="k">next</span> <span class="k">if</span> <span class="nv">$low</span> <span class="o">==</span> <span class="nv">$high</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$addr</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
    <span class="k">unless</span> <span class="p">(</span> <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">high</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">low</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$low</span><span class="p">;</span>
        <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">high</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$high</span><span class="p">;</span>
        <span class="k">next</span><span class="p">;</span>
    <span class="p">};</span>
<span class="c1">#如果中间就隔几个ip的，可以无视之，合并就是了……</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$low</span> <span class="o">-</span> <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">high</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">high</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$high</span><span class="p">;</span>
        <span class="k">next</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nb">unshift</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">low</span><span class="p">}},</span> <span class="nv">$low</span><span class="p">;</span>
    <span class="nb">unshift</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">high</span><span class="p">}},</span> <span class="nv">$high</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">foreach</span> <span class="nv">$addr</span> <span class="p">(</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$hash</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span> <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">low</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">print</span> <span class="nv">$addr</span> <span class="o">.</span> <span class="s">&quot;\t&quot;</span> <span class="o">.</span> <span class="o">&amp;</span><span class="n">nota</span><span class="p">(</span><span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">low</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">.</span> <span class="s">&quot;\t&quot;</span> <span class="o">.</span> <span class="o">&amp;</span><span class="n">nota</span><span class="p">(</span><span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$addr</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">high</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="p">,</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
        <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">nota</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$aton</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="nv">@a</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s">&#39;C4&#39;</span><span class="p">,(</span><span class="nb">pack</span><span class="p">(</span><span class="s">&#39;N&#39;</span><span class="p">,</span><span class="nv">$aton</span><span class="p">)));</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">join</span> <span class="s">&quot;\.&quot;</span><span class="p">,</span><span class="nv">@a</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>pack真复杂，基本看不懂perldoc，唉……</p>
<p>最后汇报一下运行结果：
合并前一共428452行，合并后103008行。</p>
      <a href="/2011/05/20/merge-iplist-of-qqwry" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/05/19/get-iplist-from-qqwry" title="从纯真数据库里获取ip列表" rel="bookmark">从纯真数据库里获取ip列表</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-05-19 00:00:00 +0800">19 May 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>首先申明只是一个简单的方式，因为打算的是提取总列表成bind9使用的acl格式，所以不在乎性能问题。
第一步、从CZ88.NET下载QQWry数据库，然后运行IP.exe，选择“解压”，然后会在桌面生成一个qqwry.txt，这里就有四十多万行的ip记录。格式如下：
起始ip    结束ip   大区域     小区域
但是这个大区域也不是想像中的那么整齐，比如清华大学宿舍楼也是大区域的……
好在我们DNS只需要一个大概的南北指向，根据电信占主流的现实，只要取出来联通的，其他都算电信就行了~
第二步、把起始ip-结束ip改成acl需要的子网掩码格式，这一步用perl完成，全文如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">Net::IPAddress::Util::</span><span class="n">Range</span><span class="p">;</span>
<span class="k">while</span><span class="p">(</span><span class="o">&lt;&gt;</span><span class="p">){</span>
    <span class="k">next</span> <span class="k">unless</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(\S+)\s+(\S+)\s+(.+)/</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$range</span> <span class="o">=</span> <span class="nn">Net::IPAddress::Util::</span><span class="n">Range</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">({</span> <span class="n">lower</span> <span class="o">=&gt;</span> <span class="nv">$1</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=&gt;</span> <span class="nv">$2</span> <span class="p">});</span>
    <span class="nb">map</span> <span class="p">{</span><span class="nb">printf</span> <span class="s">&quot;%s\t%s\n&quot;</span><span class="p">,</span> <span class="nv">$_</span><span class="p">,</span> <span class="nv">$3</span> <span class="p">}</span> <span class="nv">$range</span><span class="o">-&gt;</span><span class="n">tight</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">as_cidrs</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>其中tight()-&gt;as_cidrs()其实是Net::IPAddress::Util::Collection的函数（Range.pm里use了这个函数）。tight将不规律的ip段划分成规律的子网，cidrs将类似(1.1.1.0 .. .1.1.1.255)改成1.1.1.0/24。
如果直接采用Net::IPAddress::Util::Range的$range-&gt;as_cidr()的话，它会把一个不规律的ip段取一个最近的规律子网来显示……比方1.59.0.0-1.60.149.255会被计算成1.57.0.0/13！！
不过这个还有一个问题，就是没有多行合并，导致条目太多~~这个之后再看吧~</p>
      <a href="/2011/05/19/get-iplist-from-qqwry" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page5">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page active">
      <a href="#">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li>
      <a href="/page7">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.icylife.net/blog/" title="">心路</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://dbahacker.com/" title="TB 杨德华">DBA Hacker</a></li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.laird-sa.com/" title="">Laird-SA</a></li>
              <li><a href="http://www.linuxsee.com/" title="">LinuxSEE</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://www.puppeter.cn/" title="">piol</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.sanote.org/" title="">sa note</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://blog.ops.tudou.com/wp/" title="">土豆运营团队</a></li>
              <li><a href="http://www.91tuanfang.com/" title="安居客运维">家欣的天空</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://www.opboy.com" title="">运维小子</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://l09.me/" title="风声">风声</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://mooser.me/" title="牛氓">牛氓</a></li>
              <li><a href="http://http://www.yinwang.org/" title="当然我在扯淡">当然我在扯淡</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://muxueqz.laou.me" title="muxueqz">聊逍遥兮容与</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://paperplane.ruhoh.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://blog.sectop.org/" title=""></a></li>
              <li><a href="http://www.reddit.com/r/perl/" title=""></a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天"></a></li>
          </ul>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
