<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/10/20/screenshot-4-cloudhosting-down" title="博客恢复了，截图纪念一下" rel="bookmark">博客恢复了，截图纪念一下</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-10-20 00:00:00 +0800">20 Oct 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>这两天折腾博客宕机问题啊~原本对阿里云的看好大幅下降……几次挂掉，甚至电话告知说数据恢复不了请自行重置……崩溃原因居然解释说“因为你没有修改grub再重启”这种解释，拜托，我要重启还不是因为突然ssh报密码错误而你们“重置密码必须重启”？死循环啊！
对了，我人格保证，作为一个用xen当工作环境一年多的运维，绝对没有犯自行升级内核导致重启失败这种错误的可能。阿里云客服能不能不要把一个客户的缘由安到别的客户头上……
不管如何，结局还是好的。截个监控宝的告警图纪念一下：
<img src="/images/uploads/20111020192305.png" alt="" title="aliyunOS" width="856" height="332" class="alignnone size-full wp-image-2647" /></p>
      <a href="/2011/10/20/screenshot-4-cloudhosting-down" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/10/17/notes-about-probind" title="ProBIND体验笔记" rel="bookmark">ProBIND体验笔记</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-10-17 00:00:00 +0800">17 Oct 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dns-ref" title="dns" rel="category tag">dns</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>闲的无聊，继续研究DNS周边产品，这次盯上了Probind。这是搜索结果中比较常见的bind的web管理工具。其实我是比较希望有个中文的东东方便我偷懒，可惜看sina之前的xbayDNS一直停留在了只支持FreeBSD/MAC的阶段没有更新，汗，不支持linux的项目偶见过的还真不多……
probind最近一次更新也是2003/05/24的事情了。所以也没期待它能多么适应现在的bind体系，不过作为代码看看还是可以的。
创建mysql用户和库，然后把程序解压到webroot目录，然后执行mysql -u named -p named &lt; etc/mktables.sql，这就是install的步骤。但是这个时候访问首页是有一堆报错的，提示你dns服务器的默认配置（外部检测用dns，管理员邮箱等等）没配置。这个需要通过./tools/settings.php去添加——但是首页上没有链接点击，得自己手敲url，汗……
然后，probind更新的时候，估计php还是以version4为主，所以里头用的还是$HTTP_GET_VARS和$HTTP_POST_VARS等全局变量。奇怪的是我把php.ini里的register_global改成On后重启httpd了，页面依然没变，不得已在./inc/lib.inc文件的开头加上了两句</p>
<div class="highlight"><pre><code class="php"><span class="x">$HTTP_GET_VARS = &amp;$_GET;</span>
<span class="x">$HTTP_POST_VARS = &amp;$_POST;</span>
</code></pre></div>
<p>才好。
OK，现在正式看到probind的页面了。demo地址：<a href="http://chenlinux.com/probind/">点这里</a>
主要就是一个zone的管理，有add、delete、browse三个页面，前两个就是标准的表单，倒是browse里有个test，蛮好玩的，调用bin/testns脚本，使用perl的Net::DNS模块测试zone内的正/反向解析是否正常。
然后就是record的管理，在browse zones里点进zone就可以编辑record了，主要就是主机名、解析ip。
最后是server的管理，这里管理的是真实的DNS的ip和type(master|slave)——probind在易用和性能之间取了一个平衡，他不是像mysqlbind或者mysql-dlz那样直接从db里取数据做响应，而是每次更新(这里区分开了步骤，update的时候只是更新了db，然后再去bulk update的时候才是真正update dns配置)的时候，从数据库生成文件(bin/mkzonefile)，再同步到DNS服务器上(sbin/push.local|remote)并执行rndc reconfig命令。</p>
<hr />
<p>每次添加一个server的时候，都会在probind/HOSTS/目录下生成一个同名目录，里面存有从template复制出来的named.tmpl模板，reconfig.sh脚本，rndc.conf和root.hint。
由上可见：
第一，其实probind的管理方式，很像一个简单的集中式配置管理系统；
第二，probind虽然号称支持bind9，但是缺失了现在来看最关键的acl+view体系。不过想到第一点，其实加一个view配置也不是很复杂。大概列一下：
新建views表，包括id、area、iplist和zonefile字段；
修改records表，把关联zones.id的zone改成view关联views.id；
修改inc/lib.inc文件，把add_domain()里的$zonefile命名从$domain.dns改成$domain+$views.id的格式。
修改brzones.php页面，改成先browse views，然后在view里面再选zones；
和template的小小变动。这个可能就多了……</p>
      <a href="/2011/10/17/notes-about-probind" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/09/30/dynamic-dns-demo" title="一个ddns的demo" rel="bookmark">一个ddns的demo</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-30 00:00:00 +0800">30 Sep 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上回分析lbnamed的时候，开玩笑说自己也可以试试在模块基础上加点啥功能。国庆节前最后一天，没啥事情做，就写个小demo续貂。代码如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">autodie</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Sys::</span><span class="n">Hostname</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">YAML::</span><span class="n">Syck</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Net::IP::Match::</span><span class="n">Regexp</span> <span class="sx">qw( create_iprange_regexp match_ip )</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Stanford::</span><span class="n">DNS</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Stanford::</span><span class="n">DNSserver</span><span class="p">;</span>
<span class="nv">$SIG</span><span class="p">{</span><span class="s">&#39;HUP&#39;</span><span class="p">}</span> <span class="o">=</span> <span class="s">&#39;catch_hup&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$need_reload</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$hostmaster</span> <span class="o">=</span> <span class="s">&#39;domain.chenlinux.com&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$soa</span>        <span class="o">=</span> <span class="n">rr_SOA</span><span class="p">(</span><span class="n">hostname</span><span class="p">(),</span> <span class="nv">$hostmaster</span><span class="p">,</span> <span class="nb">time</span><span class="p">(),</span> <span class="mi">3600</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="mi">86400</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$ns</span>         <span class="o">=</span> <span class="nn">Stanford::</span><span class="n">DNSserver</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">listen_on</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="n">hostname</span><span class="p">()</span> <span class="p">],</span>
<span class="c1">#                                           debug     =&gt; 1,</span>
                                           <span class="n">loopfunc</span>  <span class="o">=&gt;</span> <span class="o">\&amp;</span><span class="n">conf_reload</span><span class="p">,</span>
<span class="c1">#                                           daemon    =&gt; &#39;no&#39;,</span>
                                         <span class="p">);</span>
<span class="k">my</span> <span class="nv">$regexp</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@domains</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$arealist</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$templist</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$config_path</span> <span class="o">=</span> <span class="s">&#39;/data/chenlinux.com/perl/&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$ns_domain</span> <span class="o">=</span> <span class="s">&#39;test.domain.chenlinux.com&#39;</span><span class="p">;</span>
<span class="nv">$ns</span><span class="o">-&gt;</span><span class="n">add_dynamic</span><span class="p">(</span><span class="s">&quot;$domain&quot;</span> <span class="o">=&gt;</span> <span class="o">\&amp;</span><span class="n">dyn_lb</span> <span class="p">)</span> <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$domain</span> <span class="p">(</span> <span class="nv">@domains</span> <span class="p">);</span>
<span class="nv">$ns</span><span class="o">-&gt;</span><span class="n">add_static</span><span class="p">(</span> <span class="s">&quot;$ns_domain&quot;</span><span class="p">,</span> <span class="n">T_SOA</span><span class="p">,</span> <span class="nv">$soa</span><span class="p">);</span>
<span class="nv">$ns</span><span class="o">-&gt;</span><span class="n">add_static</span><span class="p">(</span> <span class="s">&quot;$ns_domain&quot;</span><span class="p">,</span> <span class="n">T_NS</span><span class="p">,</span> <span class="n">rr_NS</span><span class="p">(</span><span class="nv">$hostmaster</span><span class="p">));</span>
<span class="nv">$ns</span><span class="o">-&gt;</span><span class="n">answer_queries</span><span class="p">();</span>
<span class="k">sub </span><span class="nf">catch_hup</span> <span class="p">{</span>
    <span class="nv">$need_reload</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">conf_reload</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="nv">$need_reload</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">load_config</span><span class="p">();</span>
        <span class="nv">$need_reload</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">load_config</span> <span class="p">{</span>
    <span class="nv">$regexp</span> <span class="o">=</span> <span class="n">ip2area</span><span class="p">(</span><span class="s">&quot;ip.list&quot;</span><span class="p">);</span>
    <span class="nv">@domains</span> <span class="o">=</span> <span class="nb">grep</span> <span class="p">{</span><span class="sr">s/${config_path}config-(.+?)\.yml/$1/</span><span class="p">}</span> <span class="nb">glob</span><span class="p">(</span><span class="s">&quot;${config_path}*&quot;</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$domain</span> <span class="p">(</span> <span class="nv">@domains</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nv">$arealist</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$domain&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="n">LoadFile</span><span class="p">(</span><span class="s">&quot;${config_path}config-${domain}.yml&quot;</span><span class="p">);</span>
      <span class="nv">@</span><span class="p">{</span><span class="nv">$templist</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$domain&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$_&quot;</span><span class="p">}}</span> <span class="o">=</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$arealist</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$domain&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$_&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;per&#39;</span><span class="p">}}</span> <span class="k">foreach</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$arealist</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$domain&quot;</span><span class="p">}};</span>
  <span class="p">};</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">dyn_lb</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$domain</span><span class="p">,</span><span class="nv">$residual</span><span class="p">,</span><span class="nv">$qtype</span><span class="p">,</span><span class="nv">$qclass</span><span class="p">,</span><span class="nv">$dm</span><span class="p">,</span><span class="nv">$from</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$ttl</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="n">area2resolv</span><span class="p">(</span><span class="nv">$domain</span><span class="p">,</span> <span class="nv">$from</span><span class="p">);</span>
    <span class="nv">$dm</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;answer&#39;</span><span class="p">}</span> <span class="o">.=</span> <span class="n">dns_answer</span><span class="p">(</span><span class="n">QPTR</span><span class="p">,</span> <span class="n">T_A</span><span class="p">,</span> <span class="n">C_IN</span><span class="p">,</span> <span class="nv">$ttl</span><span class="p">,</span> <span class="n">rr_A</span><span class="p">(</span><span class="nv">$ip</span><span class="p">));</span>
    <span class="nv">$dm</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;ancount&#39;</span><span class="p">}</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">ip2area</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$area</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">my</span> <span class="nv">$last_area</span><span class="p">;</span>
    <span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="nv">$file</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="sr">&lt;$fh&gt;</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="sr"> /^acl (\w+)/</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$last_area</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr"> /^((\d{1,3}\.?){4});/</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$area</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$1&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$last_area</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">next</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="k">my</span> <span class="nv">$regexp</span> <span class="o">=</span> <span class="n">create_iprange_regexp</span><span class="p">(</span><span class="nv">$area</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$regexp</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">area2resolv</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$from</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$area</span> <span class="o">=</span> <span class="n">match_ip</span><span class="p">(</span> <span class="s">&quot;$from&quot;</span><span class="p">,</span> <span class="nv">$regexp</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$ip</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$len</span> <span class="o">=</span> <span class="nv">$#</span><span class="p">{</span><span class="nv">$arealist</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$domain&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$area&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;per&#39;</span><span class="p">}};</span>
    <span class="k">for</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">..</span> <span class="nv">$len</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$arealist</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$domain&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$area&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;per&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$ip</span> <span class="o">=</span> <span class="nv">$arealist</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$domain&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$area&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;ip&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$_</span><span class="p">];</span>
            <span class="nv">$arealist</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$domain&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$area&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;per&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
            <span class="k">last</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$_</span> <span class="o">==</span> <span class="nv">$len</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">@</span><span class="p">{</span><span class="nv">$arealist</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$domain&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$area&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;per&#39;</span><span class="p">}}</span> <span class="o">=</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$templist</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$domain&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$area&quot;</span><span class="p">}};</span>
            <span class="k">redo</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="n">ip_conv</span><span class="p">(</span><span class="s">&quot;$ip&quot;</span><span class="p">);</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">ip_conv</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nv">$1</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="nv">$2</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="nv">$3</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="nv">$4</span> <span class="k">if</span> <span class="nv">$ip</span> <span class="o">=~</span> <span class="sr">m/(\d+)\.(\d+)\.(\d+)\.(\d+)/</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>其中调用的ip.list是bind9用的acl格式，即：</p>
<div class="highlight"><pre><code class="bash">acl cnc_beijing <span class="o">{</span>
202.106.0.0/24;
...
<span class="o">}</span>
...
</code></pre></div>
<p>这种格式。
调用的config-www.domain.com.yml是YAML格式定义的地区指向ip，即：</p>
<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">ctc_hebei</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">ip</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">10.168.168.1</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">10.168.169.2</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">10.168.170.3</span>
    <span class="l-Scalar-Plain">per</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">50</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">30</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">20</span>
</code></pre></div>
<p>超级简单(其实是我没想到好的weight实现方式)的算法，就是找到这个ctc_hebei的时候，依次序返回ip，同时每返回一次对应的per就减1，减到0就换下一个ip，都0了就复原从头开始。</p>
<p>严重缺失的地方：<del datetime="2011-10-13T05:40:51+00:00">读取不同域名配置；</del>对server的监控；<del datetime="2011-10-13T05:40:51+00:00">对config.yml的reload</del>。</p>
      <a href="/2011/09/30/dynamic-dns-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/09/29/dancing-website-for-sync-dist-3" title="写个同步分发系统(三)" rel="bookmark">写个同步分发系统(三)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-29 00:00:00 +0800">29 Sep 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上篇写的页面上，留下一个超链接，查看每条任务的具体情况。现在完成这部分。
首先修改数据库结构，上篇已经建了websync.websync_peer表，现在继续：</p>
<div class="highlight"><pre><code class="mysql"><span class="k">create</span> <span class="k">table</span> <span class="nf">websync_customer</span> <span class="p">(</span>
    <span class="n">uid</span> <span class="kt">int</span> <span class="k">not</span> <span class="no">null</span> <span class="kp">auto_increment</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">user</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">not</span> <span class="no">null</span><span class="p">,</span>
    <span class="n">passwd</span> <span class="kt">char</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">not</span> <span class="no">null</span><span class="p">,</span>
    <span class="n">custom_info</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
    <span class="n">node</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">not</span> <span class="no">null</span>
<span class="p">)</span> <span class="kp">engine</span><span class="o">=</span><span class="n">innodb</span><span class="p">;</span>
<span class="k">create</span> <span class="k">table</span> <span class="nf">remote_node</span> <span class="p">(</span>
    <span class="n">nid</span> <span class="kt">int</span> <span class="k">not</span> <span class="no">null</span> <span class="kp">auto_increment</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">node_name</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">not</span> <span class="no">null</span><span class="p">,</span>
    <span class="n">node_ip</span> <span class="kt">int</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">not</span> <span class="no">null</span>
<span class="p">)</span> <span class="kp">engine</span><span class="o">=</span><span class="n">innodb</span><span class="p">;</span>
<span class="k">create</span> <span class="k">table</span> <span class="nf">task_msg</span> <span class="p">(</span>
    <span class="n">id</span> <span class="kt">int</span> <span class="k">not</span> <span class="no">null</span> <span class="kp">auto_increment</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">task_id</span> <span class="kt">int</span> <span class="k">not</span> <span class="no">null</span><span class="p">,</span>
    <span class="n">node_id</span> <span class="kt">int</span> <span class="k">not</span> <span class="no">null</span><span class="p">,</span>
    <span class="n">node_md5</span> <span class="kt">char</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">default</span> <span class="no">null</span><span class="p">,</span>
    <span class="k">key</span> <span class="p">(</span><span class="n">task_id</span><span class="p">),</span>
    <span class="k">key</span> <span class="p">(</span><span class="n">node_id</span><span class="p">),</span>
    <span class="k">constraint</span> <span class="n">task_f</span> <span class="k">foreign</span> <span class="k">key</span> <span class="n">task_id</span> <span class="k">references</span> <span class="nf">websync_peer</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">on</span> <span class="k">delete</span> <span class="k">cascade</span> <span class="k">on</span> <span class="k">update</span> <span class="k">cascade</span><span class="p">,</span>
    <span class="k">constraint</span> <span class="n">node_f</span> <span class="k">foreign</span> <span class="k">key</span> <span class="n">node_id</span> <span class="k">references</span> <span class="nf">remote_node</span> <span class="p">(</span><span class="n">nid</span><span class="p">)</span> <span class="k">on</span> <span class="k">delete</span> <span class="k">cascade</span> <span class="k">on</span> <span class="k">update</span> <span class="k">cascade</span><span class="p">,</span>
<span class="p">)</span> <span class="kp">engine</span><span class="o">=</span><span class="n">innodb</span><span class="p">;</span>
</code></pre></div>
<p>主要内容，一是每个用户使用多少节点；二是各节点下载完url后反馈的md5值。
然后新增dancer动作如下:</p>
<div class="highlight"><pre><code class="perl"><span class="n">get</span> <span class="s">&#39;/checkstatus&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$task_id</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;login&#39;</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">@status</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$task_sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&#39;select md5_hex from websync_customer where id = ?&#39;</span><span class="p">);</span>
    <span class="nv">$task_sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span> <span class="nv">$task_id</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$peer_md5</span> <span class="o">=</span> <span class="nv">$task_sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;md5_hex&#39;</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$node_sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&#39;select node from websync_customer where user = ?&#39;</span><span class="p">);</span>
    <span class="nv">$node_sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span> <span class="nv">$user</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$nodes</span> <span class="o">=</span> <span class="nv">$node_sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;node&#39;</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$check_sql</span> <span class="o">=</span> <span class="s">&#39;selct remote_node.node_name node, task_msg.node_md5 md5 from task_msg join remote_node on (task_msg.node_id = remote_node.nid) where task_msg.task_id = ? and task_msg.node_id in ( ? )&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$check_sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span> <span class="nv">$check_sql</span> <span class="p">);</span>
    <span class="nv">$check_sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span> <span class="nv">$task_id</span><span class="p">,</span> <span class="nv">$nodes</span> <span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span> <span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$check_sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$node_name</span> <span class="o">=</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;node&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$node_result</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nb">defined</span> <span class="nv">$peer_md5</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$node_result</span> <span class="o">=</span> <span class="s">&#39;Peer synchronizing&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="o">!</span> <span class="nb">defined</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;md5&#39;</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$node_result</span> <span class="o">=</span> <span class="s">&#39;Remote distributing&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;md5&#39;</span><span class="p">}</span> <span class="o">==</span> <span class="nv">$peer_md5</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$node_result</span> <span class="o">=</span> <span class="s">&#39;Distribute Over&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$node_result</span> <span class="o">=</span> <span class="s">&#39;Distribute Not Match&#39;</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="nb">push</span> <span class="nv">@status</span><span class="p">,</span> <span class="p">{</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">$node_name</span><span class="p">,</span> <span class="n">result</span> <span class="o">=&gt;</span> <span class="nv">$node_result</span><span class="p">,</span> <span class="p">};</span>
    <span class="p">};</span>
    <span class="n">template</span> <span class="s">&#39;checkstatus&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#39;status&#39;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@status</span><span class="p">,</span> <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>对应的TT模板如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;&lt;table&gt;</span>
<span class="nt">&lt;tr&gt;&lt;th&gt;</span>TASK<span class="nt">&lt;/th&gt;&lt;td&gt;</span><span class="err">&lt;</span>% task %&gt;<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;tr&gt;&lt;th&gt;</span>NODE<span class="nt">&lt;/th&gt;&lt;th&gt;</span>STATUS<span class="nt">&lt;/th&gt;&lt;/tr&gt;</span>
<span class="err">&lt;</span>% FOREACH node IN status %&gt;
<span class="nt">&lt;tr&gt;&lt;td&gt;</span><span class="err">&lt;</span>% node.name %&gt;<span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>% node.result %&gt;<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="err">&lt;</span>% END %&gt;
<span class="nt">&lt;/table&gt;&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>然后需要给admin加一个管理页面，勾选恰当的节点分配给客户。动作配置如下：</p>
<div class="highlight"><pre><code class="perl"><span class="n">any</span> <span class="p">[</span><span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="s">&#39;post&#39;</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="s">&#39;/nodeadd&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">()</span> <span class="ow">eq</span> <span class="s">&#39;GET&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$node_sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&#39;select node_name,nid from remote_node order by nid&#39;</span><span class="p">);</span>
        <span class="nv">$node_sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">();</span>
        <span class="k">my</span> <span class="nv">@nodes</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span> <span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$node_sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span> <span class="p">){</span>
            <span class="nb">push</span> <span class="nv">@nodes</span><span class="p">,</span> <span class="p">{</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;node_name&#39;</span><span class="p">},</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;nid&#39;</span><span class="p">},</span> <span class="p">};</span>
        <span class="p">};</span>
        <span class="k">my</span> <span class="nv">$user_sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&#39;select user from websync_customer&#39;</span><span class="p">);</span>
        <span class="nv">$user_sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">();</span>
        <span class="k">my</span> <span class="nv">@users</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$user_sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nb">push</span> <span class="nv">@users</span><span class="p">,</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;user&#39;</span><span class="p">};</span>
        <span class="p">};</span>
        <span class="n">template</span> <span class="s">&#39;nodeadd&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#39;users&#39;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@users</span><span class="p">,</span>
                              <span class="s">&#39;nodes&#39;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@nodes</span><span class="p">,</span>
                            <span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;user&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$nodes</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;nodes&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$add_sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&#39;update remote_node set nodes = ? where user = ?&#39;</span><span class="p">);</span>
        <span class="nv">$add_sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span> <span class="nv">$nodes</span><span class="p">,</span> <span class="nv">$user</span> <span class="p">);</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>对应的TT模板如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
function post_node() {
    var nodes = &#39;&#39;;
    var user = &#39;&#39;;
    $(&quot;form &gt; [type=checkbox]&quot;).each(function(){
        if($(this)[0].checked) {
            nodes += $(this).val()+&#39;,&#39;;
        }
    });
    $(&quot;select &gt; option&quot;).each(function(){
        if($(this).attr(&#39;selected&#39;)==true) {
            user = $(this).val();
        }
    });
    $.post(&#39;/nodeadd?nodes=&#39;+nodes+&#39;<span class="ni">&amp;user=&#39;+user);</span>
}
<span class="nt">&lt;/head&gt;&lt;body&gt;</span>
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;post_node()&quot;</span><span class="nt">&gt;</span>
<span class="err">&lt;</span>% FOREACH node IN nodes %&gt;
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">name=</span><span class="s">&quot;node&quot;</span> <span class="na">value=</span><span class="s">&quot;&lt;% node.id %&gt;&quot;</span> <span class="nt">/&gt;</span><span class="err">&lt;</span>% node.name %&gt;
<span class="err">&lt;</span>% END %&gt;
<span class="nt">&lt;HR</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;select</span> <span class="na">name=</span><span class="s">&quot;customer&quot;</span><span class="nt">&gt;</span>
<span class="err">&lt;</span>% FOREACH user IN users %&gt;
<span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;&lt;% user %&gt;&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>% user %&gt;<span class="nt">&lt;/option&gt;</span>
<span class="err">&lt;</span>% END %&gt;
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>从度娘那抄了个jquery例子来用……</p>
      <a href="/2011/09/29/dancing-website-for-sync-dist-3" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/09/26/dancing-website-for-sync-dist-2" title="写个同步分发系统(二)" rel="bookmark">写个同步分发系统(二)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-26 00:00:00 +0800">26 Sep 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>接上篇，加上分发过程查看的页面。这应该是一个很典型的翻页处理。
首先创建一个数据库表如下：</p>
<div class="highlight"><pre><code class="mysql"><span class="k">create</span> <span class="k">table</span> <span class="nf">websync_peer</span> <span class="p">(</span>
    <span class="n">id</span> <span class="kt">int</span> <span class="k">not</span> <span class="no">null</span> <span class="kp">auto_increment</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">begin_time</span> <span class="kt">timestamp</span> <span class="k">not</span> <span class="no">null</span> <span class="k">default</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">end_time</span> <span class="kt">timestamp</span> <span class="k">on</span> <span class="k">update</span> <span class="k">current_timestamp</span><span class="p">,</span>
    <span class="n">url</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">not</span> <span class="no">null</span><span class="p">,</span>
    <span class="n">customer</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">not</span> <span class="no">null</span><span class="p">,</span>
    <span class="n">md5_hex</span> <span class="kt">char</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">default</span> <span class="no">null</span>
<span class="p">)</span> <span class="kp">engine</span><span class="o">=</span><span class="n">innodb</span><span class="p">;</span>
</code></pre></div>
<p>然后把之前的peer_query()函数修改如下：</p>
<div class="highlight"><pre><code class="perl"><span class="k">sub </span><span class="nf">peer_query</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$url</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="c1">#这里的database和session都需要其他plugin的配合，见之前博客，不贴重复代码了</span>
    <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&#39;insert into websync_peer (begin_time, url, customer) value (now(), ?, ?)&#39;</span><span class="p">);</span>
    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">login</span><span class="p">});</span>
<span class="p">};</span>
</code></pre></div>
<p>然后把gearman::client的功能改到mysql的UDFs内完成，做法见<a href="http://www.php-oa.com/2010/09/20/perl-gearman-server-mysql-udfs.html" title="http://www.php-oa.com/2010/09/20/perl-gearman-server-mysql-udfs.html"></a>。
然后写翻页函数了~</p>
<div class="highlight"><pre><code class="perl"><span class="n">get</span> <span class="s">&#39;/check&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$from</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">page</span><span class="p">}</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">login</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">@urls</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$count_sql</span> <span class="o">=</span> <span class="s">&#39;select count(id) count from websync_peer where customer = ?&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$count_sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
    <span class="nv">$count_sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span> <span class="nv">$user</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$count</span> <span class="o">=</span> <span class="nv">$count_sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$total_pages</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="nv">$count</span> <span class="o">/</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">);</span>
    <span class="k">return</span> <span class="s">&#39;No url has been posted to purge.&#39;</span> <span class="k">unless</span> <span class="nv">$count</span><span class="p">;</span>
    <span class="k">return</span> <span class="s">&#39;Selected page number out of range.&#39;</span> <span class="k">if</span> <span class="nv">$from</span> <span class="o">&gt;</span> <span class="nv">$total_pages</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$url_sql</span> <span class="o">=</span> <span class="s">&#39;select id,url,begin_time from websync_peer where customer = ? order by id desc limit ?, 20&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$url_sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
    <span class="nv">$url_sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span> <span class="nv">$user</span><span class="p">,</span> <span class="p">(</span><span class="nv">$from</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">20</span> <span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span> <span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nb">push</span> <span class="nv">@urls</span><span class="p">,</span> <span class="nv">$ref</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">template</span> <span class="s">&#39;check&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#39;urls&#39;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@urls</span><span class="p">,</span> 
                        <span class="s">&#39;prev&#39;</span> <span class="o">=&gt;</span> <span class="nv">$from</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">?</span> <span class="nv">$from</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s">&#39;next&#39;</span> <span class="o">=&gt;</span> <span class="nv">$from</span> <span class="o">&lt;</span> <span class="nv">$total_pages</span> <span class="p">?</span> <span class="nv">$from</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="nv">$total_pages</span><span class="p">,</span> 
                        <span class="s">&#39;last&#39;</span> <span class="o">=&gt;</span> <span class="nv">$total_pages</span><span class="p">,</span> 
                      <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>对应的check.tt如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;&lt;head&gt;</span>
<span class="nt">&lt;style </span><span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
<span class="nf">#main</span> <span class="p">{</span><span class="k">text-align</span><span class="o">:</span><span class="k">center</span><span class="p">;</span><span class="k">width</span><span class="o">:</span><span class="m">500px</span><span class="p">;</span><span class="k">margin-right</span><span class="o">:</span><span class="k">auto</span><span class="p">;</span><span class="k">margin-left</span><span class="o">:</span><span class="k">auto</span><span class="p">;</span><span class="k">padding</span><span class="o">:</span><span class="m">0px</span><span class="p">;}</span>
<span class="nf">#url</span> <span class="p">{</span><span class="k">width</span><span class="o">:</span><span class="m">776px</span><span class="p">;</span><span class="k">border</span><span class="o">:</span><span class="m">1px</span><span class="p">;}</span>
<span class="nf">#page_link</span> <span class="nt">ul</span> <span class="p">{</span><span class="k">list-style</span><span class="o">:</span><span class="k">none</span><span class="p">;}</span>
<span class="nf">#page_link</span> <span class="nt">li</span> <span class="p">{</span><span class="k">float</span><span class="o">:</span><span class="k">left</span><span class="p">;</span><span class="k">width</span><span class="o">:</span><span class="m">100px</span><span class="p">;</span><span class="k">margin-left</span><span class="o">:</span><span class="m">3px</span><span class="p">;</span><span class="k">line-height</span><span class="o">:</span><span class="m">30px</span><span class="p">;}</span>
<span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;&lt;body&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;url&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
<span class="nt">&lt;tr&gt;&lt;th&gt;</span>ID<span class="nt">&lt;/th&gt;&lt;th&gt;</span>URL<span class="nt">&lt;/th&gt;&lt;th&gt;</span>TIME<span class="nt">&lt;/th&gt;&lt;th&gt;</span>MORE<span class="nt">&lt;/th&gt;&lt;/tr&gt;</span>
<span class="err">&lt;</span>% FOREACH ref IN urls %&gt;
<span class="nt">&lt;tr&gt;</span>
<span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>% ref.id %&gt;<span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>% ref.begin_time %&gt;<span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>% ref.url %&gt;<span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;td&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/checkstatus?id=&lt;% ref.id %&gt;&quot;</span><span class="nt">&gt;</span>more<span class="nt">&lt;/a&gt;&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
<span class="err">&lt;</span>% END %&gt;
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;page_link&quot;</span><span class="nt">&gt;&lt;ul&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/check?page=1&quot;</span><span class="nt">&gt;</span>1<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/check?page=&lt;% prev %&gt;&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>% prev %&gt;<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/check?page=&lt;% next %&gt;&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>% next %&gt;<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/check?page=&lt;% last %&gt;&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>% last %&gt;<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;/ul&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;&lt;/html&gt;</span>
</code></pre></div>
<p>额，傻乎乎的css，好难看，好难写啊……
下一步继续修改mysql表结构，然后完成页面里提供的/checkstatus功能。</p>
      <a href="/2011/09/26/dancing-website-for-sync-dist-2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/09/20/get-ip-address-by-perl-on-linux" title="linux上获取本机ip的各种perl写法" rel="bookmark">linux上获取本机ip的各种perl写法</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-20 00:00:00 +0800">20 Sep 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>大家讨论使用 Gearman 做分布式处理时，各机需要注册一个独立的 job 作为信息反馈，但是为了方便，<code>Gearman::Worker</code> 脚本 <code>register_function</code> 代码又要通用，于是想到了使用各自的 ip 地址作为 job 命名~</p>
<p>那么怎么在 worker 脚本里获取本机 ip 作为 func 呢？</p>
<ul>
  <li>第一种办法，最简单的，调用 shell：</li>
</ul>
<div class="highlight"><pre><code class="perl">    <span class="nv">$ip</span> <span class="o">=</span> <span class="sb">`ifconfig eth0|grep -oE &#39;([0-9]{1,3}\.?){4}&#39;|head -n 1`</span><span class="p">;</span>
</code></pre></div>
<p>注：这里输入是固定的，所以简单的 <code>[0-9]{1,3}</code> 了，如果是在 web 程序等地方验证 ip，需要更严谨！</p>
<p>或者</p>
<div class="highlight"><pre><code class="perl">    <span class="nv">$ip</span> <span class="o">=</span> <span class="sb">`ifconfig eth0|awk -F: &#39;/inet addr/{split($2,a,&quot; &quot;);print a[1];exit}&#39;`</span><span class="p">;</span>
</code></pre></div>
<p>好吧，这样显得太不 perl 了，而且频繁的调用外部 shell 不太好</p>
<ul>
  <li>第二种：</li>
</ul>
<div class="highlight"><pre><code class="perl">    <span class="nb">open</span> <span class="n">FH</span><span class="p">,</span><span class="s">&quot;ifconfig eth0|&quot;</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="sr">&lt;FH&gt;</span><span class="p">){</span>
        <span class="k">last</span> <span class="k">unless</span> <span class="sr">/inet addr:((\d{1,3}\.?){4})/</span><span class="p">;</span>
        <span class="k">print</span> <span class="nv">$1</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>看起来稍微 perl 了一些，虽然实质跟上面的调用 shell 和 grep 法是一样的。</p>
<ul>
  <li>第三种，更 perl 一点，纯粹读文件：</li>
</ul>
<div class="highlight"><pre><code class="perl">    <span class="nb">open</span> <span class="n">FH</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&#39;/etc/sysconfig/network-scripts/ifcfg-eth0&#39;</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="sr">&lt;FH&gt;</span><span class="p">){</span>
        <span class="k">next</span> <span class="k">unless</span> <span class="sr">/IPADDR\s*=\s*(\S+)/</span><span class="p">;</span>
    <span class="k">print</span> <span class="nv">$1</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>进一步的，如果不一定 rh 系，还要去读 <code>/etc/issue</code> ，确定网络配置文件到底是 <code>/etc/sysconfig/network-script/ifcfg-eth0</code> 还是 <code>/etc/network/interfaces</code> 还是其他，然后根据不同发行版写不同的处理方法……额，这是打算自己写模块么？</p>
<p>好吧，大家来充分体会 <code>CPAN</code> 的魅力，去 search 一下，找到一把 <code>Sys::HostIP</code>、<code>Sys::HostAddr</code>、<code>Net::Inetface</code> 等模块。</p>
<ul>
  <li>第四种：</li>
</ul>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="nn">Sys::</span><span class="n">HostAddr</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$interface</span> <span class="o">=</span> <span class="nn">Sys::</span><span class="n">HostAddr</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="n">ipv</span> <span class="o">=&gt;</span> <span class="s">&#39;4&#39;</span><span class="p">,</span> <span class="n">interface</span> <span class="o">=&gt;</span> <span class="s">&#39;eth0&#39;</span><span class="p">);</span>
    <span class="k">print</span> <span class="nv">$interface</span><span class="o">-&gt;</span><span class="n">main_ip</span><span class="p">;</span>
</code></pre></div>
<p>不过进去看看pm文件，汗，这几个模块都是调用ifconfig命令，不过是根据发行版的不同进行封装而已。</p>
<p>还有办法么？还有，看</p>
<ul>
  <li>第五种：</li>
</ul>
<div class="highlight"><pre><code class="perl">    <span class="n">perl</span> <span class="o">-</span><span class="n">MPOSIX</span> <span class="o">-</span><span class="n">MSocket</span> <span class="o">-</span><span class="n">e</span> <span class="s">&#39;my $host = (uname)[1];print inet_ntoa(scalar gethostbyname($host))&#39;</span><span class="p">;</span>
</code></pre></div>
<p>不过有童鞋说了，这个可能因为hostname的原因，导致获取的都是127.0.0.1……</p>
<p>那么最后还有一招。通过 <code>strace ifconfig</code> 命令可以看到，linux 实质是通过 ioctl 命令完成的网络接口 ip 获取。那么，我们也用 <code>ioctl</code> 就是了！</p>
<ul>
  <li>第六种如下：</li>
</ul>
<div class="highlight"><pre><code class="perl">    <span class="c1">#!/usr/bin/perl</span>
    <span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Socket</span><span class="p">;</span>
    <span class="nb">require</span> <span class="s">&#39;sys/ioctl.ph&#39;</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">get_ip_address</span><span class="p">($)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$pack</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s">&quot;a*&quot;</span><span class="p">,</span> <span class="nb">shift</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$socket</span><span class="p">;</span>
        <span class="nb">socket</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nb">ioctl</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="n">SIOCGIFADDR</span><span class="p">(),</span> <span class="nv">$pack</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$pack</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">4</span><span class="p">));</span>
    <span class="p">};</span>
    <span class="k">print</span> <span class="n">get_ip_address</span><span class="p">(</span><span class="s">&quot;eth0&quot;</span><span class="p">);</span>
</code></pre></div>
<p>这样的好处，就是只调用了核心模块，在分发脚本时，不用连带安装其他模块。</p>
<p><em>注</em>：这个其实是根据网上有的一个 py 的脚本修改的</p>
<ul>
  <li>py版如下：</li>
</ul>
<div class="highlight"><pre><code class="python">    <span class="c">#!/usr/bin/python</span>
    <span class="kn">import</span> <span class="nn">socket</span>
    <span class="kn">import</span> <span class="nn">fcntl</span>
    <span class="kn">import</span> <span class="nn">struct</span>
    <span class="k">def</span> <span class="nf">get_ip_address</span><span class="p">(</span><span class="n">ifname</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">fcntl</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span>
                <span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span>
                <span class="mh">0x8915</span><span class="p">,</span>  <span class="c"># SIOCGIFADDR</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;256s&#39;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">[:</span><span class="mi">15</span><span class="p">])</span>
        <span class="p">)[</span><span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">])</span>
    <span class="k">print</span> <span class="n">get_ip_address</span><span class="p">(</span><span class="s">&#39;eth0&#39;</span><span class="p">)</span>
</code></pre></div>
<p><em>2012年12月19日增</em>：</p>
<p>为logstash的input/file.rb找到</p>
<ul>
  <li>ruby版本的：</li>
</ul>
<div class="highlight"><pre><code class="ruby">    <span class="c1">#!/usr/bin/ruby</span>
    <span class="nb">require</span> <span class="s1">&#39;socket&#39;</span>  
    <span class="no">SIOCGIFADDR</span>    <span class="o">=</span> <span class="mh">0x8915</span>          <span class="c1"># get PA address            </span>
    <span class="k">def</span> <span class="nf">get_ip_address</span><span class="p">(</span><span class="n">iface</span><span class="p">)</span>  
      <span class="k">begin</span>  
        <span class="n">sock</span> <span class="o">=</span> <span class="no">UDPSocket</span><span class="o">.</span><span class="n">new</span>  
        <span class="n">buf</span> <span class="o">=</span> <span class="o">[</span><span class="n">iface</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="o">].</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;a16h16&#39;</span><span class="p">)</span>  
        <span class="n">sock</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="no">SIOCGIFADDR</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>  
        <span class="n">sock</span><span class="o">.</span><span class="n">close</span>  
        <span class="n">buf</span><span class="o">[</span><span class="mi">20</span><span class="o">.</span><span class="n">.</span><span class="mi">24</span><span class="o">].</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;CCCC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>  
      <span class="k">rescue</span>  
        <span class="kp">nil</span>  
      <span class="k">end</span>  
    <span class="k">end</span>  
    <span class="k">if</span> <span class="vg">$0</span> <span class="o">==</span> <span class="bp">__FILE__</span>  
      <span class="nb">puts</span> <span class="n">get_ip_address</span><span class="p">(</span><span class="s1">&#39;eth0&#39;</span><span class="p">)</span>  
    <span class="k">end</span>  
</code></pre></div>
<p>不过看puppet里还是用ifconfig的方法。</p>
      <a href="/2011/09/20/get-ip-address-by-perl-on-linux" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/09/16/dancing-website-for-sync-dist-1" title="写个同步分发系统(一)" rel="bookmark">写个同步分发系统(一)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-16 00:00:00 +0800">16 Sep 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>写程序这个事情，其实规划最麻烦。比方我其实并没留意过一个完整的同步分发系统都有哪些功能。权做练手，想到哪些写哪些好了。
最基础的部分:一个提交文件列表的页面，自动分析文件列表然后从源下载文件，中心下载完成后通知边缘节点开始；
其次：文件完整性的校验，同步和分发的进度报表页面，失败报表的重试选择和报警；
再次：系统分用户，不同用户可选节点指定分发，只查看当前用户的报表。
以上。
今天先完成最基础的部分。还是用dancer -a websync创建应用。然后创建views/websync.tt如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;/head&gt;&lt;body&gt;</span>
<span class="nt">&lt;form</span> <span class="na">name=</span><span class="s">&#39;urllist&#39;</span> <span class="na">action=</span><span class="s">&#39;/websync&#39;</span> <span class="na">method=</span><span class="s">&#39;post&#39;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table</span> <span class="na">border=</span><span class="s">&#39;1&#39;</span> <span class="na">align=</span><span class="s">&#39;center&#39;</span><span class="nt">&gt;</span>
<span class="nt">&lt;tr&gt;&lt;td&gt;</span><span class="err">&lt;</span>% message %&gt;<span class="err">&lt;</span>% FOREACH url IN errurls %&gt;<span class="err">&lt;</span>% url %&gt;<span class="nt">&lt;br&gt;</span><span class="err">&lt;</span>% END %&gt;<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;tr&gt;&lt;td&gt;&lt;textarea</span> <span class="na">name=</span><span class="s">&#39;urllist&#39;</span> <span class="na">cols=</span><span class="s">&#39;64&#39;</span> <span class="na">rows=</span><span class="s">&#39;10&#39;</span><span class="nt">&gt;&lt;/textarea&gt;&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;tr&gt;&lt;td</span> <span class="na">align=</span><span class="s">&quot;center&quot;</span><span class="nt">&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;reset&quot;</span> <span class="na">name=</span><span class="s">&quot;cancel&quot;</span> <span class="na">value=</span><span class="s">&quot;cancel&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;&lt;/html&gt;</span>
</code></pre></div>
<p>一如既往的难看……考虑是不是学下用dreamweaver画个稍微好看点的页面出来做layout啊……
然后是lib/websync.pm，如下：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="n">websync</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Gearman::</span><span class="n">Client</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$VERSION</span> <span class="o">=</span> <span class="s">&#39;0.1&#39;</span><span class="p">;</span>
<span class="c1">#Don&#39;t change index because there are so many otherthings to do! </span>
<span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">template</span> <span class="s">&#39;index&#39;</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">any</span> <span class="p">[</span><span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="s">&#39;post&#39;</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="s">&#39;/websync&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">@errurls</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$message</span> <span class="o">=</span> <span class="s">&#39;Write urllist under here.&lt;br&gt;Attention: The url format must like &quot;http://img.domain.com/path/to/example.flv&quot;&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">()</span> <span class="ow">eq</span> <span class="s">&#39;POST&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$url_pattern</span> <span class="o">=</span> <span class="sx">qr(^http://[^/]+?\.\w+/)</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">@urllists</span> <span class="o">=</span> <span class="nb">split</span> <span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">urllist</span><span class="p">};</span>
        <span class="k">foreach</span> <span class="p">(</span> <span class="nv">@urllists</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nb">push</span> <span class="nv">@errurls</span><span class="p">,</span> <span class="nv">$_</span> <span class="ow">and</span> <span class="k">next</span> <span class="k">unless</span> <span class="sr">m/$url_pattern/</span><span class="p">;</span>
            <span class="n">peer_query</span><span class="p">(</span><span class="nv">$_</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nv">$message</span> <span class="o">=</span> <span class="s">&#39;Sync begin, waiting please.&lt;br&gt;And there are some error urls. Please check them:&lt;br&gt;&#39;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">template</span> <span class="s">&#39;websync&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="nv">$message</span><span class="p">,</span> 
                          <span class="s">&#39;errurls&#39;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@errurls</span><span class="p">,</span> 
                        <span class="p">};</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">peer_query</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$url</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@job_servers</span> <span class="o">=</span> <span class="sx">qw(127.0.0.1:7003 192.168.0.2:7004)</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$client</span> <span class="o">=</span> <span class="nn">Gearman::</span><span class="n">Client</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
    <span class="nv">$client</span><span class="o">-&gt;</span><span class="n">job_servers</span><span class="p">(</span><span class="nv">@job_servers</span><span class="p">);</span>
    <span class="nv">$client</span><span class="o">-&gt;</span><span class="n">dispatch_background</span><span class="p">(</span><span class="s">&#39;websync&#39;</span><span class="p">,</span> <span class="nv">$url</span><span class="p">);</span>
<span class="p">};</span>
<span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>嗯，这里试着用了gearman而不是fork，一个是考虑到可能web系统跟中心存储不在一起；另一个是考虑之后需要用mysql存储分发状态，可以把gearman::client改成mysql的trigger形式。
然后是worker.pl，运行在中心存储上，接受job，完成下载，然后通知其他节点继续：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="nn">Gearman::</span><span class="n">Worker</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">LWP::</span><span class="n">Simple</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Net::SSH::</span><span class="n">Perl</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="s">&#39;:WNOHANG&#39;</span><span class="p">;</span>
<span class="nv">$SIG</span><span class="p">{</span><span class="n">CHLD</span><span class="p">}</span> <span class="o">=</span> <span class="k">sub </span><span class="p">{</span><span class="nb">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">WNOHANG</span><span class="p">)};</span>
<span class="k">my</span> <span class="nv">@job_servers</span> <span class="o">=</span> <span class="sx">qw(127.0.0.1:7003 192.168.0.2)</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$worker</span> <span class="o">=</span> <span class="nn">Gearman::</span><span class="n">Worker</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
<span class="nv">$worker</span><span class="o">-&gt;</span><span class="n">job_servers</span><span class="p">(</span><span class="nv">@job_servers</span><span class="p">);</span>
<span class="nv">$worker</span><span class="o">-&gt;</span><span class="n">register_function</span><span class="p">(</span> <span class="n">websync</span> <span class="o">=&gt;</span> <span class="o">\&amp;</span><span class="n">websync</span> <span class="p">);</span>
<span class="nv">$worker</span><span class="o">-&gt;</span><span class="n">work</span> <span class="k">while</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">websync</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$job</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@path</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$job</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$filepath</span> <span class="o">=</span> <span class="s">&#39;/var/www/&#39;</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span> <span class="mi">2</span> <span class="o">..</span> <span class="nv">$#path</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$filepath</span> <span class="o">.=</span> <span class="nv">$path</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span><span class="o">.</span><span class="s">&#39;/&#39;</span><span class="p">;</span>
        <span class="nb">mkdir</span> <span class="nv">$filepath</span> <span class="k">unless</span> <span class="o">-</span><span class="n">d</span> <span class="nv">$filepath</span><span class="p">;</span> 
    <span class="p">};</span>
    <span class="n">sync_get</span><span class="p">(</span><span class="nv">$job</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span> <span class="nv">$filepath</span> <span class="o">.</span> <span class="nv">$path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">sync_get</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$url</span><span class="p">,</span> <span class="nv">$file</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$http_code</span> <span class="o">=</span> <span class="n">getstore</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$file</span><span class="p">);</span>
    <span class="n">dist</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="k">if</span> <span class="nv">$http_code</span> <span class="o">=~</span> <span class="sr">m/^2/</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">#I will rewrite this function to use gearman too~</span>
<span class="k">sub </span><span class="nf">dist</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@remote</span> <span class="o">=</span> <span class="sx">qw(1.1.1.1 2.2.2.2)</span><span class="p">;</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">@remote</span><span class="p">){</span>
      <span class="k">unless</span><span class="p">(</span><span class="nb">fork</span><span class="p">){</span>
        <span class="k">my</span> <span class="nv">$ssh</span> <span class="o">=</span> <span class="nn">Net::SSH::</span><span class="n">Perl</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$_</span><span class="p">);</span>
        <span class="nv">$ssh</span><span class="o">-&gt;</span><span class="n">login</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">passwd</span><span class="p">);</span>
        <span class="nv">$ssh</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="s">&quot;rsync 192.168.0.2:$file $file&quot;</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>不过想到，其实可以在remote上设定每15分钟一次rsync。这样节省掉中心的dist功能，改成remote上的rsync后，主动通过mysql汇报更新的list和md5。
明天开始改这种方式。</p>
<hr />
<p>晚饭回来，增加dancer在nginx上的部署方式。之前写过apache上用mod_perl的方式，这回因为正好电脑上有nginx，就改用nginx反代了：
首先安装一个perl的server，命令如下：</p>
<div class="highlight"><pre><code class="bash"><span class="c"># cpanm Plack Starman</span>
</code></pre></div>
<p>Starman是一个提供prefork方式运行的HTTP服务器。另外还有基于AnyEvent的Twiggy和基于Coro的Corona，不够因为我是在本机的colinux上做实验，装的是UBUNTU9.04系统，已经没有apt源装openssl了，所以Net::SSLeay模块无法安装，AnyEvent类型的也就不能用了。
启动命令如下：</p>
<div class="highlight"><pre><code class="bash">sudo -u www-data plackup -E production -s Starman --workers<span class="o">=</span>2 -l /tmp/plack.sock -a /var/www/websync/bin/app.pl &amp;
</code></pre></div>
<p>该命令指定了运行用户，运行server核心，读取的配置文件，启动的worker进程，提供的socket接口。
然后就可以利用nginx的upstream功能，pass到这个socket接口上了。nginx.conf相关部分如下：</p>
<div class="highlight"><pre><code class="nginx">    <span class="k">upstream</span> <span class="s">backendurl</span> <span class="p">{</span>
        <span class="kn">server</span> <span class="s">unix:/tmp/plack.sock</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">server</span> <span class="p">{</span>
      <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
      <span class="kn">server_name</span>  <span class="s">dancer.test.com</span><span class="p">;</span>
      <span class="kn">access_log</span> <span class="s">logs/dancer_access.log</span><span class="p">;</span>
      <span class="kn">error_log</span>  <span class="s">logs/dancer_err.log</span> <span class="s">info</span><span class="p">;</span>
      <span class="kn">root</span> <span class="s">/var/www/websync/public</span><span class="p">;</span>
      <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="s">@proxy</span><span class="p">;</span>
        <span class="kn">access_log</span> <span class="no">off</span><span class="p">;</span>
        <span class="kn">expires</span> <span class="s">max</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kn">location</span> <span class="s">@proxy</span> <span class="p">{</span>
            <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
            <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Host</span> <span class="nv">$host</span><span class="p">;</span>
            <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
            <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
            <span class="kn">proxy_pass</span>       <span class="s">http://backendurl</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
      <a href="/2011/09/16/dancing-website-for-sync-dist-1" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/09/08/lbnamed-code-reading" title="lbnamed代码浅读" rel="bookmark">lbnamed代码浅读</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-08 00:00:00 +0800">08 Sep 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>群里听说lbnamed这么个东东，用perl实现的动态DNS服务器。程序包括三个perl模块：Stanford::DNSserver模块、Stanford::DNS模块、LBCD模块；三个perl程序：lbnamed主程序、poller探测程序、slbcd监控程序（这个有C语言的版本）。</p>
<ul>
  <li>先看主程序lbnamed。</li>
</ul>
<p>排除掉sig啊，help啊，pid啊，log啊之类的以后，剩下的主要内容包括：</p>
<ol>
  <li>一个Stanford::DNSserver-&gt;new()对象，分别用add_static和add_dynamic方法加入的DNS记录，然后用answer_queries方法启动运行。</li>
  <li>一个handle_lb_request()函数，用在add_dynamic中完成动态DNS解析响应。</li>
  <li>一个load_config()函数，用于从文件中读取domain/ip/weight的值并存入hash。</li>
  <li>一个by_weight()函数，用于排序。</li>
</ol>
<ul>
  <li>接下来主要是去看Stanford::DNSserver里的add_*和answer_queries函数。</li>
</ul>
<p>这个模块里，$self除了new()传递的参数以外，还有几个很重要的空间，分别是$self-&gt;{select}、$self-&gt;{static}-&gt;{$domain}-&gt;{$type}-&gt;{answer}、$self-&gt;{static}-&gt;{$domain}-&gt;{$type}-&gt;{ancount}和$self-&gt;{dynamic}-&gt;{$domain}。
1. add_static()很简单，把传入的配置按照格式组装给Stanford::DNS::dns_answer()，返回值存入$self-&gt;{static}-&gt;{$domain}-&gt;{$type}-&gt;{answer}，同时$self-&gt;{static}-&gt;{$domain}-&gt;{$type}-&gt;{ancount}加1。</p>
<pre><code>
*** 2011-10-09注: 代码是.=，即返回值是接入，static方法可以返回多条记录，而dynamic方法只会返回最后加载的一条。
</code></pre>
<ol>
  <li>add_dynamic()更简单，直接把lbnamed里的handle_lb_request()的引用存入$self-&gt;{dynamic}-&gt;{$domain}就完了。</li>
  <li>answer_queries()方法启动服务器，步骤如下：</li>
</ol>
<p>$self-&gt;daemon()，其实就是改变STD后的fork。<br />
 $self-&gt;init()，首先用IO::Socket::INET模块，new出两个socket，分别监听在TCP/UDP的DNS端口上；然后调用$self-&gt;{select}，这在new的时候已经创建了一个IO::Select对象。把之前的两个socket加入到select队列中。<br />
 在一个while(1){}死循环中，调用select的can_read()方法，具体是$self-&gt;{select}-&gt;can_read(600)，根据IO::Select的说明，这个600表示如果一直没有可以READ的SOCKET，等待600秒后返回一个空队列，也就是说轮训的时候，每个socket会阻塞600秒~<br />
 如果can_read成立，根据其协议是UDP还是TCP，调用$self-&gt;handle_udp_req或者$self-&gt;handle_tcp_req处理这个socket。</p>
<ul>
  <li>然后看$self-&gt;handle_udp_req()方法。</li>
</ul>
<ol>
  <li>用perl内嵌的recv方法，从socket中读取8192字节到$buff，至于这里为什么是8192字节，没有找到比较合理的解释。因为DNS协议的UDP传输一般只有512字节，而UDP协议的不可靠性，也很难保证8192字节的数据完整。唯一在一篇博客上看到说因为NFS的读写数据大小是这个。反正不管怎么样，8192肯定是足够的；</li>
  <li>把$buff传递给$self-&gt;do_dns_request()函数，返回值赋为$reply。</li>
  <li>用send方法，把$reply发回给socket。</li>
</ol>
<ul>
  <li>再来看$self-&gt;handle_tcp_req()方法。</li>
</ul>
<ol>
  <li>用IO::Socket::INET::accept()方法创建一个返回到对端的socket对象；</li>
  <li>关闭原来的socket，释放IO::Select；</li>
  <li>使用perl内嵌的sysread方法，从socket中读入2个字节到$buff，然后用unpack(&lsquo;n&rsquo;,$buff)的方式解压得到数据长度；</li>
  <li>根据计算的长度，继续读入相应长度的数据，并传递给$self-&gt;do_dns_request()函数，返回值赋为$reply；</li>
  <li>用pack(&lsquo;n&rsquo;,length $reply)打包数据长度，接在数据报文的头部，用send方法发送出去；</li>
  <li>依上面三步的操作，循环进行，直到socket内数据全部读取完成。</li>
</ol>
<ul>
  <li>然后看$self-&gt;do_dns_request()方法。</li>
</ul>
<ol>
  <li>先把buff里的前12字节取出来，然后用unpack(&lsquo;n6C*&rsquo;,$buff)解压成RFC1035标准里的包头信息，包括：</li>
</ol>
<pre><code>
    $id——用来验证请求和响应匹配的随机数, 
    $flags——包括$opcode查询类型（正向/反向）、$qr（请求/响应）、$tc（截断？）、$rd（是否递归）, 
    $qdcount——查询的问题个数, 
    $ancount——响应的结果个数, 
    $aucount——额，这个在RFC1035里都没发现, 
    $adcount——附加区域内的响应结果个数。从程序来看，aucount和adcount一直都是0。
</code></pre>
<ol>
  <li>然后用Stanford::DNS::dn_expand()解析$buff出$qname，用unpack(&lsquo;nn&rsquo;, substr($buff, $ptr, 4))解析出$qtype和$qclass，这三个变量是RFC1035.4.1.3中定义的请求区内容。</li>
  <li>最后，使用$self-&gt;check_static($qname,$qtype,$qclass,\%dnsmsg)或$self-&gt;check_dynamic($qname,$qtype,$qclass,\%dnsmsg,$from)方法，得到响应内容，然后pack(&lsquo;n6&rsquo;, $id, $flags, $qdcount, $dnsmsg{ancount}, $dnsmsg{aucount}, $dnsmsg{adcount}) . $reply组装完成返回。</li>
</ol>
<pre><code>
*** 2011-10-09注: 代码是if( * or * )，即是先检查check_static结果并返回，只有不存在static的情况下，才会check_dynamic去！
</code></pre>
<p>上面关于pack/unpack语焉不详，实在是自己也不懂……汗！</p>
<ul>
  <li>然后看check_static()函数</li>
</ul>
<p>很简单，从前面add_static存入的%{$self-&gt;{static}}里取出对应qname的value即可，同时计算一下ancount。</p>
<ul>
  <li>接着是check_dynamic()函数</li>
</ul>
<p>跟static不同的是，这里对域名进行了分割然后重拼装，在获取到最先匹配的handler后跳出循环，调用handler处理。举例说：team.www.domain.com这个域名，它先检查是不是存在$self-&gt;{dynamic}-&gt;{www.domain.com}，有就传递(&lsquo;www.domain.com&rsquo;,&rsquo;team&rsquo;,&hellip;)；否则下一步检查$self-&gt;{dynamic}-&gt;{domain.com}，有就传递(&lsquo;domain.com&rsquo;,&rsquo;team.www&rsquo;,&hellip;)；依此类推……
<br />至于Stanford::DNS模块，主要就是拼装各种数据成DNS协议规范的数据格式，在没看懂RFC1035和pack/unpack的用法前，就不写了。</p>
<ul>
  <li>回头继续看那个handler函数</li>
</ul>
<ol>
  <li>在new的时候，调用了&amp;do_reload()做loopfunc；</li>
  <li>do_reload()中调用了load_config(&ldquo;${poller_results}lb&rdquo;)读取poller的结果文本；</li>
  <li>load_config()中将groups数组作为key，存入了各项数值，weight、ttl、rnd等；</li>
  <li>unless ($group = $lb_groups{$qname})这里就是用到了上一步的key，确认域名存在；</li>
  <li>by_weight()中，用$weight{}对$host排序；</li>
  <li>选出最终答案，$rnd{$qname} ? @$group[int(rand(min($rnd{$qname},$#$group)))] : @$group[0];不过在load_config中，$rnd{$group}=0（另外一个赋值的地方是$rnd{$weight}=$host，很没道理的地方，我都怀疑是不是写反了？），所以肯定是从数组拿第一个，也就是最大的一个了。</li>
</ol>
<ul>
  <li>server部分完毕，然后看poller程序：</li>
</ul>
<ol>
  <li>大同小异的也是在while(1){&hellip;;sleep(120)}中用IO::Select和IO::Socket::INET完成对host的探测；</li>
  <li>然后dump_lb()函数里取出各host的探测结果，计算weight，写入文件。</li>
</ol>
<p>这个计算方法主要包括了服务器的登录user数量和loadavg的大小。说实话我不清楚为啥要计算user数量……具体的数据格式，可以看LBCD.pm里注释的C语言typeof struct定义，也可以看slbcd脚本里的pack。如下：</p>
<div class="highlight"><pre><code class="perl"><span class="nv">$reply</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s">&quot;nnnnNNNnnnnnCC&quot;</span><span class="p">,</span>            <span class="c1"># build the reply</span>
              <span class="nv">$version</span><span class="p">,</span> <span class="nv">$id</span><span class="p">,</span> <span class="nv">$op</span><span class="p">,</span> <span class="nv">$status</span><span class="p">,</span>
              <span class="nv">$btime</span><span class="p">,</span> <span class="nb">time</span><span class="p">(),</span> <span class="nv">$utime</span><span class="p">,</span>
              <span class="nv">$l1</span><span class="p">,</span> <span class="nv">$l5</span><span class="p">,</span> <span class="nv">$l15</span><span class="p">,</span> <span class="nv">$tot</span><span class="p">,</span> <span class="nv">$uniq</span><span class="p">,</span>
              <span class="nv">$console</span><span class="p">,</span> <span class="nv">$reserved</span><span class="p">);</span>
</code></pre></div>
<ul>
  <li>最后总结</li>
</ul>
<p>这个server利用poller调整解析的weight，但并不是我想象中的百分比解析，而是针对每次解析请求时后端服务器的准实时（120秒）负载情况给出最适合的一个。对于全网GSLB，感觉不太适用；对于内部SLB，又感觉不如LVS好用。<br />
不过作为一个DNS框架，如果抛开poller，倒也可以自己再设想一个动态dns来：</p>
<ol>
  <li>用Net::IP::Match::Regexp匹配ip列表到area区域——可以注意到，lbnamed中写的handler中没有用上传递进去的$from；</li>
  <li>然后$file是area区域到host/weight(100%)的对应，handler中取rand(100)随机数，跟设定的weight比大小，确定具体用哪个ip；</li>
  <li>最后改造poller，根据流量，响应时间等，确定一个weight阈值，超标的话就修改$file中得weight大小。</li>
</ol>
      <a href="/2011/09/08/lbnamed-code-reading" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/08/25/nginx-diff-response-via-filesize" title="用nginx区分文件大小做出不同响应" rel="bookmark">用nginx区分文件大小做出不同响应</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-25 00:00:00 +0800">25 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>昨晚和前21v的同事聊天，说到我离职后一些技术上的更新。其中有个给某大客户(游戏下载类)的特殊需求设计，因为文件大小差距很大——估计是大版本和补丁的区别——又走的是同一个域名，而squid在响应比较大的文件时，尤其是初次下载的时候，性能比较差，所以拆成两组服务器，squid服务于较小的文件，通过pull方式从peer层获取，nginx服务于较大的文件，通过push方式由peer层分发同步。外部发布域名一律解析到squid服务器组上，请求透传到peer层的nginx，nginx分析这个url的content-length，如果大于阈值，则不返回文件，而是302到nginx服务器组的独立域名下的相应url去。</p>
<p>这里要注意的是，nginx的内部变量里有一个$content-length，是不能用在这里的，官方wiki是这么解释这个变量的：&rdquo;This variable is equal to line Content-Length in the header of request&rdquo;。可见，这个变量是请求头的内容，一般见于POST请求用来限定POST信息的长度；而不是我们需要的响应头的内容。</p>
<p>老东家最后是修改了nginx的src完成的功能。不过我想，这里其实可以使用http_perl_module完成的。而且还可以扩展302跳转的功能，把独立域名改成直接通过remote_addr定向到最近IP上。</p>
<p>因为手头没有服务器，以下内容都是凭空想象，看官们注意……
首先是nginx.conf里的配置：</p>
<div class="highlight"><pre><code class="nginx"><span class="k">http</span> <span class="p">{</span>
    <span class="kn">perl_modules</span> <span class="s">perl</span><span class="p">;</span>
    <span class="kn">perl_require</span> <span class="s">SizeDiff.pm</span><span class="p">;</span>
    <span class="kn">server</span> <span class="p">{</span>
       <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
       <span class="kn">server_name</span>  <span class="s">dl.gamedomain.com</span><span class="p">;</span>
       <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
          <span class="kn">perl</span> <span class="s">SizeDiff::handler</span><span class="p">;</span>
       <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>然后是perl/SizeDiff.pm，如下：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="n">SizeDiff</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Nginx::</span><span class="n">Simple</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">main</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$webroot</span> <span class="o">=</span> <span class="s">&#39;/www/dl.gamedomain.com/&#39;</span>
    <span class="k">return</span> <span class="n">HTTP_NOT_ALLOWED</span> <span class="k">unless</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">uri</span> <span class="o">=~</span> <span class="sr">m!^(/.+/)[^/]+$!</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$webroot</span> <span class="o">.</span> <span class="nv">$1</span> <span class="o">.</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@filestat</span> <span class="o">=</span> <span class="nb">stat</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="ow">or</span> <span class="k">return</span> <span class="n">HTTP_NOT_FOUND</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$filesize</span> <span class="o">=</span> <span class="nv">$filestat</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$filesize</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">OK</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">location</span><span class="p">(</span><span class="s">&#39;http://bigfile.cdndomain.com&#39;</span><span class="o">.</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="n">uri</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="mi">1</span>
</code></pre></div>
<p>大体应该就是上面这样。
之前还考虑过如果不是push方式，可以在perl里考虑使用LWP获取header，不过仔细想想：第一，万一源站开启了chunked获取不到content-length呢？第二，就算可以，如果一个文件是1个G，那再去下载这1个G的文件下来，这个perl进程肯定挂了——官方wiki里可是连DNS解析时间都认为太长……也就是说，这个设想不适合在peer层，而是在loadbalance的角色，通过lwp的header结果，小文件upstream到后端的squid，大文件location到另外的nginx。
另一个可改进的地方，就是self-&gt;location前面，可以结合Net::IP::Match::Regexp模块或者自己完成的类似功能，来针对self-&gt;remote_addr选择最近的服务器组IP，最后返回location(&ldquo;http://$ip$uri&rdquo;)这样。</p>
      <a href="/2011/08/25/nginx-diff-response-via-filesize" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/08/18/learning-cloudfarecast-3" title="CloudForecast学习笔记(三)" rel="bookmark">CloudForecast学习笔记(三)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-18 00:00:00 +0800">18 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>第三篇，看web部分。主程序cloudforecast_web里主要就是调用CloudForecast::Web的run()函数，接下来去看CloudForecast::Web。
照例还是加载配置，然后这里主要多了两个accessor：allowfrom和front_proxy。用来定制acl和代理的。从下文可以看到，分别是采用了Plack::Middleware::Access和Plack::Middleware::ReverseProxy两个模块进行控制。
然后是主要部分，通过Plack::Builder建立$app：
1、初始化:&rdquo;my $app = $self-&gt;psgi;&rdquo;，这里是调用父层&rdquo;use Shirahata -base;&rdquo;的psgi()函数完成的。稍后再看这个。
2、包装:取出前面说的allowfrom和front_proxy部分后，代码如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="nv">$app</span> <span class="o">=</span> <span class="n">builder</span> <span class="p">{</span>
        <span class="n">enable</span> <span class="s">&#39;Plack::Middleware::Lint&#39;</span><span class="p">;</span>
        <span class="n">enable</span> <span class="s">&#39;Plack::Middleware::StackTrace&#39;</span><span class="p">;</span>
        <span class="n">enable</span> <span class="s">&#39;Plack::Middleware::Static&#39;</span><span class="p">,</span>
            <span class="n">path</span> <span class="o">=&gt;</span> <span class="sx">qr{^/(favicon\.ico$|static/)}</span><span class="p">,</span>
            <span class="n">root</span> <span class="o">=&gt;</span><span class="nn">Path::Class::</span><span class="n">dir</span><span class="p">(</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="n">root_dir</span><span class="p">,</span> <span class="s">&#39;htdocs&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">stringify</span><span class="p">;</span>
        <span class="nv">$app</span><span class="p">;</span>
    <span class="p">};</span>
</code></pre></div>
<p>真实加载顺序是倒序的，先加载Static.pm，用来服务静态文件，意即url路径为^/static/.*的，实际documentroot为./htdocs/；然后加载StackTrace.pm，用于开发调试的时候，向标准输出输出错误跟踪信息；最后是Lint.pm，用于检查请求/响应的格式是否正确。
然后是加载运行，使用Plack::Loader运行上面build出来的$app。方法如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$loader</span> <span class="o">=</span> <span class="nn">Plack::</span><span class="n">Loader</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">(</span>
        <span class="s">&#39;Starlet&#39;</span><span class="p">,</span>
        <span class="n">port</span> <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">||</span> <span class="mi">5000</span><span class="p">,</span>
        <span class="n">host</span> <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">||</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_workers</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="nv">$loader</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">(</span><span class="nv">$app</span><span class="p">);</span>
</code></pre></div>
<p>主要是两个参数，第一个是用来运行plack的服务器模块名称，常见的有starman/twiggy/corona/perlbal等等，这里写的这个Starlet，是基于HTTP::Server::PSGI模块添加预派生(prefork)/热部署(Server::Starter)/优雅重启等功能的一个服务器模块，原来叫的名字是&rdquo;Plack::Server::Standalone::Prefork::Server::Starter&rdquo;(简称PSSPSS)……</p>
<p>然后去看前面说到的Shirahata.pm里的psgi()函数。
这个Shirahata似乎是作者自己完成的一个框架？反正我在cpan上没看到。psgi()里调用build_app()完成主要功能，其中使用了Router::Simple完成route功能，Data::Section::Simple(提取文件中_DATA_下的内容)和HTML::FillInForm::Lite()、Text::Xslate完成template功能，Plack::Request和Plack::Response完成请求响应功能，最终返回一个&rdquo;$psgi_res;&rdquo;。
一堆模块没一个看过的……不细究了……</p>
      <a href="/2011/08/18/learning-cloudfarecast-3" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/08/18/learning-cloudfarecast-2" title="CloudForecast学习笔记(二)" rel="bookmark">CloudForecast学习笔记(二)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-18 00:00:00 +0800">18 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>接下来看radar部分，也就是探测主程序cloudforecast_radar，其中主要就是调用CloudForecast::Radar中的run()函数。
首先还是惯例，调用ConfigLoader模块加载配置文件；
然后是%SIG信号的定义，用来之后自动重运行的；
然后一个while true死循环：
1、循环里用select(undef,undef,undef,0.5)实现一个0.5秒的sleep；
2、第一个if语句，用来判断是否是父进程，并使用无阻塞的waitpid($pid,WNOHANG)等待子进程完成——即$kid==-1；
3、第二个if语句，用来强制退出死循环，条件是收到%SIG信号；
4、第三个if语句，确认当前时间超过计划中的执行时间（即离上次执行时间最近的整5分钟点），开始执行探测——采用fork()派生子进程。
5、子进程内容是从之前获取的配置文件内，轮询每一台设备，最终调用run_host()函数执行。
然后又是两个if语句，接在while里的last之后，等待子进程全部完成的。</p>
<p>接下来看run_host()函数，其实就是new了一个CloudForecast::Host对象，并调用其run()函数。
这个run()函数，就是根据config里的resource调用相应的CloudForecast::Data::*，最后到CloudForecast::Data里的call_fetch()函数。ok，这个函数上一篇已经看过了。</p>
      <a href="/2011/08/18/learning-cloudfarecast-2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/08/17/learning-cloudfarecast-1" title="CloudForecast学习笔记(一)" rel="bookmark">CloudForecast学习笔记(一)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-17 00:00:00 +0800">17 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>近三天学习cloudforecast，这是一个日本SA写的分布式监控的perl项目。日本的运维水平和perl水平，都让人羡慕啊……
项目介绍：
http://blog.riywo.com/2011/02/27/043646
demo网址:
http://editnuki.info:5000/
下载地址：
https://github.com/kazeburo/cloudforecast
粗略的看了主要文件，主要是用Class::<em>完成的OO，Plack::MiddleWare::</em>完成的web，Gearman::Worker调用Data::*里的具体模块完成对服务器的监控抓取，然后调用RRDs完成监控数据图像的更新，在启动分布式的情况下，则用Gearman::Client传输监控数据给调用RRDs的worker。</p>
<p>第一篇主要记录一下监控数据在服务器上流程，cloudforecast是怎么去抓取数据，怎么传递给rrd的。
不过，先看看Class::*的用法：
在CloudForecast::Data中，有如下一段代码：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">base</span> <span class="sx">qw/Class::Data::Inheritable Class::Accessor::Fast/</span><span class="p">;</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">mk_accessors</span><span class="p">(</span><span class="sx">qw/hostname address details args</span>
<span class="sx">                             component_config _component_instance</span>
<span class="sx">                             global_config/</span><span class="p">);</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">mk_classdata</span><span class="p">(</span><span class="s">&#39;rrd_schema&#39;</span><span class="p">);</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">mk_classdata</span><span class="p">(</span><span class="s">&#39;fetcher_func&#39;</span><span class="p">);</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">mk_classdata</span><span class="p">(</span><span class="s">&#39;graph_key_list&#39;</span><span class="p">);</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">mk_classdata</span><span class="p">(</span><span class="s">&#39;graph_defs&#39;</span><span class="p">);</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">mk_classdata</span><span class="p">(</span><span class="s">&#39;title_func&#39;</span><span class="p">);</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">mk_classdata</span><span class="p">(</span><span class="s">&#39;sysinfo_func&#39;</span><span class="p">);</span>
</code></pre></div>
<p>这里，先用use base()加载两个父类继承关系。然后用Class::Accessor::Fast的mk_accessors方法创建了一堆可读写的变量，这里有另一种写法，看起来更舒服一些：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Class::</span><span class="n">Accessor</span> <span class="s">&quot;moose-like&quot;</span><span class="p">;</span>
<span class="n">has</span> <span class="n">hostname</span> <span class="o">=&gt;</span> <span class="p">(</span> <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;rw&#39;</span><span class="p">,</span> <span class="n">isa</span> <span class="o">=&gt;</span> <span class="s">&#39;Str&#39;</span> <span class="p">);</span>
</code></pre></div>
<p>然后是Class::Data::Inheritable的mk_classdata方法创建了一堆可继承的方法。
在CPAN上看到另外有一个模块叫Class::Data::Accessor的，是上面这两个模块的合集，不过作者声明说已经废弃，推荐大家使用Moose了……</p>
<p>现在来跟踪一下fetch_worker的流程：
先看cf_fetcher_worker脚本里new一个worker出来后，执行的是fetcher_worker()；</p>
<p>然后看lib/CloudForecast/Gearman/Worker.pm里的fetcher_worker()，在连接上gearmand上的fetcher任务后，执行的是$self-&gt;load_resource();</p>
<p>然后看lib/CloudForecast/Gearman/Worker.pm里的load_resource()，其实就是根据具体监控项require并且new一个CloudFarecast::Data::*（这个new方法是通过use base和SUPER::new最终到的CloudFarecast.pm上的）。</p>
<p>然后看fetcher_worker()的下一句&rdquo;$resource-&gt;exec_fetch;&rdquo;，先去找CloudFarecast::Data::*，发现没有exec_fetch()，那往base的CloudFarecast::Data上看，果然有了。其中的主要两行&rdquo;$ret = $self-&gt;do_fetch();&rdquo;和&rdquo;$self-&gt;call_updater($ret);&rdquo;。</p>
<p>然后看do_fetch()。其中主要两行&rdquo;my $ret = $self-&gt;fetcher_func-&gt;($self);&rdquo;和&rdquo;my $schema = $self-&gt;rrd_schema;&rdquo;。这两个fetcher_func和rrd_schema都是前面mk_classdata出来的方法。而这里的$self，则一直追溯到最前面Worker.pm里的$resource，即CloudForecast::Data::*。</p>
<p>选一个CloudForecast::Data::Basic看，其中分别调用了Data.pm里的rrds/graph/title/fetcher函数。</p>
<p>返回Data.pm看fetcher()函数如下：</p>
<div class="highlight"><pre><code class="perl"><span class="k">sub </span><span class="nf">fetcher</span><span class="p">(&amp;) {</span>
    <span class="k">my</span> <span class="nv">$class</span> <span class="o">=</span> <span class="nb">caller</span><span class="p">;</span>
    <span class="nn">Carp::</span><span class="n">croak</span><span class="p">(</span><span class="s">&quot;already seted fetcher_func&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nv">$class</span><span class="o">-&gt;</span><span class="n">fetcher_func</span><span class="p">;</span>
    <span class="nv">$class</span><span class="o">-&gt;</span><span class="n">fetcher_func</span><span class="p">(</span><span class="nb">shift</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>学习一下，这里新出现的一个caller函数，这是perl自带的函数，可以使用perldoc -f caller查看详细说明。默认返回三个值，分别是调用的package/file/linenumber。显然这里就是获取package，也就是$class = &lsquo;CloudFarecast::Data::Basic&rsquo;了。然后返回的&rdquo;$class-&gt;fetcher_func(shift);&rdquo;，这个shift也就是(&amp;)里的内容，即Basic.pm里的{my $c = shift;my @map = &hellip;;my $ret = $c-&gt;component(&lsquo;SNMP&rsquo;)-&gt;get(@map);return $ret;}这个匿名函数。
这样前面Worker里的$resource就有了自己的fetcher_func函数了，就此执行并且返回$ret。完成！</p>
<p>然后把$ret传递给call_updater()函数。这个函数中先对配置文件做一次判断，是否enable了gearmand。如果没有，直接调用exec_updater()完成本地rrd图像的初始化init_rrd()或更新update_rrd()。如果有，则连接上gearmand，new一个CloudForecast::Gearman对象，使用updater方法提交数据。</p>
<p>然后看Gearman.pm中的updater()，其实就是Gearman::Client的dispatch_background()连接上updater任务，发送数据。</p>
      <a href="/2011/08/17/learning-cloudfarecast-1" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/08/02/calendar-select-html-for-self-monitor" title="cdn自主监控(六):数据展示页面" rel="bookmark">cdn自主监控(六):数据展示页面</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-02 00:00:00 +0800">02 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>接下来进入我不擅长的页面部分了。规划页面分为side和main，side中提供时间选择框/类型下拉选择框和提交按钮；main中展示最后形成的chart。
时间选择框是用js和css完成的，这个网上有很多，不过要同时支持多浏览器和分钟级别的选项的，目前就发现一个好用的。下载地址如下：<a href="http://chenlinux.com/images/uploads/Calendar.zip">http://chenlinux.com/images/uploads/Calendar.zip</a>
然后创建cachemoni/public/cdn.html如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;HTML&gt;</span>
<span class="nt">&lt;HEAD&gt;</span>
<span class="nt">&lt;META</span> <span class="na">NAME=</span><span class="s">&quot;ROBOTS&quot;</span> <span class="na">CONTENT=</span><span class="s">&quot;NOINDEX, NOFOLLOW&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;TITLE&gt;</span>CDN Monitor<span class="nt">&lt;/TITLE&gt;</span>
<span class="nt">&lt;/HEAD&gt;</span>
<span class="nt">&lt;FRAMESET</span> <span class="na">BORDER=</span><span class="s">&quot;0&quot;</span> <span class="na">FRAMEBORDER=</span><span class="s">&quot;0&quot;</span> <span class="na">FRAMESPACING=</span><span class="s">&quot;0&quot;</span> <span class="na">COLS=</span><span class="s">&quot;270,*&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;FRAME</span> <span class="na">SRC=</span><span class="s">&quot;side.html&quot;</span> <span class="na">NAME=</span><span class="s">&quot;side&quot;</span> <span class="na">TARGET=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;FRAME</span> <span class="na">SRC=</span><span class="s">&quot;main.html&quot;</span> <span class="na">NAME=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/FRAMESET&gt;</span>
<span class="nt">&lt;/HTML&gt;</span>
</code></pre></div>
<p>cachemoni/public/side.html如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;link</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;css/calendar.css&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;script </span><span class="na">language=</span><span class="s">&quot;javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/calendar.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
select_time<span class="nt">&lt;HR&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/cdncharts&quot;</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">target=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;LI&gt;</span>begin<span class="nt">&lt;/LI&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;timefrom&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">id=</span><span class="s">&quot;timefrom&quot;</span> <span class="na">style=</span><span class="s">&quot;width:100%;&quot;</span> <span class="na">onclick=</span><span class="s">&quot;displayCalendar(this, &#39;yyyy-mm-dd hh:ii&#39;, this, true, &#39;&#39;);&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;LI&gt;</span>end<span class="nt">&lt;/LI&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;timeto&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">id=</span><span class="s">&quot;timeto&quot;</span> <span class="na">style=</span><span class="s">&quot;width:100%;&quot;</span> <span class="na">onclick=</span><span class="s">&quot;displayCalendar(this, &#39;yyyy-mm-dd hh:ii&#39;, this, true, &#39;&#39;);&quot;</span><span class="nt">/&gt;&lt;HR&gt;</span>
<span class="nt">&lt;select</span> <span class="na">name=</span><span class="s">&quot;chartstype&quot;</span> <span class="na">id=</span><span class="s">&quot;chartstype&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;area&quot;</span><span class="nt">&gt;</span>area<span class="nt">&lt;/option&gt;</span>
<span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;isp&quot;</span><span class="nt">&gt;</span>isp<span class="nt">&lt;/option&gt;</span>
<span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;time&quot;</span> <span class="na">selected</span><span class="nt">&gt;</span>time<span class="nt">&lt;/option&gt;</span>
<span class="nt">&lt;/select&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div>
<p>cachemoni/views/charts.tt如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>FusionCharts Free Documentation<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;css/chartstyle.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;script </span><span class="na">language=</span><span class="s">&quot;JavaScript&quot;</span> <span class="na">src=</span><span class="s">&quot;javascripts/FusionCharts.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;table</span> <span class="na">width=</span><span class="s">&quot;98%&quot;</span> <span class="na">border=</span><span class="s">&quot;0&quot;</span> <span class="na">cellspacing=</span><span class="s">&quot;0&quot;</span> <span class="na">cellpadding=</span><span class="s">&quot;3&quot;</span> <span class="na">align=</span><span class="s">&quot;center&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tr&gt;</span> 
    <span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span> <span class="na">class=</span><span class="s">&quot;text&quot;</span> <span class="na">align=</span><span class="s">&quot;center&quot;</span><span class="nt">&gt;</span> <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chartdiv&quot;</span> <span class="na">align=</span><span class="s">&quot;center&quot;</span><span class="nt">&gt;</span> 
        FusionCharts. 
      <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
		   <span class="kd">var</span> <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FusionCharts</span><span class="p">(</span><span class="s2">&quot;[% IF line %]chartswf/FCF_MSLine.swf[% ELSE %]chartswf/FCF_MSBar2D.swf[% END %]&quot;</span><span class="p">,</span> <span class="s2">&quot;ChartId&quot;</span><span class="p">,</span> <span class="s2">&quot;400&quot;</span><span class="p">,</span> <span class="s2">&quot;350&quot;</span><span class="p">);</span>
		   <span class="nx">chart</span><span class="p">.</span><span class="nx">setDataURL</span><span class="p">(</span><span class="nx">escape</span><span class="p">(</span><span class="s2">&quot;[% url %]&quot;</span><span class="p">));</span>
		   <span class="nx">chart</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s2">&quot;chartdiv&quot;</span><span class="p">);</span>
		<span class="nt">&lt;/script&gt;</span> <span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>cachemoni/lib/cachemoni.pm中相关函数如下：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Time::</span><span class="n">Local</span><span class="p">;</span>
<span class="n">get</span> <span class="s">&#39;/cdncharts&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$type</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">chartstype</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$begin</span> <span class="o">=</span> <span class="n">unix_time_format</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">timefrom</span><span class="p">});</span>
    <span class="k">my</span> <span class="nv">$end</span> <span class="o">=</span> <span class="n">unix_time_format</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">timeto</span><span class="p">});</span>
    <span class="k">my</span> <span class="nv">$req_url</span> <span class="o">=</span> <span class="s">&quot;/xml?begin=${begin}&amp;end=${end}&amp;type=${type}&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;time&#39;</span><span class="p">;</span>
    <span class="n">template</span> <span class="s">&#39;charts&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">line</span> <span class="o">=&gt;</span> <span class="nv">$line</span><span class="p">,</span> <span class="n">url</span> <span class="o">=&gt;</span> <span class="s">&quot;$req_url&quot;</span><span class="p">,</span> <span class="p">};</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">unix_time_format</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$time</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$time</span> <span class="o">=~</span> <span class="sr">m/^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2})/</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">timelocal</span><span class="p">(</span><span class="s">&#39;00&#39;</span><span class="p">,</span><span class="nv">$5</span><span class="p">,</span><span class="nv">$4</span><span class="p">,</span><span class="nv">$3</span><span class="p">,</span><span class="nv">$2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nv">$1</span><span class="o">-</span><span class="mi">1900</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>这里比较怪的是，如果setDataURL里传的arg是直接2011-08-01 11:00的格式，fusionchart.js不会发起请求，只有1311111111才行，所以只能在用Time::Local模块转换时间了。
最终访问结果如下：
<img src="/images/uploads/calendar.png" alt="" title="QQ截图20110802191306" width="697" height="370" class="alignnone size-full wp-image-2555" /></p>
      <a href="/2011/08/02/calendar-select-html-for-self-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/08/01/fusioncharts-for-self-monitor" title="cdn自主监控(五):生成charts图像" rel="bookmark">cdn自主监控(五):生成charts图像</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-01 00:00:00 +0800">01 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上篇完成了xml的输出，这篇开始说charts图像的生成。我们采用fusioncharts的免费版，之前博客有提到另一个amcharts，不过amcharts的免费版会在图像左上角加上自己amcharts.com的广告标识……
从fusioncharts官网下载free版的压缩包，有20MB大，不过其中对我们这个小项目有用的只有MSLine.swf/MSBar2D.swf/fusioncharts.js等。
说明：
1、官网介绍上写了支持perl，不过下载包里只有php/asp/jsp/rails的class，没有perl的。所以还是得采用js的方式；
2、js下有setDataURL和setDataXML两个方法，不过官方强烈建议使用setDataURL方法，这种方法可接受的数据量比setDataXML大很多。
页面html很简单，加如下js代码即可：</p>
<div class="highlight"><pre><code class="javascript"><span class="o">&lt;</span><span class="err">/script&gt;</span>
<span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;</span>
<span class="kd">var</span> <span class="nx">myChart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FusionCharts</span><span class="p">(</span><span class="s2">&quot;/Charts/MSBar2D.swf&quot;</span><span class="p">,</span> <span class="s2">&quot;myChartId&quot;</span><span class="p">,</span> <span class="s2">&quot;600&quot;</span><span class="p">,</span> <span class="s2">&quot;500&quot;</span><span class="p">);</span>
<span class="nx">myChart</span><span class="p">.</span><span class="nx">setDataURL</span><span class="p">(</span><span class="nx">escape</span><span class="p">(</span><span class="s2">&quot;/xml?begin=***&amp;end=***&amp;type=area&quot;</span><span class="p">));</span>
<span class="nx">myChart</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s2">&quot;chartdiv&quot;</span><span class="p">);</span>
<span class="o">&lt;</span><span class="err">/script&gt;</span>
</code></pre></div>
<p>要点在这个escape()，如果URL里带参数的话，必须用escape()转码，不然的话第一个&amp;之后的所有参数都会丢失掉！
在调试中注意到，为了忽略缓存，setDataURL()会在url最后跟上一个随机1-4位数字参数&amp;curr=1234然后再发起请求。
现在就可以访问页面看看了～嗯，可以看到图像中的中文字有问题。这是因为fusioncharts不认utf8的中文，必须输出gbk或者gb2312的xml数据才行。所以需要修改一些dancer的charset配置，把config.yml里的charset: UTF-8改成charset: GBK。然后重新请求，中文就正确显示了。
如下图：
<img src="/images/uploads/fusioncharts.jpg" alt="" title="MSBar2D" width="400" height="350" class="alignnone size-full wp-image-2548" /></p>
<hr />
<p>题外话：因为数据是自己insert的，结果写了个区号0751，在quhao.txt里不存在，导致输出category的时候总有问题……难怪总看人说程序本身很好写，各种错误处理才是麻烦事……</p>
      <a href="/2011/08/01/fusioncharts-for-self-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/28/output-xml-for-funsioncharts" title="cdn自主监控(四):输出xml数据" rel="bookmark">cdn自主监控(四):输出xml数据</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-28 00:00:00 +0800">28 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>准备使用funsioncharts绘图，其采用xml数据，在绘制line图的时候，就要从mysql里读取数据，并输出成xml格式，相关配置如下：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="n">cachemoni</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">Database</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(strftime)</span><span class="p">;</span>
<span class="n">get</span> <span class="s">&#39;/xml&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$begin_time</span> <span class="o">=</span> <span class="n">date_format</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">begin</span><span class="p">});</span>
    <span class="k">my</span> <span class="nv">$end_time</span> <span class="o">=</span> <span class="n">date_format</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">end</span><span class="p">});</span>
    <span class="k">my</span> <span class="nv">$type</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">type</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$color</span> <span class="o">=</span> <span class="p">{</span> <span class="n">chinacache</span> <span class="o">=&gt;</span> <span class="s">&#39;1D8BD1&#39;</span><span class="p">,</span>
                  <span class="n">dnion</span>      <span class="o">=&gt;</span> <span class="s">&#39;F1683C&#39;</span><span class="p">,</span>
                  <span class="n">fastweb</span>    <span class="o">=&gt;</span> <span class="s">&#39;2AD62A&#39;</span><span class="p">,</span>
                <span class="p">};</span>
    <span class="k">my</span> <span class="nv">$xml_head</span> <span class="o">=</span> <span class="s">&quot;&lt;graph caption=&#39;Response Time&#39; subcaption=&#39;from $begin_time to $end_time&#39; hovercapbg=&#39;FFECAA&#39; hovercapborder=&#39;F47E00&#39; formatNumberScale=&#39;0&#39; decimalPrecision=&#39;0&#39; showvalues=&#39;0&#39; numdivlines=&#39;3&#39; numVdivlines=&#39;0&#39; yaxisminvalue=&#39;1000&#39; yaxismaxvalue=&#39;1800&#39;  rotateNames=&#39;1&#39;&gt;\n&lt;categories &gt;\n&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$group</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;time&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$group</span> <span class="o">=</span> <span class="s">&#39;cur_date&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;isp&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$group</span> <span class="o">=</span> <span class="s">&#39;isp&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;area&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$group</span> <span class="o">=</span> <span class="s">&#39;area&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#39;Error&#39;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">my</span> <span class="nv">$xml</span> <span class="o">=</span> <span class="n">cdn_select</span><span class="p">(</span><span class="nv">$begin_time</span><span class="p">,</span> <span class="nv">$end_time</span><span class="p">,</span> <span class="nv">$group</span><span class="p">,</span> <span class="nv">$color</span><span class="p">,</span> <span class="nv">$xml_head</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$xml</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">get_area_code</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$area_code</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;0000&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;其他&#39;</span> <span class="p">};</span>
    <span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&quot;$file&quot;</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cannot open $file&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$fh&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">chomp</span><span class="p">;</span>
        <span class="k">my</span><span class="p">(</span><span class="nv">$area</span><span class="p">,</span><span class="nv">$code</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">;</span>
	<span class="nv">$area_code</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$code&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;$area&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">close</span> <span class="nv">$fh</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$area_code</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">cdn_select</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$begin_time</span><span class="p">,</span> <span class="nv">$end_time</span><span class="p">,</span> <span class="nv">$group</span><span class="p">,</span> <span class="nv">$color</span><span class="p">,</span> <span class="nv">$xml</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$sql</span> <span class="o">=</span> <span class="s">&quot;SELECT ${group},AVG(avg_time) avg FROM cdn_cron_record WHERE cdn = ? AND cur_date BETWEEN ? AND ? GROUP BY ${group} ORDER BY ${group}&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="k">my</span> <span class="nv">$cdn</span> <span class="p">(</span><span class="sx">qw{chinacache dnion fastweb}</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$cdn</span><span class="p">,</span> <span class="nv">$begin_time</span><span class="p">,</span> <span class="nv">$end_time</span><span class="p">);</span>
        <span class="k">unless</span><span class="p">(</span><span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">@values</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span> <span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">my</span> <span class="p">(</span><span class="nv">$avg_time</span><span class="p">,</span> <span class="nv">$type</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;avg&#39;</span><span class="p">},</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$group&quot;</span><span class="p">});</span>
                <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;category name=&#39;convert_group($group, $type)&#39; /&gt;\n&quot;</span><span class="p">;</span>
                <span class="nb">push</span> <span class="nv">@values</span><span class="p">,</span> <span class="nv">$avg_time</span><span class="p">;</span>
            <span class="p">};</span>
            <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;/category&gt;\n&quot;</span><span class="p">;</span>
            <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;dataset seriesName=&#39;$cdn&#39; color=&#39;$color-&gt;{$cdn}&#39;&gt;\n&quot;</span><span class="p">;</span>
            <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;set value=&#39;$_&#39; /&gt;\n&quot;</span> <span class="k">for</span> <span class="nv">@values</span><span class="p">;</span>
            <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;/dataset&gt;\n&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;dataset seriesName=&#39;$cdn&#39; color=&#39;$color-&gt;{$cdn}&#39;&gt;\n&quot;</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span> <span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;set value=&#39;$ref-&gt;{avg}&#39; /&gt;\n&quot;</span><span class="p">;</span>
            <span class="p">};</span>
            <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&quot;&lt;/dataset&gt;\n&quot;</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nv">$xml</span> <span class="o">.=</span> <span class="s">&#39;&lt;/graph&gt;&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$xml</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">convert_group</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$group</span><span class="p">,</span> <span class="nv">$origin</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$group</span> <span class="ow">eq</span> <span class="s">&#39;cur_date&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$origin</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$group</span> <span class="ow">eq</span> <span class="s">&#39;isp&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">@isplist</span> <span class="o">=</span> <span class="sx">qw(其他 电信 联通 移动 教育网)</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$isplist</span><span class="p">[</span><span class="nv">$origin</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$group</span> <span class="ow">eq</span> <span class="s">&#39;area&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$arealist</span> <span class="o">=</span> <span class="n">get_area_code</span><span class="p">(</span><span class="s">&#39;quhao.txt&#39;</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$code</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s">&quot;%04s&quot;</span><span class="p">,</span><span class="nv">$origin</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$arealist</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$code</span><span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#39;Error&#39;</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">date_format</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$time</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%F %H:%M&quot;</span><span class="p">,</span><span class="nb">localtime</span><span class="p">(</span><span class="nv">$time</span><span class="p">))</span> <span class="k">if</span> <span class="nv">$time</span> <span class="o">=~</span> <span class="sr">m/\d+/</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>用curl请求一下，如下：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@naigos ~<span class="o">]</span><span class="c"># curl &#39;http://cache.monitor.china.com/xml?begin=1311739200&amp;end=1311840000&amp;type=time&#39;</span>
&lt;graph <span class="nv">caption</span><span class="o">=</span><span class="s1">&#39;Daily Visits&#39;</span> <span class="nv">subcaption</span><span class="o">=</span><span class="s1">&#39;from 2011-07-27 12:00 to 2011-07-28 16:00&#39;</span> <span class="nv">hovercapbg</span><span class="o">=</span><span class="s1">&#39;FFECAA&#39;</span> <span class="nv">hovercapborder</span><span class="o">=</span><span class="s1">&#39;F47E00&#39;</span> <span class="nv">formatNumberScale</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">decimalPrecision</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">showvalues</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">numdivlines</span><span class="o">=</span><span class="s1">&#39;3&#39;</span> <span class="nv">numVdivlines</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">yaxisminvalue</span><span class="o">=</span><span class="s1">&#39;1000&#39;</span> <span class="nv">yaxismaxvalue</span><span class="o">=</span><span class="s1">&#39;1800&#39;</span>  <span class="nv">rotateNames</span><span class="o">=</span><span class="s1">&#39;1&#39;</span>&gt;&lt;categories &gt;&lt;category <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;2011-07-27 17:27:12&#39;</span> /&gt;
&lt;category <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;2011-07-27 17:32:12&#39;</span> /&gt;
&lt;category <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;2011-07-27 17:37:01&#39;</span> /&gt;
&lt;/category&gt;&lt;dataset <span class="nv">seriesName</span><span class="o">=</span><span class="s1">&#39;chinacache&#39;</span> <span class="nv">color</span><span class="o">=</span><span class="s1">&#39;1D8BD1&#39;</span>&gt;&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;300.0000&#39;</span> /&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;511.0000&#39;</span> /&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;482.0000&#39;</span> /&gt;
&lt;/dataset&gt;&lt;dataset <span class="nv">seriesName</span><span class="o">=</span><span class="s1">&#39;dnion&#39;</span> <span class="nv">color</span><span class="o">=</span><span class="s1">&#39;F1683C&#39;</span>&gt;&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;595.6667&#39;</span> /&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;432.0000&#39;</span> /&gt;
&lt;/dataset&gt;&lt;dataset <span class="nv">seriesName</span><span class="o">=</span><span class="s1">&#39;fastweb&#39;</span> <span class="nv">color</span><span class="o">=</span><span class="s1">&#39;2AD62A&#39;</span>&gt;&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;471.0000&#39;</span> /&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;431.5000&#39;</span> /&gt;
&lt;/dataset&gt;&lt;/graph&gt;
</code></pre></div>
<p>换个area参数试试：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@naigos lib<span class="o">]</span><span class="c"># curl &#39;http://cache.monitor.china.com/xml?begin=1311739200&amp;end=1312169668&amp;type=area&#39;</span>
&lt;graph <span class="nv">caption</span><span class="o">=</span><span class="s1">&#39;Response Time&#39;</span> <span class="nv">subcaption</span><span class="o">=</span><span class="s1">&#39;from 2011-07-27 12:00 to 2011-08-01 11:34&#39;</span> <span class="nv">hovercapbg</span><span class="o">=</span><span class="s1">&#39;FFECAA&#39;</span> <span class="nv">hovercapborder</span><span class="o">=</span><span class="s1">&#39;F47E00&#39;</span> <span class="nv">formatNumberScale</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">decimalPrecision</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">showvalues</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">numdivlines</span><span class="o">=</span><span class="s1">&#39;3&#39;</span> <span class="nv">numVdivlines</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">yaxisminvalue</span><span class="o">=</span><span class="s1">&#39;1000&#39;</span> <span class="nv">yaxismaxvalue</span><span class="o">=</span><span class="s1">&#39;1800&#39;</span>  <span class="nv">rotateNames</span><span class="o">=</span><span class="s1">&#39;1&#39;</span>&gt;
&lt;categories &gt;
&lt;category <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;四川&#39;</span> /&gt;
&lt;category <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;江西&#39;</span> /&gt;
&lt;/category&gt;&lt;dataset <span class="nv">seriesName</span><span class="o">=</span><span class="s1">&#39;chinacache&#39;</span> <span class="nv">color</span><span class="o">=</span><span class="s1">&#39;1D8BD1&#39;</span>&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;511.0000&#39;</span> /&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;421.3333&#39;</span> /&gt;
&lt;/dataset&gt;&lt;dataset <span class="nv">seriesName</span><span class="o">=</span><span class="s1">&#39;dnion&#39;</span> <span class="nv">color</span><span class="o">=</span><span class="s1">&#39;F1683C&#39;</span>&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;482.5000&#39;</span> /&gt;
&lt;/dataset&gt;&lt;dataset <span class="nv">seriesName</span><span class="o">=</span><span class="s1">&#39;fastweb&#39;</span> <span class="nv">color</span><span class="o">=</span><span class="s1">&#39;2AD62A&#39;</span>&gt;
&lt;<span class="nb">set </span><span class="nv">value</span><span class="o">=</span><span class="s1">&#39;431.3333&#39;</span> /&gt;
&lt;/dataset&gt;&lt;/graph&gt;
</code></pre></div>
<p>呃，上面用的数据只是我自己insert的，所以出现了比较囧的条数不一致……</p>
      <a href="/2011/07/28/output-xml-for-funsioncharts" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/27/prepare-mysql-for-self-monitor" title="cdn自主监控(三):数据库准备工作" rel="bookmark">cdn自主监控(三):数据库准备工作</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-27 00:00:00 +0800">27 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>准备两个表，一个存储原始数据，另一个存储每5分钟归总一次的数据。之后根据时间段绘制省份运营商性能图的时候，就直接从汇总表里获取数据；原始表留给详细查询。
数据库准备脚本如下：</p>
<div class="highlight"><pre><code class="mysql"><span class="k">USE</span> <span class="n">myops</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="nf">cdn_ori_record</span> <span class="p">(</span>
	<span class="n">id</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="kp">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="n">ip</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0000000000&#39;</span><span class="p">,</span>
	<span class="n">isp</span> <span class="kt">ENUM</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">),</span>
	<span class="n">area</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0000&#39;</span><span class="p">,</span>
	<span class="n">cur_date</span> <span class="kt">TIMESTAMP</span> <span class="k">DEFAULT</span> <span class="nf">NOW</span><span class="p">(),</span>
	<span class="n">cdn_time</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
	<span class="n">cdn</span> <span class="kt">ENUM</span><span class="p">(</span><span class="s1">&#39;CHINACACHE&#39;</span><span class="p">,</span><span class="s1">&#39;DNION&#39;</span><span class="p">,</span><span class="s1">&#39;FASTWEB&#39;</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
	<span class="k">KEY</span> <span class="nf">time_key</span> <span class="p">(</span><span class="n">cur_date</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="nf">cdn_cron_record</span> <span class="p">(</span>
	<span class="n">id</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="kp">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="n">isp</span> <span class="kt">TINYINT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
	<span class="n">area</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0000&#39;</span><span class="p">,</span>
	<span class="n">cur_date</span> <span class="kt">TIMESTAMP</span> <span class="k">DEFAULT</span> <span class="nf">NOW</span><span class="p">(),</span>
	<span class="n">cdn</span> <span class="kt">ENUM</span><span class="p">(</span><span class="s1">&#39;CHINACACHE&#39;</span><span class="p">,</span><span class="s1">&#39;DNION&#39;</span><span class="p">,</span><span class="s1">&#39;FASTWEB&#39;</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
	<span class="n">avg_time</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
	<span class="k">KEY</span> <span class="nf">time_area_isp_key</span> <span class="p">(</span><span class="n">cur_date</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">isp</span><span class="p">)</span>
<span class="p">);</span>
<span class="n">DELIMITER</span> <span class="o">|</span>
<span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">cdn_cron</span> <span class="o">|</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="nf">cdn_cron</span><span class="p">()</span>
<span class="n">BEGIN</span>
	<span class="k">INSERT</span> <span class="k">INTO</span> <span class="nf">cdn_cron_record</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span><span class="n">area</span><span class="p">,</span><span class="n">cdn</span><span class="p">,</span><span class="n">avg_time</span><span class="p">)</span> 
	<span class="k">SELECT</span> <span class="n">isp</span><span class="p">,</span><span class="n">area</span><span class="p">,</span><span class="n">cdn</span><span class="p">,</span><span class="nf">AVG</span><span class="p">(</span><span class="n">cdn_time</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">cdn_ori_record</span> 
	<span class="k">WHERE</span> <span class="n">cur_date</span> <span class="o">&gt;</span> <span class="nf">FROM_UNIXTIME</span><span class="p">(</span><span class="nf">UNIX_TIMESTAMP</span><span class="p">()</span><span class="o">-</span><span class="mi">300</span><span class="p">)</span>
	<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">cdn</span><span class="p">,</span><span class="n">area</span><span class="p">,</span><span class="n">isp</span><span class="p">;</span>
<span class="n">END</span> <span class="o">|</span>
<span class="n">DELIMITER</span> <span class="p">;</span>
<span class="kt">SET</span> <span class="n">GLOBAL</span> <span class="n">event_scheduler</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="n">EVENT</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">event_cdn</span> <span class="k">ON</span> <span class="n">SCHEDULE</span> <span class="n">EVERY</span> <span class="mi">300</span> <span class="n">SECOND</span> <span class="k">ON</span> <span class="n">COMPLETION</span> <span class="n">PRESERVE</span> <span class="n">DO</span> <span class="k">CALL</span> <span class="nf">cdn_cron</span><span class="p">();</span>
<span class="k">ALTER</span> <span class="n">EVENT</span> <span class="n">event_cdn</span> <span class="k">ON</span> <span class="n">COMPLETION</span> <span class="n">PRESERVE</span> <span class="n">ENABLE</span><span class="p">;</span>
</code></pre></div>
      <a href="/2011/07/27/prepare-mysql-for-self-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/26/seek-iplist-for-self-monitor" title="cdn自主监控(二):快速查找ip对应信息" rel="bookmark">cdn自主监控(二):快速查找ip对应信息</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-26 00:00:00 +0800">26 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>话接上篇，ip整理出来，然后就是接一个ip地址，快速定位查找到它属于哪个ip段，然后返回具体的省份和运营商。因为之前的ip已经转换成数字，而且是顺序排列的，所以可以采用折半算法(二分法)。perl脚本如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="c1">#my $ip = inet_aton(&quot;$ARGV[0]&quot;);</span>
<span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="n">inet_aton</span><span class="p">(</span><span class="n">get_test_ip</span><span class="p">());</span>
<span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="s">&#39;iplist.txt&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$length</span> <span class="o">=</span> <span class="sb">`cat $file | wc -l`</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$code</span> <span class="o">=</span> <span class="n">get_area_code</span><span class="p">(</span><span class="s">&#39;quhao.txt&#39;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">@isplist</span> <span class="o">=</span> <span class="sx">qw(&#39;其他&#39; &#39;电信&#39; &#39;联通&#39; &#39;移动&#39; &#39;教育网&#39;)</span><span class="p">;</span>
<span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&quot;$file&quot;</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cannot open $file\n&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$line_len</span> <span class="o">=</span> <span class="s">&#39;26&#39;</span><span class="p">;</span>                       <span class="c1">#=10+10+4+1+1，包括回车符(注意上篇输出为了好看多了空格，可以删掉) </span>
<span class="k">my</span> <span class="nv">$first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$last</span> <span class="o">=</span> <span class="nv">$length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>                    <span class="c1">#统一使用SEEK_SET,所以最后一行的起始位置是length-1 </span>
<span class="k">my</span> <span class="nv">$result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$middle</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s">&quot;%.0f&quot;</span><span class="p">,(</span><span class="nv">$last</span><span class="o">-</span><span class="nv">$first</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="nv">$first</span><span class="p">);</span>    <span class="c1">#折半位置，除法取整时采用sprintf比直接int精确</span>
    <span class="nb">seek</span> <span class="nv">$fh</span><span class="p">,</span> <span class="nv">$line_len</span> <span class="o">*</span> <span class="nv">$middle</span><span class="p">,</span> <span class="mi">0</span><span class="p">;</span>                            <span class="c1">#移动到折半位置 </span>
    <span class="nb">sysread</span> <span class="nv">$fh</span><span class="p">,</span> <span class="nv">$begin_ip</span><span class="p">,</span> <span class="mi">10</span><span class="p">;</span>                                  <span class="c1">#从折半处读取10位 </span>
    <span class="nb">sysread</span> <span class="nv">$fh</span><span class="p">,</span> <span class="nv">$end_ip</span><span class="p">,</span> <span class="mi">10</span><span class="p">;</span>                                    <span class="c1">#接着再读10位,如果没删空格,还要先seek移动1位,麻烦 </span>
    <span class="c1">#根据比大小决定下次向哪个方向折半</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$ip</span> <span class="o">&lt;</span> <span class="nv">$begin_ip</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$last</span> <span class="o">=</span> <span class="nv">$middle</span><span class="p">;</span>
        <span class="k">next</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$ip</span> <span class="o">&gt;</span> <span class="nv">$end_ip</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$first</span> <span class="o">=</span> <span class="nv">$middle</span><span class="p">;</span>
        <span class="k">next</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">#找到相应区间，读取区号和运营商号</span>
        <span class="nb">sysread</span> <span class="nv">$fh</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="mi">4</span><span class="p">;</span>
        <span class="nb">sysread</span> <span class="nv">$fh</span><span class="p">,</span> <span class="nv">$isp</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nb">printf</span> <span class="s">&quot;%010s %s %s\n&quot;</span><span class="p">,</span> <span class="nv">$ip</span><span class="p">,</span> <span class="nv">$code</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$area&quot;</span><span class="p">},</span> <span class="nv">$isplist</span><span class="p">[</span><span class="nv">$isp</span><span class="p">];</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                             <span class="c1">#设定$result为假，退出循环 </span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="nb">close</span> <span class="nv">$fh</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">inet_aton</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$short</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%010s&quot;</span><span class="p">,</span> <span class="nv">$1</span> <span class="o">*</span> <span class="mi">256</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="nv">$2</span> <span class="o">*</span> <span class="mi">256</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="nv">$3</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="nv">$4</span> <span class="k">if</span> <span class="nv">$ip</span> <span class="o">=~</span><span class="sr"> /(\d+)\.(\d+)\.(\d+)\.(\d+)/</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$short</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">#对应区号和省份，跟上篇的kv相反</span>
<span class="k">sub </span><span class="nf">get_area_code</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$area_code</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;0000&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;other&#39;</span> <span class="p">};</span>
    <span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&quot;$file&quot;</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cannot open $file&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$fh&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">chomp</span><span class="p">;</span>
        <span class="k">my</span><span class="p">(</span><span class="nv">$area</span><span class="p">,</span><span class="nv">$code</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">;</span>
	<span class="nv">$area_code</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$code&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;$area&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">close</span> <span class="nv">$fh</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$area_code</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">#生成一个随机的合法ip地址</span>
<span class="k">sub </span><span class="nf">get_test_ip</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">join</span> <span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="nb">map</span> <span class="nb">int</span> <span class="nb">rand</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="o">..</span><span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
      <a href="/2011/07/26/seek-iplist-for-self-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/25/overwrite-qqwry-for-self-monitor" title="cdn自主监控(一):整理一个可用范围内的尽可能小的ip库" rel="bookmark">cdn自主监控(一):整理一个可用范围内的尽可能小的ip库</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-25 00:00:00 +0800">25 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>为了跟第三方监控做对比和作为备用，准备自己通过页面js返回数据做个监控。首先第一步，整理一个足够自己用的ip库。
首先，考虑调用会比较频繁，打算把内容尽可能归并，到省级运营商即可；
其次，未知归并完会有多大的情况下，考虑到qqwry的地区都是中文，打算统一使用电话区号代替地区，运营商也有一位数字代替，ip采用inet-aton网络值代替；这样每条记录的字节数固定，可以方便采用seek和sysread提高读取某条记录的速度。</p>
<hr />
<p>前几步工作和之前整理ip库给dns用的时候一样，导出qqwry.txt，约42w条，24MB大小。
然后从网上搜一下全国电话区号，以各省省会(首府)的区号为准，存成一个quhao.txt，为了之后处理方便，只保留前两个中文，好在中国的省份里也只有内蒙古和黑龙江是三个字，留两位不至于影响阅读，txt内容如下：</p>
<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">北京 0010</span> 
<span class="l-Scalar-Plain">上海 0021</span>
<span class="l-Scalar-Plain">天津 0022</span>
<span class="l-Scalar-Plain">重庆 0023</span>
<span class="l-Scalar-Plain">安徽 0551</span>
<span class="l-Scalar-Plain">福建 0591</span>
<span class="l-Scalar-Plain">甘肃 0931</span>
<span class="l-Scalar-Plain">广东 0020</span>
<span class="l-Scalar-Plain">广西 0771</span>
<span class="l-Scalar-Plain">贵州 0851</span>
<span class="l-Scalar-Plain">海南 0898</span>
<span class="l-Scalar-Plain">河北 0311</span>
<span class="l-Scalar-Plain">河南 0371</span>
<span class="l-Scalar-Plain">黑龙 0451</span>
<span class="l-Scalar-Plain">湖北 0027</span>
<span class="l-Scalar-Plain">湖南 0731</span>
<span class="l-Scalar-Plain">吉林 0431</span>
<span class="l-Scalar-Plain">江苏 0025</span>
<span class="l-Scalar-Plain">江西 0791</span>
<span class="l-Scalar-Plain">辽宁 0024</span>
<span class="l-Scalar-Plain">内蒙 0471</span>
<span class="l-Scalar-Plain">宁夏 0951</span>
<span class="l-Scalar-Plain">青海 0971</span>
<span class="l-Scalar-Plain">山东 0531</span>
<span class="l-Scalar-Plain">山西 0351</span>
<span class="l-Scalar-Plain">陕西 0029</span>
<span class="l-Scalar-Plain">四川 0028</span>
<span class="l-Scalar-Plain">西藏 0891</span>
<span class="l-Scalar-Plain">新疆 0991</span>
<span class="l-Scalar-Plain">云南 0871</span>
<span class="l-Scalar-Plain">浙江 0571</span>
</code></pre></div>
<p>然后用如下perl脚本归并：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">my</span><span class="p">(</span><span class="nv">$quhao</span><span class="p">,</span> <span class="nv">$qqwry</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@ARGV</span><span class="p">;</span>
<span class="nv">$code</span> <span class="o">=</span> <span class="n">read_area_code</span><span class="p">(</span><span class="nv">$quhao</span><span class="p">);</span>
<span class="n">overwrite_iplist</span><span class="p">(</span><span class="nv">$qqwry</span><span class="p">,</span> <span class="nv">$code</span><span class="p">);</span>
<span class="k">sub </span><span class="nf">inet_aton</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$short</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%010s&quot;</span><span class="p">,</span> <span class="nv">$1</span> <span class="o">*</span> <span class="mi">256</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="nv">$2</span> <span class="o">*</span> <span class="mi">256</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="nv">$3</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="nv">$4</span> <span class="k">if</span> <span class="nv">$ip</span> <span class="o">=~</span><span class="sr"> /(\d+)\.(\d+)\.(\d+)\.(\d+)/</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$short</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">read_area_code</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$area_code</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&quot;$file&quot;</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cannot open $file&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$fh&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">chomp</span><span class="p">;</span>
        <span class="k">my</span><span class="p">(</span><span class="nv">$area</span><span class="p">,</span><span class="nv">$code</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">;</span>
	<span class="nv">$area_code</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$area&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;$code&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">close</span> <span class="nv">$fh</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$area_code</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">overwrite_iplist</span> <span class="p">{</span>
    <span class="k">my</span><span class="p">(</span><span class="nv">$iplist</span><span class="p">,</span> <span class="nv">$area_code</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span><span class="p">(</span><span class="nv">$last_begin_ip_n</span><span class="p">,</span> <span class="nv">$last_end_ip_n</span><span class="p">,</span> <span class="nv">$last_province_n</span><span class="p">,</span> <span class="nv">$last_isp_n</span><span class="p">);</span>
    <span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&quot;$iplist&quot;</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cannoet open $iplist&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$fh&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">chomp</span><span class="p">;</span>
	<span class="k">my</span><span class="p">(</span><span class="nv">$begin_ip</span><span class="p">,</span> <span class="nv">$end_ip</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="nv">$isp</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">;</span>
	<span class="k">my</span><span class="p">(</span><span class="nv">$province_n</span><span class="p">,</span> <span class="nv">$isp_n</span><span class="p">);</span>
	<span class="k">my</span> <span class="nv">$begin_ip_n</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inet_aton</span><span class="p">(</span><span class="s">&quot;$begin_ip&quot;</span><span class="p">);</span>
	<span class="k">my</span> <span class="nv">$end_ip_n</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inet_aton</span><span class="p">(</span><span class="s">&quot;$end_ip&quot;</span><span class="p">);</span>
        <span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$end_ip_n</span> <span class="o">-</span> <span class="nv">$begin_ip_n</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="nv">$area</span> <span class="o">=~</span><span class="sr"> /学/</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$isp_n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>                                          <span class="c1">#教育网, 因为清华北大等学校记录在area里了，所以这步提前设定 </span>
	<span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span> <span class="nv">$isp</span> <span class="o">=~</span> <span class="sr">m/电信/</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$isp_n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                                          <span class="c1">#电信 </span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$isp</span> <span class="o">=~</span> <span class="sr">m/联通/</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$isp_n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>                                          <span class="c1">#联通(包括原网通) </span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$isp</span> <span class="o">=~</span> <span class="sr">m/铁通|移动/</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$isp_n</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>                                          <span class="c1">#移动(包括原铁通) </span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$isp</span> <span class="o">=~</span> <span class="sr">m/学/</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$isp_n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>                                          <span class="c1">#教育网 </span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nv">$isp_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                          <span class="c1">#国外地址及其他未能识别的国内运营商 </span>
	<span class="p">};</span>
        <span class="k">my</span> <span class="nv">$province</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>                      <span class="c1">#中文用2字节，所以对原始记录获取前四字节即为省份名</span>
	<span class="k">if</span> <span class="p">(</span> <span class="nb">exists</span> <span class="nv">$area_code</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$province&quot;</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$province_n</span> <span class="o">=</span> <span class="nv">$area_code</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$province&quot;</span><span class="p">};</span>             <span class="c1">#国内已知电话区号的省份 </span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nv">$province_n</span> <span class="o">=</span> <span class="s">&#39;0000&#39;</span><span class="p">;</span>                                <span class="c1">#港澳台及外国，可能有其他未能识别的国内地址 </span>
	<span class="p">};</span>
        <span class="c1">#下段为合并网段，之前dns时也用过</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$last_province_n</span><span class="p">)</span> <span class="p">{</span>
	    <span class="p">(</span><span class="nv">$last_begin_ip_n</span><span class="p">,</span> <span class="nv">$last_end_ip_n</span><span class="p">,</span> <span class="nv">$last_province_n</span><span class="p">,</span> <span class="nv">$last_isp_n</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$begin_ip_n</span><span class="p">,</span> <span class="nv">$end_ip_n</span><span class="p">,</span> <span class="nv">$province_n</span><span class="p">,</span> <span class="nv">$isp_n</span><span class="p">);</span>
	<span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$last_province_n</span> <span class="o">==</span> <span class="nv">$province_n</span> <span class="o">&amp;&amp;</span> <span class="nv">$last_isp_n</span> <span class="o">==</span> <span class="nv">$isp_n</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$last_end_ip_n</span> <span class="o">=</span> <span class="nv">$end_ip_n</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nb">printf</span> <span class="s">&quot;%010s %010s %04s %s\n&quot;</span><span class="p">,</span> <span class="nv">$last_begin_ip</span><span class="p">,</span> <span class="nv">$last_end_ip</span><span class="p">,</span> <span class="nv">$last_province_n</span><span class="p">,</span> <span class="nv">$last_isp_n</span><span class="p">;</span>
	    <span class="p">(</span><span class="nv">$last_begin_ip_n</span><span class="p">,</span> <span class="nv">$last_end_ip_n</span><span class="p">,</span> <span class="nv">$last_province_n</span><span class="p">,</span> <span class="nv">$last_isp_n</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$begin_ip_n</span><span class="p">,</span> <span class="nv">$end_ip_n</span><span class="p">,</span> <span class="nv">$province_n</span><span class="p">,</span> <span class="nv">$isp_n</span><span class="p">);</span>
	<span class="p">};</span>
    <span class="p">};</span>
    <span class="nb">close</span> <span class="nv">$fh</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>最后运行如下命令即可获得精简ip库：</p>
<div class="highlight"><pre><code class="bash">perl overwrite.pl quhao.txt qqwry.txt &gt; newip.txt
</code></pre></div>
<p>对比一下大小和行数：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@cdn2 ~<span class="o">]</span><span class="c"># ll</span>
-rw-r--r-- 1 root root   539226 Jul 25 18:18 newer.txt
-rw-r--r-- 1 root root  9058928 May 15 13:13 QQWry.dat
-rw-r--r-- 1 root root 24753935 Jul 25 15:26 qqwry.txt
-rw-r--r-- 1 root root      340 Jul 25 15:03 quhao.txt
-rw-r--r-- 1 root root     2439 Jul 25 18:17 test.pl
<span class="o">[</span>root@cdn2 ~<span class="o">]</span><span class="c"># wc -l *</span>
   18594 newer.txt
   34727 QQWry.dat
  428454 qqwry.txt
      30 quhao.txt
      72 test.pl
</code></pre></div>
<p>好了，一天一天来，明天实现在这527KB的文件里快速定位ip……</p>
      <a href="/2011/07/25/overwrite-qqwry-for-self-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/21/some-tests-about-perl" title="perl小测试题(转自CU)" rel="bookmark">perl小测试题(转自CU)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-21 00:00:00 +0800">21 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>原贴地址：http://bbs.chinaunix.net/thread-3563215-1-1.html
flw回帖里有翻译，我试答如下：
1. Perl 5 中变量名开头的那个字符（sigils）有哪几种、分别都有什么含义？
$标量@数组%散列&amp;函数
2. 访问一个数组元素时，用 $items[$index] 和用 @items[$index] 有什么区别？
$是标量，@是数组切片
3. 请问 == 和 eq 之间的区别是什么？
分别是数值和字符的比较
4. 在列表上下文中对一个 hash 求值，会得到什么？
应该是得到一个数组？
5. 如何查看关键字的 Perl 文档？
perldoc -f 
6. Perl 5 中的函数和方法有什么不同？
方法是bless后的函数调用？
7. Perl 5 什么时候对一个变量所使用的内存进行回收？
引用计数器清空后？（好像记得是）或者执行完成退出的时候
8. 如何做才能够确保一个变量的缺省作用域是词法作用域？
my local？
9. 如何加载模块并且从中导入符号？
use Module;
符号是啥？
10. 是什么在控制 Perl 如何加载模块？有什么办法可以指定一个目录清单告诉 Perl 从这些地方尝试加载模块？
不知道。
use lib qw();或者perl -I或者export PERL5LIB=
11. 你怎么在 Perl 5 的文档中中查看一条错误信息说明？（加分项：了解如何为所有遇到过的错误信息启用解释）
汗，这个用|less然后/搜索……有好办法么？
12. 试着阐述一下把数组传递给函数的时候会发生什么事。
应该是复制一个数组副本出来，然后赋值到@<em>给函数用？
13. 如何传递多个独立的数组给函数？
分别传递数组引用。
14. 对于调用方来说，return 和 return undef 有什么区别？
return的应该是上一个的结果吧？
15. Where do tests go in a standard CPAN distribution?
module里头都有t/目录可以test吧，然后cpan.org上有志愿者？
16. 拿到一个 CPAN 模块后怎样进行测试？
make test
17. 你用什么命令从 CPAN 上安装新模块？
cpanm Module
18. 为什么要使用 open 函数的三参数形式？
预防文件名带有&gt;等特殊字符串
19. 如何检测（和报告）像 open 这样的系统调用产生的错误？（加分项: 知道如何开启自动检测和报告）
在open的时候接上or die $@；
use autodie;
20. 如何在 Perl 5 中抛出一个异常？
die
21. 如何在 Perl 5 中捕获一个异常？
eval {}
22. 用 for 读文件和用 while 读文件有什么不同吗？
for一次性读入；while一次一行
23. 在 Perl 5 的函数或者方法中，你分别是如何处理参数的？
my $abc = shift;
my ($abc, $def) = @</em>;
24. my ($value) = @_; 中的小括号有什么用？如果删掉会发生什么？
强制为列表环境；
删掉之后变成标量环境就是@_的元素个数了。
25. new 是 Perl 5 的内置函数或者关键字吗？
不是，模块里要自己写new方法。
26. 你怎么看 Perl 的核心模块的文档？如果是 CPAN 模块的话又该如何看？
perldoc查看，不过核心模块和一般模块方法有区别么？
27. 怎样只访问 hash 的值？
values函数</p>
      <a href="/2011/07/21/some-tests-about-perl" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/08/mysql_history_monitor" title="mysql_history_monitor" rel="bookmark">mysql_history_monitor</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-08 00:00:00 +0800">08 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上篇加了bash_history的监控，这篇说mysql_history的监控。不像bash4，mysql自始至终没有提供过syslog的代码，只能自己通过守护进程去实时获取~/.mysql_history的记录了。一个小脚本如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="n">POE</span> <span class="sx">qw(Wheel::FollowTail)</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Log::Syslog::</span><span class="n">Fast</span> <span class="sx">qw(:all)</span><span class="p">;</span>
<span class="nb">defined</span><span class="p">(</span><span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="nb">fork</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cant fork:$!&quot;</span><span class="p">;</span>
<span class="k">unless</span><span class="p">(</span><span class="nv">$pid</span><span class="p">){</span>  
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
         <span class="nb">exit</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="nn">POE::</span><span class="n">Session</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span>
    <span class="n">inline_states</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="n">_start</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]{</span><span class="n">tailor</span><span class="p">}</span> <span class="o">=</span> <span class="nn">POE::Wheel::</span><span class="n">FollowTail</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
          <span class="n">Filename</span> <span class="o">=&gt;</span> <span class="s">&quot;/root/.mysql_history&quot;</span><span class="p">,</span>
          <span class="n">InputEvent</span> <span class="o">=&gt;</span> <span class="s">&quot;got_log_line&quot;</span><span class="p">,</span>
          <span class="n">ResetEvent</span> <span class="o">=&gt;</span> <span class="s">&quot;got_log_rollover&quot;</span><span class="p">,</span>
        <span class="p">);</span>
      <span class="p">},</span>
      <span class="n">got_log_line</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
<span class="c1">#通过Data::Dumper看到实际是$_[10]，不过在POE::Session里定义了sub ARG0 () { 10 };这样写起来简单了</span>
        <span class="n">to_rsyslog</span><span class="p">(</span><span class="nv">$_</span><span class="p">[</span><span class="n">ARG0</span><span class="p">]);</span>
      <span class="p">},</span>
      <span class="n">got_log_rollover</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="n">to_rsyslog</span><span class="p">(</span><span class="s">&#39;roll&#39;</span><span class="p">);</span>
      <span class="p">},</span>
    <span class="p">}</span>
<span class="p">);</span>
<span class="nn">POE::</span><span class="n">Kernel</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
<span class="nb">exit</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">to_rsyslog</span> <span class="p">{</span>
  <span class="nv">$message</span> <span class="o">=</span> <span class="nb">join</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="nv">@_</span><span class="p">;</span>
<span class="c1">#rsyslog开的是UDP的514端口；而LOG_LOCAL0和LOG_INFO都是syslog定义的，乱写的话会自动归入kernel | alert</span>
  <span class="k">my</span> <span class="nv">$logger</span> <span class="o">=</span> <span class="nn">Log::Syslog::</span><span class="n">Fast</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="n">LOG_UDP</span><span class="p">,</span> <span class="s">&quot;10.0.0.123&quot;</span><span class="p">,</span> <span class="mi">514</span><span class="p">,</span> <span class="n">LOG_LOCAL0</span><span class="p">,</span> <span class="n">LOG_INFO</span><span class="p">,</span> <span class="s">&quot;mysql_231&quot;</span><span class="p">,</span> <span class="s">&quot;mysql_monitor&quot;</span><span class="p">);</span>
  <span class="nv">$logger</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="nv">$message</span> <span class="p">,</span><span class="nb">time</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>当然，mysql的history其实不止一个位置，需要判断~</p>
      <a href="/2011/07/08/mysql_history_monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/07/08/bash_syslog_history" title="bash_syslog_history" rel="bookmark">bash_syslog_history</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-08 00:00:00 +0800">08 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>@钚钉钬影 童鞋要试验系统日志收集处理，采用rsyslog+loganalyzer做界面，因为需求有把bash_history也带上，所以采用修改bash源码的方式。最先采用了bash4.2（bash4.2已经带了这个功能，但是默认不开启，删掉哪个/**/就行了），不过因为这个bash4.+跟redhat的network-functions脚本有点小矛盾，重启的时候报个错——虽然改起来也很简单，就是加一个./的事情——不过本着尽量改动少的原则，换回bash3.1。
bash3.1里默认没有记录syslog的代码，所以从bash4.2/bashhist.c里复制有关bash_syslog_history代码段到bash3.1中——注意不是原样复制到bashhist.c，那样不顶用——需要复制到lib/readline/history.c中，如下：</p>
<div class="highlight"><pre><code class="c"><span class="o">+</span>   <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">syslog</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="err">……</span>
<span class="kt">void</span>
<span class="n">add_history</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span>
     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>
<span class="p">{</span>
<span class="n">HIST_ENTRY</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
<span class="o">+</span><span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">600</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>   <span class="n">syslog</span><span class="p">(</span><span class="n">LOG_LOCAL5</span> <span class="o">|</span> <span class="n">LOG_INFO</span><span class="p">,</span> <span class="s">&quot;%s %s %s %s&quot;</span><span class="p">,</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;LOGNAME&quot;</span><span class="p">),</span><span class="n">getlogin</span><span class="p">(),</span><span class="n">ttyname</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">string</span><span class="p">);</span>
<span class="o">+</span>    <span class="p">}</span>
<span class="o">+</span>    <span class="k">else</span> <span class="p">{</span>
<span class="o">+</span>      <span class="kt">char</span> <span class="n">trunc</span><span class="p">[</span><span class="mi">600</span><span class="p">];</span>
<span class="o">+</span>      <span class="n">strncpy</span><span class="p">(</span><span class="n">trunc</span><span class="p">,</span><span class="n">string</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">trunc</span><span class="p">));</span>
<span class="o">+</span>      <span class="n">trunc</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">trunc</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="o">+</span>    <span class="n">syslog</span><span class="p">(</span><span class="n">LOG_LOCAL5</span><span class="p">,</span> <span class="n">LOG_INFO</span><span class="p">,</span> <span class="s">&quot;%s %s %s %s(++TRUNC)&quot;</span><span class="p">,</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;LOGNAME&quot;</span><span class="p">),</span><span class="n">getlogin</span><span class="p">(),</span><span class="n">ttyname</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">trunc</span><span class="p">);</span>
<span class="o">+</span>    <span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">history_stifled</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">history_length</span> <span class="o">==</span> <span class="n">history_max_entries</span><span class="p">))</span>
</code></pre></div>
<p>上面的LOG_LOCAL5和LOG_INFO都是syslog.h里的定义，所以要include进来。
然后编译使用，就能记录进/var/log/messages里了。</p>
<hr />
<p>话说网上关于上面的说明中，大多数没有提到需要include<syslog.h>，但是make的时候居然只报LOG_INFO和LOG_LOCAL5的未定义错误，随便把这两个改成一个已经defined过的变量，比如HISTORY，编译一样成功；而且也一样记录系统日志。唯一体现不同的地方就是loganalyzer页面上看到所有的history操作都是alert级别。
之前没了解过程的时候，还采用了mysql触发器，自动修改这个报警级别，也记录一下，毕竟是自己第一次用触发器~~</syslog.h></p>
<div class="highlight"><pre><code class="mysql"><span class="k">USE</span> <span class="n">Syslog</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TRIGGER</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">trig_bash_prior</span><span class="p">;</span>
<span class="n">DELIMITER</span> <span class="o">|</span>
<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">trig_bash_prior</span> <span class="k">BEFORE</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="n">Syslog</span><span class="p">.</span><span class="n">SystemEvents</span>
 <span class="k">FOR</span> <span class="k">EACH</span> <span class="n">ROW</span> <span class="n">BEGIN</span>
  <span class="k">IF</span> <span class="n">NEW</span><span class="p">.</span><span class="n">SysLogTag</span><span class="o">=</span><span class="s1">&#39;-bash:&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">NEW</span><span class="p">.</span><span class="n">Priority</span><span class="o">=</span><span class="s1">&#39;1&#39;</span> <span class="k">THEN</span>
   <span class="kt">SET</span> <span class="n">NEW</span><span class="p">.</span><span class="n">Priority</span><span class="o">=</span><span class="s1">&#39;6&#39;</span><span class="p">;</span>
  <span class="n">END</span> <span class="k">IF</span><span class="p">;</span>
 <span class="n">END</span>
<span class="o">|</span>
</code></pre></div>
<p>这个库很简单，基本数据就是记在这个单表里~~</p>
      <a href="/2011/07/08/bash_syslog_history" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/28/a-dancer-demo-of-monitor-squid" title="squid监控+dancer小试验" rel="bookmark">squid监控+dancer小试验</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-28 00:00:00 +0800">28 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>squid监控之前有一篇关于snmp的内容，不过这次是真要用上了，所以细细挑出来几个做监控。碰巧凯哥更新了一把modern perl的东西，我亦步亦趋，也试试dancer。不过花了两天时间，DBIx::Class::Schema还是没搞出来，最终还是简单的用DBI跳过了……
用的database就是之前nmap试验时生成的数据，有application/channel/intranet等column。
首先安装：</p>
<div class="highlight"><pre><code class="perl"><span class="n">cpanm</span> <span class="n">Dancer</span> <span class="n">DBI</span> <span class="n">DBD:mysql</span> <span class="n">Template</span> <span class="nn">Dancer::Session::</span><span class="n">YAML</span>
<span class="n">dancer</span> <span class="o">-</span><span class="n">a</span> <span class="n">cachemoni</span>
</code></pre></div>
<p>然后修改cachemoni/lib/cachemoni.pm如下：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="n">cachemoni</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">Database</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Net::</span><span class="n">SNMP</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Digest::</span><span class="n">MD5</span> <span class="sx">qw(md5_hex)</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$VERSION</span> <span class="o">=</span> <span class="s">&#39;0.1&#39;</span><span class="p">;</span>
<span class="n">get</span> <span class="s">&#39;/monitor&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$app</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">app</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;squid&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="s">&#39;Only support squid now&#39;</span> <span class="k">unless</span> <span class="nv">$app</span> <span class="ow">eq</span> <span class="s">&#39;squid&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$checkstat</span> <span class="o">=</span> <span class="n">_snmp_check</span><span class="p">(</span><span class="nv">$app</span><span class="p">);</span>
    <span class="n">template</span> <span class="s">&#39;monitor&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">status</span> <span class="o">=&gt;</span> <span class="nv">$checkstat</span><span class="p">,</span>
                          <span class="n">name</span>   <span class="o">=&gt;</span> <span class="p">[</span><span class="s">&#39;IP地址&#39;</span><span class="p">,</span><span class="s">&#39;流量命中率&#39;</span><span class="p">,</span><span class="s">&#39;请求数命中率&#39;</span><span class="p">,</span><span class="s">&#39;回源请求响应毫秒&#39;</span><span class="p">,</span><span class="s">&#39;当前客户端数&#39;</span><span class="p">,</span><span class="s">&#39;剩余文件描述符数&#39;</span><span class="p">,</span><span class="s">&#39;已缓存文件数&#39;</span><span class="p">,</span><span class="s">&#39;平均每秒请求数&#39;</span><span class="p">],</span>
                        <span class="p">};</span>
<span class="p">};</span>
<span class="n">any</span><span class="p">[</span><span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="s">&#39;post&#39;</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="s">&#39;/login&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$err</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">()</span> <span class="ow">eq</span> <span class="s">&#39;POST&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">username</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$passwd</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">password</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span>
            <span class="s">&#39;select audit,passwd from ops_user where name = ?&#39;</span>
        <span class="p">);</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchrow_arrayref</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$ref</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">redirect</span> <span class="s">&#39;/register&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">ne</span> <span class="s">&#39;yes&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$err</span> <span class="o">=</span> <span class="s">&#39;你的帐户还没通过审核&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="n">md5_hex</span><span class="p">(</span><span class="s">&quot;$passwd&quot;</span><span class="p">)</span> <span class="ow">ne</span> <span class="s">&quot;$ref-&gt;[1]&quot;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$err</span> <span class="o">=</span> <span class="s">&#39;密码错误&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">session</span> <span class="s">&#39;logged_in&#39;</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">;</span>
            <span class="n">redirect</span> <span class="s">&#39;/&#39;</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="n">template</span> <span class="s">&#39;login&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#39;err&#39;</span> <span class="o">=&gt;</span> <span class="nv">$err</span><span class="p">,</span> <span class="p">};</span>
<span class="p">};</span>
<span class="n">any</span><span class="p">[</span><span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="s">&#39;post&#39;</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="s">&#39;/register&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$err</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">()</span> <span class="ow">eq</span> <span class="s">&#39;POST&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">username</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$passwd</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">password</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$check_sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span>
            <span class="s">&#39;select count(name) from ops_user where name = ?&#39;</span>
        <span class="p">);</span>
        <span class="nv">$check_sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$check_sth</span><span class="o">-&gt;</span><span class="n">fetchrow_arrayref</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="s">&quot;$ref-&gt;[0]&quot;</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$insert_sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span>
                <span class="s">&#39;insert into ops_user (name,passwd) value(?,?)&#39;</span>
            <span class="p">);</span>
            <span class="nv">$insert_sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="n">md5_hex</span><span class="p">(</span><span class="nv">$passwd</span><span class="p">));</span>
            <span class="nv">$err</span> <span class="o">=</span> <span class="s">&#39;等待人工审核通过,3Q&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$err</span> <span class="o">=</span> <span class="s">&#39;该用户名已注册&#39;</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="n">template</span> <span class="s">&#39;register&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#39;err&#39;</span> <span class="o">=&gt;</span> <span class="nv">$err</span><span class="p">,</span> <span class="p">};</span>
<span class="p">};</span>
<span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">template</span> <span class="s">&#39;index&#39;</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">get</span> <span class="s">&#39;/logout&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">session</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">;</span>
    <span class="n">redirect</span> <span class="s">&#39;/&#39;</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">_snmp_check</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$app</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$list</span> <span class="o">=</span> <span class="p">{};</span>
<span class="c1">#之前通过use加载了plugin::database，所以直接有database对象引用了</span>
    <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span>
        <span class="s">&#39;select channel,intranet from myhost where application = ?&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$app</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$list</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$ref-&gt;{&#39;channel&#39;}&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span> <span class="k">unless</span> <span class="nb">exists</span> <span class="nv">$list</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$ref-&gt;{&#39;channel&#39;}&quot;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;intranet&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">@snmpstat</span> <span class="o">=</span> <span class="n">_snmp_walk</span><span class="p">(</span><span class="s">&quot;$ip&quot;</span><span class="p">);</span>
<span class="c1">#这里第一是没想到比较好的把每个ip的各项检查结果导出的办法；所以干脆采用固定次序输出；</span>
<span class="c1">#第二是因为unshift很耗资源，所以先push再reverse</span>
        <span class="nb">push</span> <span class="nv">@snmpstat</span><span class="p">,</span> <span class="nv">$ip</span><span class="p">;</span>
        <span class="nv">@snmpstat</span> <span class="o">=</span> <span class="nb">reverse</span> <span class="nv">@snmpstat</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$list</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$ref-&gt;{&#39;channel&#39;}&quot;</span><span class="p">}},</span> <span class="o">\</span><span class="nv">@snmpstat</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">push</span> <span class="k">my</span> <span class="nv">@checkstat</span><span class="p">,</span> <span class="nb">map</span><span class="p">{</span>
        <span class="p">{</span> <span class="n">channel</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="p">,</span>
          <span class="n">host</span>    <span class="o">=&gt;</span> <span class="nv">$list</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$_&quot;</span><span class="p">},</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$list</span><span class="p">};</span>
    <span class="k">return</span> <span class="o">\</span><span class="nv">@checkstat</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">_snmp_walk</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$o_host</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$o_community</span> <span class="o">=</span> <span class="s">&#39;public&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$result</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">my</span> <span class="nv">%oids</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s">&#39;cacheUptime&#39;</span>                  <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.1.3.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheProtoClientHttpRequests&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.2.1.1.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheNumObjCount&#39;</span>             <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.1.7.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheCurrentUnusedFDescrCnt&#39;</span>  <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.1.10.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheClients&#39;</span>                 <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.2.1.15.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheHttpMissSvcTime&#39;</span>         <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.2.2.1.3.1&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheRequestHitRatio&#39;</span>         <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.2.2.1.9.1&#39;</span><span class="p">,</span>
        <span class="s">&#39;cacheRequestByteRatio&#39;</span>        <span class="o">=&gt;</span> <span class="s">&#39;.1.3.6.1.4.1.3495.1.3.2.2.1.10.1&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$session</span><span class="p">,</span> <span class="nv">$error</span><span class="p">)</span> <span class="o">=</span> <span class="nn">Net::</span><span class="n">SNMP</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">(</span>
        <span class="o">-</span><span class="n">hostname</span>  <span class="o">=&gt;</span> <span class="nv">$o_host</span><span class="p">,</span>
        <span class="o">-</span><span class="n">community</span> <span class="o">=&gt;</span> <span class="nv">$o_community</span><span class="p">,</span>
<span class="c1">#默认是5秒超时，如果有没开snmp的，这页面打开时间一下就上去了，所以要调短</span>
        <span class="o">-</span><span class="n">timeout</span>   <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$session</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$session</span><span class="o">-&gt;</span><span class="n">translate</span><span class="p">(</span><span class="nn">Net::</span><span class="n">SNMP</span><span class="o">-&gt;</span><span class="n">TRANSLATE_NONE</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$squid_status</span> <span class="o">=</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="n">get_request</span><span class="p">(</span> <span class="o">-</span><span class="n">varbindlist</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheUptime&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheProtoClientHttpRequests&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheNumObjCount&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheCurrentUnusedFDescrCnt&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheClients&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheHttpMissSvcTime&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheRequestHitRatio&#39;</span><span class="p">},</span> <span class="nv">$oids</span><span class="p">{</span><span class="s">&#39;cacheRequestByteRatio&#39;</span><span class="p">},</span> <span class="p">],</span> <span class="p">);</span>
        <span class="nv">$session</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$squid_status</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">#如果要算当前的rps，那得sleep 1再取一次，对几十台集群监控来说不可取；</span>
<span class="c1">#姑且用总的平均值做个衡量，或许可以采用二八法则估算一个高峰时间的rps；</span>
<span class="c1">#注意这个cacheUptime是保留两位ms的，所以算rps的时候要除以100；</span>
<span class="c1">#上述原因也是一般大家对单机squid监控采用rrd的原因，采用COUNTER32数据源，直接递增显示。</span>
            <span class="k">my</span> <span class="nv">$request_sum</span> <span class="o">=</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheProtoClientHttpRequests&#39;}&quot;</span><span class="p">};</span>
            <span class="k">my</span> <span class="nv">$uptime</span> <span class="o">=</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheUptime&#39;}&quot;</span><span class="p">};</span>
            <span class="k">return</span> <span class="nv">$request_sum</span> <span class="o">/</span> <span class="nv">$uptime</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheNumObjCount&#39;}&quot;</span><span class="p">},</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheCurrentUnusedFDescrCnt&#39;}&quot;</span><span class="p">},</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheClients&#39;}&quot;</span><span class="p">},</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheHttpMissSvcTime&#39;}&quot;</span><span class="p">},</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheRequestHitRatio&#39;}&quot;</span><span class="p">},</span> <span class="nv">$squid_status</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$oids{&#39;cacheRequestByteRatio&#39;}&quot;</span><span class="p">};</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>修改cachemoni/config.yml如下：</p>
<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">appname</span><span class="p-Indicator">:</span> <span class="s">&quot;cachemoni&quot;</span>
<span class="l-Scalar-Plain">layout</span><span class="p-Indicator">:</span> <span class="s">&quot;main&quot;</span>
<span class="l-Scalar-Plain">charset</span><span class="p-Indicator">:</span> <span class="s">&quot;UTF-8&quot;</span>
<span class="c1">#采用TT作为view模板，注意tt默认是[%%]，而dancer里是&lt;%%&gt;，所以另外要定义标签</span>
<span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="s">&quot;template_toolkit&quot;</span>
<span class="l-Scalar-Plain">engines</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">template_toolkit</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span>  <span class="s">&#39;utf8&#39;</span>
    <span class="l-Scalar-Plain">start_tag</span><span class="p-Indicator">:</span> <span class="s">&#39;[%&#39;</span>
    <span class="l-Scalar-Plain">end_tag</span><span class="p-Indicator">:</span>   <span class="s">&#39;%]&#39;</span>
<span class="c1">#用默认的Simple，即存在内存的一个hash里，实际效果很不稳定，改用yaml，但也有yml文件在关闭浏览器后依旧存在的问题。</span>
<span class="l-Scalar-Plain">session</span><span class="p-Indicator">:</span> <span class="s">&quot;YAML&quot;</span>
<span class="l-Scalar-Plain">session_dir</span><span class="p-Indicator">:</span> <span class="s">&quot;/tmp/dancer_session_dir&quot;</span>
<span class="l-Scalar-Plain">session_expires</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">300</span>
<span class="l-Scalar-Plain">plugins</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">Database</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&#39;mysql&#39;</span>
    <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="s">&#39;myops&#39;</span>
    <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="s">&#39;10.1.1.25&#39;</span>
    <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&#39;user&#39;</span>
    <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">&#39;password&#39;</span>
    <span class="l-Scalar-Plain">connection_check_threshold</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
    <span class="l-Scalar-Plain">dbi_params</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">RaiseError</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
      <span class="l-Scalar-Plain">AutoCommit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
    <span class="l-Scalar-Plain">on_connect_do</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;SET</span><span class="nv"> </span><span class="s">NAMES</span><span class="nv"> </span><span class="s">&#39;utf8&#39;&quot;</span><span class="p-Indicator">,</span> <span class="s">&quot;SET</span><span class="nv"> </span><span class="s">CHARACTER</span><span class="nv"> </span><span class="s">SET</span><span class="nv"> </span><span class="s">&#39;utf8&#39;&quot;</span> <span class="p-Indicator">]</span>
    <span class="l-Scalar-Plain">log_queries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</code></pre></div>
<p>创建cachemoni/views/monitor.tt如下：</p>
<div class="highlight"><pre><code class="html">[% IF session.logged_in %]
[% FOREACH stat IN status %]
  <span class="nt">&lt;hr&gt;</span> channel: [% stat.channel %]
  <span class="nt">&lt;table</span> <span class="na">width=</span><span class="s">&quot;100%&quot;</span> <span class="na">cellspacing=</span><span class="s">&quot;0&quot;</span> <span class="na">cellpadding=</span><span class="s">&quot;0&quot;</span> <span class="na">border=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
  [% FOREACH col IN name %] 
    <span class="nt">&lt;th&gt;&lt;center&gt;</span>
    [% col %]
    <span class="nt">&lt;/center&gt;&lt;/th&gt;</span>
  [% END %]
  <span class="nt">&lt;/tr&gt;</span>
  [% FOREACH host IN stat.host %]
    <span class="nt">&lt;tr&gt;</span>
    [% FOREACH list IN host %]
      <span class="nt">&lt;td&gt;</span>
      [% list %]
      <span class="nt">&lt;/td&gt;</span>
    [% END %]
  [% END %]
  <span class="nt">&lt;/tr&gt;&lt;/table&gt;</span>
[% END %]
[% ELSE %]
  内部信息，请登陆后查看
[% END %]
</code></pre></div>
<p>创建cachemoni/views/login.tt如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;center&gt;</span>
<span class="nt">&lt;h2&gt;</span>登陆页面<span class="nt">&lt;/h2&gt;</span>
[% IF err %]<span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">error</span><span class="nt">&gt;&lt;strong&gt;</span>Error:<span class="nt">&lt;/strong&gt;</span> [% err %][% END %]
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/login&quot;</span> <span class="na">method=</span><span class="s">post</span><span class="nt">&gt;</span>
  <span class="nt">&lt;dl&gt;</span>
    <span class="nt">&lt;dt&gt;</span>用户名:
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">text</span> <span class="na">name=</span><span class="s">username</span><span class="nt">&gt;</span>
    <span class="nt">&lt;dt&gt;</span>密  码:
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">password</span> <span class="na">name=</span><span class="s">password</span><span class="nt">&gt;</span>
    <span class="nt">&lt;dd&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">login</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/dl&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/center&gt;</span>
</code></pre></div>
<p>注册页面类似，不贴了。
然后是layout层的共用部分，之前定义了是views/layouts/main.tt，如下：</p>
<div class="highlight"><pre><code class="html">……
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">metanav</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>首页<span class="nt">&lt;/a&gt;</span> | 
  [% IF not session.logged_in %]
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/register&quot;</span><span class="nt">&gt;</span>注册<span class="nt">&lt;/a&gt;</span> | 
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/login&quot;</span><span class="nt">&gt;</span>登陆<span class="nt">&lt;/a&gt;</span>
  [% ELSE %]
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/logout&quot;</span><span class="nt">&gt;</span>退出<span class="nt">&lt;/a&gt;</span>
  [% END %]
[% content %]
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;footer&quot;</span><span class="nt">&gt;</span>
Powered by <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://perldancer.org/&quot;</span><span class="nt">&gt;</span>Dancer<span class="nt">&lt;/a&gt;</span> [% dancer_version %]
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>这里修改了&lt;%%&gt;为[%%]，其他的tt模版也要改。
然后运行perl cachemoni/bin/app.pl，启动3000端口的监听，访问一下如下：
<img src="/images/uploads/squid-monitor-demo.jpg" alt="" title="123" width="571" height="401" class="alignnone size-full wp-image-2505" />&lt;/a&gt;
这就算完成一个小的网页了，然后开始配置进apache：</p>
<div class="highlight"><pre><code class="bash">cpanm Plack::Handler::Apache2
wget http://search.cpan.org/CPAN/authors/id/P/PH/PHRED/mod_perl-2.0.5.tar.gz
tar zxvf mod_perl-2.0.5.tar.gz
<span class="nb">cd </span>mod_perl-2.0.5
perl Makefile.PL
然后会提示输入apxs的全路径：/usr/local/apache2/bin/apxs
make <span class="o">&amp;&amp;</span> make install
sed -i s<span class="err">&#39;</span>/LoadModule/i<span class="se">\L</span>oadModule perl_module modules/mod_perl.so<span class="se">\&#39;</span> /usr/local/apache2/conf/httpd.conf
cat &gt;&gt; /usr/local/apache2/conf/httpd.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">&lt;VirtualHost *:80&gt;</span>
<span class="s">        ServerName dancer.test.china.com</span>
<span class="s">        DocumentRoot /www/html/cachemoni</span>
<span class="s">        &lt;Directory /www/html/cachemoni&gt;</span>
<span class="s">            AllowOverride None</span>
<span class="s">            Order allow,deny</span>
<span class="s">            Allow from all</span>
<span class="s">        &lt;/Directory&gt;</span>
<span class="s">        &lt;Location /&gt;</span>
<span class="s">            SetHandler perl-script</span>
<span class="s">            PerlHandler Plack::Handler::Apache2</span>
<span class="s">            PerlSetVar psgi_app /www/html/cachemoni/bin/app.pl</span>
<span class="s">        &lt;/Location&gt;</span>
<span class="s">&lt;/VirtualHost&gt;</span>
<span class="s">EOF</span>
/usr/local/apache2/bin/apachectl restart
</code></pre></div>
<p>访问一下，OK~
各种和webserver搭配的方法（其实就是两种：mod_perl和各种cgi）详见：<a href="http://search.cpan.org/~sukria/Dancer-1.3060/lib/Dancer/Deployment.pod">CPAN文档</a></p>
      <a href="/2011/06/28/a-dancer-demo-of-monitor-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/23/make-patch-of-squid-snmp" title="patch制作和使用" rel="bookmark">patch制作和使用</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-23 00:00:00 +0800">23 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>做运维几年没用过patch，说来也怪了~~趁着上一篇自己的小改动，熟悉一下这个命令的简单用法。
首先是patch的制作，用diff命令。</p>
<div class="highlight"><pre><code class="bash">tar zxvf squid-2.7.STABLE9.tar.gz
cp squid-2.7.STABLE9 squid-2.7.STABLE9-old <span class="o">&amp;&amp;</span> mv squid-2.7.STABLE9 squid-2.7.STABLE9-new
<span class="c">#然后按照上篇的内容修改squid-2.7.STABLE9-new/里的文件</span>
diff -uNr squid-2.7.STABLE9-old squid-2.7.STABLE9-new &gt; squid-snmp.patch
</code></pre></div>
<p>这就完成了，好简单啊~来看看patch文件的内容吧：</p>
<div class="highlight"><pre><code class="c"><span class="n">diff</span> <span class="o">-</span><span class="n">uNr</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">cache_snmp</span><span class="p">.</span><span class="n">h</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">cache_snmp</span><span class="p">.</span><span class="n">h</span>
<span class="o">---</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">cache_snmp</span><span class="p">.</span><span class="n">h</span>	<span class="mi">2006</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">22</span> <span class="mi">10</span><span class="o">:</span><span class="mi">49</span><span class="o">:</span><span class="mf">24.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="o">+++</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">cache_snmp</span><span class="p">.</span><span class="n">h</span>	<span class="mi">2011</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">23</span> <span class="mi">13</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mf">04.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">125</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">125</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
     <span class="n">MESH_PTBL_KEEPAL_S</span><span class="p">,</span>
     <span class="n">MESH_PTBL_KEEPAL_R</span><span class="p">,</span>
     <span class="n">MESH_PTBL_INDEX</span><span class="p">,</span>
<span class="o">+</span>    <span class="n">MESH_PTBL_CONN_OPEN</span><span class="p">,</span>
     <span class="n">MESH_PTBL_HOST</span><span class="p">,</span>
     <span class="n">MESH_PTBL_END</span>
 <span class="p">};</span>
<span class="n">diff</span> <span class="o">-</span><span class="n">uNr</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_agent</span><span class="p">.</span><span class="n">c</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_agent</span><span class="p">.</span><span class="n">c</span>
<span class="o">---</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_agent</span><span class="p">.</span><span class="n">c</span>	<span class="mi">2009</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">26</span> <span class="mo">06</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mf">10.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="o">+++</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_agent</span><span class="p">.</span><span class="n">c</span>	<span class="mi">2011</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">23</span> <span class="mi">13</span><span class="o">:</span><span class="mi">27</span><span class="o">:</span><span class="mf">31.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">264</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">264</span><span class="p">,</span><span class="mi">11</span> <span class="err">@@</span>
 	    <span class="n">index</span><span class="p">,</span>
 	    <span class="n">ASN_INTEGER</span><span class="p">);</span>
 	<span class="k">break</span><span class="p">;</span>
<span class="o">+</span>    <span class="k">case</span> <span class="n">MESH_PTBL_CONN_OPEN</span>:
<span class="o">+</span>        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new_integer</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">,</span>
<span class="o">+</span>            <span class="n">p</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">conn_open</span><span class="p">,</span>
<span class="o">+</span>            <span class="n">ASN_INTEGER</span><span class="p">);</span>
<span class="o">+</span>        <span class="k">break</span><span class="p">;</span>
     <span class="nl">default:</span>
 	<span class="o">*</span><span class="n">ErrP</span> <span class="o">=</span> <span class="n">SNMP_ERR_NOSUCHNAME</span><span class="p">;</span>
 	<span class="k">break</span><span class="p">;</span>
<span class="n">diff</span> <span class="o">-</span><span class="n">uNr</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_core</span><span class="p">.</span><span class="n">c</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_core</span><span class="p">.</span><span class="n">c</span>
<span class="o">---</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">old</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_core</span><span class="p">.</span><span class="n">c</span>	<span class="mi">2008</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">05</span> <span class="mo">07</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span><span class="mf">13.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="o">+++</span> <span class="n">squid</span><span class="o">-</span><span class="mf">2.7</span><span class="p">.</span><span class="n">STABLE9</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">snmp_core</span><span class="p">.</span><span class="n">c</span>	<span class="mi">2011</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">23</span> <span class="mi">20</span><span class="o">:</span><span class="mi">36</span><span class="o">:</span><span class="mf">54.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">321</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">321</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
 						<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
 						    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_Inst</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
 					    <span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="o">-</span>						<span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
<span class="o">+</span>						<span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
 						<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
 						    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
 						<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">351</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">351</span><span class="p">,</span><span class="mi">8</span> <span class="err">@@</span>
 						<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
 						    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
 						<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
<span class="o">+</span>                                                    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="o">+</span>                                                <span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
 						    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">))),</span>
 					<span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
 					    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
</code></pre></div>
<p>制作练完了，再练一次使用：</p>
<div class="highlight"><pre><code class="bash"><span class="nb">cd </span>squid-2.7.STABLE9-old
mv ../squid-snmp.patch .
patch -p1 &lt; squid-snmp.patch
</code></pre></div>
<p>-p指定从那层目录开始，因为之前diff的时候顶层目录分别叫old和new，如果在其他地方时候的话，别人的目录肯定不会这么命名的，所以就往里进一层，然后用-p1来patch。
然后more一下那三个文件，确认都修改了~
最后回退patch：</p>
<div class="highlight"><pre><code class="bash">patch -R -p1 &lt; squid-snmp.patch
</code></pre></div>
<p>完成~</p>
      <a href="/2011/06/23/make-patch-of-squid-snmp" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/22/extend-open_conn-output-support-to-squid-snmp" title="给squid的snmp增加open_conn输出" rel="bookmark">给squid的snmp增加open_conn输出</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-22 00:00:00 +0800">22 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>做反向代理的squid集群监控，在单机维护时，squidclient mgr:server_list里的OPEN CONNS是经常看的一项数据，不过在开启snmp支持后，在mib里却没有找到相关的数据。还一度怀疑是不是cachePeerKeepAlRecv或者cachePeerKeepSent。今天想起来去src里grep了一把源码，顺利的在squid/src/neighbors.c里看到了OPEN CONNS等数据的来源，如下：</p>
<div class="highlight"><pre><code class="c"><span class="k">static</span> <span class="kt">void</span>
<span class="nf">dump_peers</span><span class="p">(</span><span class="n">StoreEntry</span> <span class="o">*</span> <span class="n">sentry</span><span class="p">,</span> <span class="n">peer</span> <span class="o">*</span> <span class="n">peers</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">peer</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="err">……</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">peers</span><span class="p">;</span> <span class="n">e</span><span class="p">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<span class="err">……</span>
        <span class="n">storeAppendPrintf</span><span class="p">(</span><span class="n">sentry</span><span class="p">,</span> <span class="s">&quot;OPEN CONNS : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">conn_open</span><span class="p">);</span>
<span class="err">……</span>
        <span class="n">storeAppendPrintf</span><span class="p">(</span><span class="n">sentry</span><span class="p">,</span> <span class="s">&quot;keep-alive ratio: %d%%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">percent</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">n_keepalives_recv</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">n_keepalives_sent</span><span class="p">));</span>
</code></pre></div>
<p>然后在squid/src/snmp_agent.c里看到了这些数据的snmp输出，如下：</p>
<div class="highlight"><pre><code class="c"><span class="n">variable_list</span> <span class="o">*</span>
<span class="nf">snmp_meshPtblFn</span><span class="p">(</span><span class="n">variable_list</span> <span class="o">*</span> <span class="n">Var</span><span class="p">,</span> <span class="n">snint</span> <span class="o">*</span> <span class="n">ErrP</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">variable_list</span> <span class="o">*</span><span class="n">Answer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="n">laddr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">loop</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">peer</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="err">……</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">MESH_PTBL_NAME</span>:
        <span class="n">cp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">);</span>
<span class="err">……</span>
    <span class="k">case</span> <span class="n">MESH_PTBL_KEEPAL_R</span>:
        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new_integer</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">,</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">n_keepalives_recv</span><span class="p">,</span>
            <span class="n">SMI_COUNTER32</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">MESH_PTBL_INDEX</span>:
        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new_integer</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">,</span>
            <span class="n">index</span><span class="p">,</span>
            <span class="n">ASN_INTEGER</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
        <span class="o">*</span><span class="n">ErrP</span> <span class="o">=</span> <span class="n">SNMP_ERR_NOSUCHNAME</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">Answer</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>一对比，发现确实没有stats.conn_open输出……
好在这个比较简单，稍微改一下，就能搞出来：
1、修改squid/include/cache_snmp.h如下：</p>
<div class="highlight"><pre><code class="c"><span class="k">enum</span> <span class="p">{</span>                          <span class="cm">/* cachePeerTable */</span>
<span class="err">……</span>
    <span class="n">MESH_PTBL_CONN_OPEN</span><span class="p">,</span>   <span class="cm">/*新增这个*/</span>
    <span class="n">MESH_PTBL_HOST</span><span class="p">,</span>
    <span class="n">MESH_PTBL_END</span>
<span class="p">};</span>
</code></pre></div>
<p>2、修改squid/src/snmp_core.c如下：</p>
<div class="highlight"><pre><code class="c"><span class="kt">void</span>
<span class="nf">snmpInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="err">……</span>
                                            <span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="cm">/* LEN_SQ_MESH + 2, NULL, NULL, 15,这里改成16，大概在324行，通过原来的MIB知道有15的地方就两个，peer的是后一个 */</span>
                                                <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
<span class="err">……</span>
                                                <span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
                                                    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                                <span class="n">snmpAddNode</span><span class="p">(</span><span class="n">snmpCreateOid</span><span class="p">(</span><span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SQ_MESH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="cm">/*新增这个16*/</span>
                                                    <span class="n">LEN_SQ_MESH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">snmp_meshPtblFn</span><span class="p">,</span> <span class="n">peer_InstIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">))),</span>
</code></pre></div>
<p>3、修改squid/src/snmp_agent.c如下：</p>
<div class="highlight"><pre><code class="c"><span class="err">……</span>
    <span class="k">case</span> <span class="n">MESH_PTBL_INDEX</span>:
        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new_integer</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">,</span>
            <span class="n">index</span><span class="p">,</span>
            <span class="n">ASN_INTEGER</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
<span class="cm">/*新增下面这段，case的内容在第1步cache_snmp.h里增加了；stats.conn_open由之前grep的结果得知；INTEGER是数值类型，照抄RTT的即可*/</span>
    <span class="k">case</span> <span class="n">MESH_PTBL_CONN_OPEN</span>:
        <span class="n">Answer</span> <span class="o">=</span> <span class="n">snmp_var_new_integer</span><span class="p">(</span><span class="n">Var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Var</span><span class="o">-&gt;</span><span class="n">name_length</span><span class="p">,</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">conn_open</span><span class="p">,</span>
            <span class="n">ASN_INTEGER</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
</code></pre></div>
<p>4、重新编译squid，然后用snmpwalk获取数据观察：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@naigos myops<span class="o">]</span><span class="c"># snmpwalk -v 2c -c cacti_china 10.168.168.69 .1.3.6.1.4.1.3495.1.5.1.2  -Cc  | tail</span>
SNMPv2-SMI::enterprises.3495.1.5.1.2.13.3 <span class="o">=</span> Counter32: 0
SNMPv2-SMI::enterprises.3495.1.5.1.2.14.1 <span class="o">=</span> INTEGER: 1
SNMPv2-SMI::enterprises.3495.1.5.1.2.14.2 <span class="o">=</span> INTEGER: 2
SNMPv2-SMI::enterprises.3495.1.5.1.2.14.3 <span class="o">=</span> INTEGER: 3
SNMPv2-SMI::enterprises.3495.1.5.1.2.15.1 <span class="o">=</span> INTEGER: 3
SNMPv2-SMI::enterprises.3495.1.5.1.2.15.2 <span class="o">=</span> INTEGER: 5
SNMPv2-SMI::enterprises.3495.1.5.1.2.15.3 <span class="o">=</span> INTEGER: 6
SNMPv2-SMI::enterprises.3495.1.5.1.2.16.1 <span class="o">=</span> STRING: <span class="s2">&quot;10.168.170.43&quot;</span>
SNMPv2-SMI::enterprises.3495.1.5.1.2.16.2 <span class="o">=</span> STRING: <span class="s2">&quot;10.168.168.73&quot;</span>
SNMPv2-SMI::enterprises.3495.1.5.1.2.16.3 <span class="o">=</span> STRING: <span class="s2">&quot;10.168.168.122&quot;</span>
</code></pre></div>
<p>原来的SNMPv2-SMI::enterprises.3495.1.5.1.2.15.1 = STRING: &ldquo;10.168.170.43&rdquo;变成了SNMPv2-SMI::enterprises.3495.1.5.1.2.16.1 = STRING: &ldquo;10.168.170.43&rdquo;，而SNMPv2-SMI::enterprises.3495.1.5.1.2.15.1 = INTEGER: 3就是需要的open_conn数据了！</p>
      <a href="/2011/06/22/extend-open_conn-output-support-to-squid-snmp" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/06/14/intro-mybench" title="mysql测试小工具mybench试用" rel="bookmark">mysql测试小工具mybench试用</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-06-14 00:00:00 +0800">14 Jun 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#testing-ref" title="testing" rel="category tag">testing</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>小型的mysql测试工具，主要有自带的mysqlslap、super-smack和mybench。嗯，我这里的小型的意思是指工具安装过程简单。
mysqlslap的使用方法遍地都是，就不先详细写了。根据个人偏好写写mybench吧，毕竟是perl的。
安装很简单，如下：</p>
<div class="highlight"><pre><code class="bash">cpanm DBI DBD::mysql Time::HiRes
wget http://jeremy.zawodny.com/mysql/mybench/mybench-1.0.tar.gz
tar zxvf mybench-1.0.tar.gz
<span class="nb">cd </span>mybench-1.0
perl MakeFile.PL <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make install
</code></pre></div>
<p>但是使用就不是太简单了——mysqlslap会自己生成（-a选项）sql，super-smack则带了一个gen-data程序生成数据然后自动导入，但是mybench没有，所以只能自己搞定数据。
不过mybench还是自己生成了一个测试模版的脚本在/usr/bin/bench_example，很简单的就知道怎么做了。
example如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="nb">eval</span> <span class="s">&#39;exec /usr/bin/perl -w -S $0 ${1+&quot;$@&quot;}&#39;</span>
    <span class="k">if</span> <span class="mi">0</span><span class="p">;</span> <span class="c1"># not running under some shell</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">MyBench</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Std</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Time::</span><span class="n">HiRes</span> <span class="sx">qw(gettimeofday tv_interval)</span><span class="p">;</span>
<span class="k">use</span> <span class="n">DBI</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%opt</span><span class="p">;</span>
<span class="nn">Getopt::Std::</span><span class="n">getopt</span><span class="p">(</span><span class="s">&#39;n:r:h:&#39;</span><span class="p">,</span> <span class="o">\</span><span class="nv">%opt</span><span class="p">);</span>
<span class="c1">#这是我见过的最hardcode的perl脚本了（呃，除了我自己写的垃圾），连db库、用户名、密码都不给运行参数的</span>
<span class="k">my</span> <span class="nv">$num_kids</span>  <span class="o">=</span> <span class="nv">$opt</span><span class="p">{</span><span class="n">n</span><span class="p">}</span> <span class="o">||</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$num_runs</span>  <span class="o">=</span> <span class="nv">$opt</span><span class="p">{</span><span class="n">r</span><span class="p">}</span> <span class="o">||</span> <span class="mi">100</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$db</span>        <span class="o">=</span> <span class="s">&quot;test&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$user</span>      <span class="o">=</span> <span class="s">&quot;test&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$pass</span>      <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$port</span>      <span class="o">=</span> <span class="mi">3306</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$host</span>      <span class="o">=</span> <span class="nv">$opt</span><span class="p">{</span><span class="n">h</span><span class="p">}</span> <span class="o">||</span> <span class="s">&quot;192.168.0.1&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$dsn</span>       <span class="o">=</span> <span class="s">&quot;DBI:mysql:$db:$host;port=$port&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$callback</span> <span class="o">=</span> <span class="k">sub</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$id</span>  <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$dbh</span> <span class="o">=</span> <span class="n">DBI</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span><span class="nv">$dsn</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$pass</span><span class="p">,</span> <span class="p">{</span> <span class="n">RaiseError</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">});</span>
<span class="c1">#为测试准备的请求，测select就写select，测insert就写insert呗~</span>
<span class="c1">#如果不修改，也就是说测试用的是test.mytable表，而且必须有一个列叫id</span>
    <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&quot;SELECT * FROM mytable WHERE ID = ?&quot;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@times</span> <span class="o">=</span> <span class="p">();</span>
    <span class="c1">## wait for the parent to HUP me</span>
    <span class="nb">local</span> <span class="nv">$SIG</span><span class="p">{</span><span class="n">HUP</span><span class="p">}</span> <span class="o">=</span> <span class="k">sub </span><span class="p">{</span> <span class="p">};</span>
    <span class="nb">sleep</span> <span class="mi">600</span><span class="p">;</span>
<span class="c1">#脚本定义的每个进程执行多少次请求</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">$cnt</span> <span class="o">&lt;</span> <span class="nv">$num_runs</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">100_000</span><span class="p">));</span>
        <span class="c1">## time the query</span>
        <span class="k">my</span> <span class="nv">$t0</span> <span class="o">=</span> <span class="p">[</span><span class="n">gettimeofday</span><span class="p">];</span>
<span class="c1">#真正的执行sql请求，通过上面的rand知道，之前准备的test.mytable的id列必须是int格式，同时不少于10w行（又一处hard）</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$v</span><span class="p">);</span>
<span class="c1">#通过前后两次gettimeofday获得sql的exec耗时</span>
        <span class="k">my</span> <span class="nv">$t1</span> <span class="o">=</span> <span class="n">tv_interval</span><span class="p">(</span><span class="nv">$t0</span><span class="p">,</span> <span class="p">[</span><span class="n">gettimeofday</span><span class="p">]);</span>
<span class="c1">#完成一次请求执行，加入数组</span>
        <span class="nb">push</span> <span class="nv">@times</span><span class="p">,</span> <span class="nv">$t1</span><span class="p">;</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">();</span>
        <span class="nv">$cnt</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">## cleanup</span>
    <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">();</span>
<span class="c1">#计算本进程全部请求的各项数据，几个大小和均来自MyBench模块</span>
    <span class="k">my</span> <span class="nv">@r</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nb">scalar</span><span class="p">(</span><span class="nv">@times</span><span class="p">),</span> <span class="n">min</span><span class="p">(</span><span class="nv">@times</span><span class="p">),</span> <span class="n">max</span><span class="p">(</span><span class="nv">@times</span><span class="p">),</span> <span class="n">avg</span><span class="p">(</span><span class="nv">@times</span><span class="p">),</span> <span class="n">tot</span><span class="p">(</span><span class="nv">@times</span><span class="p">));</span>
    <span class="k">return</span> <span class="nv">@r</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">#将上面这个函数交给MyBench模块的fork_and_work执行，即并发指定数量请求，返回总的结果</span>
<span class="k">my</span> <span class="nv">@results</span> <span class="o">=</span> <span class="nn">MyBench::</span><span class="n">fork_and_work</span><span class="p">(</span><span class="nv">$num_kids</span><span class="p">,</span> <span class="nv">$callback</span><span class="p">);</span>
<span class="c1">#计算总的数据</span>
<span class="nn">MyBench::</span><span class="n">compute_results</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="nv">@results</span><span class="p">);</span>
<span class="nb">exit</span><span class="p">;</span>
<span class="cp">__END__</span>
</code></pre></div>
<p>然后看看/usr/lib/perl5/site_perl/5.8.8/MyBench.pm，主要内容就是fork和compute：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="n">MyBench</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="nv">$</span><span class="nn">main::</span><span class="nv">VERSION</span> <span class="o">=</span> <span class="s">&#39;1.0&#39;</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Exporter</span><span class="p">;</span>
<span class="nv">@</span><span class="nn">MyBench::</span><span class="nv">ISA</span> <span class="o">=</span> <span class="s">&#39;Exporter&#39;</span><span class="p">;</span>
<span class="c1">#导出求最大值、最小值、平均值、综合值的函数给外面用</span>
<span class="nv">@</span><span class="nn">MyBench::</span><span class="nv">EXPORT</span> <span class="o">=</span> <span class="sx">qw(max min avg tot)</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">fork_and_work</span><span class="p">($$)</span>
<span class="p">{</span>
<span class="c1">#关闭输出缓冲</span>
    <span class="vg">$|</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">IO::</span><span class="n">Pipe</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">IO::</span><span class="n">Select</span><span class="p">;</span>
    <span class="nv">$SIG</span><span class="p">{</span><span class="n">CHLD</span><span class="p">}</span> <span class="o">=</span> <span class="s">&#39;IGNORE&#39;</span><span class="p">;</span>      <span class="c1">## let the kids die</span>
    <span class="k">my</span> <span class="nv">$kids_to_fork</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$callback</span>     <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$num_kids</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@pipes</span>        <span class="o">=</span> <span class="p">();</span>
    <span class="k">my</span> <span class="nv">@pids</span>         <span class="o">=</span> <span class="p">();</span>
    <span class="k">my</span> <span class="nv">$pid</span>          <span class="o">=</span> <span class="nb">undef</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;forking: &quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">$num_kids</span> <span class="o">&lt;</span> <span class="nv">$kids_to_fork</span><span class="p">)</span>
    <span class="p">{</span>
<span class="c1">#用IO::Pipe管道方式来传递父子进程的信息</span>
        <span class="k">my</span> <span class="nv">$pipe</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">IO::</span><span class="n">Pipe</span><span class="p">;</span>
<span class="c1">#fork进程开始</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$pid</span> <span class="o">=</span> <span class="nb">fork</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="c1">## parent</span>
            <span class="nv">$num_kids</span><span class="o">++</span><span class="p">;</span>
<span class="c1">#每fork完成一个打印一个+号</span>
            <span class="k">print</span> <span class="s">&quot;+&quot;</span><span class="p">;</span>
<span class="c1">#从管道中读取数据</span>
            <span class="nv">$pipe</span><span class="o">-&gt;</span><span class="n">reader</span><span class="p">();</span>
            <span class="nb">push</span> <span class="nv">@pipes</span><span class="p">,</span> <span class="nv">$pipe</span><span class="p">;</span>
            <span class="nb">push</span> <span class="nv">@pids</span><span class="p">,</span>  <span class="nv">$pid</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">elsif</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$pid</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">## child</span>
<span class="c1">#打开管道写入数据的功能</span>
            <span class="nv">$pipe</span><span class="o">-&gt;</span><span class="n">writer</span><span class="p">();</span>
<span class="c1">#执行select_example脚本传入的mysql请求测试函数</span>
            <span class="k">my</span> <span class="nv">@result</span> <span class="o">=</span> <span class="nv">$callback</span><span class="o">-&gt;</span><span class="p">(</span><span class="nv">$num_kids</span><span class="p">);</span>
<span class="c1">#把结果写入管道</span>
            <span class="k">print</span> <span class="nv">$pipe</span> <span class="s">&quot;@result\n&quot;</span><span class="p">;</span>
<span class="c1">#关闭管道</span>
            <span class="nv">$pipe</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">();</span>
            <span class="nb">exit</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">print</span> <span class="s">&quot;fork failed: $!\n&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">print</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
    <span class="c1">## give them a bit of time to setup</span>
    <span class="k">my</span> <span class="nv">$time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nv">$num_kids</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;sleeping for $time seconds while kids get ready\n&quot;</span><span class="p">;</span>
    <span class="nb">sleep</span> <span class="nv">$time</span><span class="p">;</span>
 <span class="c1">#发送SIGHUP信号给callback函数</span>
    <span class="nb">kill</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">@pids</span><span class="p">;</span>
    <span class="c1">## collect the results</span>
    <span class="k">my</span> <span class="nv">@results</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;waiting: &quot;</span><span class="p">;</span>
<span class="c1">#从管道中读取数据到数组</span>
    <span class="k">for</span> <span class="k">my</span> <span class="nv">$pipe</span> <span class="p">(</span><span class="nv">@pipes</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="sr">&lt;$pipe&gt;</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@results</span><span class="p">,</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="nv">$pipe</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">();</span>
        <span class="k">print</span> <span class="s">&quot;-&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">print</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">@results</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">compute_results</span><span class="p">(@)</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$recs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$Cnt</span><span class="p">,</span> <span class="nv">$Min</span><span class="p">,</span> <span class="nv">$Max</span><span class="p">,</span> <span class="nv">$Avg</span><span class="p">,</span> <span class="nv">$Tot</span><span class="p">,</span> <span class="nv">@Min</span><span class="p">,</span> <span class="nv">@Max</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">@_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">## 6 elements per record</span>
        <span class="k">my</span> <span class="nv">$rec</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span> <span class="nb">chomp</span> <span class="nv">$rec</span><span class="p">;</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$cnt</span><span class="p">,</span> <span class="nv">$min</span><span class="p">,</span> <span class="nv">$max</span><span class="p">,</span> <span class="nv">$avg</span><span class="p">,</span> <span class="nv">$tot</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span> <span class="sr">/\s+/</span><span class="p">,</span> <span class="nv">$rec</span><span class="p">;</span>
        <span class="nv">$Cnt</span> <span class="o">+=</span> <span class="nv">$cnt</span><span class="p">;</span>
        <span class="nv">$Avg</span> <span class="o">+=</span> <span class="nv">$avg</span><span class="p">;</span>
        <span class="nv">$Tot</span> <span class="o">+=</span> <span class="nv">$tot</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@Min</span><span class="p">,</span> <span class="nv">$min</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@Max</span><span class="p">,</span> <span class="nv">$max</span><span class="p">;</span>
        <span class="nv">$recs</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$Avg</span> <span class="o">=</span> <span class="nv">$Avg</span> <span class="o">/</span> <span class="nv">$recs</span><span class="p">;</span>
    <span class="nv">$Min</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="nv">@Min</span><span class="p">);</span>
    <span class="nv">$Max</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="nv">@Max</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$Qps</span> <span class="o">=</span> <span class="nv">$Cnt</span> <span class="sr">/ ($Tot /</span> <span class="nv">$recs</span><span class="p">);</span>
    <span class="k">print</span> <span class="s">&quot;$name: $Cnt $Min $Max $Avg $Tot $Qps\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  clients : $recs\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  queries : $Cnt\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  fastest : $Min\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  slowest : $Max\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  average : $Avg\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  serial  : $Tot\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;  q/sec   : $Qps\n&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">## some numerical helper functions for arrays</span>
<span class="k">sub </span><span class="nf">max</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">@_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span> <span class="o">&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$val</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">min</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">@_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span> <span class="o">&lt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$val</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">avg</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$tot</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">@_</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$tot</span> <span class="o">+=</span> <span class="nv">$_</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$tot</span> <span class="o">/</span> <span class="nv">@_</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">tot</span>
<span class="p">{</span>
    <span class="k">my</span> <span class="nv">$tot</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">@_</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$tot</span> <span class="o">+=</span> <span class="nv">$_</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$tot</span><span class="p">;</span>
<span class="p">}</span>
<span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>好了，开始准备数据，比较懒，直接用super-smack的gen-data先出了一些./gen-data  -n 100000 -f %n,%80-12s%12n,%512-512s,%d &gt; /root/data，然后进mysql里执行：</p>
<div class="highlight"><pre><code class="mysql"><span class="k">USE</span> <span class="n">test</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nf">mytable</span> <span class="p">(</span><span class="n">id</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="kp">AUTO_INCREMENT</span><span class="p">,</span> <span class="n">col1</span> <span class="kt">CHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">col2</span> <span class="kt">CHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">col3</span> <span class="kt">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">)</span><span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="k">LOAD</span> <span class="n">DATA</span> <span class="n">LOCAL</span> <span class="k">INFILE</span> <span class="s1">&#39;data&#39;</span> <span class="k">REPLACE</span> <span class="k">INTO</span> <span class="k">TABLE</span> <span class="s1">&#39;mytable&#39;</span> <span class="n">FIELDS</span> <span class="k">TERMINATED</span> <span class="k">BY</span> <span class="s1">&#39;,&#39;</span> <span class="k">LINES</span> <span class="k">TERMINATED</span> <span class="k">BY</span> <span class="s1">&#39;\n&#39;</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="nf">mytable</span> <span class="p">(</span><span class="n">col1</span><span class="p">,</span><span class="n">col2</span><span class="p">,</span><span class="n">col3</span><span class="p">)</span> <span class="k">SELECT</span> <span class="n">col1</span><span class="p">,</span><span class="n">col2</span><span class="p">,</span><span class="n">col3</span> <span class="k">FROM</span> <span class="n">mytable</span><span class="p">;</span>
</code></pre></div>
<p>最后执行./select_bench -h 10.168.170.92 -n 10 -r 1000就能看到结果了：
forking: ++++++++++
sleeping for 2 seconds while kids get ready
waiting: &mdash;&mdash;&mdash;-
test: 10000 0.00017 0.006809 0.0010413514 10.413514 9602.9063772325
  clients : 10
  queries : 10000
  fastest : 0.00017
  slowest : 0.006809
  average : 0.0010413514
  serial  : 10.413514
  q/sec   : 9602.9063772325</p>
      <a href="/2011/06/14/intro-mybench" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page5">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page active">
      <a href="#">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li>
      <a href="/page7">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.icylife.net/blog/" title="">心路</a></li>
              <li><a href="http://dbahacker.com/" title="TB 杨德华">DBA Hacker</a></li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.laird-sa.com/" title="">Laird-SA</a></li>
              <li><a href="http://www.linuxsee.com/" title="">LinuxSEE</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://www.puppeter.cn/" title="">piol</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.sanote.org/" title="">sa note</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://blog.ops.tudou.com/wp/" title="">土豆运营团队</a></li>
              <li><a href="http://www.91tuanfang.com/" title="安居客运维">家欣的天空</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://www.opboy.com" title="">运维小子</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://l09.me/" title="风声">风声</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://mooser.me/" title="牛氓">牛氓</a></li>
              <li><a href="http://http://www.yinwang.org/" title="当然我在扯淡">当然我在扯淡</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://muxueqz.laou.me" title="muxueqz">聊逍遥兮容与</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://paperplane.ruhoh.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.sectop.org/" title="">kindle</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
          </ul>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
