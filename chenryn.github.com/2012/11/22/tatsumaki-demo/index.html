<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>用 Tatsumaki 框架写 elasticsearch 界面</title>
    
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
            
            
            
  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://feed.feedsky.com/chenlinux" rel="alternate" /><a href="http://feed.feedsky.com/chenlinux" target="_blank">RSS订阅</a></li>
            <li><a href="/links.html">友情链接</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
        
<div class="row">
  <div class="page-header">
    <h1>用 Tatsumaki 框架写 elasticsearch 界面 <small></small></h1>
    <div class="date"><span>22 November 2012</span></div>
  
    <ul class="tag_box pull-right">
    
    
  
     
    	<li><a href="/tags.html#perl-ref">perl <span>52</span></a></li>
     
    	<li><a href="/tags.html#javascript-ref">javascript <span>5</span></a></li>
     
    	<li><a href="/tags.html#amcharts-ref">amcharts <span>4</span></a></li>
    
  
    </ul>
    
  </div>
  <div style='background-color: #FFF;'>
    <p>Tatsumaki是Plack作者的一个小框架，亮点是很好的利用了psgi.streaming的接口可以async的完成响应。不过因为缺少周边支持，所以除了几个webchat的example，似乎没看到什么应用。笔者之前纯为练手，却用tatsumaki写了个sync响应的小demo，算是展示一下用tatsuamki做普通web应用的基础步骤吧：</p>
<p>(代码本来是作为一个ElasticSearch数据分析的平台，不过后来发现社区有人开始做纯js的内嵌进ElasticSearch的plugin了，所以撤了repo，这里贴下代码)</p>
<ul>
  <li>所有的psgi/plack应用都一样有自己的app.psgi文件：</li>
</ul>
<div class="highlight"><pre><code class="perl"><span class="k">our</span> <span class="nv">$VERSION</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>
<span class="c1">### app.psgi</span>
<span class="k">use</span> <span class="nn">Tatsumaki::</span><span class="n">Error</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Tatsumaki::</span><span class="n">Application</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Tatsumaki::</span><span class="n">HTTPClient</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Tatsumaki::</span><span class="n">Server</span><span class="p">;</span>
<span class="c1">### read config</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Basename</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">YAML::</span><span class="n">Syck</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$config</span> <span class="o">=</span> <span class="n">LoadFile</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s">&#39;/config.yml&#39;</span><span class="p">);</span>
<span class="c1">### elasticsearch init</span>
<span class="k">use</span> <span class="n">ElasticSearch</span><span class="p">;</span>
<span class="c1">#这里yml的写法借鉴Dancer::Plugin::ElasticSearch了</span>
<span class="k">my</span> <span class="nv">$elsearch</span> <span class="o">=</span> <span class="n">ElasticSearch</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;options&#39;</span><span class="p">}</span> <span class="p">);</span>
<span class="c1">### index init</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(strftime)</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$index</span> <span class="o">=</span> <span class="nb">join</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="p">(</span> <span class="p">(</span><span class="o">+</span><span class="nb">split</span><span class="p">(</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;index&#39;</span><span class="p">}</span> <span class="p">))[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strftime</span><span class="p">(</span> <span class="p">(</span><span class="o">+</span><span class="nb">split</span><span class="p">(</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;index&#39;</span><span class="p">}</span> <span class="p">))[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">localtime</span> <span class="p">)</span> <span class="p">);</span>
<span class="k">my</span> <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">};</span>
<span class="c1">#首页类，调用了模板</span>
<span class="nb">package</span> <span class="n">MainHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(Tatsumaki::Handler)</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">get</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;index.html&#39;</span><span class="p">);</span>
<span class="p">};</span>
<span class="c1">#具体的API类</span>
<span class="nb">package</span> <span class="n">ListHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(Tatsumaki::Handler)</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">get</span> <span class="p">{</span>
<span class="c1">#这里自动把urlpath切分好了</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$self</span><span class="p">,</span> <span class="nv">$group</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$interval</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">return</span> <span class="s">&#39;Not valid order&#39;</span> <span class="k">unless</span> <span class="nv">$order</span> <span class="ow">eq</span> <span class="s">&#39;count&#39;</span> <span class="ow">or</span> <span class="nv">$order</span> <span class="ow">eq</span> <span class="s">&#39;mean&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="s">&#39;Not valid interval&#39;</span> <span class="k">unless</span> <span class="nv">$interval</span> <span class="o">=~</span> <span class="n">m</span><span class="c1">#\d+(h|m|s)#;</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$key_field</span><span class="p">,</span> <span class="nv">$value_field</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$group</span> <span class="ow">eq</span> <span class="s">&#39;url&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$key_field</span> <span class="o">=</span> <span class="s">&#39;url&#39;</span><span class="p">;</span>
        <span class="nv">$value_field</span> <span class="o">=</span> <span class="s">&#39;responsetime&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$group</span> <span class="ow">eq</span> <span class="s">&#39;ip&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$key_field</span> <span class="o">=</span> <span class="s">&#39;oh&#39;</span><span class="p">;</span>
        <span class="nv">$value_field</span> <span class="o">=</span> <span class="s">&#39;upstreamtime&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#39;Not valid group field&#39;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="c1"># get index mapping and sort into array</span>
    <span class="k">my</span> <span class="nv">$mapping</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">(</span>
        <span class="nb">index</span> <span class="o">=&gt;</span> <span class="s">&quot;$index&quot;</span><span class="p">,</span>
        <span class="n">type</span>  <span class="o">=&gt;</span> <span class="s">&quot;$type&quot;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">@res_map</span><span class="p">;</span>
    <span class="k">for</span> <span class="k">my</span> <span class="nv">$property</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span> <span class="nv">$mapping</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$type</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$property</span> <span class="ow">eq</span> <span class="s">&#39;@fields&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">@fields</span><span class="p">;</span>
            <span class="nb">push</span> <span class="nv">@fields</span><span class="p">,</span> <span class="p">{</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="p">,</span> <span class="n">type</span> <span class="o">=&gt;</span> <span class="nv">$mapping</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$type</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$property</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$_</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">}</span> <span class="p">}</span>
                <span class="k">for</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span> <span class="nv">$mapping</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$type</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$property</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span> <span class="p">};</span>
            <span class="nb">push</span> <span class="nv">@res_map</span><span class="p">,</span> <span class="o">\</span><span class="nv">@fields</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">push</span> <span class="nv">@res_map</span><span class="p">,</span> <span class="p">{</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">$property</span><span class="p">,</span> <span class="n">type</span> <span class="o">=&gt;</span> <span class="nv">$mapping</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$type</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$property</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">}</span> <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1"># get value stat group by key field</span>
    <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
        <span class="nb">index</span> <span class="o">=&gt;</span> <span class="s">&quot;$index&quot;</span><span class="p">,</span>
        <span class="n">type</span>  <span class="o">=&gt;</span> <span class="s">&quot;$type&quot;</span><span class="p">,</span>
        <span class="n">size</span>  <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">query</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&quot;range&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="s">&#39;@timestamp&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">from</span> <span class="o">=&gt;</span> <span class="s">&quot;now-$interval&quot;</span><span class="p">,</span>
                    <span class="n">to</span>   <span class="o">=&gt;</span> <span class="s">&quot;now&quot;</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="n">facets</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&quot;$group&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="s">&quot;terms_stats&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="s">&quot;value_field&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;$value_field&quot;</span><span class="p">,</span>
                    <span class="s">&quot;key_field&quot;</span>   <span class="o">=&gt;</span> <span class="s">&quot;$key_field&quot;</span><span class="p">,</span>
                    <span class="s">&quot;order&quot;</span>       <span class="o">=&gt;</span> <span class="s">&quot;$order&quot;</span><span class="p">,</span>
                    <span class="s">&quot;size&quot;</span>        <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">}</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">@res_tbl</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">facets</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$group&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">terms</span><span class="p">}}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$mean</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%.03f&quot;</span><span class="p">,</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">mean</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$code_count</span> <span class="o">=</span> <span class="n">code_count</span><span class="p">(</span><span class="nv">$key_field</span><span class="p">,</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$interval</span><span class="p">);</span>
        <span class="nb">push</span> <span class="nv">@res_tbl</span><span class="p">,</span> <span class="p">{</span>
            <span class="n">key</span>   <span class="o">=&gt;</span> <span class="nv">$key</span><span class="p">,</span>
            <span class="n">min</span>   <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">min</span><span class="p">},</span>
            <span class="n">max</span>   <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">max</span><span class="p">},</span>
            <span class="n">mean</span>  <span class="o">=&gt;</span> <span class="nv">$mean</span><span class="p">,</span>
            <span class="n">code</span>  <span class="o">=&gt;</span> <span class="nv">$code_count</span><span class="p">,</span>
            <span class="n">count</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">},</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="c1"># render可以接收参数，并且默认把$self带进去，具体key是handler</span>
    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;index.html&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">table</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@res_tbl</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@res_map</span> <span class="p">});</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">code_count</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$key_field</span><span class="p">,</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$interval</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
        <span class="nb">index</span> <span class="o">=&gt;</span> <span class="s">&quot;$index&quot;</span><span class="p">,</span>
        <span class="n">type</span>  <span class="o">=&gt;</span> <span class="s">&quot;$type&quot;</span><span class="p">,</span>
        <span class="n">size</span>  <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">query</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="n">range</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="s">&#39;@timestamp&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">from</span> <span class="o">=&gt;</span> <span class="s">&quot;now-$interval&quot;</span><span class="p">,</span>
                    <span class="n">to</span>   <span class="o">=&gt;</span> <span class="s">&quot;now&quot;</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="n">facets</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&quot;code&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">facet_filter</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">term</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="nv">$key_field</span> <span class="o">=&gt;</span> <span class="s">&quot;$key&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="n">terms</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">field</span> <span class="o">=&gt;</span> <span class="s">&quot;status&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">facets</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">code</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">terms</span><span class="p">}}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$result</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">}}</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">#画图数据API类，因为响应的是Ajax请求，所以这里开启了async，不过其实没意义了。因为这个ElasticSearch代码不是async格式的。应该改造用ElasticSearch::Transport::AEHTTP才能做到全程async。</span>
<span class="nb">package</span> <span class="n">ChartHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(Tatsumaki::Handler)</span><span class="p">;</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">asynchronous</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="k">use</span> <span class="n">JSON</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">post</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$api</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;api&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s">&#39;term&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s">&#39;oh&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;status&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s">&#39;200&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$field</span> <span class="o">=</span>  <span class="nv">$key</span> <span class="ow">eq</span> <span class="s">&#39;oh&#39;</span> <span class="p">?</span> <span class="s">&#39;upstreamtime&#39;</span> <span class="p">:</span> <span class="s">&#39;responsetime&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
        <span class="nb">index</span> <span class="o">=&gt;</span> <span class="s">&quot;$index&quot;</span><span class="p">,</span>
        <span class="n">type</span>  <span class="o">=&gt;</span> <span class="s">&quot;$type&quot;</span><span class="p">,</span>
        <span class="n">size</span>  <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">query</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="n">match_all</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="p">}</span>
        <span class="p">},</span>
        <span class="n">facets</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&quot;chart&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">facet_filter</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="ow">and</span> <span class="o">=&gt;</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="n">term</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                <span class="n">status</span> <span class="o">=&gt;</span> <span class="nv">$status</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="nv">$api</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">},</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="n">date_histogram</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">value_field</span> <span class="o">=&gt;</span> <span class="nv">$field</span><span class="p">,</span>
                    <span class="n">key_field</span> <span class="o">=&gt;</span> <span class="s">&#39;@timestamp&#39;</span><span class="p">,</span>
                    <span class="n">interval</span> <span class="o">=&gt;</span> <span class="s">&quot;1m&quot;</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">@result</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;facets&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;chart&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;entries&#39;</span><span class="p">}}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nb">push</span> <span class="nv">@result</span><span class="p">,</span> <span class="p">{</span>
           <span class="nb">time</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">},</span>
           <span class="n">count</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;count&#39;</span><span class="p">},</span>
           <span class="n">mean</span> <span class="o">=&gt;</span> <span class="nb">sprintf</span> <span class="s">&quot;%.3f&quot;</span><span class="p">,</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;mean&#39;</span><span class="p">}</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="n">header</span><span class="p">(</span><span class="s">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;application/json&#39;</span><span class="p">);</span>
    <span class="n">to_json</span><span class="p">(</span><span class="o">\</span><span class="nv">@result</span><span class="p">);</span>
<span class="p">};</span>
<span class="c1">#主函数</span>
<span class="nb">package</span> <span class="n">main</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Basename</span><span class="p">;</span>
<span class="c1">#通过Tatsumaki::Application绑定urlpath到不同的类上。注意下面listhandler那里用的正则捕获。对，上面类里传参就是这么来的。注意最多不超过$9。</span>
<span class="k">my</span> <span class="nv">$app</span> <span class="o">=</span> <span class="nn">Tatsumaki::</span><span class="n">Application</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">([</span>
    <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;MainHandler&#39;</span><span class="p">,</span>
    <span class="s">&#39;/api/chartdata&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;ChartHandler&#39;</span><span class="p">,</span>
    <span class="s">&#39;/api/(\w+)/(\w+)/(\w+)&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;ListHandler&#39;</span><span class="p">,</span>
<span class="p">]);</span>
<span class="c1">#指定template和static的路径。类似Dancer里的views和public</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="n">template_path</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s">&#39;/templates&#39;</span><span class="p">);</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="n">static_path</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s">&#39;/static&#39;</span><span class="p">);</span>
<span class="c1">#psgi app组建完成</span>
<span class="k">return</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="n">psgi_app</span><span class="p">;</span>
<span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>static里都是bootstrap的东西就不贴了。然后说说template。目前Tatsumaki只支持Text::MicroTemplate::File一种template，当然自己在handler里调用其他的template然后返回字符串也行。不过其实Text::MicroTemplate也蛮强大的。下面上例子：</p>
<div class="highlight"><pre><code class="html">%# 这就是Text::MicroTemplate强大的地方了，行首加个百分号就可以直接使用perl而不像TT那样尽量搞自己的语法
%# 配合render传来的handler(前面说了是类$self)，整个环境全可以任意调用。
% my $mapping = $_[0]-&gt;{&#39;mapping&#39;};
% my $table = $_[0]-&gt;{&#39;table&#39;};
%# 比如这里其实就是通过handler调用request了。
% my $group = $_[0]-&gt;{handler}-&gt;args-&gt;[0];
% my @codes = qw(200 206 302 304 400 403 404 499 502 503 504);
<span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span>
<span class="cp">        &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;title&gt;</span>Bubble -- a perl webui for logstash <span class="err">&amp;</span> elasticsearch<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/bootstrap/css/bootstrap.css&quot;</span> <span class="nt">&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/fontawesome/css/font-awesome.css&quot;</span> <span class="nt">&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/css/style.css&quot;</span> <span class="nt">&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/amcharts/style.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container-fluid&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row-fluid&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span3&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;well sidebar-nav&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav nav-list&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;nav-header&quot;</span><span class="nt">&gt;</span>查询<span class="nt">&lt;/li&gt;</span>
% for my $property ( @{ $mapping } ) {
%     if ( ref( $property ) eq &#39;ARRAY&#39; ) {
          <span class="nt">&lt;li&gt;</span>@fields<span class="nt">&lt;/li&gt;</span>
%          for ( @{$property} ) {
          <span class="nt">&lt;li&gt;</span>  - <span class="err">&lt;</span>%= $_-&gt;{&#39;name&#39;} %&gt; <span class="err">&lt;</span>%= $_-&gt;{&#39;type&#39;} %&gt;<span class="nt">&lt;/li&gt;</span>
%          }
%     } elsif ( $property-&gt;{&#39;type&#39;} ) {
          <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= $property-&gt;{&#39;name&#39;} %&gt; <span class="err">&lt;</span>%= $property-&gt;{&#39;type&#39;} %&gt;<span class="nt">&lt;/li&gt;</span>
%     }
% }
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span9&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;search&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;control-group&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;controls docs-input-sizes&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-small inline&quot;</span> <span class="na">id=</span><span class="s">&quot;esapi&quot;</span> <span class="na">name=</span><span class="s">&quot;api&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;option&gt;</span>匹配方式<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;option&gt;</span>prefix<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;option&gt;</span>term<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;option&gt;</span>text<span class="nt">&lt;/option&gt;</span>
            <span class="nt">&lt;/select&gt;</span>
            <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-small inline&quot;</span> <span class="na">id=</span><span class="s">&quot;eskey&quot;</span> <span class="na">name=</span><span class="s">&quot;key&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;option&gt;</span>查询列<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;option&gt;</span>oh<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;option&gt;</span>url<span class="nt">&lt;/option&gt;</span>
            <span class="nt">&lt;/select&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-big inline&quot;</span> <span class="na">id=</span><span class="s">&quot;esvalue&quot;</span> <span class="na">name=</span><span class="s">&quot;value&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;查询文本&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-small inline&quot;</span> <span class="na">id=</span><span class="s">&quot;esstatus&quot;</span> <span class="na">name=</span><span class="s">&quot;status&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;指定状态&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary&quot;</span> <span class="na">onclick=</span><span class="s">&quot;genchart()&quot;</span><span class="nt">&gt;</span>查看<span class="nt">&lt;/button&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chartdiv&quot;</span> <span class="na">style=</span><span class="s">&quot;display:none; width: 100%; height: 500px;&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;estable&quot;</span><span class="nt">&gt;</span>
% if ( $table ) {
        <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;table table-striped table-bordered table-condensed&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;thead&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
              <span class="nt">&lt;th&gt;</span><span class="err">&lt;</span>%= $group %&gt;<span class="nt">&lt;/th&gt;</span>
              <span class="nt">&lt;th&gt;</span>平均响应时间<span class="nt">&lt;/th&gt;</span>
              <span class="nt">&lt;th&gt;</span>最大响应时间<span class="nt">&lt;/th&gt;</span>
              <span class="nt">&lt;th&gt;</span>下载数<span class="nt">&lt;/th&gt;</span>
%     for ( @codes ) {
              <span class="nt">&lt;th&gt;</span><span class="err">&lt;</span>%= $_ %&gt;<span class="nt">&lt;/th&gt;</span>
%     }
            <span class="nt">&lt;/tr&gt;</span>
          <span class="nt">&lt;/thead&gt;</span>
          <span class="nt">&lt;tbody&gt;</span>
%     for my $list ( @{ $table } ) {
            <span class="nt">&lt;tr&gt;</span>
              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;key&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>
              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;mean&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>
              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;max&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>
              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;count&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>
%         for ( @codes ) {
%             if ( $list-&gt;{&#39;code&#39;}-&gt;{$_} ) {
              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;code&#39;}-&gt;{$_} %&gt;<span class="nt">&lt;/td&gt;</span>
%             } else {
              <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
%             }
%         }
            <span class="nt">&lt;/tr&gt;</span>
%     }
          <span class="nt">&lt;/tbody&gt;</span>
        <span class="nt">&lt;/table&gt;</span>
% }
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/javascripts/jquery-1.7.2.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/bootstrap/js/bootstrap.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/amcharts/amstock.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
  <span class="kd">var</span> <span class="nx">chart</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">chartProvider</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">function</span> <span class="nx">createStockChart</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmStockChart</span><span class="p">();</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">pathToImages</span> <span class="o">=</span> <span class="s2">&quot;/static/amcharts/images/&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">categoryAxesSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">CategoryAxesSettings</span><span class="p">();</span>
    <span class="nx">categoryAxesSettings</span><span class="p">.</span><span class="nx">parseDates</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">categoryAxesSettings</span><span class="p">.</span><span class="nx">minPeriod</span> <span class="o">=</span> <span class="s2">&quot;mm&quot;</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">categoryAxesSettings</span> <span class="o">=</span> <span class="nx">categoryAxesSettings</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">dataSet</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">DataSet</span><span class="p">();</span>
    <span class="nx">dataSet</span><span class="p">.</span><span class="nx">fieldMappings</span> <span class="o">=</span> <span class="p">[{</span>
      <span class="nx">fromField</span> <span class="o">:</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
      <span class="nx">toField</span> <span class="o">:</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="nx">fromField</span> <span class="o">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
      <span class="nx">toField</span> <span class="o">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="p">}];</span>
    <span class="nx">dataSet</span><span class="p">.</span><span class="nx">dataProvider</span> <span class="o">=</span> <span class="nx">chartProvider</span><span class="p">;</span>
    <span class="nx">dataSet</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">=</span> <span class="s2">&quot;date&quot;</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">dataSets</span> <span class="o">=</span> <span class="p">[</span><span class="nx">dataSet</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">stockPanel1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockPanel</span><span class="p">();</span>
    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">percentHeight</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">valueAxis1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>
    <span class="nx">valueAxis1</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">;</span>
    <span class="nx">valueAxis1</span><span class="p">.</span><span class="nx">axisColor</span> <span class="o">=</span> <span class="s2">&quot;#999999&quot;</span><span class="p">;</span>
    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis1</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">graph1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockGraph</span><span class="p">();</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">valueField</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">;</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;mean(ms)&quot;</span><span class="p">;</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;smoothedLine&quot;</span><span class="p">;</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">lineColor</span> <span class="o">=</span> <span class="s2">&quot;#999999&quot;</span><span class="p">;</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">useDataSetColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addStockGraph</span><span class="p">(</span><span class="nx">graph1</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">stockLegend1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockLegend</span><span class="p">();</span>
    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">stockLegend</span> <span class="o">=</span> <span class="nx">stockLegend1</span><span class="p">;</span>
    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">drawingIconsEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">stockPanel2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockPanel</span><span class="p">();</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">percentHeight</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">marginTop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">showCategoryAxis</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">valueAxis2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>
    <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">gridAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">axisThickness</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis2</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">graph2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockGraph</span><span class="p">();</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">valueAxis</span> <span class="o">=</span> <span class="nx">valueAxis2</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">valueField</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">balloonText</span> <span class="o">=</span> <span class="s2">&quot;[[value]]%&quot;</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;column&quot;</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">cornerRadiusTop</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">lineColor</span> <span class="o">=</span> <span class="s2">&quot;#FCD202&quot;</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">useDataSetColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">addStockGraph</span><span class="p">(</span><span class="nx">graph2</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">stockLegend2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockLegend</span><span class="p">();</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">stockLegend</span> <span class="o">=</span> <span class="nx">stockLegend2</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">panels</span> <span class="o">=</span> <span class="p">[</span><span class="nx">stockPanel1</span><span class="p">,</span> <span class="nx">stockPanel2</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">sbsettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartScrollbarSettings</span><span class="p">();</span>
    <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="nx">graph2</span><span class="p">;</span>
    <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">graphType</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span><span class="p">;</span>
    <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">chartScrollbarSettings</span> <span class="o">=</span> <span class="nx">sbsettings</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cursorSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartCursorSettings</span><span class="p">();</span>
    <span class="nx">cursorSettings</span><span class="p">.</span><span class="nx">valueBalloonsEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">chartCursorSettings</span> <span class="o">=</span> <span class="nx">cursorSettings</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#chartdiv&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;chartdiv&quot;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">genchart</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;/api/chartdata&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">api</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#esapi&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="nx">key</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#eskey&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="nx">status</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#esstatus&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="nx">value</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#esvalue&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">time</span><span class="p">);</span>
        <span class="nx">chartProvider</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
          <span class="nx">date</span><span class="o">:</span> <span class="nx">date</span><span class="p">,</span>
          <span class="nx">count</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">count</span><span class="p">,</span>
          <span class="nx">mean</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">mean</span><span class="p">,</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="nx">createStockChart</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">};</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>效果如下：</p>
<p><img src="/images/uploads/tatsumaki.png" alt="查询表格并提交最多次的url绘图" title="查询表格并提交最多次的url绘图" /></p>
<hr />
<p><strong>2012 年 12 月 30 日附注：</strong></p>
<p>更好的纯 js 版本已经作为独立的 elasticsearch-plugin 项目发布在 github 上。地址：<a href="https://github.com/chenryn/elasticsearch-logstash-faceter">https://github.com/chenryn/elasticsearch-logstash-faceter</a> 。欢迎大家试用!!</p>
    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2012/11/22/gnuplot-to-draw-multi-graph" title="用gnuplot绘制多图">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2012/12/01/convert-docx-to-markdown" title="把docx文档转换成markdown格式发布">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    
  <!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" id="UYScript" src="http://v1.uyan.cc/js/iframe.js?UYUserId=1589850" async=""></script>
<!-- UY END -->
  </div>
</div>
  
      </div>
      <div class="span4">
          
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
               
                 <li> <a href="/2013/03/15/puppet-provider-development">Puppet 自定义 Provider</a></li>
               
                 <li> <a href="/2013/03/14/JPush-example">极光推送demo</a></li>
               
                 <li> <a href="/2013/02/25/nginx-testing-10Gibps">Nginx 万兆网络环境测试</a></li>
               
                 <li> <a href="/2013/02/22/setup-stf2">STF 2.0 安装测试</a></li>
               
                 <li> <a href="/2013/01/31/puppet-define-type-and-custom-function">Puppet 自定义 type 和 function</a></li>
               
                 <li> <a href="/2013/01/11/systemtap-to-debug-kmsg-dump">用 systemtap 调试 kmsg dump</a></li>
               
                 <li> <a href="/2013/01/10/update-puppet-to-3.0">升级 Puppet 到 3.0 及其他附件简介</a></li>
               
                 <li> <a href="/2013/01/10/rspec-puppet-intro">给 puppet 写 Rspec 测试用例</a></li>
               
                 <li> <a href="/2013/01/06/limit-bandwidth-of-one-process">限制单个进程的带宽</a></li>
               
            </ul>
          </div>
        
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
