<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>用 Amcharts 和 ElasticSearch 做日志分析</title>
    
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
            
            
            
  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://feed.feedsky.com/chenlinux" rel="alternate" /><a href="http://feed.feedsky.com/chenlinux" target="_blank">RSS订阅</a></li>
            <li><a href="/links.html">友情链接</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
        
<div class="row">
  <div class="page-header">
    <h1>用 Amcharts 和 ElasticSearch 做日志分析 <small></small></h1>
    <div class="date"><span>22 December 2012</span></div>
  
    <ul class="tag_box pull-right">
    
    
  
     
    	<li><a href="/tags.html#amcharts-ref">amcharts <span>4</span></a></li>
     
    	<li><a href="/tags.html#elasticsearch-ref">elasticsearch <span>8</span></a></li>
     
    	<li><a href="/tags.html#javascript-ref">javascript <span>5</span></a></li>
    
  
    </ul>
    
  </div>
  <div style='background-color: #FFF;'>
    <p>之前有一篇从 ElasticSearch 官网摘下来的博客<a href="http://chenlinux.com/2012/11/18/data-visualization-with-elasticsearch-and-protovis">《【翻译】用ElasticSearch和Protovis实现数据可视化》</a>。不过一来 Protovis 已经过时，二来 不管是 Protovis 的进化品 D3 还是 Highchart 什么的，我觉得在多图方面都还不如 amcharts 好用。所以在最后依然选择了老牌的 amcharts 完成。</p>
<p>展示品的大概背景还是 webserver 日志，嗯，这个需求应该是最有代表性的了。我们需要对webserver的性能有所了解。之前有一篇文章<a href="http://chenlinux.com/2012/11/22/tatsumaki-demo/">《Tatsumaki框架的小demo一个》</a>，讲的是通过 <code>terms_stats</code> 获取固定时段内请求时间的平均值。其实这个demo是可以参照官网博客修改成纯js应用的。因为 Tatsumaki 在这里除了处理 HTTP 请求参数，什么都没干。而且这个demo目的是展示 perl 框架的处理，所以amchart方面直接就写死了各种变量。</p>
<p>但是还有一种需求，比如你需要的是针对某个情况超过某个百分比的分时走势统计。这时候必须多次请求 ES 来做运算，再让 js 做，不是说不行，但是多一倍数据在网络中传输，就不如在服务器端封装 API 了 —— 其实是我 js 太烂这种事情，我会告诉你们么。。。</p>
<p>先上两张效果图，其实这个布局我是从 facetgrapher 项目偷来的，但这个项目只适合比较不同 index 之间同时间段的数据，我建议作者修改，作者说&rdquo;我自己js也是半吊子水平&rdquo;。。。</p>
<p><img src="/images/uploads/amchart-column.png" alt="分地区错误情况统计" title="分地区错误情况统计" /></p>
<p><img src="/images/uploads/amchart-line.png" alt="实时分运营商错误比例统计" title="实时分运营商错误比例统计" /></p>
<p><strong>2013 年 2 月 21 日更新：利用 bullet 大小来表示 hasErr 的程度</strong></p>
<p>查询的 ES 库情况如下：</p>
<div class="highlight"><pre><code class="bash">    <span class="nv">$ </span>curl <span class="s2">&quot;http://10.4.16.68:9200/demo-photo/log/_mapping?pretty=1&quot;</span>
    <span class="o">{</span>
      <span class="s2">&quot;log&quot;</span> : <span class="o">{</span>
        <span class="s2">&quot;properties&quot;</span> : <span class="o">{</span>
          <span class="s2">&quot;brower&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;date&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;date&quot;</span>,
            <span class="s2">&quot;format&quot;</span> : <span class="s2">&quot;dateOptionalTime&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;fromArea&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>,
            <span class="s2">&quot;index&quot;</span> : <span class="s2">&quot;not_analyzed&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;hasErr&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;requestUrl&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>,
            <span class="s2">&quot;index&quot;</span> : <span class="s2">&quot;not_analyzed&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;timeCost&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;long&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;userId&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;xnforword&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="nv">$ </span>curl <span class="s2">&quot;http://10.4.16.68:9200/demo-photo/log/_search?pretty=1&amp;size=1&quot;</span> -d <span class="s1">&#39;{&quot;query&quot;:{&quot;match_all&quot;:{}}}&#39;</span>
    <span class="o">{</span>
      <span class="s2">&quot;took&quot;</span> : 14,
      <span class="s2">&quot;timed_out&quot;</span> : <span class="nb">false</span>,
      <span class="s2">&quot;_shards&quot;</span> : <span class="o">{</span>
        <span class="s2">&quot;total&quot;</span> : 10,
        <span class="s2">&quot;successful&quot;</span> : 10,
        <span class="s2">&quot;failed&quot;</span> : 0
      <span class="o">}</span>,
      <span class="s2">&quot;hits&quot;</span> : <span class="o">{</span>
        <span class="s2">&quot;total&quot;</span> : 2330679,
        <span class="s2">&quot;max_score&quot;</span> : 1.0,
        <span class="s2">&quot;hits&quot;</span> : <span class="o">[</span> <span class="o">{</span>
          <span class="s2">&quot;_index&quot;</span> : <span class="s2">&quot;demo-photo&quot;</span>,
          <span class="s2">&quot;_type&quot;</span> : <span class="s2">&quot;log&quot;</span>,
          <span class="s2">&quot;_id&quot;</span> : <span class="s2">&quot;iSI5xic7Qg2p9Sqk5yp-pQ&quot;</span>,
          <span class="s2">&quot;_score&quot;</span> : 1.0, <span class="s2">&quot;_source&quot;</span> : <span class="o">{</span><span class="s2">&quot;hasErr&quot;</span>:<span class="s2">&quot;false&quot;</span>,<span class="s2">&quot;date&quot;</span>:<span class="s2">&quot;2012-12-06T15:04:21,983&quot;</span>,<span class="s2">&quot;userId&quot;</span>:<span class="s2">&quot;123456789&quot;</span>,<span class="s2">&quot;requestUrl&quot;</span>:<span class="s2">&quot;http://photo.demo.domain.com/path/to/your/app/test.jpg&quot;</span>,<span class="s2">&quot;brower&quot;</span>:<span class="s2">&quot;chrome17.0.963.84&quot;</span>,<span class="s2">&quot;timeCost&quot;</span>:750,<span class="s2">&quot;xnforword&quot;</span>:<span class="o">[</span><span class="s2">&quot;192.168.1.123&quot;</span>,<span class="s2">&quot;10.10.10.10&quot;</span><span class="o">]</span>,<span class="s2">&quot;fromArea&quot;</span>:<span class="s2">&quot;CN-UNI-OTHER&quot;</span><span class="o">}</span>
        <span class="o">}</span> <span class="o">]</span>
      <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div>
<p>然后后台是我惯用的 Dancer 框架：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="n">AnalysisDemo</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">Ajax</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">ElasticSearch</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(strftime)</span><span class="p">;</span>
    <span class="nb">no</span>  <span class="n">warnings</span><span class="p">;</span>
    
    <span class="k">my</span> <span class="nv">$elsearch</span>         <span class="o">=</span> <span class="n">ElasticSearch</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="p">{</span> <span class="nv">%</span><span class="p">{</span> <span class="n">config</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">plugins</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ElasticSearch</span><span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$index_prefix</span>     <span class="o">=</span> <span class="s">&#39;demo-&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$type</span>             <span class="o">=</span> <span class="s">&#39;log&#39;</span><span class="p">;</span>
    <span class="c1"># 这里是对ip库的归类。数据是需要提前导入ES的，这可以是logstash发挥作用</span>
    <span class="k">my</span> <span class="nv">$default_provider</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">yidong</span>    <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(CN-CRN CN-CMN)</span><span class="p">],</span>
        <span class="n">jiaoyu</span>    <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(CN-CER CN-CST)</span><span class="p">],</span>
        <span class="n">dianxin</span>   <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(CN-CHN)</span><span class="p">],</span>
        <span class="n">liantong</span>  <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(CN-UNI CN-CNC)</span><span class="p">],</span>
        <span class="n">guangdian</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(CN-SCN)</span><span class="p">],</span>
        <span class="n">haiwai</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(OS)</span><span class="p">],</span>
    <span class="p">};</span>
    
    <span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="c1"># 通过 state API 获取 ES 集群现有的所有index列表</span>
        <span class="c1"># 因为是一个域名一个index，这样就有了前段页面上的域名下拉选择框</span>
        <span class="k">my</span> <span class="nv">$indices</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">cluster_state</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">routing_table</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">indices</span><span class="p">};</span>
        <span class="n">template</span> <span class="s">&#39;demo/chart&#39;</span><span class="p">,</span>
          <span class="p">{</span>
            <span class="n">providers</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%$default_provider</span> <span class="p">],</span>
            <span class="n">datasources</span> <span class="o">=&gt;</span>
              <span class="p">[</span> <span class="nb">grep</span> <span class="p">{</span> <span class="sr">/^$index_prefix/</span> <span class="o">&amp;&amp;</span> <span class="sr">s/$index_prefix//</span> <span class="p">}</span> <span class="nb">keys</span> <span class="nv">%$indices</span> <span class="p">],</span>
            <span class="n">inputfrom</span> <span class="o">=&gt;</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%F\T%T&quot;</span><span class="p">,</span> <span class="nb">localtime</span><span class="p">(</span><span class="nb">time</span><span class="p">()</span><span class="o">-</span><span class="mi">864000</span><span class="p">)),</span>
            <span class="n">inputto</span> <span class="o">=&gt;</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%F\T%T&quot;</span><span class="p">,</span> <span class="nb">localtime</span><span class="p">()),</span>
          <span class="p">};</span>
    <span class="p">};</span>
    
    <span class="c1"># 这里把 api 拆成服务商和区域两个，没啥特殊原因，因为是分两回写的，汗</span>
    <span class="c1"># 其实可以看到最开始的请求参数类似，最后json的field名字都一样</span>
    <span class="n">ajax</span> <span class="s">&#39;/api/provider&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">$param</span> <span class="o">=</span> <span class="n">from_json</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$index</span> <span class="o">=</span> <span class="nv">$index_prefix</span> <span class="o">.</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;datasource&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$from</span>  <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;from&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;now-10d&#39;</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$to</span>    <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;to&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;now&#39;</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$providers</span> <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;provider&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$pct</span><span class="p">,</span> <span class="nv">$chartData</span> <span class="p">);</span>
        <span class="k">for</span> <span class="k">my</span> <span class="nv">$provider</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$providers</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$provider_pct</span><span class="p">;</span>
            <span class="c1"># 这里是比较麻烦的一点，因为一个区域在ip库里可能标记成多个，比如铁通和移动，现在都是移动</span>
            <span class="k">for</span> <span class="k">my</span> <span class="nv">$area</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$default_provider</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$provider</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="n">pct_count</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
                <span class="k">for</span> <span class="k">my</span> <span class="nv">$time</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$res</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
                    <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">error</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">error</span><span class="p">};</span>
                    <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">slow</span><span class="p">}</span>  <span class="o">+=</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">slow</span><span class="p">};</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c1"># 这里因为可能没有错误，所以前面关闭了常用的 warnings 警告</span>
            <span class="k">for</span> <span class="k">my</span> <span class="nv">$time</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$provider_pct</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">my</span> <span class="nv">$right_pct</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
                <span class="nv">$right_pct</span> <span class="o">=</span>
                  <span class="mi">100</span> <span class="o">-</span>
                  <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">slow</span><span class="p">}</span> <span class="o">/</span> <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">}</span>
                  <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
                <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$provider</span><span class="p">}</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%.2f&quot;</span><span class="p">,</span> <span class="nv">$right_pct</span><span class="p">;</span>
                <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Err&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%.2f&quot;</span><span class="p">,</span>
                  <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">error</span><span class="p">}</span> <span class="o">/</span> <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">}</span>
                  <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
                <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Size&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%.0f&quot;</span><span class="p">,</span>
                  <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Err&quot;</span><span class="p">};</span>
            <span class="p">}</span>
        <span class="p">};</span>
    
        <span class="k">for</span> <span class="k">my</span> <span class="nv">$time</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%$pct</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">date</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$time</span><span class="p">;</span>
            <span class="k">for</span> <span class="k">my</span> <span class="nv">$provider</span> <span class="p">(</span> <span class="nv">@$providers</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$provider</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$provider</span><span class="p">}</span> <span class="o">||</span> <span class="mi">100</span><span class="p">;</span>
                <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Err&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Err&quot;</span><span class="p">}</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
                <span class="c1"># 百分比太低，所以翻 5 倍来作为 bullet 的大小</span>
                <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Size&quot;</span><span class="p">}</span> <span class="o">=</span>
                  <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Size&quot;</span><span class="p">}</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">};</span>
            <span class="nb">push</span> <span class="nv">@$chartData</span><span class="p">,</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="p">};</span>
    
        <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">type</span> <span class="o">=&gt;</span> <span class="s">&quot;line&quot;</span><span class="p">,</span>
            <span class="n">categoryField</span> <span class="o">=&gt;</span> <span class="s">&quot;date&quot;</span><span class="p">,</span>
            <span class="n">graphList</span> <span class="o">=&gt;</span> <span class="nv">$providers</span><span class="p">,</span>
            <span class="n">chartData</span> <span class="o">=&gt;</span> <span class="nv">$chartData</span><span class="p">,</span>
        <span class="p">};</span>
    
        <span class="k">return</span> <span class="n">to_json</span><span class="p">(</span><span class="nv">$res</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="n">ajax</span> <span class="s">&#39;/api/area&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">$param</span> <span class="o">=</span> <span class="n">from_json</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$index</span> <span class="o">=</span> <span class="nv">$index_prefix</span> <span class="o">.</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;datasource&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$limit</span> <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;limit&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="mi">50</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$from</span>  <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;from&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;now-10d&#39;</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$to</span>    <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;to&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;now&#39;</span><span class="p">;</span>
        <span class="c1"># 这是后来写的，尽可能把 sub 拆分了，所以 ajax 这里就很简略</span>
        <span class="c1"># 当然因为不考虑多运营商的问题，本身也容易一些</span>
        <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="n">pct_terms</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">return</span> <span class="n">to_json</span><span class="p">(</span><span class="nv">$res</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="k">sub </span><span class="nf">pct_terms</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$area_all_count</span> <span class="o">=</span> <span class="n">area_terms</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>    <span class="nv">$limit</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$area_err_count</span> <span class="o">=</span> <span class="n">area_terms</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$error</span><span class="p">,</span> <span class="nv">$chartData</span> <span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$area_err_count</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$error</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">}</span> <span class="p">}</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$area_all_count</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nb">push</span> <span class="nv">@$chartData</span><span class="p">,</span> <span class="p">{</span>
                <span class="n">area</span>  <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">},</span>
                <span class="n">error</span> <span class="o">=&gt;</span> <span class="nv">$error</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">}</span> <span class="p">}</span> <span class="o">||</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">right</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">}</span> <span class="o">-</span> <span class="nv">$error</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">}</span> <span class="p">},</span>
            <span class="p">};</span>
        <span class="p">}</span>
        <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">type</span> <span class="o">=&gt;</span> <span class="s">&quot;column&quot;</span><span class="p">,</span>
            <span class="n">categoryField</span> <span class="o">=&gt;</span> <span class="s">&quot;area&quot;</span><span class="p">,</span>
            <span class="n">graphList</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(right error)</span><span class="p">],</span>
            <span class="n">chartData</span> <span class="o">=&gt;</span> <span class="nv">$chartData</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="nv">$res</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">sub </span><span class="nf">pct_count</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$level</span> <span class="o">=</span> <span class="nv">$area</span> <span class="ow">eq</span> <span class="s">&#39;OS&#39;</span> <span class="p">?</span> <span class="mi">3000</span> <span class="p">:</span> <span class="mi">2000</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$all_count</span>  <span class="o">=</span> <span class="n">histo_count</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>      <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$slow_count</span> <span class="o">=</span> <span class="n">histo_count</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$level</span><span class="p">,</span>   <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$err_count</span>  <span class="o">=</span> <span class="n">histo_count</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="s">&#39;hasErr&#39;</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$res</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$slow_count</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="nb">time</span><span class="p">}</span> <span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">slow</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$err_count</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="nb">time</span><span class="p">}</span> <span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">error</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$all_count</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="nb">time</span><span class="p">}</span> <span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$res</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1"># 下面开始的两个才是真正发 ES 请求的地方</span>
    <span class="k">sub </span><span class="nf">area_terms</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$level</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
            <span class="nb">index</span>  <span class="o">=&gt;</span> <span class="nv">$index</span><span class="p">,</span>
            <span class="n">type</span>   <span class="o">=&gt;</span> <span class="nv">$type</span><span class="p">,</span>
            <span class="n">size</span>   <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">facets</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">area</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">facet_filter</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="ow">and</span> <span class="o">=&gt;</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="n">range</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                    <span class="n">date</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                        <span class="n">from</span> <span class="o">=&gt;</span> <span class="nv">$from</span><span class="p">,</span>
                                        <span class="n">to</span>   <span class="o">=&gt;</span> <span class="nv">$to</span>
                                    <span class="p">},</span>
                                <span class="p">},</span>
                            <span class="p">},</span>
                            <span class="p">{</span>
                                <span class="n">numeric_range</span> <span class="o">=&gt;</span>
                                  <span class="p">{</span> <span class="n">timeCost</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">gte</span> <span class="o">=&gt;</span> <span class="nv">$level</span><span class="p">,</span> <span class="p">},</span> <span class="p">},</span>
                            <span class="p">},</span>
                        <span class="p">],</span>
                    <span class="p">},</span>
                    <span class="c1"># 使用最简单的 terms facets API，因为只用计数就好了</span>
                    <span class="n">terms</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="n">field</span> <span class="o">=&gt;</span> <span class="s">&quot;fromArea&quot;</span><span class="p">,</span>
                        <span class="n">size</span>  <span class="o">=&gt;</span> <span class="nv">$limit</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">);</span>
        <span class="k">return</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">facets</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">area</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">terms</span><span class="p">};</span>
    <span class="p">}</span>
    
    <span class="k">sub </span><span class="nf">histo_count</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$level</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="c1"># 根据 level 参数判断使用 hasErr 还是 timeCost 列数据</span>
        <span class="k">my</span> <span class="nv">$level_ref</span> <span class="o">=</span>
          <span class="nv">$level</span> <span class="ow">eq</span> <span class="s">&#39;hasErr&#39;</span>
          <span class="p">?</span> <span class="p">{</span> <span class="n">term</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">hasErr</span> <span class="o">=&gt;</span> <span class="s">&#39;true&#39;</span> <span class="p">}</span> <span class="p">}</span>
          <span class="p">:</span> <span class="p">{</span> <span class="n">numeric_range</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">timeCost</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ow">gt</span> <span class="o">=&gt;</span> <span class="nv">$level</span> <span class="p">}</span> <span class="p">}</span> <span class="p">};</span>
        <span class="k">my</span> <span class="nv">$facets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">pct</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">facet_filter</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="c1"># 这里条件比较多，所以要用 bool API，不能用 and 了</span>
                    <span class="n">bool</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="c1"># must 可以提供多个条件作为 AND 数组</span>
                        <span class="c1"># 此外还有 must_not 作为 AND NOT 数组</span>
                        <span class="c1"># should 作为 OR 数组</span>
                        <span class="n">must</span> <span class="o">=&gt;</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="n">range</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                    <span class="n">date</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                        <span class="n">from</span> <span class="o">=&gt;</span> <span class="nv">$from</span><span class="p">,</span>
                                        <span class="n">to</span>   <span class="o">=&gt;</span> <span class="nv">$to</span>
                                    <span class="p">},</span>
                                <span class="p">},</span>
                            <span class="p">},</span>
                            <span class="p">{</span> <span class="n">prefix</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">fromArea</span> <span class="o">=&gt;</span> <span class="nv">$area</span> <span class="p">}</span> <span class="p">},</span>
                            <span class="nv">$level_ref</span><span class="p">,</span>
                        <span class="p">],</span>
                    <span class="p">},</span>
                <span class="p">},</span>
                <span class="c1"># 这里是需要针对专门的时间列做汇总，所以用 date_histogram 了，具体说明之前有博客</span>
                <span class="n">date_histogram</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">field</span>    <span class="o">=&gt;</span> <span class="s">&quot;date&quot;</span><span class="p">,</span>
                    <span class="n">interval</span> <span class="o">=&gt;</span> <span class="s">&quot;1h&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
            <span class="nb">index</span>  <span class="o">=&gt;</span> <span class="nv">$index</span><span class="p">,</span>
            <span class="n">type</span>   <span class="o">=&gt;</span> <span class="nv">$type</span><span class="p">,</span>
            <span class="n">facets</span> <span class="o">=&gt;</span> <span class="nv">$facets</span><span class="p">,</span>
            <span class="n">size</span>   <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="k">return</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">facets</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">pct</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">entries</span><span class="p">};</span>
    <span class="p">}</span>
</code></pre></div>
<p>其实把里面请求的hash拆开来一个个定义，然后根据情况组合，但是不方便察看作为 demo 的整体情况。</p>
<p>然后看template里怎么写。这里虽然有两个效果图，但是只有一个template哟：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;[% $request.uri_base %]/amcharts/style.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;[% $request.uri_base %]/amcharts/amcharts.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
  <span class="kd">var</span> <span class="nx">chart</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">createAmChart</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 清空原有图形</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#chartdiv&quot;</span><span class="p">).</span><span class="nx">empty</span><span class="p">();</span>
    <span class="c1">// 如果是时间轴线图，需要把date字符转成Date对象</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">==</span> <span class="s2">&quot;date&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">date</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmSerialChart</span><span class="p">();</span>
    <span class="c1">// 拖动条等图片的路径</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">pathToImages</span> <span class="o">=</span> <span class="s2">&quot;/amcharts/images/&quot;</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">dataProvider</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">categoryField</span><span class="p">;</span>
    <span class="c1">// 如果是柱状图，可以显示 3D 效果</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;column&#39;</span> <span class="p">)</span> <span class="p">{</span>
<span class="c1">//      chart.rotate = true;</span>
      <span class="nx">chart</span><span class="p">.</span><span class="nx">depth3D</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
      <span class="nx">chart</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">categoryAxis</span> <span class="o">=</span> <span class="nx">chart</span><span class="p">.</span><span class="nx">categoryAxis</span><span class="p">;</span>
    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">fillAlpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">fillColor</span> <span class="o">=</span> <span class="s2">&quot;#FAFAFA&quot;</span><span class="p">;</span>
    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">axisAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">gridPosition</span> <span class="o">=</span> <span class="s2">&quot;start&quot;</span><span class="p">;</span>
    <span class="c1">// 时间轴需要解析Date对象</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">==</span> <span class="s2">&quot;date&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">parseDates</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">minPeriod</span> <span class="o">=</span> <span class="s2">&quot;hh&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">valueAxis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>
    <span class="nx">valueAxis</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="nx">valueAxis</span><span class="p">.</span><span class="nx">axisAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// 指定柱状图为叠加模式，这里有多种模式可以看文档</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;column&#39;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">valueAxis</span><span class="p">.</span><span class="nx">stackType</span> <span class="o">=</span> <span class="s2">&quot;regular&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis</span><span class="p">);</span>
    <span class="c1">// 这里有个有趣的事情，如果不把graph当数组直接循环，效果也没问题</span>
    <span class="c1">// 我只能猜测是 addGraph 后数据其实已经缓存到 chart 了</span>
    <span class="kd">var</span> <span class="nx">graph</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#FF6600&#39;</span><span class="p">,</span> <span class="s1">&#39;#FCD202&#39;</span><span class="p">,</span> <span class="s1">&#39;#B0DE09&#39;</span><span class="p">,</span> <span class="s1">&#39;#0D8ECF&#39;</span><span class="p">,</span> <span class="s1">&#39;#2A0CD0&#39;</span><span class="p">,</span> <span class="s1">&#39;#CD0D74&#39;</span><span class="p">,</span> <span class="s1">&#39;#CC0000&#39;</span><span class="p">,</span> <span class="s1">&#39;#00CC00&#39;</span><span class="p">,</span> <span class="s1">&#39;#0000CC&#39;</span><span class="p">,</span> <span class="s1">&#39;#DDDDDD&#39;</span><span class="p">,</span> <span class="s1">&#39;#999999&#39;</span><span class="p">,</span> <span class="s1">&#39;#333333&#39;</span><span class="p">,</span> <span class="s1">&#39;#990000&#39;</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmGraph</span><span class="p">();</span>
      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">valueField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;column&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">valueField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">descriptionField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;Err&quot;</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletSizeField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;Size&quot;</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bullet</span> <span class="o">=</span> <span class="s2">&quot;round&quot;</span><span class="p">;</span>
        <span class="c1">// 设定为空心圆圈</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletColor</span> <span class="o">=</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletBorderAlpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="c1">// amchart 本来有默认颜色，不过前面因为修改了圆内的颜色，所以其他颜色无法继承默认设定了</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletBorderColor</span> <span class="o">=</span>  <span class="nx">colors</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineColor</span> <span class="o">=</span>  <span class="nx">colors</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineAlpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineThickness</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">balloonText</span> <span class="o">=</span> <span class="s2">&quot;[[value]]% / hasErr:[[description]]%&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">chart</span><span class="p">.</span><span class="nx">addGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="c1">// 加图例，这样可以在图上随时勾选察看具体某个数据，也方便某数据异常的时候影响察看其他</span>
    <span class="kd">var</span> <span class="nx">legend</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmLegend</span><span class="p">();</span>
    <span class="nx">legend</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">;</span>
    <span class="nx">legend</span><span class="p">.</span><span class="nx">horizontalGap</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="nx">legend</span><span class="p">.</span><span class="nx">switchType</span> <span class="o">=</span> <span class="s2">&quot;v&quot;</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">addLegend</span><span class="p">(</span><span class="nx">legend</span><span class="p">);</span>
    <span class="c1">// 加拖拉轴，这样可以拖动察看细节，这个功能很赞</span>
    <span class="kd">var</span> <span class="nx">scrollbar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartScrollbar</span><span class="p">();</span>
    <span class="nx">scrollbar</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="nx">graph</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">scrollbar</span><span class="p">.</span><span class="nx">graphType</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span><span class="p">;</span>
    <span class="nx">scrollbar</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">addChartScrollbar</span><span class="p">(</span><span class="nx">scrollbar</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartCursor</span><span class="p">();</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">addChartCursor</span><span class="p">(</span><span class="nx">cursor</span><span class="p">);</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;chartdiv&quot;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">drawChart</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">provider</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#provider :selected&quot;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
       <span class="nx">provider</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="p">);</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">datasource</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#datasource :selected&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">apitype</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;:radio:checked&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#from&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#to&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
      <span class="nx">processData</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;[% $request.uri_base %]/demo/api/&quot;</span> <span class="o">+</span> <span class="nx">apitype</span><span class="p">,</span>
      <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="s2">&quot;provider&quot;</span><span class="o">:</span><span class="nx">provider</span><span class="p">,</span> <span class="s2">&quot;datasource&quot;</span><span class="o">:</span><span class="nx">datasource</span><span class="p">,</span> <span class="s2">&quot;from&quot;</span><span class="o">:</span><span class="nx">from</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="o">:</span><span class="nx">to</span><span class="p">}),</span>
      <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
      <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
      <span class="nx">success</span> <span class="o">:</span> <span class="nx">createAmChart</span>
    <span class="p">});</span>
  <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">showselect</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#providers&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
  <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">hideselect</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#providers&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
  <span class="p">};</span>
<span class="nt">&lt;/script&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;well&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;from&quot;</span> <span class="na">name=</span><span class="s">&quot;from&quot;</span> <span class="na">value=</span><span class="s">&quot;[% $inputfrom %]&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;to&quot;</span> <span class="na">name=</span><span class="s">&quot;to&quot;</span> <span class="na">value=</span><span class="s">&quot;[% $inputto %]&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;datasource&quot;</span><span class="nt">&gt;</span>
%% for $datasources -&gt; $datasource {
            <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;[% $datasource %]&quot;</span><span class="nt">&gt;</span>[% $datasource %]<span class="nt">&lt;/option&gt;</span>
%% }
          <span class="nt">&lt;/select&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span2&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;radio&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">name=</span><span class="s">&quot;querytype&quot;</span> <span class="na">value=</span><span class="s">&quot;provider&quot;</span> <span class="na">onclick=</span><span class="s">&quot;showselect()&quot;</span><span class="nt">&gt;</span>服务商趋势
          <span class="nt">&lt;/label&gt;</span>
          <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;radio&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">name=</span><span class="s">&quot;querytype&quot;</span> <span class="na">value=</span><span class="s">&quot;area&quot;</span> <span class="na">checked</span> <span class="na">onclick=</span><span class="s">&quot;hideselect()&quot;</span><span class="nt">&gt;</span>分地区统计
          <span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary&quot;</span> <span class="na">onclick=</span><span class="s">&quot;drawChart()&quot;</span><span class="nt">&gt;</span>查询<span class="nt">&lt;/button&gt;</span>
        
        <span class="nt">&lt;div</span> <span class="na">id =</span><span class="s">&quot;providers&quot;</span> <span class="na">class=</span><span class="s">&quot;controls hide&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;provider&quot;</span> <span class="na">multiple=</span><span class="s">&quot;mulitiple&quot;</span><span class="nt">&gt;</span>
%% for $providers -&gt; $provider {
            <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;[% $provider %]&quot;</span> <span class="na">selected</span><span class="nt">&gt;</span>[% $provider %]<span class="nt">&lt;/option&gt;</span>
%% }
          <span class="nt">&lt;/select&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span><span class="c">&lt;!--/well--&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chartdiv&quot;</span> <span class="na">style=</span><span class="s">&quot;width: 100%; height: 400px;&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
</code></pre></div>
    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2012/12/21/dancer-plugin-auth-extensible" title="学习 Dancer::Plugin::Auth::Extensible 模块">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2012/12/22/intro-dancer-plugin-adapter" title="Dancer::Plugin::Adapter 模块介绍">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    
  <!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" id="UYScript" src="http://v1.uyan.cc/js/iframe.js?UYUserId=1589850" async=""></script>
<!-- UY END -->
  </div>
</div>
  
      </div>
      <div class="span4">
          
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
               
                 <li> <a href="/2013/03/15/puppet-provider-development">Puppet 自定义 Provider</a></li>
               
                 <li> <a href="/2013/03/14/JPush-example">极光推送demo</a></li>
               
                 <li> <a href="/2013/02/25/nginx-testing-10Gibps">Nginx 万兆网络环境测试</a></li>
               
                 <li> <a href="/2013/02/22/setup-stf2">STF 2.0 安装测试</a></li>
               
                 <li> <a href="/2013/01/31/puppet-define-type-and-custom-function">Puppet 自定义 type 和 function</a></li>
               
                 <li> <a href="/2013/01/11/systemtap-to-debug-kmsg-dump">用 systemtap 调试 kmsg dump</a></li>
               
                 <li> <a href="/2013/01/10/update-puppet-to-3.0">升级 Puppet 到 3.0 及其他附件简介</a></li>
               
                 <li> <a href="/2013/01/10/rspec-puppet-intro">给 puppet 写 Rspec 测试用例</a></li>
               
                 <li> <a href="/2013/01/06/limit-bandwidth-of-one-process">限制单个进程的带宽</a></li>
               
            </ul>
          </div>
        
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
