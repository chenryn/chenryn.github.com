<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/archive/">归档</a></li>
      	<li><a href="/categories/">分类</a></li>
      	<li><a href="/elk-errata/">《ELK stack权威指南》勘误</a></li>
      	<li><a href="/errata/">《网站运维技术与实践》勘误</a></li>
      	<li><a href="/pages/">Pages</a></li>
      	<li><a href="/projects/">学习记录</a></li>
      	<li><a href="/tags/">标签</a></li>
            <li><a href="http://chenlinux.com/poetry/index.html" />诗文集</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/12/19/omd_intro_install_on_centos5/" title="OMD系列(一)简介与安装" rel="bookmark">OMD系列(一)简介与安装</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-12-19 00:00:00 +0800">19 Dec 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>OMD，全称Open Monitoring Distribution，是一个围绕Nagios core构建的分布式开源监控集。在nagios基础上融合了NRPE、NSCA、check_mk、mod_gearman、pnp4nagios、nagvis、rrdcached等插件，以完成高性能的、可视化的，分权限管理的监控系统。<br />
（我是在看mod_gearman的安装介绍时看到的，感觉这种一体式的安装很爽）<br />
项目主页是<a href="http://omdistro.org" target="_blank">http://omdistro.org</a>，提供了rh、debian、suse和src各种安装模式。<br />
比如在centos5上面，只需要简单的操作即可：
      <a href="/2011/12/19/omd_intro_install_on_centos5/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/12/19/intro_open_flash_chart/" title="Chart::OFC试用" rel="bookmark">Chart::OFC试用</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-12-19 00:00:00 +0800">19 Dec 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>这几天ppt看的比较多，一样一样来玩。今天先说OFC，之前有试过amcharts和fusioncharts。amcharts最全最漂亮（尤其是有scroll和map），可惜图上都自动标上了amcharts.com的字样；fusioncharts的free版本，也蛮好用的，虽然scroll怪怪的居然靠的是点击控制。比较相同的一点就是，这两都只提供了php、python等的模块，如果是perl写的网页，那只能通过提供xml/json数据给js控制的办法。稍微一点点遗憾……<br />
这次在cpan上终于看到一个chart控制的模块，叫Chart::OFC。这个OFC的项目地址如下：<br />
<a href="http://teethgrinder.co.uk/open-flash-chart/" target="_blank">http://teethgrinder.co.uk/open-flash-chart/</a><br />
其实用法上没什么特殊，无非是省略一点点xml代码，通过OO的方式自动生成而已。让我觉得蛮好玩的是官网上作者的声明。因为他曾经在维护公司一个付费的flash chart项目时，给甲方发信要求修改bug，等了一个月没反应。于是自己现学as语言开始自己搞= =！然后念念不忘的提示说：要重视客户的反馈。。。。。。哈哈<br />
这个项目目前用as3改写，所以新版本叫OFC2了，不过作者自己也说不太稳定，建议继续用OFC1.9.7，所以先不说Chart::OFC2，继续用Chart::OFC好了：
      <a href="/2011/12/19/intro_open_flash_chart/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/12/15/learning_dancer_plugin_simplecrud/" title="Dancer::Plugin::SimpleCRUD模块学习" rel="bookmark">Dancer::Plugin::SimpleCRUD模块学习</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-12-15 00:00:00 +0800">15 Dec 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>Dancer圣临历中介绍了一个新插件Dancer::Plugin::SimpleCRUD。可以很快的生成对数据库表的create/read/update/delete。大概阅读了一下代码。主要就是使用HTML::FromDatabase模块生成read的页面，用CGI::FormBuilder模块生成create/update/delete的页面，用Dancer::Plugin::Database::Handle模块操作数据库。因为是Simple，所以html代码都是固定的，不甚美观。但是思路可以学习，通过这两个模块，可以自己结合Dancer的template系统做CRUD了。<br />
先来说HTML::FromDatabase模块，这个只涉及select，所以特别简单：<br />
<code class="highlighter-rouge">perl
any ['get', 'post'] =&gt; '/add/:element' =&gt; sub {
    my $element = params-&gt;{'element'};
    if ( request-&gt;method eq 'GET' ) {
        my $sth = database-&gt;prepare("select * from $element");
        $sth-&gt;execute();
        my $table = HTML::Table::FromDatabase-&gt;new( -sth =&gt; $sth )-&gt;getTable;
        template 'info', { table =&gt; $table };
    };
...
};
</code>
      <a href="/2011/12/15/learning_dancer_plugin_simplecrud/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/12/12/nginx_perl_demo/" title="nginx_perl试用" rel="bookmark">nginx_perl试用</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-12-12 00:00:00 +0800">12 Dec 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>因为空闲时间比较多，所以在CPAN上乱翻，看到了nginx_perl这个项目(原名Nginx::Engine)，现在托管在github.com上。地址见：<br />
<a href="https://github.com/zzzcpan/nginx-perl">https://github.com/zzzcpan/nginx-perl</a>
      <a href="/2011/12/12/nginx_perl_demo/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/11/04/test_websocket_with_dancer/" title="websocket体验" rel="bookmark">websocket体验</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-11-04 00:00:00 +0800">04 Nov 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>因为看到mojo在宣传其内置websocket支持，去CPAN上search了一下，发现Dancer也有plugin做websocket用。稍微看了一下，很显然没看mojo的内嵌代码，而dancer的plugin代码倒是相当简单。<br />
简单的说，就是通过AnyMQ、Plack和Web::Hippie的组合完成。注意的是，因为Web::Hippie使用了AnyEvent::Handle管理websocket的fh，AnyMQ也使用AnyEvent管理message queue，所以在启动plackup的时候，必须使用AnyEvent核心的Twiggy服务器。<br />
Plugin里硬编码很多。比较重要的地方就是&rdquo;set plack_middlewares_map&rdquo;，plack_middlewares_map是dancer新加的功能，这里用URLMap来mount &lsquo;/_hippie&rsquo;到Web::Hippie::Pipe和AnyMQ上。也就是说，使用websocket的访问路径，必须固定为&rsquo;^/_hippie/.*&lsquo;这样。<br />
然后像两个get方法，&rsquo;/new_listener&rsquo;和&rsquo;/message&rsquo;，这两个访问路径是Web::Hippie里写死的，不能改。好在一般应用也不会直接访问这个。<br />
最后有三个register到Dancer的方法，&rsquo;ws_on_message&rsquo;、&rsquo;ws_on_new_listener&rsquo;和&rsquo;ws_send&rsquo;，前两个用来覆盖上面提到的get的两个route的具体信息，一般不用前面两个，因为这样就意味着页面的js里无法控制websocket了（个人理解，不知道对否？）后面那个类似把websocket改成普通的params方式请求响应（用curl/wget可以请求的那种）。
      <a href="/2011/11/04/test_websocket_with_dancer/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/11/04/perl_oauth_to_weibo_api/" title="用perl调用新浪微博API小实验" rel="bookmark">用perl调用新浪微博API小实验</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-11-04 00:00:00 +0800">04 Nov 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>新浪微博API是通过OAuth方式的。perl上有现成的模块，只需要稍微调一下参数就行了。下午比较闲，试试看。。。<br />
一般网上说的，都还是Net::OAuth模块，这个是1.0a版本的，一看perldoc那个长篇就头疼。这里我用Net::OAuth2模块，简单方便，而且正好配合dancer框架，方便做外部网站应用。<br />
首先是安装模块：<br />
<code class="highlighter-rouge">perlcpanm --mirror-only --mirror http://mirrors.163.com/cpan LWP::Protocol::https Net::OAuth2::Client</code><br />
因为新浪微博的api用的是https协议，所以要加上LWP::Protocol::https模块，这样才能发起443请求。<br />
然后在web/lib/weibo.pm里里添加如下语句：<br />
```perluse Net::OAuth2::Client;<br />
use JSON qw(decode_json);        #只需要decode_json，因为dancer自己有from_json和to_json，不要覆盖了
      <a href="/2011/11/04/perl_oauth_to_weibo_api/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/10/26/a_perl_extended_regex/" title="一个perl扩展正则表达式" rel="bookmark">一个perl扩展正则表达式</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-10-26 00:00:00 +0800">26 Oct 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>今天傍晚，莫言在Q群里贴了一个他写的正则表达式，回来翻了翻perlre文档，基本算是看懂，赶紧记录下来：<br />
<code class="highlighter-rouge">perlmy $ip = "192.168.0.1|192.168.0.2|192.168.0.1";
if ( $ip =~ /
    ^
    (?:
        ((?:\d{1,3}\.){3}\d{1,3})
        (?=
            (?:
                \|(?!\1)(?1)
            )*
            \z
        )
        \|
    )*
    (?1)
    $
    /x ) {
    print "match\n";
}</code><br />
根据<a href="http://perldoc.perl.org/perlre.html" title="perlre文档" target="_blank">perlre文档</a>的说明，一点一点解释。
      <a href="/2011/10/26/a_perl_extended_regex/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/10/25/rewrite_template_for_squid-conf/" title="用Template::Tookit给squid.conf写模板" rel="bookmark">用Template::Tookit给squid.conf写模板</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-10-25 00:00:00 +0800">25 Oct 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>本文纯属练习Template模块使用，是否可以运用到生产，是否有必要运用到生产，都是未知数……<br />
包括如下文件：<br />
```bash[raocl@localhost tt2-test]$ tree<br />
.<br />
|&ndash; config-cdcgame.net.yml<br />
|&ndash; config-china.com.yml<br />
|&ndash; config.tt<br />
|&ndash; hostconfig.yml<br />
|&ndash; squid.layout.tt<br />
`&ndash; tt4squid.pl
      <a href="/2011/10/25/rewrite_template_for_squid-conf/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/10/24/backup-script-4-my-blog/" title="blog备份脚本" rel="bookmark">blog备份脚本</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-10-24 00:00:00 +0800">24 Oct 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>之前总不重视自己的博客，上回一丢才心疼，现在重视起来，决定定期备份sql。写个小脚本如下：<br />
<code class="highlighter-rouge">perl#!/usr/bin/perl
use warnings;
use strict;
use MySQL::Backup;
use Mail::Sender;
open my $tmp_sql, '&gt;', "backup.sql";
my $mb = new MySQL::Backup('dbname', 'localhost', 'dbuser', 'dbpasswd', {'USE_REPLACE' =&gt; 1, 'SHOW_TABLE_NAMES' =&gt; 1});
print $tmp_sql $mb-&gt;create_structure();
print $tmp_sql $mb-&gt;data_backup();
close $tmp_sql;
my $sender = new Mail::Sender { smtp    =&gt; 'smtp.163.com',
                                from    =&gt; 'mailuser@163.com',
#                                debug   =&gt; 'backup_debug.log',
                                auth    =&gt; 'LOGIN',
                                authid  =&gt; 'mailuser',
                                authpwd =&gt; 'mailpasswd',
                              };
$sender-&gt;MailFile({ to      =&gt; 'mailuser@gmail.com',
                    subject =&gt; 'Backup Blog SQL_'.time(),
                    msg     =&gt; '3Q',
                    file    =&gt; 'backup.sql',});</code><br />
没有直接用mysqldump，而是找了这个MySQL::Backup模块，试着看了导出的sql，和mysqldump的结果是有些不同的。<br />
mysqldump导出的sql一般结构是这样子：<br />
<code class="highlighter-rouge">mysqlDROP TABLE IF EXISTS `tablename`;
CREATE TABLE `tablename`(ID INT NOT NULL ...);
LOCK TABLES `tablename` WARITE;
INSERT INTO `tablename` VALUES(...),(...),(...);
UNLOCK TABLES;</code><br />
而MySQL::Backup导出的sql结构是这样子的：<br />
<code class="highlighter-rouge">mysqlCREATE TABLE `tablename`(ID INT NOT NULL ...);
REPLACE INTO `tablename`(ID,...)VALUES(1,...);
REPLACE INTO `tablename`(ID,...)VALUES(2,...);</code><br />
其实我不太清楚replace比insert好在那，不过pod上的example用了USE_REPLACE=&gt;&rsquo;1&rsquo;，就照抄了，如果习惯insert的，在new构建对象时，不用这个param就行了。<br />
另外这个Mail::Sender模块，是在微博上某次评论时，发现很多朋友在用的，我也就放弃一次Net::SMTP_auth，用一次试试，感觉还不错~~
      <a href="/2011/10/24/backup-script-4-my-blog/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/10/20/screenshot-4-cloudhosting-down/" title="博客恢复了，截图纪念一下" rel="bookmark">博客恢复了，截图纪念一下</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-10-20 00:00:00 +0800">20 Oct 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>这两天折腾博客宕机问题啊~原本对阿里云的看好大幅下降……几次挂掉，甚至电话告知说数据恢复不了请自行重置……崩溃原因居然解释说“因为你没有修改grub再重启”这种解释，拜托，我要重启还不是因为突然ssh报密码错误而你们“重置密码必须重启”？死循环啊！<br />
对了，我人格保证，作为一个用xen当工作环境一年多的运维，绝对没有犯自行升级内核导致重启失败这种错误的可能。阿里云客服能不能不要把一个客户的缘由安到别的客户头上……<br />
不管如何，结局还是好的。截个监控宝的告警图纪念一下：<br />
<img src="/images/uploads/20111020192305.png" alt="" title="aliyunOS" width="856" height="332" class="alignnone size-full wp-image-2647" />
      <a href="/2011/10/20/screenshot-4-cloudhosting-down/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/10/17/notes-about-probind/" title="ProBIND体验笔记" rel="bookmark">ProBIND体验笔记</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-10-17 00:00:00 +0800">17 Oct 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#DNS-ref" title="DNS" rel="category tag">DNS</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>闲的无聊，继续研究DNS周边产品，这次盯上了Probind。这是搜索结果中比较常见的bind的web管理工具。其实我是比较希望有个中文的东东方便我偷懒，可惜看sina之前的xbayDNS一直停留在了只支持FreeBSD/MAC的阶段没有更新，汗，不支持linux的项目偶见过的还真不多……<br />
probind最近一次更新也是2003/05/24的事情了。所以也没期待它能多么适应现在的bind体系，不过作为代码看看还是可以的。<br />
创建mysql用户和库，然后把程序解压到webroot目录，然后执行mysql -u named -p named &lt; etc/mktables.sql，这就是install的步骤。但是这个时候访问首页是有一堆报错的，提示你dns服务器的默认配置（外部检测用dns，管理员邮箱等等）没配置。这个需要通过./tools/settings.php去添加——但是首页上没有链接点击，得自己手敲url，汗……<br />
然后，probind更新的时候，估计php还是以version4为主，所以里头用的还是$HTTP_GET_VARS和$HTTP_POST_VARS等全局变量。奇怪的是我把php.ini里的register_global改成On后重启httpd了，页面依然没变，不得已在./inc/lib.inc文件的开头加上了两句<br />
<code class="highlighter-rouge">php$HTTP_GET_VARS = &amp;$_GET;
$HTTP_POST_VARS = &amp;$_POST;</code>才好。<br />
OK，现在正式看到probind的页面了。demo地址：<a href="http://chenlinux.com/probind/">点这里</a><br />
主要就是一个zone的管理，有add、delete、browse三个页面，前两个就是标准的表单，倒是browse里有个test，蛮好玩的，调用bin/testns脚本，使用perl的Net::DNS模块测试zone内的正/反向解析是否正常。<br />
然后就是record的管理，在browse zones里点进zone就可以编辑record了，主要就是主机名、解析ip。<br />
最后是server的管理，这里管理的是真实的DNS的ip和type(master|slave)——probind在易用和性能之间取了一个平衡，他不是像mysqlbind或者mysql-dlz那样直接从db里取数据做响应，而是每次更新(这里区分开了步骤，update的时候只是更新了db，然后再去bulk update的时候才是真正update dns配置)的时候，从数据库生成文件(bin/mkzonefile)，再同步到DNS服务器上(sbin/push.local|remote)并执行rndc reconfig命令。
      <a href="/2011/10/17/notes-about-probind/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/09/30/dynamic-dns-demo/" title="一个ddns的demo" rel="bookmark">一个ddns的demo</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-30 00:00:00 +0800">30 Sep 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>上回分析lbnamed的时候，开玩笑说自己也可以试试在模块基础上加点啥功能。国庆节前最后一天，没啥事情做，就写个小demo续貂。代码如下：<br />
```perl<br />
#!/usr/bin/perl<br />
use warnings;<br />
use strict;<br />
use autodie;<br />
use Sys::Hostname;<br />
use YAML::Syck;<br />
use Net::IP::Match::Regexp qw( create_iprange_regexp match_ip );<br />
use Stanford::DNS;<br />
use Stanford::DNSserver;<br />
$SIG{&lsquo;HUP&rsquo;} = &lsquo;catch_hup&rsquo;;<br />
my $need_reload;<br />
my $hostmaster = &lsquo;domain.chenlinux.com&rsquo;;<br />
my $soa        = rr_SOA(hostname(), $hostmaster, time(), 3600, 1800, 86400, 0);<br />
my $ns         = Stanford::DNSserver-&gt;new( listen_on =&gt; [ hostname() ],<br />
#                                           debug     =&gt; 1,<br />
                                           loopfunc  =&gt; \&amp;conf_reload,<br />
#                                           daemon    =&gt; &lsquo;no&rsquo;,<br />
                                         );<br />
my $regexp;<br />
my @domains;<br />
my $arealist;<br />
my $templist;<br />
my $config_path = &lsquo;/data/chenlinux.com/perl/&rsquo;;<br />
my $ns_domain = &lsquo;test.domain.chenlinux.com&rsquo;;<br />
$ns-&gt;add_dynamic(&ldquo;$domain&rdquo; =&gt; \&amp;dyn_lb ) foreach my $domain ( @domains );<br />
$ns-&gt;add_static( &ldquo;$ns_domain&rdquo;, T_SOA, $soa);<br />
$ns-&gt;add_static( &ldquo;$ns_domain&rdquo;, T_NS, rr_NS($hostmaster));
      <a href="/2011/09/30/dynamic-dns-demo/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/09/29/dancing-website-for-sync-dist-3/" title="写个同步分发系统(三)" rel="bookmark">写个同步分发系统(三)</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-29 00:00:00 +0800">29 Sep 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>上篇写的页面上，留下一个超链接，查看每条任务的具体情况。现在完成这部分。<br />
首先修改数据库结构，上篇已经建了websync.websync_peer表，现在继续：<br />
```mysql<br />
create table websync_customer (<br />
    uid int not null auto_increment primary key,<br />
    user varchar(20) not null,<br />
    passwd char(32) not null,<br />
    custom_info varchar(128),<br />
    node varchar(128) not null<br />
) engine=innodb;
      <a href="/2011/09/29/dancing-website-for-sync-dist-3/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/09/26/dancing-website-for-sync-dist-2/" title="写个同步分发系统(二)" rel="bookmark">写个同步分发系统(二)</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-26 00:00:00 +0800">26 Sep 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>接上篇，加上分发过程查看的页面。这应该是一个很典型的翻页处理。<br />
首先创建一个数据库表如下：<br />
<code class="highlighter-rouge">mysqlcreate table websync_peer (
    id int not null auto_increment primary key,
    begin_time timestamp not null default 0,
    end_time timestamp on update current_timestamp,
    url varchar(128) not null,
    customer varchar(20) not null,
    md5_hex char(32) default null
) engine=innodb;</code><br />
然后把之前的peer_query()函数修改如下：<br />
<code class="highlighter-rouge">perlsub peer_query {
    my $url = shift;
    #这里的database和session都需要其他plugin的配合，见之前博客，不贴重复代码了
    my $sth = database-&gt;prepare('insert into websync_peer (begin_time, url, customer) value (now(), ?, ?)');
    $sth-&gt;execute($url, session-&gt;{login});
};</code><br />
然后把gearman::client的功能改到mysql的UDFs内完成，做法见<a href="http://www.php-oa.com/2010/09/20/perl-gearman-server-mysql-udfs.html" title="http://www.php-oa.com/2010/09/20/perl-gearman-server-mysql-udfs.html"></a>。<br />
然后写翻页函数了~<br />
<code class="highlighter-rouge">perlget '/check' =&gt; sub {
    my $from = params-&gt;{page} || 1;
    my $user = session-&gt;{login};
    my @urls;
    my $count_sql = 'select count(id) count from websync_peer where customer = ?';
    my $count_sth = database-&gt;prepare($sql);
    $count_sth-&gt;execute( $user );
    my $count = $count_sth-&gt;fetchrow_hashref-&gt;{count};
    my $total_pages = int( $count / 20 + 1 );
    return 'No url has been posted to purge.' unless $count;
    return 'Selected page number out of range.' if $from &gt; $total_pages;
    my $url_sql = 'select id,url,begin_time from websync_peer where customer = ? order by id desc limit ?, 20';
    my $url_sth = database-&gt;prepare($sql);
    $url_sth-&gt;execute( $user, ($from - 1) * 20 );
    while ( my $ref = $sth-&gt;fetchrow_hashref ) {
        push @urls, $ref;
    };
    template 'check', { 'urls' =&gt; \@urls, 
                        'prev' =&gt; $from &gt; 1 ? $from - 1 : 1,
                        'next' =&gt; $from &lt; $total_pages ? $from + 1 : $total_pages, 
                        'last' =&gt; $total_pages, 
                      };
};</code><br />
对应的check.tt如下：<br />
```html&lt;html&gt;&lt;head&gt;
      <a href="/2011/09/26/dancing-website-for-sync-dist-2/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/09/20/get-ip-address-by-perl-on-linux/" title="linux上获取本机ip的各种perl写法" rel="bookmark">linux上获取本机ip的各种perl写法</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-20 00:00:00 +0800">20 Sep 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>大家讨论使用 Gearman 做分布式处理时，各机需要注册一个独立的 job 作为信息反馈，但是为了方便，<code class="highlighter-rouge">Gearman::Worker</code> 脚本 <code class="highlighter-rouge">register_function</code> 代码又要通用，于是想到了使用各自的 ip 地址作为 job 命名~
      <a href="/2011/09/20/get-ip-address-by-perl-on-linux/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/09/16/dancing-website-for-sync-dist-1/" title="写个同步分发系统(一)" rel="bookmark">写个同步分发系统(一)</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-16 00:00:00 +0800">16 Sep 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>写程序这个事情，其实规划最麻烦。比方我其实并没留意过一个完整的同步分发系统都有哪些功能。权做练手，想到哪些写哪些好了。<br />
最基础的部分:一个提交文件列表的页面，自动分析文件列表然后从源下载文件，中心下载完成后通知边缘节点开始；<br />
其次：文件完整性的校验，同步和分发的进度报表页面，失败报表的重试选择和报警；<br />
再次：系统分用户，不同用户可选节点指定分发，只查看当前用户的报表。<br />
以上。<br />
今天先完成最基础的部分。还是用dancer -a websync创建应用。然后创建views/websync.tt如下：<br />
```html<br />
&lt;/head&gt;&lt;body&gt;
      <a href="/2011/09/16/dancing-website-for-sync-dist-1/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/09/08/lbnamed-code-reading/" title="lbnamed代码浅读" rel="bookmark">lbnamed代码浅读</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-08 00:00:00 +0800">08 Sep 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>群里听说lbnamed这么个东东，用perl实现的动态DNS服务器。程序包括三个perl模块：Stanford::DNSserver模块、Stanford::DNS模块、LBCD模块；三个perl程序：lbnamed主程序、poller探测程序、slbcd监控程序（这个有C语言的版本）。
      <a href="/2011/09/08/lbnamed-code-reading/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/08/25/nginx-diff-response-via-filesize/" title="用nginx区分文件大小做出不同响应" rel="bookmark">用nginx区分文件大小做出不同响应</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-25 00:00:00 +0800">25 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>昨晚和前21v的同事聊天，说到我离职后一些技术上的更新。其中有个给某大客户(游戏下载类)的特殊需求设计，因为文件大小差距很大——估计是大版本和补丁的区别——又走的是同一个域名，而squid在响应比较大的文件时，尤其是初次下载的时候，性能比较差，所以拆成两组服务器，squid服务于较小的文件，通过pull方式从peer层获取，nginx服务于较大的文件，通过push方式由peer层分发同步。外部发布域名一律解析到squid服务器组上，请求透传到peer层的nginx，nginx分析这个url的content-length，如果大于阈值，则不返回文件，而是302到nginx服务器组的独立域名下的相应url去。
      <a href="/2011/08/25/nginx-diff-response-via-filesize/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/08/18/learning-cloudfarecast-3/" title="CloudForecast学习笔记(三)" rel="bookmark">CloudForecast学习笔记(三)</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-18 00:00:00 +0800">18 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>第三篇，看web部分。主程序cloudforecast_web里主要就是调用CloudForecast::Web的run()函数，接下来去看CloudForecast::Web。<br />
照例还是加载配置，然后这里主要多了两个accessor：allowfrom和front_proxy。用来定制acl和代理的。从下文可以看到，分别是采用了Plack::Middleware::Access和Plack::Middleware::ReverseProxy两个模块进行控制。<br />
然后是主要部分，通过Plack::Builder建立$app：<br />
1、初始化:&rdquo;my $app = $self-&gt;psgi;&rdquo;，这里是调用父层&rdquo;use Shirahata -base;&rdquo;的psgi()函数完成的。稍后再看这个。<br />
2、包装:取出前面说的allowfrom和front_proxy部分后，代码如下：<br />
<code class="highlighter-rouge">perl
    $app = builder {
        enable 'Plack::Middleware::Lint';
        enable 'Plack::Middleware::StackTrace';
        enable 'Plack::Middleware::Static',
            path =&gt; qr{^/(favicon\.ico$|static/)},
            root =&gt;Path::Class::dir($self-&gt;root_dir, 'htdocs')-&gt;stringify;
        $app;
    };</code><br />
真实加载顺序是倒序的，先加载Static.pm，用来服务静态文件，意即url路径为^/static/.*的，实际documentroot为./htdocs/；然后加载StackTrace.pm，用于开发调试的时候，向标准输出输出错误跟踪信息；最后是Lint.pm，用于检查请求/响应的格式是否正确。<br />
然后是加载运行，使用Plack::Loader运行上面build出来的$app。方法如下：<br />
<code class="highlighter-rouge">perl
    my $loader = Plack::Loader-&gt;load(
        'Starlet',
        port =&gt; $self-&gt;port || 5000,
        host =&gt; $self-&gt;host || 0,
        max_workers =&gt; 2,
    );
    $loader-&gt;run($app);</code><br />
主要是两个参数，第一个是用来运行plack的服务器模块名称，常见的有starman/twiggy/corona/perlbal等等，这里写的这个Starlet，是基于HTTP::Server::PSGI模块添加预派生(prefork)/热部署(Server::Starter)/优雅重启等功能的一个服务器模块，原来叫的名字是&rdquo;Plack::Server::Standalone::Prefork::Server::Starter&rdquo;(简称PSSPSS)……
      <a href="/2011/08/18/learning-cloudfarecast-3/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/08/18/learning-cloudfarecast-2/" title="CloudForecast学习笔记(二)" rel="bookmark">CloudForecast学习笔记(二)</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-18 00:00:00 +0800">18 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>接下来看radar部分，也就是探测主程序cloudforecast_radar，其中主要就是调用CloudForecast::Radar中的run()函数。<br />
首先还是惯例，调用ConfigLoader模块加载配置文件；<br />
然后是%SIG信号的定义，用来之后自动重运行的；<br />
然后一个while true死循环：<br />
1、循环里用select(undef,undef,undef,0.5)实现一个0.5秒的sleep；<br />
2、第一个if语句，用来判断是否是父进程，并使用无阻塞的waitpid($pid,WNOHANG)等待子进程完成——即$kid==-1；<br />
3、第二个if语句，用来强制退出死循环，条件是收到%SIG信号；<br />
4、第三个if语句，确认当前时间超过计划中的执行时间（即离上次执行时间最近的整5分钟点），开始执行探测——采用fork()派生子进程。<br />
5、子进程内容是从之前获取的配置文件内，轮询每一台设备，最终调用run_host()函数执行。<br />
然后又是两个if语句，接在while里的last之后，等待子进程全部完成的。
      <a href="/2011/08/18/learning-cloudfarecast-2/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/08/17/learning-cloudfarecast-1/" title="CloudForecast学习笔记(一)" rel="bookmark">CloudForecast学习笔记(一)</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-17 00:00:00 +0800">17 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>近三天学习cloudforecast，这是一个日本SA写的分布式监控的perl项目。日本的运维水平和perl水平，都让人羡慕啊……<br />
项目介绍：<br />
http://blog.riywo.com/2011/02/27/043646<br />
demo网址:<br />
http://editnuki.info:5000/<br />
下载地址：<br />
https://github.com/kazeburo/cloudforecast<br />
粗略的看了主要文件，主要是用Class::<em>完成的OO，Plack::MiddleWare::</em>完成的web，Gearman::Worker调用Data::*里的具体模块完成对服务器的监控抓取，然后调用RRDs完成监控数据图像的更新，在启动分布式的情况下，则用Gearman::Client传输监控数据给调用RRDs的worker。
      <a href="/2011/08/17/learning-cloudfarecast-1/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/08/02/calendar-select-html-for-self-monitor/" title="cdn自主监控(六):数据展示页面" rel="bookmark">cdn自主监控(六):数据展示页面</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-02 00:00:00 +0800">02 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>接下来进入我不擅长的页面部分了。规划页面分为side和main，side中提供时间选择框/类型下拉选择框和提交按钮；main中展示最后形成的chart。<br />
时间选择框是用js和css完成的，这个网上有很多，不过要同时支持多浏览器和分钟级别的选项的，目前就发现一个好用的。下载地址如下：<a href="http://chenlinux.com/images/uploads/Calendar.zip">http://chenlinux.com/images/uploads/Calendar.zip</a><br />
然后创建cachemoni/public/cdn.html如下：<br />
```html
      <a href="/2011/08/02/calendar-select-html-for-self-monitor/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/08/01/fusioncharts-for-self-monitor/" title="cdn自主监控(五):生成charts图像" rel="bookmark">cdn自主监控(五):生成charts图像</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-01 00:00:00 +0800">01 Aug 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>上篇完成了xml的输出，这篇开始说charts图像的生成。我们采用fusioncharts的免费版，之前博客有提到另一个amcharts，不过amcharts的免费版会在图像左上角加上自己amcharts.com的广告标识……<br />
从fusioncharts官网下载free版的压缩包，有20MB大，不过其中对我们这个小项目有用的只有MSLine.swf/MSBar2D.swf/fusioncharts.js等。<br />
说明：<br />
1、官网介绍上写了支持perl，不过下载包里只有php/asp/jsp/rails的class，没有perl的。所以还是得采用js的方式；<br />
2、js下有setDataURL和setDataXML两个方法，不过官方强烈建议使用setDataURL方法，这种方法可接受的数据量比setDataXML大很多。<br />
页面html很简单，加如下js代码即可：<br />
<code class="highlighter-rouge">javascript&lt;/script&gt;
&lt;script type="text/javascript"&gt;
var myChart = new FusionCharts("/Charts/MSBar2D.swf", "myChartId", "600", "500");
myChart.setDataURL(escape("/xml?begin=***&amp;end=***&amp;type=area"));
myChart.render("chartdiv");
&lt;/script&gt;</code><br />
要点在这个escape()，如果URL里带参数的话，必须用escape()转码，不然的话第一个&amp;之后的所有参数都会丢失掉！<br />
在调试中注意到，为了忽略缓存，setDataURL()会在url最后跟上一个随机1-4位数字参数&amp;curr=1234然后再发起请求。<br />
现在就可以访问页面看看了～嗯，可以看到图像中的中文字有问题。这是因为fusioncharts不认utf8的中文，必须输出gbk或者gb2312的xml数据才行。所以需要修改一些dancer的charset配置，把config.yml里的charset: UTF-8改成charset: GBK。然后重新请求，中文就正确显示了。<br />
如下图：<br />
<img src="/images/uploads/fusioncharts.jpg" alt="" title="MSBar2D" width="400" height="350" class="alignnone size-full wp-image-2548" />
      <a href="/2011/08/01/fusioncharts-for-self-monitor/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/07/28/output-xml-for-funsioncharts/" title="cdn自主监控(四):输出xml数据" rel="bookmark">cdn自主监控(四):输出xml数据</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-28 00:00:00 +0800">28 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>准备使用funsioncharts绘图，其采用xml数据，在绘制line图的时候，就要从mysql里读取数据，并输出成xml格式，相关配置如下：<br />
```perl<br />
package cachemoni;<br />
use Dancer &lsquo;:syntax&rsquo;;<br />
use Dancer::Plugin::Database;<br />
use POSIX qw(strftime);
      <a href="/2011/07/28/output-xml-for-funsioncharts/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/07/27/prepare-mysql-for-self-monitor/" title="cdn自主监控(三):数据库准备工作" rel="bookmark">cdn自主监控(三):数据库准备工作</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-27 00:00:00 +0800">27 Jul 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>准备两个表，一个存储原始数据，另一个存储每5分钟归总一次的数据。之后根据时间段绘制省份运营商性能图的时候，就直接从汇总表里获取数据；原始表留给详细查询。<br />
数据库准备脚本如下：<br />
```mysqlUSE myops;<br />
CREATE TABLE IF NOT EXISTS cdn_ori_record (<br />
	id INT(11) NOT NULL AUTO_INCREMENT PRIMARY KEY,<br />
	ip INT(10) NOT NULL DEFAULT &lsquo;0000000000&rsquo;,<br />
	isp ENUM(&lsquo;0&rsquo;,&rsquo;1&rsquo;,&rsquo;2&rsquo;,&rsquo;3&rsquo;,&rsquo;4&rsquo;),<br />
	area INT(4) NOT NULL DEFAULT &lsquo;0000&rsquo;,<br />
	cur_date TIMESTAMP DEFAULT NOW(),<br />
	cdn_time INT(10) NOT NULL DEFAULT &lsquo;0&rsquo;,<br />
	cdn ENUM(&lsquo;CHINACACHE&rsquo;,&rsquo;DNION&rsquo;,&rsquo;FASTWEB&rsquo;) NOT NULL,<br />
	KEY time_key (cur_date)<br />
);
      <a href="/2011/07/27/prepare-mysql-for-self-monitor/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page8">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page active">
      <a href="#">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li class="page">
      <a href="/page17">17</a>
    </li>
    <li class="page">
      <a href="/page18">18</a>
    </li>
    <li class="page">
      <a href="/page19">19</a>
    </li>
    <li>
      <a href="/page10">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
                 <li><a href="/2015/12/27/report-of-this-year/">2015 年度个人总结</a></li>
                 <li><a href="/2015/11/25/rsyslog-mmnormalize/">Rsyslog 的 mmnormalize 模块用法</a></li>
                 <li><a href="/2015/10/29/siren/">SIREn 插件试用</a></li>
                 <li><a href="/2015/10/25/escc/">ESCC 参会笔记</a></li>
                 <li><a href="/2015/10/20/escc/">ESCC 参会笔记</a></li>
                 <li><a href="/2015/09/24/condition-in-rsyslog/">rsyslog 中 if 条件判断的限制</a></li>
                 <li><a href="/2015/08/25/kibana-custom-field-formatters/">【翻译】Kibana 字段的自定义展示格式开发</a></li>
                 <li><a href="/2015/04/03/types-mapping-conflict-in-one-index/">Elasticsearch 同一索引不同类型下同名字段的映射冲突实例</a></li>
                 <li><a href="/2015/03/16/juttle-intro/">juttle 介绍</a></li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
              <li><a href="http://showmetheco.de/" title="Viacheslav Tykhanovskyi(PocketIO/Text::Haml)">No time to wait</a></li>
              <li><a href="http://blog.dataloop.io/" title="A new SaaS monitoring tool for DevOps & Operations">Dataloop.IO</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://planeteria.org/perl6/" title="Perl6 文集">Planet Perl 6</a></li>
              <li><a href="http://www.metaforsoftware.com/blog/" title="">metafor</a></li>
              <li><a href="http://blog.kablamo.org/" title="Eric Johnson，一个游走在伦敦和北京的 Perler">kablamo</a></li>
              <li><a href="http://aphyr.com/posts" title="call me maybe 吐槽系列">Aphyr</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://timo.piqiu.me/" title="TIMO IS MY OASIS">Timo</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.lark.net.cn/" title="王剑">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://junqili.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://blog.l8ii.com/" title="刘侨">LairdNote</a></li>
              <li><a href="http://flw.tools/" title="">flw的工具箱</a></li>
              <li><a href="http://blog.mcshell.org/" title="">mcshell</a></li>
              <li><a href="http://novoland.github.io/" title="">克鲁斯卡尔的博客</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="booklists" class="nav nav-list">
          <li class="nav-header">我写的技术书籍</li>
          <li><a href='http://product.china-pub.com/3769604'><img src='http://images.china-pub.com/ebook3765001-3770000/3769604/shupi.jpg' border='0' alt='网站运维技术与实践'/></a></li>
          <li><a href='http://product.china-pub.com/64005'><img src='http://images.china-pub.com/ebook60001-65000/64005/shupi.jpg' border='0' alt='ELK Stack权威指南'/></a></li>
          <li class="nav-header">我参与翻译的技术书籍</li>
          <li><a href='http://product.china-pub.com/4582714'><img src='http://images.china-pub.com/ebook4580001-4585000/4582714/shupi.jpg' border='0' alt='Puppet 实战手册'/></a></li>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2015 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
  </body>
</html>
