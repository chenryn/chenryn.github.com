<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">标签</a></li>
      	<li><a href="/archive.html">归档</a></li>
      	<li><a href="/errata.html">《网站运维技术与实践》勘误</a></li>
      	<li><a href="/projects.html">学习记录</a></li>
      	<li><a href="/categories.html">分类</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/20/awk-efficiency" title="awk的效率" rel="bookmark">awk的效率</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-20 00:00:00 +0800">20 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>偶然和某人谈到日志处理。最简单常见的需求，日志中访问量最大的前十个IP及其访问次数。</p>
<table>
  <tbody>
    <tr>
      <td>最常见的shell命令：cat access.log</td>
      <td> cut -d &lsquo; &lsquo; -f 4 </td>
      <td>sort</td>
      <td>uniq -c</td>
      <td>sort -nr</td>
      <td>head</td>
    </tr>
  </tbody>
</table>
<table>
  <tbody>
    <tr>
      <td>我最常用的awk命令：awk &lsquo;{a[$4]++}END{for(i in a){print a[i],i}}&rsquo; access.log</td>
      <td>sort -nr</td>
      <td>head</td>
    </tr>
  </tbody>
</table>
<p>对方表示上一种速度最快，而我说是下一种。</p>
<p>最后找到一个13G大小的access.log，用time命令分别检测命令用时。结果处理一个13GB的日志，shell花了13分钟，awk花了1分半钟……</p>
      <a href="/2011/01/20/awk-efficiency" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/13/learning-accel-dynamic-data" title="读《基于动态内容的缓存加速技术》笔记" rel="bookmark">读《基于动态内容的缓存加速技术》笔记</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-13 00:00:00 +0800">13 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>《程序员》2010年11月刊的86-89四页，刊登了F5售前技术顾问，原VIACDN(TOM的CDN部门，后来独立运营)架构师徐超的文章《基于动态内容的缓存加速技术——F5 Web Accelerator产品技术剖析》。</p>
<p>文章的前三分之一内容，主要是讲述RFC2616和一般浏览器、服务器的具体实现。已经比较熟悉了，略过……</p>
<p>然后进入关键内容。</p>
<p>“让浏览器缓存能够为动态页面工作”：
A. 修改Transfer-Encoding: chunked的内容输出Content-Length。
这个squid已经做到了。其实质就是在获取url的body时，累加每个chunk的size，直到碰上MSB为0的last-chunk标记。
B. 添加Last-Modified。
这个squid差一步。squid实质已经获取了文件在本地的mtime，但只在源header不存在last-modified的时候才用于LM-factor算法。
C. 删除Expires。
大概是为了统一成HTTP/1.1的header，所以选择了删除expires？或者就是纯粹了节省代码吧……
D. 修改Cache-Control。有Expires按这个设定max-age，或者按配置设定；有private的修改成public；添加must-revalidated。
这个squid用header_access和header_replace就能完成。</p>
<p>“Web Accelerator如何识别动态页面的更新并保持更新”：
A. 预加载。
这个通过squid的补丁html prefetching可以完成
B. 根据上一章节的修改结果，浏览器对&rdquo;动态html&rdquo;每次都可以发送IMS到F5。F5向源站请求该html，并比对缓存内容。
其他过程和一般的IMS过程一样，关键在比对缓存内容。如果这个&rdquo;动态&rdquo;只是html文字内容的更新，还是正常范围；如果&rdquo;动态交互&rdquo;的结果还包括其他CSS/JS/JPG/GIF的变动，这个功能就比较有用了。
根据预加载的功能，每次确认html时重新预比对。考虑到CSS/JS/JPG/GIF一般来说都是会输出Last-Modified的，这个比对返回结果应该比较快。都没问题的话，跳过这步；
如果有部分文件mtime也变动了，开始预加载，并另存为一个带有版本号的url(比如logo.gif;pv=***)，用&rsquo;,&rsquo;而不能用&rsquo;?&rsquo;，因为?在浏览器上是不缓存的；
同时修改主文件html的内容，替换url链接为新版本号的url。最后发送这个新版本html给浏览器。
这种版本号控制的方法也节省了缓存更新时的删除操作IO，而统一交给LRU之类的完成。
想到LRU，一个疑问：当缓存不足时，假如logo.gif已经被prune出去了，那这个时候的F5怎么办？几个猜测办法：
1、浪费一点带宽和时间，以新版本号url的形式重新进入缓存；
2、用一个版本号/mtime的K-V数据库完成url版本控制；
3、F5作为特定类型给某些网站使用，就不考虑海量文件的问题。
最后，我还是觉得url版本控制这种事情，还是由网站开发人员来做CMS比较靠谱。</p>
<p>“反向动态代理”
上面的方式，确实保证了数据&rdquo;实时&rdquo;性，而且充分利用了浏览器缓存，但一次刷新引发F5和源站之间几十上百次的比对，还是比较郁闷的。所以当网站的&rdquo;动态&rdquo;结构比较清晰时，比如一个论坛，明确知道帖子列表变动就是因为有人发帖了；而且可以从发帖的POST请求url里推导出版面url的，可以采用这种技术。
一旦接收到POST请求，F5自动根据配置purge版面url的缓存。而不用去比对。</p>
<p>“MultiConnect技术”
因为浏览器对同一域名并发连接很少，所以F5可以自动替换html里的url，根据配置把image.x.com换成img1.x.com/img2.x.com/img3.x.com……前提是你的DNS上确实有这些解析。
不过要注意，域名太多也会拖慢浏览器速度的。dns解析需要时间。</p>
<p>总之，个人感觉这些技术还是比较现实的，但都用很强的应用场景针对性。呵呵~</p>
      <a href="/2011/01/13/learning-accel-dynamic-data" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/12/resin-status" title="resin-status" rel="bookmark">resin-status</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-12 00:00:00 +0800">12 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>和apache、nginx一样，resin也自带了一个比较简易的status模块，只需要在resin.conf里配置就行了。在里添加如下一段：</p>
<div class="highlight"><pre><code class="xml">    <span class="nt">&lt;servlet-mapping</span> <span class="na">servlet-class=</span><span class="s">&#39;com.caucho.servlets.ResinStatusServlet&#39;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;url-pattern&gt;</span>/resin-status<span class="nt">&lt;/url-pattern&gt;</span>
      <span class="nt">&lt;init</span> <span class="na">enable=</span><span class="s">&quot;read&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
</code></pre></div>
<p>重启resin即可。</p>
<p>然后curl访问http://127.0.0.1:8080/resin-status就可以看到输出了。</p>
<p>用浏览器的话，大致如下图：
<img src="/images/uploads/resin.jpg" alt="resin" /></p>
<p>可以关注线程数、连接数、内存使用大小和请求处理数。</p>
<p>如果要做监控的话，直接从html里获取相应数值即可。</p>
<p>唯一需要稍微注意的是请求处理数。因为其他的都是AVERAGE，只有这个是COUNTER型的。要是想很方便的看到rps。可以采用如下方法查看：</p>
<div class="highlight"><pre><code class="bash"><span class="c"># a=`curl -s http://127.0.0.1:8081/resin-status|awk -F/ &#39;/Invocation/{print $NF}&#39;`;sleep 1;curl -s http://10.168.168.56:8081/resin-status|awk -F/ &#39;/Invocation/{print($NF-&#39;$a&#39;}&#39;</span>
718
</code></pre></div>
<p>这里比较有趣的是因为这行的数据本身是有个括号的，所以就有了各种各样的写法和报错了。一并贴上来，可以体会一下awk的系统变量/内部函数/字符类型的用法：</p>
<div class="highlight"><pre><code class="bash"><span class="c"># a=`curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF}&#39;`;sleep 10;curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF-&#39;$a&#39;}&#39;</span>
awk: cmd. line:1: /Invocation/<span class="o">{</span>print <span class="nv">$NF</span>-3949612<span class="o">)}</span>
awk: cmd. line:1:                               ^ syntax error
<span class="c"># a=`curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF}&#39;`;sleep 10;curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF-&#39;&quot;$a&quot;&#39;}&#39;</span>
awk: cmd. line:1: /Invocation/<span class="o">{</span>print <span class="nv">$NF</span>-4025373<span class="o">)}</span>
awk: cmd. line:1:                               ^ syntax error
<span class="c"># a=`curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF}&#39;`;sleep 10;curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF-&quot;&#39;$a&#39;&quot;}&#39;</span>
7607
<span class="c"># a=`curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print substr($NF,0,length($NF)-1)}&#39;`;sleep 10;curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF-&#39;$a&#39;}&#39;</span>
7927
<span class="c"># a=`curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF}&#39;`;sleep 10;curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print($NF-&#39;$a&#39;}&#39;</span>
7212
</code></pre></div>
      <a href="/2011/01/12/resin-status" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/11/construct-http-auth-header" title="HTTP的auth请求模拟" rel="bookmark">HTTP的auth请求模拟</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-11 00:00:00 +0800">11 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>开发同事需要在程序中调用一个“安全级别比较高”的url，起初没觉得有啥问题，我们wget或者curl的时候，按照标准url的格式（即&rsquo;请求方法://用户名:密码@域名/文件路径&rsquo;）写就完全OK了。不过很快同事转来了报错：</p>
<p><span style="color:#000000;font-family:Verdana;font-size:x-small;"><span style="font-family:Verdana;font-size:x-small;"><span style="font-family:Verdana;font-size:x-small;">java.io.IOException: Server returned HTTP response code: 401 for URL: <a href="http://gundong:gdxw6354@editornew.china.com/interface/addcategory.php?parentid=2&amp;id=2&amp;name=gbox_%D0%C7%BC%CA%D5%F9%B0%D4&amp;groupname=game&amp;code=satrcraft&amp;m=09286f9d135d5debe7052bea42a27eef">http://test:test1234@test.domain.com/interface/addcategory.php?parentid=2&amp;id=2&amp;name=gbox_%D0%C7%BC%CA%D5%F9%B0%D4&amp;groupname=game&amp;code=satrcraft&amp;m=09286f9d135d5debe7052bea42a27eef</a></span></span></span>
原来用的是IO的方式，我用telnet模拟一下，结果还真是这样：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@cms ~<span class="o">]</span><span class="c"># telnet test.domain.com 80</span>
Trying 123.124.125.126...
Connected to test.domain.com <span class="o">(</span>123.124.125.126<span class="o">)</span>.
Escape character is <span class="s1">&#39;^]&#39;</span>.
GET http://test:test1234@test.domain.com/interface/addcategory.php?parentid<span class="o">=</span>2&amp;amp;id<span class="o">=</span>2&amp;amp;name<span class="o">=</span>gbox_%D0%C7%BC%CA%D5%F9%B0%D4&amp;amp;groupname<span class="o">=</span>game&amp;amp;code<span class="o">=</span>satrcraft&amp;amp;m<span class="o">=</span>09286f9d135d5debe7052bea42a27eef HTTP/1.0
HTTP/1.1 401 Authorization Required
Date: Tue, 11 Jan 2011 03:39:37 GMT
Server: Apache/1.3.37 <span class="o">(</span>Unix<span class="o">)</span> PHP/4.4.9
WWW-Authenticate: Basic <span class="nv">realm</span><span class="o">=</span><span class="s2">&quot;CMS-Testdotcom&quot;</span>
Connection: close
Content-Type: text/html; <span class="nv">charset</span><span class="o">=</span>iso-8859-1
</code></pre></div>
<p>查了一下HTTP协议，原来auth是走的另外一个header完成Authorization，其格式是Authorization: Basic &lsquo;encoded_base64(user:passwd)&rsquo;。服务器会自动的用decoded_base64()解析字符串得到真正的用户名和密码。原来wget和curl这些工具不单单是发个请求这么简单啊~~</p>
<p>重新试验，先计算test:test1234的base64值：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@cms ~<span class="o">]</span><span class="c"># echo test:test1234|openssl base64</span>
<span class="nv">dGVzdDp0ZXN0MTIzNAo</span><span class="o">=</span>
<span class="o">[</span>root@cms ~<span class="o">]</span><span class="c"># telnet test.domain.com 80</span>
Trying 123.124.125.126...
Connected to test.domain.com <span class="o">(</span>123.124.125.126<span class="o">)</span>.
Escape character is <span class="s1">&#39;^]&#39;</span>.
GET http://test.domain.com/interface/addcategory.php?parentid<span class="o">=</span>2&amp;amp;id<span class="o">=</span>2&amp;amp;name<span class="o">=</span>gbox_%D0%C7%BC%CA%D5%F9%B0%D4&amp;amp;groupname<span class="o">=</span>game&amp;amp;code<span class="o">=</span>satrcraft&amp;amp;m<span class="o">=</span>09286f9d135d5debe7052bea42a27eef HTTP/1.0
Authorization: Basic <span class="nv">dGVzdDp0ZXN0MTIzNAo</span><span class="o">=</span>
HTTP/1.1 200 OK
Date: Tue, 11 Jan 2011 05:21:32 GMT
Server: Apache/1.3.37 <span class="o">(</span>Unix<span class="o">)</span> PHP/4.4.9
X-Powered-By: PHP/4.4.9
Connection: close
Content-Type: text/html
2 <span class="o">||</span> 2|| gbox_星际争霸 <span class="o">||</span> satrcraft <span class="o">||</span> game &lt;br/&gt;09286f9d135d5debe7052bea42a27eef&lt;br/&gt;2Connection closed by foreign host.
</code></pre></div>
<p>果然就可以了~~</p>
      <a href="/2011/01/11/construct-http-auth-header" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/10/mysqlreport-guide" title="mysqlreport指南" rel="bookmark">mysqlreport指南</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-10 00:00:00 +0800">10 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#database-ref" title="database" rel="category tag">database</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>mysqlreport是mysql性能监测时最常用的工具，对了解mysql运行状态和配置调整都有很大的帮助。找了一些mysql的资料，发现大多数是关于php+mysql开发的，服务配置基本就是固定的几条。干脆找上mysqlreport的官网，啃下来这篇指南。翻译都是随着我个人的语言习惯，对直接能用mysql命令上看到结果的英文则保留下来。方便以后查找：</p>
<p>原文地址：<a href="http://hackmysql.com/mysqlreportguide">http://hackmysql.com/mysqlreportguide</a></p>
<h1 id="mysqlreport">《mysqlreport指南》</h1>
<p>本指南的写作目的是解释mysqlreport上出具的各种数据。通过指南，你可以在阅读完mysqlreport的报告后，完整的解释并且理解一个最根本的问题——而这也正是你使用mysqlreport的目的所在——（我的）MySQL服务器到底运行的怎么样？</p>
<p>当前的mysqlreport版本会自动生成一份尽可能完整的数据报表，最多可达14节121行。您不必再像以前那样输入各种各样的参数定义了。不过如果您的mysql服务配置上关闭了某些部分的话，报表的相关部分也会随之关闭。比如，你关闭了<code>query cache</code>，那么mysqlreport的第4节&rsquo;Query Cache&rsquo;也就不存在了。所以报表长度是浮动的。</p>
<p>为了便于理解和观察，本指南采用了对一份完整报表做出逐行解释的方法。下面就是将要被详细解析的那份报表，为了方便，在最前端加上了行号。</p>
<div class="highlight"><pre><code class="mysql"><span class="mi">1</span> <span class="n">MySQL</span> <span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span>              <span class="n">uptime</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">26</span>       <span class="n">Fri</span> <span class="n">Sep</span>  <span class="mi">1</span> <span class="mi">19</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">02</span> <span class="mi">2006</span>
<span class="mi">2</span>
<span class="mi">3</span> <span class="n">__</span> <span class="k">Key</span> <span class="n">_________________________________________________________________</span>
<span class="mi">4</span> <span class="n">Buffer</span> <span class="n">used</span>   <span class="mi">380</span><span class="p">.</span><span class="mi">00</span><span class="n">k</span> <span class="n">of</span> <span class="mi">512</span><span class="p">.</span><span class="mi">00</span><span class="n">M</span>  <span class="o">%</span><span class="n">Used</span><span class="p">:</span>   <span class="mi">0</span><span class="p">.</span><span class="mi">07</span>
<span class="mi">5</span>   <span class="n">Current</span>      <span class="mi">59</span><span class="p">.</span><span class="mi">32</span><span class="n">M</span>            <span class="o">%</span><span class="k">Usage</span><span class="p">:</span>  <span class="mi">11</span><span class="p">.</span><span class="mi">59</span>
<span class="mi">6</span> <span class="k">Write</span> <span class="n">hit</span>      <span class="mi">97</span><span class="p">.</span><span class="mi">04</span><span class="o">%</span>
<span class="mi">7</span> <span class="k">Read</span> <span class="n">hit</span>       <span class="mi">99</span><span class="p">.</span><span class="mi">58</span><span class="o">%</span>
<span class="mi">8</span>
<span class="mi">9</span> <span class="n">__</span> <span class="n">Questions</span> <span class="n">___________________________________________________________</span>
<span class="mi">10</span> <span class="n">Total</span>          <span class="mi">98</span><span class="p">.</span><span class="mi">06</span><span class="n">k</span>   <span class="mi">47</span><span class="p">.</span><span class="mi">46</span><span class="o">/</span><span class="n">s</span>
<span class="mi">11</span>   <span class="n">DMS</span>          <span class="mi">81</span><span class="p">.</span><span class="mi">23</span><span class="n">k</span>   <span class="mi">39</span><span class="p">.</span><span class="mi">32</span><span class="o">/</span><span class="n">s</span>  <span class="o">%</span><span class="n">Total</span><span class="p">:</span>  <span class="mi">82</span><span class="p">.</span><span class="mi">84</span>
<span class="mi">12</span>   <span class="n">QC</span> <span class="n">Hits</span>      <span class="mi">16</span><span class="p">.</span><span class="mi">58</span><span class="n">k</span>    <span class="mi">8</span><span class="p">.</span><span class="mi">02</span><span class="o">/</span><span class="n">s</span>           <span class="mi">16</span><span class="p">.</span><span class="mi">91</span>
<span class="mi">13</span>   <span class="n">COM_QUIT</span>        <span class="mi">200</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">10</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">20</span>
<span class="mi">14</span>   <span class="n">Com_</span>            <span class="mi">131</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">06</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">13</span>
<span class="mi">15</span>   <span class="o">-</span><span class="n">Unknown</span>         <span class="mi">82</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">04</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">08</span>
<span class="mi">16</span> <span class="n">Slow</span> <span class="mi">5</span> <span class="n">s</span>            <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>  <span class="o">%</span><span class="n">DMS</span><span class="p">:</span>   <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>  <span class="n">Log</span><span class="p">:</span>  <span class="k">ON</span>
<span class="mi">17</span> <span class="n">DMS</span>            <span class="mi">81</span><span class="p">.</span><span class="mi">23</span><span class="n">k</span>   <span class="mi">39</span><span class="p">.</span><span class="mi">32</span><span class="o">/</span><span class="n">s</span>           <span class="mi">82</span><span class="p">.</span><span class="mi">84</span>
<span class="mi">18</span>   <span class="k">SELECT</span>       <span class="mi">64</span><span class="p">.</span><span class="mi">44</span><span class="n">k</span>   <span class="mi">31</span><span class="p">.</span><span class="mi">19</span><span class="o">/</span><span class="n">s</span>           <span class="mi">65</span><span class="p">.</span><span class="mi">72</span>         <span class="mi">79</span><span class="p">.</span><span class="mi">33</span>
<span class="mi">19</span>   <span class="k">INSERT</span>       <span class="mi">16</span><span class="p">.</span><span class="mi">75</span><span class="n">k</span>    <span class="mi">8</span><span class="p">.</span><span class="mi">11</span><span class="o">/</span><span class="n">s</span>           <span class="mi">17</span><span class="p">.</span><span class="mi">08</span>         <span class="mi">20</span><span class="p">.</span><span class="mi">61</span>
<span class="mi">20</span>   <span class="k">UPDATE</span>           <span class="mi">41</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">02</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">04</span>          <span class="mi">0</span><span class="p">.</span><span class="mi">05</span>
<span class="mi">21</span>   <span class="k">REPLACE</span>           <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>          <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">22</span>   <span class="k">DELETE</span>            <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>          <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">23</span> <span class="n">Com_</span>              <span class="mi">131</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">06</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">13</span>
<span class="mi">24</span>   <span class="n">change_db</span>       <span class="mi">119</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">06</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">12</span>
<span class="mi">25</span>   <span class="n">show_fields</span>       <span class="mi">9</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">01</span>
<span class="mi">26</span>   <span class="n">show_status</span>       <span class="mi">2</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">27</span>
<span class="mi">28</span> <span class="n">__</span> <span class="k">SELECT</span> <span class="k">and</span> <span class="n">Sort</span> <span class="n">_____________________________________________________</span>
<span class="mi">29</span> <span class="n">Scan</span>               <span class="mi">38</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">02</span><span class="o">/</span><span class="n">s</span> <span class="o">%</span><span class="k">SELECT</span><span class="p">:</span>   <span class="mi">0</span><span class="p">.</span><span class="mi">06</span>
<span class="mi">30</span> <span class="n">Range</span>              <span class="mi">14</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">02</span>
<span class="mi">31</span> <span class="n">Full</span> <span class="k">join</span>           <span class="mi">3</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">32</span> <span class="n">Range</span> <span class="k">check</span>         <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">33</span> <span class="n">Full</span> <span class="n">rng</span> <span class="k">join</span>       <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">34</span> <span class="n">Sort</span> <span class="n">scan</span>          <span class="mi">14</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="o">/</span><span class="n">s</span>
<span class="mi">35</span> <span class="n">Sort</span> <span class="n">range</span>         <span class="mi">26</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="o">/</span><span class="n">s</span>
<span class="mi">36</span> <span class="n">Sort</span> <span class="n">mrg</span> <span class="n">pass</span>       <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>
<span class="mi">37</span>
<span class="mi">38</span> <span class="n">__</span> <span class="n">Query</span> <span class="n">Cache</span> <span class="n">_________________________________________________________</span>
<span class="mi">39</span> <span class="n">Memory</span> <span class="k">usage</span>   <span class="mi">17</span><span class="p">.</span><span class="mi">81</span><span class="n">M</span> <span class="n">of</span>  <span class="mi">32</span><span class="p">.</span><span class="mi">00</span><span class="n">M</span>  <span class="o">%</span><span class="n">Used</span><span class="p">:</span>  <span class="mi">55</span><span class="p">.</span><span class="mi">66</span>
<span class="mi">40</span> <span class="n">Block</span> <span class="n">Fragmnt</span>  <span class="mi">13</span><span class="p">.</span><span class="mi">05</span><span class="o">%</span>
<span class="mi">41</span> <span class="n">Hits</span>           <span class="mi">16</span><span class="p">.</span><span class="mi">58</span><span class="n">k</span>    <span class="mi">8</span><span class="p">.</span><span class="mi">02</span><span class="o">/</span><span class="n">s</span>
<span class="mi">42</span> <span class="n">Inserts</span>        <span class="mi">48</span><span class="p">.</span><span class="mi">50</span><span class="n">k</span>   <span class="mi">23</span><span class="p">.</span><span class="mi">48</span><span class="o">/</span><span class="n">s</span>
<span class="mi">43</span> <span class="n">Prunes</span>         <span class="mi">33</span><span class="p">.</span><span class="mi">46</span><span class="n">k</span>   <span class="mi">16</span><span class="p">.</span><span class="mi">20</span><span class="o">/</span><span class="n">s</span>
<span class="mi">44</span> <span class="n">Insrt</span><span class="p">:</span><span class="n">Prune</span>    <span class="mi">1</span><span class="p">.</span><span class="mi">45</span><span class="p">:</span><span class="mi">1</span>    <span class="mi">7</span><span class="p">.</span><span class="mi">28</span><span class="o">/</span><span class="n">s</span>
<span class="mi">45</span> <span class="n">Hit</span><span class="p">:</span><span class="k">Insert</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">34</span><span class="p">:</span><span class="mi">1</span>
<span class="mi">46</span>
<span class="mi">47</span> <span class="n">__</span> <span class="k">Table</span> <span class="n">Locks</span> <span class="n">_________________________________________________________</span>
<span class="mi">48</span> <span class="n">Waited</span>          <span class="mi">1</span><span class="p">.</span><span class="mi">01</span><span class="n">k</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">49</span><span class="o">/</span><span class="n">s</span>  <span class="o">%</span><span class="n">Total</span><span class="p">:</span>   <span class="mi">1</span><span class="p">.</span><span class="mi">24</span>
<span class="mi">49</span> <span class="n">Immediate</span>      <span class="mi">80</span><span class="p">.</span><span class="mi">04</span><span class="n">k</span>   <span class="mi">38</span><span class="p">.</span><span class="mi">74</span><span class="o">/</span><span class="n">s</span>
<span class="mi">50</span>
<span class="mi">51</span> <span class="n">__</span> <span class="kp">Tables</span> <span class="n">______________________________________________________________</span>
<span class="mi">52</span> <span class="n">Open</span>              <span class="mi">107</span> <span class="n">of</span> <span class="mi">1024</span>    <span class="o">%</span><span class="n">Cache</span><span class="p">:</span>  <span class="mi">10</span><span class="p">.</span><span class="mi">45</span>
<span class="mi">53</span> <span class="n">Opened</span>            <span class="mi">118</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">06</span><span class="o">/</span><span class="n">s</span>
<span class="mi">54</span>
<span class="mi">55</span> <span class="n">__</span> <span class="n">Connections</span> <span class="n">_________________________________________________________</span>
<span class="mi">56</span> <span class="n">Max</span> <span class="n">used</span>           <span class="mi">77</span> <span class="n">of</span>  <span class="mi">600</span>      <span class="o">%</span><span class="n">Max</span><span class="p">:</span>  <span class="mi">12</span><span class="p">.</span><span class="mi">83</span>
<span class="mi">57</span> <span class="n">Total</span>             <span class="mi">202</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">10</span><span class="o">/</span><span class="n">s</span>
<span class="mi">58</span>
<span class="mi">59</span> <span class="n">__</span> <span class="n">Created</span> <span class="n">Temp</span> <span class="n">________________________________________________________</span>
<span class="mi">60</span> <span class="n">Disk</span> <span class="k">table</span>         <span class="mi">10</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>
<span class="mi">61</span> <span class="k">Table</span>              <span class="mi">26</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="o">/</span><span class="n">s</span>    <span class="n">Size</span><span class="p">:</span>  <span class="mi">4</span><span class="p">.</span><span class="mi">00</span><span class="n">M</span>
<span class="mi">62</span> <span class="n">File</span>                <span class="mi">3</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>
<span class="mi">63</span>
<span class="mi">64</span> <span class="n">__</span> <span class="n">Threads</span> <span class="n">_____________________________________________________________</span>
<span class="mi">65</span> <span class="n">Running</span>            <span class="mi">55</span> <span class="n">of</span>   <span class="mi">77</span>
<span class="mi">66</span> <span class="n">Cache</span>               <span class="mi">0</span>              <span class="o">%</span><span class="n">Hit</span><span class="p">:</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">5</span>
<span class="mi">67</span> <span class="n">Created</span>           <span class="mi">201</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">10</span><span class="o">/</span><span class="n">s</span>
<span class="mi">68</span> <span class="n">Slow</span>                <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>
<span class="mi">69</span>
<span class="mi">70</span> <span class="n">__</span> <span class="n">Aborted</span> <span class="n">_____________________________________________________________</span>
<span class="mi">71</span> <span class="n">Clients</span>             <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>
<span class="mi">72</span> <span class="n">Connects</span>            <span class="mi">8</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>
<span class="mi">73</span>
<span class="mi">74</span> <span class="n">__</span> <span class="n">Bytes</span> <span class="n">_______________________________________________________________</span>
<span class="mi">75</span> <span class="n">Sent</span>           <span class="mi">38</span><span class="p">.</span><span class="mi">46</span><span class="n">M</span>  <span class="mi">18</span><span class="p">.</span><span class="mi">62</span><span class="n">k</span><span class="o">/</span><span class="n">s</span>
<span class="mi">76</span> <span class="n">Received</span>        <span class="mi">7</span><span class="p">.</span><span class="mi">98</span><span class="n">M</span>   <span class="mi">3</span><span class="p">.</span><span class="mi">86</span><span class="n">k</span><span class="o">/</span><span class="n">s</span>
<span class="mi">77</span>
<span class="mi">78</span> <span class="n">__</span> <span class="n">InnoDB</span> <span class="n">Buffer</span> <span class="n">Pool</span> <span class="n">__________________________________________________</span>
<span class="mi">79</span> <span class="k">Usage</span>           <span class="mi">3</span><span class="p">.</span><span class="mi">95</span><span class="n">M</span> <span class="n">of</span>   <span class="mi">7</span><span class="p">.</span><span class="mi">00</span><span class="n">M</span>  <span class="o">%</span><span class="n">Used</span><span class="p">:</span>  <span class="mi">56</span><span class="p">.</span><span class="mi">47</span>
<span class="mi">80</span> <span class="k">Read</span> <span class="n">hit</span>       <span class="mi">99</span><span class="p">.</span><span class="mi">99</span><span class="o">%</span>
<span class="mi">81</span> <span class="n">Pages</span>
<span class="mi">82</span>   <span class="n">Free</span>            <span class="mi">195</span>            <span class="o">%</span><span class="n">Total</span><span class="p">:</span>  <span class="mi">43</span><span class="p">.</span><span class="mi">53</span>
<span class="mi">83</span>   <span class="n">Data</span>            <span class="mi">249</span>                     <span class="mi">55</span><span class="p">.</span><span class="mi">58</span> <span class="o">%</span><span class="n">Drty</span><span class="p">:</span>   <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">84</span>   <span class="n">Misc</span>              <span class="mi">4</span>                      <span class="mi">0</span><span class="p">.</span><span class="mi">89</span>
<span class="mi">85</span>   <span class="n">Latched</span>           <span class="mi">0</span>                      <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">86</span> <span class="k">Reads</span>         <span class="mi">574</span><span class="p">.</span><span class="mi">56</span><span class="n">k</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="o">/</span><span class="n">s</span>
<span class="mi">87</span>   <span class="k">From</span> <span class="n">file</span>       <span class="mi">176</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">03</span>
<span class="mi">88</span>   <span class="n">Ahead</span> <span class="n">Rnd</span>         <span class="mi">4</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">89</span>   <span class="n">Ahead</span> <span class="k">Sql</span>         <span class="mi">2</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">90</span> <span class="n">Writes</span>        <span class="mi">160</span><span class="p">.</span><span class="mi">82</span><span class="n">k</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="o">/</span><span class="n">s</span>
<span class="mi">91</span> <span class="n">Flushes</span>         <span class="mi">1</span><span class="p">.</span><span class="mi">04</span><span class="n">k</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">92</span> <span class="n">Wait</span> <span class="n">Free</span>           <span class="mi">0</span>       <span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">93</span>
<span class="mi">94</span> <span class="n">__</span> <span class="n">InnoDB</span> <span class="k">Lock</span> <span class="n">_________________________________________________________</span>
<span class="mi">95</span> <span class="n">Waits</span>               <span class="mi">0</span>       <span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">96</span> <span class="n">Current</span>             <span class="mi">0</span>
<span class="mi">97</span> <span class="kt">Time</span> <span class="n">acquiring</span>
<span class="mi">98</span>   <span class="n">Total</span>             <span class="mi">0</span> <span class="n">ms</span>
<span class="mi">99</span>   <span class="n">Average</span>           <span class="mi">0</span> <span class="n">ms</span>
<span class="mi">100</span>  <span class="n">Max</span>               <span class="mi">0</span> <span class="n">ms</span>
<span class="mi">101</span>
<span class="mi">102</span> <span class="n">__</span> <span class="n">InnoDB</span> <span class="n">Data</span><span class="p">,</span> <span class="n">Pages</span><span class="p">,</span> <span class="n">Rows</span> <span class="n">____________________________________________</span>
<span class="mi">103</span> <span class="n">Data</span>
<span class="mi">104</span>   <span class="k">Reads</span>           <span class="mi">225</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">105</span>   <span class="n">Writes</span>          <span class="mi">799</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">106</span>   <span class="n">fsync</span>           <span class="mi">541</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">107</span>   <span class="n">Pending</span>
<span class="mi">108</span>     <span class="k">Reads</span>           <span class="mi">0</span>
<span class="mi">109</span>     <span class="n">Writes</span>          <span class="mi">0</span>
<span class="mi">110</span>     <span class="n">fsync</span>           <span class="mi">0</span>
<span class="mi">111</span>
<span class="mi">112</span> <span class="n">Pages</span>
<span class="mi">113</span>   <span class="n">Created</span>          <span class="mi">23</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">114</span>   <span class="k">Read</span>            <span class="mi">226</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">115</span>   <span class="n">Written</span>       <span class="mi">1</span><span class="p">.</span><span class="mi">04</span><span class="n">k</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">116</span>
<span class="mi">117</span> <span class="n">Rows</span>
<span class="mi">118</span>   <span class="n">Deleted</span>      <span class="mi">25</span><span class="p">.</span><span class="mi">04</span><span class="n">k</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">119</span>   <span class="n">Inserted</span>     <span class="mi">25</span><span class="p">.</span><span class="mi">04</span><span class="n">k</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">120</span>   <span class="k">Read</span>         <span class="mi">81</span><span class="p">.</span><span class="mi">91</span><span class="n">k</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="n">s</span>
<span class="mi">121</span>   <span class="n">Updated</span>           <span class="mi">0</span>       <span class="mi">0</span><span class="o">/</span><span class="n">s</span>
</code></pre></div>
<h1 id="section">报表抬头：第1行</h1>
<p>本行包括三部分信息：MySQL版本，MySQL运行时间，服务器当前时间。显示版本是为了提醒有些功能可能这台mysql没有；显示运行时间是为了评估报表数据的精准度。事实上，如果一台mysql运行时间连几个小时都没有的，生成的很可能是一份扭曲并且充满误导意见的报表。甚至几个小时都不够，因为它可能是在半夜没啥访问量的时候运行的几个小时。所以建议最少要运行过一个24小时，时间越长越能反应真实情况。
在本例中，运行时间只有34分钟，所以报表也不具有真实的代表意义。</p>
<h1 id="section-1">索引报表：3-7行</h1>
<p>索引报表是第一个主要章节，因为索引(key或者说index)对于mysql数据库，是最最最重要的。虽然报表不可能直接告诉你这个库的索引好还是不好，但它能告诉你这个索引缓冲区(key buffer)被利用的怎么样了。
注意：本报表仅汇总默认的MyISAM表的共享key buffer信息，而不会管管理员自建的其他空间。</p>
<h1 id="section-2">缓冲区使用情况：第4行</h1>
<p>对于mysql，我们的第一个问题就是：到底用了多少key buffer？如果不太多，没问题~因为mysql只会在有需求的时候才分配系统内存给key buffer。也就是说，my.cnf中定义了<code>key_buffer_size=512M</code>，不代表mysql启动时就创建一个512M大小的key buffer。</p>
<p>本行显示的，是mysql曾经使用过的key buffer峰值大小。而事实上，mysql应该用的更少，或者诡异的更多。这个更多的情况，mysql的术语叫“高水位”这个情况和my.cnf里的<code>key_buffer_size</code>是否足够大密切相关。当“水位”已经达到80-90%的时候，赶紧加大你的<code>key_buffer_size</code>吧。</p>
<p>注意：永远不用“担心”这个值超过95%，mysql文档指出，key buffer中的一部分会被mysql主程序用于内部数据结构，这些是mysqlreport无法统计的内容。所以，所谓的95%，其实已经是100%了……</p>
<h1 id="section-3">当前情况：第5行</h1>
<p>这行只有在mysql版本高于4.1.2时出现，因为之前mysql的<code>show status</code>中没有<code>key_blocks_unused</code>。这行数据显示的是mysql当前使用的key buffer大小。如果上行的used%太大的话，那么这行必然不会超过used，除非碰上那个传说中的bug了。综合这两行，相信对<code>key_buffer_size</code>的设置是否合理就有谱了~</p>
<p>本例中，mysql使用了60M的key buffer(12%)，这就很不错，离满负荷运行还早着呢。</p>
<h1 id="section-4">写命中：第6行</h1>
<p>从本质上说，索引是基于内存的。因为访问内存的速度比硬盘快太多了。不过，mysql从磁盘里进行一点点读写操作总是不可避免的。</p>
<p>这行数据显示了写索引的效率(具体意思是：写入磁盘的key与写入内存的key的比值)。这个值没有什么参考答案，而是取决于业务类型。如果mysql主要执行的是update/insert之类的操作，那么正常比值接近0%；如果执行的select居多，那比值超过90%也是正常的。不过如果你看到的是一个负数，那说明mysql总是在往那个慢的要死的磁盘里写索引，这就很不妙了。</p>
<p>要想知道到底比值正常与否，请参考之后的DMS报表内容。</p>
<h1 id="section-5">读命中：第7行</h1>
<p>比写命中重要多了的就是读命中。同样，这个值就是读自磁盘的key与读自内存的比值。这个比值最好别低于99%！！再低就有问题了——很可能就是key buffer太小。mysql没法从内存里读到，只好找硬盘了……
当然，如果你刚重启过一次mysql，那在一两个小时内，命中率低一点也是正常的。</p>
<h1 id="section-6">请求报表：9-26行</h1>
<p>第二个主要章节。它展示了很多关于mysql在做什么以及做的怎么样的内容。请求(question)包括SQL查询(query)，也包括mysql协议通讯。大家经常关注的一个性能是mysql的qps(每秒执行查询数)。不过从一个更广泛的眼光看来，这个衡量标准其实是很随意的……mysql需要处理很多其他的请求。本报表试图展现的，就是这么一个更完整的内容。</p>
<h1 id="section-7">总值：第10行</h1>
<p>本行第一列，回答自运行起mysql一共处理多少请求，第二列，得出自运行起平均每秒钟处理多少请求。大家可能以为第二列这个值就是我们想要的qps了。但mysql真的做了这么多事情么？继续往下看。
（再次提醒大家注意questions和queries的区别）</p>
<h1 id="dtq11-15">查询的总体分布报表(DTQ)：第11-15行</h1>
<p>所有的请求都可以被粗略的分入五类：数据操作语句(DMS)，查询缓存命中(QC Hits)，COM_QUIT，其他的COM_命令以及其他未知的东东。接下来的五行分别显示这些，从大到小排列。这样你可以一眼看出mysql最重要的任务是什么了。一般的说，DMS和QCHits是主角，COM_是必须的，额，路人甲……</p>
<p>再详细解释每行之前，提示一下，第三列的比值分母是上面那行的总值。比如本例中DMS占到了82.84%就挺不错的。</p>
<p>DMS包括：select/insert/replace/update/delete(其他的比较偏门，mysqlreport干脆就排除他们了)。正常的说，mysql最应该做的事情，就是这些DMS了。详细内容见17-22行。</p>
<p><code>QC Hits</code>是mysql从查询缓存里直接获取结果的数量。我们梦寐以求的就是让这个命中率变高，因为这意味着mysql响应变的相当快。但这也意味着你必须接受一定的数据差异性。详细理由见QC报表中的insert/prune和hit/insert比值部分。</p>
<p>在本例中QC Hits达到了16.91%，看来很不错的样子。可别被这么一条数据迷惑了，38-45行的QC报表会给你一个完全不一样的结论。</p>
<p>COM_QUIT，嗯，凑数的。</p>
<p>COM_，如果这个值比较高的话，或许会有些问题，详见23-26行。</p>
<p>Unknown，理想情况下，有上面四个类别就够了。因为有时候，mysql处理了几个请求，却没有记录相应的操作数。所以Unknown有+-两种。+说明mysqlreport统计的多了，-就是少了。这个类别浮动性很大，某些特定情况下，可能会排名很靠前，不过最好还是在最底下吧。</p>
<h1 id="section-8">慢查询：第16行</h1>
<p>第16行非常重要，展示的是mysql执行的慢查询数。默认情况下，配置的<code>long_query_time</code>是10秒钟。事实上，大家都觉得这太长了，一般都改成1秒，甚至更短，mysql在版本5以后，支持到微妙us级别的。</p>
<p>配置的<code>long_query_time</code>会在&rsquo;Slow&rsquo;后面显示，默认8个字符，所以如果配置的是&rsquo;9.999999 ms&rsquo;，只会显示成&rsquo;999.999 &lsquo;，不过应该不会这么无聊吧~</p>
<p>理想情况下最好这里永远都是0，不过不太可能，多少还是有点。只要第三列的比例低于0.05%就行。</p>
<p>第四列，DMS中的slow比值；第五列，慢查询日志是否记录。强烈建议选择ON。</p>
<h1 id="dms17-22">DMS：17-22行</h1>
<p>和DTQ一样，第一行也是总值，其余内容也是动态排名。这部分内容可以解释mysql服务器偏重于什么类型：select还是insert，或者其他。一般来说会是select吧。明确这个问题，对我们理解其他数值有很大的帮助。比如说：一个insert型的mysql，他的写比率接近1.0，同时带来比较高的表锁。然后很可能用innodb表；一个select型的mysql则相反，读比率高，表锁少，而且很可能用的是MyISAM表。</p>
<p>本例就是一个select型的。65.72%的总请求是select(在DMS的比例提高到79.33%)，显然我们可以朝着select的方向进行优化了。</p>
<h1 id="com23-26">COM_：23-26行</h1>
<p>这部分内容都很直观，在mysql协议里都有，像 <code>com_change_db</code> ，一眼就知道是干嘛的。</p>
<p>如果在DTQ排名里COM_比较高，那说明mysql忙着干自己的事情而不是响应SQL查询。比如说，如果一台mysql的 <code>com_rollback</code> 高，可能糟糕了，你的事物回滚失败了。结合之前的DTQ报表分析这个东西吧~
一般这些东西不能出什么问题，不过时不时看一眼还是有必要的。</p>
<h1 id="selectsort28-36">select/sort报表：28-36行</h1>
<p>select和sort都是select_的内容。其中最主要的是29和31行：scan和full join。scan展示的是对全表进行扫描的select语句个数。full join和scan很像，除了它还出现于多表查询。程序联合多表进行全表扫描，听起来就慢的可怕……总之，对于这两个数值，只有更低，没有最低！</p>
<h1 id="qc38-45">QC报表：38-45行</h1>
<p>只有mysql版本支持QC并且my.cnf开启了QC的时候该报表才会出现。</p>
<h1 id="section-9">内存使用：39行</h1>
<p>如果内存使用的接近最大设置值，在更下面的Prune数据上也会有反应，因为QC里的查询会被踢出来。</p>
<h1 id="section-10">内存碎片：40行</h1>
<p>内存块碎片(block fragmnt)的详细解释参见《MYSQL手册》的5.14.3章节所述：</p>
<pre><code>`query_cache_min_res_unit` 的默认值是4KB，大多数情况下足够用了。如果你有一个返回超小结果的海量查询，默认的块大小(即4KB)可能会导致大量的内存碎片，同样也浪费了很多空闲内存块。因为内存不足，碎片会强制删除(prune，我也不知道为啥不叫delete或者purge)QC里的部分内容。这时候你就得降低这个 `query_cache_min_res_unit` 设置。至于空闲块和QC的删除阀值，分别由 `Qcache_free_blocks` 和 `Qcache_lowmem_prunes` 定义。
</code></pre>
<p>内存碎片的计算方法是空闲内存块除以总内存块数。比值越大，碎片越多，10-20%就已经超出平均水平了。</p>
<p>本例的13.05%还是可以接受的，不过最好还是检查一下 <code>query_cache_min_res_unit</code> 是不是能调调~</p>
<h1 id="hitsinsertsprunes41-43">Hits/Inserts/Prunes：41-43行</h1>
<p>Hits是最重要的，它反映了select有多少是从QC里获得的应答，当然越多越好。至于insert和prune，或许从44行的比值中更好理解一下。之前有提到prune多说明qc太小，当然这只是一种可能而已。</p>
<p>本例中，只有55%的QC被利用，而碎片又不是太高。prune达到每秒16次，比QCHits高了一倍！打个不太恰当的（这话我加的，感觉比直接理解技术更难懂的比喻）比方：这台mysql的QC就像苹果树一样，苹果还没摘呢，树枝已经被砍掉了……</p>
<h1 id="insertprunehitinsert44-45">insert/prune和hit/insert比：44-45行</h1>
<p>insert/prune是一个波动性的QC指标。一个稳定运行中的QC，insert进QC的查询数量应该大于prune掉的查询数量。而一个不稳定的QC，比值或许是1:1，甚至偏向prune。这说明两个问题：1、QC大小不够；2、mysql试图缓存一切，结果帮了倒忙~</p>
<p>如果是第一种情况，简单的加大QC大小就够了。然后再观察碎片和内存使用率的情况。</p>
<p>但更多的时候是第二种情况。因为QC设置里开启的默认type1就是要求mysql尽可能的缓存一切东西。</p>
<p>mysql官方说明里这么解释这个<code>type 1</code>的：</p>
<pre><code>“缓存一切查询结果，除非查询时使用'select sql_no_cache'方式”。
</code></pre>
<p>可惜这个 <code>sql_no_cache</code> 基本没人用。另一个稍微好一些的方式是 <code>type 2 demand</code> ，解释如下：</p>
<pre><code>“只有在查询使用 `select sql_cache` 时才缓存查询结果”。
</code></pre>
<p>这个type对开发人员要求比较多，因为他们得明确指出哪些要缓存，哪些不要。不过也没人比他们更清楚到底哪些是该缓存的啦~</p>
<p>hit/insert用来反映QC的有效性。理想情况是：mysql插入一批稳定的查询到QC里，然后源源不断的命中这批结果……所以，如果QC的有效性足够，这个比值应该是偏向hit的。如果不幸的偏向了insert，那说明QC其实没起到太大的作用。比如说1:1，一次insert用了一次hit，然后就被替换了，这完全违背了使用QC的初衷。不过还有更糟的，比如0.34:1,一次都没用上，就被prune掉了……</p>
<p>本例的QCHits不低，hit/insert却不高。再考虑到内存使用和碎片情况也还可以。或许真的有必要换成type2的DEMAND了~~</p>
<h1 id="section-11">表锁报表：47-49行</h1>
<p>表锁报表包括两行，一行是总数，一行是当前数。锁等待对于数据库来说永远是糟糕的事情。第三列的总比值反应了一个综述的情况，无论如何不能高过10%，否则肯定就带来一大堆的索引和慢查询问题！</p>
<h1 id="section-12">表报表：51-53行</h1>
<p>也是两行，一行是当前mysql打开表的个数、表缓存的使用率，一行是mysql运行以来的平均值。</p>
<p>这里有两个值比较重要。一个是表缓存使用率，哪怕高到100%都行。不过要是真高到100%了，可能你的&rsquo;table_cache&rsquo;设置已经不够了，赶紧加大吧。第二个是当前打开表的比率，这个也能协助判断&rsquo;table_cache&rsquo;设置是否合理。一般这个值应该小于每秒1次。不过一个负载比较高而又运行的还不错的mysql，可能能达到每秒打开7次表，依然保持100%的表缓存~</p>
<h1 id="section-13">连接数报表：55-57行</h1>
<p>如果最大连接数曾经接近过100%，请加大&rsquo;max_connection&rsquo;设置。不过事实上，默认的100已经足够绝大多数哪怕相当繁忙的mysql使用了，盲目加大这个设置其实不对。一个mysql链接持续1秒钟，100个就是足足100秒。所以如果连接数太高，或者说一直在慢慢涨，问题很可能在别的地方，比如慢查询、糟糕的索引、甚至DNS解析太慢。在修改这个数的事情，还是先去研究一下为什么100个还不够呢？</p>
<p>至于每秒连接数，只要mysql运行正常，高低无所谓。不过大多数mysql这个值在每秒5次以下~~</p>
<h1 id="section-14">临时表报表：59-62行</h1>
<p>mysql可以在内存、磁盘甚至临时文件上创建临时表。这三种情况分别对应下面的三条报告。这些数据没有标准值，不过必须要知道的是磁盘上的临时表示最慢的。mysql一般也避免在磁盘上创建临时表，除非达到了&rsquo;tmp_table_size&rsquo;的阀值。这个阀值会显示在内存(Table)那行的Size列后面。至于内存和临时文件的数值到底该多少，取决于mysql数据库的硬件配置。</p>
<h1 id="section-15">线程、中断、流量报表：64-76行</h1>
<p>这三个报表是最重要的，系统级别的问题不用多说了都……</p>
<p>这里面有一个需要注意的地方：66行的线程命中率。每个mysql的连接都是一个单独的线程。mysql启动时，只创建不多的几个线程和一个线程缓存，以节省不断创建和销毁线程的开销，哪怕这个开销不怎么明显。当mysql的连接数超过了线程缓存数(由 <code>thread_cache_size</code> 定义)时，MySQL开始出现线程抖动(&lsquo;thread thrash&rsquo;)。为了接纳新的连接，mysql疯狂的创建新线程，结果自然是线程命中率大幅下滑。</p>
<p>线程抖动是问题么？Yahoo的Jeremy Zawondy在博客中写了如下一段话：</p>
<pre><code>所以上面这个故事的教训就是：如果你的服务器老是接受一些快速连接，想办法加大你的线程缓存吧，直到你的`show status`命令里`threads_created`不再飙升为止！你的CPU绝对会感谢你的。线程缓存不是啥大问题。可是你解决完真的大问题后，它就是最大的问题了……(汗)
</code></pre>
<p>所以，如果真出现线程抖动的话，加大&rsquo;thread_cache_size&rsquo;吧。</p>
<p>比如本例，线程缓存命中率只有可怜的0.05%！基本意味着每个连接都是新创建了线程。不过看看报表其他的内容，这也是必然的：缓存里一个线程都没有(66行)，201个线程被创建(67行),202个连接(57行)……</p>
<h1 id="innodb78-92">innodb缓冲池报表：78-92行</h1>
<p>mysql版本5.0.2之后才在<code>show status</code>里加入了innodb_内容。所以这部分报表只在该版本之后有效。</p>
<p>innodb存储引擎的重要特性就是它把表数据和索引都缓存在缓冲池里。缓冲池内的页大小是16KB，可以包含各种不同的数据类型。本报表就展示了这些页的数值。</p>
<p>注：因为mysqlreport比较老，对innodb的采集分析不如myisam多。</p>
<h1 id="section-16">使用率：79行</h1>
<p>这个可以类比第4行的 <code>key buffer used</code>。不过myisam引擎只缓存索引，而innodb也存数据。所以要想知道这个使用率的详细情况，还得看81-85行的内容。</p>
<p>显然，必须避免mysql运行到缓冲池溢出的地步。myisam溢出，只会导致性能下降(索引读写变慢)，而innodb的溢出问题就多了，因为几乎所有东西都依赖缓冲池。所以最好还是配置好自增长缓冲池(&lsquo;auto-extending buffer pool&rsquo;)吧。</p>
<h1 id="section-17">读命中：80行</h1>
<p>同样跟地7行的<code>key read hit</code>类似。不过对innodb来说这个数值更重要。缓冲池显示的是从内存读取的比例，所以一般都接近100%，绝大多数情况至少大于99.98%。</p>
<h1 id="section-18">页：81-85行</h1>
<p>各种各样的关于缓冲池中页的指标。比如82行的空闲页、83行的数据页、84行的杂页、85行的锁定页。</p>
<p>空闲页就是79行使用率的对立方。</p>
<p>数据页和空闲页一样是自描述的。我们没法知道这些页里有哪些数据类型。本行还有一列%Dirty，展示已经被修改过，但还没有被刷新到磁盘存储的数据页的比率。</p>
<p>另两样就更没什么可说的了。mysql手册上只是简单的这么描述这两样页：“用于管理分配行锁和自适应哈希索引导致的开销使用的页”和“目前正在读写、或者因为其他原因无法被刷新的页”。</p>
<h1 id="section-19">读：86-89行</h1>
<p>接下来的四行是关于innodb缓冲池的读情况的。86行是从内存读取的数量。在一个比较繁忙的innoDB引擎mysql服务器上，这个值应该非常大，因为innodb总是试图从内存里的缓冲池读取页。这个数值可以用来衡量innodb缓冲池的吞吐量。因为几乎所有inondb需要的东西都是在缓冲池里，所以缓冲池的读性能是越快越好。哪怕超过每秒200000次也不是不可能的。</p>
<p>87行的数值就小的多了。官方解释叫做“innodb无法从缓冲池获得而只能进行单页读取的逻辑读操作数”，其实就是从磁盘读的数量。</p>
<p>88行，随机读。官方解释“innodb启动的随机读取数。只有对表的大部分内容进行随机扫描的时候才会出现”。</p>
<p>89行，顺序读。官方解释“innodb启动的顺序读取数。只有进行全表扫描的时候才会出现”。全表扫描可不是什么好事，这个数值还是小点好。</p>
<h1 id="section-20">写：90行</h1>
<p>和86行类似，也可以用来衡量innodb的吞吐量。本行显示写的数量以及读写的比率。如果服务器主要操作是update和insert的话，这个值也会比较高。</p>
<h1 id="section-21">刷新：91行</h1>
<p>缓冲池的页刷新请求数。</p>
<h1 id="section-22">空闲等待：92行</h1>
<p>mysql手册上这么描述这个变量：
    一般情况下，innodb缓冲池的写操作是后台运行的。不过，如果出现必须要读写一个页可偏偏没有可用的新页时，（innodb）就只能先等待页的刷新了。这个变量就是这些等待的总数。只要缓冲池的大小设置得当，等待数应该会很小。</p>
<h1 id="innodb94-100">innodb锁报表：94-100行</h1>
<p>innodb的行锁变量是mysql5.0.3之后加入的。MyISAM引擎是表锁，而innoDB是行锁。所以当你使用innodb时这几个变量的值非常重要。</p>
<h1 id="section-23">等待：95行</h1>
<p>“等待某行解锁的累积次数”，最好是0次。</p>
<h1 id="section-24">当前：96行</h1>
<p>“当前正在等待解锁的行个数”，最好是0次。</p>
<h1 id="section-25">时间分析：97-100行</h1>
<p>98-100行显示了毫秒(ms)级行锁等待数据。分别是总值、平均值和最大值。同样最好是0次。</p>
<h1 id="innodb102-121">innoDB数据、页、行报表：102-121行</h1>
<p>这部分报告，一般广泛的用于衡量innodb引擎的吞吐量指标。</p>
<h1 id="section-26">数据：103-110行</h1>
<p>第一部分，数据，列出了四种类型的操作：读、写、刷新(fsync)和等待(pending)。</p>
<ol>
  <li>第一个类型：读，指的是整个innodb引擎完成所有的数据读取次数——注意：不是整个数据读取字节数或者类型，而是innodb完成的数据读取次数。</li>
  <li>第二个类型：写，和读一样也是次数的统计。</li>
  <li>第三个类型：刷新，同样的，innodb从内存写入磁盘的次数。这个值应该会比前两个小。</li>
  <li>第四个类型：等待，又被分成了三行(108-110)，分别是读、写、刷新的等待次数。</li>
</ol>
<h1 id="section-27">页：112-115行</h1>
<p>这部分包括三种自描述类型：创建、读取、写入，分别用来表示缓冲池中页的创建、读取和写入的数量和速率(即每秒操作数)。由于没有指出具体是哪种页，这几个数值也就是用来概述一下innodb引擎的吞吐量罢了。</p>
<h1 id="section-28">行：117-121行</h1>
<p>最后一部分，行，只是一些比较泛泛的数值。包括对行的delete/insert/read/update操作。这些数值会比较大，而速率部分同样也是些概述参考……</p>
<h1 id="section-29">结论</h1>
<p>现在我们已经阅读甚至分析完了整个报表，可以对本例mysql做出一个总体的评价了。</p>
<p>总的来说，这个服务器运行情况还是不错的，几个关键指标都很好：key buffer只用了12%，DMS和QCHits占了请求的99%，也没有什么Com_问题，表锁也不错，表缓存只用了10%，连接数很低。</p>
<p>至于innodb引擎，服务器也在使用，但比重不大。目前这些innodb的状态变量反映出的情况看，一些正常。</p>
<p>不过还是有些优化的余地。首先一点，也是最重要的一点，就是查询缓存QC不太稳定；然后是线程缓存，建议调高 <code>thread_cache_size</code>，知道线程缓存命中率回升到满意值~~</p>
      <a href="/2011/01/10/mysqlreport-guide" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/07/compute-flow-from-access_log-by-awk-2" title="日志计算(awk进阶)" rel="bookmark">日志计算(awk进阶)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-07 00:00:00 +0800">07 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <table>
  <tbody>
    <tr>
      <td>曾经用awk写过一个日志流量计算的单行命令。因为awk中没有sort函数，所以在中途采用了</td>
      <td>sort</td>
      <td>的方式，导致效率很低。在计算50GB+的日志时，运算时间慢的不可忍受。</td>
    </tr>
  </tbody>
</table>
<p>设想了很多方法来加快运算，比如舍弃awk改用perl来完成，如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$access_log</span> <span class="o">=</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="k">my</span> <span class="nv">$log_pattern</span> <span class="o">=</span> <span class="sx">qr&#39;^.*?:(\d\d:\d\d):(\S+\s){5}\d+\s(\d+).+&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%flow</span><span class="p">;</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$traffic</span><span class="p">,</span> <span class="nv">$result</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nb">open</span> <span class="n">FH</span><span class="p">,</span><span class="s">&quot;&lt; $access_log&quot;</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cannot open access_log&quot;</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="k">my</span> <span class="nv">$log</span> <span class="o">=</span> <span class="sr">&lt;FH&gt;</span><span class="p">))</span> <span class="p">{</span>
<span class="err">  </span> <span class="err"> </span><span class="nv">$flow</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$3</span> <span class="k">if</span> <span class="nv">$log</span> <span class="o">=~</span><span class="sr"> /$log_pattern/</span><span class="p">;</span>
 <span class="err"> </span> <span class="err"> </span><span class="c1">#print $1.&quot; &quot;.$3.&quot; &quot;.$flow{$1} * 8 / 300 / 1024 / 1024,&quot;\n&quot;;</span>
<span class="p">}</span>
<span class="nb">close</span> <span class="n">FH</span><span class="p">;</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$key</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%flow</span> <span class="p">)</span> <span class="p">{</span>
<span class="err">  </span> <span class="err"> </span><span class="k">my</span> <span class="nv">$minute</span> <span class="o">=</span> <span class="nv">$1</span> <span class="k">if</span> <span class="nv">$key</span> <span class="o">=~</span><span class="sr"> /\d\d:\d(\d)/</span><span class="p">;</span>
<span class="err">  </span> <span class="err"> </span><span class="nv">$traffic</span> <span class="o">+=</span> <span class="nv">$flow</span><span class="p">{</span><span class="nv">$key</span><span class="p">};</span>
<span class="err">  </span> <span class="err"> </span><span class="k">if</span> <span class="p">(</span> <span class="nv">$minute</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span> <span class="ow">or</span> <span class="nv">$minute</span> <span class="o">==</span> <span class="s">&#39;5&#39;</span> <span class="p">)</span> <span class="p">{</span>
<span class="err">  </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="nv">$result</span> <span class="o">=</span> <span class="nv">$traffic</span> <span class="k">if</span> <span class="nv">$traffic</span> <span class="o">&gt;</span> <span class="nv">$result</span><span class="p">;</span>
<span class="err">  </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="nv">$traffic</span> <span class="o">=</span> <span class="s">&#39;0&#39;</span><span class="p">;</span>
<span class="err">  </span> <span class="err"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="k">print</span> <span class="nv">$result</span> <span class="o">*</span> <span class="mi">8</span> <span class="sr">/ 300 /</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
</code></pre></div>
<p>好吧，这个正则太过垃圾，请无视，但至少在管道和系统sort上浪费的时间还是大大的节省了的。</p>
<p>然后在CU上翻到一个老帖子，提供一个比较不错的awk思路，命令如下：</p>
<div class="highlight"><pre><code class="bash">awk <span class="s1">&#39;!b[substr($4,14,5)]++{print v,a[v]}{v=substr($4,14,5);a[v]+=$10}END{print v,a[v]}&#39;</span>
</code></pre></div>
<p>这里用substr()跟指定FS相比那个效率高未知，不过采用!b++的方式来判断某时间刻度结束，输出该时刻总和，在顺序输入日志的前提下，运算速度极快（就剩下一个加法和赋值了）。</p>
<p>注意：此处b[]内不能偷懒写v，!b[v]++永远只会输出时刻的第一行数值。</p>
<p>不过真实使用时不尽如人意。逻辑上推导了很久没发现问题，结果在重新运行前面的perl时看了看while中的print，发现这个日志因为是从各节点合并出来的日志，其时间并不是顺序排列的！！</p>
<p>另，刚知道gawk3.1以上提供了asort()和asorti()函数，可以研究一下~</p>
<p>采用time命令测试一下</p>
<div class="highlight"><pre><code class="bash">gawk <span class="s1">&#39;{a[substr($4,14,5)]+=$10}END{n=asorti(a,b);for(i=1;i&lt;=n;i++){print b[i],a[b[i]]*8/60/1024/1024}}&#39;</span> example.com_log | awk <span class="s1">&#39;{if($2&gt;a){a=$2;b=$1}}END{print b,a}&#39;</span>
</code></pre></div>
<p>一个35G的日志文件只用了6分钟。</p>
<p>然后更简单的</p>
<div class="highlight"><pre><code class="bash">gawk <span class="s1">&#39;{a[substr($4,14,5)]+=$10}END{n=asort(a);print a[n]*8/60/1024/1024}&#39;</span> example.com_log
</code></pre></div>
<p>不过简单的运行发现只比前一种快不到10秒钟。而前一种还能输出峰值的时间，可读性更好一些~</p>
      <a href="/2011/01/07/compute-flow-from-access_log-by-awk-2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/12/30/resin-ipv6" title="resin与ipv6" rel="bookmark">resin与ipv6</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-12-30 00:00:00 +0800">30 Dec 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一台nginx+resin的应用服务器出现大量的ipv6下的CLOSE_WAIT。重启后十五分钟就累积到了1500+。</p>
<p>调整resin的keepalive-timeout和nginx的proxy_read_timeout，没有丝毫改变。决定先关掉ipv6。</p>
<p>如果要关掉整个linux的ipv6，需要修改/etc/modprobe.conf然后reboot，显然没法在生产环境上直接操作，只能寻求应用监听上的办法。</p>
<p>修改sysctl -w net.ipv6.bindv6only=1，然后重启应用，赫然发现resin重启失败，只有perl进程，没有java进程了。改回0，java立刻启动成功。</p>
<p>google了一下，在<a href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=560044">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=560044</a>中看到了答案——原来java默认就是用ipv6。</p>
<p>增加resin/bin/wrapper.pl相关行如下：</p>
<p>$EXTRA_JAVA_ARGS=&rdquo;-Djava.util.logging.manager=com.caucho.log.LogManagerImpl&rdquo;;
$EXTRA_JAVA_ARGS.=&rdquo; -Djavax.management.builder.initial=com.caucho.jmx.MBeanServerBuilderImpl&rdquo;;
$EXTRA_JAVA_ARGS.=&rdquo; -Djava.net.preferIPv4Stack=true&rdquo;;#新增参数</p>
<p>重启，就只在ipv4上了。</p>
      <a href="/2010/12/30/resin-ipv6" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/12/28/intro-tcprstat" title="TCP响应时间监测" rel="bookmark">TCP响应时间监测</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-12-28 00:00:00 +0800">28 Dec 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>对于squid等服务器，其日志中就含有响应时间。但是，这个时间只是服务器软件处理过程的时间，进程一旦交出去，在网卡等处的时间，它就管不着了。而percona出品一款迷你型小工具，叫做tcprstat，正好派上用场~</p>
<p>tcprstat下载地址见：<a href="http://www.percona.com/docs/wiki/tcprstat:start">http://www.percona.com/docs/wiki/tcprstat:start</a></p>
<p>本来是percona用来监测mysql响应时间的。不过对于任何运行在TCP协议上的响应时间，都可以用。不过据我试验，（至少非编译的64位二进制版如此）这个工具对linux内核版本也是有要求的，我在RH的AS4上运行就提示kernel不够……</p>
<p>对于使用一个2000行代码的工具，网页上的说明已经相当清晰。直接开用吧：</p>
<div class="highlight"><pre><code class="bash">wget http://github.com/downloads/Lowercases/tcprstat/tcprstat-static.v0.3.1.x86_64 --no-check-certificate -O /sbin/tcprstat
chmod +x /sbin/tcprstat
tcprstat -p 1521 -t 10 -n 0 -f <span class="s1">&#39;%T\t%n\t%M\t%a\t%95M\t%99M\n&#39;</span>
timestamp	count	max	avg	95_max	99_max
1293528181	339	4429229	142446	617688	2196833
</code></pre></div>
<p>That&rsquo;s all!</p>
<p>监听oracle的1521端口，每10秒一次统计，长期运行，输出格式为“UNIX时间，响应个数，最长响应时间，平均响应时间，95%响应时间，99%响应时间”（这个%可以自定义数值）</p>
<p><strong>注意：这个响应时间是microsecond，即us，等于0.000001s。</strong></p>
<p>突然想起来基调的smoke图。用这个输出数据给gnuplot，相当容易画出类似的效果~给不同%的数据定义渐进颜色画柱状图（注意叠加次序），avg画连线图，count或许可以画在top的x轴上~先贴个简易版的：</p>
<div class="highlight"><pre><code class="tcl"><span class="k">set</span> terminal png size <span class="mi">550</span><span class="err">,</span><span class="mi">350</span> <span class="err">\</span>
<span class="nv">xffffff</span> x000000 x404040 <span class="err">\</span>
<span class="nv">xcfcfcf</span> x8a8a8a x4a4a4a x00ff00
<span class="k">set</span> output <span class="s2">&quot;log.png&quot;</span>
<span class="k">set</span> autoscale
<span class="k">set</span> xdata time
<span class="k">set</span> timefmt <span class="s2">&quot;%s&quot;</span>
<span class="k">set</span> xlabel <span class="s2">&quot;time&quot;</span>
<span class="k">set</span> ylabel <span class="s2">&quot;microsecond&quot;</span>
<span class="k">set</span> title <span class="s2">&quot;Oracle response time&quot;</span>
<span class="k">set</span> grid
<span class="nv">plot</span> <span class="s2">&quot;tcp.log&quot;</span> using <span class="mi">1</span><span class="o">:</span><span class="mi">3</span> title <span class="err">&#39;</span>max<span class="err">&#39;</span> with filledcurves x1<span class="err">,</span> <span class="err">\</span>
<span class="s2">&quot;tcp.log&quot;</span> <span class="nv">using</span> <span class="mi">1</span><span class="o">:</span><span class="mi">6</span> title <span class="err">&#39;</span><span class="mi">97</span><span class="o">%</span><span class="err">&#39;</span> with filledcurves x1<span class="err">,</span> <span class="err">\</span>
<span class="s2">&quot;tcp.log&quot;</span> <span class="nv">using</span> <span class="mi">1</span><span class="o">:</span><span class="mi">5</span> title <span class="err">&#39;</span><span class="mi">90</span><span class="o">%</span><span class="err">&#39;</span> with filledcurves x1<span class="err">,</span> <span class="err">\</span>
<span class="s2">&quot;tcp.log&quot;</span> <span class="nv">using</span> <span class="mi">1</span><span class="o">:</span><span class="mi">4</span> title <span class="err">&#39;</span>avg<span class="err">&#39;</span> with lines
</code></pre></div>
<p>效果如下：</p>
<p><img src="/images/uploads/log-2.png" alt="tcprstat-gnuplot" /></p>
      <a href="/2010/12/28/intro-tcprstat" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/12/23/if-modified-since-process-in-nginx" title="ims在nginx上的处理（无责任猜测）" rel="bookmark">ims在nginx上的处理（无责任猜测）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-12-23 00:00:00 +0800">23 Dec 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>最近得知CDN方面默认配置了reload-into-ims，而我们的html因为采用了ssi的include方式的原因，是没有last-modified的。在这种情况下的处理结果，让人好奇~</p>
<p>因为手头没测试机器，仅从我一知半解的nginx代码上推测一下：</p>
<p>1、之前博客里已经写过，nginx的ssi_module，在ngx_ssi_header_filter中简单的采用了ngx_http_clear_last_modified(r)抹去了last-modified的输出。</p>
<p>2、在nginx的module定义中，各filter的顺序如下：
<code>ngx_module_t *ngx_modules[] = {</code><code>
</code><code>...............................................
</code><code>&amp;ngx_http_write_filter_module,</code><code>
</code><code>&amp;ngx_http_header_filter_module,</code><code>
</code><code>&amp;ngx_http_chunked_filter_module,</code><code>
</code><code>&amp;ngx_http_range_header_filter_module,</code><code>
</code><code>&amp;ngx_http_gzip_filter_module,</code><code>
</code><code>&amp;ngx_http_postpone_filter_module,</code><code>
</code><code>&amp;ngx_http_ssi_filter_module,</code><code>
</code><code>&amp;ngx_http_charset_filter_module,</code><code>
</code><code>&amp;ngx_http_userid_filter_module,</code><code>
</code><code>&amp;ngx_http_headers_filter_module,</code><code>
</code><code>&amp;ngx_http_copy_filter_module,</code><code>
</code><code>&amp;ngx_http_range_body_filter_module,</code><code>
</code><code>&amp;ngx_http_not_modified_filter_module,</code><code>
</code><code>NULL</code><code>};</code>
越后面的越先处理。也就是说，一个带有ims请求，会先经过not_modified_filter，然后才是ssi_filter。
而在ssi抹掉last-modified之前，文件是应该存在last-modified的。
nginx默认情况下，对一个ims请求的处理流程，参见淘宝核心系统部雕梁童鞋的博客《<a href="http://www.pagefault.info/?p=66">nginx中处理http header详解(1)</a>》。大体上，是nginx获得这个请求文件的Mtime，存为变量last_modified_time；然后通过ngx_http_parse_time()换算IMS中的时间。如果ims!=last_modified_time，读取文件内容成response-body，否则clear掉content-length/content-type/content-encoding/accept-ranges等，进入下一步。</p>
<p>那么，如果一个html页本身没有修改，其中含有<!--#include virtual="/ssi/test.html"-->，而这个/ssi/test.html却变动了，那么在向这个html页发送ims的时候，就应该会是返回一个Not Modified，但在ssi_filter里又把last-modified也clear了……</p>
<p>3、在ssi_filter里如果要输出last-modified的话，如果单纯只是注释掉clear，并不起作用。不过在ngx_http_ssi_filter_module.c中，看到ngx_http_ssi_include()中调用了ngx_http_ssi_stub_output()这个handler，对virtual或file的拼接时处理header中的content-type如下：
if (!r-&gt;header_sent) {
r-&gt;headers_out.content_type_len =
r-&gt;parent-&gt;headers_out.content_type_len;
r-&gt;headers_out.content_type = r-&gt;parent-&gt;headers_out.content_type;
if (ngx_http_send_header(r) == NGX_ERROR) {
return NGX_ERROR;
}
}
return ngx_http_output_filter(r, out);</p>
<p>或许在这里加上
对r-&gt;parent-&gt;headers_out.last_modified_time和r-&gt;child-&gt;headers_out.last_modified_time的大小判断，然后赋值给r-&gt;headers_out.last_modified_time，然后把ssi_filter优先到not_modified_filter之前来？</p>
<p>C盲睡觉去也~~找时间写几个shtml测一下就知道自己对next_header_filter的理解对不对了~</p>
      <a href="/2010/12/23/if-modified-since-process-in-nginx" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/12/23/diff-between-wget-curl" title="wget和curl测试时的小区别" rel="bookmark">wget和curl测试时的小区别</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-12-23 00:00:00 +0800">23 Dec 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在对网站内容是否更新进行测试时，最常用的两个工具就是wget和curl。不过两个工具之间还是有一些小区别，甚至很可能影响到测试结论的。记录一下：</p>
<p>1、在查看response-header的时候，我们习惯用的是wget -S和curl -I，但是：wget -S的时候，发送的是GET请求，而curl -I发送的是HEAD请求。如果测试url此时没有被缓存过，直接使用curl -I进行测试，永远都会返回MISS状态。所以最好先wget一次，再用curl -I。</p>
<p>2、在查看下载速度时，常常发现wget和curl耗时差距较大。因为wget默认使用HTTP/1.0协议，不显式指定&ndash;header=&rdquo;Accept-Encoding: gzip,deflate&rdquo;的情况下，传输的是未经压缩的文件。而curl使用HTTP/1.1协议，默认接受就是压缩格式。</p>
<p>3、在测试缓存层配置时，有时发现wget可以HIT的东西，curl却始终MISS。对此可以开启debug模式进行观察跟踪。
wget自带有-d参数，直接显示request-header；curl只有-D参数，在采用GET请求的时候，将response-header另存成文件，所以只好在squid上debug请求处理流程（当然也可以去网络抓包），结果发现，curl的GET请求，都带有&rdquo;Pragma: no-cache&rdquo;！而wget需要另行指定&ndash;no-cache才会。按照squid的默认配置，对client_no_cache是透传的，所以curl永远MISS，除非squid上配置了ignore-reload/reload-into-ims两个参数，才可能强制HIT。</p>
      <a href="/2010/12/23/diff-between-wget-curl" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/12/22/monitor-netapp-by-net-snmp" title="通过snmp协议监控NetApp" rel="bookmark">通过snmp协议监控NetApp</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-12-22 00:00:00 +0800">22 Dec 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>NetApp作为专业存储，用起来还是比较让人放心的，不过放心不代表放手不管，一些重要的监控还是要做的。比如基本的CPU负载、网卡流量、磁盘使用率，作为数据存储特别关注的IOPS、DiskIO（因为有cache的原因，所以NetIO和DiskIO是不同时的，单从网卡进出不能判定磁盘的真实读写）。</p>
<p>从google中找到了NetApp的MIBtree，见<a href="https://support.ipmonitor.com/mibs/NETWORK-APPLIANCE-MIB/tree.aspx">https://support.ipmonitor.com/mibs/NETWORK-APPLIANCE-MIB/tree.aspx</a>或<a href="http://www.mibdepot.com/cgi-bin/getmib3.cgi?abc=0&amp;n=NETWORK-APPLIANCE-MIB&amp;r=netapp&amp;f=netapp_1_4.mib&amp;t=tree&amp;v=v1&amp;i=0&amp;obj=cp">http://www.mibdepot.com/cgi-bin/getmib3.cgi?abc=0&amp;n=NETWORK-APPLIANCE-MIB&amp;r=netapp&amp;f=netapp<em>1</em>4.mib&amp;t=tree&amp;v=v1&amp;i=0&amp;obj=cp</a></p>
<p>（多贴一个，省的万一哪个站挂了……）</p>
<p>CPU等项没什么问题，问题在于IO的获取。
与普通服务器的流量一样，很明显的看到了miscNfsOps、miscNetRcvdKB和miscNetSentKB三个值。我们可以很简单的通过后个值的差值运算出速率。但如果单取一个值的时候，会发现一个很诡异的情况，见下：</p>
<h1 id="snmpwalk--v-1--c-public-101010118-1361417891223--awk-print-nf">snmpwalk -v 1 -c public 10.10.10.118 .1.3.6.1.4.1.789.1.2.2.3 | awk &lsquo;{print $NF}&rsquo;</h1>
<p>-1948753579</p>
<p>居然是个负值！</p>
<p>难道是对这个MIB的理解有问题？可通过如下命令计算的结果，和通过交换机端口获取的流量却基本符合了：</p>
<p>a=<code>snmpwalk -v 1 -c public 10.10.10.118 .1.3.6.1.4.1.789.1.2.2.3 | awk '{print $NF}'</code>;sleep 10;snmpwalk -v 1 -c public 10.10.10.118 .1.3.6.1.4.1.789.1.2.2.3 | awk &lsquo;{print ($NF-&ldquo;&lsquo;$a&rsquo;&rdquo;)*8/10&rdquo;Kbps&rdquo;}&rsquo;
12364.8Kbps</p>
<p>虽然数值都变负了，但差量还是对的……汗，如果通过AVERAGE方式取这个差值绘图，倒不要紧，如果通过普通的流量Counter方式，这个图全反过X轴去了应该~</p>
<p>这个情况很容易让我想到用cacti获取网卡流量时的配置，如果选用默认的32bits绘图时，在流量较大时也会出现这类负值或者干脆画不出来的情况。</p>
<p>其次，DiskIO没有和Net一样的MIB；但net、disk和ops都有一对miscHigh<strong><em>/miscLow</em></strong>的数值。</p>
<p>这对值怎么用？MIB上的解释看起来超级茫然：
miscLowNfsOps：The total number of Server side NFS calls since the last boot.  This object returns the least significant 32 bits of the value.
miscHighNfsOps：The total number of Server side NFS calls since the last boot.  This object returns the most significant 32 bits of the value.</p>
<p>通过度娘了解了一下least significant bit和most significant bit的概念，原来LSB和MSB是在底层开发时的概念，因为2进制的字串比较长，所以通过MSB和LSB的命名方式来标明字串的高位（普通PC和MAC在存数据的时候顺序是反的，所以必须标记，还有其他原因，比如用MSB的1、0来表示正负数等）</p>
<p>那么这个most significant 32bits也就理解了~~就是从高位开始往低算的32位。least反过来……合并起来就是64位的完成数据了……2进制数的合并，也就是说用$MSBs * 2**32 + $LSBs。My God~</p>
<p>最后在zenoss的maillist上看到了相同的问题，其中网友的回答是：NetApp使用的snmp协议是v1版本，无法直接提供64bits的计数，只能变通一下，改用这种拆分方式了。</p>
<p>最后，举例一个监控ops的perl脚本。原脚本是centreon项目提供的，删除了一些和ops无关的语句。从中也可以学到Net::SNMP模块的使用，hash的解引用等~</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Net::</span><span class="n">SNMP</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Long</span><span class="p">;</span>
<span class="k">use</span> <span class="n">lib</span> <span class="s">&quot;/usr/local/nagios/libexec&quot;</span><span class="p">;</span>
<span class="k">use</span> <span class="n">utils</span> <span class="sx">qw(%ERRORS $TIMEOUT)</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$o_host</span> <span class="o">=</span> <span class="err"> </span> <span class="err"> </span><span class="nb">undef</span><span class="p">;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="c1"># hostname</span>
<span class="k">my</span> <span class="nv">$o_community</span> <span class="o">=</span> <span class="nb">undef</span><span class="p">;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="c1"># community</span>
<span class="k">my</span> <span class="nv">$o_port</span> <span class="o">=</span> <span class="err"> </span> <span class="err"> </span><span class="mi">161</span><span class="p">;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="c1"># port</span>
<span class="k">my</span> <span class="nv">$o_warn</span> <span class="o">=</span> <span class="err"> </span> <span class="err"> </span><span class="nb">undef</span><span class="p">;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="c1"># warning limit</span>
<span class="k">my</span> <span class="nv">$o_crit</span><span class="o">=</span> <span class="err"> </span> <span class="err"> </span> <span class="nb">undef</span><span class="p">;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="c1"># critical limit</span>
<span class="k">my</span> <span class="nv">$o_timeout</span><span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$exit_code</span> <span class="o">=</span> <span class="nb">undef</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$o_type</span><span class="o">=</span><span class="nb">undef</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$output</span><span class="o">=</span><span class="nb">undef</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$o_perf</span><span class="o">=</span> <span class="nb">undef</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%oids</span> <span class="o">=</span> <span class="p">(</span>
<span class="s">&#39;cpuUsage&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.1.3.0&quot;</span><span class="p">,</span>
<span class="s">&#39;globalStatus&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.4.0&quot;</span><span class="p">,</span>
<span class="s">&#39;nfsHighOps&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.5.0&quot;</span><span class="p">,</span>
<span class="s">&#39;nfsLowOps&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.6.0&quot;</span><span class="p">,</span>
<span class="s">&#39;netRecHighBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.11.0&quot;</span><span class="p">,</span>
<span class="s">&#39;netRecLowBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.12.0&quot;</span><span class="p">,</span>
<span class="s">&#39;netSentHighBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.13.0&quot;</span><span class="p">,</span>
<span class="s">&#39;netSentLowBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.14.0&quot;</span><span class="p">,</span>
<span class="s">&#39;diskReadHighBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.15.0&quot;</span><span class="p">,</span>
<span class="s">&#39;diskReadLowBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.16.0&quot;</span><span class="p">,</span>
<span class="s">&#39;diskWriteHighBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.17.0&quot;</span><span class="p">,</span>
<span class="s">&#39;diskWriteLowBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.18.0&quot;</span><span class="p">,</span>
<span class="p">);</span>
<span class="k">my</span> <span class="nv">@oidlist</span><span class="o">=</span><span class="p">(</span><span class="nv">$oids</span><span class="p">{</span><span class="n">nfsHighOps</span><span class="p">},</span><span class="nv">$oids</span><span class="p">{</span><span class="n">nfsLowOps</span><span class="p">});</span>
<span class="k">sub </span><span class="nf">check_options</span> <span class="p">{</span>
<span class="nn">Getopt::Long::</span><span class="n">Configure</span> <span class="p">(</span><span class="s">&quot;bundling&quot;</span><span class="p">);</span>
<span class="n">GetOptions</span><span class="p">(</span>
<span class="s">&#39;H:s&#39;</span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_host</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="s">&#39;hostname:s&#39;</span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_host</span><span class="p">,</span>
<span class="s">&#39;p:i&#39;</span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_port</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="s">&#39;port:i&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_port</span><span class="p">,</span>
<span class="s">&#39;C:s&#39;</span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_community</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="s">&#39;community:s&#39;</span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_community</span><span class="p">,</span>
<span class="s">&#39;c:s&#39;</span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_crit</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="s">&#39;critical:s&#39;</span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_crit</span><span class="p">,</span>
<span class="s">&#39;w:s&#39;</span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_warn</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="s">&#39;warn:s&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_warn</span><span class="p">,</span>
<span class="c1">#       &#39;T:s&#39;   =&gt; \$o_type,</span>
<span class="p">);</span>
<span class="p">}</span>
<span class="c1">########## MAIN #######</span>
<span class="n">check_options</span><span class="p">();</span>
<span class="c1"># Connect to host</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$session</span><span class="p">,</span><span class="nv">$error</span><span class="p">);</span>
<span class="c1">#关键点：创建一个session连接被监控主机</span>
<span class="p">(</span><span class="nv">$session</span><span class="p">,</span> <span class="nv">$error</span><span class="p">)</span> <span class="o">=</span> <span class="nn">Net::</span><span class="n">SNMP</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">(</span>
<span class="o">-</span><span class="n">hostname</span> <span class="err"> </span><span class="o">=&gt;</span> <span class="nv">$o_host</span><span class="p">,</span>
<span class="o">-</span><span class="n">community</span> <span class="o">=&gt;</span> <span class="nv">$o_community</span><span class="p">,</span>
<span class="o">-</span><span class="n">port</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="nv">$o_port</span><span class="p">,</span>
<span class="o">-</span><span class="n">timeout</span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="nv">$o_timeout</span>
<span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$session</span><span class="p">))</span> <span class="p">{</span>
<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;ERROR: %s.\n&quot;</span><span class="p">,</span> <span class="nv">$error</span><span class="p">);</span>
<span class="nb">exit</span> <span class="nv">$ERRORS</span><span class="p">{</span><span class="s">&quot;UNKNOWN&quot;</span><span class="p">};</span>
<span class="p">}</span>
<span class="k">my</span> <span class="nv">$resultat</span><span class="o">=</span><span class="nb">undef</span><span class="p">;</span>
<span class="c1"># Get rid of UTF8 translation in case of accentuated caracters (thanks to Dimo Velev).</span>
<span class="c1">#这里没太看懂perldoc，猜测是不开启MIB和oid的转换，这样输出结果比较简洁，不过注释掉这句运行结果毫无影响</span>
<span class="nv">$session</span><span class="o">-&gt;</span><span class="n">translate</span><span class="p">(</span><span class="nn">Net::</span><span class="n">SNMP</span><span class="o">-&gt;</span><span class="n">TRANSLATE_NONE</span><span class="p">);</span>
<span class="c1">#取值的关键，get_request返回一个hash的引用。</span>
<span class="c1">#perldoc的原文是：“A reference to a hash is returned in blocking mode which contains the contents of the VarBindList.  In non-blocking mode, a true value is returned when no error has occurred.”</span>
<span class="c1">#get_request()中-callback和-delay是non-blocking模式的，而\@oids是blocking模式。</span>
<span class="c1">#也就是说这个脚本里返回的是一个引用。</span>
<span class="k">if</span> <span class="p">(</span><span class="nn">Net::</span><span class="n">SNMP</span><span class="o">-&gt;</span><span class="n">VERSION</span> <span class="o">&amp;</span><span class="ow">lt</span><span class="p">;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
<span class="nv">$resultat</span> <span class="o">=</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="n">get_request</span><span class="p">(</span><span class="nv">@oidlist</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="nv">$resultat</span> <span class="o">=</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="n">get_request</span><span class="p">(</span><span class="o">-</span><span class="n">varbindlist</span> <span class="err"> </span><span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@oidlist</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$resultat</span><span class="p">))</span> <span class="p">{</span>
<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;ERROR: Description/Type table : %s.\n&quot;</span><span class="p">,</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
<span class="nv">$session</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">;</span>
<span class="nb">exit</span> <span class="nv">$ERRORS</span><span class="p">{</span><span class="s">&quot;UNKNOWN&quot;</span><span class="p">};</span>
<span class="p">}</span>
<span class="nv">$session</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$new_nfs_ops</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$left_shift</span><span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$last_nfs_ops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$row</span> <span class="p">;</span>
<span class="k">my</span> <span class="err"> </span><span class="nv">$last_check_time</span> <span class="p">;</span>
<span class="k">my</span> <span class="err"> </span><span class="nv">$update_time</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@last_values</span><span class="o">=</span><span class="nb">undef</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$flg_created</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">#解引用关键点：对%$resultat的解引用$$resultat{$oids{nfsHighOps}}，其中$oids{nfsHighOps}是另一个hash——%oids中的值。</span>
<span class="c1">#可以采用foreach my $value ( values %$resultat ) { print &quot;$value\n&quot;; }的方式列出hash中的各个值。</span>
<span class="c1">#按照MSBs和LSBs的划分方法，通过2**32的方式合并得到64bits计数。</span>
<span class="nv">$new_nfs_ops</span><span class="o">=</span> <span class="nv">$$resultat</span><span class="p">{</span><span class="nv">$oids</span><span class="p">{</span><span class="n">nfsHighOps</span><span class="p">}}</span> <span class="o">*</span> <span class="err"> </span><span class="nv">$left_shift</span> <span class="err"> </span><span class="o">+</span> <span class="err"> </span><span class="nv">$$resultat</span><span class="p">{</span><span class="nv">$oids</span><span class="p">{</span><span class="n">nfsLowOps</span><span class="p">}};</span>
<span class="c1">#输出到文本文件，因为是给nagios做监控脚本，所以必须通过差值的方式计算average型数值，而不像cacti绘图时那样可以直接传递counter型数值。</span>
<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">e</span> <span class="s">&quot;/tmp/traffic_ops_&quot;</span><span class="o">.</span><span class="nv">$o_host</span><span class="p">)</span> <span class="p">{</span>
<span class="nb">open</span><span class="p">(</span><span class="n">FILE</span><span class="p">,</span><span class="s">&quot;&amp;lt;&quot;</span><span class="o">.</span><span class="s">&quot;/tmp/traffic_ops_&quot;</span><span class="o">.</span><span class="nv">$o_host</span><span class="p">);</span>
<span class="k">while</span><span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="ow">lt</span><span class="p">;</span><span class="n">FILE</span><span class="o">&gt;</span><span class="p">){</span>
<span class="nv">@last_values</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="nv">$row</span><span class="p">);</span>
<span class="nv">$last_check_time</span> <span class="o">=</span> <span class="nv">$last_values</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="nv">$last_nfs_ops</span> <span class="o">=</span> <span class="nv">$last_values</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="nv">$flg_created</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="nb">close</span><span class="p">(</span><span class="n">FILE</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="nv">$flg_created</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$update_time</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<span class="k">unless</span> <span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">FILE</span><span class="p">,</span><span class="s">&quot;&gt;&quot;</span><span class="o">.</span><span class="s">&quot;/tmp/traffic_ops_&quot;</span><span class="o">.</span><span class="nv">$o_host</span><span class="p">)){</span>
<span class="k">print</span> <span class="s">&quot;Check mod for temporary file : /tmp/traffic_ops_&quot;</span><span class="o">.</span><span class="nv">$o_host</span><span class="o">.</span> <span class="s">&quot; !\n&quot;</span><span class="p">;</span>
<span class="nb">exit</span> <span class="nv">$ERRORS</span><span class="p">{</span><span class="s">&quot;UNKNOWN&quot;</span><span class="p">};</span>
<span class="p">}</span>
<span class="k">print</span> <span class="n">FILE</span> <span class="s">&quot;$update_time:$new_nfs_ops:$new_cifs_ops&quot;</span><span class="p">;</span>
<span class="nb">close</span><span class="p">(</span><span class="n">FILE</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$flg_created</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
<span class="k">print</span> <span class="s">&quot;First execution : Buffer in creation.... \n&quot;</span><span class="p">;</span>
<span class="nb">exit</span><span class="p">(</span><span class="nv">$ERRORS</span><span class="p">{</span><span class="s">&quot;UNKNOWN&quot;</span><span class="p">});</span>
<span class="p">}</span>
<span class="k">my</span> <span class="nv">$nfs_diff</span><span class="o">=</span><span class="nv">$new_nfs_ops</span> <span class="o">-</span> <span class="nv">$last_nfs_ops</span><span class="p">;</span>
<span class="nv">$nfs_diff</span><span class="o">=</span><span class="nv">$new_nfs_ops</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$nfs_diff</span> <span class="o">&amp;</span><span class="ow">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$time_diff</span><span class="o">=</span><span class="nv">$update_time</span> <span class="o">-</span> <span class="nv">$last_check_time</span><span class="p">;</span>
<span class="nv">$time_diff</span><span class="o">=</span><span class="nv">$update_time</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$time_diff</span> <span class="o">&amp;</span><span class="ow">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$nfs_ops</span> <span class="o">=</span> <span class="nv">$nfs_diff</span> <span class="o">/</span> <span class="p">(</span> <span class="nv">$time_diff</span> <span class="p">);</span>
<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;Nfs ops : %.2f ops/sec &quot;</span><span class="p">,</span> <span class="nv">$nfs_ops</span><span class="p">);</span>
<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;|nfsOps=&quot;</span><span class="o">.</span><span class="nv">$nfs_ops</span><span class="o">.</span><span class="s">&quot;\n&quot;</span><span class="p">);</span>
<span class="nb">exit</span><span class="p">(</span><span class="nv">$ERRORS</span><span class="p">{</span><span class="s">&quot;OK&quot;</span><span class="p">});</span>
</code></pre></div>
      <a href="/2010/12/22/monitor-netapp-by-net-snmp" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/12/16/diff-between-for-while" title="for/while循环的区别" rel="bookmark">for/while循环的区别</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-12-16 00:00:00 +0800">16 Dec 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一般习惯使用for循环，在一年前写cgi的时候，还为这郁闷过一阵：for i in <code>cat ip</code>时，会自动的把文件中每行内容按照空格分割传递，最后采用先把空格改成+号的方式解决。</p>
<p>今天看CU，发现也有人提出这个问题，而解决办法很简单——用while循环即可。</p>
<table>
  <tbody>
    <tr>
      <td>另，while循环有两个用法，cat a</td>
      <td>while read和while;do;done&lt;a，pipe方式的变量，仅在循环内有效，又是一个区别~~</td>
    </tr>
  </tbody>
</table>
<p>下面是示例：</p>
<p>[root@localhost ~]# cat info
a b c d
[root@localhost ~]# for i in <code>cat info </code>;do echo $i;done
a
b
c
d
[root@localhost ~]# i=123;while read i;do echo $i;done&lt;info;echo $i
a b c d</p>
<p>[root@localhost ~]# i=12;cat info |while read i;do echo $i;done;echo $i
a b c d
12
[root@localhost ~]#</p>
<p>另，看到一个网站，专门介绍单行shell命令的，对SA来说，比较有用，url如下：
<a href="http://www.commandlinefu.com/commands/browse">http://www.commandlinefu.com/commands/browse</a></p>
      <a href="/2010/12/16/diff-between-for-while" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/12/12/learning-weathermap-cacti-plugin-3" title="weathermap-cacti-plugin学习(3)" rel="bookmark">weathermap-cacti-plugin学习(3)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-12-12 00:00:00 +0800">12 Dec 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>今天继续啃weathermap的php代码，因为lib的readdata里return了$inbw和$outbw，尝试在之前理解的ReadConfig()相应match处加上了一段 <code>if($inbw=='0'){$this-&gt;width=0;$linematched++;}elseif</code>……等几分钟后cache过期，一看weathermap效果，所有的链路曲线箭头图都变成了一根直线~~然后仔细看了看这串if之前的while，发现原来weathermap不是每次针对数据进行config匹配，而是统一读取一次config。也就是说ReadConfig()里的任何修改都会对全局起作用。</p>
<p>既然在源头的配置参数无法修改，那么就只能在末端的绘图的时候做出改变了，找到 <code>draw_curve()</code> 函数，这个函数就是画线的。最终由 <code>Draw()</code> 函数分别调用 <code>calc_curve</code> 描点，<code>draw_curve</code> 连线，<code>drawlabel</code> 画框。<code>Draw()</code> 内容是一个顺序处理过程，在最后的 <code>drawlabel()</code> 前面，可以很清晰的看到 <code>$task[*]</code> 是怎么取出的：</p>
<div class="highlight"><pre><code class="php"><span class="x">$outbound=array($q1_x,$q1_y,0,0,$this-&gt;outpercent,$this-&gt;bandwidth_out,$q1_angle);</span>
<span class="x">$inbound=array($q3_x,$q3_y,0,0,$this-&gt;inpercent,$this-&gt;bandwidth_in,$q3_angle);</span>
</code></pre></div>
<p>那么在draw_curve()前面，依葫芦画瓢来上一段就好了：</p>
<div class="highlight"><pre><code class="php"><span class="x">if(($this-&gt;bandwidth_out == &#39;0&#39;) &amp;&amp; ($this-&gt;bandwidth_in == &#39;0&#39;))</span>
<span class="x">{</span>
<span class="x">    $link_width=&#39;0&#39;;</span>
<span class="x">}</span>
<span class="x">else</span>
<span class="x">{</span>
<span class="x">    $link_width=$this-&gt;width;</span>
<span class="x">}</span>
<span class="x">draw_curve($im, $this-&gt;curvepoints, $link_width, $outline_colour, $comment_colour, array($link_in_colour, $link_out_colour), $this-&gt;name, $map);</span>
</code></pre></div>
<p>这个改完当然不能看到效果，看到就该排障去了~不过可以采用一点变通的方法来验证一下，比如某些线路现在比较空闲，我们就把预定的阀值0（断网的流量）改大一些，刚好超过某个空载线路即可了：</p>
<p>比如改成 <code>if ( $this-&gt;bandwidth_out &lt; '1000' )</code> 的话，weathermap效果变成如下：</p>
<p><img src="/images/uploads/qqe688aae59bbee69caae591bde5908d.jpg" alt="wethermap" /></p>
<p>其中两条流量小于1000bits的线路，其width就变成了0，只留下一条直线了~~</p>
<p>至于为了 <code>width==0</code> 却还留下了一条线，这就跟weathermap的绘图方式有关了。<code>draw_curve</code> 中是这么利用gd画图的：</p>
<ol>
  <li>根据node的位置，获取在二维空间上的x轴、y轴坐标，在两个node之间通过打点的方式进行矢量连线；</li>
  <li>获取设定的width，将之前的坐标点平移相应的位置，再次打点；</li>
  <li>在连线的中点处绘制箭头；</li>
  <li>填充颜色。</li>
</ol>
<p>如果要完全去除掉这根连线，或许可以在 <code>draw_curve</code> 中设定其连线长度为0？在 <code>draw_curve()</code> 中有一个变量叫 <code>$totaldistance</code>，指的是两个node之间的距离，之后包括箭头、文字等，都是以这个变量*50%来计算的。添加 <code>if($this-&gt;bandwidth_out&lt;1000){$totaldistance=0}</code>，等了十分钟再刷新，可图片依然没有更新！</p>
<p>继续看 <code>$totaldistance</code> 是怎么得出的，看到了 <code>$this-&gt;curvepoints</code>，而 <code>$this-&gt;curvepoints</code> 是通过 <code>calc_curve($xpoints, $ypoints)</code> 返回的。那么在 <code>Draw()</code> 中继续修改 <code>$this-&gt;curvepoints</code> 即可。变通一下上面的测试代码如下：</p>
<div class="highlight"><pre><code class="php"><span class="x">$link_width=$this-&gt;width;</span>
<span class="x">$this-&gt;curvepoints = calc_curve($xpoints, $ypoints);</span>
<span class="x">if ( $this-&gt;bandwidth_out &lt; &#39;2000&#39; )</span>
<span class="x">{</span>
<span class="x">    $link_width=0; //没有连线的话，宽度设啥都一样了~</span>
<span class="x">    $this-&gt;curvepoints = array( );</span>
<span class="x">}</span>
</code></pre></div>
<p>稍后刷新页面，看到原来的连线已经不见了~ 不过从效果图来看，少了连线反而不起眼了，还不如留着一根线容易引起警觉……</p>
<p><img src="/images/uploads/qqe688aae59bbee69caae591bde5908d1.jpg" alt="new-weathermap" /></p>
      <a href="/2010/12/12/learning-weathermap-cacti-plugin-3" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/12/12/learning-cache-control-from-mop-com" title="从猫扑论坛看终极页的缓存控制" rel="bookmark">从猫扑论坛看终极页的缓存控制</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-12-12 00:00:00 +0800">12 Dec 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>GF找我要猫扑账号，只好去申请了一个，顺带着之前分析天涯的劲头，把猫扑也看看~</p>
<p>猫扑的左右分栏与天涯等论坛都不同，其左侧栏提供了大量推荐文章和栏目列表，右侧栏作为具体内容的阅读使用，通过firebug和源码阅读可以看到，左侧栏是通过frame加载的 <code>/leftFrame.jsp?type=*</code> ，再由该jsp根据后面的参数来调用相应的html页；右侧栏是通过js中定义的 <code>openRightUrl</code> 来打开具体某个html帖子，这个 <code>openRightUrl</code> 定义在<a href="http://txt.mop.com/dzhjs/dzh2js/turlUrl.js?version">http://txt.mop.com/dzhjs/dzh2js/turlUrl.js?version</a>里，其实就是一个 <code>right.location.href</code>。显然这个js将成为上猫扑时最常用的文件，其缓存时间相当长~header中可以看到 <code>Cache-Control: max-age=8640000</code> </p>
<p>另，虽然header中的Server内容被修改，但当不带参数访问 <code>/leftFrame.jsp</code> 时，其调用的 <code>*_0_0.html</code> 不存在，显示出了 nginx0.7.34 的 404 错误页面。但随意输入 abcd.html，却能返回猫扑自定的错误页面，这也是比较怪的一点，怀疑其 nginx 的 proxy 配置不太正确。</p>
<p>最后还是看html的缓存控制和回复时的控制。</p>
<p>从列表中复制具体一个帖子的html链接地址另行打开，比如 <code>http://dzh.mop.com/topic/readSub_12990049_0_0.html</code> 第一个数应该是帖子号，第二个数是页码（从0开始计数~），第三个未知……</p>
<p>可以看到这该域名下的html的默认配置，max-age是180。</p>
<p>然后写下评论，点击提交回复。内容随即更新了，但url抓起到的url却是 <code>http://dzh.mop.com/topic/readSub_12990049_-1_0.html</code> ，而这个url的max-age设定是0！
比较奇怪的是，回复时POST提交的url并没有和天涯一样返回一个302指向，而是返回一个无内容的200，但页码依然跳转了，而且 <code>-1_0.html</code> 的refer也不是POST的jsp，而是原先停留的 <code>0_0.html</code> ……</p>
<p>另外点了一下全文观看，其页码是-2，max-age也是180，显然回复后的显示url是特意定制的header~~</p>
<p>最后，有图有真相：</p>
<p><img src="/mop.jpg" alt="mop" /></p>
      <a href="/2010/12/12/learning-cache-control-from-mop-com" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/12/10/xen-dom0-memory-setup" title="xen的dom0内存设置" rel="bookmark">xen的dom0内存设置</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-12-10 00:00:00 +0800">10 Dec 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cloud-ref" title="cloud" rel="category tag">cloud</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>公司测试环境使用了xen来提供大批逻辑隔离的服务器供内部调测使用。随着应用系统和同事人数的增加，虚拟机数量越来越多，原先每台server开两三个vm已经吃紧，遂要增加新的vm。cp相应的img后，启动却失败了。</p>
<p>连上server看了一下具体的报错和系统信息，server的BIOS上识别出了1G内存，free命令的mem-total是491MB，xm li看到dom0的mem正是491M，而dom1、dom2各255M。</p>
<p>修改/etc/grub.conf，在kernel /xen.gz-2.6.18-8.el5后面加上dom0_mem=128M。reboot之后再启动第三台vm，OK！</p>
<p>另：按照一般经验，一台2G的server，dom0最低使用mem在128-256M，单个vm的mem最低为64M(debian)或128M(CentOS)</p>
      <a href="/2010/12/10/xen-dom0-memory-setup" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/12/10/learning-cache-control-from-tianya-cn" title="从天涯论坛看终极页的缓存控制" rel="bookmark">从天涯论坛看终极页的缓存控制</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-12-10 00:00:00 +0800">10 Dec 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一般不太上天涯论坛灌水或者潜水，不过经常去天涯SA刘天斯的blog上逛逛~在他开源memlink后，想起来去天涯看看前端设计，发现其论坛主列表页采用nginx发布（预计有nginx的module直接读取memlink），终极页前端采用varnish缓存，回复时的动态asp页面由IIS处理。但在终极页上，虽然显示的server也还是IIS，我却有一定的怀疑~</p>
<p>在访问某终极页时，可以看到类似如下的header
Age:78
Cache-Control:public
Connection:close
Content-Encoding:gzip
Content-Length:34687
Content-Type:text/html
Date:Fri, 10 Dec 2010 09:03:48 GMT
Expires:Fri, 10 Dec 2010 09:07:30 GMT
Last-Modified:Fri, 10 Dec 2010 09:02:30 GMT
Server:Microsoft-IIS/6.0
Vary:Accept-Encoding
Via:Tianya Cache
X-Cache:HIT118
X-Powered-By:ASP.NET
X-tianya:1098678484 1098675384</p>
<p>如果按下F5，会看到一个IMS请求，最后返回304或者200的结果。</p>
<p>如果按下Ctrl+F5，会看到一个no-cache请求，最后返回200的结果。</p>
<p>不过奇怪的是，在no-cache请求后，虽然明知页面没有变（请求的是一个多页帖子的第一页，wget和wget &ndash;header &lsquo;Cache-Control: no-cache&rsquo;下来后的页面的MD5值都一样），但返回的last-modified时间却变成了和Date一致的当前时间了。以至于让我怀疑这个*.shtml难道不是静态化生成的？</p>
<p>然后回复该帖。通过POST方式向另一个动态域名传输数据，并302跳转回原页面。由于POST方式的不可缓存性，浏览器自动带上了no-cache请求头，并传递给了302之后的动作，即以no-cache重新请求了原帖子的url，并重新下载了该页面。由此完成了对回复的即时更新——对于论坛来说，重要的就是发帖人自己能即时看到，其他人完全可以等一会页面过期或者IMS比对来看别人的新回复。</p>
<p>假设前面说到的shtml确实是静态化生成的话，那么这个直接跳转的做法就有一定的风险，即要求系统在极短时间（从浏览器时间看就是POST的firstbyte时间开始，到200的connection时间结束，网络较好的情况下应该是毫秒级）内，完成对终极页的静态化工作。
写到这里，愈发怀疑这个shtml是asp的伪装版了……</p>
      <a href="/2010/12/10/learning-cache-control-from-tianya-cn" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/12/10/intro-amcharts" title="flash绘图利器-amcharts" rel="bookmark">flash绘图利器-amcharts</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-12-10 00:00:00 +0800">10 Dec 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>作为SA最常用的绘图工具肯定是rrdtool；而coder最常用的肯定是gd；前段时间从ibm文库里学到一个同样很强大的函数绘图工具gnuplot；最近在技术群里又见识到一些更新奇小巧的绘图工具，记录一下~</p>
<p>google的API提供一个简易而不失美观的方法（详见<a href="http://code.google.com/intl/zh-CN/apis/charttools/docs/choosing.html">http://code.google.com/intl/zh-CN/apis/charttools/docs/choosing.html</a>）只需要在url的strings里提供一些数据，google就能直接返回给你想要的图表。当然也能采用google提供的js库完成高级一些的内容——不过对某些小心翼翼的SA来说，采用外部js总让人有一种不安全感~而比较固定的样式又可能不足以让销售部门的同事满意……</p>
<p>扶凯大大及时冒泡，提供给大家另一个工具：amcharts！一个flash绘图工具。flash的美观度和互动能力绝对是众所周知的有保证~（详见<a href="http://www.amcharts.com/">http://www.amcharts.com/</a>）官网界面简洁明快，各种examples，包括股价图、柱状图、饼状图、线面图、散点图，网状图，支持3D效果、渐变效果、背景图自定义、指针自定义图文提示、数据动态输入等各种功能。xml配置文件的每个标签都有详细注释。使用时，只需要在webroot下放上amcharts的swf，写好settings.xml，在html里插入swf即可~</p>
<p>在选择到stock的Smoothed line chart(平滑线图)时，我很惊讶的发现：这不就是之前我一直很赞叹的蓝汛客户服务平台里的带宽flash图么？如下所示：</p>
<p><img src="/images/uploads/charts.jpg" alt="amcharts" /></p>
<p>不过这个工具虽然千好万好，没想出来对我目前的工作有啥使用的必要……姑且记录之~</p>
      <a href="/2010/12/10/intro-amcharts" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/12/04/nagios-add-ons-install" title="nagios的add-ons安装小抄~" rel="bookmark">nagios的add-ons安装小抄~</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-12-04 00:00:00 +0800">04 Dec 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>给nagios安装几个add-ons，碰到一些一般安装教程上不会提及的问题，记录一下：</p>
<p>1、ndoutils：
在./configure通过后make一直error，因为不管是否&ndash;with-mysql-lib，也不管&ndash;with-mysql-lib=/usr/local/mysql/lib还是/usr/local/mysql/lib/mysql，甚至使用LDFLAGS=-I/usr/local/mysql/lib等等，最后在make的时候总还是会报出如下错误：
../include/config.h:261:25: error: mysql/mysql.h: No such file or  directory
../include/config.h:262:26: error: mysql/errmsg.h: No such file or  directory
解决办法：编辑config.h文件的261和262行，把mysql/*.h的mysql/删除掉即可。</p>
<p>make完成后，将相应文件cp到指定目录，启动ndomod会报错libmysqlclient.so.6.0.0动态链接库无法找到。网上一般都说ln -s /usr/local/mysql/lib/* /usr/lib;echo &lsquo;/usr/lib&rsquo;&nbsp;&raquo; /etc/ld.so.conf;ldconfig即可。其实还不行。
解决办法：echo &lsquo;/usr/local/mysql/lib/mysql&rsquo; &gt; /etc/ld.so.conf.d/mysql.conf;ldconfig即可。因为通用办法的目录不够深。</p>
<p>2、pnp4nagios：
之前使用的pnp0.4.<em>版本，今天下的是pnp0.6.</em>版本。整个url设计发生了较大变化。各监控项页面的url从pnp4nagios/index.php?host=&amp;service=变成了/pnp4nagios/graph?host=&amp;service=。而这个graph（rrd图像的url是/pnp4nagios/image?***）则通过apache的mod_rewrite实现。
pnp自己编译时可以make出来一个httpd.conf。其中相关Rewrite的包括：</p>
<div class="highlight"><pre><code class="apache"><span class="nt">&lt;Directory</span> <span class="s">&#39;&quot;/usr/local/pnp4nagios/share/&quot;</span><span class="nt">&gt;</span>
<span class="nb">RewriteEngine</span> <span class="k">On</span>
<span class="nb">RewriteBase</span> <span class="sx">/pnp4nagios/</span>
<span class="nb">RewriteRule</span> ^(application|modules|system) - [F,L]
<span class="nb">RewriteCond</span> %{REQUEST_FILENAME} !-d
<span class="nb">RewriteCond</span> %{REQUEST_FILENAME} !-f
<span class="nb">RewriteRule</span> .* index.php$0 [PT,L]
<span class="nt">&lt;/Directory&gt;</span>
</code></pre></div>
<p>因为pnp编译时没有具体区分etc和share的路径，所以之后apache的发布路径也不同，为了方便，不再写directory。最后经过反复试验，可用配置如下：</p>
<div class="highlight"><pre><code class="apache"><span class="nb">RewriteEngine</span> <span class="k">On</span>
<span class="nb">RewriteRule</span> ^(application|modules|system) - [F,L]
<span class="nb">RewriteCond</span> %{DOCUMENT_ROOT}/%{REQUEST_FILENAME} !-d
<span class="nb">RewriteCond</span> %{DOCUMENT_ROOT}/%{REQUEST_FILENAME} !-f
<span class="nb">RewriteRule</span> ^/nagios/pnp4nagios/(.*) <span class="sx">/nagios/pnp4nagios/index.php</span>$1 [PT,L]
</code></pre></div>
<p>试验中发现几个apache与nginx的不同：
1、rewriterule的转向url不能用^标记起始端！
2、PT的强制进入下一个处理器相当有用，不然会形成回环rewrite！
3、rewritecond里德%{REQUEST_FILENAME}默认是在rewritebase下的——而rewritebase只能在directory里使用。</p>
      <a href="/2010/12/04/nagios-add-ons-install" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/12/03/keepalived-problem-about-vrrp-delay" title="keepalived故障一例" rel="bookmark">keepalived故障一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-12-03 00:00:00 +0800">03 Dec 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一组lvs，以keepalived主从方式运行。今天早上突然收到VIP报警，所有的VIP都ping不通了。</p>
<p>上lvs运行ipvsadm -ln一看，计数表全是0！怀疑是slave霸占了MAC，于是keepalived restart了一次，故障依旧。然后再restart了一次master，顿时恢复正常。</p>
<p>然后分析messages中的详细信息，推理本次故障的过程如下：</p>
<p>故障前——masterA，slaveB</p>
<pre><code>0:00    A "kernel:eth1:link DOWN"，疑似网卡物理中断，自动降级成slave；    
0:01    B检测A宕机，升级为master，send arp到交换机，add所有VIP；    
0:40    A "kernel:eth1:link UP"，但配置应该是不自动抢占；    
0:43    A检测B宕机，升级为master；    
0:48    A发送arp刷新请求到交换机，add所有VIP，但因为是物理中断，目前A实际仍处于断网状态，有期间RIP检查的timeout为证；    
1:10    A检测RIP的http status正常，即此时A的网络才正式恢复正常；    
1:10    B检测发觉A的状态为master，降级为slave，remove所有VIP；    
</code></pre>
<p>在0:43的时候，masterA的ARP刷新请求没能发送到交换机，而交换机记录的对应地址就还是B的——但在1:10时，B自认为slave而移除了所有ip。导致ping失败！</p>
<p>故障解决过程解析：</p>
<p>1、重启B——因为B已经是slave，所以restart不会发送ARP刷新，无效；  <br />
2、重启A——因为A自认是master，重启A导致keepalived切换，会触发B发送ARP刷新，恢复正常。</p>
<p>最终解决办法：</p>
<p>在keepalived.conf中添加garp_master_delay 30参数，让slave在升级成master后延时30s再发送一次arp刷新请求，以应对网卡硬件中断引起的这个问题。</p>
      <a href="/2010/12/03/keepalived-problem-about-vrrp-delay" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/11/26/learning-weathermap-cacti-plugin-2" title="weathermap-cacti-plugin学习(2)" rel="bookmark">weathermap-cacti-plugin学习(2)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-11-26 00:00:00 +0800">26 Nov 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在Weathermap.class.php中，定义了一个function叫LoadPlugins，读取lib/datasources/下的php类。其中就有WeatherMapDataSource_rrd.php。其中定义了Init、Recognise和ReadData三个方法。明显是ReadData函数来读取rra数据，具体方法为调用管道，运行rrdtool命令。</p>
<p>命令如右：rrdtool fetch *.rrd AVERAGE &ndash;start now-800 &ndash;end now</p>
<p>然后是对命令的结果进行分析。可以先运行一下看看效果：</p>
<p>[raochenlin@cacti datasources]$ date +%s;/usr/local/rrdtool-1.2.18/bin/rrdtool fetch /www/cacti/rra/10<em>168</em>168<em>130_traffic_in</em>2866.rrd AVERAGE &ndash;start now-800 &ndash;end now
1290704787
traffic_out          traffic_in</p>
<p>1290704100: 4.8623533333e+01 2.2821386667e+02
1290704400: 4.0663000000e+01 1.9051346667e+02
1290704700: 3.5332000000e+01 2.3380053333e+02
1290705000: nan nan</p>
<p>由此可见数据是300s一采集，所以当设定start是-800的时候，就会取比800大的离800最近的300的倍数，即900之间的数据。</p>
      <a href="/2010/11/26/learning-weathermap-cacti-plugin-2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/11/25/draw-images-of-inotify-log-by-gnuplot" title="inotify-purge后续分析" rel="bookmark">inotify-purge后续分析</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-11-25 00:00:00 +0800">25 Nov 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在选定sersync2进行command方式刷新后，需要对诸多域名的更新频率做个简单的分析，以了解编辑的操作习惯，方便选定调整时间、确定文件过期时间等等。</p>
<p>经过测试，早command插件下，sersync输出的是file的全路径。考虑到实际情况是有大量servername和serveralias，运行如下脚本：</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
<span class="nv">MODIFY_FILE</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
<span class="nv">MODIFY_DIR</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$MODIFY_FILE</span>|awk -F/ <span class="s1">&#39;{print $3}&#39;</span><span class="sb">`</span>
<span class="nv">MODIFY_URI</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$MODIFY_FILE</span>|sed <span class="s1">&#39;s/\/backup\/.*.test.com\/htdocs//&#39;</span><span class="sb">`</span>
<span class="nv">MODIFY_DOMAIN</span><span class="o">=</span><span class="sb">`</span>cat servername.list|grep <span class="nv">$MODIFY_DIR</span>|awk <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>
<span class="nv">IPLIST</span><span class="o">=</span><span class="s2">&quot;1.1.1.12</span>
<span class="s2">1.1.1.79</span>
<span class="s2">1.1.1.87</span>
<span class="s2">1.1.1.21</span>
<span class="s2">1.1.1.22</span>
<span class="s2">1.1.1.23</span>
<span class="s2">1.1.1.27</span>
<span class="s2">1.1.1.80</span>
<span class="s2">&quot;</span>
<span class="nv">Time</span><span class="o">=</span><span class="sb">`</span>date +%Y%m%d<span class="sb">`</span>
<span class="nv">Username</span><span class="o">=</span><span class="s1">&#39;test.com&#39;</span>
<span class="nv">Userkey</span><span class="o">=</span><span class="s1">&#39;test&#39;</span>
<span class="nv">Userpass</span><span class="o">=</span><span class="s1">&#39;test.com1234&#39;</span>
<span class="nv">MD5</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -n <span class="s2">&quot;$Time$Username$Userkey$Userpass&quot;</span>|md5sum|awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
<span class="k">function </span>cache_purge <span class="o">{</span>
<span class="k">for </span>i in <span class="nv">$IPLIST</span>;<span class="k">do</span>
/home/tools/squidclient -p 80 -h <span class="nv">$i</span> -m purge <span class="s2">&quot;$1&quot;</span>
<span class="k">done</span>
curl -s -G -d <span class="s2">&quot;username=${Username}&amp;amp;md5=${MD5}&amp;amp;url_list=$1&quot;</span> http://cs.fastweb.com.cn/interface/push_portal.php
<span class="o">}</span>
<span class="k">for </span>i in <span class="sb">`</span><span class="nb">echo</span> <span class="nv">$MODIFY_DOMAIN</span>|sed <span class="s1">&#39;s/,/ /g&#39;</span><span class="sb">`</span>;<span class="k">do</span>
<span class="nv">PURGE_URL</span><span class="o">=</span><span class="s2">&quot;http://$i$MODIFY_URI&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;`date +%F-%T` $PURGE_URL&quot;</span> &gt;&gt; purge.log
cache_purge <span class="nv">$PURGE_URL</span>
<span class="k">done</span>
</code></pre></div>
<p>然后运行如下命令，分别得到html/js/css的每分钟更新量：（有点小瑕疵，即当某分钟html无更新时js和css也无法记录，不过这种概率应该不高）</p>
<div class="highlight"><pre><code class="bash">cat /home/tools/purge.log |awk -F<span class="s2">&quot;[:|-]&quot;</span> <span class="s1">&#39;/html/{a[$4&quot;:&quot;$5]++}/js/{b[$4&quot;:&quot;$5]++}/css/{c[$4&quot;:&quot;$5]++}END{for(i in a){print i,a[i],b[i],c[i]}}&#39;</span>|sort
</code></pre></div>
<p>得到文件类似如下：</p>
<pre><code>11:23 28 15
11:24 10 7
11:25 224 37 13
11:26 470 192
11:27 344 187 1
11:28 441 77 2
11:29 419 8
</code></pre>
<p>然后创建gnuplot.conf如下：</p>
<div class="highlight"><pre><code class="tcl"><span class="k">set</span> terminal png xFFEEDD size <span class="mi">2048</span><span class="err">,</span><span class="mi">512</span>
<span class="k">set</span> output <span class="s2">&quot;log.png&quot;</span>
<span class="k">set</span> autoscale
<span class="k">set</span> xdata time
<span class="k">set</span> timefmt <span class="s2">&quot;%H:%M&quot;</span>
<span class="k">set</span> format x <span class="s2">&quot;%H:%M&quot;</span>
<span class="k">set</span> xtics <span class="mi">10</span>
<span class="k">set</span> mxtics <span class="mi">4</span>
<span class="k">set</span> style data lines
<span class="k">set</span> datafile missing <span class="s2">&quot;0&quot;</span>
<span class="k">set</span> xlabel <span class="s2">&quot;time per day&quot;</span>
<span class="k">set</span> ylabel <span class="s2">&quot;purge&quot;</span>
<span class="k">set</span> title <span class="s2">&quot;DPD expires&quot;</span>
<span class="k">set</span> grid
<span class="nv">plot</span> <span class="s2">&quot;log&quot;</span> using <span class="mi">1</span><span class="o">:</span><span class="mi">2</span> title <span class="s2">&quot;html/min&quot;</span><span class="err">,</span><span class="s2">&quot;log&quot;</span> using <span class="mi">1</span><span class="o">:</span><span class="mi">3</span> title <span class="s2">&quot;js/min&quot;</span><span class="err">,</span><span class="s2">&quot;log&quot;</span> using <span class="mi">1</span><span class="o">:</span><span class="mi">4</span> title <span class="s2">&quot;css/min&quot;</span>
</code></pre></div>
<p>运行 <code>cat gnuplot.conf|gnuplot</code> 就得到 log.png 了，如下：</p>
<p><img src="/images/uploads/log.png" alt="gnuplot-log" /></p>
      <a href="/2010/11/25/draw-images-of-inotify-log-by-gnuplot" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/11/24/learning-weathermap-cacti-plugin-1" title="weathermap-cacti-plugin学习(1)" rel="bookmark">weathermap-cacti-plugin学习(1)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-11-24 00:00:00 +0800">24 Nov 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>weathermap是一个利用php的gd库画图的程序，它可以自主运行，但更多情况下是作为cacti等监控工具的插件，通过rra数据库获取数据完成绘图。其官网地址如右：<a href="http://www.network-weathermap.com">http://www.network-weathermap.com</a></p>
<p>正常情况下，其link的color是由浅到深，当链路接近满载时，显示为鲜红色~然而这个设定遗漏了一个更加严重的情况——链路中断！在完全没有流量的情况下，weathermap应该会按照默认的0%处理——显示为白色（有+1的黑色边框）。</p>
<p>当然，这么可怕的事情，肯定会有多种手段来完成报警，不至于靠人眼盯着weathermap来汇报。但毕竟算是个功能上的缺失。</p>
<p>很巧，在zenoss（和cacti类似的另一款监控软件）的wiki上，看到有网友修改的perl版的weathermap，网址如右：<a href="http://community.zenoss.org/docs/DOC-2543">http://community.zenoss.org/docs/DOC-2543</a>。其配置文件中的WIDTH标签，比php的多出了&lt;%status-width(device name,component name)%&gt;配置，其解释说“draw link with width 0 if it is down otherwise draw it with width_ok width”。相关代码如下：</p>
<div class="highlight"><pre><code class="perl"><span class="k">while</span><span class="p">(</span><span class="nv">$line</span><span class="o">=~</span><span class="sr">m/&lt;%status-width([^%]+)%&gt;/</span><span class="p">)</span>
<span class="p">{</span>
<span class="k">my</span> <span class="nv">$tmp</span><span class="p">;</span>
<span class="nv">$tmp</span><span class="o">=</span><span class="nv">$1</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$res</span><span class="p">;</span>
<span class="c1">#WidthIfOK, device, port</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$tmp</span><span class="o">=~</span><span class="sr">m/\((.+),(.+),(.+)\)/</span><span class="p">)</span>
<span class="p">{</span>
<span class="k">my</span> <span class="nv">$url</span><span class="o">=</span><span class="n">get_device_url</span><span class="p">(</span><span class="nv">$2</span><span class="p">);</span>
<span class="nv">$res</span><span class="o">=</span><span class="n">get_port_status</span><span class="p">(</span><span class="s">&quot;$url/$3&quot;</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$res</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#OK</span>
<span class="p">{</span>
<span class="nv">$res</span><span class="o">=</span><span class="nv">$1</span><span class="p">;</span> <span class="c1">#default width</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
<span class="nv">$res</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
<span class="nb">die</span> <span class="p">(</span><span class="s">&quot;Bad format $line&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span><span class="o">!~</span><span class="sr">s/&lt;%status-width([^%]+)%&gt;/$res/</span><span class="p">)</span>
<span class="p">{</span>
<span class="nb">die</span> <span class="p">(</span><span class="s">&quot;Error 1&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>思路是通过wget数据获取状态，一旦错误就至width为0，否则读取正常设定值绘图。</p>
<p>在原版的php中相关部分如下：</p>
<div class="highlight"><pre><code class="php"><span class="x">if (preg_match(&quot;/^\s*WIDTH\s+(\d+)\s*$/i&quot;, $buffer, $matches))</span>
<span class="x">{</span>
<span class="x">if ($last_seen == &#39;LINK&#39;)</span>
<span class="x">{</span>
<span class="x">$curlink-&gt;width=$matches[1];</span>
<span class="x">$linematched++;</span>
<span class="x">}</span>
<span class="x">else // we&#39;re talking about the global WIDTH</span>
<span class="x">{</span>
<span class="x">$this-&gt;width=$matches[1];</span>
<span class="x">$linematched++;</span>
<span class="x">}</span>
<span class="x">}</span>
</code></pre></div>
<p>显然只要在这里加上一个else{}就可以了。</p>
<p>至于如何判定链路中断，有待继续学习~是外挂一个ping？或者读取rra中的数值？下一步先看懂Weathermap.class.php是怎么读取rra数值的吧~</p>
<p>（题外话，在baidu该字眼的第一页结果，看到中南民族大学的校园网cacti页面。他们居然开放匿名访问，甚至settings都能点开，无语~网址如右：<a href="http://210.42.159.3/cacti/plugins/weathermap/weathermap-cacti-plugin.php">http://210.42.159.3/cacti/plugins/weathermap/weathermap-cacti-plugin.php</a>）</p>
      <a href="/2010/11/24/learning-weathermap-cacti-plugin-1" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/11/22/pureftpd-problem-about-symbolic-links" title="ftp中的软连接问题" rel="bookmark">ftp中的软连接问题</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-11-22 00:00:00 +0800">22 Nov 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>数据临时迁移，为了尽量不影响业务，创建了一个软连接。不料pureftpd出了一点小问题。</p>
<p>当ln -s /text /www/text的时候，如果pureftpd.passwd中指定的是/www/text，访问没有问题；如果是/www的话，再cd text会出问题。</p>
<p>搞怪的是，text1出的报错是Too many levels of symbolic links，而text2出的报错是No such file or directory……</p>
<p>进pureftpd的src里看./configure &ndash;help，看到如下一行：</p>
<p>&ndash;with-virtualchroot    Enable the ability to follow symlinks outside a chroot jail</p>
<p>以前的编译，都只用了&ndash;with-everything       Build a big server with almost everything</p>
<p>看来almost里还真就不包括virtualchroot……</p>
<p>重新编译pureftpd，加上了virtualchroot参数。然后cp原ftp的pdb过来，启动一试，OK~</p>
      <a href="/2010/11/22/pureftpd-problem-about-symbolic-links" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/11/19/intro-sersync2-5" title="sersync2.5试用~" rel="bookmark">sersync2.5试用~</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-11-19 00:00:00 +0800">19 Nov 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前采用 inotify-tools 来触发 purge，实际运行中碰上一些问题：</p>
<p>1、因为一个文件的更新，可能伴随着 <code>create</code>、<code>modify</code>、<code>close_write</code> 等等过程，而文件稍大一些，甚至就有连续的 <code>modify</code> 出现。于是一个文件的更新，通过管道发送的 purge 请求经常可以看到三四个！如果量不大的情况下，倒也没什么，可如果更新比较频繁的情况下，再翻上三四倍，任务就比较拥挤了。</p>
<p>2、cms 程序通常是通过 ftp 等方式，将页面上传的文件 move 到指定位置。而 ftp 本身在接受过程中也会产生名叫 <code>.pureftpd-upload.****</code> 的临时文件。</p>
<p>第二个倒可以在管道后面再 grep 一次解决，但第一个问题在管道这种流形式的简单处理中就没办法了。预想了几个办法，先一个是记录日志，然后每次管道接受时比对日志中最近十条是否有重复，不过这么频繁的读写日志文件，也会很郁闷~；后一个是把日志文件转进内存去，即管道获取的信息 push 进一个 hash，然后 sleep 后再 poll 这个 hash 出来，不过 shell 没有 hash，就得把简单的 shell 重写成比较复杂的 perl 了……</p>
<p>今天刚想起来半年前曾经看到过金山逍遥运维部开源的一个项目，也是基于 inotify 完成的。去翻来看看，很好很强大，感觉完全能满足我目前的想法。</p>
<p>项目网址：<a href="http://code.google.com/p/sersync/">http://code.google.com/p/sersync/</a></p>
<p>提供了 bin 和 src 两个版本，直接下 bin 来用：</p>
<div class="highlight"><pre><code class="bash">wget http://sersync.googlecode.com/files/sersync2.5_64bit_binary_stable_final.tar.gz
tar zxvf sersync2.5_64bit_binary_stable_final.tar.gz
<span class="nb">cd </span>GNU-Linux-x86/
</code></pre></div>
<p>很简单，只有两个文件，一个是程序，一个是 xml 配置文件。配置包括 debug 模式、xfs 支持、过滤器配置（默认已过滤<code>^.</code>和<code>~$</code>）、inotify 监听（推荐是创建目录、完成输入和移动）、本地监听路径和 rsync 远程主机（ip，rsync 模块名、用户名密码）、失败重试及日志、多次失败后的定时任务、插件（通过socket 向远程主机传输 inotify 日志、通过 http 向 cdn 的 api 发送 purge 请求、调用外部命令处理文件）。</p>
<p>本来直接就有 purge 功能，可惜我的环境下域名比较多，目前的功能上只能对 url 做 regex，不能反引用到 domain 上。所以是写个 shell，然后采用 command 插件传递参数~</p>
<p>先最简单的实验，写个write.sh如下：</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/sh</span>
<span class="nb">echo</span> <span class="nv">$1</span> &gt;&gt; <span class="nv">$0</span>.log
</code></pre></div>
<p>然后修改xml如下句：</p>
<div class="highlight"><pre><code class="xml">    <span class="nt">&lt;param</span> <span class="na">prefix=</span><span class="s">&quot;GNU-Linux-x86/write.sh&quot;</span> <span class="na">suffix=</span><span class="s">&quot;&quot;</span> <span class="na">ignoreError=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
</code></pre></div>
<p>运行 <code>GNU-Linux-x86/sersync2 -d -m command</code> 即可后台运行 command 插件且不启用 rsync。</p>
<p>然后 <code>tailf write.sh.log</code> 看，果然每条 url 都不重复了~~</p>
<p>（看了作者周洋的 blog，其中提到文件如果比较大，更新完成时间超过一定值，也会导致队列重复，我猜估计思路和我的第二种想法应该是类似的。）</p>
<p>另，<code>sersync -h</code> 可以看到其固定修改 sysctl 如下：</p>
<div class="highlight"><pre><code class="bash"><span class="nb">echo </span>50000000 &gt; /proc/sys/fs/inotify/max_user_watches
<span class="nb">echo </span>327679 &gt; /proc/sys/fs/inotify/max_queued_events
</code></pre></div>
<p>据周洋的说法是 inotify 最多只能监听到五千万个文件夹~~在我的环境下，1300 万 inode，add watch 就花了1个多小时……</p>
      <a href="/2010/11/19/intro-sersync2-5" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/11/18/template-problem-of-pnp4nagios-2" title="pnp4nagios的模板问题(2)" rel="bookmark">pnp4nagios的模板问题(2)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-11-18 00:00:00 +0800">18 Nov 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>接上篇。结尾时找到的url确实就是解决这个问题的。我错怪作者鸟~~</p>
<p>在 <code>nagios/etc/pnp/check_commands</code> 文件夹下，可以添加 <code>%check_command%.cfg</code> 配置文件，以定义pnp在使用模板时的一些参数。在我的应用环境下，只需要添加如下一个 <code>check_nrpe.cfg</code> 即可：</p>
<pre><code>CUSTOM_TEMPLATE = 1   #使用命令的第一个参数做自定义模板名
DATATYPE = GAUGE       #数据类型为即时数值
USE_MIN_ON_CREATE = 0    #绘图数据最小值为0，用来排除某些错误溢出导致的负值
</code></pre>
<p>然后就可以进 <code>nagios/share/pnp/templates/</code> 下去创建自己需要的模板了。仿照cacti的样子写个loadavg的如下：</p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="nv">$opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;--vertical-label Load -l0  --title </span><span class="se">\&quot;</span><span class="s2">CPU Load for </span><span class="si">$hostname</span><span class="s2"> / </span><span class="si">$servicedesc</span><span class="se">\&quot;</span><span class="s2"> &quot;</span><span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="err"> </span><span class="s2">&quot;DEF:var1=</span><span class="si">$rrdfile</span><span class="s2">:</span><span class="si">$DS[1]</span><span class="s2">:AVERAGE &quot;</span> <span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;DEF:var2=</span><span class="si">$rrdfile</span><span class="s2">:</span><span class="si">$DS[2]</span><span class="s2">:AVERAGE &quot;</span> <span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;DEF:var3=</span><span class="si">$rrdfile</span><span class="s2">:</span><span class="si">$DS[3]</span><span class="s2">:AVERAGE &quot;</span> <span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;CDEF:total=var1,var2,+,var3,+ &quot;</span> <span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;HRULE:</span><span class="si">$WARN[1]</span><span class="s2">#FFFF00 &quot;</span><span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;HRULE:</span><span class="si">$CRIT[1]</span><span class="s2">#FF0000 &quot;</span><span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;AREA:var1#FFD700:</span><span class="se">\&quot;</span><span class="s2">load 1 </span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;GPRINT:var1:LAST:</span><span class="se">\&quot;</span><span class="s2">%6.2lf last</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;GPRINT:var1:AVERAGE:</span><span class="se">\&quot;</span><span class="s2">%6.2lf avg</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;GPRINT:var1:MAX:</span><span class="se">\&quot;</span><span class="s2">%6.2lf max</span><span class="se">\\</span><span class="s2">n</span><span class="se">\&quot;</span><span class="s2"> &quot;</span><span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;AREA:var2#7FFF00:</span><span class="se">\&quot;</span><span class="s2">Load 5 </span><span class="se">\&quot;</span><span class="s2">:STACK &quot;</span> <span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;GPRINT:var2:LAST:</span><span class="se">\&quot;</span><span class="s2">%6.2lf last</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;GPRINT:var2:AVERAGE:</span><span class="se">\&quot;</span><span class="s2">%6.2lf avg</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;GPRINT:var2:MAX:</span><span class="se">\&quot;</span><span class="s2">%6.2lf max</span><span class="se">\\</span><span class="s2">n</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;AREA:var3#FF0000:</span><span class="se">\&quot;</span><span class="s2">Load 15</span><span class="se">\&quot;</span><span class="s2">:STACK &quot;</span> <span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;GPRINT:var3:LAST:</span><span class="se">\&quot;</span><span class="s2">%6.2lf last</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;GPRINT:var3:AVERAGE:</span><span class="se">\&quot;</span><span class="s2">%6.2lf avg</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;GPRINT:var3:MAX:</span><span class="se">\&quot;</span><span class="s2">%6.2lf max</span><span class="se">\\</span><span class="s2">n</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="p">;</span>
<span class="nv">$def</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">&quot;LINE1:total#000000 &quot;</span> <span class="p">;</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>采用DEF方式定义数据，CDEF方式计算总和，HRULE画水平线，AREA画涂层，LINE画连线(有1/2/3种粗细)，STACK累加数值绘图效果，GPRINT计算并显示数据。</p>
<p>只画一个图就都是$def[1]，如果需要两个图就是$def[2]，依次类推，不过页面上的Datesource是读取的*.xml文件中的<name>，如果合并数据绘图，显示就会有问题，所以最好就把所有数据都画一张图里。比如网卡流量。用CDEF取反，我不知道RPN中有没有特定函数，简单的采用了0,var,-方式，将部分数据倒到x轴下方~~</name></p>
<p>如果不是STACK的话，需要注意一点，AREA方式是不透明的，单纯的图层覆盖，所以一定要把最大的值放在最前面绘制，然后才能有效果。像流量这种没谱的事情，最好就采用LINE方式~~</p>
<p>目前我绘制的load、conn、flow三个rra如下：</p>
<p><img src="/images/uploads/load.jpg" alt="load" /></p>
<p><img src="/images/uploads/conn.jpg" alt="conn" /></p>
<p><img src="/images/uploads/flow.jpg" alt="flow" /></p>
      <a href="/2010/11/18/template-problem-of-pnp4nagios-2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page8">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page active">
      <a href="#">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li class="page">
      <a href="/page17">17</a>
    </li>
    <li>
      <a href="/page10">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
              <li><a href="http://showmetheco.de/" title="Viacheslav Tykhanovskyi(PocketIO/Text::Haml)">No time to wait</a></li>
              <li><a href="http://blog.dataloop.io/" title="A new SaaS monitoring tool for DevOps & Operations">Dataloop.IO</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://planeteria.org/perl6/" title="Perl6 文集">Planet Perl 6</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.lark.net.cn/" title="王剑">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://junqili.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://blog.l8ii.com/" title="刘侨">LairdNote</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="booklists" class="nav nav-list">
          <li class="nav-header">我写的第一本技术书籍</li>
          <li><a href='http://product.china-pub.com/3769604'><img src='http://images.china-pub.com/ebook3765001-3770000/3769604/shupi.jpg' border='0' alt='网站运维技术与实践'/></a></li>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
