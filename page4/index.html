<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">标签</a></li>
      	<li><a href="/archive.html">归档</a></li>
      	<li><a href="/errata.html">《网站运维技术与实践》勘误</a></li>
      	<li><a href="/projects.html">学习记录</a></li>
      	<li><a href="/categories.html">分类</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/10/gnuplot-to-draw-histogram-cluster" title="用gnuplot绘制直方图" rel="bookmark">用gnuplot绘制直方图</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-10 00:00:00 +0800">10 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>越来越喜欢用 gnuplot 画图了，因为有时候发现自己实在是不会用 Excel……</p>
<p>之前基本上用gnuplot画的都是时间轴形式的，诸位客官肯定已经看多了。但是 gnuplot 可不止是这点。还有一种很常见的功能也很方便，就是与时间无关的多个数据做对比的时候，还画成两条连线，就不如画成直方图更体现价值了。比如下面这组数据：</p>
<pre><code>地区	总数(A)	总数(B)
美洲	16682	20344
澳洲	4021	3672
欧洲	2902	2878
</code></pre>
<p>只需要几行配置，就可以生成很漂亮滴直方图对比了。</p>
<div class="highlight"><pre><code class="bash"><span class="nb">set </span>key right top Left reverse width 0 box 3
<span class="nb">set </span>xlabel <span class="s2">&quot;各大洲区域&quot;</span>
<span class="nb">set </span>ylabel <span class="s2">&quot;请求总数&quot;</span>
<span class="nb">set </span>ytics 0, 500
<span class="nb">set </span>mytics 5
<span class="nb">set </span>grid
<span class="nb">set </span>boxwidth 0.9 absolute
<span class="nb">set </span>style fill solid 1.00 border -1
<span class="nb">set </span>style histogram clustered gap 1 title offset character 0, 0, 0
<span class="nb">set </span>style data histograms
<span class="nb">set </span>terminal png size 1024, 512
<span class="nb">set </span>output <span class="s2">&quot;oversea.png&quot;</span>
plot <span class="s1">&#39;oversea.csv&#39;</span> using 2:xtic<span class="o">(</span>1<span class="o">)</span> ti col, <span class="s1">&#39;&#39;</span> u 3 ti col
</code></pre></div>
<p>注意如果行比较多，默认大小的图上X轴的标记就会挤在一块了，所以在 set terminal 后面设置图片大小，这和 set size 是不一样的。后者设置的相对值是本次要 plot 的图形在总画布上的比例大小。</p>
<p>plot 里 using 的两列也是和画 line 图时反过来的顺序，而且 X 轴的列要用 xtic() 包起来写，否则 gnuplot 会认为这应该是个自增序列，然后找不到 xrange 出错。</p>
<p>效果图如下：</p>
<p><img src="/images/uploads/gnuplot-boxes.png" alt="图片" /></p>
      <a href="/2012/12/10/gnuplot-to-draw-histogram-cluster" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/01/convert-docx-to-markdown" title="把docx文档转换成markdown格式发布" rel="bookmark">把docx文档转换成markdown格式发布</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-01 00:00:00 +0800">01 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>有些Word文档想搬到博客上来，而博客用的是markdown的格式。最简单的办法是在Word里转成html格式另存为，因为markdown和html是兼容的。不过word直接另存为的html里面带有“海量”的无聊样式，实在不方便之后我们再用vim的工具编辑。所以还是想办法整整。</p>
<p>相对来说，Word的docx格式比doc格式要容易处理，因为docx是微软特意推出的open xml格式。其实就是记录了文本内容的content.xml、附件media/*和对应附件路径的_ref.xml等的zip包而已。所以相对必须在Windows平台上调用WIN32OLE的API来处理的doc来说，我们在linux平台上也可以很容易的处理docx文件了。比如rubygems上就有一个很不错的gem叫<code>ydocx</code>。一般的docx库都是只抽取docx里的content文字，而这个ydocx很负责的把media/*也复制到docxname_files/images/*下面，并且在html里生成<code>&lt;img&gt;</code>标签了。</p>
<p>然后另一步就是把html转换成markdown，这在github上也有现成的repo叫<a href="https://github.com/cousine/downmark_it">downmark_it</a>。嗯，这名字一目了然就是反过来……</p>
<p>(<code>ydocx</code>用的是<code>nokogiri</code>，<code>downmark\_it</code>用的是<code>hpricot</code>，或许应该也改用<code>nokogiri</code>比较好~不过<code>nokogiri</code>官网可耻的被墙了)</p>
<h1 id="section">首先安装依赖</h1>
<div class="highlight"><pre><code class="bash">  apt-get install libxslt1-dev libxml2-dev
  gem install rubyzip htmlentities rmagick ydocx hpricot
  wget https://raw.github.com/cousine/downmark_it/master/downmark_it.rb
</code></pre></div>
<h1 id="section-1">编写转换脚本</h1>
<div class="highlight"><pre><code class="ruby">  <span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
  <span class="nb">require</span> <span class="s1">&#39;ydocx&#39;</span>
  <span class="vg">$:</span> <span class="o">&lt;&lt;</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span>
  <span class="nb">require</span> <span class="s1">&#39;downmark_it&#39;</span>
  <span class="n">filename</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">shift</span>
  <span class="n">ydocx</span> <span class="o">=</span> <span class="ss">YDocx</span><span class="p">:</span><span class="ss">:Document</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
  <span class="n">html</span> <span class="o">=</span> <span class="n">ydocx</span><span class="o">.</span><span class="n">to_html</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="no">DownmarkIt</span><span class="o">.</span><span class="n">to_markdown</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
</code></pre></div>
<p>这样就能看到输出了。目录里的每个章节都有引用格式凸现，美中不足是对word里的标题样式识别不太好，本来期望是可以自己生成<code>&lt;h1&gt;</code>、<code>&lt;h2&gt;</code>的，但是ydocx生成的html里只把第一个标题一变成<code>&lt;h1&gt;</code>，其他的都是普通的<code>&lt;p&gt;</code>。</p>
<p>另一个问题是上面脚本里直接调用to_html的方法，不会保存住unzip出来的images文件夹。自己再另写一段unzip的代码:</p>
<div class="highlight"><pre><code class="ruby">  <span class="nb">require</span> <span class="s1">&#39;fileutils&#39;</span>  
  <span class="nb">require</span> <span class="s1">&#39;zip/zip&#39;</span>  
  <span class="nb">require</span> <span class="s1">&#39;zip/zipfilesystem&#39;</span>  
  <span class="k">def</span> <span class="nf">unzip</span><span class="p">(</span><span class="n">zip_file</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">)</span>
    <span class="ss">Zip</span><span class="p">:</span><span class="ss">:ZipFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">zip_file</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">zf</span><span class="o">|</span>
      <span class="n">zf</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
        <span class="n">path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="no">FileUtils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">zf</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="p">{</span> <span class="kp">true</span> <span class="p">}</span>
      <span class="k">end</span>  
    <span class="k">end</span>  
  <span class="k">end</span>
  <span class="n">dirname</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;.docx&#39;</span><span class="p">)</span>
  <span class="n">unzip</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;/tmp/</span><span class="si">#{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="no">FileUtils</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="s2">&quot;/tmp/</span><span class="si">#{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">/media/&quot;</span><span class="p">,</span> <span class="s2">&quot;/images/&quot;</span><span class="p">)</span>
  <span class="no">FileUtils</span><span class="o">.</span><span class="n">rm_rf</span><span class="p">(</span><span class="s2">&quot;/tmp/</span><span class="si">#{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>比较普通的办法，是直接使用ydocx自带的脚本<code>docx2html --format none file.docx</code>，会在docx文档的同级目录下生成同名html和_files目录。然后再写一个单行脚本转成markdown的。</p>
      <a href="/2012/12/01/convert-docx-to-markdown" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/11/22/tatsumaki-demo" title="用 Tatsumaki 框架写 elasticsearch 界面" rel="bookmark">用 Tatsumaki 框架写 elasticsearch 界面</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-11-22 00:00:00 +0800">22 Nov 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Tatsumaki是Plack作者的一个小框架，亮点是很好的利用了psgi.streaming的接口可以async的完成响应。不过因为缺少周边支持，所以除了几个webchat的example，似乎没看到什么应用。笔者之前纯为练手，却用tatsumaki写了个sync响应的小demo，算是展示一下用tatsuamki做普通web应用的基础步骤吧：</p>
<p>(代码本来是作为一个ElasticSearch数据分析的平台，不过后来发现社区有人开始做纯js的内嵌进ElasticSearch的plugin了，所以撤了repo，这里贴下代码)</p>
<ul>
  <li>所有的psgi/plack应用都一样有自己的app.psgi文件：</li>
</ul>
<div class="highlight"><pre><code class="perl"><span class="k">our</span> <span class="nv">$VERSION</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>
<span class="c1">### app.psgi</span>
<span class="k">use</span> <span class="nn">Tatsumaki::</span><span class="n">Error</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Tatsumaki::</span><span class="n">Application</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Tatsumaki::</span><span class="n">HTTPClient</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Tatsumaki::</span><span class="n">Server</span><span class="p">;</span>
<span class="c1">### read config</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Basename</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">YAML::</span><span class="n">Syck</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$config</span> <span class="o">=</span> <span class="n">LoadFile</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s">&#39;/config.yml&#39;</span><span class="p">);</span>
<span class="c1">### elasticsearch init</span>
<span class="k">use</span> <span class="n">ElasticSearch</span><span class="p">;</span>
<span class="c1">#这里yml的写法借鉴Dancer::Plugin::ElasticSearch了</span>
<span class="k">my</span> <span class="nv">$elsearch</span> <span class="o">=</span> <span class="n">ElasticSearch</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;options&#39;</span><span class="p">}</span> <span class="p">);</span>
<span class="c1">### index init</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(strftime)</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$index</span> <span class="o">=</span> <span class="nb">join</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="p">(</span> <span class="p">(</span><span class="o">+</span><span class="nb">split</span><span class="p">(</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;index&#39;</span><span class="p">}</span> <span class="p">))[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strftime</span><span class="p">(</span> <span class="p">(</span><span class="o">+</span><span class="nb">split</span><span class="p">(</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;index&#39;</span><span class="p">}</span> <span class="p">))[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">localtime</span> <span class="p">)</span> <span class="p">);</span>
<span class="k">my</span> <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">};</span>
<span class="c1">#首页类，调用了模板</span>
<span class="nb">package</span> <span class="n">MainHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(Tatsumaki::Handler)</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">get</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;index.html&#39;</span><span class="p">);</span>
<span class="p">};</span>
<span class="c1">#具体的API类</span>
<span class="nb">package</span> <span class="n">ListHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(Tatsumaki::Handler)</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">get</span> <span class="p">{</span>
<span class="c1">#这里自动把urlpath切分好了</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$self</span><span class="p">,</span> <span class="nv">$group</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$interval</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">return</span> <span class="s">&#39;Not valid order&#39;</span> <span class="k">unless</span> <span class="nv">$order</span> <span class="ow">eq</span> <span class="s">&#39;count&#39;</span> <span class="ow">or</span> <span class="nv">$order</span> <span class="ow">eq</span> <span class="s">&#39;mean&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="s">&#39;Not valid interval&#39;</span> <span class="k">unless</span> <span class="nv">$interval</span> <span class="o">=~</span> <span class="n">m</span><span class="c1">#\d+(h|m|s)#;</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$key_field</span><span class="p">,</span> <span class="nv">$value_field</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$group</span> <span class="ow">eq</span> <span class="s">&#39;url&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$key_field</span> <span class="o">=</span> <span class="s">&#39;url&#39;</span><span class="p">;</span>
        <span class="nv">$value_field</span> <span class="o">=</span> <span class="s">&#39;responsetime&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$group</span> <span class="ow">eq</span> <span class="s">&#39;ip&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$key_field</span> <span class="o">=</span> <span class="s">&#39;oh&#39;</span><span class="p">;</span>
        <span class="nv">$value_field</span> <span class="o">=</span> <span class="s">&#39;upstreamtime&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#39;Not valid group field&#39;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="c1"># get index mapping and sort into array</span>
    <span class="k">my</span> <span class="nv">$mapping</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">(</span>
        <span class="nb">index</span> <span class="o">=&gt;</span> <span class="s">&quot;$index&quot;</span><span class="p">,</span>
        <span class="n">type</span>  <span class="o">=&gt;</span> <span class="s">&quot;$type&quot;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">@res_map</span><span class="p">;</span>
    <span class="k">for</span> <span class="k">my</span> <span class="nv">$property</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span> <span class="nv">$mapping</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$type</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$property</span> <span class="ow">eq</span> <span class="s">&#39;@fields&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">@fields</span><span class="p">;</span>
            <span class="nb">push</span> <span class="nv">@fields</span><span class="p">,</span> <span class="p">{</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="p">,</span> <span class="n">type</span> <span class="o">=&gt;</span> <span class="nv">$mapping</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$type</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$property</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$_</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">}</span> <span class="p">}</span>
                <span class="k">for</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span> <span class="nv">$mapping</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$type</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$property</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span> <span class="p">};</span>
            <span class="nb">push</span> <span class="nv">@res_map</span><span class="p">,</span> <span class="o">\</span><span class="nv">@fields</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">push</span> <span class="nv">@res_map</span><span class="p">,</span> <span class="p">{</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">$property</span><span class="p">,</span> <span class="n">type</span> <span class="o">=&gt;</span> <span class="nv">$mapping</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$type</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$property</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">}</span> <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1"># get value stat group by key field</span>
    <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
        <span class="nb">index</span> <span class="o">=&gt;</span> <span class="s">&quot;$index&quot;</span><span class="p">,</span>
        <span class="n">type</span>  <span class="o">=&gt;</span> <span class="s">&quot;$type&quot;</span><span class="p">,</span>
        <span class="n">size</span>  <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">query</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&quot;range&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="s">&#39;@timestamp&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">from</span> <span class="o">=&gt;</span> <span class="s">&quot;now-$interval&quot;</span><span class="p">,</span>
                    <span class="n">to</span>   <span class="o">=&gt;</span> <span class="s">&quot;now&quot;</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="n">facets</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&quot;$group&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="s">&quot;terms_stats&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="s">&quot;value_field&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;$value_field&quot;</span><span class="p">,</span>
                    <span class="s">&quot;key_field&quot;</span>   <span class="o">=&gt;</span> <span class="s">&quot;$key_field&quot;</span><span class="p">,</span>
                    <span class="s">&quot;order&quot;</span>       <span class="o">=&gt;</span> <span class="s">&quot;$order&quot;</span><span class="p">,</span>
                    <span class="s">&quot;size&quot;</span>        <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">}</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">@res_tbl</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">facets</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$group&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">terms</span><span class="p">}}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$mean</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%.03f&quot;</span><span class="p">,</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">mean</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$code_count</span> <span class="o">=</span> <span class="n">code_count</span><span class="p">(</span><span class="nv">$key_field</span><span class="p">,</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$interval</span><span class="p">);</span>
        <span class="nb">push</span> <span class="nv">@res_tbl</span><span class="p">,</span> <span class="p">{</span>
            <span class="n">key</span>   <span class="o">=&gt;</span> <span class="nv">$key</span><span class="p">,</span>
            <span class="n">min</span>   <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">min</span><span class="p">},</span>
            <span class="n">max</span>   <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">max</span><span class="p">},</span>
            <span class="n">mean</span>  <span class="o">=&gt;</span> <span class="nv">$mean</span><span class="p">,</span>
            <span class="n">code</span>  <span class="o">=&gt;</span> <span class="nv">$code_count</span><span class="p">,</span>
            <span class="n">count</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">},</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="c1"># render可以接收参数，并且默认把$self带进去，具体key是handler</span>
    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;index.html&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">table</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@res_tbl</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@res_map</span> <span class="p">});</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">code_count</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$key_field</span><span class="p">,</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$interval</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
        <span class="nb">index</span> <span class="o">=&gt;</span> <span class="s">&quot;$index&quot;</span><span class="p">,</span>
        <span class="n">type</span>  <span class="o">=&gt;</span> <span class="s">&quot;$type&quot;</span><span class="p">,</span>
        <span class="n">size</span>  <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">query</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="n">range</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="s">&#39;@timestamp&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">from</span> <span class="o">=&gt;</span> <span class="s">&quot;now-$interval&quot;</span><span class="p">,</span>
                    <span class="n">to</span>   <span class="o">=&gt;</span> <span class="s">&quot;now&quot;</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="n">facets</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&quot;code&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">facet_filter</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">term</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="nv">$key_field</span> <span class="o">=&gt;</span> <span class="s">&quot;$key&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="n">terms</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">field</span> <span class="o">=&gt;</span> <span class="s">&quot;status&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">facets</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">code</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">terms</span><span class="p">}}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$result</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">}}</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">#画图数据API类，因为响应的是Ajax请求，所以这里开启了async，不过其实没意义了。因为这个ElasticSearch代码不是async格式的。应该改造用ElasticSearch::Transport::AEHTTP才能做到全程async。</span>
<span class="nb">package</span> <span class="n">ChartHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(Tatsumaki::Handler)</span><span class="p">;</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">asynchronous</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="k">use</span> <span class="n">JSON</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">post</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$api</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;api&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s">&#39;term&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s">&#39;oh&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;status&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s">&#39;200&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$field</span> <span class="o">=</span>  <span class="nv">$key</span> <span class="ow">eq</span> <span class="s">&#39;oh&#39;</span> <span class="p">?</span> <span class="s">&#39;upstreamtime&#39;</span> <span class="p">:</span> <span class="s">&#39;responsetime&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
        <span class="nb">index</span> <span class="o">=&gt;</span> <span class="s">&quot;$index&quot;</span><span class="p">,</span>
        <span class="n">type</span>  <span class="o">=&gt;</span> <span class="s">&quot;$type&quot;</span><span class="p">,</span>
        <span class="n">size</span>  <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">query</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="n">match_all</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="p">}</span>
        <span class="p">},</span>
        <span class="n">facets</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&quot;chart&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">facet_filter</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="ow">and</span> <span class="o">=&gt;</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="n">term</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                <span class="n">status</span> <span class="o">=&gt;</span> <span class="nv">$status</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="nv">$api</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">},</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="n">date_histogram</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">value_field</span> <span class="o">=&gt;</span> <span class="nv">$field</span><span class="p">,</span>
                    <span class="n">key_field</span> <span class="o">=&gt;</span> <span class="s">&#39;@timestamp&#39;</span><span class="p">,</span>
                    <span class="n">interval</span> <span class="o">=&gt;</span> <span class="s">&quot;1m&quot;</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">@result</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;facets&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;chart&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;entries&#39;</span><span class="p">}}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nb">push</span> <span class="nv">@result</span><span class="p">,</span> <span class="p">{</span>
           <span class="nb">time</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">},</span>
           <span class="n">count</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;count&#39;</span><span class="p">},</span>
           <span class="n">mean</span> <span class="o">=&gt;</span> <span class="nb">sprintf</span> <span class="s">&quot;%.3f&quot;</span><span class="p">,</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;mean&#39;</span><span class="p">}</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="n">header</span><span class="p">(</span><span class="s">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;application/json&#39;</span><span class="p">);</span>
    <span class="n">to_json</span><span class="p">(</span><span class="o">\</span><span class="nv">@result</span><span class="p">);</span>
<span class="p">};</span>
<span class="c1">#主函数</span>
<span class="nb">package</span> <span class="n">main</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Basename</span><span class="p">;</span>
<span class="c1">#通过Tatsumaki::Application绑定urlpath到不同的类上。注意下面listhandler那里用的正则捕获。对，上面类里传参就是这么来的。注意最多不超过$9。</span>
<span class="k">my</span> <span class="nv">$app</span> <span class="o">=</span> <span class="nn">Tatsumaki::</span><span class="n">Application</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">([</span>
    <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;MainHandler&#39;</span><span class="p">,</span>
    <span class="s">&#39;/api/chartdata&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;ChartHandler&#39;</span><span class="p">,</span>
    <span class="s">&#39;/api/(\w+)/(\w+)/(\w+)&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;ListHandler&#39;</span><span class="p">,</span>
<span class="p">]);</span>
<span class="c1">#指定template和static的路径。类似Dancer里的views和public</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="n">template_path</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s">&#39;/templates&#39;</span><span class="p">);</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="n">static_path</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s">&#39;/static&#39;</span><span class="p">);</span>
<span class="c1">#psgi app组建完成</span>
<span class="k">return</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="n">psgi_app</span><span class="p">;</span>
<span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>static里都是bootstrap的东西就不贴了。然后说说template。目前Tatsumaki只支持Text::MicroTemplate::File一种template，当然自己在handler里调用其他的template然后返回字符串也行。不过其实Text::MicroTemplate也蛮强大的。下面上例子：</p>
<div class="highlight"><pre><code class="html">%# 这就是Text::MicroTemplate强大的地方了，行首加个百分号就可以直接使用perl而不像TT那样尽量搞自己的语法
%# 配合render传来的handler(前面说了是类$self)，整个环境全可以任意调用。
% my $mapping = $_[0]-&gt;{&#39;mapping&#39;};
% my $table = $_[0]-&gt;{&#39;table&#39;};
%# 比如这里其实就是通过handler调用request了。
% my $group = $_[0]-&gt;{handler}-&gt;args-&gt;[0];
% my @codes = qw(200 206 302 304 400 403 404 499 502 503 504);
<span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span>
<span class="cp">        &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;title&gt;</span>Bubble -- a perl webui for logstash <span class="err">&amp;</span> elasticsearch<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/bootstrap/css/bootstrap.css&quot;</span> <span class="nt">&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/fontawesome/css/font-awesome.css&quot;</span> <span class="nt">&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/css/style.css&quot;</span> <span class="nt">&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/amcharts/style.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container-fluid&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row-fluid&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span3&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;well sidebar-nav&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav nav-list&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;nav-header&quot;</span><span class="nt">&gt;</span>查询<span class="nt">&lt;/li&gt;</span>
% for my $property ( @{ $mapping } ) {
%     if ( ref( $property ) eq &#39;ARRAY&#39; ) {
          <span class="nt">&lt;li&gt;</span>@fields<span class="nt">&lt;/li&gt;</span>
%          for ( @{$property} ) {
          <span class="nt">&lt;li&gt;</span>  - <span class="err">&lt;</span>%= $_-&gt;{&#39;name&#39;} %&gt; <span class="err">&lt;</span>%= $_-&gt;{&#39;type&#39;} %&gt;<span class="nt">&lt;/li&gt;</span>
%          }
%     } elsif ( $property-&gt;{&#39;type&#39;} ) {
          <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= $property-&gt;{&#39;name&#39;} %&gt; <span class="err">&lt;</span>%= $property-&gt;{&#39;type&#39;} %&gt;<span class="nt">&lt;/li&gt;</span>
%     }
% }
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span9&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;search&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;control-group&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;controls docs-input-sizes&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-small inline&quot;</span> <span class="na">id=</span><span class="s">&quot;esapi&quot;</span> <span class="na">name=</span><span class="s">&quot;api&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;option&gt;</span>匹配方式<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;option&gt;</span>prefix<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;option&gt;</span>term<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;option&gt;</span>text<span class="nt">&lt;/option&gt;</span>
            <span class="nt">&lt;/select&gt;</span>
            <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-small inline&quot;</span> <span class="na">id=</span><span class="s">&quot;eskey&quot;</span> <span class="na">name=</span><span class="s">&quot;key&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;option&gt;</span>查询列<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;option&gt;</span>oh<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;option&gt;</span>url<span class="nt">&lt;/option&gt;</span>
            <span class="nt">&lt;/select&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-big inline&quot;</span> <span class="na">id=</span><span class="s">&quot;esvalue&quot;</span> <span class="na">name=</span><span class="s">&quot;value&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;查询文本&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-small inline&quot;</span> <span class="na">id=</span><span class="s">&quot;esstatus&quot;</span> <span class="na">name=</span><span class="s">&quot;status&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;指定状态&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary&quot;</span> <span class="na">onclick=</span><span class="s">&quot;genchart()&quot;</span><span class="nt">&gt;</span>查看<span class="nt">&lt;/button&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chartdiv&quot;</span> <span class="na">style=</span><span class="s">&quot;display:none; width: 100%; height: 500px;&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;estable&quot;</span><span class="nt">&gt;</span>
% if ( $table ) {
        <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;table table-striped table-bordered table-condensed&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;thead&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
              <span class="nt">&lt;th&gt;</span><span class="err">&lt;</span>%= $group %&gt;<span class="nt">&lt;/th&gt;</span>
              <span class="nt">&lt;th&gt;</span>平均响应时间<span class="nt">&lt;/th&gt;</span>
              <span class="nt">&lt;th&gt;</span>最大响应时间<span class="nt">&lt;/th&gt;</span>
              <span class="nt">&lt;th&gt;</span>下载数<span class="nt">&lt;/th&gt;</span>
%     for ( @codes ) {
              <span class="nt">&lt;th&gt;</span><span class="err">&lt;</span>%= $_ %&gt;<span class="nt">&lt;/th&gt;</span>
%     }
            <span class="nt">&lt;/tr&gt;</span>
          <span class="nt">&lt;/thead&gt;</span>
          <span class="nt">&lt;tbody&gt;</span>
%     for my $list ( @{ $table } ) {
            <span class="nt">&lt;tr&gt;</span>
              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;key&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>
              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;mean&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>
              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;max&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>
              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;count&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>
%         for ( @codes ) {
%             if ( $list-&gt;{&#39;code&#39;}-&gt;{$_} ) {
              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;code&#39;}-&gt;{$_} %&gt;<span class="nt">&lt;/td&gt;</span>
%             } else {
              <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
%             }
%         }
            <span class="nt">&lt;/tr&gt;</span>
%     }
          <span class="nt">&lt;/tbody&gt;</span>
        <span class="nt">&lt;/table&gt;</span>
% }
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/javascripts/jquery-1.7.2.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/bootstrap/js/bootstrap.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/amcharts/amstock.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
  <span class="kd">var</span> <span class="nx">chart</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">chartProvider</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">function</span> <span class="nx">createStockChart</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmStockChart</span><span class="p">();</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">pathToImages</span> <span class="o">=</span> <span class="s2">&quot;/static/amcharts/images/&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">categoryAxesSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">CategoryAxesSettings</span><span class="p">();</span>
    <span class="nx">categoryAxesSettings</span><span class="p">.</span><span class="nx">parseDates</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">categoryAxesSettings</span><span class="p">.</span><span class="nx">minPeriod</span> <span class="o">=</span> <span class="s2">&quot;mm&quot;</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">categoryAxesSettings</span> <span class="o">=</span> <span class="nx">categoryAxesSettings</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">dataSet</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">DataSet</span><span class="p">();</span>
    <span class="nx">dataSet</span><span class="p">.</span><span class="nx">fieldMappings</span> <span class="o">=</span> <span class="p">[{</span>
      <span class="nx">fromField</span> <span class="o">:</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
      <span class="nx">toField</span> <span class="o">:</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="nx">fromField</span> <span class="o">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
      <span class="nx">toField</span> <span class="o">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="p">}];</span>
    <span class="nx">dataSet</span><span class="p">.</span><span class="nx">dataProvider</span> <span class="o">=</span> <span class="nx">chartProvider</span><span class="p">;</span>
    <span class="nx">dataSet</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">=</span> <span class="s2">&quot;date&quot;</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">dataSets</span> <span class="o">=</span> <span class="p">[</span><span class="nx">dataSet</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">stockPanel1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockPanel</span><span class="p">();</span>
    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">percentHeight</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">valueAxis1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>
    <span class="nx">valueAxis1</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">;</span>
    <span class="nx">valueAxis1</span><span class="p">.</span><span class="nx">axisColor</span> <span class="o">=</span> <span class="s2">&quot;#999999&quot;</span><span class="p">;</span>
    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis1</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">graph1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockGraph</span><span class="p">();</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">valueField</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">;</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;mean(ms)&quot;</span><span class="p">;</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;smoothedLine&quot;</span><span class="p">;</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">lineColor</span> <span class="o">=</span> <span class="s2">&quot;#999999&quot;</span><span class="p">;</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">useDataSetColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addStockGraph</span><span class="p">(</span><span class="nx">graph1</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">stockLegend1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockLegend</span><span class="p">();</span>
    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">stockLegend</span> <span class="o">=</span> <span class="nx">stockLegend1</span><span class="p">;</span>
    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">drawingIconsEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">stockPanel2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockPanel</span><span class="p">();</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">percentHeight</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">marginTop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">showCategoryAxis</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">valueAxis2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>
    <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">gridAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">axisThickness</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis2</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">graph2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockGraph</span><span class="p">();</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">valueAxis</span> <span class="o">=</span> <span class="nx">valueAxis2</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">valueField</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">balloonText</span> <span class="o">=</span> <span class="s2">&quot;[[value]]%&quot;</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;column&quot;</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">cornerRadiusTop</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">lineColor</span> <span class="o">=</span> <span class="s2">&quot;#FCD202&quot;</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">useDataSetColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">addStockGraph</span><span class="p">(</span><span class="nx">graph2</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">stockLegend2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockLegend</span><span class="p">();</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">stockLegend</span> <span class="o">=</span> <span class="nx">stockLegend2</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">panels</span> <span class="o">=</span> <span class="p">[</span><span class="nx">stockPanel1</span><span class="p">,</span> <span class="nx">stockPanel2</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">sbsettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartScrollbarSettings</span><span class="p">();</span>
    <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="nx">graph2</span><span class="p">;</span>
    <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">graphType</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span><span class="p">;</span>
    <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">chartScrollbarSettings</span> <span class="o">=</span> <span class="nx">sbsettings</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cursorSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartCursorSettings</span><span class="p">();</span>
    <span class="nx">cursorSettings</span><span class="p">.</span><span class="nx">valueBalloonsEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">chartCursorSettings</span> <span class="o">=</span> <span class="nx">cursorSettings</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#chartdiv&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;chartdiv&quot;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">genchart</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;/api/chartdata&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">api</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#esapi&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="nx">key</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#eskey&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="nx">status</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#esstatus&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="nx">value</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#esvalue&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">time</span><span class="p">);</span>
        <span class="nx">chartProvider</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
          <span class="nx">date</span><span class="o">:</span> <span class="nx">date</span><span class="p">,</span>
          <span class="nx">count</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">count</span><span class="p">,</span>
          <span class="nx">mean</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">mean</span><span class="p">,</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="nx">createStockChart</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">};</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>效果如下：</p>
<p><img src="/images/uploads/tatsumaki.png" alt="查询表格并提交最多次的url绘图" title="查询表格并提交最多次的url绘图" /></p>
<hr />
<p><strong>2012 年 12 月 30 日附注：</strong></p>
<p>更好的纯 js 版本已经作为独立的 elasticsearch-plugin 项目发布在 github 上。地址：<a href="https://github.com/chenryn/elasticsearch-logstash-faceter">https://github.com/chenryn/elasticsearch-logstash-faceter</a> 。欢迎大家试用!!</p>
      <a href="/2012/11/22/tatsumaki-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/11/22/gnuplot-to-draw-multi-graph" title="用gnuplot绘制多图" rel="bookmark">用gnuplot绘制多图</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-11-22 00:00:00 +0800">22 Nov 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>以前已经提过多次gnuplot的简便快捷了。不过大多是最基本的单图上画条线之类的。这次碰到需求，稍微help了一下在一个图上画多个区域。主要需要注意的就是set size的定位点到底从什么角度算，说实话蛮麻烦的。</p>
<p>上文件：</p>
<div class="highlight"><pre><code class="bash">    <span class="nv">result</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">begin</span><span class="o">=</span><span class="sb">`</span>head -n 1 <span class="nv">$result</span>.txt | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
    <span class="nv">end</span><span class="o">=</span><span class="sb">`</span>tail -n 1 <span class="nv">$result</span>.txt | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
    cat &gt; conf/<span class="nv">$result</span>.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">    set terminal png</span>
<span class="s">    set output &quot;png/$result.png&quot;</span>
<span class="s">    set multiplot</span>
<span class="s">    set xdata time</span>
<span class="s">    set timefmt &quot;%H:%M:%S&quot;</span>
<span class="s">    set format x &quot;%M:%S&quot;</span>
<span class="s">    set size 1.0,0.5</span>
<span class="s">    set origin 0.0,0.5</span>
<span class="s">    set ylabel &quot;KRps&quot;</span>
<span class="s">    unset xtics</span>
<span class="s">    plot &quot;res/$result.txt&quot; using 1:(\$2/1000) with points linewidth 2 title &quot;&quot;</span>
<span class="s">    set origin 0.0,0.0</span>
<span class="s">    set size 1.0,0.35</span>
<span class="s">    set xtics</span>
<span class="s">    set xrange [&quot;$begin&quot;:&quot;$end&quot;]</span>
<span class="s">    set ylabel &quot;%usr:sys:irq&quot;</span>
<span class="s">    plot &quot;res/$result.csv&quot; using 2:(\$3+\$4+\$8) with boxes fs solid 1.0 title &quot;&quot;, \</span>
<span class="s">         &quot;res/$result.csv&quot; using 2:(\$3+\$4) with boxes fs solid 1.0 title &quot;&quot;, \</span>
<span class="s">         &quot;res/$result.csv&quot; using 2:3 with boxes fs solid 1.0 title &quot;&quot;</span>
<span class="s">    set origin 0.0,0.3</span>
<span class="s">    set size 1.0,0.25</span>
<span class="s">    unset xtics</span>
<span class="s">    set ylabel &quot;MBps&quot;</span>
<span class="s">    plot &quot;res/$result.csv&quot; using 2:(\$11/1024/1024) with boxes fs solid 0.7 linecolor rgb &quot;green&quot; title &quot;&quot;, \</span>
<span class="s">         &quot;res/$result.csv&quot; using 2:(\$12/1024/1024) with lines linewidth 2 linecolor rgb &quot;blue&quot; title &quot;&quot;</span>
<span class="s">    EOF</span>
    cat conf/<span class="nv">$result</span>.conf | gnuplot
</code></pre></div>
<p>注意：新增了一行xrange配置，如果不指定这个几张小图的xtics会不统一，而上面两张图的xtics又已经被unset了，结果看起来就跟不同步似的。</p>
<p>效果如下：
<img src="/images/uploads/gnuplot-multi.png" alt="图片" /></p>
      <a href="/2012/11/22/gnuplot-to-draw-multi-graph" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/11/19/syslog-realtime-warning-to-speech" title="syslog实时报警"说出来"" rel="bookmark">syslog实时报警"说出来"</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-11-19 00:00:00 +0800">19 Nov 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>syslog应该是大家最常用的，也基本可以说是最重要的服务器监控信息来源了。</p>
<p>syslog的传输，应该不用再说，哪怕在百度里搜都有足够多的靠谱结果。而关于报警的问题，之前我也写了好几篇，比如<a href="/2012/10/17/juggernaut-for-syslog-check">《用Juggernaut实时推送syslog分析结果》</a>讲了如何用websocket推送结果，<a href="/2012/11/09/chrome-app-demo">《Chrome的APP简单用法》</a>讲了如何利用chrome后台页面开机自动运行进行桌面提示。</p>
<p>那么，如果我既不想开网页看，也不好安装chrome浏览器，有没有够简便的办法接收呢？有！Linux社区从来不缺乏各种神奇工具。下面介绍两个同样强大的提示办法。</p>
<p>第一个，非chrome型的桌面通知notify-send命令，依发行版不同，可能属于libnotify-tools或者libnotify-bin包，自己搜索即可；</p>
<p>第二个，Espeak命令，著名Text To Speech软件，虽然电子音怪了点，但是支持中文而且文件很小，同样直接在源里安装即可。</p>
<p>下面就是如何把这两个强大的工具和server结合起来的问题了，出动胶水语言代表perl。代码如下：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Mojo::</span><span class="n">UserAgent</span><span class="p">;</span>
<span class="k">use</span> <span class="n">JSON</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$ua</span> <span class="o">=</span> <span class="nn">Mojo::</span><span class="n">UserAgent</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
<span class="k">my</span> <span class="p">(</span> <span class="nv">$sid</span><span class="p">,</span> <span class="nv">$ws</span> <span class="p">);</span>
<span class="c1"># 本来用Protocol::WebSocket::Handshake::Client模块，指定IP和端口，自动会获取sid拼ws地址的，不过测试发现open后没反应。奇怪</span>
<span class="n">LABEL:</span>
<span class="nv">$sid</span> <span class="o">=</span> <span class="p">(</span><span class="o">+</span><span class="nb">split</span><span class="p">(</span><span class="sr">/:/</span><span class="p">,</span> <span class="nv">$ua</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;http://syslog.domain.com:8080/socket.io/1/&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span>
<span class="nv">$ws</span> <span class="o">=</span> <span class="s">&quot;ws://syslog.domain.com:8080/socket.io/1/websocket/${sid}&quot;</span><span class="p">;</span>
<span class="nv">$ua</span><span class="o">-&gt;</span><span class="n">websocket</span><span class="p">(</span> <span class="nv">$ws</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$ua</span><span class="p">,</span> <span class="nv">$tx</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="nv">$tx</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&#39;3:::{&quot;type&quot;:&quot;subscribe&quot;,&quot;channel&quot;:&quot;syslog&quot;}&#39;</span><span class="p">);</span>
    <span class="nv">$tx</span><span class="o">-&gt;</span><span class="n">on</span><span class="p">(</span><span class="n">finish</span>  <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="c1"># 很怪的是，mojo::useragent的websocket client总是在不到一分钟内就进入on_finish状态，所以这里只好返回重连</span>
        <span class="nn">Mojo::</span><span class="n">IOLoop</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span>
        <span class="nb">goto</span> <span class="n">LABEL</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nv">$tx</span><span class="o">-&gt;</span><span class="n">on</span><span class="p">(</span><span class="n">message</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$tx</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">length</span><span class="p">(</span> <span class="nv">$msg</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$syslog</span> <span class="o">=</span> <span class="n">from_json</span><span class="p">(</span> <span class="nb">substr</span><span class="p">(</span> <span class="nv">$msg</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">);</span>
            <span class="n">notify</span><span class="p">(</span> <span class="nv">$syslog</span> <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">});</span>
<span class="p">});</span>
<span class="nn">Mojo::</span><span class="n">IOLoop</span><span class="o">-&gt;</span><span class="n">start</span> <span class="k">unless</span> <span class="nn">Mojo::</span><span class="n">IOLoop</span><span class="o">-&gt;</span><span class="n">is_running</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">notify</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">eq</span> <span class="s">&#39;btn&#39;</span><span class="p">;</span>
    <span class="nb">exec</span><span class="p">(</span><span class="s">&quot;notify-send \&quot;$data-&gt;[0] $data-&gt;[1]\&quot; \&quot;$data-&gt;[3] $data-&gt;[4]\&quot;&quot;</span><span class="p">);</span>
    <span class="c1"># 注意设定-s 120，默认是175，念得飞快</span>
    <span class="nb">exec</span><span class="p">(</span><span class="s">&quot;espeak -vzh+f2 -s 120 \&quot;$data-&gt;[1]\&quot;&quot;</span><span class="p">);</span> <span class="c1"># 指定中文报ip，不然很难听懂</span>
    <span class="c1"># f是女生，m是男声，至于第几个声音，我没听出来多大差别，都跟九十年代初电影里的机器人一样</span>
    <span class="nb">exec</span><span class="p">(</span><span class="s">&quot;espeak -ven+m2 -s 120 \&quot;$data-&gt;[3] $data-&gt;[4]\&quot;&quot;</span><span class="p">);</span> <span class="c1"># 指定英文报内容，不然用中文的声音念更难听懂</span>
<span class="p">};</span>
</code></pre></div>
<p>以上抛砖引玉，大家可以试试Ekho(余音)，这是国人开发的真人语音TTS开源软件，还支持粤语，文言文等选择，汗……</p>
      <a href="/2012/11/19/syslog-realtime-warning-to-speech" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/11/18/data-visualization-with-elasticsearch-and-protovis" title="【翻译】用ElasticSearch和Protovis实现数据可视化" rel="bookmark">【翻译】用ElasticSearch和Protovis实现数据可视化</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-11-18 00:00:00 +0800">18 Nov 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>搜索引擎最重要的目的，嗯，不出意料就是<code>搜索</code>。你传给它一个请求，然后它依照相关性返回你一串匹配的结果。我们可以根据自己的内容创造各种请求结构，试验各种不同的分析器，搜索引擎都会努力尝试提供最好的结果。</p>
<p>不过，一个现代的全文搜索引擎可以做的比这个更多。因为它的核心是基于一个为了高效查询匹配文档而高度优化过的数据结构——<a href="http://en.wikipedia.org/wiki/Index_\(search_engine\)#Inverted_indices">倒排索引</a>。它也可以为我们的数据完成复杂的<code>聚合</code>运算，在这里我们叫它facets。(不好翻译，后文对这个单词都保留英文)</p>
<p>facets通常的目的是提供给用户某个方面的导航或者搜索。 当你在网上商店搜索“相机”，你可以选择不同的制造商，价格范围或者特定功能来定制条件，这应该就是点一下链接的事情，而不是通过修改一长串查询语法。</p>
<p>一个<a href="http://blog.linkedin.com/2009/12/14/linkedin-faceted-search/">LinkedIn的导航</a>范例如下图所示：</p>
<p><img src="http://www.elasticsearch.cn/blog/images/dashboards/linkedin-faceted-search.png" alt="图片1" /></p>
<p>Facet搜索为数不多的几个可以把强大的请求能力开放给最终用户的办法之一，详见Moritz Stefaner的试验<a href="http://well-formed-data.net/archives/54/elastic-lists">“Elastic Lists”</a>，或许你会有更多灵感。</p>
<p>但是，除了链接和复选框，其实我们还能做的更多。比如利用这些数据画图，而这就是我们在这篇文章中要讲的。</p>
<h1 id="section">实时仪表板</h1>
<p>在几乎所有的分析、监控和数据挖掘服务中，或早或晚的你都会碰到这样的需求：“我们要一个仪表板！”。因为大家都爱仪表板，可能因为真的有用，可能单纯因为它漂亮~这时候，我们不用写任何<a href="http://en.wikipedia.org/wiki/Online_analytical_processing">OLAP</a>实现，用facets就可以完成一个很漂亮很给力的分析引擎。</p>
<p>下面的截图就是从一个<a href="http://ataxosocialinsider.cz/">社交媒体监控应用</a>上获取的。这个应用不单用ES来搜索和挖掘数据，还通过交互式仪表板提供数据聚合功能。</p>
<p><img src="http://www.elasticsearch.cn/blog/images/dashboards/dashboard.png" alt="图片2" /></p>
<p>当用户深入数据，添加一个关键字，使用一个自定义查询，所有的图都会实时更新，这就是facet聚合的工作方式。仪表板上不是数据定期计算好的的静态快照，而是一个用于数据探索的真正的交互式工具。</p>
<p>在本文中，我们将会学习到怎样从ES中获取数据，然后怎么创建这些图表。</p>
<h1 id="terms-facet">关系聚合(terms facet)的饼图</h1>
<p>第一个图，我们用ES中比较简单的<a href="http://elasticsearch.org/guide/reference/api/search/facets/terms-facet.html">terms</a>facet来做。这个facet会返回一个字段中最常见的词汇和它的计数值。</p>
<p>首先我们先插入一些数据。</p>
<div class="highlight"><pre><code class="bash">curl -X DELETE <span class="s2">&quot;http://localhost:9200/dashboard&quot;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;</span>
<span class="s1">             { &quot;title&quot; : &quot;One&quot;,</span>
<span class="s1">               &quot;tags&quot;  : [&quot;ruby&quot;, &quot;java&quot;, &quot;search&quot;]}</span>
<span class="s1">&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;</span>
<span class="s1">             { &quot;title&quot; : &quot;Two&quot;,</span>
<span class="s1">               &quot;tags&quot;  : [&quot;java&quot;, &quot;search&quot;] }</span>
<span class="s1">&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;</span>
<span class="s1">             { &quot;title&quot; : &quot;Three&quot;,</span>
<span class="s1">               &quot;tags&quot;  : [&quot;erlang&quot;, &quot;search&quot;] }</span>
<span class="s1">&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;</span>
<span class="s1">             { &quot;title&quot; : &quot;Four&quot;,</span>
<span class="s1">               &quot;tags&quot;  : [&quot;search&quot;] }</span>
<span class="s1">&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/_refresh&quot;</span>
</code></pre></div>
<p>你们都看到了，我们存储了一些文章的标签，每个文章可以多个标签，数据以JSON格式发送，这也是ES的文档格式。</p>
<p>现在，要知道文档的十大标签，我们只需要简单的请求：</p>
<div class="highlight"><pre><code class="bash">curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/_search?pretty=true&quot;</span> -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;query&quot; : { &quot;match_all&quot; : {} },</span>
<span class="s1">    &quot;facets&quot; : {</span>
<span class="s1">        &quot;tags&quot; : { &quot;terms&quot; : {&quot;field&quot; : &quot;tags&quot;, &quot;size&quot; : 10} }</span>
<span class="s1">    }</span>
<span class="s1">}</span>
<span class="s1">&#39;</span>
</code></pre></div>
<p>你看到了，我接受所有文档，然后定义一个terms facet叫做“tags”。这个请求会返回如下样子的数据：</p>
<div class="highlight"><pre><code class="javascript"><span class="p">{</span>
    <span class="s2">&quot;took&quot;</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="c1">// ... snip ...</span>
    <span class="s2">&quot;hits&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;total&quot;</span> <span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="c1">// ... snip ...</span>
    <span class="p">},</span>
    <span class="s2">&quot;facets&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;_type&quot;</span> <span class="o">:</span> <span class="s2">&quot;terms&quot;</span><span class="p">,</span>
            <span class="s2">&quot;missing&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;terms&quot;</span> <span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="s2">&quot;term&quot;</span> <span class="o">:</span> <span class="s2">&quot;search&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span> <span class="o">:</span> <span class="mi">4</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;term&quot;</span> <span class="o">:</span> <span class="s2">&quot;java&quot;</span><span class="p">,</span>   <span class="s2">&quot;count&quot;</span> <span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;term&quot;</span> <span class="o">:</span> <span class="s2">&quot;ruby&quot;</span><span class="p">,</span>   <span class="s2">&quot;count&quot;</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;term&quot;</span> <span class="o">:</span> <span class="s2">&quot;erlang&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>JSON中<code>facets</code>部分是我们关心的，特别是<code>facets.tags.terms</code>数组。它告诉我们有四篇文章打了search标签，两篇java标签，等等…….(当然，我们或许应该给请求添加一个<code>size</code>参数跳过前面的结果)</p>
<p>这种比例类型的数据最合适的可视化方案就是饼图，或者它的变体：油炸圈饼图。最终结果如下(你可能希望看这个<a href="http://www.elasticsearch.cn/blog/assets/dashboards/donut.html">可运行的实例</a>)：</p>
<p><img src="http://www.elasticsearch.cn/blog/images/dashboards/donut_chart.png" alt="图片3" /></p>
<p>我们将使用<a href="http://vis.stanford.edu/protovis/">Protovis</a>一个JavaScript的数据可视化工具集。Protovis是100%开源的，你可以想象它是数据可视化方面的RoR。和其他类似工具形成鲜明对比的是，它没有附带一组图标类型来供你“选择”。而是定义了一组原语和一个灵活的DSL，这样你可以非常简单的创建自定义的可视化。创建<a href="http://vis.stanford.edu/protovis/ex/pie.html">饼图</a>就非常简单。</p>
<p>因为ES返回的是JSON数据，我们可以通过Ajax调用加载它。不要忘记你可以clone或者下载实例的<a href="https://gist.github.com/966338">全部源代码</a>。</p>
<p>首先需要一个HTML文件来容纳图标然后从ES里加载数据：</p>
<div class="highlight"><pre><code class="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>ElasticSearch Terms Facet Donut Chart<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- Load JS libraries --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;jquery-1.5.1.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;protovis-r3.2.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;donut.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script&gt;</span>
        <span class="nx">$</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">load_data</span><span class="p">();</span> <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">load_data</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>   <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://localhost:9200/dashboard/article/_search?pretty=true&#39;</span>
                     <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span>
                     <span class="p">,</span> <span class="nx">data</span> <span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
                           <span class="s2">&quot;query&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;match_all&quot;</span> <span class="o">:</span> <span class="p">{}</span> <span class="p">},</span>
                           <span class="s2">&quot;facets&quot;</span> <span class="o">:</span> <span class="p">{</span>
                               <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">{</span>
                                   <span class="s2">&quot;terms&quot;</span> <span class="o">:</span> <span class="p">{</span>
                                       <span class="s2">&quot;field&quot;</span> <span class="o">:</span> <span class="s2">&quot;tags&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;size&quot;</span>  <span class="o">:</span> <span class="s2">&quot;10&quot;</span>
                                   <span class="p">}</span>
                               <span class="p">}</span>
                           <span class="p">}</span>
                       <span class="p">})</span>
                     <span class="p">,</span> <span class="nx">dataType</span> <span class="o">:</span> <span class="s1">&#39;json&#39;</span>
                     <span class="p">,</span> <span class="nx">processData</span><span class="o">:</span> <span class="kc">false</span>
                     <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="nx">statusText</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
                           <span class="k">return</span> <span class="nx">display_chart</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
                       <span class="p">}</span>
                     <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                           <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Error while loading data from ElasticSearch&quot;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
                           <span class="k">throw</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
                       <span class="p">}</span>
            <span class="p">});</span>
            <span class="kd">var</span> <span class="nx">display_chart</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">Donut</span><span class="p">().</span><span class="nx">data</span><span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">facets</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">terms</span><span class="p">).</span><span class="nx">draw</span><span class="p">();</span>
            <span class="p">};</span>
        <span class="p">};</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="c">&lt;!-- Placeholder for the chart --&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chart&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>文档加载后，我们通过Ajax收到和之前<code>curl</code>测试中一样的facet。在jQuery的Ajaxcallback里我们通过封装的<code>display_chart()</code>把返回的JSON传给<code>Donut()</code>函数.</p>
<p><code>Donut()</code>函数及注释如下： </p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// =====================================================================================================</span>
<span class="c1">// A donut chart with Protovis - See http://vis.stanford.edu/protovis/ex/pie.html</span>
<span class="c1">// =====================================================================================================</span>
<span class="kd">var</span> <span class="nx">Donut</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dom_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">dom_id</span><span class="p">)</span>  <span class="p">{</span>                <span class="c1">// Set the default DOM element ID to bind</span>
        <span class="nx">dom_id</span> <span class="o">=</span> <span class="s1">&#39;chart&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>                         <span class="c1">// Set the data for the chart</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">json</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">entries</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// Sort the data by term names, so the</span>
            <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">term</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">term</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>            <span class="c1">// color scheme for wedges is preserved</span>
        <span class="p">}),</span>                                             <span class="c1">// with any order</span>
        <span class="nx">values</span>  <span class="o">=</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">entries</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>         <span class="c1">// Create an array holding just the counts</span>
            <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
        <span class="p">});</span>
        <span class="c1">// console.log(&#39;Drawing&#39;, entries, values);</span>
        <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>                                    <span class="c1">// Dimensions and color scheme for the chart</span>
            <span class="nx">h</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
            <span class="nx">colors</span> <span class="o">=</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">Colors</span><span class="p">.</span><span class="nx">category10</span><span class="p">().</span><span class="nx">range</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">vis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">Panel</span><span class="p">()</span>                        <span class="c1">// Create the basis panel</span>
            <span class="p">.</span><span class="nx">width</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">margin</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nx">vis</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Wedge</span><span class="p">)</span>                               <span class="c1">// Create the &quot;wedges&quot; of the chart</span>
            <span class="p">.</span><span class="nx">def</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>                          <span class="c1">// Auxiliary variable to hold mouse over state</span>
            <span class="p">.</span><span class="nx">data</span><span class="p">(</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">)</span>               <span class="c1">// Pass the normalized data to Protovis</span>
            <span class="p">.</span><span class="nx">left</span><span class="p">(</span><span class="nx">w</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>                                  <span class="c1">// Set-up chart position and dimension</span>
            <span class="p">.</span><span class="nx">top</span><span class="p">(</span><span class="nx">w</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">outerRadius</span><span class="p">(</span><span class="nx">w</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">innerRadius</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>                            <span class="c1">// Create a &quot;donut hole&quot; in the center</span>
            <span class="p">.</span><span class="nx">angle</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>                       <span class="c1">// Compute the &quot;width&quot; of the wedge</span>
                <span class="k">return</span> <span class="nx">d</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">;</span>
             <span class="p">})</span>
            <span class="p">.</span><span class="nx">strokeStyle</span><span class="p">(</span><span class="s2">&quot;#fff&quot;</span><span class="p">)</span>                        <span class="c1">// Add white stroke</span>
            <span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s2">&quot;mouseover&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>            <span class="c1">// On &quot;mouse over&quot;, set the &quot;wedge&quot; as active</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">active</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">cursor</span><span class="p">(</span><span class="s1">&#39;pointer&#39;</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
             <span class="p">})</span>
            <span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span>  <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>            <span class="c1">// On &quot;mouse out&quot;, clear the active state</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">active</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s2">&quot;mousedown&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>           <span class="c1">// On &quot;mouse down&quot;, perform action,</span>
                <span class="kd">var</span> <span class="nx">term</span> <span class="o">=</span> <span class="nx">entries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">term</span><span class="p">;</span>    <span class="c1">// such as filtering the results...</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Filter the results by &#39;&quot;</span><span class="o">+</span><span class="nx">term</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="p">));</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Dot</span><span class="p">)</span>                <span class="c1">// Add the left part of he &quot;inline&quot; label,</span>
                                                        <span class="c1">// displayed inside the donut &quot;hole&quot;</span>
            <span class="p">.</span><span class="nx">visible</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>                      <span class="c1">// The label is visible when its wedge is active</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                       <span class="p">.</span><span class="nx">active</span><span class="p">()</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">fillStyle</span><span class="p">(</span><span class="s2">&quot;#222&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">lineWidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">radius</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;center&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Bar</span><span class="p">)</span>               <span class="c1">// Add the middle part of the label</span>
            <span class="p">.</span><span class="nx">fillStyle</span><span class="p">(</span><span class="s2">&quot;#222&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">width</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>                        <span class="c1">// Compute width:</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">d</span><span class="o">*</span><span class="mi">100</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>               <span class="c1">// add pixels for percents</span>
                              <span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span>
                       <span class="mi">10</span> <span class="o">+</span>                             <span class="c1">// add pixels for glyphs (%, etc)</span>
                       <span class="nx">entries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">]</span>              <span class="c1">// add pixels for letters (very rough)</span>
                           <span class="p">.</span><span class="nx">term</span><span class="p">.</span><span class="nx">length</span><span class="o">*</span><span class="mi">9</span><span class="p">;</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">top</span><span class="p">((</span><span class="nx">w</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mi">14</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Dot</span><span class="p">)</span>                <span class="c1">// Add the right part of the label</span>
            <span class="p">.</span><span class="nx">fillStyle</span><span class="p">(</span><span class="s2">&quot;#222&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">lineWidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">radius</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>          <span class="c1">// Add the text to label</span>
                   <span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Label</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">left</span><span class="p">((</span><span class="nx">w</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mi">7</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>                         <span class="c1">// Combine the text for label</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">d</span><span class="o">*</span><span class="mi">100</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;%&quot;</span> <span class="o">+</span>
                       <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">entries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">term</span> <span class="o">+</span>
                       <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="nx">values</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">textStyle</span><span class="p">(</span><span class="s2">&quot;#fff&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">canvas</span><span class="p">(</span><span class="nx">dom_id</span><span class="p">)</span>                        <span class="c1">// Bind the chart to DOM element</span>
            <span class="p">.</span><span class="nx">render</span><span class="p">();</span>                                  <span class="c1">// And render it.</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="p">{</span>                                            <span class="c1">// Create the public API</span>
        <span class="nx">data</span>   <span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
        <span class="nx">draw</span>   <span class="o">:</span> <span class="nx">draw</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>现在你们看到了，一个简单的JSON数据转换，我们就可以创建出丰富的有吸引力的关于我们文章标签分布的可视化图标。完整的例子在<a href="http://www.elasticsearch.cn/blog/assets/dashboards/donut.html">这里</a>。</p>
<p>当你使用完全不同的请求，比如显示某个特定作者的文章，或者特定日期内发表的文章，整个可视化都照样正常工作，代码是可以重用的。</p>
<h1 id="date-histogram-facets">日期直方图(date histogram facets)时间线</h1>
<p>Protovis让创建另一种常见的可视化类型也非常容易：<a href="http://vis.stanford.edu/protovis/ex/zoom.html">时间线</a>。任何类型的数据，只要和特定日期相关的，比如文章发表，事件发生，目标达成，都可以被可视化成时间线。</p>
<p>最终结果就像下面这样(同样可以看<a href="http://www.elasticsearch.cn/blog/assets/dashboards/timeline.html">运行版</a>)：</p>
<p><img src="http://www.elasticsearch.cn/blog/images/dashboards/timeline_chart.png" alt="图片4" /></p>
<p>好了，让我们往索引里存一些带有发表日期的文章吧：</p>
<div class="highlight"><pre><code class="bash">curl -X DELETE <span class="s2">&quot;http://localhost:9200/dashboard&quot;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;1&quot;,  &quot;published&quot; : &quot;2011-01-01&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;2&quot;,  &quot;published&quot; : &quot;2011-01-02&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;3&quot;,  &quot;published&quot; : &quot;2011-01-02&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;4&quot;,  &quot;published&quot; : &quot;2011-01-03&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;5&quot;,  &quot;published&quot; : &quot;2011-01-04&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;6&quot;,  &quot;published&quot; : &quot;2011-01-04&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;7&quot;,  &quot;published&quot; : &quot;2011-01-04&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;8&quot;,  &quot;published&quot; : &quot;2011-01-04&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;9&quot;,  &quot;published&quot; : &quot;2011-01-10&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;10&quot;, &quot;published&quot; : &quot;2011-01-12&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;11&quot;, &quot;published&quot; : &quot;2011-01-13&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;12&quot;, &quot;published&quot; : &quot;2011-01-14&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;13&quot;, &quot;published&quot; : &quot;2011-01-14&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;14&quot;, &quot;published&quot; : &quot;2011-01-15&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;15&quot;, &quot;published&quot; : &quot;2011-01-20&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;16&quot;, &quot;published&quot; : &quot;2011-01-20&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;17&quot;, &quot;published&quot; : &quot;2011-01-21&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;18&quot;, &quot;published&quot; : &quot;2011-01-22&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;19&quot;, &quot;published&quot; : &quot;2011-01-23&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;20&quot;, &quot;published&quot; : &quot;2011-01-24&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/_refresh&quot;</span>
</code></pre></div>
<p>我们用ES的<a href="http://www.elasticsearch.org/guide/reference/api/search/facets/date-histogram-facet.html">date histogram facet</a>来获取文章发表的频率。</p>
<div class="highlight"><pre><code class="bash">curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/_search?pretty=true&quot;</span> -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;query&quot; : { &quot;match_all&quot; : {} },</span>
<span class="s1">    &quot;facets&quot; : {</span>
<span class="s1">        &quot;published_on&quot; : {</span>
<span class="s1">            &quot;date_histogram&quot; : {</span>
<span class="s1">                &quot;field&quot;    : &quot;published&quot;,</span>
<span class="s1">                &quot;interval&quot; : &quot;day&quot;</span>
<span class="s1">            }</span>
<span class="s1">        }</span>
<span class="s1">    }</span>
<span class="s1">}</span>
<span class="s1">&#39;</span>
</code></pre></div>
<p>注意我们是怎么设置间隔为天的。这个很容易就可以替换成周，月 ，或者年。</p>
<p>请求会返回像下面这样的JSON：</p>
<div class="highlight"><pre><code class="javascript"><span class="p">{</span>
    <span class="s2">&quot;took&quot;</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="c1">// ... snip ...</span>
    <span class="s2">&quot;hits&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;total&quot;</span> <span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="c1">// ... snip ...</span>
    <span class="p">},</span>
    <span class="s2">&quot;facets&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;published&quot;</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;_type&quot;</span> <span class="o">:</span> <span class="s2">&quot;histogram&quot;</span><span class="p">,</span>
            <span class="s2">&quot;entries&quot;</span> <span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="s2">&quot;time&quot;</span> <span class="o">:</span> <span class="mi">1293840000000</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;time&quot;</span> <span class="o">:</span> <span class="mi">1293926400000</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span> <span class="o">:</span> <span class="mi">2</span> <span class="p">}</span>
                <span class="c1">// ... snip ...</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>我们要注意的是<code>facets.published.entries</code>数组，和上面的例子一样。同样需要一个HTML页来容纳图标和加载数据。机制既然一样，代码就直接看<a href="https://gist.github.com/900542/#file_chart.html">这里</a>吧。</p>
<p>既然已经有了JSON数据，用protovis创建时间线就很简单了，用一个自定义的<a href="http://vis.stanford.edu/protovis/ex/area.html">area chart</a>即可。</p>
<p>完整带注释的<code>Timeline()</code>函数如下：</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// =====================================================================================================</span>
<span class="c1">// A timeline chart with Protovis - See http://vis.stanford.edu/protovis/ex/area.html</span>
<span class="c1">// =====================================================================================================</span>
<span class="kd">var</span> <span class="nx">Timeline</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dom_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">dom_id</span><span class="p">)</span> <span class="p">{</span>                 <span class="c1">// Set the default DOM element ID to bind</span>
        <span class="nx">dom_id</span> <span class="o">=</span> <span class="s1">&#39;chart&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>                         <span class="c1">// Set the data for the chart</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">json</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">entries</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>                        <span class="c1">// Set-up the data</span>
            <span class="nx">entries</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>                              <span class="c1">// Add the last &quot;blank&quot; entry for proper</span>
              <span class="nx">count</span> <span class="o">:</span> <span class="nx">entries</span><span class="p">[</span><span class="nx">entries</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">count</span>   <span class="c1">// timeline ending</span>
            <span class="p">});</span>
        <span class="c1">// console.log(&#39;Drawing, &#39;, entries);</span>
        <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span>                                    <span class="c1">// Set-up dimensions and scales for the chart</span>
            <span class="nx">h</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="nx">max</span> <span class="o">=</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">entries</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">;}),</span>
            <span class="nx">x</span> <span class="o">=</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">Scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">entries</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">w</span><span class="p">),</span>
            <span class="nx">y</span> <span class="o">=</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">Scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">max</span><span class="p">).</span><span class="nx">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">h</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">vis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">Panel</span><span class="p">()</span>                        <span class="c1">// Create the basis panel</span>
            <span class="p">.</span><span class="nx">width</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">bottom</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">left</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">right</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">top</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
         <span class="nx">vis</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Label</span><span class="p">)</span>                              <span class="c1">// Add the chart legend at top left</span>
            <span class="p">.</span><span class="nx">top</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                 <span class="kd">var</span> <span class="nx">first</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">time</span><span class="p">);</span>
                 <span class="kd">var</span> <span class="nx">last</span>  <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">entries</span><span class="p">[</span><span class="nx">entries</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">2</span><span class="p">].</span><span class="nx">time</span><span class="p">);</span>
                 <span class="k">return</span> <span class="s2">&quot;Articles published between &quot;</span> <span class="o">+</span>
                     <span class="p">[</span> <span class="nx">first</span><span class="p">.</span><span class="nx">getDate</span><span class="p">(),</span>
                       <span class="nx">first</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="nx">first</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span>
                     <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s2">&quot; and &quot;</span> <span class="o">+</span>
                     <span class="p">[</span> <span class="nx">last</span><span class="p">.</span><span class="nx">getDate</span><span class="p">(),</span>
                       <span class="nx">last</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="nx">last</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span>
                     <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">);</span>
             <span class="p">})</span>
            <span class="p">.</span><span class="nx">textStyle</span><span class="p">(</span><span class="s2">&quot;#B1B1B1&quot;</span><span class="p">)</span>
         <span class="nx">vis</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Rule</span><span class="p">)</span>                               <span class="c1">// Add the X-ticks</span>
            <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">entries</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">visible</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">time</span><span class="p">;})</span>
            <span class="p">.</span><span class="nx">left</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">bottom</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">strokeStyle</span><span class="p">(</span><span class="s2">&quot;#33A3E1&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Label</span><span class="p">)</span>              <span class="c1">// Add the tick label (DD/MM)</span>
            <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
                 <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">time</span><span class="p">);</span>
                 <span class="k">return</span> <span class="p">[</span>
                     <span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">(),</span>
                     <span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
                 <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
             <span class="p">})</span>
            <span class="p">.</span><span class="nx">textStyle</span><span class="p">(</span><span class="s2">&quot;#2C90C8&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">textMargin</span><span class="p">(</span><span class="s2">&quot;5&quot;</span><span class="p">)</span>
         <span class="nx">vis</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Rule</span><span class="p">)</span>                               <span class="c1">// Add the Y-ticks</span>
            <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">ticks</span><span class="p">(</span><span class="nx">max</span><span class="p">))</span>                         <span class="c1">// Compute tick levels based on the &quot;max&quot; value</span>
            <span class="p">.</span><span class="nx">bottom</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">strokeStyle</span><span class="p">(</span><span class="s2">&quot;#eee&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Label</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">tickFormat</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">textStyle</span><span class="p">(</span><span class="s2">&quot;#c0c0c0&quot;</span><span class="p">)</span>
        <span class="nx">vis</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Panel</span><span class="p">)</span>                               <span class="c1">// Add container panel for the chart</span>
           <span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Area</span><span class="p">)</span>                                <span class="c1">// Add the area segments for each entry</span>
           <span class="p">.</span><span class="nx">def</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>                           <span class="c1">// Auxiliary variable to hold mouse state</span>
           <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">entries</span><span class="p">)</span>                               <span class="c1">// Pass the data to Protovis</span>
           <span class="p">.</span><span class="nx">bottom</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">left</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">x</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">);})</span>   <span class="c1">// Compute x-axis based on scale</span>
           <span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">y</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">);})</span>    <span class="c1">// Compute y-axis based on scale</span>
           <span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="s1">&#39;cardinal&#39;</span><span class="p">)</span>                     <span class="c1">// Make the chart curve smooth</span>
           <span class="p">.</span><span class="nx">segmented</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>                             <span class="c1">// Divide into &quot;segments&quot; (for interactivity)</span>
           <span class="p">.</span><span class="nx">fillStyle</span><span class="p">(</span><span class="s2">&quot;#79D0F3&quot;</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s2">&quot;mouseover&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>             <span class="c1">// On &quot;mouse over&quot;, set segment as active</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">active</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span>
               <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
           <span class="p">})</span>
           <span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span>  <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>             <span class="c1">// On &quot;mouse out&quot;, clear the active state</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">active</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
               <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
           <span class="p">})</span>
           <span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s2">&quot;mousedown&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>            <span class="c1">// On &quot;mouse down&quot;, perform action,</span>
               <span class="kd">var</span> <span class="nx">time</span> <span class="o">=</span> <span class="nx">entries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">time</span><span class="p">;</span>     <span class="c1">// eg filtering the results...</span>
               <span class="k">return</span> <span class="p">(</span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Timestamp: &#39;&quot;</span><span class="o">+</span><span class="nx">time</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="p">));</span>
           <span class="p">})</span>
           <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Line</span><span class="p">)</span>                  <span class="c1">// Add thick stroke to the chart</span>
           <span class="p">.</span><span class="nx">lineWidth</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">strokeStyle</span><span class="p">(</span><span class="s1">&#39;#33A3E1&#39;</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Dot</span><span class="p">)</span>                   <span class="c1">// Add the circle &quot;label&quot; displaying</span>
                                                        <span class="c1">// the count for this day</span>
           <span class="p">.</span><span class="nx">visible</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>                       <span class="c1">// The label is only visible when</span>
               <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>           <span class="c1">// its segment is active</span>
                          <span class="p">.</span><span class="nx">active</span><span class="p">()</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
            <span class="p">})</span>
           <span class="p">.</span><span class="nx">left</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span> <span class="p">})</span>
           <span class="p">.</span><span class="nx">bottom</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">y</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">);</span> <span class="p">})</span>
           <span class="p">.</span><span class="nx">fillStyle</span><span class="p">(</span><span class="s2">&quot;#33A3E1&quot;</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">lineWidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">radius</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;center&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Label</span><span class="p">)</span>             <span class="c1">// Add text to the label</span>
           <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">;})</span>
           <span class="p">.</span><span class="nx">textStyle</span><span class="p">(</span><span class="s2">&quot;#E7EFF4&quot;</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">canvas</span><span class="p">(</span><span class="nx">dom_id</span><span class="p">)</span>                        <span class="c1">// Bind the chart to DOM element</span>
           <span class="p">.</span><span class="nx">render</span><span class="p">();</span>                                  <span class="c1">// And render it.</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="p">{</span>                                            <span class="c1">// Create the public API</span>
        <span class="nx">data</span>   <span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
        <span class="nx">draw</span>   <span class="o">:</span> <span class="nx">draw</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>完整示例代码在<a href="http://www.elasticsearch.cn/blog/assets/dashboards/timeline.html">这里</a>。不过先去下载protovis提供的关于<a href="http://vis.stanford.edu/protovis/docs/area.html">area</a>的原始文档，然后观察当你修改<code>interpolate('cardinal')</code>成<code>interpolate('step-after')</code>后发生了什么。对于多个facet，画叠加的区域图，添加交互性，然后完全定制可视化应该都不是什么问题了。</p>
<p>重要的是注意，这个图表完全是根据你传递给ES的请求做出的响应，使得你有可能做到简单立刻的完成某项指标的可视化需求。比如“显示这个作者在这个主题上最近三个月的出版频率”。只需要提交这样的请求就够了：</p>
<div class="highlight"><pre><code class="bash"> author:John AND topic:Search AND published:<span class="o">[</span>2011-03-01 TO 2011-05-31<span class="o">]</span>
</code></pre></div>
<h1 id="section-1">总结</h1>
<p>当你需要为复杂的自定义查询做一个丰富的交互式的数据可视化时，使用ES的facets应该是最容易的办法之一，你只需要传递ES的JSON响应给<a href="http://vis.stanford.edu/protovis/">Protovis</a>这样的工具就好了。</p>
<p>通过模仿本文中的方法和代码，你可以在几小时内给你的数据跑通一个示例。</p>
      <a href="/2012/11/18/data-visualization-with-elasticsearch-and-protovis" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/11/18/coro" title="【翻译】Coro模块文档" rel="bookmark">【翻译】Coro模块文档</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-11-18 00:00:00 +0800">18 Nov 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <h1 id="section">名称</h1>
<p>Coro —— perl唯一真正的线程</p>
<h1 id="section-1">简要</h1>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Coro</span><span class="p">;</span>
    <span class="n">async</span> <span class="p">{</span>
        <span class="c1">#一些异步执行的线程</span>
        <span class="k">print</span> <span class="s">&quot;2\n&quot;</span><span class="p">;</span>
        <span class="n">cede</span><span class="p">;</span> <span class="c1">#切换回main线程</span>
        <span class="k">print</span> <span class="s">&quot;4\n&quot;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">print</span> <span class="s">&quot;1\n&quot;</span><span class="p">;</span>
    <span class="n">cede</span><span class="p">;</span> <span class="c1">#切换到coro线程</span>
    <span class="k">print</span> <span class="s">&quot;3\n&quot;</span><span class="p">;</span>
    <span class="n">cede</span><span class="p">;</span> <span class="c1">#再次切换</span>
    <span class="c1">#使用信号锁</span>
    <span class="k">my</span> <span class="nv">$lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Coro::</span><span class="n">Semaphore</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$locked</span><span class="p">;</span>
    <span class="nv">$lock</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">;</span>
    <span class="nv">$locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nv">$lock</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">;</span>
</code></pre></div>
<h1 id="section-2">描述</h1>
<p>如果想看教程式的介绍，请阅读<a href="http://search.cpan.org/perldoc?Coro::Intro">Coro::Intro</a>文档。这里主要介绍的是一些参考信息。</p>
<p>一般来说，本模块以协作线程(文档中简写成coro)的方式来汇总管理后续代码。他们和内核线程很像但是一般来说不会在SMP机器上同时并发执行。这个模块提供的线程特殊的格式保证了他只在必须的时候才会在你程序中标明了的地方切换线程，所以锁和并发访问都不太会成为问题。Coro模块让线程编程变得更安全，更容易了。</p>
<p>不像那些所谓的“Perl threads”(这并不是真的线程，而是windows进程仿真(详见下面同名章节)移植到UNIX的，实际工作还是进程)，Coro提供了一个完全共享的地址空间。这使得线程之间的通信变得非常容易。而且Coro线程也非常快：放弃掉你的perl程序中windows进程仿真的代码改用coro可以很容易的获得2到4倍的速度提升。一个并行矩阵乘法基准测试(高度密集的通信)用coro在单核上运行也比在4核上跑满perl伪线程快300倍。</p>
<p>Coro通过支持多个运行中的解释器共享数据做到的这点。这对写伪并行进程和事件驱动程序非常有用，比如多个HTTP协议的GET请求并发运行。可以看看<a href="http://search.cpan.org/perldoc?Coro::AnyEvent">Coro::AnyEvent</a>模块来学习怎样集成Coro到事件驱动环境里。</p>
<p>在这个模块里，一个县城被定义为“调用链+词法变量+包变量+C栈”。也就是说，一个线程有自己的调用链，自己的词法集，自己的关键性的全局变量(更多配置和背景知识见<a href="http://search.cpan.org/perldoc?Coro::State">Coro::State</a>模块)。</p>
<p>注意看文档结尾的<code>参考</code>区域——Coro模块的家族可是非常庞大的。</p>
<h1 id="coro">Coro线程生命周期</h1>
<p>在coro线程漫长而兴奋(或许也不)的生命中，它咬经过一系列的状态：</p>
<ul>
  <li>1、创建</li>
</ul>
<p>coro线程生命中的第一件事情当然是创建——创建方法就是调用<code>async块</code>函数：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
        <span class="c1">#这里写线程的代码</span>
    <span class="p">};</span>
</code></pre></div>
<p>你也可以传递参数给代码块，默认会存进<code>@_</code>里：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
         <span class="k">print</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="c1">#打印2</span>
    <span class="p">}</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">;</span>
</code></pre></div>
<p>这会创建一个新的coro线程并放进ready队列里，这意味着当CPU空闲后它会立刻运行。</p>
<p><code>async</code>会返回一个Coro对象——你可以把这个对象存起来给之后使用——这个对象就是一个运行中、准备运行或者等待事件中的线程。</p>
<p>另一个创建线程的办法是调用带有代码引用的<code>new</code>构造器：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">new</span> <span class="n">Coro</span> <span class="k">sub </span><span class="p">{</span>
         <span class="c1">#这里写线程代码</span>
    <span class="p">},</span> <span class="nv">@optional_arguments</span><span class="p">;</span>
</code></pre></div>
<p>这和调用<code>async</code>相当类似，唯一的区别就是新线程默认不会放进ready队列里。你不显式的放进去的话，这个线程就永远不会执行了。所以，<code>async</code>应该等于下面这样的写法：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$coro</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Coro</span> <span class="k">sub </span><span class="p">{</span>
         <span class="c1">#这里写线程代码</span>
    <span class="p">};</span>
    <span class="nv">$coro</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$coro</span><span class="p">;</span>
</code></pre></div>
<ul>
  <li>2、启动</li>
</ul>
<p>当新coro线程创建之后，只会保存一个代码引用和参数。并不立刻分配额外的内存给栈。这样可以保持coro线程的低内存使用水平。</p>
<p>只有当线程真正开始运行的时候，这些资源才会分配出来。</p>
<p>附加参数在coro创建的时候存进了<code>@_</code>里，这点和函数调用是一样的。</p>
<ul>
  <li>3、运行、阻塞</li>
</ul>
<p>当coro线程开始运行之后会发生很多事情。一般来说，它不会一口气跑到底(因为这种情况你肯定是直接用普通函数代替了)，它会让出CPU来等待其他外部事件。</p>
<p>只要coro线程还在运行，这个Coro对象就一直存在一个叫做<code>$Coro::current</code>的全局变量里。</p>
<p>一个底层的让出CPU的办法是调用调度器，调度器会选择一个新的线程来运行：</p>
<div class="highlight"><pre><code class="perl">    <span class="nn">Coro::</span><span class="n">schedule</span><span class="p">;</span>
</code></pre></div>
<p>因为运行中的线程不可能在ready队列里，所以啥都不做单纯调用调度器会永远的阻塞住coro线程——你必须安排好由某些事件或者线程唤醒coro线程，或者是在调度前直接把coro线程放进ready队列：</p>
<div class="highlight"><pre><code class="perl">    <span class="c1">#这其实就是Coro::cede做的</span>
    <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">current</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">;</span>
    <span class="nn">Coro::</span><span class="n">schedule</span><span class="p">;</span>
</code></pre></div>
<p>所有高级的同步方法(Coro::Semaphore, Coro::rouse_*)都是通过<code>-&gt;ready</code>和<code>Coro::schedule</code>来实现的。</p>
<p>当coro线程运行的时候，它可能被分配到一个C级别的线程，也可能从C级别的线程里被剥离，一切如Coro运行时所愿。当你的perl线程调用C级别的函数的时候，就需要分配到C线程，然后这个函数反过来调用perl，然后perl就要想办法切换协程。在你运行事件循环然后在回调中阻塞的时候经常会出现这个情况。还有一种情况是perl自己通过<code>tie</code>机制调用一些方法或者函数比如<code>AUTOLOAD</code>等等。</p>
<ul>
  <li>4、终止</li>
</ul>
<p>一段时间后，大多数线程都会终止。有很多办法来终止一个coro线程。最简单的就是从顶级代码引用里返回：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
        <span class="c1">#当从这里return后，coro线程自然就终止了</span>
    <span class="p">};</span>
    <span class="n">async</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">if</span> <span class="mf">0.5</span> <span class="o">&lt;</span>  <span class="nb">rand</span><span class="p">;</span> <span class="c1">#可能提前从这里就终止了</span>
        <span class="k">print</span> <span class="s">&quot;got a chance to print this\n&quot;</span><span class="p">;</span>
        <span class="c1">#或者在这里终止</span>
    <span class="p">};</span>
</code></pre></div>
<p>从协程里返回的任意值都可以由<code>-&gt;join</code>获取：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$coro</span> <span class="o">=</span> <span class="n">async</span> <span class="p">{</span>
         <span class="s">&quot;hello, world\n&quot;</span> <span class="c1">#返回一个字符串</span>
    <span class="p">}</span>
    <span class="k">my</span> <span class="nv">$hello_world</span> <span class="o">=</span> <span class="nv">$coro</span><span class="o">-&gt;</span><span class="nb">join</span><span class="p">;</span>
    <span class="k">print</span> <span class="nv">$hello_world</span><span class="p">;</span>
</code></pre></div>
<p>另一个办法就是调用<code>Coro::terminate</code>方法，在任意嵌套级别的子例程里都行：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
         <span class="nn">Coro::</span><span class="n">terminate</span> <span class="s">&quot;return value 1&quot;</span><span class="p">,</span> <span class="s">&quot;return value 2&quot;</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>还有一个办法是从另一个线程<code>-&gt;cancel</code>(或者<code>-&gt;safe_cancel</code>)一个coro线程：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$coro</span> <span class="o">=</span> <span class="n">async</span> <span class="p">{</span>
        <span class="nb">exit</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nv">$coro</span><span class="o">-&gt;</span><span class="n">cancel</span><span class="p">;</span> <span class="c1">#同样接收数据给-&gt;join获取</span>
</code></pre></div>
<p>取消操作通常<code>可能</code>会很危险——它有点像调用了<code>exit</code>却又没真的退出。然后可能把C库和XS模块遗留在一个古怪的状态。而且和其他的线程实现不一样的是，Coro关于取消方面的异常是安全的。在你想用Coro做些奇妙的事情而又被取消的情况下，Perl会一直保持一个一致的状态——那就是，确保线程被取消的时候，所有清理代码都被执行了——所以还有一个<code>-&gt;safe_cancel</code>方法。</p>
<p>所以，在一个XS的事件循环里取消一个线程可能不是最好的主意。不过在只有perl(比如<code>tie</code>方法或<code>AUTOLOAD</code>)的其他组合里这么处理是安全的。
最后，Coro线程对象在<code>-&gt;cancel</code>后自动的被取消引用了——和Perl里其他对象一样。虽然这不是什么普遍的情况，一个运行中的线程被<code>$Coro::current</code>引用，一个等待运行中的线程被ready队列引用，一个等待锁或者信号的线程被等待列表引用，等等等等……但取消的时候，所有队列都不再有这个线程了：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
         <span class="n">schedule</span><span class="p">;</span> <span class="c1">#切换到其他coro里，不进ready队列</span>
    <span class="p">};</span>
    <span class="n">cede</span><span class="p">;</span>
    <span class="c1">#现在上面的async被摧毁了，不再被任何地方引用。</span>
</code></pre></div>
<ul>
  <li>5、清理</li>
</ul>
<p>线程需要分配各种资源。大多数但不是所有在线程终止的时候会被清理返回。</p>
<p>清理非常像丢弃未捕获的异常：perl会按照它的方式去运行所有的子例程调用和代码块。它的方式里，它会释放所有的<code>my</code>变量，撤销所有的<code>local</code>变量，释放所有其他线程独立的资源。</p>
<p>所以，常见的释放资源的办法就是让他们成为my变量。</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
         <span class="k">my</span> <span class="nv">$big_cache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cache</span> <span class="o">...</span><span class="p">;</span>
    <span class="p">};</span>
</code></pre></div>
<p>如果不再有引用存在，<code>$big_cache</code>对象在线程终止的时候自然就释放掉了。</p>
<p>它并<code>不</code>会解锁Coro::Semaphore或类似的其他资源，这时候<code>guard</code>方法就派上用场了：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$sem</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Coro::</span><span class="n">Semaphore</span><span class="p">;</span>
    <span class="n">async</span> <span class="p">{</span>
         <span class="k">my</span> <span class="nv">$lock_guard</span> <span class="o">=</span> <span class="nv">$sem</span><span class="o">-&gt;</span><span class="n">guard</span><span class="p">;</span>
         <span class="c1">#如果我们在这里return，或者die，或者取消</span>
         <span class="c1">#信号也就唤醒了</span>
    <span class="p">}</span>
</code></pre></div>
<p>这个<code>Guard::guard</code>函数可以在你想要的时候出现在任意清理的时候(但是不能从代码块里切换到其他协程中)：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
         <span class="k">my</span> <span class="nv">$window</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Gtk2::</span><span class="n">window</span> <span class="s">&quot;toplevel&quot;</span><span class="p">;</span>
         <span class="c1">#window不会被自动清理，哪怕$window被释放了</span>
         <span class="c1">#所以用guard确保在出错的时候它可以被正确的毁灭</span>
         <span class="k">my</span> <span class="nv">$window_guard</span> <span class="o">=</span> <span class="nn">Guard::</span><span class="n">guard</span> <span class="p">{</span><span class="nv">$window</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">};</span>
         <span class="c1">#这样从这里开始我就安全了</span>
    <span class="p">};</span>
</code></pre></div>
<p>最后，<code>local</code>通常也是很方便的。比如临时替换一下coro线程的描述：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">sub </span><span class="nf">myfunction</span> <span class="p">{</span>
         <span class="nb">local</span> <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">current</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">desc</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;inside myfunction(@_)&quot;</span><span class="p">;</span>
         <span class="c1">#如果这里突然return或者die了，描述会重新存储过</span>
    <span class="p">}</span>
</code></pre></div>
<ul>
  <li>6、僵尸死亡万岁</li>
</ul>
<p>即便一个线程已经终止并且清理过它的资源了，Coro对象依然存在，而且存储着它的线程返回值。</p>
<p>这意味着线程终止并清理，不再有其他引用之后，Coro对象会自动释放掉。</p>
<p>而如果还有引用，Coro对象就还保留着，你可以调用<code>-&gt;join</code>多次来接收结果数据：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
         <span class="k">print</span> <span class="s">&quot;hi\n&quot;</span><span class="p">;</span>
         <span class="mi">1</span>
    <span class="p">};</span>
    <span class="c1">#运行上面的async，并且在从Coro::cede返回前释放所有资源</span>
    <span class="nn">Coro::</span><span class="n">cede</span><span class="p">;</span>
    <span class="p">{</span>
         <span class="k">my</span> <span class="nv">$coro</span> <span class="o">=</span> <span class="n">async</span> <span class="p">{</span>
              <span class="k">print</span> <span class="s">&quot;hi\n&quot;</span><span class="p">;</span>
              <span class="mi">1</span>
         <span class="p">};</span>
         <span class="c1">#运行上面的async并清理掉，但是不是放coro对象：</span>
         <span class="nn">Coro::</span><span class="n">cede</span><span class="p">;</span>
         <span class="c1">#可选的收取结果</span>
         <span class="k">my</span> <span class="nv">@results</span> <span class="o">=</span> <span class="nv">$coro</span><span class="o">-&gt;</span><span class="nb">join</span><span class="p">;</span>
         <span class="c1">#现在$coro超出范围了，可能被释放掉</span>
    <span class="p">};</span>
</code></pre></div>
<h1 id="section-3">全局变量</h1>
<ul>
  <li>$Coro::main</li>
</ul>
<p>这个变量存储了代表主程序的Coro对象。如果你可以<code>ready</code>好它，可以像操作coro一样操作它。在对比<code>$Coro::current</code>的时候特别有用，这样可以看到自己是不是运行在主程序里了。</p>
<ul>
  <li>$Coro::current</li>
</ul>
<p>这个变量代表当前coro(Coro调度器切换到的最后一个coro)。初始值和<code>$Coro::main</code>一样。</p>
<p>这个变量是__严格___只读_的。你可以复制到别的变量然后在其他Coro对象里使用，但不能修改这个变量本身。</p>
<ul>
  <li>$Coro::idle</li>
</ul>
<p>这个变量在集成Coro到事件循环的时候很有用。通常他更依赖<a href="http://search.cpan.org/perldoc?Coro::AnyEvent">Coro::AnyEvent</a>或者<a href="http://search.cpan.org/perldoc?Coro::EV">Coro::EV</a>，这是很漂亮的底层功能。</p>
<p>这个变量存储的Coro对象在没有其他ready线程的时候，就会被放进ready队列里(而不会调用其他ready钩子)。</p>
<p>默认实现是带着一个“致命的：检测到死锁”的提示die退出，然后跟着线程列表，因为程序没办法继续了。</p>
<p>钩子被<code>Coro::EV</code>和<code>Coro::AnyEvent</code>这样的模块重写以等待外部事件唤醒coro以便调度器运行。</p>
<p>这个技术的示例请参见<a href="http://search.cpan.org/perldoc?Coro::EV">Coro::EV</a>或者<a href="http://search.cpan.org/perldoc?Coro::AnyEvent">Coro::AnyEvent</a>模块。</p>
<h1 id="coro-1">简单的Coro创建</h1>
<ul>
  <li>async {&hellip;} [@args&hellip;]</li>
</ul>
<p>创建新coro返回他的Coro对象(通常用不上)。这个coro会被放进ready队列，当下一次调度来临的时候就自动运行。</p>
<p>第一个参数是要在coro里运行的代码块/闭包。当它返回时，coro自动终止。</p>
<p>剩余参数作为闭包的参数传递进去。</p>
<p>参见<code>Coro::State::new</code>构造器来了解当coro运行时coro环境的信息。</p>
<p>在coro里调用<code>exit</code>和在外头的效果是一样的，同样，如果coro线程die掉，程序整个退出，和在cor外面也一样。</p>
<p>如果你不想这样，你可以通过一个默认的<code>die</code>句柄，或者简单的用<code>eval</code>包装一下。</p>
<p>示例：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
         <span class="k">print</span> <span class="s">&quot;@_\n&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">;</span>
</code></pre></div>
<ul>
  <li>async_pool {&hellip;} [@args&hellip;]</li>
</ul>
<p>和<code>async</code>类似，不过用一个coro池，所以你不要对这个对象调用terminate或者join方法(然后我们也没禁止)。而且你可能得到一个coro是已经在执行其他代码的(这事儿说好也好，说不好也不好)。</p>
<p>从加强的的一面说，这个函数比完整的创建(和销毁)一个新coro快了两倍。所以你如果需要快速创建大批量的通用coro，使用<code>async_pool</code>，别用<code>async</code>。</p>
<p>代码块会在<code>eval</code>环境里运行，出现异常的时候抛出warning而不是终止程序，这和<code>async</code>一样。</p>
<p>当coro被重用的时候，像<code>on_destroy</code>这样的东西可能不会按照你想象的那样工作，除非你调用终止或者取消，这些都是跟池的目的相违背的(不过在异常的情况下还是很不错的)。</p>
<p>每次运行后，优先级都设置成<code>0</code>，跟踪被禁用，描述被清空，默认输出句柄被恢复。这样你可以改变所有这些东西。否则，coro会重用他们的“初始值”：最显著的就是如果你修改了每个线程的全局变量比如<code>$/</code>，你必须修复这个改变。最简单的做法就是用<code>local $/</code>这样。</p>
<p>空闲池的大小限定为<code>8</code>个空闲线程(这可以通过$Coro::POOL_SIZE改变)，但是有需求的恶化，非空闲的coro是多多益善的。</p>
<p>如果一个<code>async_pool</code>用了太多栈空间让你担心池里的coro章太猛了，你可以每秒钟运行<code>async_pool {terminate}</code>这样的代码来缓慢的补充池子。除此之外，当句柄用的栈涨到超过32KB(由$Coro::POOL_RSS设置)时，它就会被销毁。</p>
<h1 id="section-4">静态方法</h1>
<p>静态方法实际上就是对当前coro进行隐式操作的函数。</p>
<ul>
  <li>schedule</li>
</ul>
<p>调用调度器。调度器会从ready队列中查找下一个可以运行的coro并切换过去。这个“下一个可以运行的coro”就是有最高优先级的，在队列里等待时间最久的那个。如果一个都没有，就调用<code>$Coro::idle</code>钩子。</p>
<p>请注意：当前coro<code>不</code>会被放进ready队列里，所以调用这个函数后，这个coro不再会被调用知道有其他事件调用<code>-&gt;ready</code>来唤醒你。</p>
<p>这让<code>schedule</code>阻塞当前线程并等待事件：首先你要把当前coro记在一个变量里，然后安排好回调，在某些情况下可以用<code>-&gt;ready</code>来唤醒你，最后你调用<code>schedule</code>让自己进入沉睡。注意有很多办法可以唤醒coro，所以你要检测一下事件是否正确，比如把状态存储在一个变量里。</p>
<p>至于怎样等待回调，参见下面的__怎么等待回调__章节。</p>
<ul>
  <li>cede</li>
</ul>
<p>&ldquo;放弃&rdquo;到其他coro。这个函数把当前线程放进ready队列里然后调用<code>schedule</code>。它的效果是放弃当前的“时间片”给其他拥有更高优先级或者至少同级别的coro。一旦你的coro重新被轮到，它会自动恢复过来。</p>
<p>在其他语言里，这个函数经常被叫做<code>yield</code>。</p>
<ul>
  <li>Coro::cede_notself</li>
</ul>
<p>和cede类似，不过默认不会export出来，这个函数会不顾优先级强制cede给_其他_coro，在需要确保进程运行的时候还是有些用的。</p>
<ul>
  <li>terminate [arg&hellip;]</li>
</ul>
<p>带着给定的状态值终止当前coro(参见<a href="http://search.cpan.org/perldoc?cancel">cancel</a>)。这些状态值不会被直接返回，而是返回他们的引用。</p>
<ul>
  <li>Coro::on_enter BLOCK, Coro::on_leave BLOCK</li>
</ul>
<p>这两函数会在当前作用域内安装enter和leave。enter块会在on_enter 被调用，还有当前coro被调度器re-enter的时候执行。而leave快则是在当前coro被调度器阻塞，还有词法作用域被退出(意思就是exit、die、last等)的时候被执行。</p>
<p><em>在这些块里，不允许再调用调度器，也不允许异常</em>。这意味着，不用eval的情况下别想调用<code>die</code>命令，至于调度器更是什么办法都没法用了。</p>
<p>介于这些块都是和当前作用域绑定的，所以当当前作用域退出的时候，他们会自动删除。</p>
<p>这两函数实现了和计划中<code>dynamic-wind</code>做的一样的概念，在你想给一个特定coro本地化某些资源的时候比较有用。</p>
<p>使用这两函数的coro会相对的被放慢线程切换的速度(大概一个单独分配的块40%的样子，所以只要处理程序够快，线程切换依然很快)。</p>
<p>通过下面这个例子，可以更好的理解这些函数：切换当前时区到&rdquo;南极&rdquo;，这需要调用<code>tzset</code>，但是我们使用<code>on_enter</code>和<code>on_leave</code>，用来记忆/改变当前时区并存储之前的值。分别的，只有安装了这两函数的coro才会改变时区。</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(tzset)</span><span class="p">;</span>
    <span class="n">async</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$old</span><span class="o">\</span><span class="n">_tz</span><span class="p">;</span> <span class="o">\</span><span class="c1">#在这里存储外面的时区</span>
        <span class="nn">Coro::</span><span class="n">on</span><span class="o">\</span><span class="n">_enter</span> <span class="p">{</span>
            <span class="nv">$old</span><span class="o">\</span><span class="n">_tz</span> <span class="o">=</span> <span class="nv">$ENV</span><span class="p">{</span><span class="n">TZ</span><span class="p">};</span> <span class="o">\</span><span class="c1">#记忆旧的数值</span>
            <span class="nv">$ENV</span><span class="p">{</span><span class="n">TZ</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;Antarctica/South\_Pole&quot;</span><span class="p">;</span>
            <span class="n">tzset</span><span class="p">;</span> <span class="o">\</span><span class="c1">#启用新值</span>
        <span class="p">};</span>
        <span class="nn">Coro::</span><span class="n">on</span><span class="o">\</span><span class="n">_leave</span> <span class="p">{</span>
            <span class="nv">$ENV</span><span class="p">{</span><span class="n">TZ</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$old</span><span class="o">\</span><span class="n">_tz</span><span class="p">;</span>
            <span class="n">tzset</span><span class="p">;</span> <span class="o">\</span><span class="c1">#恢复旧值</span>
        <span class="p">};</span>
        <span class="o">\</span><span class="c1">#在这块，时区就是&quot;南极&quot;，不会被其他coro里的时区影响</span>
    <span class="p">};</span>
</code></pre></div>
<p>这可以用于给块本地化任何资源(locale，uid，当前工作目录等)，尽管当前有其他coro存在。</p>
<p>另一个有趣的例子，通过间隔计时器实现了时间片的多任务(下面的代码明显是可以优化的，不过当前足够跑任务了)：</p>
<div class="highlight"><pre><code class="perl">    <span class="o">\</span><span class="c1">#把给定块按时间分片</span>
    <span class="k">sub </span><span class="nf">timeslice</span><span class="p">(&amp;) {</span>
        <span class="k">use</span> <span class="nn">Time::</span><span class="n">HiRes</span> <span class="p">();</span>
        <span class="nn">Coro::</span><span class="n">on</span><span class="o">\</span><span class="n">_enter</span> <span class="p">{</span>
            <span class="o">\</span><span class="c1">#在进线程的时候，我们设置一个VTALRM信号以便cede</span>
            <span class="nv">$SIG</span><span class="p">{</span><span class="n">VTALRM</span><span class="p">}</span> <span class="o">=</span> <span class="k">sub </span><span class="p">{</span> <span class="n">cede</span> <span class="p">};</span>
            <span class="o">\</span><span class="c1">#然后启动一个间隔计时器</span>
            <span class="nn">Time::HiRes::</span><span class="n">setitimer</span> <span class="o">&amp;</span><span class="nn">Time::HiRes::</span><span class="n">ITIMER</span><span class="o">\</span><span class="n">_VIRTUAL</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="nn">Coro::</span><span class="n">on</span><span class="o">\</span><span class="n">_leave</span> <span class="p">{</span>
            <span class="o">\</span><span class="c1">#在离开线程的时候我们停止这个间隔计时器</span>
            <span class="nn">Time::HiRes::</span><span class="n">setitimer</span> <span class="o">&amp;</span><span class="nn">Time::HiRes::</span><span class="n">ITIMER</span><span class="o">\</span><span class="n">_VIRTUAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="o">&amp;</span><span class="p">{</span><span class="o">+</span><span class="nb">shift</span><span class="p">};</span>
    <span class="p">}</span> 
    <span class="o">\</span><span class="c1">#使用方法如下：</span>
    <span class="n">timeslice</span> <span class="p">{</span>
        <span class="o">\</span><span class="c1">#下面是一个死循环，一般情况下会垄断进程。</span>
        <span class="o">\</span><span class="c1">#不过现在它跑着一个时间片环境里，定期的会cede给其他线程。</span>
        <span class="k">while</span> <span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">};</span>
</code></pre></div>
<ul>
  <li>killall</li>
</ul>
<p>除当前运行的coro外，杀死/中断/取消所有coro。</p>
<p>注意，如果调用killall的coro不是主coro，当他试图释放一些主解释资源的时候，可能释放不干净。会存在一些一次性的资源泄露。</p>
<h1 id="coro-2">Coro对象方法</h1>
<p>下面是一些你可以在coro对象上调用(或者创建)的方法。</p>
<ul>
  <li>new Coro \&amp;sub [,@args&hellip;]</li>
</ul>
<p>创建一个新的coro并返回它。当sub返回的时候，coro自动终止，就像你带着返回值调用<code>terminate</code>的效果一样。要让coro运行，你要先调用rady方法把它放进ready队列里。</p>
<p>参考<code>async</code>和<code>Coro::State::new</code>查看更多关于coro环境的信息。</p>
<ul>
  <li>$success = $coro-&gt;ready</li>
</ul>
<p>将该coro放进它的ready队列的最后(每个优先级都有一个队列)并返回真。如果coro已经在ready队列里，不做任何操作并返回假。</p>
<p>这保证里当所有高优先级的coro和同优先级先准备好了的coro都恢复后，调度器会自动恢复这个coro。</p>
<ul>
  <li>$coro-&gt;suspend</li>
</ul>
<p>挂起指定coro。一个挂起的coro和其他coro一样工作，不同的是调度器不会选择挂起的coro做真正的执行。</p>
<p>当你想阻止某个coro运行又不打算销毁它，或者当你想暂时冻结某个coro(比方需要调试)等之后再恢复的时候，挂起就很有用了。</p>
<p>前者的一个场景可能是这样：fork之后挂起所有其他的coro但保持住他们不调用析构器，不过你可以继续创建新的coro。</p>
<ul>
  <li>$coro-&gt;resume</li>
</ul>
<p>当指定coro被挂起后，它就可以被恢复。注意如果一个已经在ready队列里的coro被挂起，调度器可能会把它踢出去，你会失去这次激活。</p>
<p>要避免这种情况的话，最好的办法是无条件的把挂起coro放进预备队列，每个同步机制都必然会保护自己不被虚假唤醒，Coro自然也有。</p>
<ul>
  <li>$state-&gt;is_new</li>
</ul>
<p>如果Coro对象还是“新”的，返回真，额，新的意思是还没运行过。这些状态基本只是由要调用的代码引用和参数组成。消耗的其他资源很少。转移到新状态后会自动分配一个perl解释器。</p>
<ul>
  <li>$state-&gt;is_zombie</li>
</ul>
<p>如果Coro对象被取消了，返回真。比如对象的资源因为<code>cancel</code>、<code>terminate</code>、<code>safe_cancel</code>释放了，或者可能就是简单的跑出范围了。</p>
<p>“僵尸”这个名字源自UNIX文化，当一个进程已经退出，除了退出状态什么资源都没有了的时候，就会被叫做“僵尸”。</p>
<ul>
  <li>$is_ready = $coro-&gt;is_ready</li>
</ul>
<p>如果Coro对象在预备队列里，返回真。它最终会被调度器调控，除非Coro对象被销毁。</p>
<ul>
  <li>$is_running = $coro-&gt;is_running</li>
</ul>
<p>如果Coro对象正在运行，返回真。只有一个Coro对象可以处于运行状态(但一个Coro对象可以有多个运行中的Coro::States)。</p>
<ul>
  <li>$is_suspended = $coro-&gt;is_suspended</li>
</ul>
<p>如果Coro对象被挂起，返回真。挂起的Coro永远不会被调度。</p>
<ul>
  <li>$coro-&gt;cancel (arg&hellip;)</li>
</ul>
<p>终止指定Coro线程，强制返回指定参数作为状态(默认为空列表)。如果指定Coro就是当前Coro，则无法返回。</p>
<p>这是一个相当残酷的释放coro的方式，而且还有一些限制——如果线程里有一个不希望被终止的C语言的回调，有些不忍言之事就要发生了；或者如果取消的线程上运行着复杂的清理程序，而这个清理程序又依赖于它的线程上下文，事情也不大会正常的工作。</p>
<p>要运行的清理程序代码(比如<code>guard</code>代码块)不会有线程上下文，也不允许再切换到其他线程。</p>
<p>另外，<code>-&gt;cancel</code>永远都是这么不管不顾的清理线程。所以如果你的清理代码很复杂或者你希望避免取消一个自己压根不知道怎么清理的C语言线程，建议使用<code>-&gt;throw</code>抛出异常，或者用<code>-&gt;safe_cancel</code>方法。</p>
<p>传递给<code>-&gt;cancel</code>的参数不会被复制，而是被直接引用(比如：你传递了<code>$var</code>，在调用修改这个变量之后，你也需要修改传递给<code>join</code>的返回值，所以最好别用这个)。</p>
<p>Coro的资源通常在这个调用返回之前就已经都释放或销毁掉了。不过这事可以被无限期的推迟，因为可能作为管理端的线程有时候要首先运行注销Coro对象。</p>
<ul>
  <li>$coro-&gt;safe_cancel($arg&hellip;)</li>
</ul>
<p>和<code>-&gt;cancel</code>很像。不过本质上，它是“安全”的。所以当线程并不处于一个可终止的状态的时候，它会抛出一个异常。</p>
<p>这个方法运行起来就像抛出一个不可被捕捉的异常——具体的说，它从线程的内部开始清理，所以所有的清理程序(比如<code>guard</code>块)，都是在线程的上下文中运行，并且可以随意阻塞。它的缺点就是不保证线程肯定可以终止，它可能会失败。而且，运行速度也比<code>cancel</code>和<code>terminal</code>慢。</p>
<p>一个线程，当它还没有被运行，或者没有C语言的上下文附加且在SLF函数内。</p>
<p>后面这两个的意思基本上就是线程不在被某些C函数(通常是XS模块)回调的perl函数里，也不在这些C函数通过Coro的XS级别的API调用运行中。</p>
<p>当本函数可以正常终止线程时，返回真；否则报错(即要么返回真要么不返回)。</p>
<p>为什么搞这么奇怪的接口？嗯，关于何时如何终止线程，有两种通用模式。一种是你希望当你想终止的时候就可以终止——当线程不可终止的时候，显然就会有问题了。所以需要<code>-&gt;safe_cancel</code>来报错。</p>
<p>第二种模式是，你很友好的问下先，如果不碰巧，那就先不终止线程了。看起来就像这样：</p>
<div class="highlight"><pre><code class="perl"> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">eval</span> <span class="p">{</span> <span class="nv">$coro</span><span class="o">-&gt;</span><span class="n">safe</span><span class="o">\</span><span class="n">_cancel</span> <span class="p">})</span> <span class="p">{</span>
        <span class="nb">warn</span> <span class="s">&quot;unable to cancel thread: $@&quot;</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>然而，你不应该总是先尝试安全的取消然后失败了再强行<code>-&gt;cancel</code>。这样是没道理的：因为你肯定要不就在线程里自己搞定清理代码，要不就是没有。有的话，用<code>-&gt;safe_cancel</code>；没有的话，<code>-&gt;cancel</code>更直接快捷。</p>
<ul>
  <li>$coro-&gt;schedule_to</li>
</ul>
<p>让当前线程进入休眠(类似<a href="http://search.cpan.org/perldoc?Coro::schedule">Coro::schedule</a>)，不过不会轮到ready队列的下一个线程，而是切换到给定的那个Coro对象(不管多少优先级)。coro的准备情况并不会被改变。</p>
<p>这是一个为特殊情况准备的高级方法——我很乐意听到它被实际运用了。</p>
<ul>
  <li>$coro-&gt;cede_to</li>
</ul>
<p>和<code>schedule_to</code>类似，但是是把当前线程放进ready队列里。它等效于暂时切换到给定的对象，过会儿再继续。</p>
<p>这是一个为特殊情况准备的高级方法——我很乐意听到它被实际运用了。</p>
<ul>
  <li>$coro-&gt;throw ([$scalar])</li>
</ul>
<p>如果<code>$throw</code>被定义了，那它会在下一个合适的时间点被coro作为异常抛出。否则就清理掉这个异常对象。</p>
<p>Coro会在每个类schedule函数返回时检查异常。这类函数包括<code>schedule</code>，<code>cede</code>，<code>Coro::Semaphore-&gt;down</code>，<code>Coro::Handle-&gt;readable</code>等等。大多数这些函数(都是Coro的一部分)检测这个情况，并且在异常pending的时候提前返回。</p>
<p>异常对象会在<code>$@</code>中和另一个特殊标量一起被抛出。即，如果它是字符串，不会有行号和和新行追加进来(跟<code>die</code>不一样)。</p>
<p>这可以被用来作为一个比<code>cancel</code>或者<code>safe_cancel</code>更柔和一些的询问一个coro是否结束的办法，虽然并不能保证异常一定会导致终止而且如果没有被捕获它可能会结束整个程序。</p>
<p>你也可以理解<code>throw</code>是类似带信号(这种情况就是一个标量)的<code>kill</code>。</p>
<ul>
  <li>$coro-&gt;join</li>
</ul>
<p>等待coro中止并返回线程给<code>terminal</code>或<code>cancel</code>返回的任意值。<code>join</code>可以并发的被多个线程调用。然后一旦<code>$coro</code>中止，一切都会恢复并且给出一个返回值。</p>
<ul>
  <li>$coro-&gt;on_destroy (\&amp;cb)</li>
</ul>
<p>注册一个回调函数在coro线程被销毁的时候被调用。具体的说是资源已经被释放，不过join还没开始。在任意情况下，只要<code>不</code>是die，这个回调函数都会传入终止/中止参数。</p>
<p>每个coro可以有任意多个<code>on_destroy</code>回调，而且目前为止，一旦添加，不可以再删除了。</p>
<ul>
  <li>$oldprio = $coro-&gt;prio ($newprio)</li>
</ul>
<p>设置(当没有参数的时候就是获取)coro线程的优先级。高优先级的会比低优先级的更早运行。优先级是有符号整数，目前是3到-4之间。你可以参考使用PRIO_***常量(提前导入标签:prio获取)；</p>
<div class="highlight"><pre><code class="perl">   <span class="n">PRIO</span><span class="o">\</span><span class="n">_MAX</span> <span class="o">&gt;</span> <span class="n">PRIO</span><span class="o">\</span><span class="n">_HIGH</span> <span class="o">&gt;</span> <span class="n">PRIO</span><span class="o">\</span><span class="n">_NORMAL</span> <span class="o">&gt;</span> <span class="n">PRIO</span><span class="o">\</span><span class="n">_LOW</span> <span class="o">&gt;</span> <span class="n">PRIO</span><span class="o">\</span><span class="n">_IDLE</span> <span class="o">&gt;</span> <span class="n">PRIO</span><span class="o">\</span><span class="n">_MIN</span>
       <span class="mi">3</span>    <span class="o">&gt;</span>     <span class="mi">1</span>     <span class="o">&gt;</span>      <span class="mi">0</span>      <span class="o">&gt;</span>    <span class="o">-</span><span class="mi">1</span>    <span class="o">&gt;</span>    <span class="o">-</span><span class="mi">3</span>     <span class="o">&gt;</span>    <span class="o">-</span><span class="mi">4</span>
   <span class="o">\</span><span class="c1"># 设置优先级为高</span>
   <span class="n">current</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="p">(</span><span class="n">PRIO</span><span class="o">\</span><span class="n">_HIGH</span><span class="p">);</span>
</code></pre></div>
<p>空闲的coro线程永远比其他存活的coro优先级要低。</p>
<p>修改当前coro的优先级即时生效，但是修改ready队列里的只会在下次调度(到它)的时候才生效。或者这算个bug，未来某个版本会修正。</p>
<ul>
  <li>$newprio = $coro-&gt;nice ($change)</li>
</ul>
<p>类似<code>prio</code>方法，不过是从优先级中减去给定的值(也就是说值越大优先级越低，类似UNIX里的nice命令)。</p>
<ul>
  <li>$olddesc = $coro-&gt;desc ($newdesc)</li>
</ul>
<p>设置(当没有参数的时候就是获取)coro线程的描述。这只是与coro关联的无格式的字符串。</p>
<p>这个方法只是简单的把<code>$coro-&gt;{desc}</code>成员设置为给定的字符串。你也可以自己修改这个成员。事实上，大家通常宁愿这样声明，比如在一个<a href="http://search.cpan.org/perldoc?Coro::Debug">Coro::Debug</a>的会话里：</p>
<div class="highlight"><pre><code class="perl">   <span class="k">sub </span><span class="nf">my</span><span class="p">\_long\_function {</span>
      <span class="nb">local</span> <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">current</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">desc</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;now in my\_long\_function&quot;</span><span class="p">;</span>
      <span class="o">...</span>
      <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">current</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">desc</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;my\_long\_function: phase 1&quot;</span><span class="p">;</span>
      <span class="o">...</span>
      <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">current</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">desc</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;my\_long\_function: phase 2&quot;</span><span class="p">;</span>
      <span class="o">...</span>
   <span class="p">}</span> 
</code></pre></div>
<h1 id="section-5">全局函数</h1>
<ul>
  <li>Coro::nready</li>
</ul>
<p>返回在ready状态(即通过调用<code>schedule</code>可以切换的)的coro线程个数。值为<code>0</code>的话，就意味着唯一可运行的就是当前运行的这个线程。所以<code>cede</code>是没效果的，而<code>schedule</code>会死锁到有哪个空闲函数激活别的coro。</p>
<ul>
  <li>my $guard = Coro::guard { &hellip; }</li>
</ul>
<p>这个函数还存在，不过早晚被废弃，请使用<code>Guard::guard</code>函数。</p>
<ul>
  <li>unblock_sub { &hellip; }</li>
</ul>
<p>这个有用的工具接收一个块或者代码引用，然后“unblock”它，并返回一个新的代码引用。unblock意思是：调用新的代码引用会立刻返回，不阻塞，无返回值。而原本的代码会被另一个新的coro调用。</p>
<p>这个函数存在的原因是：很多event库(比如<a href="http://search.cpan.org/perldoc?Event">Event</a>库)是非线程安全(比较弱格式的可重入性)的。这意味着你在回调总不可以阻塞。否则你就可能收到崩溃的报警。我目前唯一知道可以不用<code>unblock_sub</code>就安全的event库就是<a href="http://search.cpan.org/perldoc?EV">EV</a>了(但是当你所有的事件循环都被block后，你还是会进入死锁状态)。</p>
<p>Coro会尝试在你在事件循环中被阻塞的时候捕获异常(FATAL:$Coro::IDLE blocked itself)。当然这只是近乎完美，而且还要求你不能用自己的循环实现。</p>
<p>这个函数允许你的回调是阻塞的，因为他会在另一个可以被安全阻塞的coro里执行。一个很常见的例子就是当你用<a href="http://search.cpan.org/perldoc?Coro::AIO">Coro::AIO</a>模块时，函数让你刷结果到磁盘上。</p>
<p>简单的说：在有阻塞可能的函数里用<code>unblock_sub</code>代替<code>sub</code>。</p>
<p>如果你的函数无所谓阻塞(比如给另一个coro发个信息，或者把其他coro整理到ready队列里)，那就没理由用<code>unblock_sub</code>了。</p>
<p>注意你必须给C级别的事件循环中使用的回调函数使用<code>unblock_sub</code>。比如，当你使用一些用了<a href="http://search.cpan.org/perldoc?AnyEvent">AnyEvent</a>(而且你用的是<a href="http://search.cpan.org/perldoc?Coro::AnyEvent">Coro::AnyEvent</a>)的模块，这些模块提供的回调函数又是另一些事件回调的结果，你可不能阻塞掉它们，那么用<code>unblock_sub</code>吧。</p>
<ul>
  <li>$cb = rouse_cb</li>
</ul>
<p>创建并返回一个“唤醒式的回调”。这是一个代码引用，当被调用的时候，它就记下调用的参数副本，然后通知拥有这个回调的coro。</p>
<ul>
  <li>@args = rouse_wait [$cb]</li>
</ul>
<p>等待特定的唤醒回调(或者是本coro中最后创建的那个)。</p>
<p>一旦被调用(或者在<code>rouse_wait</code>之前被调用)，他将返回最初传递给唤醒回调的参数。在标量上下文中意味着是<code>最后</code>一个参数，就好比<code>rouse_wait</code>最后状态是<code>return ($a1,$a2,$a3...)</code>。</p>
<p>参见下面__怎么等待回调__章节的实际使用例子。</p>
<h1 id="section-6">怎么等待回调</h1>
<p>对于一个coro线程，等待回调是非常常见的。当你在另一个事件驱动程序或者事件驱动库里使用coro的时候，很自然的触发它。</p>
<p>通常时注册一个回调函数对应相应的事件，然后当这个事件触发的时候调用这些函数。不过，你可能只是想等待事件，简单到极致了。</p>
<p>比如<code>AnyEvent-&gt;child</code>注册了一个回调到特定子进程退出的时候：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$child_watcher</span> <span class="o">=</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">child</span> <span class="p">(</span><span class="n">pid</span> <span class="o">=&gt;</span> <span class="nv">$pid</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="o">...</span> <span class="p">});</span>
</code></pre></div>
<p>不过在coro里，你通常只需要这么写：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$status</span> <span class="o">=</span> <span class="n">wait_for_child</span> <span class="nv">$pid</span><span class="p">;</span>
</code></pre></div>
<p>Coro提供了两个特定的函数让这件事情变得很容易：C<coro::rouse_cb>和C<coro::rouse_wait>。</coro::rouse_wait></coro::rouse_cb></p>
<p>第一个函数，C<rouse_cb>，生成并返回一个回调，当这个回调被调用时，会自动保存参数并通知创建该回调的coro。</rouse_cb></p>
<p>第二个函数，C<rouse_wait>，等待回调被调用(通过C<schedule>命令进入休眠)并返回传递给回调的初始参数。
使用这两个函数，就可以很容易的实现上面说的C<wait_for_child>函数了：</wait_for_child></schedule></rouse_wait></p>
<div class="highlight"><pre><code class="perl">    <span class="k">sub </span><span class="nf">wait_for_child</span><span class="p">($)</span> <span class="p">{</span>
       <span class="k">my</span> <span class="p">(</span><span class="nv">$pid</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
      <span class="k">my</span> <span class="nv">$watcher</span> <span class="o">=</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">child</span> <span class="p">(</span><span class="n">pid</span> <span class="o">=&gt;</span> <span class="nv">$pid</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=&gt;</span> <span class="nn">Coro::</span><span class="n">rouse_cb</span><span class="p">);</span>
       <span class="k">my</span> <span class="p">(</span><span class="nv">$rpid</span><span class="p">,</span> <span class="nv">$rstatus</span><span class="p">)</span> <span class="o">=</span> <span class="nn">Coro::</span><span class="n">rouse_wait</span><span class="p">;</span>
       <span class="nv">$rstatus</span>
    <span class="p">}</span>
</code></pre></div>
<p>如果嫌C<rouse_cb>和C<rouse_wait>还不够灵活，你还可以用C<schedule>自己搞起：</schedule></rouse_wait></rouse_cb></p>
<div class="highlight"><pre><code class="perl">    <span class="k">sub </span><span class="nf">wait_for_child</span><span class="p">($)</span> <span class="p">{</span>
       <span class="k">my</span> <span class="p">(</span><span class="nv">$pid</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
      <span class="c1"># 把当前的coro存入$current,</span>
      <span class="c1"># 然后提供一个结果变量传递给-&gt;child的闭包</span>
      <span class="k">my</span> <span class="nv">$current</span> <span class="o">=</span> <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">current</span><span class="p">;</span>
      <span class="k">my</span> <span class="p">(</span><span class="nv">$done</span><span class="p">,</span> <span class="nv">$rstatus</span><span class="p">);</span>
      <span class="c1"># pass a closure to -&gt;child</span>
      <span class="k">my</span> <span class="nv">$watcher</span> <span class="o">=</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">child</span> <span class="p">(</span><span class="n">pid</span> <span class="o">=&gt;</span> <span class="nv">$pid</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
         <span class="nv">$rstatus</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="c1"># 记住$rstatus</span>
         <span class="nv">$done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1"># 标记$rstatus</span>
      <span class="p">});</span>
      <span class="c1">#等待闭包被调用</span>
      <span class="n">schedule</span> <span class="k">while</span> <span class="o">!</span><span class="nv">$done</span><span class="p">;</span>
      <span class="nv">$rstatus</span>
    <span class="p">}</span>
</code></pre></div>
<h1 id="section-7">错误和限制</h1>
<ul>
  <li>后端用pthread派生</li>
</ul>
<p>当coro使用pthread后端编译(不建议，但在一些BSD平台上不得不用，因为BSD的libcs完全不可用)的时候，coro无法生成fork。解决办法：修复glibc然后用snner后端。</p>
<ul>
  <li>每个进程的仿真(线程)</li>
</ul>
<p>这个模块不是perl的伪线程安全。所以你只能在第一个线程里使用coro(未来的版本可能去掉这个要求，实现每个线程自己的schedule，不过当前Coro::State模块还不支持)。我建议关闭线程支持使用进程。因为开启windows进程仿真后，插入速度只有perl代码的一半。</p>
<p>注意，使用另一个进程创建出来的线程会崩溃(报错是空指针)。</p>
<ul>
  <li>coro切换不是信号安全的</li>
</ul>
<p>你千万不要从一个处理sighal句柄的进程(指的是%SIG，大多数事件库都提供安全的信号)里切换到其他coro线程。_除非_你确信自己的做法不会中断Coro函数！</p>
<p>也就是说，你_绝对不_能调用任何可能阻塞当前coro的函数 —— <code>cede</code>，<code>schedule</code>，<code>Coro::Semaphore-&gt;down</code>或者其他使用了这些的函数。其他的命令，比如<code>ready</code>，则没问题。</p>
<h1 id="windows">windows进程仿真</h1>
<p>太多人看起来都对ithreads比较困惑（比如Chip Salzenberg就说我“无知，无能，愚蠢，上当了！”，而同一封邮件里他对perl的ithreads也是各种模糊的说法(比如说文件或者内存必须共享)，这说明他在这方面了解甚微——如果对Chip来说这都很难理解，估计对所有人都没那么容易搞明白的）。</p>
<p>下面贴一段我在2009年perl聚会上分享的《脚本语言中的线程》的超浓缩版：</p>
<p>所谓的“ithreads”最初是为了这两个理由才实现的：第一，在原生win32平台的perl上模拟unix进程；第二，替代旧的，真正的线程模型(&ldquo;5.005-threads&rdquo;)。</p>
<p>最后的实现用线程替代了操作系统进程。进程和线程的区别是：同一个进程内的线程间是共享内存的（以及其他状态，比如文件）。而进程间可不会共享任何东西（至少语义上不会）。也就是说一个线程做的修改可以是其他线程可见的，而进程的修改是其他进程不可见的。</p>
<p>“ithreads”就是这样工作的：创建新的ithreads进程时，所有状态都被复制（内存是物理上实际复制，文件和代码是逻辑上的复制）。然后，所有修改被隔离。在UNIX上，这个行为是通过操作系统进程实现的。不过UNIX通常会使用构建进系统的硬件来有效的做到这点。而windows进程仿真是通过软件模拟这个硬件操作(也很有效，不过当然还是比硬件慢很多)。</p>
<p>所以，如上面说过的，加载代码，修改代码，修改数据结构，都只是所属ithreads内部可见。同一个OS进程内的其他ithreads是看不到的。</p>
<p>这就是为什么“ithreads”根本没有给perl实现线程，而依然是进程的原因。在非windows平台上，它表现相当糟糕，就是因为你完全可以利用硬件定制的优势(比如fork模块，它可以给你(i-)threads的API，而且快很多)。</p>
<p>要在ithreads模型里共享数据，只能在线程间通过缓慢的复制语义来传输数据结构——共享数据是不存在的。</p>
<p>i-threads交互密集型的基准测试显示结果相当糟糕（事实上糟糕到了没法直接利用多核优势的Coro都比它快上数量级。因为Coro可以在线程间共享数据，详见我的分享）。</p>
<p>综上所述，i-threads是用线程来实现了进程，也就是用fork的进程来模拟，嗯，进程。启用i-threads完全是拖累perl程序的运行，在非windows平台下完全没有（顶多算微乎其微的有）实用性，反而是损害那些单线程的perl程序。</p>
<p>这就是我避免用&rdquo;ithreads&rdquo;这个名字的原因，因为这完全是误导，听起来就跟它为perl实现了某种线程模型似的。我更喜欢的是“windows进程模拟”这个名字，这才更准确和真实的描述了它的实际作用和行为。</p>
<h1 id="section-8">另见</h1>
<p>事件循环集合: <a href="http://search.cpan.org/perldoc?Coro::AnyEvent">Coro::AnyEvent</a>，<a href="http://search.cpan.org/perldoc?Coro::EV">Coro::EV</a>，<a href="http://search.cpan.org/perldoc?Coro::Event">Coro::Event</a>。</p>
<p>调试: <a href="http://search.cpan.org/perldoc?Coro::Debug">Coro::Debug</a>。</p>
<p>支持/实用工具: <a href="http://search.cpan.org/perldoc?Coro::Specific">Coro::Specific</a>，<a href="http://search.cpan.org/perldoc?Coro::Util">Coro::Util</a>。</p>
<p>锁和过程间通信: <a href="http://search.cpan.org/perldoc?Coro::Signal">Coro::Signal</a>，<a href="http://search.cpan.org/perldoc?Coro::Channel">Coro::Channel</a>，<a href="http://search.cpan.org/perldoc?Coro::Semaphore">Coro::Semaphore</a>，<coro::semaphoreset>，[Coro::RWLock](http://search.cpan.org/perldoc?Coro::RWLock)。</coro::semaphoreset></p>
<p>I/O和定时器: <a href="http://search.cpan.org/perldoc?Coro::Timer">Coro::Timer</a>，<a href="http://search.cpan.org/perldoc?Coro::Handle">Coro::Handle</a>，<a href="http://search.cpan.org/perldoc?Coro::Socket">Coro::Socket</a>，<a href="http://search.cpan.org/perldoc?Coro::AIO">Coro::AIO</a>。</p>
<p>和其他模块的结合: <a href="http://search.cpan.org/perldoc?Coro::LWP">Coro::LWP</a>(不过实用的话建议选择<a href="http://search.cpan.org/perldoc?AnyEvent::HTTP">AnyEvent::HTTP</a>)，<a href="http://search.cpan.org/perldoc?Coro::BDB">Coro::BDB</a>，<a href="http://search.cpan.org/perldoc?Coro::Storable">Coro::Storable</a>，<a href="http://search.cpan.org/perldoc?Coro::Select">Coro::Select</a>。</p>
<p>XS API: <a href="http://search.cpan.org/perldoc?Coro::MakeMaker">Coro::MakeMaker</a>。</p>
<p>底层配置，线程环境及延续机制: <a href="http://search.cpan.org/perldoc?Coro::State">Coro::State</a>。</p>
<h1 id="section-9">作者</h1>
<p>Marc Lehmann <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#115;&#099;&#104;&#109;&#111;&#114;&#112;&#064;&#115;&#099;&#104;&#109;&#111;&#114;&#112;&#046;&#100;&#101;">&#115;&#099;&#104;&#109;&#111;&#114;&#112;&#064;&#115;&#099;&#104;&#109;&#111;&#114;&#112;&#046;&#100;&#101;</a>
http://home.schmorp.de/</p>
      <a href="/2012/11/18/coro" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/11/09/chrome-app-demo" title="Chrome的APP简单用法" rel="bookmark">Chrome的APP简单用法</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-11-09 00:00:00 +0800">09 Nov 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>学习一下简单的chrome app写法。首先，chrome的ext和web app和packaged app就要分清楚。简单说，ext就是可以出现在地址栏右侧的，app是可以出现在任务栏右侧的。而web app其实就是用json描述了一个url地址，packaged app则是最接近普通桌面程序的，需要完整的带有html/css/js等内容。但同时，因为packaged app可以在关闭chrome浏览器后运行，所以有些浏览器上的API它也用不了。</p>
<p>首先上一个web app的demo，只要一个manifest.json在本地就够了。关键点是app里指定为url，permissions指定需要的权限。</p>
<div class="highlight"><pre><code class="javascript"><span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;WebApp&quot;</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;0.1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;app&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;urls&quot;</span><span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;http://www.domain.com/chrome/&quot;</span> <span class="p">],</span>
    <span class="s2">&quot;launch&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;web_url&quot;</span><span class="o">:</span> <span class="s2">&quot;http://www.domain.com/chrome/index.html&quot;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;permissions&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">,</span> <span class="s2">&quot;notifications&quot;</span><span class="p">],</span>
  <span class="s2">&quot;manifest_version&quot;</span><span class="o">:</span> <span class="mi">2</span>
<span class="p">}</span>
</code></pre></div>
<p>然后余下的事情就是web上的了。在<code>http://www.domain.com/chrome/index.html</code>里定义内容。比如我这是这样：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;&lt;head&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;openBackgroundWindow&quot;</span><span class="nt">&gt;</span>开启后台运行<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;closeBackgroundWindow&quot;</span><span class="nt">&gt;</span>关闭后台运行<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;index.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>然后把事情交给index.js来完成。这也是chrome app的通常做法，尽量拆分干净，尤其到packaged app的时候，压根就不让你在html里写script了。index.js如下：</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">bgWinUrl</span> <span class="o">=</span> <span class="s2">&quot;background.html#yay&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">bgWinName</span> <span class="o">=</span> <span class="s2">&quot;bgNotifier&quot;</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">openBackgroundWindow</span><span class="p">()</span> <span class="p">{</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">bgWinUrl</span><span class="p">,</span> <span class="nx">bgWinName</span><span class="p">,</span> <span class="s2">&quot;background&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">closeBackgroundWindow</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">bgWinUrl</span><span class="p">,</span> <span class="nx">bgWinName</span><span class="p">,</span> <span class="s2">&quot;background&quot;</span><span class="p">);</span>
  <span class="nx">w</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">}</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;DOMContentLoaded&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#openBackgroundWindow&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span>
    <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">openBackgroundWindow</span><span class="p">);</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#closeBackgroundWindow&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span>
    <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">closeBackgroundWindow</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>注意到这里的<code>background.html</code>加了锚点，原因我懒得看英文说明了，反正大意是不写个锚点有时候会出问题。</p>
<p>最后是background.html，内容参见之前博客里写的juggernaut。简单几十行。一个可以不再打开具体页面自动收报警消息的app就改造出来了～～</p>
<p>这时候进一步折腾的想法就出来了：既然叫app嘛，功能应该多一点，不单收报警，还能存下来，这样出去一趟回来可以看离线记录。</p>
<p>下面就说离线的packaged app。</p>
<p><code>manifest.json</code>的app里就不能写urls要写background了。文档中说background可以写scripts或者page，但是我实验发现scripts正常page不起作用(也确实不报错)。</p>
<div class="highlight"><pre><code class="javascript"><span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Packaged App&quot;</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;0.1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;app&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;background&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;scripts&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;juggernaut.js&quot;</span><span class="p">,</span> <span class="s2">&quot;filesystem.js&quot;</span><span class="p">,</span> <span class="s2">&quot;background.js&quot;</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;permissions&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">,</span> <span class="s2">&quot;notifications&quot;</span><span class="p">,</span> <span class="s2">&quot;unlimitedStorage&quot;</span><span class="p">],</span>
  <span class="s2">&quot;manifest_version&quot;</span><span class="o">:</span> <span class="mi">2</span>
<span class="p">}</span>
</code></pre></div>
<p>chrome app会自动把scripts数组<code>依次</code>加载。
这里需要注意修改一下默认的juggernaut/application.js，因为chrome packaged app没有浏览器框架，所以disconnect那有个报错，删除掉那三行即可。
然后background.js里最常见的功能是当点击app的时候弹出的页面，代码如下：</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">chrome</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">onLaunched</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">chrome</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s1">&#39;main.html&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="mi">400</span><span class="p">,</span>
    <span class="s1">&#39;height&#39;</span><span class="o">:</span> <span class="mi">500</span><span class="p">,</span>
    <span class="c1">//frame: &#39;none&#39;</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>如果css够好，可以开启<code>frame: none</code>，然后页面看不到一丝浏览器的样子，你就可以做得跟真的app一样有自己的控制了。</p>
<p>然后是文件操作。html5有file api。所以可以直接操作文件了：</p>
<div class="highlight"><pre><code class="javascript"><span class="nb">window</span><span class="p">.</span><span class="nx">webkitRequestFileSystem</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">TEMPORARY</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fs</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">getFile</span><span class="p">(</span><span class="s2">&quot;syslog.txt&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">create</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileEntry</span><span class="p">){</span>
        <span class="nx">fileEntry</span><span class="p">.</span><span class="nx">createWriter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fileWriter</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">bb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="s2">&quot;New File Ready\n&quot;</span><span class="p">],</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
            <span class="nx">fileWriter</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">bb</span><span class="p">);</span>
        <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
<span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
<span class="kd">function</span> <span class="nx">append_file</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">webkitRequestFileSystem</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">TEMPORARY</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fs</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">getFile</span><span class="p">(</span><span class="s2">&quot;syslog.txt&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">create</span><span class="o">:</span> <span class="kc">false</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileEntry</span><span class="p">){</span>
            <span class="nx">fileEntry</span><span class="p">.</span><span class="nx">createWriter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fileWriter</span><span class="p">){</span>
                <span class="nx">fileWriter</span><span class="p">.</span><span class="nx">seek</span><span class="p">(</span><span class="nx">fileWriter</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">bb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">msg</span><span class="p">],</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
                <span class="nx">fileWriter</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">bb</span><span class="p">);</span>
            <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
        <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>这里大多数网上的例子都还是用的<code>BlobBuilder()</code>，经过我试验，至少在chromium version24上，已经没有这个API了。</p>
<p>这里注意一个问题：Juggernaut同时收到多条消息，调用append_file()的话，会有文件锁问题。所以我加上一个缓冲控制：</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">message</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">append_file</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="mi">60000</span><span class="p">);</span>
<span class="nx">jug</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s2">&quot;syslog&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span><span class="p">;</span>
    <span class="nx">message</span> <span class="o">+=</span> <span class="nx">msg</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="nx">notification</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div>
<p>后台的工作大概就是这些。然后是弹出的main.html。记住之前提到的，不能在里面写js。所以html里除了写个div啥都没有，功能依然交给main.js来做：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;title&gt;</span>Storage test<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;main.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;bar&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">&quot;form&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;reload-window-button&quot;</span><span class="nt">&gt;</span>刷新<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;remove-window-button&quot;</span><span class="nt">&gt;</span>清空<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;close-window-button&quot;</span><span class="nt">&gt;</span>关闭<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&#39;log&#39;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">&#39;msg&#39;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>不过关于刷新页面的问题现在还比较茫然，试过metadata/reload/location.href等各种办法，都不起作用，只能在页面上右键选择刷新……</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">channel_file</span> <span class="o">=</span> <span class="s1">&#39;syslog.txt&#39;</span><span class="p">;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">webkitRequestFileSystem</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">TEMPORARY</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fs</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">getFile</span><span class="p">(</span><span class="nx">channel_file</span><span class="p">,</span> <span class="p">{},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileEntry</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fileEntry</span><span class="p">.</span><span class="nx">file</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
            <span class="nx">reader</span><span class="p">.</span><span class="nx">onloadend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">logul</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">logli</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">);</span>
                <span class="nx">logli</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
                <span class="nx">logul</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">logli</span><span class="p">,</span> <span class="nx">logul</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
            <span class="p">};</span>
            <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsText</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
            <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
        <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;remove-window-button&quot;</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">webkitRequestFileSystem</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">TEMPORARY</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fs</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fs</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">getFile</span><span class="p">(</span><span class="nx">channel_file</span><span class="p">,</span> <span class="p">{</span><span class="nx">create</span><span class="o">:</span> <span class="kc">false</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileEntry</span><span class="p">){</span>
                <span class="nx">fileEntry</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                    <span class="nx">fs</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">getFile</span><span class="p">(</span><span class="nx">channel_file</span><span class="p">,</span> <span class="p">{</span><span class="nx">create</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileEntry</span><span class="p">){</span>
                        <span class="nx">fileEntry</span><span class="p">.</span><span class="nx">createWriter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fileWriter</span><span class="p">){</span>
                            <span class="kd">var</span> <span class="nx">bb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="s2">&quot;Clean Over\n&quot;</span><span class="p">],</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
                            <span class="nx">fileWriter</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">bb</span><span class="p">);</span>
                        <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
                    <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
                <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
            <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
        <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;close-window-button&quot;</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;reload-window-button&quot;</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>以上。</p>
<p>最后，如果完成了，在浏览器上直接选择打包即可。不过新版本的chrome已经不再允许直接安装非web store的crx了……</p>
      <a href="/2012/11/09/chrome-app-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/10/30/faraday-select-rand-node-for-logstash-output-elasticsearch-http" title="【Logstash系列】Outputs::ElasticsearchHTTP自动获取随机node" rel="bookmark">【Logstash系列】Outputs::ElasticsearchHTTP自动获取随机node</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-10-30 00:00:00 +0800">30 Oct 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>今天在ES群中和medcl请教了一下index的性能问题。基本上在bulk的基础上，还有几点是可以做的。当然medcl说的是正常的全文索引的场景：</p>
<ul>
  <li>不用http协议，直接走tcp层，维护一个pool发bulk；</li>
  <li>多台node的情况下，在bulk前先设置replica为0；bulk完成后再调整replica；</li>
  <li>因为es会自动路由，所以index请求可以分散开直接发给多个node。</li>
</ul>
<p>总之，就是减少集群内部的网络传输。</p>
<p>介于logstash的应用是一直持续往es写数据的，所以replica调整这招用不上，顶多加大refresh时间而已。所以可以动手的地方主要就是第三条了。</p>
<p>正好去翻了一下perl的Elasticsearch.pm的POD。发现原来perl模块本色默认就是这么做的。new的时候定义的server，是用来发送请求获取集群所有alive的nodes。然后会从这个nodes列表里选择(随机)一个创建真正的链接返回。获取nodes的API如下：</p>
<div class="highlight"><pre><code class="bash">curl http://192.168.1.33:9200/_cluster/nodes?pretty<span class="o">=</span>1
<span class="o">{</span>
  <span class="s2">&quot;ok&quot;</span> : <span class="nb">true</span>,
  <span class="s2">&quot;cluster_name&quot;</span> : <span class="s2">&quot;logstash&quot;</span>,
  <span class="s2">&quot;nodes&quot;</span> : <span class="o">{</span>
    <span class="s2">&quot;he6ipuA3SDeNmOQYIr-bjg&quot;</span> : <span class="o">{</span>
      <span class="s2">&quot;name&quot;</span> : <span class="s2">&quot;Afari, Jamal&quot;</span>,
      <span class="s2">&quot;transport_address&quot;</span> : <span class="s2">&quot;inet[/192.168.1.33:9300]&quot;</span>,
      <span class="s2">&quot;hostname&quot;</span> : <span class="s2">&quot;ES-33.domain.com&quot;</span>,
      <span class="s2">&quot;http_address&quot;</span> : <span class="s2">&quot;inet[/192.168.1.33:9200]&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;WXK68VX0ThmNnozq0uioQw&quot;</span> : <span class="o">{</span>
      <span class="s2">&quot;name&quot;</span> : <span class="s2">&quot;Harker, Quincy&quot;</span>,
      <span class="s2">&quot;transport_address&quot;</span> : <span class="s2">&quot;inet[/192.168.1.68:9300]&quot;</span>,
      <span class="s2">&quot;hostname&quot;</span> : <span class="s2">&quot;ES-68.domain.com&quot;</span>,
      <span class="s2">&quot;http_address&quot;</span> : <span class="s2">&quot;inet[/192.168.1.68:9200]&quot;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>这样显然可以在cluster较大的时候分担index的压力(search的时候压力在集群本身的cpu上)。我打算给我的pure-ruby branch里的faraday版的Logstash::Outputs::ElasticsearchHTTP也加上这个功能。</p>
<hr />
<p>大致简单实现如下：</p>
<div class="highlight"><pre><code class="ruby">  <span class="k">def</span> <span class="nf">select_rand_host</span>
    <span class="nb">require</span> <span class="s2">&quot;json&quot;</span>
    <span class="k">begin</span>
      <span class="n">response</span> <span class="o">=</span> <span class="vi">@agent</span><span class="o">.</span><span class="n">get</span> <span class="s1">&#39;/_cluster/nodes&#39;</span>
      <span class="n">nodelist</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">[</span><span class="s1">&#39;nodes&#39;</span><span class="o">].</span><span class="n">values</span>
      <span class="n">livenode</span> <span class="o">=</span> <span class="n">nodelist</span><span class="o">[</span><span class="nb">rand</span><span class="p">(</span><span class="n">nodelist</span><span class="o">.</span><span class="n">length</span><span class="p">)</span><span class="o">][</span><span class="s2">&quot;http_address&quot;</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="sr">/\[|\]/</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
      <span class="vi">@agent</span> <span class="o">=</span> <span class="no">Faraday</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:url</span> <span class="o">=&gt;</span> <span class="s2">&quot;http:/</span><span class="si">#{</span><span class="n">livenode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">faraday</span><span class="o">|</span>
        <span class="n">faraday</span><span class="o">.</span><span class="n">use</span> <span class="ss">Faraday</span><span class="p">:</span><span class="ss">:Adapter</span><span class="o">::</span><span class="no">EMHttp</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div>
<p>然后在<code>def register</code>里和<code>def flush</code>的<code>retry</code>前面都加上<code>select_rand_host()</code>就好了。当然比起perl的ElasticSearch::Transport里各种检查各种排除，我这个还是简单多了……
另，在Ruby1.9里从数组返回随机元素可以直接调用<code>.sample</code>，真赞。不过谁让我都是1.8.7的版本呢……</p>
<p><strong>2012 年 12 月 30 日附注：</strong></p>
<p>之后我在 maillist 里联系了 logstash 的作者。不过作者表示：第一，需要自选 node 功能的，建议使用 output/elasticsearch 因为这个是用的 java 客户端，直接会把自己作为一个 node 加入 ES 的 cluster。第二，ruby 的 http 模块他都不喜欢，所以全部项目里的相关部分他都只用自己写的 ftw 模块 ==!</p>
<p><strong>2013 年 02 月 26 日附注：</strong></p>
<p>最新版的 Logstash::Outputs::ElasticSearchHTTP 已经加入随机选择 node 功能。是其他网友在 ftw 模块基础上添加的。</p>
      <a href="/2012/10/30/faraday-select-rand-node-for-logstash-output-elasticsearch-http" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/10/26/systemtap-and-file-descriptor" title="用systemtap调试文件描述符限制" rel="bookmark">用systemtap调试文件描述符限制</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-10-26 00:00:00 +0800">26 Oct 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在运行一些非root用户进程的时候，我们都习惯要在前面加上一个ulimit -HSn 65535的命令。而且我们还知道关于文件描述符的限制，不止这一个地方，还有limits.conf，sysctl -w fs.file-max等等。但是到底这些是什么个关系呢？而且，如果是一个已经在运行的程序，有没有可能在更改他的文件描述符限制呢？</p>
<p>以最经常碰到这种情况的squid为例。我们可以在squid/src/comm.c里看到<code>comm_openex()</code>是如何发现超出限制的，嗯，可以说没有&rdquo;自己发现&rdquo;，直接判断socket()是否成功而已。所以接下来的事情是看socket创建过程怎么判断的。</p>
<p>关于socket过程，主要看kernel/net/socket.c和kernel/fs/file.c，作为C菜鸟，如下系列博文在这方面说的非常清楚，我就不详细说了：</p>
<p><a href="http://blog.chinaunix.net/uid-23629988-id-3080166.html">TCP/IP源码学习(47)——socket与VFS的关联(1)</a></p>
<p><a href="http://blog.chinaunix.net/uid-23629988-id-3083376.html">TCP/IP源码学习(48)——socket与VFS的关联(2)</a></p>
<p>大体来说，就是socket本身是不触及这个限制的，但是创建出来的socket必须和文件描述符关联起来(<code>sock_map_fd()</code> &ndash; <code>sock_alloc_file()</code> &ndash; <code>get_unused_fd_flags()</code> &ndash; <code>alloc_fd()</code>)，这就相关了。在<code>alloc_fd()</code>中会读取当前进程(current)的fdtable，fdtable的结构由&rdquo;linux/fdtable.h&rdquo;定义如下：</p>
<div class="highlight"><pre><code class="c">    <span class="k">struct</span> <span class="n">fdtable</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_fds</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">file</span> <span class="o">**</span> <span class="n">fd</span><span class="p">;</span>      <span class="cm">/* current fd array */</span>
        <span class="n">fd_set</span> <span class="o">*</span><span class="n">close_on_exec</span><span class="p">;</span>
        <span class="n">fd_set</span> <span class="o">*</span><span class="n">open_fds</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">fdtable</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">struct</span> <span class="n">files_struct</span> <span class="p">{</span>
        <span class="kt">atomic_t</span> <span class="n">count</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">fdtable</span> <span class="o">*</span><span class="n">fdt</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">fdtable</span> <span class="n">fdtab</span><span class="p">;</span>
        <span class="kt">spinlock_t</span> <span class="n">file_lock</span> <span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">next_fd</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">embedded_fd_set</span> <span class="n">close_on_exec_init</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">embedded_fd_set</span> <span class="n">open_fds_init</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">fd_array</span><span class="p">[</span><span class="n">NR_OPEN_DEFAULT</span><span class="p">];</span>
    <span class="p">};</span>
    <span class="err">#</span><span class="n">define</span> <span class="n">files_fdtable</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="p">(</span><span class="n">rcu_dereference</span><span class="p">((</span><span class="n">files</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fdt</span><span class="p">))</span>
</code></pre></div>
<p>打开fd的过程如下：</p>
<ol>
  <li>如果有files-&gt;next_fd，直接使用;</li>
  <li>否则从fdtable-&gt;open_fds-&gt;fds_bits[]找到fdtable-&gt;max_fds，到找到一个可用的为止;</li>
  <li>否则说明当前fdtable不够用，需要扩充expand_files();</li>
  <li>完成后把获得的fd+1赋值给files-&gt;next_fd，这样下次就可以直接用;</li>
  <li>最后把这个fd加入fdtable-&gt;open_fds里。</li>
</ol>
<p>那么涉及max open files的显然就是这个<code>expand_files()</code>了。继续看，可以发现其中的判断分三部分：</p>
<ol>
  <li>if (nr &gt;= current-&gt;signal-&gt;rlim[RLIMIT_NOFILE].rlim_cur)</li>
  <li>if (nr &lt; fdt-&gt;max_fds)</li>
  <li>if (nr &gt;= sysctl_nr_open)</li>
</ol>
<p>都逃过之后才进入<code>expand_fdtable()</code>真正扩展。很好，现在我们看到之前就知道的ulimit/sysctl神马的是怎么限定的了。那么这第二个呢？我们可以找到files这个结构的init，如下：</p>
<div class="highlight"><pre><code class="c">    <span class="k">struct</span> <span class="n">files_struct</span> <span class="n">init_files</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">count</span>          <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">.</span><span class="n">fdt</span>            <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_files</span><span class="p">.</span><span class="n">fdtab</span><span class="p">,</span>
        <span class="p">.</span><span class="n">fdtab</span>          <span class="o">=</span> <span class="p">{</span>
            <span class="p">.</span><span class="n">max_fds</span>        <span class="o">=</span> <span class="n">NR_OPEN_DEFAULT</span><span class="p">,</span>
            <span class="p">.</span><span class="n">fd</span>             <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_files</span><span class="p">.</span><span class="n">fd_array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">.</span><span class="n">close_on_exec</span>  <span class="o">=</span> <span class="p">(</span><span class="n">fd_set</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">init_files</span><span class="p">.</span><span class="n">close_on_exec_init</span><span class="p">,</span>
            <span class="p">.</span><span class="n">open_fds</span>       <span class="o">=</span> <span class="p">(</span><span class="n">fd_set</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">init_files</span><span class="p">.</span><span class="n">open_fds_init</span><span class="p">,</span>
            <span class="p">.</span><span class="n">rcu</span>            <span class="o">=</span> <span class="n">RCU_HEAD_INIT</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">.</span><span class="n">file_lock</span>      <span class="o">=</span> <span class="n">__SPIN_LOCK_UNLOCKED</span><span class="p">(</span><span class="n">init_task</span><span class="p">.</span><span class="n">file_lock</span><span class="p">),</span>
    <span class="p">};</span>
</code></pre></div>
<p>这个<code>NR_OPEN_DEFAULT</code>可以在fdtable.h里看到就是<code>BITS_PER_LONG</code>。<code>BITS_PER_LONG</code>应该是32或者64，取决于CPU是32还是64位的了。</p>
<p>其实这里还可以继续看<code>alloc_fdtable()</code>中怎么确定新扩展的<code>fdt-&gt;max_fds</code>的，如果nr大于sysctl的设定，那么nr会计算成</p>
<div class="highlight"><pre><code class="c">    <span class="p">((</span><span class="n">sysctl_nr_open</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div>
<p>然后<code>copy_fdtable()</code>转移数据，奇怪的是看到转移完后，还判断了原有<code>fdt-&gt;max_fds &gt; NR_OPEN_DEFAULT</code>才释放，我不清楚什么情况下会有<code>fdt-&gt;max_fds</code>小于init值了&hellip;</p>
<p>回到主题。三个条件里后两个条件都很明白了。现在就是第一个，这是根据current不同有不同的，我们可以试试看如果修改这个值会怎么样？</p>
<p>修改工具我用到了systemtap大神器，不过我是菜鸟啦～脚本如下：</p>
<div class="highlight"><pre><code class="c">    <span class="err">#</span><span class="o">!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">stap</span>
    <span class="o">%</span><span class="p">{</span>
    <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">linux</span><span class="o">/</span><span class="n">sched</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
    <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">linux</span><span class="o">/</span><span class="n">resource</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
    <span class="o">%</span><span class="p">}</span>
    <span class="n">probe</span> <span class="n">begin</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;begin...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">probe</span> <span class="n">kernel</span><span class="p">.</span><span class="n">function</span><span class="p">(</span><span class="s">&quot;expand_files@fs/file.c&quot;</span><span class="p">).</span><span class="n">call</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">execname</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;squid&quot;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[%s] %s fdt:%d, task:%d, rlim:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tz_ctime</span><span class="p">(</span><span class="n">gettimeofday_s</span><span class="p">()),</span> <span class="n">execname</span><span class="p">(),</span> <span class="err">$</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">fdtab</span><span class="o">-&gt;</span><span class="n">max_fds</span><span class="p">,</span> <span class="n">task_open_file_handles</span><span class="p">(</span><span class="n">task_current</span><span class="p">()),</span> <span class="n">rlim_cur</span><span class="p">());</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">args_nr: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="err">$</span><span class="n">nr</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">rlim_cur</span><span class="p">()</span> <span class="o">&lt;</span> <span class="err">$</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">set rlim: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">set_rlim_cur</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">));</span>
                <span class="n">exit</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">probe</span> <span class="n">kernel</span><span class="p">.</span><span class="n">function</span><span class="p">(</span><span class="s">&quot;expand_files@fs/file.c&quot;</span><span class="p">).</span><span class="k">return</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">execname</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;squid&quot;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">return: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="err">$</span><span class="k">return</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">probe</span> <span class="n">kernel</span><span class="p">.</span><span class="n">function</span><span class="p">(</span><span class="s">&quot;expand_fdtable&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s call fdtable with %s&quot;</span><span class="p">,</span> <span class="n">execname</span><span class="p">(),</span> <span class="err">$$</span><span class="n">vars</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">function</span> <span class="n">rlim_cur</span><span class="o">:</span><span class="kt">long</span> <span class="p">()</span>
    <span class="o">%</span><span class="p">{</span> <span class="cm">/* pure */</span> <span class="cm">/* unprivileged */</span>
        <span class="k">struct</span> <span class="n">signal_struct</span> <span class="o">*</span><span class="n">ss</span> <span class="o">=</span> <span class="n">kread</span><span class="p">(</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">)</span> <span class="p">);</span>
        <span class="n">THIS</span><span class="o">-&gt;</span><span class="n">__retvalue</span> <span class="o">=</span> <span class="n">kread</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">rlim</span><span class="p">[</span><span class="n">RLIMIT_NOFILE</span><span class="p">].</span><span class="n">rlim_cur</span><span class="p">));</span>
        <span class="n">CATCH_DEREF_FAULT</span><span class="p">();</span>
    <span class="o">%</span><span class="p">}</span>
    <span class="n">function</span> <span class="n">set_rlim_cur</span><span class="o">:</span><span class="kt">long</span> <span class="p">(</span><span class="n">val</span><span class="o">:</span><span class="kt">long</span><span class="p">)</span>
    <span class="o">%</span><span class="p">{</span> <span class="cm">/* pure */</span> <span class="cm">/* unprivileged */</span>
        <span class="k">struct</span> <span class="n">signal_struct</span> <span class="o">*</span><span class="n">ss</span> <span class="o">=</span> <span class="n">kread</span><span class="p">(</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">)</span> <span class="p">);</span>
        <span class="n">kwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">rlim</span><span class="p">[</span><span class="n">RLIMIT_NOFILE</span><span class="p">].</span><span class="n">rlim_cur</span><span class="p">),</span> <span class="n">THIS</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
        <span class="n">CATCH_DEREF_FAULT</span><span class="p">();</span>
    <span class="o">%</span><span class="p">}</span>
</code></pre></div>
<p>systemtap自己提供了一系列tapset函数，比如这里的execname(),task_*都是。注意systemtap是脚本语言的，所以这些函数直接在/usr/share/systemtap/下面可以看怎么写的。比如我上面定义的两个function就是仿照里面<code>task_max_file_handles()</code>写的。</p>
<p>用%和{}标记的是内嵌C代码，systemtap在编译成C的时候直接插入进去，可以stap -k保留在/tmp/stap123456下查看的到。</p>
<p>kread/kwrite是systemtap-runtime提供的函数，封装的是put_user/get_user指令。</p>
<p>现在我们启动squid进程和stap脚本：</p>
<div class="highlight"><pre><code class="bash">    <span class="nb">ulimit</span> -HSn 256;squid -D
    stap -g max_fds.stp 1024
</code></pre></div>
<p>注意要加-g，否则不会加载内嵌C的。
另开窗口发起一次请求，然后看到stap输出：</p>
<pre><code>begin...
[Fri Oct 26 19:20:34 2012 CST] squid fdt:64, task:16, rlim:256
        args_nr: 12
        set rlim: 0
</code></pre>
<p>额，这个set是返回值0。function里如果把kwrite的返回值赋给<code>THIS-&gt;retvalue</code>会报void的错误。挺奇怪的。</p>
<p>再运行stap，发起请求，就可以看到squid的rlim变成1024了：</p>
<pre><code>begin...
[Fri Oct 26 19:24:40 2012 CST] squid fdt:64, task:16, rlim:1024
        args_nr: 12
        return: 0
[Fri Oct 26 19:24:40 2012 CST] squid fdt:64, task:17, rlim:1024
        args_nr: 17
        return: 0
</code></pre>
<p>不过我的虚拟机跑不出这么大的并发，没法超过<code>BITS_PER_LONG</code>的64。所以我们可以换一个思路来验证<code>expand_files()</code>的执行。</p>
<ul>
  <li>先ulimit -HSn 16启动squid，然后stap修改到1024</li>
</ul>
<p>这个时候，搞笑而现实的事情发生了。nr越过了1024的判断，却越不过<code>BITS_PER_LONG</code>的判断，于是<code>expand_files</code>永远过不去。squid的max open files只能停留在16。这一步的return是0。所以看到stap里.return{}打印的是0。</p>
<ul>
  <li>先ulimit -HSn 1024启动squid，然后stap修改到16</li>
</ul>
<p>这个时候，由之前的测试可以看到，squid本身就要用掉十多个fd来维护运行的。所以基本一接请求nr就超过16了。squid完全无法响应请求。这一步的return是-EMFILE，于是屏幕上开始出现一行行squid call fdtable {.n}&hellip;&hellip;&hellip;</p>
<p>附注：使用systemtap需要debuginfo。内核调试需要kernel-debuginfo/kernel-devel，程序也需要。如果是自己编译的，没问题直接probe process(&ldquo;${path}/command&rdquo;)即可，如果是rpm安装的，那就必须得把debuginfo包安装上，比如nginx-debuginfo.rpm这样子。</p>
<p>2012年12月3日更新：</p>
<p>采用tc延时的办法，可以达到在虚拟机上获取squid高连接的模拟环境。然后作出如下修正：</p>
<ul>
  <li>在修改<code>rlim_cur</code>的时候也需要修改<code>rlim_max</code></li>
</ul>
<p>在上面的缩小测试里不会触发问题，不过在增大的测试中，问题来了——<code>setrlimit()</code>函数会很诧异为毛自己参数里那个<code>&amp;rl</code>的<code>rlim_cur</code>比<code>rlim_max</code>还大？然后悲剧的报出&rdquo;etrlimit(RLIMIT_NOFILE) failed: Invalid argument (22)&rdquo;的错误……</p>
<div class="highlight"><pre><code class="c">    <span class="n">kwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">rlim</span><span class="p">[</span><span class="n">RLIMIT_NOFILE</span><span class="p">].</span><span class="n">rlim_max</span><span class="p">),</span> <span class="n">THIS</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
</code></pre></div>
<ul>
  <li>对于squid还需要修改<code>Squid_MaxFD</code>全局变量</li>
</ul>
<p>上面都是对kernel里的socket和file的修改，在实际运用中，用户程序本身也会有各种判断。squid维护了一堆全局变量，比如<code>Squid_MaxFD</code>，<code>Biggest_FD</code>和<code>Number_FD</code>，这就是squidclient mgr:info里看到的关于文件描述符的那几个值。其中<code>Squid_MaxFD</code>是在init的时候根据主进程启动时的ulimit情况一次性设定的，即便child进程重启也不会变。而<code>Biggest_FD</code>则是由<code>fdUpdateBiggest()</code>函数每次更新。不巧的是，里面有这么一句判断：</p>
<div class="highlight"><pre><code class="c">    <span class="n">assert</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="n">Squid_MaxFD</span><span class="p">);</span>
</code></pre></div>
<p>所以，光修改kernel里的限制，socket返回后在更新<code>Biggest_FD</code>时squid会直接挂掉……</p>
<p>下面是修改squid进程里全局变量的办法，和修改kernel其实很类似：</p>
<div class="highlight"><pre><code class="c"><span class="n">probe</span> <span class="nf">process</span><span class="p">(</span><span class="s">&quot;/usr/sbin/squid&quot;</span><span class="p">).</span><span class="n">function</span><span class="p">(</span><span class="s">&quot;fdUpdateBiggest@src/fd.c&quot;</span><span class="p">)</span>        
<span class="p">{</span>                                                                            
    <span class="k">if</span> <span class="p">(</span> <span class="err">$</span><span class="n">Squid_MaxFD</span> <span class="o">&lt;</span> <span class="mi">65535</span> <span class="p">)</span> <span class="p">{</span>                                            
        <span class="err">$</span><span class="n">Squid_MaxFD</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>                                                
    <span class="p">}</span>                                                                        
<span class="p">}</span> 
</code></pre></div>
<p>把上面两个修改加入到之前的文件，然后测试增大ulimit限制(记住ulimit要大于64，否则不起作用哟)，就没问题了。</p>
      <a href="/2012/10/26/systemtap-and-file-descriptor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/10/21/elasticearch-simple-usage" title="【Logstash系列】ElasticSearch的几点使用事项" rel="bookmark">【Logstash系列】ElasticSearch的几点使用事项</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-10-21 00:00:00 +0800">21 Oct 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前已经写过一些ES的使用，也翻译了一篇官网上关于ES存储日志的建议日志。今天稍微总结一下近期以来实践出来的方案。</p>
<h1 id="shardreplica">shard和replica的选择</h1>
<p>在测试期，可以单节点上设置成1 shard + 0 replica的方式，这种的indexing速度是最快的(存疑:我至今没搞清楚ES在index的时候集群&rdquo;应该&rdquo;是比单node快还是慢)。</p>
<p>我曾经按照&rdquo;常理&rdquo;(我想象中的)理解，设定成10 shards + 0 replica，期望能用上并行写双node加倍index，事实上压根没用，而且因为另一台node上有其他负载的原因导致更慢了。</p>
<p>更可怕的是：就在前几天，突然出现一个shard挂了，……毫无办法，整个index全作废了。</p>
<p>所以结论是：无论如何，一定要保证有 &gt; 0 份的replica!! 至于shards，保持默认的5个，或者顶多到20个也就差不多了。在maillist里看到有哥们设了100个，然后苦着脸问性能问题…… 要知道shards的份数是一旦设定不能更改的。</p>
<h1 id="template">template的使用</h1>
<p>刚开始的时候，每次实验都去改/etc/elasticsearch/elasticsearch.yml配置文件。事实上在template里修改settings更方便而且灵活！当然最主要的，还是调节里面的properties设定，合理的控制store和analyze了。</p>
<p>template设定也有多种方法。最简单的就是和存储数据一样POST上去。长期的办法，就是写成json文件放在配置路径里。其中，default配置放在/etc/elasticsearch/下，其他配置放在/etc/elasticsearch/templates/下。举例我现在的一个templates/template-logstash.json内容如下：</p>
<div class="highlight"><pre><code class="json"><span class="p">{</span>
  <span class="nt">&quot;template-logstash&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;template&quot;</span> <span class="p">:</span> <span class="s2">&quot;logstash*&quot;</span><span class="p">,</span>
    <span class="nt">&quot;settings&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;index.number_of_shards&quot;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
      <span class="nt">&quot;number_of_replicas&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nt">&quot;index&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;store&quot;</span> <span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;compress&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;stored&quot;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nt">&quot;tv&quot;</span><span class="p">:</span> <span class="kc">true</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;mappings&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;_default_&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;properties&quot;</span> <span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;dynamic&quot;</span> <span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
        <span class="p">},</span>
      <span class="p">},</span>
      <span class="nt">&quot;loadbalancer&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;_source&quot;</span> <span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;compress&quot;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="nt">&quot;_ttl&quot;</span> <span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;enabled&quot;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nt">&quot;default&quot;</span> <span class="p">:</span> <span class="s2">&quot;10d&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;_all&quot;</span> <span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;enabled&quot;</span> <span class="p">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="nt">&quot;properties&quot;</span> <span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;@fields&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;dynamic&quot;</span> <span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
            <span class="nt">&quot;properties&quot;</span> <span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;client&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                <span class="nt">&quot;index&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_analyzed&quot;</span>
              <span class="p">},</span>
              <span class="nt">&quot;domain&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                <span class="nt">&quot;index&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_analyzed&quot;</span>
              <span class="p">},</span>
              <span class="nt">&quot;oh&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                <span class="nt">&quot;index&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_analyzed&quot;</span>
              <span class="p">},</span>
              <span class="nt">&quot;responsetime&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;double&quot;</span><span class="p">,</span>
              <span class="p">},</span>
              <span class="nt">&quot;size&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;long&quot;</span><span class="p">,</span>
                <span class="nt">&quot;index&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_analyzed&quot;</span>
              <span class="p">},</span>
              <span class="nt">&quot;status&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                <span class="nt">&quot;index&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_analyzed&quot;</span>
              <span class="p">},</span>
              <span class="nt">&quot;upstreamtime&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;double&quot;</span><span class="p">,</span>
              <span class="p">},</span>
              <span class="nt">&quot;url&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                <span class="nt">&quot;index&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_analyzed&quot;</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="nt">&quot;@source&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="nt">&quot;index&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_analyzed&quot;</span>
          <span class="p">},</span>
          <span class="nt">&quot;@timestamp&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span>
            <span class="nt">&quot;format&quot;</span> <span class="p">:</span> <span class="s2">&quot;dateOptionalTime&quot;</span>
          <span class="p">},</span>
          <span class="nt">&quot;@type&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="nt">&quot;index&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_analyzed&quot;</span><span class="p">,</span>
            <span class="nt">&quot;store&quot;</span> <span class="p">:</span> <span class="s2">&quot;no&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>注意：POST 发送的 json 内容比存储的 json 文件内容要少最外层的名字，因为名字是在 url 里体现的。</strong></p>
<h1 id="mapping">mapping简介</h1>
<p>上面template中除了index/shard/replica之外的部分，就是mapping了，大家注意到其中的dynamic，默认情况下，index会在第一条数据进入的时候自动分析这条数据的情况，给每个value找到最恰当的type，然后以此为该index的mapping。之后再PUT上来的数据，格式如果不符合mapping的，也能存储成功，但是就无法检索了。</p>
<p>mapping中关于store和compress的部分，之前翻译的<a href="http://chenlinux.com/2012/08/26/translate-using-elasticsearch-for-logs">《用ElasticSearch存储日志》</a>已经说的比较详细了。这里我的建议是 disable 掉 <code>_all</code>，但是 enable 住 <code>_source</code>!! 经过我的惨痛测试，如果连 <code>_source</code> 也 disable 掉的话，一旦你重启进程，整个 index 里除了 <code>_id</code>，<code>_timestamp</code> 和 <code>_score</code> 三个默认字段，啥都丢了……</p>
<h1 id="api">API简介</h1>
<p>ES的API，最基本的就是CRUD操作了，这部分是标准的REST，就不说了。</p>
<p>然后还有三个API比较重要且常用，分别是: bulk/count/search。</p>
<ul>
  <li>Bulk顾名思义，把多个单条的记录合并成一个大数组统一提交，这样避免一条条发送的header解析，索引频繁更新，indexing速度大大提高</li>
  <li>Count根据POST的json，返回命中范围内的总条数。当然没POST时就直接返回该index的总条数了。</li>
  <li>Search根据POST的json或者GET的args，返回命中范围内的数据。这是最重要的部分了。下面说说常用的search API：</li>
</ul>
<h2 id="query">query</h2>
<p>一旦使用search，必须至少提供query参数，然后在这个query的基础上进行接下来其他的检索。query参数又分三类：</p>
<ul>
  <li><code>"match_all" : { }</code> 直接请求全部；</li>
  <li><code>"term"/"text"/"prefix"/"wildcard" : { "key" : "value" }</code> 根据字符串搜索(严格相等/片断/前缀/匹配符);</li>
  <li><code>"range" : { "@timestamp" : { "from" : "now-1d", "to" : "now" } }</code> 根据范围搜索，如果type是时间格式，可以使用内置的now表示当前，然后用-1d/h/m/s来往前推。</li>
</ul>
<h2 id="filter">filter</h2>
<p>上面提到的query的参数，在filter中也都存在。此外，还有比较重要的参数就是连接操作：</p>
<ul>
  <li><code>"or"/"and" : [{"range":{}}, {"prefix":""}]</code> 两个filter的查询，交集或者合集；</li>
  <li><code>"bool" : ["must":{},"must_not":{},"should":{}]</code> 上面的and虽然更快，但是只能支持两个，超过两个的，要用 bool 方法；</li>
  <li><code>"not"/"limit" : {}</code> 取反和限定执行数。注意这个limit和mysql什么的有点不同：它限定的是在每个shards上执行多少条。如果你有5个shards，其实对整个index是limit了5倍大小的设定值。</li>
</ul>
<p>另一点比较关键的是：filter结果默认是不缓存的，如果常用，需要指定 <code>"_cache" : true</code>。</p>
<h2 id="facets">facets</h2>
<p>facets接口可以根据query返回统计数据，最基础的是terms和statistical两种。不过在日志分析的情况下，最常用的是：</p>
<ul>
  <li><code>"histogram" : { "key_field" : "", "value_field" : "", "interval" : "" }</code> 根据时间间隔返回柱状图式的统计数据；</li>
  <li><code>"terms_stats" : { "key_field" : "", "value_field" : "" }</code> 根据key的情况返回value的统计数据，类似group by的意思。</li>
</ul>
<p>这里就涉及到前面mapping里为什么针对每个field都设定type的原因了。因为 <code>histogram</code> 里的 <code>key_field</code> 只能是 <code>dateOptionalTime</code> 格式的，<code>value_field</code> 只能是 <code>string</code> 格式的；而 <code>terms_stats</code> 里的 <code>key_field</code> 只能是 <code>string</code> 格式的，<code>value_field</code> 只能是 <code>numberic</code> 格式的。</p>
<p>而我们都知道，http code那些200/304/400/503神马的，看起来是数字，我们却需要的是他们的count数据，不是算他们的平均数。所以不能由ES动态的认定为long，得指定为string。</p>
<h1 id="analyze">analyze简介</h1>
<p>对于logstash分析日志，基本没有提到analyze的部分，包括Kibana也是。但是做web日志分析，其实也需要注意analyze。因为ES默认提供并开启了一些analyze。最简单的比如空格分隔表示单词，斜线分割表示url路径，@分割表示email地址等等。文档地址见<a href="http://www.elasticsearch.org/guide/reference/index-modules/analysis/">http://www.elasticsearch.org/guide/reference/index-modules/analysis/</a>。当然ES社区的中国人也有提供中文分词的plugin。通常情况下，analyze工作的很好。嗯，ES比其他全文索引工具在默认情况下都工作的好。</p>
<p>但是当你想算的是今天访问的url排名，或者来访者IP排名的时候，麻烦来了，你苦苦等待N久，最后一看排名是这样的：</p>
<pre><code>jpg  2345678
html 123456
20121021 34567
bbs 9876
</code></pre>
<p>对，你的url被ES辛辛苦苦的用 / 和 . 分割了，然后每个单词排序来再返回给你。如果你是在一个数千万条的大型库上运行的话，基本吃个饭回来才能有结果。</p>
<p>事实上，url就是一个整体，所以在mapping中，要定义好在indexing的时候，不要启用analyzer。这样，返回一个你心目中想要的正确的url排名，时间从吃个午饭直接缩减到打个喷嚏了！而如果是访问者ip，时间则是眨下眼就够了！</p>
<p>注意：analyze不是只有indexing的时候能用，在query的时候，也可以单独指定某个analyze来分析记录。analyze其实是和search并列的API，不过目前场景下用不上，就不说了。</p>
<p>有以上API，基本上一个针对logstash的ES数据分析系统后台就足够构建出来了。剩下的就是前端页面的事情，这方面可以参考logstash的Kibana，更广义一些的ES数据可视化可以参考ES的blog: <a href="http://www.elasticsearch.cn/blog/2011/05/13/data-visualization-with-elasticsearch-and-protovis.html">http://www.elasticsearch.cn/blog/2011/05/13/data-visualization-with-elasticsearch-and-protovis.html</a>，笔者的译文见<a href="http://chenlinux.com/2012/11/18/data-visualization-with-elasticsearch-and-protovis">http://chenlinux.com/2012/11/18/data-visualization-with-elasticsearch-and-protovis</a>。</p>
<h1 id="section">性能监控</h1>
<p>ES周边的工具有很多。目前我主要用三种方式：</p>
<ul>
  <li>es_head: 这个主要提供的是健康状态查询，当然标签页里也提供了简单的form给你提交API请求。es_head现在可以直接通过 <code>elasticsearch/bin/plugin -install mobz/elasticsearch-head</code> 安装，然后浏览器里直接输入 <code>http://$eshost:9200/_plugin/head/</code> 就可以看到cluster/node/index/shards的状态了。</li>
  <li>bigdesk: 这个主要提供的是节点的实时状态监控，包括jvm的情况，linux的情况，elasticsearch的情况。排查性能问题的时候很有用，现在也可以通过 <code>elasticsearch/bin/plugin -install lukas-vlcek/bigdesk</code> 直接安装了。然后浏览器里直接输入 <code>http://$eshost:9200/_plugin/bigdesk/</code> 就可以看到了。注意如果使用的 <code>bulk_index</code> 的话，如果选择的刷新间隔太长，indexing per second数据是不准的。</li>
  <li>然后是最基础的办法，通过ES本身的status API获取状态。因为上面都是web工具，如果想要避免上文提到的故障很久才发现的问题，我们需要一个可以提供给nagios使用的办法，这很简单就可以做到。刚巧ES本身也有green/yellow/red等不同的状态。所以很简单完成一个check_es_health.sh如下：</li>
</ul>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/sh</span>
    <span class="nv">ES_HOST</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">ES_URI</span><span class="o">=</span><span class="s2">&quot;http://${ES_HOST}:9200/_cluster/health&quot;</span>
    <span class="nv">RES_JSON</span><span class="o">=</span><span class="sb">`</span>curl -s <span class="k">${</span><span class="nv">ES_URI</span><span class="k">}</span><span class="sb">`</span>
    <span class="nv">status</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">RES_JSON</span><span class="k">}</span>|awk -F<span class="se">\&quot;</span> <span class="s1">&#39;{print $8}&#39;</span><span class="sb">`</span>
    <span class="nv">failed</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">RES_JSON</span><span class="k">}</span>|awk -F<span class="se">\&quot;</span> <span class="s1">&#39;{print $NF}&#39;</span>|sed <span class="s1">&#39;s/^:\([0-9]*\)}/\1/&#39;</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$status&quot;</span> -eq <span class="s2">&quot;green&quot;</span> <span class="o">]]</span>;<span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;ES Cluster OK | failed_node=${failed}&quot;</span>
        <span class="nb">exit </span>0
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$status&quot;</span> -eq <span class="s2">&quot;yellow&quot;</span> <span class="o">]]</span>;<span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Warning! ES Cluster shards relocating or initializing. | failed_node=${failed}&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">else</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Critical! ES Cluster shards unassigned. | failed_node=${failed}&quot;</span>
        <span class="nb">exit </span>2
    <span class="k">fi</span>
</code></pre></div>
<h1 id="section-1">其他插件</h1>
<p>ES是一个很活跃的开源项目，所以如果有其他目前ES没有你有觉得有需要的功能，大可以上github搜索一下，或许别人早已经做完相关插件了。</p>
<p>比如我就在上面找到一个plugin叫elasticfacets。加强了ES的 <code>date_histogram</code> 功能，原先只能针对某个 <code>value_field</code> 做攻击，这个plugin可以在这个基础上，把 <code>value_field</code> 加强成又一层facets。项目地址: <a href="https://github.com/bleskes/elasticfacets">https://github.com/bleskes/elasticfacets</a>。之前和作者反馈了在ES 0.19.8上的问题，不知道修复没。或许最好还是用0.19.9吧。</p>
<h1 id="section-2">邮件列表</h1>
<p>ES的邮件列表基本每天都有四五十封邮件，地址是：<a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#101;&#108;&#097;&#115;&#116;&#105;&#099;&#115;&#101;&#097;&#114;&#099;&#104;&#064;&#103;&#111;&#111;&#103;&#108;&#101;&#103;&#114;&#111;&#117;&#112;&#115;&#046;&#099;&#111;&#109;">&#101;&#108;&#097;&#115;&#116;&#105;&#099;&#115;&#101;&#097;&#114;&#099;&#104;&#064;&#103;&#111;&#111;&#103;&#108;&#101;&#103;&#114;&#111;&#117;&#112;&#115;&#046;&#099;&#111;&#109;</a>。</p>
      <a href="/2012/10/21/elasticearch-simple-usage" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/10/17/juggernaut-for-syslog-check" title="用Juggernaut实时推送syslog分析结果" rel="bookmark">用Juggernaut实时推送syslog分析结果</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-10-17 00:00:00 +0800">17 Oct 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>大家一般都会用rsyslog或者syslog-ng之类的收集系统日志。不过收集之后的处理就各种各样了。这里提供一个简单的处理，按日期保存成文件，然后定时分析新增内容，通过websocket推送到页面报警。这对于像磁盘错误等信息比较有用。因为等nagios之类的监控反应出来，故障可能就已经到你措手不及的地步了。</p>
<p>这里介绍一下Juggernaut项目，作者当初还在上学的时候就开始搞这个项目并最终因为这个项目找到的工作。不过几个月前他宣布不再维护了，因为他觉得html5已经普及，大家直接写websocket就够了。额，在口年的中国，我觉得Juggernaut还是很有意义的。项目地址：<a href="https://github.com/maccman/juggernaut">https://github.com/maccman/juggernaut</a>。</p>
<p>举例中有ruby、js和python的样例，不过既然是用Redis传消息，那么改成perl的代码跟python的比差距也就很小了。</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl</span>
<span class="k">use</span> <span class="n">AnyEvent</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Long</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Redis</span><span class="p">;</span>
<span class="k">use</span> <span class="n">JSON</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw/ strftime /</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="mf">5.010</span><span class="p">;</span>
<span class="c1"># 后台运行</span>
<span class="k">use</span> <span class="nn">App::</span><span class="n">Daemon</span> <span class="sx">qw( daemonize )</span><span class="p">;</span>
<span class="nv">$</span><span class="nn">App::Daemon::</span><span class="nv">as_user</span>    <span class="o">=</span> <span class="s">&quot;root&quot;</span><span class="p">;</span>
<span class="n">daemonize</span><span class="p">();</span>
<span class="c1"># 设定调试和间隔</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">,</span> <span class="nv">$interval</span><span class="p">,</span> <span class="nv">$help</span><span class="p">);</span>                                                                                                                                                        
<span class="n">GetOptions</span><span class="p">(</span>                                                                                                                                                                           
    <span class="s">&quot;debug|d&quot;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$debug</span><span class="p">,</span>                                                                                                                                                             
    <span class="s">&quot;interval|i=i&quot;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$interval</span><span class="p">,</span>                                                                                                                                                     
    <span class="s">&quot;help|h&quot;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$help</span><span class="p">,</span>                                                                                                                                                               
<span class="p">);</span>                                                                                                                                                                                    
<span class="k">if</span><span class="p">(</span> <span class="nv">$help</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">say</span> <span class="s">&quot;Usage: $0 [start|stop|-X] -d -i num&quot;</span><span class="p">;</span>
    <span class="n">say</span> <span class="s">&quot;       -X means run frontend;&quot;</span><span class="p">;</span>
    <span class="n">say</span> <span class="s">&quot;       -d means debug for timer and submit;&quot;</span><span class="p">;</span>
    <span class="n">say</span> <span class="s">&quot;       -i means define a special interval seconds for regexp and submit, default set 300s.&quot;</span><span class="p">;</span>
<span class="p">};</span>
<span class="nv">$interval</span> <span class="o">=</span> <span class="mi">300</span> <span class="k">unless</span> <span class="nv">$interval</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@str</span> <span class="o">=</span> <span class="p">();</span>
<span class="c1"># syslog的pri，定义见http://www.ietf.org/rfc/rfc3164.txt。因为本例只收集kernel信息，即Facility = 0,所以PRI = 0 * 8 + Severity。这里为了页面好看直接写成bootstrap里button的class了。</span>
<span class="k">my</span> <span class="nv">@pri</span> <span class="o">=</span> <span class="sx">qw(</span>
<span class="sx">    btn-inverse</span>
<span class="sx">    btn-danger</span>
<span class="sx">    btn-warning</span>
<span class="sx">    btn-success</span>
<span class="sx">    btn-info</span>
<span class="sx">    btn-primary</span>
<span class="sx">    btn</span>
<span class="sx">    disabled</span>
<span class="sx">)</span><span class="p">;</span>
<span class="c1"># syslog格式&lt;IP&gt; &lt;TIME&gt; &lt;PRI&gt; kernel: &lt;MSG&gt;</span>
<span class="c1"># 注意最后msg里的\S.+，因为当内存出错等情况时，msg里开头会以空格表示附属关系</span>
<span class="k">my</span> <span class="nv">$re</span> <span class="o">=</span> <span class="sx">qr/((?:\d{1,3}\.){3}\d{1,3}) \[(\w+ \d+ \d{2}:\d{2}:\d{2})\] &lt;(\d+)&gt; kernel: (\S.+)/</span><span class="p">;</span>
<span class="c1"># 目前是直接收集成时间格式命名了，所以每天crond里要restart脚本，如果是日志名不变，crond切割的，那么脚本可以一直跑</span>
<span class="nb">open</span><span class="p">(</span><span class="k">my</span> <span class="nv">$r</span><span class="p">,</span> <span class="s">&quot;-|&quot;</span><span class="p">,</span> <span class="s">&quot;tail&quot;</span><span class="p">,</span> <span class="s">&quot;-F&quot;</span><span class="p">,</span> <span class="s">&#39;/data1/syslog/kern.&#39;</span> <span class="o">.</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y%m%d&quot;</span><span class="p">,</span> <span class="nb">localtime</span><span class="p">)</span> <span class="o">.</span> <span class="s">&#39;.log&#39;</span> <span class="p">)</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;can&#39;t fork: $!&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$io</span> <span class="o">=</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">(</span>
    <span class="n">fh</span> <span class="o">=&gt;</span> <span class="nv">$r</span><span class="p">,</span>
    <span class="n">poll</span> <span class="o">=&gt;</span> <span class="s">&quot;r&quot;</span><span class="p">,</span>
    <span class="n">cb</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">$input</span> <span class="o">=</span> <span class="nb">scalar</span> <span class="sr">&lt;$r&gt;</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">if</span> <span class="nv">$input</span> <span class="o">=~</span><span class="sr"> /repeat|suppress|window/</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@str</span><span class="p">,</span> <span class="nv">$input</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">);</span>
<span class="k">my</span> <span class="nv">$w</span> <span class="o">=</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">(</span>
    <span class="n">after</span> <span class="o">=&gt;</span> <span class="nv">$interval</span><span class="p">,</span>
    <span class="n">interval</span> <span class="o">=&gt;</span> <span class="nv">$interval</span><span class="p">,</span>
    <span class="n">cb</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="n">say</span> <span class="s">&quot;######## &quot;</span><span class="p">,</span><span class="nb">time</span> <span class="k">if</span> <span class="nv">$debug</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@str</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">next</span> <span class="k">unless</span> <span class="nv">$_</span> <span class="o">=~</span> <span class="nv">$re</span><span class="p">;</span>
            <span class="k">my</span> <span class="p">(</span> <span class="nv">$ip</span><span class="p">,</span> <span class="nv">$time</span><span class="p">,</span> <span class="nv">$level</span><span class="p">,</span> <span class="nv">$msg</span> <span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="nv">$1</span><span class="p">,</span> <span class="nv">$2</span><span class="p">,</span> <span class="nv">$3</span><span class="p">,</span> <span class="nv">$4</span> <span class="p">);</span>
            <span class="k">next</span> <span class="k">if</span> <span class="nb">exists</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$ip</span><span class="p">};</span>
            <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$ip</span><span class="p">}</span> <span class="o">=</span> <span class="n">classify</span><span class="p">(</span><span class="nv">$msg</span><span class="p">);</span>
            <span class="n">submit</span><span class="p">(</span> <span class="nv">$time</span><span class="p">,</span> <span class="nv">$ip</span><span class="p">,</span> <span class="nv">$pri</span><span class="p">[</span><span class="nv">$level</span><span class="p">],</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$ip</span><span class="p">},</span> <span class="nv">$msg</span> <span class="p">);</span>
        <span class="p">};</span>
        <span class="nv">@str</span> <span class="o">=</span> <span class="p">();</span>
    <span class="p">},</span>
<span class="p">);</span>
<span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">condvar</span><span class="o">-&gt;</span><span class="nb">recv</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">submit</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">@msg</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="n">say</span> <span class="nv">@msg</span> <span class="k">if</span> <span class="nv">$debug</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$redis</span> <span class="o">=</span> <span class="n">Redis</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">server</span> <span class="o">=&gt;</span> <span class="s">&#39;198.168.0.2:6379&#39;</span> <span class="p">);</span>
    <span class="nv">$redis</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="s">&quot;juggernaut&quot;</span><span class="p">,</span> <span class="n">to_json</span><span class="p">({</span>
        <span class="n">channels</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s">&#39;channel1&#39;</span><span class="p">],</span>
        <span class="n">data</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@msg</span><span class="p">,</span>
    <span class="p">}));</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">classify</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$msg</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$msg</span> <span class="o">=~</span><span class="sr"> /TCP|UDP|SYN|socket/</span> <span class="p">)</span> <span class="p">{</span>
        <span class="s">&#39;network&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$msg</span> <span class="o">=~</span><span class="sr"> /segfault|swap|mem|allocation/</span> <span class="p">)</span> <span class="p">{</span>
        <span class="s">&#39;memory&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$msg</span> <span class="o">=~</span><span class="sr"> /IPMI|EXT|cciss|scsi|mpt|usb|DRAC|sd\w/</span> <span class="p">)</span> <span class="p">{</span>
        <span class="s">&#39;disk&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$msg</span> <span class="o">=~</span><span class="sr"> /CPU|IRQ/</span> <span class="p">)</span> <span class="p">{</span>
        <span class="s">&#39;cpu&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="s">&#39;unknown&#39;</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>然后写html页面来接收。</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;charset&quot;</span> <span class="na">content=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>syslog-push-webUI<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://192.168.0.2:8080/application.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/javascripts/jquery-1.7.2.min.js &quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&#39;syslog&#39;</span> <span class="na">style=</span><span class="s">&quot;overflow-y: scroll; border: #999&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;unstyled&quot;</span> <span class="na">id=</span><span class="s">&#39;msg&#39;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;&lt;button</span> <span class="na">class=</span><span class="s">&quot;btn&quot;</span> <span class="na">id=</span><span class="s">&quot;notify-permission-button&quot;</span><span class="nt">&gt;</span>开启桌面通知<span class="nt">&lt;/button&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">msg</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#msg li:gt(40)&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">msg</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">msg</span> <span class="o">=</span> <span class="s1">&#39;&lt;blockquote&gt;&#39;</span><span class="p">;</span>
          <span class="nx">msg</span> <span class="o">+=</span> <span class="s1">&#39;&lt;button type = &quot;button&quot; class=&quot;btn-mini &#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/button&gt;: &#39;</span><span class="p">;</span>
          <span class="nx">msg</span> <span class="o">+=</span> <span class="s1">&#39;&lt;code&gt;&#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/code&gt;&#39;</span><span class="p">;</span>
          <span class="nx">msg</span> <span class="o">+=</span> <span class="s1">&#39;&lt;small&gt;&lt;strong&gt;&#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/strong&gt; &#39;</span><span class="p">;</span>
          <span class="nx">msg</span> <span class="o">+=</span> <span class="s1">&#39;&lt;cite&gt;&#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/cite&gt;&lt;/small&gt;&#39;</span><span class="p">;</span>
          <span class="nx">msg</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/blockquote&gt;&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#msg:first-child&#39;</span><span class="p">).</span><span class="nx">prepend</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&#39;</span> <span class="o">+</span> <span class="nx">msg</span> <span class="o">+</span> <span class="s1">&#39;&lt;/li&gt;&#39;</span><span class="p">);</span>
      <span class="p">};</span>
      <span class="kd">var</span> <span class="nx">jug</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Juggernaut</span><span class="p">({</span>
        <span class="nx">secure</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;https:&#39;</span> <span class="o">==</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">),</span>
        <span class="nx">host</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
        <span class="nx">port</span><span class="o">:</span> <span class="mi">8080</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">port</span>
      <span class="p">});</span>
      <span class="nx">jug</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;connect&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&quot;&lt;code&gt;Connected&lt;/code&gt;&quot;</span><span class="p">)</span> <span class="p">});</span>
      <span class="nx">jug</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;disconnect&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&quot;&lt;code&gt;Disconnected&lt;/code&gt;&quot;</span><span class="p">)</span> <span class="p">});</span>
      <span class="nx">jug</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;reconnect&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&quot;&lt;code&gt;Reconnecting&lt;/code&gt;&quot;</span><span class="p">)</span> <span class="p">});</span>
      <span class="nx">jug</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s2">&quot;channel1&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
        <span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;btn&#39;</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">desk_notify</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">};</span>
      <span class="p">});</span>
      <span class="kd">var</span> <span class="nx">desk_notify</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">webkitNotifications</span><span class="p">){</span>
          <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">webkitNotifications</span><span class="p">.</span><span class="nx">checkPermission</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">RequestPermission</span><span class="p">(</span><span class="nx">desk_notify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">notification</span> <span class="o">=</span> <span class="nx">webkitNotifications</span><span class="p">.</span><span class="nx">createNotification</span><span class="p">(</span>
              <span class="s1">&#39;http://a.xnimg.cn/imgpro/app/mobile/renren_phone_icon2.png&#39;</span><span class="p">,</span>
              <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
              <span class="nx">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="p">);</span>
            <span class="nx">notification</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="kd">function</span> <span class="nx">RequestPermission</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">webkitNotifications</span><span class="p">.</span><span class="nx">requestPermission</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#notify-permission-button&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#notify-permission-button&#39;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
        <span class="nx">desk_notify</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;syslog realtime push&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;开启&#39;</span><span class="p">]);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>这里除了juggernaut的代码以外，还加上了chrome独有的webkitnotification功能，这样使用chrome的话，可以打开桌面通知，监控效果更佳～</p>
<p>注意：chrome桌面通知的权限授予，不能通过页面代码自动触发，必须显式的用button.click来触发。</p>
<p><strong>2013 年 2 月 17 日更新：</strong></p>
<p>我的 Ubuntu 12.10 更新到 firefox 18.0.2 版本后，以上代码也可以出现桌面通知了。不过奇怪的是：第一至今没有看到哪里有这个更新说明；第二我确实没有安装相关的extension，事实上我一共就安装了 firebug/xmarks/adblocks 三个扩展。</p>
      <a href="/2012/10/17/juggernaut-for-syslog-check" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/10/02/gather-take-in-perl5" title="Perl5里的gather/take" rel="bookmark">Perl5里的gather/take</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-10-02 00:00:00 +0800">02 Oct 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>九月末的YAPC::Asia上，Larry Wall展示了一下怎么把一个perl5上很标准的排序脚本改造成perl6脚本。主要是条件语句不再用()了，子函数传参方式，对象化操作等等。唯独有个命令是之前未见过的：gather/take。用这个可以减少临时变量的使用。</p>
<p>找了一下，类似命令在perl5中有多个模块对应：<a href="http://search.cpan.org/~moritz/Perl6-GatherTake-0.0.3/lib/Perl6/GatherTake.pm">Perl6::GatherTake</a>、<a href="http://search.cpan.org/~gaal/Perl6-Take-0.04/lib/Perl6/Take.pm">Perl6::Take</a>、<a href="http://search.cpan.org/~dconway/Perl6-Gather-0.42/lib/Perl6/Gather.pm">Perl6::Gather</a>、<a href="http://search.cpan.org/~flora/List-Gather-0.06/lib/List/Gather.pm">List::Gather</a>和<a href="http://search.cpan.org/~frew/Syntax-Keyword-Gather-1.002000/lib/Syntax/Keyword/Gather.pm">Syntax::Keyword::Gather</a>。</p>
<p>具体的说明，可以看<a href="http://search.cpan.org/~dconway/Perl6-Gather-0.42/lib/Perl6/Gather.pm">Perl6::Gather</a>的POD说明，比较详细。其他的都是简单给个例子就是了。</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Perl6::</span><span class="n">Gather</span><span class="p">;</span>
<span class="k">print</span> <span class="n">gather</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">@data</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">take</span> <span class="k">if</span> <span class="nv">$_</span> <span class="nv">%</span> <span class="nv">2</span><span class="p">;</span>
        <span class="n">take</span> <span class="n">to_num</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="k">if</span> <span class="sr">/(?:one|three|five|nine)\z/</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">take</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span> <span class="k">unless</span> <span class="n">gathered</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>相当于：</p>
<div class="highlight"><pre><code class="perl"><span class="k">my</span> <span class="nv">@arrays</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">@data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">push</span> <span class="nv">@arrays</span><span class="p">,</span> <span class="nv">$_</span> <span class="k">if</span> <span class="nv">$_</span> <span class="nv">%</span> <span class="nv">2</span><span class="p">;</span>
    <span class="nb">push</span> <span class="nv">@arrays</span><span class="p">,</span> <span class="n">to_num</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="k">if</span> <span class="sr">/(?:one|three|five|nine)\z/</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">@arrays</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span> <span class="k">unless</span> <span class="nv">@arrays</span><span class="p">;</span>
<span class="k">print</span> <span class="nv">@arrays</span><span class="p">;</span>
</code></pre></div>
<p>省略的就是这个push用的临时@arrays变量。同样也可以是标量，用~gather就可以省略.=了，比gather前面多一个波浪号~。</p>
      <a href="/2012/10/02/gather-take-in-perl5" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/09/26/jsonp-for-new-version-amcharts" title="用javascript操作新版本amcharts" rel="bookmark">用javascript操作新版本amcharts</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-26 00:00:00 +0800">26 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>新版本的amcharts用js和html5改写。不再简单的用settings.xml而是写成js的object了。好在例子依然详细。下面贴一段从数据库里取值并绘制成多栏图式的代码：</p>
<div class="highlight"><pre><code class="javascript"><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">meta</span> <span class="nx">http</span><span class="o">-</span><span class="nx">equiv</span><span class="o">=</span><span class="s2">&quot;Content-Type&quot;</span> <span class="nx">content</span><span class="o">=</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;</span><span class="nx">amStock</span> <span class="nx">Example</span><span class="o">&lt;</span><span class="err">/title&gt;</span>
        <span class="o">&lt;</span><span class="nx">link</span> <span class="nx">rel</span><span class="o">=</span><span class="s2">&quot;stylesheet&quot;</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;../amcharts/style.css&quot;</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/css&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;../javascripts/jquery-1.7.2.min.js&quot;</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
        <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;../amcharts/amstock.js&quot;</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
        <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;</span>
            <span class="kd">var</span> <span class="nx">chart</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">dataProvider</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
                    <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
                    <span class="nx">dataType</span><span class="o">:</span><span class="s2">&quot;jsonp&quot;</span><span class="p">,</span>
                    <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;http://api.domain.com/database/table/find&quot;</span><span class="p">,</span>
                    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;body&quot;</span><span class="o">:</span><span class="s1">&#39;{&quot;sort&quot;:[[&quot;date&quot;,-1]], &quot;limit&quot;:10000}&#39;</span><span class="p">},</span>
                    <span class="nx">jsonp</span><span class="o">:</span><span class="s1">&#39;jsonpCallback&#39;</span><span class="p">,</span>
                    <span class="nx">jsonpCallback</span><span class="o">:</span><span class="s1">&#39;jsonCallbackFunction&#39;</span><span class="p">,</span>
                    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
                    <span class="p">},</span>
                    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span>
                        <span class="nx">alert</span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">);</span>
                        <span class="nx">alert</span><span class="p">(</span><span class="nx">textStatus</span><span class="p">);</span>
                        <span class="nx">alert</span><span class="p">(</span><span class="nx">errorThrown</span><span class="p">);</span>
                    <span class="p">},</span>
                <span class="p">});</span>
            <span class="p">});</span>
            <span class="kd">function</span> <span class="nx">jsonCallbackFunction</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">parseJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
                <span class="nx">createStockChart</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="kd">function</span> <span class="nx">createStockChart</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmStockChart</span><span class="p">();</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">pathToImages</span> <span class="o">=</span> <span class="s2">&quot;../amcharts/images/&quot;</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">categoryAxesSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">CategoryAxesSettings</span><span class="p">();</span>
                <span class="c1">//定义显示的最小时间段，前提是X轴是Date对象</span>
                <span class="nx">categoryAxesSettings</span><span class="p">.</span><span class="nx">minPeriod</span> <span class="o">=</span> <span class="s2">&quot;hh&quot;</span><span class="p">;</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">categoryAxesSettings</span> <span class="o">=</span> <span class="nx">categoryAxesSettings</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">dataSet1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">DataSet</span><span class="p">();</span>
                <span class="c1">//注意这里的field要和json里的key一致</span>
                <span class="nx">dataSet1</span><span class="p">.</span><span class="nx">fieldMappings</span> <span class="o">=</span> <span class="p">[{</span>
                    <span class="nx">fromField</span><span class="o">:</span> <span class="s2">&quot;Total&quot;</span><span class="p">,</span>
                    <span class="nx">toField</span><span class="o">:</span> <span class="s2">&quot;Total&quot;</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="nx">fromField</span><span class="o">:</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span>
                    <span class="nx">toField</span><span class="o">:</span> <span class="s2">&quot;Error&quot;</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="nx">fromField</span><span class="o">:</span> <span class="s2">&quot;ErrorRate&quot;</span><span class="p">,</span>
                    <span class="nx">toField</span><span class="o">:</span> <span class="s2">&quot;ErrorRate&quot;</span><span class="p">,</span>
                <span class="p">}];</span>
                <span class="nx">dataSet1</span><span class="p">.</span><span class="nx">dataProvider</span> <span class="o">=</span> <span class="nx">dataProvider</span><span class="p">;</span>
                <span class="nx">dataSet1</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">=</span> <span class="s2">&quot;date&quot;</span><span class="p">;</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">dataSets</span> <span class="o">=</span> <span class="p">[</span><span class="nx">dataSet1</span><span class="p">];</span>
                <span class="nx">stockPanel1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockPanel</span><span class="p">();</span>
                <span class="c1">//第一栏占全图的百分比</span>
                <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">percentHeight</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">valueAxis1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>
                <span class="c1">//Y轴数值位置，amstock中无法设定Y轴偏移量</span>
                <span class="nx">valueAxis1</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">;</span>
                <span class="nx">valueAxis1</span><span class="p">.</span><span class="nx">axisColor</span> <span class="o">=</span> <span class="s2">&quot;#999999&quot;</span><span class="p">;</span>
                <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis1</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">graph1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockGraph</span><span class="p">();</span>
                <span class="nx">graph1</span><span class="p">.</span><span class="nx">valueField</span> <span class="o">=</span> <span class="s2">&quot;Total&quot;</span><span class="p">;</span>
                <span class="nx">graph1</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;总计&quot;</span><span class="p">;</span>
                <span class="c1">//平滑曲线</span>
                <span class="nx">graph1</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;smoothedLine&quot;</span><span class="p">;</span>
                <span class="nx">graph1</span><span class="p">.</span><span class="nx">lineColor</span> <span class="o">=</span> <span class="s2">&quot;#999999&quot;</span><span class="p">;</span>
                <span class="c1">//曲线下方区域的透明度</span>
                <span class="nx">graph1</span><span class="p">.</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>
                <span class="nx">graph1</span><span class="p">.</span><span class="nx">useDataSetColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addStockGraph</span><span class="p">(</span><span class="nx">graph1</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">stockLegend1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockLegend</span><span class="p">();</span>
                <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">stockLegend</span> <span class="o">=</span> <span class="nx">stockLegend1</span><span class="p">;</span>
                <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">drawingIconsEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">valueAxis2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>
                <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">axisColor</span> <span class="o">=</span> <span class="s2">&quot;#FCD202&quot;</span><span class="p">;</span>
                <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">gridAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">axisThickness</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
                <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis2</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">graph2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockGraph</span><span class="p">();</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">valueAxis</span> <span class="o">=</span> <span class="nx">valueAxis2</span><span class="p">;</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;smoothedLine&quot;</span><span class="p">;</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;错误&quot;</span><span class="p">;</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">valueField</span> <span class="o">=</span> <span class="s2">&quot;Error&quot;</span><span class="p">;</span>
                <span class="c1">//绘点的形状</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">bullet</span> <span class="o">=</span> <span class="s2">&quot;square&quot;</span><span class="p">;</span>
                <span class="c1">//图上超过多少点就不显示形状了</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">hideBulletsCount</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">lineColor</span> <span class="o">=</span> <span class="s2">&quot;#FCD202&quot;</span><span class="p">;</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">lineThickness</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">useDataSetColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addStockGraph</span><span class="p">(</span><span class="nx">graph2</span><span class="p">);</span>
                <span class="nx">stockPanel2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockPanel</span><span class="p">();</span>
                <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">percentHeight</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
                <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">marginTop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
                <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">showCategoryAxis</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="nx">valueAxis5</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>
                <span class="nx">valueAxis5</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
                <span class="nx">valueAxis5</span><span class="p">.</span><span class="nx">gridAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="nx">valueAxis5</span><span class="p">.</span><span class="nx">axisThickness</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
                <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis5</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">graph5</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockGraph</span><span class="p">();</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">valueAxis</span> <span class="o">=</span> <span class="nx">valueAxis5</span><span class="p">;</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">valueField</span> <span class="o">=</span> <span class="s2">&quot;ErrorRate&quot;</span><span class="p">;</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;错误比率&quot;</span><span class="p">;</span>
                <span class="c1">//漂浮显示的文字，可用graph.valueField的[[value]]和graph.descriptionField的[[description]]</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">balloonText</span> <span class="o">=</span> <span class="s2">&quot;[[value]]%&quot;</span><span class="p">;</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;column&quot;</span><span class="p">;</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">cornerRadiusTop</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">lineColor</span> <span class="o">=</span> <span class="s2">&quot;#FCD202&quot;</span><span class="p">;</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">useDataSetColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">addStockGraph</span><span class="p">(</span><span class="nx">graph5</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">stockLegend2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockLegend</span><span class="p">();</span>
                <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">stockLegend</span> <span class="o">=</span> <span class="nx">stockLegend2</span><span class="p">;</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">panels</span> <span class="o">=</span> <span class="p">[</span><span class="nx">stockPanel1</span><span class="p">,</span> <span class="nx">stockPanel2</span><span class="p">];</span>
                <span class="kd">var</span> <span class="nx">sbsettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartScrollbarSettings</span><span class="p">();</span>
                <span class="c1">//根据graph1显示拖动条栏</span>
                <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="nx">graph1</span><span class="p">;</span>
                <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">graphType</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span><span class="p">;</span>
                <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">chartScrollbarSettings</span> <span class="o">=</span> <span class="nx">sbsettings</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">cursorSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartCursorSettings</span><span class="p">();</span>
                <span class="c1">//光标移动时跟随显示漂浮气球</span>
                <span class="nx">cursorSettings</span><span class="p">.</span><span class="nx">valueBalloonsEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">chartCursorSettings</span> <span class="o">=</span> <span class="nx">cursorSettings</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">periodSelector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">PeriodSelector</span><span class="p">();</span>
                <span class="nx">periodSelector</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;bottom&quot;</span><span class="p">;</span>
                <span class="nx">periodSelector</span><span class="p">.</span><span class="nx">periods</span> <span class="o">=</span> <span class="p">[{</span>
                    <span class="nx">period</span><span class="o">:</span> <span class="s2">&quot;DD&quot;</span><span class="p">,</span>
                    <span class="nx">selected</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                    <span class="nx">count</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;1 day&quot;</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="nx">period</span><span class="o">:</span> <span class="s2">&quot;DD&quot;</span><span class="p">,</span>
                    <span class="nx">count</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
                    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;1 week&quot;</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="nx">period</span><span class="o">:</span> <span class="s2">&quot;MM&quot;</span><span class="p">,</span>
                    <span class="nx">count</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;1 month&quot;</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="nx">period</span><span class="o">:</span> <span class="s2">&quot;YYYY&quot;</span><span class="p">,</span>
                    <span class="nx">count</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;1 year&quot;</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="nx">period</span><span class="o">:</span> <span class="s2">&quot;YTD&quot;</span><span class="p">,</span>
                    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;YTD&quot;</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="nx">period</span><span class="o">:</span> <span class="s2">&quot;MAX&quot;</span><span class="p">,</span>
                    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;MAX&quot;</span>
                <span class="p">}];</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">periodSelector</span> <span class="o">=</span> <span class="nx">periodSelector</span><span class="p">;</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;chartdiv&quot;</span><span class="p">);</span>
            <span class="p">};</span>
            <span class="kd">function</span> <span class="nx">parseDate</span><span class="p">(</span><span class="nx">dateString</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">dateArray</span> <span class="o">=</span> <span class="nx">dateString</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">dateArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">dateArray</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">dateArray</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">dateArray</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
                <span class="k">return</span> <span class="nx">date</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kd">function</span> <span class="nx">parseJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
                <span class="nx">dataProvider</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">reverse</span><span class="p">();</span>
                <span class="c1">//其余列原样保存，时间列必须把字符串转换成Date对象</span>
                <span class="k">for</span><span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dataProvider</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">dataProvider</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">date</span> <span class="o">=</span> <span class="nx">parseDate</span><span class="p">(</span><span class="nx">dataProvider</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">date</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">};</span>
        <span class="o">&lt;</span><span class="err">/script&gt;</span>
    <span class="o">&lt;</span><span class="err">/head&gt;</span>
    <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;chartdiv&quot;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&quot;width: 100%; height: 700px;&quot;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;</span>
    <span class="o">&lt;</span><span class="err">/body&gt;</span>
<span class="o">&lt;</span><span class="err">/html&gt;</span>
</code></pre></div>
      <a href="/2012/09/26/jsonp-for-new-version-amcharts" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/09/21/json-event-for-logstash" title="【Logstash系列】数据格式之json-event" rel="bookmark">【Logstash系列】数据格式之json-event</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-21 00:00:00 +0800">21 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前的各种示例中，都没有提到logstash的输入输出格式。看起来就好像logstash比Message::Passing少了decoder/encoder一样。其实logstash也有类似的设定的，这就是format。有三种选择：plain/json/json_event。默认情况下是plain。也就是我们之前的通用做法，传文本给logstash，由logstash转换成json。</p>
<p>logstash社区根据某些应用场景，有相关的cookbook。关于访问日志，有<a href="http://cookbook.logstash.net/recipes/apache-json-logs/">http://cookbook.logstash.net/recipes/apache-json-logs/</a>。这是一个不错的思路！我们可以照葫芦画瓢给nginx也定义一下：</p>
<div class="highlight"><pre><code class="nginx">     <span class="k">logformat</span> <span class="s">json</span> <span class="s">&#39;</span><span class="p">{</span><span class="kn">&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#39;</span>
                    <span class="s">&#39;&quot;@source&quot;:&quot;</span><span class="nv">$server_addr&quot;,&#39;</span>
                    <span class="s">&#39;&quot;@fields&quot;:</span><span class="p">{</span><span class="kn">&#39;</span>
                    <span class="s">&#39;&quot;client&quot;:&quot;</span><span class="nv">$remote_addr&quot;,&#39;</span>
                    <span class="s">&#39;&quot;size&quot;:</span><span class="nv">$body_bytes_sent,&#39;</span>
                    <span class="s">&#39;&quot;responsetime&quot;:</span><span class="nv">$request_time,&#39;</span>
                    <span class="s">&#39;&quot;upstreamtime&quot;:</span><span class="nv">$upstream_response_time,&#39;</span>
                    <span class="s">&#39;&quot;oh&quot;:&quot;</span><span class="nv">$upstream_addr&quot;,&#39;</span>
                    <span class="s">&#39;&quot;domain&quot;:&quot;</span><span class="nv">$host&quot;,&#39;</span>
                    <span class="s">&#39;&quot;url&quot;:&quot;</span><span class="nv">$uri&quot;,&#39;</span>
                    <span class="s">&#39;&quot;status&quot;:&quot;</span><span class="nv">$status&quot;}}&#39;</span><span class="p">;</span>
     <span class="kn">access_log</span> <span class="s">/data/nginx/logs/access.json</span> <span class="s">json</span><span class="p">;</span>
</code></pre></div>
<p>这里需要注意的地方是：因为最后需要插入ES的某些field是有double/float类型。所以麻烦来了：一些端口监控工具的请求，状态码为400的，因为直接断开，所以并没有链接上upstream的服务器，其$upstream_response_time变量不存在，记录在日志里是-，这对于数值型是非法的定义。直接把带有400的日志通过file格式输入给logstash的时候，因为这个非法定义会报错，并把这行日志给丢弃掉。那么我们就无法统计400请求的数据了。</p>
<p>这里需要变通一下，我们知道其实所谓的Input::File就等效于tail -F ${path}${filename}(当然其实不是，模块的实际做法是在~/.sincedb里记录上次读取的位置，然后每${stat_interval}秒检查一次内容更新，每${discover_interval}秒检查一次文件描述符变更。也就是说默认其实是每秒读一次，一次几百上千行，这样效率更高)。所以我们可以自己运行tail命令，然后sed修正upstream_response_time后通过管道传递给logstash的Input::STDIN，效果是一样一样的。
新的logstash/agent.conf如下：</p>
<div class="highlight"><pre><code class="ruby"><span class="n">input</span> <span class="p">{</span>
    <span class="n">stdin</span> <span class="p">{</span>
        <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;nginx&quot;</span>
        <span class="nb">format</span> <span class="o">=&gt;</span> <span class="s2">&quot;json_event&quot;</span>
    <span class="p">}</span>
<span class="p">}</span> 
<span class="n">output</span> <span class="p">{</span>
    <span class="n">amqp</span> <span class="p">{</span>
        <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;nginx&quot;</span>
        <span class="n">host</span> <span class="o">=&gt;</span> <span class="s2">&quot;10.10.10.10&quot;</span>
        <span class="n">key</span>  <span class="o">=&gt;</span> <span class="s2">&quot;cdn&quot;</span>
        <span class="nb">name</span> <span class="o">=&gt;</span> <span class="s2">&quot;logstash&quot;</span>
        <span class="n">exchange_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;direct&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>运行命令如下：</p>
<div class="highlight"><pre><code class="bash">    <span class="c">#!/bin/sh</span>
      tail -F /data/nginx/logs/access.json <span class="se">\</span>
    | sed <span class="s1">&#39;s/upstreamtime&quot;:-/upstreamtime&quot;:0/&#39;</span> <span class="se">\</span>
    | /usr/local/logstash/bin/logstash -f /usr/local/logstash/etc/agent.conf &amp;
</code></pre></div>
<p>这样可以直接省略掉昂贵的Grok操作，同时节约原本的_all/_message/_source_host等等格式的空间。</p>
      <a href="/2012/09/21/json-event-for-logstash" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/09/16/regexp-log-demo-for-nginx" title="【Message::Passing系列】Regexp::Log模板匹配变量" rel="bookmark">【Message::Passing系列】Regexp::Log模板匹配变量</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-16 00:00:00 +0800">16 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上面调用的Regexp::Log::Nginx是base Regexp::Log的实例，CPAN上已经提供了好些server的log regex，见<a href="http://search.cpan.org/search?query=Regexp%3A%3Alog&amp;mode=all">http://search.cpan.org/search?query=Regexp%3A%3Alog&amp;mode=all</a>。</p>
<div class="highlight"><pre><code class="perl">    <span class="c1">#!/usr/bin/perl</span>
    <span class="nb">package</span> <span class="nn">Regexp::Log::</span><span class="n">Nginx</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">base</span> <span class="sx">qw( Regexp::Log )</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">vars</span> <span class="sx">qw( $VERSION %DEFAULT %FORMAT %REGEXP )</span><span class="p">;</span>
    <span class="nv">%DEFAULT</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">format</span>  <span class="o">=&gt;</span> <span class="s">&#39;%date %status %remotehost %domain %request %originhost %responsetime %upstreamtime %bytes %referer %useragent %xforwarderfor&#39;</span><span class="p">,</span>
            <span class="n">capture</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s">&#39;ts&#39;</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">,</span> <span class="s">&#39;remotehost&#39;</span><span class="p">,</span> <span class="s">&#39;url&#39;</span><span class="p">,</span> <span class="s">&#39;oh&#39;</span><span class="p">,</span> <span class="s">&#39;responsetime&#39;</span><span class="p">,</span> <span class="s">&#39;upstreamtime&#39;</span><span class="p">,</span> <span class="s">&#39;bytes&#39;</span> <span class="p">],</span>
    <span class="p">);</span>
    <span class="nv">%FORMAT</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;:default&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;%date %status %remotehost %domain %request %originhost %responsetime %upstreamtime %bytes %referer %useragent %xforwarderfor&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="nv">%REGEXP</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;%date&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=date)\[(?#=ts)\d{2}\/\w{3}\/\d{4}(?::\d{2}){3}(?#!ts) [-+]\d{4}\](?#!date)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%status&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=status)\d+(?#!status)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%remotehost&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=remotehost)\S+(?#!remotehost)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%domain&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=domain).*?(?#!domain)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%request&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=request)-|(?#=method)\w+(?#!method) (?#=url).*?(?#!url) (?#=version)HTTP/\d\.\d(?#!version)(?#!request)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%originhost&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=originhost)-|(?#=oh).*?(?#!oh):\d+(?#!originhost)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%responsetime&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=responsetime)-|.*?(?#!responsetime)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%upstreamtime&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=upstreamtime).*?(?#!upstreamtime)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%bytes&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=bytes)\d+(?#!bytes)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%referer&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=referer)\&quot;(?#=ref).*?(?#!ref)\&quot;(?#!referer)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%useragent&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=useragent)\&quot;(?#=ua).*?(?#!ua)\&quot;(?#!useragent)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%xforwarderfor&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=xforwarderfor)\&quot;(?#=xff).*?(?#!xff)\&quot;(?#!xforwarderfor)&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="mi">1</span><span class="p">;</span>
</code></pre></div>
      <a href="/2012/09/16/regexp-log-demo-for-nginx" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/09/16/message-passing-filter-demo" title="【Message::Passing系列】过滤器实例" rel="bookmark">【Message::Passing系列】过滤器实例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-16 00:00:00 +0800">16 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p><a href="http://github.com/suretec">Message::Passing</a>是Suretec公司为自己的VoIP业务开发的logstash山寨版。这几个月更新还是比较快的。比之前我刚关注它时改变很大。比如Message::Passing::Output::ElasticSearch已经出来了，还有专门的Message::Passing::Filter::ToLogstash，连命令行方式Message::Passing::Role::Script都采用了MooX::Options构建，相当的OO了。</p>
<p>不过可能是运用环境的区别吧，作者一直在filter方面没有什么动静，可怜巴巴的null/all/key/tologstash这么几个，比起input和output的列表差太远了。而且像logstash里的jls-grok这么最有力的工具没有山寨。</p>
<p>今天有空，稍微写了个例子，可以比较方便的定义类似grok_pattern的方式完成对accesslog的json序列化。不过配置方式比Grok还是麻烦不少，以后真用的话，再考虑config的办法吧，这里主要是为了展示Message::Passing::Filter::XXX的编写：</p>
<div class="highlight"><pre><code class="perl">    <span class="c1">#!/usr/bin/perl</span>
    <span class="nb">package</span> <span class="nn">Message::Passing::Filter::</span><span class="n">GrokLike</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Moo</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">MooX::Types::MooseLike::</span><span class="n">Base</span> <span class="sx">qw/ ArrayRef Str /</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">List::</span><span class="n">MoreUtils</span> <span class="sx">qw/ uniq /</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">DateTime</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Regexp::Log::</span><span class="n">Nginx</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">namespace::</span><span class="n">clean</span> <span class="o">-</span><span class="n">except</span> <span class="o">=&gt;</span> <span class="s">&#39;meta&#39;</span><span class="p">;</span>
    <span class="n">with</span> <span class="s">&#39;Message::Passing::Role::Filter&#39;</span><span class="p">;</span>
    <span class="n">has</span> <span class="nb">format</span> <span class="o">=&gt;</span> <span class="p">(</span>
        <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span>
        <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="s">&#39;%date %status %remotehost %domain %request %originhost %responsetime %upstreamtime %bytes %referer %useragent %xforwarderfor&#39;</span> <span class="p">},</span>
    <span class="p">);</span>
    <span class="n">has</span> <span class="n">capture</span> <span class="o">=&gt;</span> <span class="p">(</span>
        <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span>
        <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">ArrayRef</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="p">[</span> <span class="s">&#39;ts&#39;</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">,</span> <span class="s">&#39;remotehost&#39;</span><span class="p">,</span> <span class="s">&#39;url&#39;</span><span class="p">,</span> <span class="s">&#39;oh&#39;</span><span class="p">,</span> <span class="s">&#39;responsetime&#39;</span><span class="p">,</span> <span class="s">&#39;upstreamtime&#39;</span><span class="p">,</span> <span class="s">&#39;bytes&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="p">);</span>
    <span class="n">has</span> <span class="n">_grok</span> <span class="o">=&gt;</span> <span class="p">(</span>
        <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span>
        <span class="n">lazy</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">builder</span> <span class="o">=&gt;</span> <span class="s">&#39;_build_grok&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">sub </span><span class="nf">_build_grok</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$rln</span> <span class="o">=</span> <span class="nn">Regexp::Log::</span><span class="n">Nginx</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
            <span class="nb">format</span>  <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">format</span><span class="p">,</span>
            <span class="n">capture</span> <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="k">return</span> <span class="nv">$rln</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">sub </span><span class="nf">filter</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$message</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">@fields</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">_grok</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$re</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">_grok</span><span class="o">-&gt;</span><span class="n">regexp</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">%data</span><span class="p">;</span>
        <span class="nv">@data</span><span class="p">{</span><span class="nv">@fields</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;@message&#39;</span><span class="p">}</span> <span class="o">=~</span> <span class="sr">m/$re/</span><span class="p">;</span>
        <span class="nv">$message</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;@fields&#39;</span><span class="p">}</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nv">%data</span><span class="p">,</span>
            <span class="n">responsetime</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">{</span><span class="s">&#39;responsetime&#39;</span><span class="p">}</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">upstreamtime</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">{</span><span class="s">&#39;upstreamtime&#39;</span><span class="p">}</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">bytes</span>        <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">{</span><span class="s">&#39;bytes&#39;</span><span class="p">}</span>        <span class="o">+</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="nv">$message</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">true</span><span class="p">;</span>
</code></pre></div>
<hr />
<p><strong>2012 年 12 月 30 日附注：</strong></p>
<p>前两天已经把这个模块正规化后上传到 CPAN 上了。把捕获定义成 <code>.ini</code> 文件，同时还加入了类似 logstash 里的 mutate filter 的功能。模块叫 <code>Message::Passing::Filter::Regexp</code>。同时上传了一个 <code>Message::Passing::Output::PocketIO</code> 模块，可以打开一个网页时时接收output。</p>
      <a href="/2012/09/16/message-passing-filter-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/09/16/message-passing-agent" title="【Message::Passing系列】客户端收集脚本" rel="bookmark">【Message::Passing系列】客户端收集脚本</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-16 00:00:00 +0800">16 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>最后编写一段日志收集的agent：</p>
<div class="highlight"><pre><code class="perl">    <span class="c1">#!/usr/bin/perl</span>
    <span class="nb">package</span> <span class="n">NginxLogCollector</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Moo</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">MooX::</span><span class="n">Options</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Message::Passing::</span><span class="n">DSL</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">MooX::Types::MooseLike::</span><span class="n">Base</span> <span class="sx">qw/ Str /</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">namespace::</span><span class="n">clean</span> <span class="o">-</span><span class="n">except</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw( meta _options_data _options_config )</span><span class="p">];</span>
    <span class="n">with</span> <span class="s">&#39;Message::Passing::Role::Script&#39;</span><span class="p">;</span>
    <span class="n">option</span> <span class="n">filename</span> <span class="o">=&gt;</span> <span class="p">(</span>
        <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span>
        <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="s">&#39;/data/nginx/logs/access.log&#39;</span> <span class="p">},</span>
    <span class="p">);</span>
    <span class="n">option</span> <span class="n">rabbitmq</span> <span class="o">=&gt;</span> <span class="p">(</span>
        <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span>
        <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="s">&#39;10.3.18.199&#39;</span> <span class="p">},</span>
    <span class="p">);</span>
    <span class="k">sub </span><span class="nf">build_chain</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
        <span class="n">message_chain</span> <span class="p">{</span>
            <span class="n">output</span> <span class="n">rabbitmq</span> <span class="o">=&gt;</span> <span class="p">(</span>
                <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;AMQP&#39;</span><span class="p">,</span>
                <span class="n">exchange_name</span> <span class="o">=&gt;</span> <span class="s">&#39;logcollect&#39;</span><span class="p">,</span>
    <span class="c1"># 目前测试结果，发现Input::AMQP无法接收到非topic的exchange</span>
    <span class="c1"># CPAN上有关RabbitMQ的模块都是这个哥们写的，POD简略到没有一样，表示无语下</span>
    <span class="c1">#            exchange_type =&gt; &#39;direct&#39;,</span>
                <span class="n">hostname</span> <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">rabbitmq</span><span class="p">,</span>
                <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;guest&#39;</span><span class="p">,</span>
                <span class="n">password</span> <span class="o">=&gt;</span> <span class="s">&#39;guest&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">output</span> <span class="n">debug</span> <span class="o">=&gt;</span> <span class="p">(</span>
                <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;STDOUT&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">encoder</span><span class="p">(</span><span class="s">&quot;encoder&quot;</span><span class="p">,</span>
                <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;JSON&#39;</span><span class="p">,</span>
                <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;rabbitmq&#39;</span><span class="p">,</span>
                <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">filter</span> <span class="n">grok</span> <span class="o">=&gt;</span> <span class="p">(</span>
                <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;GrokLike&#39;</span><span class="p">,</span>
                <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;encoder&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">filter</span> <span class="n">logstash</span> <span class="o">=&gt;</span> <span class="p">(</span>
                <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;ToLogstash&#39;</span><span class="p">,</span>
                <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;grok&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">decoder</span><span class="p">(</span><span class="s">&quot;decoder&quot;</span><span class="p">,</span>
                <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;JSON&#39;</span><span class="p">,</span>
                <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;logstash&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">input</span> <span class="n">nginxlog</span> <span class="o">=&gt;</span> <span class="p">(</span>
                <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;FileTail&#39;</span><span class="p">,</span>
                <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;decoder&#39;</span><span class="p">,</span>
                <span class="n">filename</span> <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span>
           <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">start</span> <span class="k">unless</span> <span class="nb">caller</span><span class="p">;</span>
    <span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>目前就做到这步，之后从rabbitmq里往elasticsearch写的还没搞。从上面的chain可以很清除的看到和logstash一样的管道思想，input-&gt;decoder-&gt;filter-&gt;encoder-&gt;output。巧的是两种写法中，decode/encode那个写法跟puppet的DSL定义特别的像。哈哈～</p>
<p>继续贴汇总入库的agent代码：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl</span>
<span class="k">use</span> <span class="n">Moo</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">MooX::</span><span class="n">Options</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Message::Passing::</span><span class="n">DSL</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">MooX::Types::MooseLike::</span><span class="n">Base</span> <span class="sx">qw/ Str /</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">namespace::</span><span class="n">clean</span> <span class="o">-</span><span class="n">except</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw( meta _options_data _options_config )</span><span class="p">];</span>
<span class="n">with</span> <span class="s">&#39;Message::Passing::Role::Script&#39;</span><span class="p">;</span>
<span class="n">option</span> <span class="n">elasticsearch_servers</span> <span class="o">=&gt;</span> <span class="p">(</span>
    <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span>
    <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span><span class="p">,</span>
    <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="s">&#39;10.3.18.199:9200&#39;</span> <span class="p">},</span>
<span class="p">);</span>
<span class="n">option</span> <span class="n">rabbitmq</span> <span class="o">=&gt;</span> <span class="p">(</span>
    <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span>
    <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span><span class="p">,</span>
    <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="s">&#39;10.3.18.199&#39;</span> <span class="p">},</span>
<span class="p">);</span>
<span class="k">sub </span><span class="nf">build_chain</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="n">message_chain</span> <span class="p">{</span>
        <span class="n">output</span> <span class="n">elasticsearch</span> <span class="o">=&gt;</span> <span class="p">(</span>
            <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;ElasticSearch&#39;</span><span class="p">,</span>
            <span class="n">elasticsearch_servers</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="n">elasticsearch_servers</span><span class="p">],</span>
        <span class="p">);</span>
        <span class="n">decoder</span> <span class="n">decoder</span> <span class="o">=&gt;</span> <span class="p">(</span>
            <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;JSON&#39;</span><span class="p">,</span>
            <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;elasticsearch&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">input</span> <span class="n">rabbitmq</span> <span class="o">=&gt;</span> <span class="p">(</span>
            <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;AMQP&#39;</span><span class="p">,</span>
            <span class="n">exchange_name</span> <span class="o">=&gt;</span> <span class="s">&#39;logcollect&#39;</span><span class="p">,</span>
            <span class="n">queue_name</span> <span class="o">=&gt;</span> <span class="s">&#39;logcollect&#39;</span><span class="p">,</span>
            <span class="n">hostname</span> <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">rabbitmq</span><span class="p">,</span>
            <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;guest&#39;</span><span class="p">,</span>
            <span class="n">password</span> <span class="o">=&gt;</span> <span class="s">&#39;guest&#39;</span><span class="p">,</span>
            <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;decoder&#39;</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="p">};</span>
<span class="p">}</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">start</span> <span class="k">unless</span> <span class="nb">caller</span><span class="p">;</span>
<span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>总的来说，原有模块相互之间都有些不太协调，用的时候还是要自己改改。比如这里，原版的Output::ElasticSearch是吧之前传递过来的整个message放进@fields里的，这跟Filter::ToLogstash的message结构是完全冲突的。所以需要修改Output::ElasticSearch里的bulk_index()的data=&gt;$data,就可以了，不要多改动。</p>
<p>整个代码变动，参加个人github:<a href="https://github.com/chenryn/Message-Passing.git">https://github.com/chenryn/Message-Passing.git</a></p>
      <a href="/2012/09/16/message-passing-agent" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/09/16/elasticsearch-bulk-index-speed-testing" title="【Message::Passing系列】ElasticSearch的bulk_index速度测试" rel="bookmark">【Message::Passing系列】ElasticSearch的bulk_index速度测试</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-16 00:00:00 +0800">16 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>连续尝试了logstash的elasticsearch/elasticsearch_http/elasticsearch_river三个putput模块，发现其index/bulk/river三种插入方式的实际运行效果速度居然没有差异。而使用perl脚本测试，单例下index不到300msg/sec，bulk接近2500msg/sec，几乎翻了10倍。</p>
<p>测试脚本如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="c1">#!/usr/bin/perl -w</span>
    <span class="k">use</span> <span class="n">ElasticSearch</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">JSON</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Time::</span><span class="n">HiRes</span> <span class="sx">qw/time/</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Data::</span><span class="n">Dumper</span><span class="p">;</span>
    <span class="c1">#curl -XGET &#39;http://localhost:9200/logstash-2012.09.14/nginx/_mapping&#39;</span>
    <span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="s">&#39;{</span>
<span class="s">        &quot;@timestamp&quot; : &quot;2012-09-04T13:38:59.496888Z&quot;,</span>
<span class="s">        &quot;@tags&quot; : [], </span>
<span class="s">        &quot;@fields&quot; : { </span>
<span class="s">           &quot;reqtime&quot; : [ </span>
<span class="s">              0.016</span>
<span class="s">           ],  </span>
<span class="s">           &quot;req&quot; : [ </span>
<span class="s">              &quot;/fmn056/20120812/1645/tiny_r3N9_236f000036ad118d.jpg&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;version&quot; : [ </span>
<span class="s">              &quot;1.1&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;useragent&quot; : [ </span>
<span class="s">              &quot;\&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\&quot;&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;port&quot; : [ </span>
<span class="s">              &quot;80&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;size&quot; : [ </span>
<span class="s">              2360</span>
<span class="s">           ],  </span>
<span class="s">           &quot;client&quot; : [ </span>
<span class="s">              &quot;210.56.223.176&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;upstream&quot; : [ </span>
<span class="s">              &quot;10.9.18.50&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;method&quot; : [ </span>
<span class="s">              &quot;GET&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;referer&quot; : [ </span>
<span class="s">              &quot;photo.renren.com&quot;,</span>
<span class="s">              &quot;/photo/420723228/photo-6408408309?psource=3&amp;fromVIP=false&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;ZONE&quot; : [ </span>
<span class="s">              &quot;+0800&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;code&quot; : [ </span>
<span class="s">              200 </span>
<span class="s">           ],  </span>
<span class="s">           &quot;upstime&quot; : [ </span>
<span class="s">              0.016</span>
<span class="s">           ]   </span>
<span class="s">        },  </span>
<span class="s">        &quot;@source_path&quot; : &quot;//data/nginx/logs/access.log&quot;,</span>
<span class="s">        &quot;@source&quot; : &quot;file://DBLYD5-32.opi.com//data/nginx/logs/access.log&quot;,</span>
<span class="s">        &quot;@message&quot; : &quot;[04/Sep/2012:21:38:59 +0800] 200 210.56.223.176 fmn.rrimg.com GET /fmn056/20120812/1645/tiny_r3N9_236f000036ad118d.jpg HTTP/1.1 10.9.18.50:80 0.016 0.016 2360 \&quot;http://photo.renren.com/photo/420723228/photo-6408408309?psource=3&amp;fromVIP=false\&quot; \&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\&quot; \&quot;-\&quot;&quot;,</span>
<span class="s">        &quot;@source_host&quot; : &quot;DBLYD5-32.opi.com&quot;,</span>
<span class="s">        &quot;@type&quot; : &quot;nginx&quot;</span>
<span class="s">    }&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$hash</span> <span class="o">=</span> <span class="n">from_json</span><span class="p">(</span><span class="nv">$line</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$elsearch</span> <span class="o">=</span> <span class="n">ElasticSearch</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="n">servers</span>      <span class="o">=&gt;</span> <span class="s">&#39;10.4.16.68:9200&#39;</span><span class="p">,</span>
        <span class="n">transport</span>    <span class="o">=&gt;</span> <span class="s">&#39;httplite&#39;</span><span class="p">,</span>
        <span class="n">max_requests</span> <span class="o">=&gt;</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$begin</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">..</span> <span class="mi">1000</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">@data</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@data</span><span class="p">,</span> <span class="p">{</span> <span class="nb">index</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">data</span> <span class="o">=&gt;</span> <span class="nv">$hash</span> <span class="p">}</span> <span class="p">}</span> <span class="k">for</span> <span class="mi">1</span> <span class="o">..</span> <span class="mi">20</span><span class="p">;</span>
        <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">bulk</span><span class="p">(</span>
            <span class="nb">index</span> <span class="o">=&gt;</span> <span class="s">&#39;logstash-test&#39;</span><span class="p">,</span>
            <span class="n">type</span>  <span class="o">=&gt;</span> <span class="s">&#39;nginx&#39;</span><span class="p">,</span>
            <span class="n">actions</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@data</span>
        <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">print</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">/</span> <span class="p">(</span><span class="nb">time</span> <span class="o">-</span> <span class="nv">$begin</span><span class="p">);</span>
</code></pre></div>
<p>注意到这里bulk的数组是20个元素。实验证明超过20个会报出HTTP::Lite的错误(附带提示:ElasticSearch::Transport::*的HTTPLite啊AEHTTP啊的模块都是要另外安装的)。而且在使用Logstash::Outputs::ElasticSearchHTTP时，flush_size的default值100也是无法使用的，也是改到20后才行。</p>
<p>ps: 不知道为什么一起发github显示不了，只好拆开了，第一篇，关于ES的index速度测试。</p>
      <a href="/2012/09/16/elasticsearch-bulk-index-speed-testing" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/09/06/intro-rex" title="(R)?ex介绍" rel="bookmark">(R)?ex介绍</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-06 00:00:00 +0800">06 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>按说这文章好像轮不到我写。几个线上运用着的哥们都不出手，我勉强记录一些<a href="http://rexify.org/">官网</a>上没写example但实际应该蛮常用的功能吧：</p>
<ul>
  <li>IP列表</li>
</ul>
<p>Rex的示例中，都突出了自己可以方便的对group做集合运算的特点。嗯，这个在早先使用SSH::Batch的时候就很钦佩。但是面对可能某个应用每个节点就一两台设备又有很多应用的情况，在Rexfile里写就很麻烦了。而且难免有其他操作的时候需要用单独的列表。</p>
<p>其实Rex有Rex::Group::Lookup::File模块专门解决这个问题：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Rex::Group::Lookup::</span><span class="n">File</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$group_path</span> <span class="o">=</span> <span class="s">&quot;/etc/puppet/iplist&quot;</span><span class="p">;</span>
<span class="nb">grep</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$group_file</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$group_name</span> <span class="o">=</span> <span class="nv">$1</span> <span class="k">if</span> <span class="nv">$group_file</span> <span class="o">=~</span> <span class="n">m</span><span class="c1">#$group_path/(.+)\.list#;</span>
    <span class="n">group</span> <span class="s">&quot;$group_name&quot;</span> <span class="o">=&gt;</span> <span class="n">lookup_file</span><span class="p">(</span><span class="s">&quot;$group_file&quot;</span><span class="p">);</span>
<span class="p">}</span> <span class="nb">glob</span><span class="p">(</span><span class="s">&quot;$group_path/*&quot;</span><span class="p">);</span>
</code></pre></div>
<p>比如上面的例子，原先是在puppet上做集群管理的，已经有了现成的一个目录iplist专门存放各个应用的设备ip列表文件。那么在Rexfile开头加上这么两三行代码，就自动把整个应用设备归类到group里了。然后运行rex -Tv就看到Server Groups栏下一串串列表了。</p>
<ul>
  <li>错误输出</li>
</ul>
<p>Rex的command示例中，都是如下形式：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">say</span> <span class="n">run</span> <span class="s">&#39;uptime&#39;</span><span class="p">;</span>
</code></pre></div>
<p>但是大家会发现一个很常见的事情，就是命令行上敲错某个字母了，rex是没有错误提示输出的——当然rex本来的主要目的是做任务管理，理论上你得先保证task写正确。
当然，其实rex也可以返回错误提示的。Rex::Interface::Exec::SSH中对返回结果是有判断的。</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Rex::Helper::</span><span class="n">SSH2</span><span class="p">;</span>
<span class="o">...</span><span class="p">;</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$err</span><span class="p">)</span> <span class="o">=</span> <span class="n">net_ssh2_exec</span><span class="p">(</span><span class="nv">$ssh</span><span class="p">,</span> <span class="s">&quot;LC_ALL=C $path &quot;</span> <span class="o">.</span> <span class="nv">$cmd</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="nb">wantarray</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$err</span><span class="p">);</span> <span class="p">}</span>
<span class="k">return</span> <span class="nv">$out</span><span class="p">;</span>
</code></pre></div>
<p>对应到run命令的Rex::Commands::Run::run()里则是：</p>
<div class="highlight"><pre><code class="perl"><span class="k">sub </span><span class="nf">run</span> <span class="p">{</span>
   <span class="k">my</span> <span class="p">(</span><span class="nv">$cmd</span><span class="p">,</span> <span class="nv">$code</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
   <span class="k">my</span> <span class="nv">$path</span> <span class="o">=</span> <span class="nb">join</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="nn">Rex::</span><span class="n">Config</span><span class="o">-&gt;</span><span class="n">get_path</span><span class="p">());</span>
   <span class="k">my</span> <span class="nv">$exec</span> <span class="o">=</span> <span class="nn">Rex::Interface::</span><span class="n">Exec</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">;</span>
   <span class="k">my</span> <span class="p">(</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$err</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$exec</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">,</span> <span class="nv">$path</span><span class="p">);</span>
   <span class="nb">chomp</span> <span class="nv">$out</span> <span class="k">if</span> <span class="nv">$out</span><span class="p">;</span>
   <span class="nb">chomp</span> <span class="nv">$err</span> <span class="k">if</span> <span class="nv">$err</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="nv">$code</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">&amp;</span><span class="nv">$code</span><span class="p">(</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$err</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">if</span><span class="p">(</span><span class="nb">wantarray</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">,</span> <span class="nv">$out</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nv">$out</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>ok，看到了吧。run命令除了接收cmd外，还可以接收code的。而且也只有code方式可以处理错误输出。这里和exec不同，exec在列表上下文中返回标准输出和错误输出，但run在列表上下文中是把标准输出以行分割成列表元素。</p>
<p>所以要在run下看错误输出的话，应该这么写：</p>
<div class="highlight"><pre><code class="perl"><span class="n">task</span> <span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="n">group</span> <span class="o">=&gt;</span> <span class="s">&#39;nginx&#39;</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">run</span> <span class="s">&quot;pa aux|grep ngin[x]&quot;</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$err</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">print</span> <span class="nv">$err</span> <span class="p">?</span> <span class="nv">$err</span> <span class="p">:</span> <span class="nv">$out</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<ul>
  <li>Kerberos支持</li>
</ul>
<p>这是个人问题，估计碰到的不会多，姑且记录在此。查阅POD，包括在perl mongers和maillist上询问过了。Net::SSH2用的是libssh2库，这个库确实没办法支持gssapi-keyex/gssapi-micpassword的auth。半年前我在github上问Rex作者，表示有计划提供除Net::SSH2之外的支持，不过时间未定。结果看到他的做法是上个月推出了一个和puppet极类似的http方式的Rex::Endpoint::HTTP，我晕。</p>
<p>浏览了一遍，其实替换Net::SSH2模块并不费劲。于是我花几个小时给rex加上了krb5认证参数，在rex -k或者Rexfile里set -krb5的时候，改用Net::OpenSSH模块来完成。主要一个是connect，因为Net::SSH2是connect和auth分开的；一个是exec，因为Net::SSH2里另建channel的，Net::OpenSSH里直接capture即可；一个是disconnect，同理Net::OpenSSH是没这步直接退出的。至于SFTP，两者都实现了标准的sftp接口，代码甚至一行都不用改就能用(Makefile.PL里还是要加Net::SFTP::Foreign的)。代码见<a href="http://github.com/chenryn/rex">我的fork</a>。</p>
<ul>
  <li>集群高性能管理</li>
</ul>
<p>rex中有批量操作的参数，看代码应该是用ForkManager。但中心单机就是单机，所以rex也是在上个月推出了Rex::Gearman模块，通过gearmand把worker作成分布式的工作模式，这样简单有效的完成高性能扩展。gearmand也是我最爱的万能组件了～～</p>
<ul>
  <li>命令行集群管理</li>
</ul>
<p>rex的命令行有个怪逻辑，在-e的时候只认-H，-G只读rexfile里的task。但估计很多人都希望得到的是一次定义iplist，然后之后执行任意命令，即-G &lsquo;groupname&rsquo; -e &ldquo;say run &lsquo;commands&rsquo;&ldquo;的方式。稍微挪动一下代码段的位置，把elsif(-f $::rexfile){&hellip;}改成if(){}并移动到if($opts{&lsquo;e&rsquo;}){&hellip;}前面去就好了。本更改已提交个人fork。</p>
      <a href="/2012/09/06/intro-rex" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/08/26/translate-using-elasticsearch-for-logs" title="【翻译】用ElasticSearch存储日志" rel="bookmark">【翻译】用ElasticSearch存储日志</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-08-26 00:00:00 +0800">26 Aug 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <h1 id="section">介绍</h1>
<p>如果你使用elasticsearch来存储你的日志，本文给你提供一些做法和建议。</p>
<p>如果你想从多台主机向elasticsearch汇集日志，你有以下多种选择：</p>
<ul>
  <li><a href="http://graylog2.org/">Graylog2</a> 安装在一台中心机上，然后它负责往elasticsearch插入日志，而且你可以使用它那个漂亮的搜索界面~</li>
  <li><a href="http://logstash.net/">Logstash</a> 他有很多特性，包括你能输入什么日志，如何变换过滤，最好输出到哪里。其中就有输出到elasticsearch，包括直接输出和通过<a href="http://www.elasticsearch.org/guide/reference/river/rabbitmq.html">RabbitMQ的river</a>方式两种。</li>
  <li><a href="https://cwiki.apache.org/FLUME/">Apache Flume</a> 这个也可以从海量数据源中获取日志，用&rdquo;decorators&rdquo;修改日志，也有各种各样的&rdquo;sinks&rdquo;来存储你的输出。和我们相关的是<a href="https://github.com/Aconex/elasticflume">elasticflume sink</a>。</li>
  <li>omelasticsearch Rsyslog的输出模块。你可以在你的应用服务器上通过rsyslog直接输出到elasticsearch，也可以用rsyslog传输到中心服务器上来插入日志。或者，两者结合都行。具体如何设置参见<a href="http://wiki.rsyslog.com/index.php/HOWTO:_rsyslog_%2B_elasticsearch">rsyslog Wiki</a>。</li>
  <li>定制方案。比如，专门写一个脚本从天南海北的某个服务器传输你的日志到elasticsearch。</li>
</ul>
<p>根据你设定的不同，最佳配置也变化不定。不过总有那么几个有用的指南可以推荐一下：</p>
<h2 id="section-1">内存和打开的文件数</h2>
<p>如果你的elasticsearch运行在专用服务器上，经验值是分配一半内存给elasticsearch。另一半用于系统缓存，这东西也很重要的。</p>
<p>你可以通过修改ES_HEAP_SIZE环境变量来改变这个设定。在启动elasticsearch之前把这个变量改到你的预期值。另一个选择上球该elasticsearch的ES_JAVA_OPTS变量，这个变量时在启动脚本(elasticsearch.in.sh或elasticsearch.bat)里传递的。你必须找到-Xms和-Xmx参数，他们是分配给进程的最小和最大内存。建议设置成相同大小。嗯，ES_HEAP_SIZE其实就是干的这个作用。</p>
<p>你必须确认文件描述符限制对你的elasticsearch足够大，建议值是32000到64000之间。关于这个限制的设置，另有<a href="http://www.elasticsearch.org/tutorials/2011/04/06/too-many-open-files.html">教程</a>可以参见。</p>
<h2 id="section-2">目录数</h2>
<p>一个可选的做法是把所有日志存在一个索引里，然后用<a href="http://www.elasticsearch.org/guide/reference/mapping/ttl-field.html">ttl field</a>来确保就日志被删除掉了。不过当你日志量够大的时候，这可能就是一个问题了，因为用TTL会增加开销，优化这个巨大且唯一的索引需要太长的时间，而且这些操作都是资源密集型的。</p>
<p>建议的办法是基于时间做目录。比如，目录名可以是YYYY-MM-DD的时间格式。时间间隔完全取决于你打算保留多久日志。如果你要保留一周，那一天一个目录就很不错。如果你要保留一年，那一个月一个目录可能更好点。目录不要太多，因为全文搜索的时候开销相应的也会变大。</p>
<p>如果你选择了根据时间存储你的目录，你也可以缩小你的搜索范围到相关的目录上。比如，如果你的大多数搜索都是关于最近的日志的，那么你可以在自己的界面上提供一个&rdquo;快速搜索&rdquo;的选项只检索最近的目录。</p>
<h2 id="section-3">轮转和优化</h2>
<p>移除旧日志在有基于时间的目录后变得异常简单：</p>
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>curl -XDELETE <span class="s1">&#39;http://localhost:9200/old-index-name/&#39;</span>
</code></pre></div>
<p>这个操作的速度非常快，和删除大小差不多的少量文件速度接近。你可以放进crontab里半夜来做。</p>
<p><a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-optimize.html">Optimizing indices</a>是在非高峰时间可以做的一件很不错的事情。因为它可以提高你的搜索速度。尤其是在你是基于时间做目录的情况下，更建议去做了。因为除了当前的目录外，其他都不会再改，你只需要对这些旧目录优化一次就一劳永逸了。</p>
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>curl -XPOST <span class="s1">&#39;http://localhost:9200/old-index-name/_optimize&#39;</span>
</code></pre></div>
<h2 id="section-4">分片和复制</h2>
<p>通过elasticsearch.yml或者使用REST API，你可以给每个目录配置自己的设定。具体细节参见<a href="http://www.elasticsearch.org/guide/reference/setup/configuration.html">链接</a>。</p>
<p>有趣的是分片和复制的数量。默认情况下，每个目录都被分割成5个分片。如果集群中有一个以上节点存在，每个分片会有一个复制。也就是说每个目录有一共10个分片。当往集群里添加新节点的时候，分片会自动均衡。所以如果你有一个默认目录和11台服务器在集群里的时候，其中一台会不存储任何数据。</p>
<p>每个分片都是一个Lucene索引，所以分片越小，elasticsearch能放进分片新数据越少。如果你把目录分割成更多的分片，插入速度更快。请注意如果你用的是基于时间的目录，你只在当前目录里插入日志，其他旧目录是不会被改变的。</p>
<p>太多的分片带来一定的困难——在空间使用率和搜索时间方面。所以你要找到一个平衡点，你的插入量、搜索频率和使用的硬件条件。</p>
<p>另一方面，复制帮助你的集群在部分节点宕机的时候依然可以运行。复制越多，必须在线运行的节点数就可以越小。复制在搜索的时候也有用——更多的复制带来更快的搜索，同时却增加创建索引的时间。因为对猪分片的修改，需要传递到更多的复制。</p>
<h2 id="sourceall">映射_source和_all</h2>
<p><a href="http://www.elasticsearch.org/guide/reference/mapping/">Mappings</a>定义了你的文档如何被索引和存储。你可以，比如说，定义每个字段的类型——比如你的syslog里，消息肯定是字符串，严重性可以是整数。怎么定义映射参见<a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-put-mapping.html">链接</a>。</p>
<p>映射有着合理的默认值，字段的类型会在新目录的第一条文档插入的时候被自动的检测出来。不过你或许会想自己来调控这点。比如，可能新目录的第一条记录的message字段里只有一个数字，于是被检测为长整型。当接下来99%的日志里肯定都是字符串型的，这样Elasticsearch就没法索引他们，只会记录一个错误日志说字段类型不对。这时候就需要显式的手动映射&rdquo;message&rdquo; : {&ldquo;type&rdquo; : &ldquo;string&rdquo;}。如何注册一个特殊的映射详见<a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-put-mapping.html">链接</a>。</p>
<p>当你使用基于时间的目录名时，在配置文件里创建索引模板可能更适合一点。详见<a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-templates.html">链接</a>。除去你的映射，你海可以定义其他目录属性，比如分片数等等。</p>
<p>在映射中，你可以选择压缩文档的_source。这实际上就是整行日志——所以开启压缩可以减小索引大小，而且依赖你的设定，提高性能。经验值是当你被内存大小和磁盘速度限制的时候，压缩源文件可以明显提高速度，相反的，如果受限的是CPU计算能力就不行了。更多关于source字段的细节详见<a href="http://www.elasticsearch.org/guide/reference/mapping/source-field.html">链接</a>。</p>
<p>默认情况下，除了给你所有的字段分别创建索引，elasticsearch还会把他们一起放进一个叫_all的新字段里做索引。好处是你可以在_all里搜索那些你不在乎在哪个字段找到的东西。另一面是在创建索引和增大索引大小的时候会使用额外更多的CPU。所以如果你不用这个特性的话，关掉它。即使你用，最好也考虑一下定义清楚限定哪些字段包含进_all里。详见<a href="http://www.elasticsearch.org/guide/reference/mapping/all-field.html">链接</a>。</p>
<h2 id="section-5">刷新间隔</h2>
<p>在文档被索引后，Elasticsearch某种意义上是近乎实时的。在你搜索查找文档之前，索引必须被刷新。默认情况下，目录是每秒钟自动异步刷新的。</p>
<p>刷新是一个非常昂贵的操作，所以如果你稍微增大一些这个值，你会看到非常明显提高的插入速率。具体增大多少取决于你的用户可以接受到什么程度。</p>
<p>你可以在你的<a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-templates.html">index template</a>里保存期望的刷新间隔值。或者保存在elasticsearch.yml配置文件里，或者通过(REST API)[http://www.elasticsearch.org/guide/reference/api/admin-indices-update-settings.html]升级索引设定。</p>
<p>另一个处理办法是禁用掉自动刷新，办法是设为-1。然后用<a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-refresh.html">REST API</a>手动的刷新。当你要一口气插入海量日志的时候非常有效。不过通常情况下，你一般会采用的就是两个办法：在每次bulk插入后刷新或者在每次搜索前刷新。这都会推迟他们自己本身的操作响应。</p>
<h2 id="thrift">Thrift</h2>
<p>通常时，REST接口是通过HTTP协议的，不过你可以用更快的Thrift替代它。你需要安装<a href="https://github.com/elasticsearch/elasticsearch-transport-thrift">transport-thrift plugin</a>同时保证客户端支持这点。比如，如果你用的是<a href="https://github.com/aparo/pyes">pyes Python client</a>，只需要把连接端口从默认支持HTTP的9200改到默认支持Thrift的9500就好了。</p>
<h2 id="section-6">异步复制</h2>
<p>通常，一个索引操作会在所有分片(包括复制的)都完成对文档的索引后才返回。你可以通过<a href="http://www.elasticsearch.org/guide/reference/api/index_.html">index API</a>设置复制为异步的来让复制操作在后台运行。你可以直接使用这个API，也可以使用现成的客户端(比如pyes或者rsyslog的omelasticsearch)，都会支持这个。</p>
<h2 id="section-7">用过滤器替代请求</h2>
<p>通常，当你搜索日志的时候，你感兴趣的是通过时间序列做排序而不是评分。这种使用场景下评分是很无关紧要的功能。所以用过滤器来查找日志比用请求更适宜。因为过滤器里不会执行评分而且可以被自动缓存。两者的更多细节参见<a href="http://www.elasticsearch.org/guide/reference/query-dsl/">链接</a>。</p>
<h2 id="section-8">批量索引</h2>
<p>建议使用<a href="http://www.elasticsearch.org/guide/reference/api/bulk.html">bulk API</a>来创建索引它比你一次给一条日志创建一次索引快多了。</p>
<p>主要要考虑两个事情：</p>
<ul>
  <li>最佳的批量大小。它取决于很多你的设定。如果要说起始值的话，可以参考一下pyes里的默认值，即400。</li>
  <li>给批量操作设定时器。如果你添加日志到缓冲，然后等待它的大小触发限制以启动批量插入，千万确定还要有一个超时限制作为大小限制的补充。否则，如果你的日志量不大的话，你可能看到从日志发布到出现在elasticsearch里有一个巨大的延时。</li>
</ul>
      <a href="/2012/08/26/translate-using-elasticsearch-for-logs" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/08/23/systemtap-probe-nginx-http-header-parse-line" title="用systemtap定位nginx1.2在header解析时的报错" rel="bookmark">用systemtap定位nginx1.2在header解析时的报错</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-08-23 00:00:00 +0800">23 Aug 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一个url请求，在经过代理层访问应用层后，会报502错误。检查发现应用层是Nginx0.7.64+Resin3的结构，代理层是Nginx1.2。直接访问Nginx0.7.64是没问题的，访问Nginx1.2就会返回&rdquo;upstream sent invalid header while reading response header from upstream&rdquo;。</p>
<p>首先简单的通过编译&ndash;with-debug的nginx然后配置error_log debug;可以看到，nginx是在处理完Expires头后失败的。但是无法具体显示下一个头是在哪个地方。</p>
<p>所以进nginx/src/http/modules/ngx_http_proxy_module.c里，找到ngx_http_proxy_process_header函数，其中是根据ngx_http_parse_header_line函数的结果做判断的。所以出去看nginx/src/http/ngx_http_parse.c里ngx_http_parse_header_line函数，结果发现，从nginx1.0.14开始，新增加了关于空的判断：</p>
<div class="highlight"><pre><code class="c"><span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="n">NGX_HTTP_PARSE_INVALID_HEADER</span><span class="p">;</span>
                <span class="p">}</span>
</code></pre></div>
<p>变更记录：<a href="http://trac.nginx.org/nginx/browser/nginx/tags/release-1.0.14/src/http">http://trac.nginx.org/nginx/browser/nginx/tags/release-1.0.14/src/http</a></p>
<p>说明如下：</p>
<pre><code>*) Headers with null character are now rejected.
    Headers with NUL character aren't allowed by HTTP standard and may cause
    various security problems. They are now unconditionally rejected.
</code></pre>
<p>但是这个NULL出现在哪里呢？这里就要用systemtap来查了～</p>
<p>安装不说了，直接yum或者apt-get都有。</p>
<p>介绍的话，有余锋大神的一系列slide。然后有官网的文档。另外发现了这个翻译beginner的<a href="http://blog.csdn.net/kafeiflynn/article/details/6429976">中文文档</a>。</p>
<p>最后在本例里的简单使用了：</p>
<p>首先要自己启动/usr/local/nginx/sbin/nginx程序；</p>
<p>然后运行systemtap命令：</p>
<div class="highlight"><pre><code class="bash">stap -e <span class="s1">&#39;probe process(&quot;/usr/local/nginx/sbin/nginx&quot;).statement(&quot;ngx_http_parse_header_line@src/http/ngx_http_parse.c:855&quot;){printf(&quot;%s\n&quot;,$$locals$$);}&#39;</span>
</code></pre></div>
<p>最后发起出错的请求。查看stap的输出。类似下面这样：</p>
<pre><code>c='u' ch='U' p="ser-Agent: curl/7.15.5 (x86_64-redhat-linux-gnu) libcurl/7.15.5 OpenSSL/0.9.8b zlib/1.2.3 libidn/0.6.5^M
Host: www.connect.renren.com^M
Pragma: no-cache^M
Accept: */*^M
Proxy-Connection: Keep-Alive^M
^M
e" hash=117 i=117 state=1 lowcase=""
</code></pre>
<p>说明：</p>
<ul>
  <li>probe设探针    </li>
  <li>process运行命令    </li>
  <li>function指定函数    </li>
  <li>statement指定代码位置    </li>
  <li>$$vars变量    </li>
  <li>$$locals内部变量    </li>
  <li>$$parms参数变量    </li>
</ul>
<p>上面三个变量后面加$显示具体内容或者成员</p>
<p>可以先printf(&ldquo;%s\n&rdquo;,$$locals)看到显示的是p的内存地址，每次++。然后$$locals$看具体内容。</p>
<p>最终观察到，在header中某行处理到第N个字节的时候，不再输出，即在该字节处碰到了NULL。</p>
      <a href="/2012/08/23/systemtap-probe-nginx-http-header-parse-line" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/08/20/coro-async-pool-demo" title="Coro::Semaphore和async_pool示例" rel="bookmark">Coro::Semaphore和async_pool示例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-08-20 00:00:00 +0800">20 Aug 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#testing-ref" title="testing" rel="category tag">testing</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前有一个<a href="http://chenlinux.com/2012/07/19/anyevent-fork-http-load-runner-demo/">AnyEvent和Fork写的http压测工具</a>，评论里有大神教导说用Coro控制并发更有效更方便。于是改写了下面的版本。从被压测的nginx server上，可以看到ESTABLISHED的数量确实大大增加，“”并发”两个字算是做到了。</p>
<p>先上普通的Coro::Semaphore控制并发的代码：</p>
<div class="highlight"><pre><code class="perl"><span class="c1"># 之前的fork和count部分完全一致，不重复帖了。</span>
<span class="k">sub </span><span class="nf">coro_get</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$count</span><span class="p">,</span> <span class="nv">$urls</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@coros</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$semaphore</span><span class="o">=</span> <span class="nn">Coro::</span><span class="n">Semaphore</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$ua</span>  <span class="o">=</span> <span class="nn">FurlX::</span><span class="n">Coro</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="mi">1</span> <span class="o">..</span> <span class="nv">$count</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$urls</span><span class="o">-&gt;</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="nv">$#</span><span class="p">{</span><span class="nv">$urls</span><span class="p">}</span><span class="o">+</span><span class="mi">1</span><span class="p">))];</span>
        <span class="nb">push</span> <span class="nv">@coros</span><span class="p">,</span> <span class="n">async</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$guard</span> <span class="o">=</span> <span class="nv">$semaphore</span><span class="o">-&gt;</span><span class="n">guard</span><span class="p">;</span>
            <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$ua</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
            <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;code&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$res</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="nv">$_</span><span class="o">-&gt;</span><span class="nb">join</span> <span class="k">for</span> <span class="nv">@coros</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>然后贴的是用async_pool的代码，从perldoc来看据说是比async还快一倍。</p>
<div class="highlight"><pre><code class="perl"><span class="k">sub </span><span class="nf">coro_pool_get</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$count</span><span class="p">,</span> <span class="nv">$urls</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$sem</span> <span class="o">=</span> <span class="nn">Coro::</span><span class="n">Semaphore</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">POOL_SIZE</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$ua</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">FurlX::</span><span class="n">Coro</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span> <span class="mi">1</span> <span class="o">..</span> <span class="nv">$count</span> <span class="p">){</span>
        <span class="k">my</span> <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$urls</span><span class="o">-&gt;</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="nv">$#</span><span class="p">{</span><span class="nv">$urls</span><span class="p">}</span><span class="o">+</span><span class="mi">1</span><span class="p">))];</span>
        <span class="n">async_pool</span> <span class="p">{</span> <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$ua</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;$url&quot;</span><span class="p">);</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;code&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$res</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">}</span><span class="o">++</span><span class="p">;</span> <span class="nv">$sem</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">;</span> <span class="p">};</span> 
    <span class="p">};</span>
    <span class="nv">$sem</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>在两个函数中，只要修改$semaphore或者$limit的构造参数，就可以获得并发ESTABLISHED的效果。同样是4核nginx，基本在设置init var为100的情况下，最后整个脚本带来的是3000+的ESTABLISHED，然后可能出现少量的非200响应。</p>
      <a href="/2012/08/20/coro-async-pool-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/07/30/plack-middleware-demo" title="一个Plack::Middleware的实例" rel="bookmark">一个Plack::Middleware的实例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-30 00:00:00 +0800">30 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>做一个文件上传的网页，想稍微华丽一点，显示进度条出来。在Apache和Catalyst下都有现成的模块，不过Dancer上还没有。看了一下代码，Dancer::Request里没有像Catalyst那样暴露prepare_body_chunk方法。所以需要在plack上利用psgi.input来做。尽量重用现有代码，所以progress.css和progress.js都直接从Catalyst/Plugin/UploadProgress/example/Upload/root/static/里复制。</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">Plack::Middleware::</span><span class="n">UploadProgress</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">CHI</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Carp</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">HTTP::</span><span class="n">Body</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Plack::</span><span class="n">Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Plack::</span><span class="n">TempBuffer</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(Plack::Middleware)</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">call</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$self</span><span class="p">,</span> <span class="nv">$env</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$rm</span> <span class="o">=</span> <span class="nv">$env</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">REQUEST_METHOD</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$ct</span> <span class="o">=</span> <span class="nv">$env</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">CONTENT_TYPE</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$cl</span> <span class="o">=</span> <span class="nv">$env</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">CONTENT_LENGTH</span><span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$rm</span> <span class="o">=~</span> <span class="n">m</span><span class="c1">#^post$#i and (</span>
         <span class="nv">$ct</span> <span class="o">=~</span> <span class="n">m</span><span class="c1">#^application/x-www-form-urlencoded#i or</span>
         <span class="nv">$ct</span> <span class="o">=~</span> <span class="n">m</span><span class="c1">#^multipart/form-data#i )</span>
     <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$cache</span> <span class="o">=</span> <span class="n">CHI</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">driver</span> <span class="o">=&gt;</span> <span class="s">&#39;Memory&#39;</span><span class="p">,</span> <span class="n">global</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$req</span> <span class="o">=</span> <span class="nn">Plack::</span><span class="n">Request</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$env</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;progress_id&#39;</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$body</span> <span class="o">=</span> <span class="nn">HTTP::</span><span class="n">Body</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$ct</span><span class="p">,</span> <span class="nv">$cl</span><span class="p">);</span>
        <span class="nv">$env</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;plack.request.http.body&#39;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$body</span><span class="p">;</span>
        <span class="nv">$body</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$input</span> <span class="o">=</span> <span class="nv">$env</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;psgi.input&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$buffer</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$env</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;psgix.input.buffered&#39;</span><span class="p">})</span> <span class="p">{</span>
            <span class="nv">$input</span><span class="o">-&gt;</span><span class="nb">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$buffer</span> <span class="o">=</span> <span class="nn">Plack::</span><span class="n">TempBuffer</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$cl</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">my</span> <span class="nv">$spin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">$cl</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$input</span><span class="o">-&gt;</span><span class="nb">read</span><span class="p">(</span><span class="k">my</span> <span class="nv">$chunk</span><span class="p">,</span> <span class="nv">$cl</span> <span class="o">&lt;</span> <span class="mi">8192</span> <span class="p">?</span> <span class="nv">$cl</span> <span class="p">:</span> <span class="mi">8192</span><span class="p">);</span>
            <span class="k">my</span> <span class="nv">$read</span> <span class="o">=</span> <span class="nb">length</span> <span class="nv">$chunk</span><span class="p">;</span>
            <span class="nv">$cl</span> <span class="o">-=</span> <span class="nv">$read</span><span class="p">;</span>
            <span class="nv">$body</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="nv">$chunk</span><span class="p">);</span>
            <span class="nv">$buffer</span><span class="o">-&gt;</span><span class="k">print</span><span class="p">(</span><span class="nv">$chunk</span><span class="p">)</span> <span class="k">if</span> <span class="nv">$buffer</span><span class="p">;</span>
            <span class="k">my</span> <span class="nv">$progress</span> <span class="o">=</span> <span class="nv">$cache</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;upload_progress_&#39;</span> <span class="o">.</span> <span class="nv">$id</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">defined</span> <span class="nv">$progress</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nv">$progress</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">size</span>     <span class="o">=&gt;</span> <span class="nv">$body</span><span class="o">-&gt;</span><span class="n">content_length</span><span class="p">,</span>
                    <span class="n">received</span> <span class="o">=&gt;</span> <span class="nb">length</span> <span class="nv">$chunk</span><span class="p">,</span>
                <span class="p">};</span>
                <span class="nv">$cache</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span> <span class="s">&#39;upload_progress_&#39;</span> <span class="o">.</span> <span class="nv">$id</span><span class="p">,</span> <span class="nv">$progress</span> <span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$progress</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">received</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$read</span><span class="p">;</span>
                <span class="nv">$cache</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span> <span class="s">&#39;upload_progress_&#39;</span> <span class="o">.</span> <span class="nv">$id</span><span class="p">,</span> <span class="nv">$progress</span> <span class="p">);</span>
            <span class="p">};</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$read</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$spin</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">)</span> <span class="p">{</span>
                <span class="nn">Carp::</span><span class="n">croak</span> <span class="s">&quot;Bad Content-Length: maybe client disconnect? ($cl bytes remaining)&quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$buffer</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">env</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;psgix.input.buffered&#39;</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">env</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;psgi.input&#39;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$buffer</span><span class="o">-&gt;</span><span class="n">rewind</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$input</span><span class="o">-&gt;</span><span class="nb">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">app</span><span class="o">-&gt;</span><span class="p">(</span><span class="nv">$env</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$res</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>上面的代码，progress部分基本摘抄自Catalyst::Plugin::UploadProgress模块，chunk部分基本摘抄自Plack::Middleware::CSRFBlock模块，当然它也基本摘抄自Plack::Request模块~~
上面写的不全，没有关于GET /progress?progress_id=*的json输出处理。不过这部分也可以在DancerApp.pm里直接写get &lsquo;/progress&rsquo; =&gt; sub {};，最后申明，这代码刚写完，没测……CHI或许应该用memcached而不是memory~</p>
<p>在DancerApp/bin/app.pl里这么配置：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">Dancer</span><span class="p">;</span>
<span class="k">use</span> <span class="n">DancerApp</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Plack::</span><span class="n">Builder</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$app</span> <span class="o">=</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$env</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$req</span> <span class="o">=</span> <span class="nn">Dancer::</span><span class="n">Request</span><span class="o">-</span><span class="k">new</span><span class="p">(</span> <span class="n">env</span> <span class="o">=&gt;</span> <span class="nv">$env</span> <span class="p">);</span>
<span class="p">};</span>
<span class="n">builder</span> <span class="p">{</span>
    <span class="n">enable</span> <span class="s">&quot;Plack::Middleware::UploadProgress&quot;</span><span class="p">;</span>
    <span class="nv">$app</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">dance</span><span class="p">;</span>
</code></pre></div>
      <a href="/2012/07/30/plack-middleware-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/07/30/dancer-plugin-demo" title="一个Dancer::Plugin的实例" rel="bookmark">一个Dancer::Plugin的实例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-30 00:00:00 +0800">30 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>公司内部工具统一使用passport认证登录，于是写这么一个小plugin，用来给dancer做的网站使用统一认证。
passport的原理很简单，将原先的页面url带入session转到passport的login，然后由passport通过user/password或者kerberos确认是否正确，并返回一个ticket参数，然后拿这个ticket再到passport的verify上校验一次username，正确的话写入session即可。代码如下：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">Dancer::Plugin::Auth::</span><span class="n">Passport</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Dancer::</span><span class="n">Plugin</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Furl</span><span class="p">;</span> 
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$VERSION</span> <span class="o">=</span> <span class="s">&#39;0.01&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$settings</span> <span class="o">=</span> <span class="n">plugin_setting</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$PASSPORT_HOST</span> <span class="o">=</span> <span class="nv">$settings</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">passport_host</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;passport.company.com&#39;</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">_auth_passport</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">session</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$req_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">scheme</span> <span class="o">.</span><span class="s">&#39;://&#39;</span><span class="o">.</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">(</span><span class="s">&#39;Host&#39;</span><span class="p">)</span> <span class="o">.</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">uri</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">defined</span><span class="p">(</span><span class="k">my</span> <span class="nv">$ticket</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;ticket&#39;</span><span class="p">})</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$passport_url</span> <span class="o">=</span> <span class="s">&quot;https://${PASSPORT_HOST}/verify.php?t=${ticket}&quot;</span><span class="p">;</span>
            <span class="k">my</span> <span class="nv">$furl</span> <span class="o">=</span> <span class="n">Furl</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">timeout</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s">&#39;Referer&#39;</span> <span class="o">=&gt;</span> <span class="s">&quot;$req_url&quot;</span><span class="p">]</span> <span class="p">);</span>
            <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$furl</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="nv">$passport_url</span><span class="p">);</span>
            <span class="n">redirect</span> <span class="s">&quot;https://${PASSPORT_HOST}/login.php?forward=${req_url}&quot;</span> <span class="k">unless</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="n">is_success</span><span class="p">;</span>
            <span class="n">session</span> <span class="n">username</span> <span class="o">=&gt;</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">;</span>
            <span class="n">redirect</span> <span class="n">session</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;original_url&#39;</span><span class="p">};</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">session</span> <span class="n">original_url</span> <span class="o">=&gt;</span> <span class="nv">$</span><span class="p">{</span><span class="n">req_url</span><span class="p">};</span>
            <span class="n">redirect</span> <span class="s">&quot;https://${PASSPORT_HOST}/login.php?forward=${req_url}&quot;</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="n">register</span> <span class="s">&#39;auth_passport&#39;</span> <span class="o">=&gt;</span> <span class="o">\&amp;</span><span class="n">_auth_passport</span><span class="p">;</span>
<span class="n">register_plugin</span><span class="p">;</span>
<span class="n">true</span><span class="p">;</span>
<span class="cp">__END__</span>
</code></pre></div>
<p>使用方法如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="n">DancerApp</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Dancer::Plugin::Auth::</span><span class="n">Passport</span><span class="p">;</span>
    <span class="n">hook</span> <span class="s">&#39;before&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="n">auth_passport</span> <span class="p">};</span>
    <span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="k">return</span> <span class="s">&#39;Hello Passport&#39;</span> <span class="p">};</span>
    <span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>完毕。</p>
      <a href="/2012/07/30/dancer-plugin-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page3">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page active">
      <a href="#">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li class="page">
      <a href="/page17">17</a>
    </li>
    <li>
      <a href="/page5">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
              <li><a href="http://showmetheco.de/" title="Viacheslav Tykhanovskyi(PocketIO/Text::Haml)">No time to wait</a></li>
              <li><a href="http://blog.dataloop.io/" title="A new SaaS monitoring tool for DevOps & Operations">Dataloop.IO</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://planeteria.org/perl6/" title="Perl6 文集">Planet Perl 6</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://junqili.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.sectop.org/" title="">kindle</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="booklists" class="nav nav-list">
          <li class="nav-header">我写的第一本技术书籍</li>
          <li><a href='http://product.china-pub.com/3769604'><img src='http://images.china-pub.com/ebook3765001-3770000/3769604/shupi.jpg' border='0' alt='网站运维技术与实践'/></a></li>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
