<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/archive/">归档</a></li>
      	<li><a href="/categories/">分类</a></li>
      	<li><a href="/elk-errata/">《ELK stack权威指南》勘误</a></li>
      	<li><a href="/errata/">《网站运维技术与实践》勘误</a></li>
      	<li><a href="/pages/">Pages</a></li>
      	<li><a href="/projects/">学习记录</a></li>
      	<li><a href="/tags/">标签</a></li>
            <li><a href="http://chenlinux.com/poetry/index.html" />诗文集</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/31/intro-header_replace/" title="header_replace试验" rel="bookmark">header_replace试验</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-31 00:00:00 +0800">31 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>在linuxtone论坛上，偶见一贴，说采用如下配置，browser就可以正常遵守originserver的过期设置，而且充分利用browser本身的缓存设置，对server来说就可以达到减少304请求的效果，从而提升机器性能，节省带宽云云……
      <a href="/2010/01/31/intro-header_replace/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/31/anti-hotlinking-by-external_acl/" title="防盗链二进阶（squid外部ACL）" rel="bookmark">防盗链二进阶（squid外部ACL）</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-31 00:00:00 +0800">31 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#CDN-ref" title="CDN" rel="category tag">CDN</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>服务器防盗链设置，从最简单的referer判断，到进阶的key+time生成md5值，应该说是比较可靠了，而还有一种防盗链方式，基于IP/COOKIE的，这个我没找到太多有用信息，似乎IIS有个相关插件？<br />
只看到一篇squid的相关文章，简单的举了个防盗链的例子，未必有效（因为把cookie做明文处理，相比md5加密实在是防君子不防小人）。倒是从中学习一下external_acl_type用法，对squid进阶一番罢~~<br />
首先按惯例，上权威：《squid中文权威指南》6.1.3章节和12.5章节。<br />
用法如下：<br />
external_acl_type name [options] FORMAT.. /path/to/helper<br />
[helper arguments..]<br />
options包括：ttl、negtive_ttl、children、concurrency、cache和grace；<br />
FORMAT包括：%LOGIN,%EXT_USER,%IDENT,%SRC,%SRCPORT,%DST,%PROTO,%PORT,%METHOD,%MYADDR,%MYPORT,%PATH,%USER_CERT,%USER_CERTCHAIN,%USER_CERT_xx,%USER_CA_xx,%{Header},%{Hdr:member},%{Hdr:;member},%ACL,%DATA。<br />
外部程序输出结果必须是OK或者ERR，不过可以再带上一些keyword，比如user/passwd，ERR的messages，access.log里记录的%ea等等。<br />
cookie防盗链举例squid/libexec/check_cookie.pl如下：<br />
<code class="highlighter-rouge">perl
#!/usr/bin/perl -w
# 这个脚本仅仅是验证了Cache这个cookie的存在，没有严格的校验其值。
# disable output buffering
$|=1;
while () {
    chop;
    $cookie=$_;
    if( $cookie =~ /$COOKIE/i) {
        print "OK\n";
    } else {
        print "ERR\n";
    }
}
</code><br />
squid.conf配置如下：<br />
<code class="highlighter-rouge">squid
external_acl_type download children=15 %{Cookie} squid/libexec/check_cookie.pl
acl dl external download
acl filetype url_regex -i .wmv .wma .asf .asx .avi .mp3 .smi .rm .ram .rmvb .swf .mpg .mpeg .mov .zip .mid
http_access deny filetype !dl
</code><br />
回过头来，想到之前的squid_session一文中，也是用的这个外部ACL~~
      <a href="/2010/01/31/anti-hotlinking-by-external_acl/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/30/solution-of-linuxqq-die-on-ubuntu-9-10/" title="ubuntu 9.10下linuxqq经常挂掉的解决方案" rel="bookmark">ubuntu 9.10下linuxqq经常挂掉的解决方案</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-30 00:00:00 +0800">30 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>ubuntu 9.10下linuxqq（官方的QQ，八百年不更新的那个了）
      <a href="/2010/01/30/solution-of-linuxqq-die-on-ubuntu-9-10/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/30/limit-speed-in-nginx-lighttpd/" title="限速进阶" rel="bookmark">限速进阶</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-30 00:00:00 +0800">30 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#CDN-ref" title="CDN" rel="category tag">CDN</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>继续横向比较，之前有squid的限速配置，现在说nginx限速，nginx关于限速的模块有三个：HTTPLimitZoneModule、HTTPCoreModule和HTTPLimitReqModule，详见官方wiki，就不再贴链接了，能不能上天知道，真是地上芙蓉姐，天上绿坝娘呀……
      <a href="/2010/01/30/limit-speed-in-nginx-lighttpd/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/30/anti-hotlinking-in-nginx-lighttpd-squid/" title="防盗链进阶（nginx、lighttpd和squid类比）" rel="bookmark">防盗链进阶（nginx、lighttpd和squid类比）</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-30 00:00:00 +0800">30 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#CDN-ref" title="CDN" rel="category tag">CDN</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>在折腾squid的rewrite.pl时，参考的是公司原有的一个防盗链脚本。如下：<br />
<code class="highlighter-rouge">perl
#! /usr/bin/env perl
use strict;
use Digest::MD5 qw(md5_hex);
use POSIX qw(difftime mktime);
$| = 1;
my $errUrl = "http://www.test.com/no_such_url.html";
my $secret = "123456";
my $expired = 7200;
while () {
    my ($uri, $client, $ident, $method) = split;
    print "$errUrln" and next unless ($uri =~ m#^(http://w*.?test.com)/(d{4})(d{2})(d{2})(d{2})(d{2})/(w{32})(/.+.mp3)$#i);
    my ($domain, $year, $mon, $mday, $hour, $min, $md5, $path) = ($1, $2, $3, $4, $5, $6, $7, $8);
    print "$errUrl\n" and next if $year &lt; 1990 or $mon == 0 or $mon &gt; 12 or $mday == 0 or $mday &gt; 31 or $hour &gt; 23 or $min &gt; 59;
    print "$errUrl\n" and next if abs(difftime((int(time() / 100) * 100), mktime(00, $min, $hour, $mday, $mon - 1, $year - 1900))) &gt; $expired;
    $path =~ s#%(..)#pack("c", hex($1))#eg;
    print "$errUrl\n" and next if $md5 ne md5_hex($secret . $year . $mon . $mday . $hour . $min . $path);
    print $domain . $path, "\n";
}
</code><br />
今天在网上看到lighttpd相似的配置。lighttpd自带mod_secdownload模块实现这种防盗链方法。具体配置及php代码如下例（详见http://trac.lighttpd.net/trac/wiki/Docs%3AModSecDownload）：<br />
<code class="highlighter-rouge">php
&lt;?
$secret = "verysecret";  //加密字符串，必须跟lighttpd.conf里边保持一致
$uri_prefix = "/dl/";    //虚拟的路径，必须跟lighttpd.conf里边保持一致
# filename
$f = "/secret-file.txt";  //实际文件名，必须要加"/"斜杠
# current timestamp
$t = time();
$t_hex = sprintf("%08x", $t);
$m = md5($secret.$f.$t_hex);
# generate link
printf('%s', $uri_prefix, $m, $t_hex, $f, $f);
?&gt;
</code><br />
lighttpd配置文件:    <br />
server.modules = ( &hellip;, &ldquo;mod_secdownload&rdquo;, &hellip; )<br />
secdownload.secret          = &ldquo;verysecret&rdquo;<br />
secdownload.document-root   = &ldquo;/home/www/servers/download-area/&rdquo;<br />
secdownload.uri-prefix      = &ldquo;/dl/&rdquo;<br />
secdownload.timeout         = 10
      <a href="/2010/01/30/anti-hotlinking-in-nginx-lighttpd-squid/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/29/intro-cronolog-logrotate/" title="日志管理" rel="bookmark">日志管理</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-29 00:00:00 +0800">29 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>第一个，最常见的cronolog，因为他配对apache，apache太常见，所以cronolog也就常见了~~稳定版本1.6.2，似乎不支持2G以上的日志，因为那时候linux内核也不支持。。。现在有beta版可以，另据网友分析，其实只要修改1.6.2源代码中的openfile函数成openfile64就行了……<br />
使用方法：
      <a href="/2010/01/29/intro-cronolog-logrotate/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/28/transparent-by-ports/" title="端口转发" rel="bookmark">端口转发</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-28 00:00:00 +0800">28 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>常见的linux端口转发，是iptables方式，方法如下：<br />
<code class="highlighter-rouge">bash
#modprobe iptable_nat
#modprobe ip_conntrack
#service iptables stop
#echo 1 &gt; /proc/sys/net/ipv4/ip_forward
#iptables -t nat -I PREROUTING -p tcp --dport 443 -j DNAT --to 1.2.3.4
#iptables -t nat -I POSTROUTING -p tcp --dport 8081 -j MASQUERADE
#service iptables save
#service iptables start
</code><br />
其次网上有不少推荐rinetd，方法如下：<br />
<code class="highlighter-rouge">bash
#wget http://www.boutell.com/rinetd/http/rinetd.tar.gz
#tar zxvf rinetd.tar.gz
#cd rinted
#./configure &amp;&amp; make &amp;&amp; make install
# cat /etc/rinetd.conf
0.0.0.0 443 www.test.com 443 allow *.*.*.*
logfile /var/log/rinetd.log
</code><br />
看起来比iptables有个优势，可以采用域名解析，可惜做不到根据域名的不同，把相同端口的请求转向不同IP，其实也就跟直接写IP没多少区别了。<br />
第三还有ssh的端口转发，其实是把原TCP端口的数据转由ssh通道传输。方法如下：<br />
本地转发：ssh -g -L <local port="">:<remote host="">:
远程转发：ssh -g -R <local port="">:<remote host="">:
不过客户未必（或许说基本不可能）给外人开放ssh吧~~
第四，socket网络编程实现。我在网上发现了相关的perl脚本。
例一代码如下：
```perl
#!C:Perlbinperl.exe
#端口重定向(fork、IO::Select）
#By shanleiguang@gmail.com, 2005/10
use strict;
use warnings;
use IO::Socket;
use IO::Select;
use Getopt::Std;
use POSIX qw(:sys_wait_h strftime);
use constant FOREVER =&gt; 1;
use constant BUFSIZE =&gt; 4096;
#父进程下处理僵死子进程
sub zombie_reaper {
while(waitpid(-1, WNOHANG) &gt; 0) {}
$SIG{CHLD} = &zombie_reaper;
}
$SIG{CHLD} = &zombie_reaper;
#处理参数
my %opts;
getopts('h:l:t:p:', %opts);
print_help() and exit if(defined($opts{'h'}));
print_help() and exit if(not defined($opts{'t'}) or not defined($opts{'p'}));
print_help() and exit if($opts{'t'} !~ m/^d+.d+.d+.d+$/);
print_help() and exit if($opts{'l'} !~ m/^d+$/);
print_help() and exit if($opts{'p'} !~ m/^d+$/);
my $listen_port = (defined($opts{'l'})) ? $opts{'l'} : 8080;
my $target_ip   = $opts{'t'};
my $target_port = $opts{'p'};
#在本地创建监听Socket
my $socket_listen  = IO::Socket::INET-&gt;new(
LocalPort =&gt; $listen_port,
Proto     =&gt; 'tcp',
Listen    =&gt; 5,
Reuse     =&gt; 1,
);
print timestamp(), ", listening on port $listen_port ...n";
#新建两个用于Socket IO监视的IO::Select对象
my $readers = IO::Select-&gt;new();
my $writers = IO::Select-&gt;new();
$readers-&gt;add($socket_listen);
#父进程仅监视Listening Socket的accept事件
while(FOREVER) {
my @readers = $readers-&gt;can_read;
foreach my $reader (@readers) {
if($reader eq $socket_listen) {
#创建子进程处理后续的转发，父进程继续监视Listening Socket
fork and next;
my $socket_client = $socket_listen-&gt;accept();
#在子进程中，不再需要对Listening Socket进行操作
$readers-&gt;remove($socket_listen);
$socket_listen-&gt;close();
#子进程
as_server($socket_client);
exit;
}
}
}
#子进程
sub as_server {
my $socket_client = shift;
my $client_port = $socket_client-&gt;peerport();
my $client_ip   = $socket_client-&gt;peerhost();
#创建到目标地址:端口的Socket连接
my $socket_forward = IO::Socket::INET-&gt;new(
PeerAddr =&gt; $target_ip,
PeerPort =&gt; $target_port
);
print timestamp(), ", $client_ip:$client_port$target_ip:$target_port.n";
#监视socket_client、socket_forward的IO情况
$readers-&gt;add($socket_client);
$readers-&gt;add($socket_forward);
$writers-&gt;add($socket_client);
$writers-&gt;add($socket_forward);
my ($rbuffer_forward, $rbuffer_client) = ('', '');
while(FOREVER) {
my @readers = $readers-&gt;can_read;
foreach my $reader (@readers) {
my $rbuffer;
#当socket_client可读时，将读取的内容追加到rbuffer_client后
#假如读取失败，则退出子进程
if($reader eq $socket_client) {
exit if(not recv($reader, $rbuffer, BUFSIZE, 0));
$rbuffer_client.= $rbuffer;
}
#当socket_forward可读时，将读取的内容追加到rbuffer_forward后
#假如读取失败，则退出子进程
if($reader eq $socket_forward) {
exit if(not recv($reader, $rbuffer, BUFSIZE, 0));
$rbuffer_forward .= $rbuffer;
}
}
my @writers = $writers-&gt;can_write;
foreach my $writer (@writers) {
#当socket_client可写，且rbuffer_forward不为空时，将rbuffer_forward
#内容写入socket_client，假如写失败，则退出子进程
if($writer eq $socket_client) {
next if(not $rbuffer_forward);
exit if(not send($writer, $rbuffer_forward, 0));
$rbuffer_forward = '';
}
#当socket_forward可写，且rbuffer_client不为空时，将rbuffer_client
#内容写入socket_forward，假如写失败，则退出子进程
if($writer eq $socket_forward) {
next if(not $rbuffer_client);
exit if(not send($writer, $rbuffer_client, 0));
$rbuffer_client = '';
}
}
}
}
sub timestamp {
return strftime "[%y/%m/%d,%H:%M:%S]", localtime;
}
sub print_help {
my $filename = (split /\/, $0)[-1];
print &lt;<help>&gt;&gt;
$filename [-h,-l:]
 -h  print help
 -l  listening local port, default 8080
 -t  target ipaddr
 -p  target port
By shanleiguang@gmail.com, 2005/10
HELP
}
```
例二代码如下：
```perl
#!C:Perlbinperl.exe
#端口重定向（POE）
#By shanleiguang@gmail.com, 2005/10
#POE结构：
#
#Driver-&gt;Filter-&gt;Wheel-&gt;Components
#
|______|______|________|
#
|
#          Session
#
|
# Kernel
#
#Driver：    底层文件操作的抽象，在编程时不会直接用到
#Filter：    底层、中层协议操作的抽象，通常不会直接用到
#Wheel：     高层协议操作的抽象，经常要用到
#Components：POE提供的一些拿来就能用的组件
#Session：   会话抽象，会话中需要创建高层协议抽象
#Kernel：    POE管理会话的内核
#
#POE对象的数据结构：
#
#$_[HEAP]：是会话唯一的数据存储区；
#$_[SESSION]：是指向会话自身的引用；
#$_[KERNEL]：是指向会话管理内核的引用；
#@_[ARG0..ARG9]：用于传递给各事件处理函数的参数；
#
#还是实例最直观：
#在父会话中创建一个监听用的Socket，当有客户端连接，即有accept_sucess事件发生时，
#则创建一个子会话处理后续事件，并将accept获得的客户端Socket传递给子会话；子会话
#创建到目标的Socket，连接过程中，如果客户端Socket中有input事件，则将客户端的input
#内容缓存在一个队列中，当连接成功后，发送给到目标的那个Socket中，见下图：
#
#          +-------------------------------+
#         /|      Socket_listen            |
#        / +-------------------------------+
#Client|Socket_client Socket_server|Target
#          +-------------------------------+
#                    Forwarder
use strict;
use warnings;
use Socket;
use Getopt::Std;
use POSIX qw(strftime);
use POE qw(
Wheel::SocketFactory
Wheel::ReadWrite
Filter::Stream
);
#Get Options
my %opts;
getopts('hl:t:p:', %opts);
print_help() and exit if(defined($opts{'h'}));
print_help() and exit if(not defined($opts{'t'}) or not defined($opts{'p'}));
print_help() and exit if($opts{'t'} !~ m/^d+.d+.d+.d+$/);
print_hekp() and exit if($opts{'p'} !~ m/^d+$/);
my $listen_port = (defined($opts{'l'})) ? $opts{'l'} : 8080;
my $target_addr = $opts{'t'};
my $target_port = $opts{'p'};
###Create Parent - 'Listen Session'###
###创建父会话用于监听客户端的连接
###会话创建的最后将进入_start状态，执行_start的handler
###accept_success即在_start的handler中创建监听Socket的Wheel中
###的SuccessEvent事件，它的handler是forwarder_create函数
###$_[ARG0]是wheel::SocketFatory的SuccessEvent传递的参数
POE::Session-&gt;create(
  inline_states =&gt; {
    _start =&gt; &amp;forwarder_server_start,
    _stop  =&gt; sub { print timestamp(), ", forwarder server stopped."; },
    accept_success =&gt; sub { &amp;forwarder_create($_[ARG0]); },
    accept_failure =&gt; sub { delete $_[HEAP]-&gt;{server_wheel} },
  },
);
$poe_kernel-&gt;run();
exit;
###Event handlers for Parent Session###
###父会话中的事件处理函数
sub forwarder_server_start {
print timestamp(), ", listening on port $listen_port and ";
print "forward to $target_addr:$target_port\n";
#在父会话的存储区创建一个监听Socket类型的Wheel
$_[HEAP]-&gt;{server_wheel} = POE::Wheel::SocketFactory-&gt;new(
  BindPort       =&gt; $listen_port,
  SocketProtocol =&gt; 'tcp',
  ListenQueue    =&gt; SOMAXCONN,
  Reuse          =&gt; 'on',
#ARG0 of SuccessEvent
  SuccessEvent   =&gt; 'accept_success',
  FailureEvent   =&gt; 'accept_failure',
);
}
###Create Child - 'Forward Session'###
###创建子会话
sub forwarder_create {
my $socket = shift;
POE::Session-&gt;create(
inline_states =&gt; {
_start =&gt; &amp;forwarder_start,
_stop  =&gt; sub {
print ' ' x 4, timestamp(), ', sessionId:';
print $_[SESSION]-&gt;ID, ", forwarder stop\n";
},
client_input =&gt; &amp;client_input,
client_error =&gt; sub {
delete $_[HEAP]-&gt;{wheel_client};
delete $_[HEAP]-&gt;{wheel_server};
},
server_connect =&gt; &amp;server_connect,
server_input =&gt; sub {
$_[HEAP]-&gt;{wheel_client}-&gt;put($_[ARG0]) if(exists $_[HEAP]-&gt;{wheel_client});
},
server_error =&gt; sub {
delete $_[HEAP]-&gt;{wheel_client};
delete $_[HEAP]-&gt;{wheel_server};
},
},
#Parameters to '_start' Event
args =&gt; [$socket],
);
}
##Event Handlers of Child Session##
sub forwarder_start {
my ($heap, $socket) = @_[HEAP, ARG0];
print ' ' x 4, timestamp(), ', sessionId:';
print $_[SESSION]-&gt;ID, ", forwarder startn";
#Buffer client's input while connecting to the target
$heap-&gt;{state} = 'connecting';
$heap-&gt;{queue} = [];
#ClientForwarder server
$heap-&gt;{wheel_client} = POE::Wheel::ReadWrite-&gt;new(
Handle =&gt; $socket,
Driver =&gt; POE::Driver::SysRW-&gt;new(),
Filter =&gt; POE::Filter::Stream-&gt;new(),
InputEvent =&gt; 'client_input',
ErrorEvent =&gt; 'client_error',
);
#Forwarder servertarget
$heap-&gt;{wheel_server} = POE::Wheel::SocketFactory-&gt;new(
RemoteAddress =&gt; $target_addr,
RemotePort    =&gt; $target_port,
SuccessEvent  =&gt; 'server_connect',
FailureEvent  =&gt; 'server_error',
);
}
sub server_connect {
my ($kernel, $session, $heap, $socket) = @_[KERNEL, SESSION, HEAP, ARG0];
#Replace
$heap-&gt;{wheel_server}
$heap-&gt;{wheel_server}
= POE::Wheel::ReadWrite-&gt;new(
Handle     =&gt; $socket,
Driver     =&gt; POE::Driver::SysRW-&gt;new,
Filter     =&gt; POE::Filter::Stream-&gt;new,
InputEvent =&gt; 'server_input',
ErrorEvent =&gt; 'server_error',
);
$heap-&gt;{state} = 'connected';
$kernel-&gt;call($session, 'client_input', $_) foreach(@{$heap-&gt;{queue}});
$heap-&gt;{queue} = [];
}
sub client_input {
my ($heap, $input) = @_[HEAP, ARG0];
push @{$heap-&gt;{queue}}, $input and return if($heap-&gt;{state} eq 'connecting');
$heap-&gt;{wheel_server}-&gt;put($input) if(exists $heap-&gt;{wheel_server});
}
#Common subroutines
sub timestamp {
return strftime "[%H:%M:%S]", localtime;
}
sub print_help {
my $filename = (split /\/, $0)[-1];
print &lt;<help>&gt;&gt;
$filename [-h,-l:]
-h  print help
-l  listen port
-t  target ipaddress
-p  target port
A simple TCP forwarder server, 2005/10
By shanleiguang@gmail.com
HELP
}
```
使用方法：
# perl tcpForwarder.pl -l 8080 -t
xxx.xxx.xxx.xxx -p 80
[xx:xx:xx:], listening on local port 8080 and forward to
xxx.xxx.xxx.xxx:80...
...</help></help></remote></local></remote></local>
      <a href="/2010/01/28/transparent-by-ports/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/27/test-location-in-squid/" title="squid页面跳转试验" rel="bookmark">squid页面跳转试验</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-27 00:00:00 +0800">27 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>某客户页面跳转试验记录
      <a href="/2010/01/27/test-location-in-squid/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/24/shell-script-for-train-setting/" title="CUshell版惊见中国特色脚本" rel="bookmark">CUshell版惊见中国特色脚本</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-24 00:00:00 +0800">24 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>58同城：<br />
<code class="highlighter-rouge">bash
#!/bin/bash
#该脚本仅用于58同城网站刷票
#到达目的地
DES="(天水|兰州|西安)"
#刷票url
URL=http://bj.58.com/huochepiao/a1/
OLDMD5=`curl $URL | egrep "$DES" | sed '$d' | md5sum | awk '{print $1}'`
while true; do
    if [ "$OLDMD5" == `curl $URL | egrep "$DES" | sed '$d' | md5sum | awk '{print $1}'` ];then
        sleep 300
    else
        MESSAGE=`curl $URL | egrep "$DES" | sed '$d' | head -n1`
        SEND=`echo $MESSAGE | awk -F"&gt;" '{print $3}' | sed -e 's/&lt;.*//'`
        DATE=`echo $SEND | awk -F":" '{print $2}'`
        #判断DATE变量，使其匹配你需要出发的日期
        if [ "$DATE" == "2010-02-08" -o "$DATE" == "2010-02-09" -o "$DATE" == "2010-02-10" -o "$DATE" == "2010-02-11" -o "$DATE" == "2010-02-12" -o "$DATE" == "2010-01-28" ];then
            #输入需要发送信息的命令,飞信或mail等.....,发送的内容为$SEND变量
            /usr/bin/curl -d cdkey=xxxx-xxx-xxxx-xxxxx -d password=xxxxxx -d addserial=xxx -d phone=13000000000 -d message="$SEND:58.com" http://sdkhttp.eucp.b2m.cn/sdkproxy/asynsendsms.action
        fi
        OLDMD5=`curl $URL | egrep "$DES" | sed '$d' | md5sum | awk '{print $1}'`
        sleep 300
    fi
done
</code><br />
赶集网：<br />
<code class="highlighter-rouge">bash
#!/bin/bash
#该脚本仅用于赶集网刷票
#到达目的地
DES="(天水|兰州|西安)"
#刷票url
URL=http://bj.ganji.com/piao/sell/
OLDMD5=`curl $URL | egrep "$DES" | md5sum | awk '{print $1}'`
while true; do
    if [ "$OLDMD5" == `curl $URL | egrep "$DES" | md5sum | awk '{print $1}'` ];then
        sleep 300
    else
        MESSAGE=`curl $URL | egrep "$DES" | head -n1`
        SEND=`echo $MESSAGE | awk -F"&gt;" '{print $3}' | sed -e 's/&lt;.*//'`
        DATE=`echo $SEND | awk -F":" '{print $2}'`
        #判断DATE变量，使其匹配你需要出发的日期
        if [ "$DATE" == "02-08" -o "$DATE" == "02-09" -o "$DATE" == "02-10" -o "$DATE" == "02-11" -o "$DATE" == "02-12" -o "$DATE" == "01-28" ];then
        #输入需要发送信息的命令,飞信或mail等.....,发送的内容为$SEND变量
        /usr/bin/curl -d cdkey=xxxx-xxx-xxxx-xxxxx -d password=xxxxxx -d addserial=xxx -d phone=13000000000 -d message="$SEND:ganji.com" &lt;a href="http://sdkhttp.eucp.b2m.cn/sdkproxy/asynsendsms.action"&gt;http://sdkhttp.eucp.b2m.cn/sdkproxy/asynsendsms.action&lt;/a&gt;
        fi
        OLDMD5=`curl $URL | egrep "$DES" | md5sum | awk '{print $1}'`
        sleep 300
    fi
done
</code>
      <a href="/2010/01/24/shell-script-for-train-setting/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/23/automate-configure-squid-in-website/" title="squid自动配置web化" rel="bookmark">squid自动配置web化</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-23 00:00:00 +0800">23 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#CDN-ref" title="CDN" rel="category tag">CDN</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>[root@test data]# cat index.htm<br />
```html
      <a href="/2010/01/23/automate-configure-squid-in-website/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/19/sysctl-about-tcp/" title="系统优化——TCP参数" rel="bookmark">系统优化——TCP参数</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-19 00:00:00 +0800">19 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>tcp_syn_retries ：INTEGER<br />
默认值是5<br />
对于一个新建连接，内核要发送多少个 SYN 连接请求才决定放弃。不应该大于255，默认值是5，对应于180秒左右时间。(对于大负载而物理通信良好的网络而言,这个值偏高,可修改为2.这个值仅仅是针对对外的连接,对进来的连接,是由tcp_retries1决定的)
      <a href="/2010/01/19/sysctl-about-tcp/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/13/refresh-cache-of-interrogation-url/" title="squid刷新缓存" rel="bookmark">squid刷新缓存</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-13 00:00:00 +0800">13 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#CDN-ref" title="CDN" rel="category tag">CDN</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>这篇博文的起因是最近犯的一个低级错误。某客户要求立刻刷新掉一批url。格式是http://a.b.com/index.jsp?pid=123456&amp;id=654321这样的。<br />
我也没多想，上去就执行“squidclient -p 80  -m purge<br />
http://a.b.com/index.jsp?pid=123456&amp;id=654321”。结果硬是刷不掉……明明访问源站已经没有这个url了。我wget居然还能MISS/200~~~<br />
直到同事提醒。才赫然发现其实我一直在purge和wget的，不是http://a.b.com/index.jsp?pid=123456&amp;id=654321，而是http://a.b.com/index.jsp?pid=123456。linux把url里的&amp;当作后台运行的命令执行了……而access.log中为了安全又没记录?后的具体参数，于是傻傻的跟客户客服扯皮了N久……<br />
“squidclient -p 80  -m purge &lsquo;http://a.b.com/index.jsp?pid=123456&amp;amp;id=654321&rsquo;”这么一刷立刻就好了~~<br />
由此告诫自己，以后一定要严谨行事，引号最好还是要养成习惯都给带上~~
      <a href="/2010/01/13/refresh-cache-of-interrogation-url/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/13/refresh-cache-by-php/" title="刷新squid缓存的php脚本" rel="bookmark">刷新squid缓存的php脚本</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-13 00:00:00 +0800">13 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#CDN-ref" title="CDN" rel="category tag">CDN</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <div class="highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">interface</span> <span class="nx">Flush_Cache</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">flush</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">Flush_Cache_HTTP_Header_Impl</span> <span class="k">implements</span> <span class="nx">Flush_Cache</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">flush</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$url</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$url_component</span> <span class="o">=</span> <span class="nb">parse_url</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
        <span class="k">global</span> <span class="nv">$g_squid_servers</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$g_squid_servers</span> <span class="k">as</span> <span class="nv">$server</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nv">$squid_params</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="s1">':'</span> <span class="p">,</span> <span class="nv">$server</span><span class="p">);</span>
            <span class="nv">$fsocket</span> <span class="o">=</span> <span class="nb">fsockopen</span><span class="p">(</span><span class="nv">$squid_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$squid_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nv">$errono</span><span class="p">,</span> <span class="nv">$errstr</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="k">FALSE</span> <span class="o">!=</span> <span class="nv">$fsocket</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nv">$head</span> <span class="o">=</span> <span class="s2">"HEAD </span><span class="si">{</span><span class="nv">$url_component</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]}</span> <span class="nx">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="nx">rn</span><span class="s2">";
                </span><span class="nv">$head</span><span class="s2"> .= "</span><span class="nx">Accept</span><span class="o">:</span> <span class="o">*/*</span><span class="nx">rn</span><span class="s2">";
                </span><span class="nv">$head</span><span class="s2"> .= "</span><span class="nx">Host</span><span class="o">:</span> <span class="p">{</span><span class="nv">$url_component</span><span class="p">[</span><span class="s1">'host'</span><span class="p">]}</span><span class="nx">rn</span><span class="s2">";
                </span><span class="nv">$head</span><span class="s2"> .= "</span><span class="nx">Cache</span><span class="o">-</span><span class="nx">Control</span><span class="o">:</span> <span class="nx">no</span><span class="o">-</span><span class="nx">cachern</span><span class="s2">";
                </span><span class="nv">$head</span><span class="s2"> .= "</span><span class="nx">rn</span><span class="s2">";
                echo </span><span class="nv">$head</span><span class="s2">;
                fwrite(</span><span class="nv">$fsocket</span><span class="s2"> , </span><span class="nv">$head</span><span class="s2">);
                while (!feof(</span><span class="nv">$fsocket</span><span class="s2">))
                {
                    </span><span class="nv">$line</span><span class="s2"> = fread(</span><span class="nv">$fsocket</span><span class="s2"> , 4096);
                    echo </span><span class="nv">$line</span><span class="s2">;
                }
                fclose(</span><span class="nv">$fsocket</span><span class="s2">);
            }
        }
    }
}
</span><span class="nv">$g_squid_servers</span><span class="s2"> = array('192.168.2.88:80');
</span><span class="nv">$flush_cache</span><span class="s2"> = new Flush_Cache_HTTP_Header_Impl();
</span><span class="nv">$flush_cache-&gt;flush</span><span class="s2">('http://ent.cdqss.com/index.html');
?&gt;
</span></code></pre>
</div>
      <a href="/2010/01/13/refresh-cache-by-php/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/10/zz-intro-acls-in-squid/" title="Squid的ACL分类" rel="bookmark">Squid的ACL分类</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-10 00:00:00 +0800">10 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>在找http_status的acl用法时，看到这么一句“This clause supports both fast and slow acl types”。acl还分快慢呢~~赶紧去wiki看：<a href="http://wiki.squid-cache.org/SquidFaq/SquidAcl#Fast_and_Slow_ACLs">http://wiki.squid-cache.org/SquidFaq/SquidAcl#Fast_and_Slow_ACLs</a>
      <a href="/2010/01/10/zz-intro-acls-in-squid/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/09/keep-sessions-between-client-cache-origin/" title="client-cache-origin之间的session问题" rel="bookmark">client-cache-origin之间的session问题</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-09 00:00:00 +0800">09 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#CDN-ref" title="CDN" rel="category tag">CDN</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>昨天，突然接到某客户的邮件，表示他们质疑我们cache对其多originserver的轮询不均等，以至于影响到网站的访问。<br />
听起来不是什么难题，把服务器上的DNSCache进程中止掉，不就能平均轮询了么？可是操作完成后，客户依然不认可……于是开始细细探讨具体的错误问题所在。<br />
原来实际情况是这样：点击其网站的回复、收藏等动态页面时，时常会弹出错误页面。对这个错误页面，客户的解释是“session状态CDN加速未保留”。<br />
由此解释，我觉得cache上的问题恰恰相反，正是因为均等轮询了导致的。而客户其他一些单源的域名服务正常，也证明了这点。<br />
上cache服务器查看配置，使用的默认keep-alive设置，也就是对client和origin都开启了keep-alive，默认时间为2min。但实际上并没有起作用。在测试中，可以看到这样的日志：
      <a href="/2010/01/09/keep-sessions-between-client-cache-origin/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/09/intro-http_status/" title="squid3新acl类型http_status试用（源站故障转向研究）" rel="bookmark">squid3新acl类型http_status试用（源站故障转向研究）</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-09 00:00:00 +0800">09 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>今天试着自己编译安装了squid3.1，然后开始移植2.6的配置文件。在squid.conf.document（2.6里的squid.conf.default）里看了很久，发现不少新东西。跟转向有关的，便发现一个：
      <a href="/2010/01/09/intro-http_status/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/05/principle-and-solution-of-the-vm-date-problem/" title="虚拟机时间问题的机制原理及解决办法" rel="bookmark">虚拟机时间问题的机制原理及解决办法</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-05 00:00:00 +0800">05 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cloud-ref" title="cloud" rel="category tag">cloud</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>对于CDN来说，时间是个非常重要的概念，squid的缓存刷新控制，全都是以服务器时间为基准。在我博客的前不知道几篇的某文中，就提到过因为时间的原因引起的刷新事故。而最新的一次，是公司在日志流量统计时，因为相差太大导致截取失败——这可都是钱呢。<br />
实际工作中，大多会搭建一个NTP服务器，给应用服务器提供时间同步服务。但虚拟机在这方面有个问题。虚拟机的时间是读取的宿主机的硬件时钟，随便你date<br />
-s 1234怎么改，下一次date查看，都会恢复成原样。<br />
这样看起来是个好事，因为这样可以省略掉大批机器的NTP服务器同步时间的压力。但糟糕的事情在后头：一大批重要客户的虚拟机，在运行上半年以上时间后，date都比真实时间超前了（偶然我也看到过一次滞后的）。或许是几分钟，或许是几小时！！<br />
这一度让我很无奈，因为即使我重启虚拟机，这个诡异的date也依然倔强的按照它自己的时钟前进。看起来办法只有一个：把虚拟平台整个的重启——好在这种试验的结果是有效的，不然真不知道怎么办了。<br />
从这个无奈的办法中，也应该可以推测出一个结论，虚拟机的时钟，应该是另有文件存储在虚拟平台的某个临时文件里。所以关闭虚拟机，该文件还存在并继续计时；重启动虚拟平台，该文件才会重计。至于这个文件叫什么，存放在哪里，一时半会我就找不到了，或许这个问题不算什么特别大的问题，至少我在linuxsir.org的《xen初学指南》中，没有找到关于时钟的配置说明。<br />
不过再小的问题也顶不住人的研究。于是我找到了另一篇很对口的文章：《虚拟机中GUEST OS时钟(TIMEKEEP)问题的探讨》。<br />
文章告诉我们：虚拟机的时钟，与真实机的时钟区别，其一在于其处理不是抢占中断而是延迟处理；其二在于其中断模拟软件可能因资源占用问题被推迟。<br />
这两点区别，导致的结果却是一个，就是一旦服务器负载变高，时钟中断就被排到后头去了……<br />
文章也提出了解决办法，一个是编程，让系统补上中断的时间，这个俺就不说了；一个是修改内核，让系统不断修正date；<br />
进一步问题：不管哪个办法，第一，加重了虚拟机负载；第二，这又依赖与系统去更新date的进程的精准度，而这个进程的中断时钟如果有偏差的话，……<br />
再进一步方法……有兴趣的还是自己点文章看吧。<br />
看起来这个问题就要永远终结在此了。<br />
不过变通的主意及时的出现了——既然虚拟机跟虚拟平台之间的异步时钟同步没法解决，我们就干脆不要虚拟机跟虚拟平台同步了。这样虽然对NTP的压力大了，但毕竟保证了CDN的正常。而且从上头的原理可以知道，能够导致date偏差到这个程度的原因，大概也是因为虚拟机的负载压力太大。事实上，我们为了保证冗余，也是尽量避免这种压力出现的。那么date偏差的服务器，其实也就是少数了。<br />
顺着这个思路一查，原来办法其实很简单——修改虚拟机的independent_wallclock值即可：<br />
echo 1 &gt; /proc/sys/xen/independent_wallclock<br />
或sysctl xen.independent_wallclock=1<br />
启用虚拟机独立系统时间；<br />
/etc/init.d/ntpd stop<br />
ntpdate 192.168.0.1<br />
就能完成NTP时间同步了；<br />
再date看看，时间果然就更正了~~<br />
/proc下的文件都是进程使用中的文件，如果要让虚拟机开机自动读取配置，把这个修改写进/etc/sysctl.conf才行哦：<br />
echo &ldquo;xen.independent_wallclock = 1&rdquo;&nbsp;&raquo; /etc/sysctl.conf<br />
就这么简单~~~
      <a href="/2010/01/05/principle-and-solution-of-the-vm-date-problem/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2010/01/01/limit-speed-in-squid/" title="squid限速" rel="bookmark">squid限速</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-01 00:00:00 +0800">01 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>squid有个delay_pool，可以做限速，虽然效果不太准~（嗯，就像限制并发连接数的maxconn一样）<br />
首先搬个老虎皮做大旗——《Squid: The Definitive Guide》的相关段落：
      <a href="/2010/01/01/limit-speed-in-squid/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2009/12/31/process-of-request-to-squid/" title="squid请求处理流程（源站故障转向研究）" rel="bookmark">squid请求处理流程（源站故障转向研究）</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-31 00:00:00 +0800">31 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>今天继续想别的办法，第一，当然还是修改源代码，这个C++可惜俺不懂，只是大略的通过百大哥谷大婶知道了squid的请求处理流程：
      <a href="/2009/12/31/process-of-request-to-squid/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2009/12/30/system-function-in-awk/" title="awk中让人郁闷的system()函数" rel="bookmark">awk中让人郁闷的system()函数</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-30 00:00:00 +0800">30 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>发现一个特尴尬的事实。我辛辛苦苦去百度资料，想用rewrite实现针对不同域名源站故障后的自动跳转功能，但整个思路里遗漏了一个严重的问题。
      <a href="/2009/12/30/system-function-in-awk/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2009/12/30/squid-gzip/" title="squid3 的 gzip 支持" rel="bookmark">squid3 的 gzip 支持</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-30 00:00:00 +0800">30 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>标题很简单，内容很复杂，而且我也用不上。姑且存档吧：<br />
原标题《VIGOS eCAP GZIP Adapter for SQUID Proxy Cache》<br />
第一句话就让我很绝望，本插件只适用于squid3.1及以上版本——squid有比3.1更高的版本么——前文提到的有session控制的squid2.7我都还没看呢~哭
      <a href="/2009/12/30/squid-gzip/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2009/12/30/a-reverse-example-of-url_rewrite_program/" title="url_rewrite_program（squid游戏恶搞~）" rel="bookmark">url_rewrite_program（squid游戏恶搞~）</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-30 00:00:00 +0800">30 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>标题很引人吧。其实是我在查找squid的rewrite资料时，看到的一篇文章。原作者突发奇想，准备让公司的同事们上网时，看到的所有图片全都倒过来180°。嘿嘿，小样，还不拧断你们脖子~~
      <a href="/2009/12/30/a-reverse-example-of-url_rewrite_program/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2009/12/30/a-location-example-of-url_rewrite_program/" title="url_rewrite_program（首次访问跳转）" rel="bookmark">url_rewrite_program（首次访问跳转）</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-30 00:00:00 +0800">30 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>上文提到，squid大多数的rewrite_program是用perl编写的。现在就转几个简洁明了的redirect.pl。虽说我至今没把perl基础教程看完。不过从中领会一下squid的rewrite流程，还是可以的：
      <a href="/2009/12/30/a-location-example-of-url_rewrite_program/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2009/12/30/a-location-example-of-squid_session/" title="squid_session（首次访问跳转）" rel="bookmark">squid_session（首次访问跳转）</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-30 00:00:00 +0800">30 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>上文perl例二中提到的第一次上某网站时先跳转公司主页。在CU上看到另一种办法。即在squid2.7以上版本中，有个squid_session。操作如下：<br />
首先是安装：<br />
安装squid ( for 2.7 stable )<br />
修改源代码：vi src/errorpage.c 60行处将
      <a href="/2009/12/30/a-location-example-of-squid_session/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2009/12/30/502-error-in-nginx/" title="nginx502错误" rel="bookmark">nginx502错误</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-30 00:00:00 +0800">30 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
    <p>NGINX 502 Bad Gateway错误是FastCGI有问题，造成NGINX 502错误的可能性比较多。将网上找到的一些和502 Bad Gateway错误有关的问题和排查方法列一下，先从FastCGI配置入手：
      <a href="/2009/12/30/502-error-in-nginx/" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page16">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li class="page active">
      <a href="#">17</a>
    </li>
    <li class="page">
      <a href="/page18">18</a>
    </li>
    <li class="page">
      <a href="/page19">19</a>
    </li>
    <li>
      <a href="/page18">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
                 <li><a href="/2015/10/29/siren/">SIREn 插件试用</a></li>
                 <li><a href="/2015/10/25/escc/">ESCC 参会笔记</a></li>
                 <li><a href="/2015/10/20/escc/">ESCC 参会笔记</a></li>
                 <li><a href="/2015/09/24/condition-in-rsyslog/">rsyslog 中 if 条件判断的限制</a></li>
                 <li><a href="/2015/08/25/kibana-custom-field-formatters/">【翻译】Kibana 字段的自定义展示格式开发</a></li>
                 <li><a href="/2015/04/03/types-mapping-conflict-in-one-index/">Elasticsearch 同一索引不同类型下同名字段的映射冲突实例</a></li>
                 <li><a href="/2015/03/14/spark-streaming-kafka/">spark streaming 接收 kafka 数据示例</a></li>
                 <li><a href="/2015/03/14/kibana3-source-code-analysis/">Kibana 3 源码解析</a></li>
                 <li><a href="/2015/03/06/kibana4-for-slowlog/">用 Kibana4 实现 PHP 慢日志函数堆栈分析</a></li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
              <li><a href="http://showmetheco.de/" title="Viacheslav Tykhanovskyi(PocketIO/Text::Haml)">No time to wait</a></li>
              <li><a href="http://blog.dataloop.io/" title="A new SaaS monitoring tool for DevOps & Operations">Dataloop.IO</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://planeteria.org/perl6/" title="Perl6 文集">Planet Perl 6</a></li>
              <li><a href="http://www.metaforsoftware.com/blog/" title="">metafor</a></li>
              <li><a href="http://blog.kablamo.org/" title="Eric Johnson，一个游走在伦敦和北京的 Perler">kablamo</a></li>
              <li><a href="http://aphyr.com/posts" title="call me maybe 吐槽系列">Aphyr</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://timo.piqiu.me/" title="TIMO IS MY OASIS">Timo</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.lark.net.cn/" title="王剑">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://junqili.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://blog.l8ii.com/" title="刘侨">LairdNote</a></li>
              <li><a href="http://flw.tools/" title="">flw的工具箱</a></li>
              <li><a href="http://blog.mcshell.org/" title="">mcshell</a></li>
              <li><a href="http://novoland.github.io/" title="">克鲁斯卡尔的博客</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="booklists" class="nav nav-list">
          <li class="nav-header">我写的技术书籍</li>
          <li><a href='http://product.china-pub.com/3769604'><img src='http://images.china-pub.com/ebook3765001-3770000/3769604/shupi.jpg' border='0' alt='网站运维技术与实践'/></a></li>
          <li><a href='http://product.china-pub.com/64005'><img src='http://images.china-pub.com/ebook60001-65000/64005/shupi.jpg' border='0' alt='ELK Stack权威指南'/></a></li>
          <li class="nav-header">我参与翻译的技术书籍</li>
          <li><a href='http://product.china-pub.com/4582714'><img src='http://images.china-pub.com/ebook4580001-4585000/4582714/shupi.jpg' border='0' alt='Puppet 实战手册'/></a></li>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2015 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
  </body>
</html>
