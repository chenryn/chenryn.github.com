<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/04/13/test-inode-support-of-reiserfs-xfs" title="reiserfs和xfs的inode测试" rel="bookmark">reiserfs和xfs的inode测试</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-04-13 00:00:00 +0800">13 Apr 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#testing-ref" title="testing" rel="category tag">testing</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>某应用的碎文件生成太多，大量消耗inode，不得不做迁移调整。
原先的使用的NetApp存储，虽然可以调节inode，但是有一个上限，最高就是40000000——说实话真的挺小的啊~~
一个同样大小的普通服务器ext3文件系统，在没有强行指定的情况下，inode都有将近3个亿，是netapp的7倍。
了解了一下ext3文件系统在分区时指定inode最大可用数的情况，大致可以理解为小于可用空间大小/256。详细分析测试情况见：http://blog.wgzhao.com/2008/04/13/how-much-inodes-do-you-need.html，大意是inode个数由block大小和单个inode的字节决定。理论上最小block是1024，实际（采用-N强行指定的话）可能是256左右。</p>
<p>之前在做sersync的时候，发现开启xfs支持就可以对netapp使用inotify功能。因此可以认为netapp使用是（至少在inode上）类似xfs的文件系统。最终决定测试一个reiserfs和xfs在inode方面的情况——这两个文件系统都是非分布式的动态inode的文件系统。
RHEL5默认是不支持这两个fs的。需要plus一下。方法见http://www.gnutoolbox.com/reiserfs-centos/和http://wiki.centos.org/AdditionalResources/Repositories/CentOSPlus的说明。一步一步照做即可。
随后在vmware上添加一块10G的硬盘sdb，fdisk分区成sdb1和sdb2，分别mkfs.reiser和mkfs.xfs两个分区，挂载在/mnt1和/mnt2上。
这个时候df -h和df -i查看如下：
[root@localhost ~]# df -i
Filesystem            Inodes   IUsed   IFree IUse% Mounted on
/dev/sda3            1240320  144694 1095626   12% /
/dev/sda1              26104      40   26064    1% /boot
/tmpfs                 64314       1   64313    1% /dev/shm
/dev/sdb1                  0       0       0    -  /mnt1
/dev/sdb2             562240    2368  559872    1% /mnt2
[root@localhost ~]# df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/sda3              19G  4.8G   14G  27% /
/dev/sda1              99M   17M   77M  18% /boot
/tmpfs                252M     0  252M   0% /dev/shm
/dev/sdb1             471M  33M  438M   7% /mnt1
/dev/sdb2             545M   28M  517M   6% /mnt2
另开窗口，分别运行for((i=1;i&lt;562240;i++));do touch /mnt1/a<em>$i;done和for((i=1;i&lt;562240;i++));do touch /mnt2/b</em>$i;done——为了加速，实际开了四个窗口，每个命令都是同时运行两个。
一段时间后，mnt2的终端显示No space。于是中止。
此时df -i和df -h的结果如下：
[root@localhost ~]# df -i
Filesystem            Inodes   IUsed   IFree IUse% Mounted on
/dev/sda3            1240320  144694 1095626   12% /
/dev/sda1              26104      40   26064    1% /boot
/tmpfs                 64314       1   64313    1% /dev/shm
/dev/sdb1                  0       0       0    -  /mnt1
/dev/sdb2             124032  123397     635  100% /mnt2
[root@localhost ~]# df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/sda3              19G  4.8G   14G  27% /
/dev/sda1              99M   17M   77M  18% /boot
/tmpfs                252M     0  252M   0% /dev/shm
/dev/sdb1             471M   60M  411M  13% /mnt1
/dev/sdb2             545M  545M  144K 100% /mnt2
可以发现，xfs的空间没有变化（说这句是因为ext3在强制inode数变大的时候，可用空间会变小），但inode总数“神奇”的缩水了4倍！！
继续等待，直到mnt1的for循环执行完成，这时候df -h结果如下：[root@localhost ~]# df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/sda3              19G  4.8G   14G  27% /
/dev/sda1              99M   17M   77M  18% /boot
/tmpfs                252M     0  252M   0% /dev/shm
/dev/sdb1             471M  134M  338M  29% /mnt
根据最后的结果算471<em>1024/562240/2=0.43K， 545</em>1024/124032=4.5K。看来对于空文件，reiserfs很压缩，而xfs则老老实实的做block了。</p>
      <a href="/2011/04/13/test-inode-support-of-reiserfs-xfs" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/04/05/learning-suse-linux-enterprise-desktop-system-analysis-and-tuning-guide" title="《SUSE Linux Enterprise Desktop System Analysis and Tuning Guide》读书笔记" rel="bookmark">《SUSE Linux Enterprise Desktop System Analysis and Tuning Guide》读书笔记</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-04-05 00:00:00 +0800">05 Apr 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>这是一本比上篇提到的老书新很多、厚很多的调优指南。虽然至今没用过suse，但同是linux内核，与redhat差距不算太大。目前只打印并看到了systemtap章节，感觉很多内容说的比上本书细致的多，继续做笔记~
<!--more-->
1 General Notes on System Tuning
1.2 Rule Out Common Problems
检查/var/log/warn和/var/log/messages中的异常条目；
用top或ps命令检查是否有进程吃了太多CPU和内存；
通过/proc/net/dev检查网络问题；
用smartmontools检查硬盘IO问题；
确认后台进程都是在系统负载较低的时候运行的，可以通过nice命令调整其优先级；
一台服务器运行太多使用相同资源的服务的话，考虑拆分；
升级软件。
2 System Monitoring Utilities
2.1 Multi-Purpose Tools
2.1.1 vmstat
第一行输出显示的从最近一次重启以来的平均值
各列说明：
r 运行队列中的进程数。这些进程等待cpu的空闲以便执行。如果该数值长期大于cpu核数，说明cpu不足；
b 等待除了cpu以外的其他资源的进程数。通常是IO不足；
swpd 已用swap空间，单位KB；
free 未用内存空间，单位KB；
inact 可以回收的未用内存空间，只有当使用-a参数时才显示——建议使用该参数；
active 使用中且没有回收的内存空间，同样只在-a时显示；
buff 内存中的文件缓冲空间；相反，-a时不显示；
cache 内存中的页缓存空间；-a不显示；
si 每秒从内存移动到swap的数据大小，单位KB；
so 每秒从swap移动到内存的数据大小，单位KB，以上两个数长期偏大的话，机器需要加内存；
bi 每秒从块设备中获取的块数量——注意swap也是块设备，包含在内！
bo 每秒发送到块设备的块数量，同样包括swap；
in 每秒中断数，数值越大说明IO级别越高；
cs 每秒文本交换数，这个代表内核从内存中某进程中提取替换掉另一个进程的可执行代码——茫然？？
us 用户空间的cpu使用率；
sy 系统空间的cpu使用率；
id cpu时间中的空闲比——就算它是0，也不一定就是什么坏事，还得看r和b两个数值来判断；
wa 如果这个数不等于0，那说明系统吞吐在等待IO。这或许是不可避免的。比如如果一个文件是第一次被读取（即没有缓存），那同时的后台写必然挂起。这个数也是硬件瓶颈的一个指标（网络或者磁盘）。最后，还有可能是虚拟内存管理上的问题；
st cpu用在虚拟管理上的比例。
2.1.2 System Activity Information: sar and sadc
sadc其实就是在/etc/cron.d中添加的任务。原始数据写入/var/log/sa/saDD中，报告数据写入/var/logs/sar/sarDD中。默认配置，数据每10分钟一收集；报告每6小时一收集。详见/etc/sysstat/sysstat.cron；数据收集脚本是/usr/lib64/sa/sa1；数据报告脚本是/usr/lib64/sa/sa2；有必要的话可以自己用这两个脚本收集性能数据。
sar -f指定特定的数据文件出报告
sar -P指定某一个CPU出报告
sar -r显示内存信息：kbcommit和%commit显示了当前工作负载下可能需要的最大内存（含swap）；
sar -B显示内核页信息：majflt/s显示了每秒钟有多少页从硬盘（含swap）读入内存，这个数太大意味着系统很慢，而且内存不足；%vmeff显示了页扫描(pascand/s)及其相关的缓冲重用率(pgsteal/s),用以衡量页面回收的效率，数值接近100说明所有so的页都重用了，接近0说明没有被扫描的页，这都很好，但不要在0-30%之间。
sar -d显示块设备信息，最好加上-p显示设备名；
sar -n显示网络信息，包括DEV/EDEV/NFS/NFSD/SOCK/ALL
2.2 System Information
2.2.1 iostat
-n显示nfs；
-x显示增强型信息；
2.2.3 pidstat
-C &ldquo;top&rdquo;显示命令名中包括top字符串的目标。
2.2.5 lsof
无参数：打开的所有文件
-i：网络文件
2.2.6 udevadm
本工具只有root可以使用
2.3 Processes
2.3.2 ps
显示具体某进程：ps -p $(pidof ssh)
显示格式和排序：ps ax &ndash;format pid,rss,cmd &ndash;sort rss
显示单独进程：ps axo pid,$cpu,rss,vsz,args,wchan,etime
显示进程树：ps axfo pid,args
2.3.4 top
默认每2秒钟一刷新；
显示一次即退出：-n 1
shift+p——以CPU使用率排列(默认)；
shift+m——以常驻内存排列；
shift+n——以进程号排列；
shift+t——以时间排列；
2.4 Memory
2.4.1 free
free -d 1.5——每1.5秒一刷新数据
2.4.3 smaps
在/proc/${pid}/smaps中看到的是进程当前的内存页数量，即除掉共享内存以外的真正进程使用的内存大小。
2.5 Networking
2.5.1 netstat
-r路由；-i网卡；-M伪装链接；-g广播成员；-s信息
2.5.2 iptraf
iptraf -i eth0 -t 1 -B -L iptraf.log
eth0网卡一分钟内的信息，后台收集，记入iptraf.log中。
2.6 The /proc File System
/proc/devices 可用设备
/proc/modules 已加载内核模块
/proc/cmdline 内核命令行
/proc/meminfo 内存使用详细信息
/proc/config.gz 内核当前运行配置的压缩文件
详细说明见/usr/src/linux/Documentation/filesystems/proc.txt
执行的进程和库文件以及他们在内存的地址信息见/proc/***/maps文件。</p>
      <a href="/2011/04/05/learning-suse-linux-enterprise-desktop-system-analysis-and-tuning-guide" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/04/01/learning-tuning-red-hat-enterprise-linux-on-ibm-server-xseries-servers" title="《Tuning Red Hat Enterprise Linux on IBM server xSeries Servers》读书笔记" rel="bookmark">《Tuning Red Hat Enterprise Linux on IBM server xSeries Servers》读书笔记</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-04-01 00:00:00 +0800">01 Apr 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一本很老的书，还是RHEL3时代的，在陪GF的空隙一点点读完，把笔记整理一下发在这里，只包括自己不知道或者说容易忘记的内容，不代表调优指南。<!--more-->
1 Tuning the operating system
1.1 Disabling daemons
关闭不必要的后台进程。RHEL3中，默认启动的后台进程有：
apmd 高级电源管理
autofs 自动挂载
cups 通用UNIX打印机系统
hpoj 惠普打印机支持
isdn 调制解调器
netfs nfslock portmap NFS支持
pcmcia PCMCIA支持
rhnsd 自动升级
sendmail 邮件转发程序
xfs 桌面程序
1.2 Shutting down the GUI
runlevel:
0 halt立刻关机immediately shut down
1 single单人
2 multi-user without NFS（这个说明和一般的说法不太一样~）
3 full multi-user
5 X11
6 reboot
修改/etc/inittab如下：
id:3:initdefault:		#runlevel
#4:2345:respawn:/sbin/mingetty tty4		#关闭多余控制台
注意：留3个，以免在被攻击的时候自己反而进不去了！
1.4 Changing kernel parameters
/proc/loadavg 系统负载1/5/15分钟
/proc/stat 内核状态：进程/swap/磁盘IO
/proc/cpuinfo CPU信息
/proc/meminfoo 内存信息
/proc/sys/fs/* linux可用文件数及磁盘配额
/proc/sys/kernel/* 进程号范围/系统日志级别
/proc/sys/net/* 网络细节
/proc/sys/vm/* 内存缓冲管理
1.7 Tuning the processor subsystem
CPU超线程注意事项:
注意使用SMP的kernel
实际CPU数越多，超线程意义越小：
2核：提升15-25%
4核：提升1-1%
8核：提升0-5%
1.8 Tuning the memory subsystem
如果决定调整/proc/sys/vm/*的参数，最好一次只调整一个。
vm.dbflush前3个参数分别为：
nfract 在buffer被转存到disk前允许的最大buffer比率
ndirty 将buffer转到disk时一次允许操作最大的buffer数
nfract_sync 转存时允许buffer中dirty数据的最大比率
vm.kswapd
tries_base 一次swap传输时的pages数。如果swapping较大，适当增加该值
tries_min kswapd运行时交换的pages的最小数
swap_cluster kswapd一次写入pages的数。太小会增加IO次数，太大又要等待请求队列
1.9 Tuning the file subsystem
磁盘访问速度是ms级别的，而内存是ns，PCI是us。
磁盘IO是最关键的问题服务器举例：
文件/打印服务器：所有数据从磁盘读取
数据库服务器：大量IO，在内存和磁盘间交换数据
磁盘IO不是最关键的问题服务器举例：
邮件服务器：网络状况才是最关键的。
web服务器：网络和内存才是最关键的&hellip;..
1.9.5 The swap partition
创建多个swap区有助于提升swap性能
通常情况，多个swap采用顺序读写，即只有/etc/fstab中排名在前的swap区耗尽的情况下，才会使用下一个swap区；
可以在fstab中定义优先级，类似&rdquo;/dev/sda2 swap swap sw,pri=5 0 0&rdquo;的格式；
相同优先级的swap区，系统会并发使用，不同优先级之间依然要等待耗尽！——另外，如果相同优先级的swap区有一个性能较差，会连带影响整个swap性能。
1.10 Tuning the network subsystem
网络问题经常会导致其他伴生问题。比如：块大小太小会给CPU利用率带来显著影响；TCP连接数过多会带来内存使用率的急速上升……
经常被打开的net.ipv4.tcp_tw_reuse和net.ipv4.tcp_tw_recycle的作用：缓存TCP交互中的客户端信息，包括交互时间、最大段大小，阻塞窗口。详见RFC1644。
net.ipv4.tcp_fin_timeout可以缩短TCP建连时最后发送FIN序列的时间，以便快速释放内存提供给新进连接请求。但是修改这个的时候也要谨慎，因为由此导致的死套接字数量可能引起内存溢出！
net.core.wmem_max/net.core.rmem_max定义在每个TCP套接字创建时划分的内存大小，推荐设置8MB。
net.ipv4.tcp_wmem/net.ipv4.tcp_rmem的最后一个数字不能大于上面core的定义。
net.ipv4.tcp_max_syn_backlog队列存放半连接。这些连接可能是因为客户端的连接异常，也可能仅仅是因为服务器负载太高导致。除了半连接，这个配置对防范拒绝服务攻击也有效。
net.ipv4.ipfrag_low_thresh/net.ipv4.ipfrag_high_thresh规范ip碎片，一旦触底，内核会开始丢包。这对于NFS和samba等文件服务器很重要，建议设置为256和384MB。
2 Tuning tools
2.3 top
STAT:S=SLEEPING,R=RUNNING,T=TRACED/STOPPED,D=INTERRUPTIBLE SLEEP,Z=ZOMBIE
2.3.1 Process priority and nice levels
优先级从19（最低）到-19（最高），默认是0。启动进程时指定nice -n 19 command，启动后改变renice 19 command
2.4 iostat
tps:transfers per second,多个单独的IO请求，可以组合在一次transfer请求中。
Blk_read/s,Blk_wrtn/s:每秒的读写块个数。block大小和transfer大小一样各不相同。一般是1、2、4KB，采用如下命令查看：dumpe2fs -h /dev/sda1 | grep -F &lsquo;Block Size&rsquo;
2.5 vmstat
Process：r:等待运行的进程数，b:不可中断睡眠中的进程数
Swap：单位是KBps
CPU：us:非内核时间，包括user和nice，id:在linux2.5.41前，这个数值包括了IOwait时间在内……
2.11 ulimit
-H和-S分别是hard和soft，开机启动指定的话，修改/etc/security/limits.conf即可。
2.12 mpstat
用来在多CPU的机器上查看每个CPU的情况。
3. Analyzing performance bottlenecks
3.1 Identifying bottlenecks
快速调优策略：
a. 了解你的系统；
b. 备份系统；
c. 监控、分析系统性能；
d. 缩小瓶颈，找出根源；
e. 解决瓶颈的时候一次只修改一个地方；
f. 返回c步骤继续，直到满意。
3.1.1 Gathering information
在收到“服务器出问题了”的报警时，提出下列问题，可以更加有效地收集信息进行故障定位：
Q:服务器的完整描述？包括：模块、使用时长、配置、外围设备、操作系统版本号……
Q:能准确描述一下问题所在么？包括：症状表现、各种错误日志记录……
Q:问题是谁碰到/发现的？一个人、某些特定的人群，还是所有的用户？由此可以大概猜测问题是网络、应用还是客户电脑。另外：性能问题可能不会立刻从服务器反应到客户端上来，因为网络延迟经常会覆盖掉其他问题。这个延迟包括网络设备，也包括其他服务器提供的网络服务，比如域名解析~
Q:问题可以再现么？所有可以再现的问题都是可以解决的！
重现故障的步骤是什么？这可以协助你在测试环境完成调优工作。
问题是持续发生的么？如果是断续发生的，赶紧找出让它重现的办法，最好就是能按你的剧本指令重现……
问题是不是周期性的固定某个时间发生？查查那时候是不是有人登陆了？尝试梗概系统，看问题会重现么？
问题真的很不常见？如果真是如此，那只能说rp有问题了，事实上，绝大多数问题都是可重现的~对没法重现的，那就出网管绝招：reboot、然后更新升级驱动和补丁。
Q:问题什么时候开始的？逐渐显现还是突然爆发？如果是逐渐，那应该是积累出来的；如果是突然，那考虑是不是外设做了改动。
Q:服务器是不是有变动，或者客户端的使用方法变了？
Q:事情紧急么？要求几分钟内搞定还是未来几天？
3.1.2 Analyzing the server&rsquo;s performance
在任何排障动作前，牢记备份！！
有必要为服务器创建一份性能日志，内容包括：进程、系统、工作队列、内存、交换页、磁盘、重定向、网卡……
3.2 CPU bottlenecks
动态应用/数据库服务器，CPU常常是瓶颈，但实际经常是CPU在等待其他方面的响应。
3.2.1 Finding CPU boottlenecks
注意：同时不要运行多个工具，以免给CPU增加负载
3.2.2 SMP
进程在CPU之间进行切换时需要消耗一点的时间，所以绑定CPU比较有用。
3.2.3 Performance tuning options
关闭非必须进程；调成优先级；绑定CPU；CPU主频，是否多核；更新驱动；
3.3 Memory bottlenecks
free命令参数-l -t -o，分别表示low/high，total，old（不显示buffer信息）
3.3.2 Performance tuning options
调整页大小，默认是4/8KB；限定user资源limits.conf；……
3.4 Disk bottlenecks
常见问题：一、硬盘数太少；二、分区数太多，导致磁头寻址时间变大。
3.4.1 Finding disk bottlenecks
写缓冲；磁盘控制器负载；网络延时导致响应慢；IO等待队列
随机读写还是顺序读写？单次IO大还是小？
表3-2
磁盘转速 latency seek-time random-access-time IOPS Throughout
15000    2ms      3.8ms      6.8ms                    147  1.15MBps
10000    3ms      4.9ms      8.9ms                    112  900KBps
7200     4.2ms    9ms        13.2ms                    75   600KBps
在一个大概70%读30%写的随机IO型正常负载的服务器上，采用RAID10比RAID5能提高50-60%的性能。
 打开文件太多时，会因为寻址时间太长导致响应的变慢
iostat的指标：
%util 被IO请求消耗的CPU比例
svctm 完成一个请求的平均时间，单位ms
await 一个IO请求等待服务的平均时间，单位ms
avgqu-sz 平均队列长度
avgrq-sz 平均请求大小
rrqm/s 发送到磁盘的每秒合并读请求数
wrqm/s 发送到磁盘的每秒合并写请求数
3.4.2 Performance tuning options
顺序读写换磁头；随机读写加磁盘；用硬件RAID卡；加内存
3.5 Network bottlenecks
    3.5.2 Performance tuning options
    检查路由配置；子网；网卡速率；TCP内核参数；换网卡；bonding
4 Tuning Apache
4.1 Gathering a baseline
吞吐量：每秒请求数和每秒传输字节数；请求处理响应时间……
4.5 Operating system optimization
文件打开数；进程数；文件访问时间——不记录atime的作用是消减IO峰值！
4.6 Apache 2 optimizations
如果文件是通过NFS方式发布的，apache不会采用sendfile方式缓存文件，配置文件请选择“EnableSendfile Off”！
4.6.1 Multi-processing module directives
经常需要重启的，加大StartServer；
负载较大的，加大MinSpareServers到25，MaxSpareServers到125；
MaxClients最大只能是256，内存不足时应该减少；
4.6.2 Compression of data
默认的6级压缩比，可以带来72%的带宽减小。太高级别压缩，对CPU有影响。
在测试中，启用压缩的apache带宽减小70%；cpu负载上升87%到饱和状态，能同时处理的客户端请求数降到三分之一。
vary头的作用：告知代理服务器对支持压缩的客户端只发送压缩后的内容。
apache2只在客户端请求包含Accept-encoding: gzip和Accept-encoding: gzip, deflate的时候才压缩数据。
4.6.3 Logging
使用WebBench的时候，一般会有2%的请求是404的，这可能导致error_log迅速变大！
5 Tuning database servers
5.1 Important subsystems
CPU：
数据库都是多线程的，最好使用16核以上CPU，2级缓存相当重要，命中率最好在90%以上；
内存：
缓冲是数据库最重要的部分。编译内核时请确认CONFIG_HIGHMEM64G_HIGHPTE=y这项。
磁盘：
数据库会有大量的磁盘IO以完成数据在内存和硬盘的交换。一般每个xeon的CPU需要对应10块高速硬盘，最好能有50块10000转的磁盘。IBM的xSeries 370使用450块10000转磁盘以达到最大吞吐量——每分钟40000次交换。</p>
<p>笔记到此为止。之后的内容是DB2的调优，samba、ldap、lotus章节，就没看了……</p>
      <a href="/2011/04/01/learning-tuning-red-hat-enterprise-linux-on-ibm-server-xseries-servers" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/31/problem-of-php-compile-option" title="php编译参数问题一例" rel="bookmark">php编译参数问题一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-31 00:00:00 +0800">31 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#php-ref" title="php" rel="category tag">php</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>某php应用在给图片加水印的时候，显示的中文全都成了乱码，而开发同事在它本机(ubuntu)上apt安装的lamp上显示没有问题。仔细检查过了从env到encoding到phpinfo，都没有发现问题——都符合GD函数imagettftext()的utf8要求。
还好有google，发现一个类似的文章，提出是php的编译参数中有一个&ndash;enable-gd-jis-conv，会把ttf字库中非标准拉丁文的部分，按照日文顺序映射，imagettftext()的默认编码其实被隐形指定成了日文编码euc-jp，中文自然就不正常了！
然后赶紧重新看phpinfo，真有这个参数。重新编译php，随后恢复正常显示了。
编译参数还真是不能大意啊～～</p>
      <a href="/2011/03/31/problem-of-php-compile-option" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/28/using-awk-as-one-line-command" title="awk单行命令" rel="bookmark">awk单行命令</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-28 00:00:00 +0800">28 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一眨眼又几天没更新，中午在Q群里聊到一个单行命令，随手记录下。
A需求：某文件如下
aaa
bbb
aaa
aaa
ccc
aaa
ddd
……
通过命令改成如下格式：
1
bbb
3
5
ccc
7
ddd
……
方法如下：</p>
<div class="highlight"><pre><code class="bash"><span class="nb">echo</span> -en <span class="s1">&#39;aaa\nbbb\naaa\naaa\ndddd&#39;</span>|awk <span class="s1">&#39;BEGIN{tag=1}{if(/aaa/){print tag;tag+=2}else{print}}&#39;</span>
</code></pre></div>
<p>或者更短一点：</p>
<div class="highlight"><pre><code class="bash"><span class="nb">echo</span> -en <span class="s1">&#39;aaa\nbbb\naaa\naaa\ndddd&#39;</span>|awk <span class="s1">&#39;BEGIN{tag=1}{if(/aaa/){$0=tag;tag+=2};print}&#39;</span>
</code></pre></div>
<p>B需求：
aaa不是文件一行的全部内容，而只是一部分。
方法如下：</p>
<div class="highlight"><pre><code class="bash"><span class="nb">echo</span> -en <span class="s1">&#39;aaa\nbbb\naaa\nfdaaafdaaa\ndddd&#39;</span>|awk <span class="s1">&#39;BEGIN{tag=1}{gsub(/aaa/,tag) &amp;&amp; tag+=2;print}&#39;</span>
</code></pre></div>
<p>以上三种，凯的perl版本分别如下：</p>
<div class="highlight"><pre><code class="perl"><span class="n">perl</span> <span class="o">-</span><span class="n">nale</span> <span class="s">&#39;BEGIN{$tag = 1}if(/aaa/){print $tag;$tag+=2}else{print}&#39;</span>
<span class="n">perl</span> <span class="o">-</span><span class="n">nalpe</span> <span class="s">&#39;BEGIN{$tag = 1};$_=$tag and $tag+=2 if /aaa/&#39;</span>
<span class="n">perl</span> <span class="o">-</span><span class="n">nalpe</span> <span class="s">&#39;BEGIN{$tag = 1};$tag+=2 if s/aaa/$tag/&#39;</span>
</code></pre></div>
      <a href="/2011/03/28/using-awk-as-one-line-command" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/21/bsd_flow_monitor_by_awk" title="BSD上的流量监控脚本" rel="bookmark">BSD上的流量监控脚本</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-21 00:00:00 +0800">21 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前有过一篇linux上的流量监控脚本的博文，是利用procfs进行数据运算。但BSD上的procfs和linux有所不同，它只包含了进程的信息，没有系统的统计。所以只能通过其他方法。
linux上另一种获取网卡总流量的方法是ifconfig命令，这个命令其实也是读取proc；但是BSD上的ifconfig输出里也没有……
不过BSD上倒不是没法查流量上，事实上另外有两个命令，在实时观测中更加好用，一个是systat -if 1，几乎就是一个无色版的iptraf；另一个是netstat -idbhI bce0 1。
解释一下，systat是bsd上用来查看系统信息的一个超级利器，-if是-ifstat的简写，类似还有-vmstat等等。netstat是专门用来显示网络状态的，最常用的就是-ant显示所有的TCP链接，这里用的idbhI，表示interface、drop、bytes、human，也就是用方便读取的格式输出某网卡的流量值。
但是这两个命令，都是持续输出，必须接到^C信号才会退出运行。在实时管理时很好用，在做监控脚本的时候，就弄巧成拙了……
好在netstat参数多，调整一下，使用idbnf参数（family）即可输出网卡总流量值，然后按照linux上一样的思路进行计算了。
最终脚本如下：</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
/usr/local/bin/gawk <span class="s1">&#39;BEGIN{flow=&quot;netstat -idbnf inet&quot;;while((flow) | getline){now_in[$1]=$7;now_out[$1]=$10};time=systime()}{if_in[$1]=(now_in[$1]-$2)*8/(time-$4);if_out[$1]=(now_out[$1]-$3)*8/(time-$4)}END{printf &quot;OK. The flow is %.2f,%.2f,%.2f,%.2f Kbps | bce0_in=%d;0;0;0;0 bce0_out=%d;0;0;0;0 bce1_in=%d;0;0;0;0 bce1_out=%d;0;0;0;0&quot;,if_in[&quot;bce0&quot;]/1024,if_out[&quot;bce0&quot;]/1024,if_in[&quot;bce1&quot;]/1024,if_out[&quot;bce1&quot;]/1024,if_in[&quot;bce0&quot;],if_out[&quot;bce0&quot;],if_in[&quot;bce1&quot;],if_out[&quot;bce1&quot;];for(i in now_in){print i,now_in[i],now_out[i],time &gt; &quot;/tmp/if_flow.txt&quot;}}&#39;</span> /tmp/if_flow.txt
</code></pre></div>
<p>脚本就一行，不过就有一个缺点比不上分开写很多行的shell脚本，第一次运行前必须手动touch /tmp/if_flow.txt。因为如果这个文件不存在的话，awk会报错，执行不到END{}来，不会自动生成这个文件的……
另：systime()函数是gawk特有的，而BSD上默认的是awk，所以需要安装gawk（在/usr/ports/lang/gawk目录下make&amp;&amp;make install）；或者在awk中采用shell变量，定义time=&rsquo;<code>date +%s</code>&lsquo;来调用了。</p>
      <a href="/2011/03/21/bsd_flow_monitor_by_awk" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/18/gearmand-test-on-single-server" title="gearman单机试验" rel="bookmark">gearman单机试验</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-18 00:00:00 +0800">18 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>想把前端缓存几十台服务器的访问日志数据计入数据库中，以便核算各频道带宽。按照一般流量统计的惯例，在服务器上设定crontab每5分钟rotate一次access.log。但是想到一个问题——当A服务器select了数据库里的数据但还没来得及update时，B服务器也开始执行任务select数据来了，最后的结果就不准确了——我相信这个问题对coder来说很低级，不过我是op，搞不来……</p>
<p>不过op有op的思路——咱把所有的数据汇总由一台服务器来写数据库。考虑scp或者rsync可能会出现的各种未知失败（这个失败太普遍了，相信所有的op都有体会），打算试试gearman。</p>
<p>gearman出现的本意，是由jobserver来派发client的jobs到workers完成，比如张宴提到金山用它来分发上传图片的缩略裁剪（这也正是LiveJourna发明gearman的初始用途）；比如TimYang提到用它来分发监控任务；OSCON2009的文档上，还提到了搜索引擎、分布式文件系统、map/reduce、日志分析、mysql集群处理等多种应用。</p>
<p>其中关于日志分析的结构图如下：</p>
<p><img src="/images/uploads/gearman4log.jpg" alt="gearman" /></p>
<p>好了。上面都是虚的。现在开始做实验。</p>
<p>下载gearman的c语言版，毕竟单纯就为了记录下带宽值的话，没必要下perl版的来折腾——注意，和memcached一样，gearman也采用了libevent，所以必须先安好libevent：</p>
<div class="highlight"><pre><code class="bash">wget http://launchpad.net/gearmand/trunk/0.14/+download/gearmand-0.14.tar.gz
tar zxvf gearmand-0.14
<span class="nb">cd</span> !<span class="err">$</span>
./configure <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make install
</code></pre></div>
<p>默认会采用sqlite存储持久化队列。如果觉得memcached什么的更有爱，也可以&ndash;with。</p>
<p>安装完成后，会在/usr/local/bin下生成gearman和gearmand两个文件，前一个是worker和client共用的；后一个是jobserver。</p>
<p>首先要启动jobserver：</p>
<pre><code>gearmand -d -p 7003
</code></pre>
<p>然后开启一个client：</p>
<pre><code>echo 'test' | gearman -h 127.0.0.1 -p 7003 -f testwork
</code></pre>
<p>资料都说7003是gearman的默认端口，但C版的必须明确定义才行。</p>
<p>这个时候，可以telnet 127.0.0.1 7003上去，输入status看看了，上面显示“1 0 0”，表示有一个请求在队列中等待执行了。</p>
<p>然后注册一个worker：</p>
<pre><code>gearman -n -w -f testwork -- ls -lh
</code></pre>
<p>资料也都没有要使用-n参数。但如果不用这个，worker会在接收执行完队列中的第一个任务后就主动退出了！</p>
<p>ok，现在执行结果出来了。在client端（因为单机执行，其实就是运行client命令的ssh窗口），显示出来了一串文件信息，就是worker端的ls -lh结果。</p>
<p>然后重新注册worker，以测试client传递的内容能被worker正确处理：</p>
<pre><code>gearman -n -w -f testwork | awk '{print $0}'
</code></pre>
<p>嗯？worker端还是没有反应啊？切到client来，发现client这边显示了test！难道是标准输出就是用来返回给client的？那试试别的命令试试吧。</p>
<p>重新注册worker：</p>
<pre><code>gearman -n -w -f testwork | awk '{system("touch /tmp/"$0}'
</code></pre>
<p>这时候也可以telnet上去看看status，会显示“0 0 1”，表示有一个注册在jobserver上的worker；</p>
<p>然后重新发起client：</p>
<pre><code>echo 'test' | gearman -h 127.0.0.1 -p 7003 -f testwork
</code></pre>
<p>在到/tmp下一看，确实出现了/tmp/test文件了~~</p>
<p>不过，如何确定这个/tmp/test是worker生成的，而不是client呢（单机测试就是郁闷啊……）</p>
<p>修改一下worker：</p>
<pre><code>gearman -n -w -f testwork | awk '{system("sleep 100;touch /tmp/"$0}'
</code></pre>
<p>重新发起client，因为有sleep 100在，这次client没有立刻退出，但为了测试需要，按下Ctrl+C，终止client的运行，以确保命令不会是由client执行的（更确保一点，可以退出ssh会话）。</p>
<p>切换到/tmp/目录下，用stat命令查看/tmp/test文件的CTIME——目前还是上一次试验时的生成时间。</p>
<p>这时候telnet看status，显示是“1 0 1”，表示一个job正在运行。</p>
<p>再过一会儿，stat看，发现/tmp/test的CTIME突然变成一个新的时间了。可见touch命令确实是由worker执行的。</p>
      <a href="/2011/03/18/gearmand-test-on-single-server" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/17/initctl-error" title="linux小报错一例" rel="bookmark">linux小报错一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-17 00:00:00 +0800">17 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>需要给某台服务器加内存，准备关机的时候，却一直报错。考虑直接断电危害比较大，还是找找原因，报错如下：
shutdown: timeout opening/writing control channel /dev/initctl 
init: timeout opening/writing control channel /dev/initctl 
从messages日志里没有发现任何附加信息。只能求助百度。好在解答很多：
是原有的initscripts和SysVinit找不到了导致的。
传上去initscripts-8.45.19.EL-1.x86<em>64.rpm和SysVinit-2.86-14.x86</em>64.rpm两个包，rpm -ivh安装。
重新poweroff还是报错；但强制-f跳过shutdown过程后，成功了。稍后再启动设备，试着再敲一次poweroff，这次就不报错，成功关机了。</p>
      <a href="/2011/03/17/initctl-error" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/15/simple-test-between-squid-varnish-ats" title="squid/varnish/ats简单测试" rel="bookmark">squid/varnish/ats简单测试</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-15 00:00:00 +0800">15 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>简单的试试varnish和apache traffic server。跟squid进行一下对比。
介于varnish和ats都是出现不太久的东西（至少是开源流行不长），选择其最新开发版本测试，正巧都是2.15版。呵呵~
varnish配置文件，只修改了backend到具体某台nginx发布点上。其他都是反向代理缓存的标配。（可参考张宴博客http://blog.s135.com和varnish权威指南http://linuxguest.blog.51cto.com/195664/354889）
ats说明更少，从目前的资料看，修改了records.config中的监听，cache.config遵循源站未改，remap.config添加了map一条，绑定域名到同一台nginx上。
注：varnish和ats都没有修改缓存路径，即分别为var/varnish/varnish.cache和var/trafficserver，都是磁盘。</p>
<p>然后从线上某台squid2.7上收集www.domain.com下的html页面url一共164条，存成urllist。
使用http_load进行测试。第一遍，先用http_load -r 100 -s 10完成cache的加载；第二遍改用-r 1000 -s 60进行测试。
1、先是varnish
开另一个窗口看netstat，发现在第一次加载的时候，varnish启动了相当多的链接到后端nginx请求数据！第二遍时，-r1000一直在刷wrong，修改成-r900就没有问题。最后的报告显示fetch/sec还略大于指定的900达到990，建连时间平均1.3ms，响应时间1.8ms。
2、然后ats
-r1000也报wrong，于是同样使用-r900，fetch/sec和和建连时间与varnish相近，响应时间2.1ms。
从trafficserver_shell的show:proxy_stats和show:cache_stats命令结果来看，缓存命中率98%，磁盘IO几乎没有。可见其实都在内存中返回了。
3、最后squid2.7.9
-r900时，fetch/sec只有880，响应时间1.9ms；提高到-r1000时，没有wrong报错，fetch/sec下降到850，响应时间2.3ms；另一个窗口的netstat命令直接卡住……
squid按照公司默认做法，缓存目录建在了tmpfs上。从squidclient来看，98%的命中率中只有三分之一是直接通过cache_mem返回的，另三分之二是通过cache_dir的tmpfs返回。</p>
<p>另：最后du -sh查看三者的缓存目录大小，赫然发现squid的是19M，ats是39M，varnish是41M。这个差别也是比较怪异的，值得后续研究……</p>
<p>从这个简单测试结果看，squid的稳定性依然没的说：对于大多数情况来说，是乐于见到这种宁愿响应慢点点也要保证响应正确的情况的；varnish在大批量回源时对后端服务器的冲击，显然比较让人担心；ats和varnish具有同样高效的响应速度（和高压下的错误……），而且其详细到甚至稍显繁琐的那堆config文件的配置格式，相比varnish来说，更加贴近运维人员（也就是说看起来不像编程语言）~~</p>
      <a href="/2011/03/15/simple-test-between-squid-varnish-ats" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/03/zz-a-day-in-the-life-of-facebook-operations" title="Facebook运维工程师的一天" rel="bookmark">Facebook运维工程师的一天</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-03 00:00:00 +0800">03 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>原文地址：http://linuxsysadminblog.com/2010/09/a-day-in-the-life-of-facebook-operations/
顺便说一句，这个linuxsysadminblog.com确实不错。
文章是笔者在现场听Facebook系统工程师汤姆·库克在2010年的surge可扩展和性能大会上的讲演时记录下来的——
这是到目前为止最火爆的讲座了，还没开始就只剩下点站着的空间……
Facebook运维需要支持多大的应用环境：
1、在facebook花上每个月7亿分钟（不太明白这个意思，一个月明明只有43200分钟）
2、60亿次内容更新；
3、30亿张图片；
4、实现100万连接；
5、5亿活跃用户。
基础设施建设的发展：
1、租用IDC达到瓶颈；
2、开始自建；
3、目前已为加利福尼亚和弗吉尼亚两州服务。
发展历程：
从LAMP起步，然后拆分负载均衡，web服务器，app服务器，memcached，数据库。
最早的Facebook是一个单纯的发布在apache上的php站点。但后来php不足以支持Facebook的访问了，现在，Facebook已经开始编译一些php功能成C++程序，这就是业界闻名的HipHop。
Facebook大概拥有世上最大的memcached集群，超过300TB的数据存储在memcached内存中。
使用flashcache来改善mysql性能。
已实现支持的服务：
新闻feed、搜索、缓存。
服务使用中的编程语言：
C++、php（前台）、python、ruby、java、erlang（聊天室）
各种编程语言间如何交互数据？json？soap？都不是。Facebook专用一个为各编程语言开发服务的软件框架。所有的Facebook系统后面，都是统一的一个平台。
Facebook每天都在担心：
开发、监控、数据管理、代码上线。
Facebook使用centos操作系统！
系统管理：
配置管理；
系统管理——用CFengine；
按需管理。
开发：
前台部分——每天都有新代码上线。代码统一协调，所有人都在IRC的频道里交流。每个人都可以知道发生了什么，而不单单是工程师自己。
1、程序推送按需分发；
2、代码分发通过BT的方式；
3、php是经过编译的，数百MB的二进制文件通过极小的BT种子迅速下发；
4、完成全网更新只需要1分钟。
后台部分——只有开发和运维。开发工程师写代码、测试、演示。
1、这样能迅速得到性能数据；
2、揭露各环节的真实交互（这里翻译的应该不对，看不懂……）；
3、没有所谓的“提交、退出”；
4、全面参与应用变成产品的过程；
5、运维被“嵌入”每个开发团队。
代码的每一处修改和推送，都必须详细记录。
Facebook的服务器性能指标在线监控
ganglia监控系统：快速、便捷、超过500万的监控指标、可以通过网格和池的方式进行规划。
自主的监控系统
nagios监控系统：用来给各团队发报警，最开始是用的email。
Scribe高性能日志系统：最开始用的是syslogd，同时在用hadoop和hive。
怎么运行的呢：
1、定义要明确的依赖关系；
2、固定的失败次数；
3、服务器是第一步，系统架构设计。
4、现在重点是搞集群。通过功能不同进行逻辑关系划分（web、db、feed等）
5、下一步是数据中心。尤其是灾备。
6、不断的沟通——信息永远在共享中。
7、IRC。
8、大量的自动化数据获取和设置。
9、内部新闻更新。
10、内部工具的&rsquo;headers&rsquo;；
11、变更日志。
12、团队要短小精悍。
一个有趣的数字：平均每台Facebook的服务器8分钟就升级一次。
一个有趣的事实：Facebook最忙的时候是万圣节后的那天。</p>
      <a href="/2011/03/03/zz-a-day-in-the-life-of-facebook-operations" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/03/01/perl-game-of-chinaunix" title="CU的perl大赛" rel="bookmark">CU的perl大赛</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-03-01 00:00:00 +0800">01 Mar 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>原帖地址：http://bbs.chinaunix.net/thread-1860259-1-1.html
刚看到帖子，试着自己做做，首先必须承认做的过程是重新去翻过资料了……</p>
<ol>
  <li>
    <div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl  myfunc {</span>
<span class="c1"># $x = ...</span>
<span class="k">return</span> <span class="nv">$x</span><span class="p">?</span><span class="mi">1</span><span class="p">:</span><span class="nb">undef</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
  </li>
  <li>
    <p>$x=()就是给$x赋了个undef；列表在标量上下文中取列表的最后一个元素；()是创建一个空列表；至于为啥取最后一个的原因，我猜测是采用的pop操作，所以从列表最后取值吧。</p>
  </li>
  <li>
    <div class="highlight"><pre><code class="perl"><span class="nv">@x</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
<span class="nv">@y</span><span class="o">=</span><span class="nv">@z</span><span class="o">=</span><span class="p">();</span>
<span class="k">for</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="nv">$#x</span><span class="p">)</span> <span class="p">{</span>
<span class="nb">push</span> <span class="nv">@y</span><span class="p">,</span> <span class="nv">$x</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="k">if</span> <span class="nv">$x</span><span class="p">[</span><span class="nv">$_</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="nv">$x</span><span class="p">[</span><span class="nv">$_</span><span class="p">];</span>
<span class="nb">push</span> <span class="nv">@z</span><span class="p">,</span> <span class="nv">$x</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="k">if</span> <span class="nv">$x</span><span class="p">[</span><span class="nv">$_</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="o">!=</span> <span class="nv">$x</span><span class="p">[</span><span class="nv">$_</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">for</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="nv">$#z</span><span class="p">)</span> <span class="p">{</span>
<span class="k">print</span> <span class="nv">$z</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span><span class="o">.</span><span class="s">&quot;-&quot;</span><span class="o">.</span><span class="nv">$y</span><span class="p">[</span><span class="nv">$_</span><span class="p">];</span>
<span class="k">print</span> <span class="s">&quot;,&quot;</span> <span class="k">unless</span> <span class="nv">$_</span> <span class="o">==</span> <span class="nv">$#z</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
  </li>
  <li>
    <p>基本没用过@x[1]这个写法啊，猜测与$x[1]的区别会是在上下文上吧？一个标量一个列表。反正就这个题目的例子，print结果都是7</p>
  </li>
  <li>
    <p>汗，不知道print <code>ls -lta</code>;算不算最短perl代码？</p>
  </li>
  <li>
    <div class="highlight"><pre><code class="perl"><span class="nv">@x</span><span class="o">=</span><span class="p">(</span><span class="o">..</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">@x</span><span class="p">)</span> <span class="p">{</span>
<span class="nv">$sum</span> <span class="o">+=</span> <span class="nv">$_</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$avg</span> <span class="o">=</span> <span class="nv">$sum</span> <span class="o">/</span> <span class="nv">@x</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">@x</span><span class="p">)</span> <span class="p">{</span>
<span class="k">print</span> <span class="s">&quot;$_ &quot;</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">&gt;</span> <span class="nv">$avg</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
  </li>
  <li>
    <div class="highlight"><pre><code class="perl"><span class="nv">$x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">rand</span> <span class="mi">100</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="o">&lt;&gt;</span><span class="p">)</span> <span class="p">{</span>
<span class="nb">chomp</span><span class="p">;</span>
<span class="nb">exit</span> <span class="k">unless</span> <span class="sr">/\d+/</span><span class="p">;</span>
<span class="k">print</span> <span class="s">&quot;Too low\n&quot;</span> <span class="ow">and</span> <span class="k">next</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">&lt;</span> <span class="nv">$x</span><span class="p">;</span>
<span class="k">print</span> <span class="s">&quot;Too high\n&quot;</span> <span class="ow">and</span> <span class="k">next</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">&gt;</span> <span class="nv">$x</span><span class="p">;</span>
<span class="k">print</span> <span class="s">&quot;Right&quot;</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">==</span> <span class="nv">$x</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
  </li>
  <li>不知道啥是无阻塞IO……</li>
</ol>
      <a href="/2011/03/01/perl-game-of-chinaunix" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/02/24/delete-rt-attachment-from-mysql" title="RT故障处理操作一例" rel="bookmark">RT故障处理操作一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-02-24 00:00:00 +0800">24 Feb 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#database-ref" title="database" rel="category tag">database</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>公司RT系统某工单页面无法打开。通过httpwatch发现是图片附件比较大，卡住了页面加载最终导致。
询问当事人后，决定把图片删除掉。
右键菜单查看图片url，是http://rt.domain.com/Ticket/Attachment/123456/654321/12.jpg这样的格式~
于是在服务器的DocumentRoot下查找相关路径，发现Ticket/Attachment下只有一个文件dhandler，这是一段perl程序。
相关部分如下：</p>
<div class="highlight"><pre><code class="perl"><span class="k">my</span> <span class="nv">$arg</span> <span class="o">=</span> <span class="nv">$m</span><span class="o">-&gt;</span><span class="n">dhandler_arg</span><span class="p">;</span>                <span class="c1"># get rest of path</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$arg</span> <span class="o">=~</span> <span class="s">&#39;^(\d+)/(\d+)&#39;</span><span class="p">)</span> <span class="p">{</span>
<span class="nv">$trans</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
<span class="nv">$attach</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">my</span> <span class="nv">$AttachmentObj</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">RT::</span><span class="n">Attachment</span><span class="p">(</span><span class="nv">$session</span><span class="p">{</span><span class="s">&#39;CurrentUser&#39;</span><span class="p">});</span>
<span class="nv">$AttachmentObj</span><span class="o">-&gt;</span><span class="n">Load</span><span class="p">(</span><span class="nv">$attach</span><span class="p">)</span> <span class="o">||</span> <span class="n">Abort</span><span class="p">(</span><span class="s">&quot;Attachment &#39;$attach&#39; could not be loaded&quot;</span><span class="p">);</span>
<span class="k">unless</span> <span class="p">(</span><span class="nv">$AttachmentObj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
<span class="n">Abort</span><span class="p">(</span><span class="s">&quot;Bad attachment id. Couldn&#39;t find attachment &#39;$attach&#39;\n&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">unless</span> <span class="p">(</span><span class="nv">$AttachmentObj</span><span class="o">-&gt;</span><span class="n">TransactionId</span><span class="p">()</span> <span class="o">==</span> <span class="nv">$trans</span> <span class="p">)</span> <span class="p">{</span>
<span class="n">Abort</span><span class="p">(</span><span class="s">&quot;Bad transaction number for attachment. $trans should be&quot;</span><span class="o">.</span><span class="nv">$AttachmentObj</span><span class="o">-&gt;</span><span class="n">TransactionId</span><span class="p">()</span> <span class="o">.</span><span class="s">&quot;\n&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>显然，该图片url对应的就是$trans=123456;$attach=654321。</p>
<p>再看RT/Attachment.pm，里面记录的是Attachments表的情况；再看其中的Create{}中相关部分如下：</p>
<div class="highlight"><pre><code class="perl">        <span class="k">my</span> <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="nn">SUPER::</span><span class="n">Create</span><span class="p">(</span>
            <span class="n">TransactionId</span>   <span class="o">=&gt;</span> <span class="nv">$args</span><span class="p">{</span><span class="s">&#39;TransactionId&#39;</span><span class="p">},</span>
            <span class="n">ContentType</span>     <span class="o">=&gt;</span> <span class="nv">$Attachment</span><span class="o">-&gt;</span><span class="n">mime_type</span><span class="p">,</span>
            <span class="n">ContentEncoding</span> <span class="o">=&gt;</span> <span class="nv">$ContentEncoding</span><span class="p">,</span>
            <span class="n">Parent</span>          <span class="o">=&gt;</span> <span class="nv">$args</span><span class="p">{</span><span class="s">&#39;Parent&#39;</span><span class="p">},</span>
            <span class="n">Headers</span>         <span class="o">=&gt;</span> <span class="nv">$Attachment</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">as_string</span><span class="p">,</span>
            <span class="n">Subject</span>         <span class="o">=&gt;</span> <span class="nv">$Subject</span><span class="p">,</span>
            <span class="n">Content</span>         <span class="o">=&gt;</span> <span class="nv">$Body</span><span class="p">,</span>
            <span class="n">Filename</span>        <span class="o">=&gt;</span> <span class="nv">$Filename</span><span class="p">,</span>
            <span class="n">MessageId</span>       <span class="o">=&gt;</span> <span class="nv">$MessageId</span><span class="p">,</span>
        <span class="p">);</span>
</code></pre></div>
<p>基本可以通过工单的id、url里的transactionid和Filename来唯一确定这个特大的图片了。</p>
<p>（实际这个Filename已经在transactionid生成的时候可以无视掉了，参见RT/Transaction_Overlay.pm里的Create{}。所以url里不管最后一段写什么*.jpg，结果都一样）</p>
<div class="highlight"><pre><code class="mysql"><span class="c1"># mysql -uroot -p</span>
<span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">rt3</span><span class="p">.</span><span class="n">Attachments</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="s1">&#39;1234&#39;</span> <span class="k">and</span> <span class="n">TransactionId</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span> <span class="k">and</span> <span class="n">Filename</span><span class="o">=</span><span class="s1">&#39;12.jpg&#39;</span><span class="p">;</span>
</code></pre></div>
<p>然后屏幕开始哗哗的刷，全是&mdash;&mdash;-</p>
<p>因为把图片内容存在Content字段里，显示就全是-了。</p>
<p>不过还是担心，万一这个-不是想象中的呢？</p>
<table>
  <tbody>
    <tr>
      <td>于是去找binlog。通过strings binlog.*</td>
      <td>awk &lsquo;/12.jpg/ &amp;&amp; /&rsquo;$Date&rsquo;/{print NR}&rsquo;找到当初create的记录（好在不是啥繁忙的系统，不然这种方法能被DBA鄙视死……），然后通过awk &lsquo;NR&gt;a &amp;&amp; NR&lt;b&rsquo;的方式查看create记录附件的其他内容。果然在Content字段，有几百行乱码，最开头就是JFIF，也就是jpg的图片格式。</td>
    </tr>
  </tbody>
</table>
<p>最后update rt3.Attachments set Content=&rsquo;&rsquo; where id=&rsquo;1234&rsquo; and TransactionId=&rsquo;123456&rsquo; and Filename=&rsquo;12.jpg&rsquo;;删除这个超大图片，浏览页面就变快多啦~~</p>
      <a href="/2011/02/24/delete-rt-attachment-from-mysql" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/02/24/a-awk-example-about-gsub-function" title="awk一例" rel="bookmark">awk一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-02-24 00:00:00 +0800">24 Feb 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一个小需求，某目录下有五万多个模板文件，其中大概两万个是链接文件。当碰到如下情况：
lrwxrwxrwx  1 nobody nobody       59 Dec 27 15:06 10000053.mod -&gt; /var/www/html/category/model/10000050.mod
就需要创建同名的另一个模板文件10000053.wap文件，指向10000050.wap。
怎么做？
我用了如下命令：</p>
<div class="highlight"><pre><code class="bash">ls -l /var/www/html/category/model | awk <span class="s1">&#39;$1~/^l/ &amp;&amp; $9~ /mod$/ {gsub(/mod$/,&quot;wap&quot;,$9);gsub(/mod$/,&quot;wap&quot;,$NF);system(&quot;rm -f &quot;$9&quot; &amp;&amp; ln -s &quot;$NF&quot; &quot;$9)}&#39;</span>
</code></pre></div>
<p>不过从效果来看，使用gsub函数后速度慢了不少，这5万个文件花了几分钟。</p>
<hr />
<p>另，在CU上看到另一个文件操作的shell考题，据说是腾讯的题。修改某目录下（含子目录）所有.shell文件为.sh。我的思路和上头的类似。不过在微博上看到一个超级不错的写法，记录一下：</p>
<div class="highlight"><pre><code class="bash">rename .shell .sh <span class="sb">`</span>find ./ -name *.shell<span class="sb">`</span>
</code></pre></div>
      <a href="/2011/02/24/a-awk-example-about-gsub-function" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/02/22/redhat-tech-questions" title="没事试试RH的技能测试" rel="bookmark">没事试试RH的技能测试</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-02-22 00:00:00 +0800">22 Feb 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上redhat官网看资料的时候想起来上面有RHCE报名前的技能水平测试（用来预估水平，省掉一些基础课程的）。然后做了一下试试。地址如右：<a href="http://www.redhat.com/explore/pre-assessment">http://www.redhat.com/explore/pre-assessment</a>
结果如下：</p>
<table border="0" cellspacing="0">
<thead>
<tr>
<th>Topic</th>
<th>Evaluation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Essential Command-Line Operations</td>
<td>Deep Understanding</td>
</tr>
<tr>
<td>Managing Simple Partitions and Filesystems</td>
<td>Some Understanding</td>
</tr>
<tr>
<td>Managing User Accounts</td>
<td>Substantial Knowledge</td>
</tr>
<tr>
<td>Tuning and Maintaining the Kernel</td>
<td>Some Understanding</td>
</tr>
<tr>
<td>Enhance User Security</td>
<td>Familiarity</td>
</tr>
<tr>
<td>BASH Scripting and Tools</td>
<td>Familiarity</td>
</tr>
</tbody>
</table>
<p><em>* The results represent a subset of the knowledge in the curriculum.</em></p>
<p><em> Recommendation
RHCSA Rapid Track Course with Exam (RH200)
Red Hat System Administration III with RHCSA and RHCE Exams (RH255)</em>
发现用win做个人桌面使用，对考rhc*还是有影响的——不少题是窗口应用的~</p>
      <a href="/2011/02/22/redhat-tech-questions" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/02/19/conns-diff-between-browsers" title="浏览器连接数的小区别" rel="bookmark">浏览器连接数的小区别</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-02-19 00:00:00 +0800">19 Feb 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>读百度UEO博客的文章《<a href="http://www.baiduux.com/blog/2011/02/15/browser-loading/" target="_blank">浏览器的加载与页面性能优化</a>》，其中关于浏览器对单个域名连接数有一段描述，与一般的概述稍有差别。由此可见像百度这种级别的公司，对性能细节抓到什么程度——让我想起之前在腾讯大讲堂里看到的&rdquo;页面代码大小要求是MTU倍数&rdquo;。</p>
<p>这段文字如下：
在HTTP/1.1协议下，单个域名的最大连接数在IE6中是2个，而在其它浏览器中一般4-8个，而整体最大链接数在30左右</p>
<p>而在HTTP/1.0协议下，IE6、7单个域名的最大链接数可以达到4个，在Even Faster Web Sites一书中的11章还推荐了对静态文件服务使用HTTP/1.0协议来提高IE6、7浏览器的速度</p>
      <a href="/2011/02/19/conns-diff-between-browsers" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/02/16/pseudo-static-problem-of-js-rewrite" title="apache的rewrite伪静态化问题一例" rel="bookmark">apache的rewrite伪静态化问题一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-02-16 00:00:00 +0800">16 Feb 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#apache-ref" title="apache" rel="category tag">apache</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>某应用系统有一个产品翻页浏览，为了利于搜索引擎，准备把/search.html?param=1-2-3-4-5做伪静态化，变成/search/1-2-3-4-5.html的url显示。</p>
<p>想来很简单，确认apache有mod_rewrite后，加入如下配置，重启即可：</p>
<div class="highlight"><pre><code class="apache"><span class="nt">&lt;IfModule</span> <span class="s">mod_rewrite.c</span><span class="nt">&gt;</span>
<span class="nb">RewriteEngine</span> <span class="k">on</span>
<span class="nb">RewriteCond</span> %{HTTP_HOST} ^example\.domain\.com [NC]
<span class="nb">RewriteCond</span> %{REQUEST_URI} ^/search/.*\.html
<span class="nb">RewriteRule</span> ^/search/(.*)\.html <span class="sx">/search.html</span>?param=$1 [P,L]
<span class="nt">&lt;/IfModule&gt;</span>
</code></pre></div>
<p>不过很不幸的事情出现了：不管点击页面搜索结果的哪个页码，看到的永远都是第一页的内容！！</p>
<p>是搜索程序有问题么？试着直接访问/search.html?param=1-2-3-4-6，能看到之后某页的新内容。</p>
<p>于是打开apache的rewritelog看看究竟：</p>
<div class="highlight"><pre><code class="apache"><span class="nb">RewriteLog</span> <span class="sx">/www/admin.game.china.com/logs/rewrite.log</span>
<span class="nb">RewriteLogLevel</span> <span class="m">9</span>
</code></pre></div>
<p>在rewrite.log中看到如下记录：</p>
<div class="highlight"><pre><code class="apache"><span class="err">[rid</span><span class="c">#13c4e40/initial] (2) init rewrite engine with requested uri /search/0-0-0-0-0-0-0-0-0-2.html</span>
<span class="err">[rid</span><span class="c">#13c4e40/initial] (3) applying pattern &#39;^/search/(.*)\.html&#39; to uri &#39;/search/0-0-0-0-0-0-0-0-0-2.html&#39;</span>
<span class="err">[rid</span><span class="c">#13c4e40/initial] (4) RewriteCond: input=&#39;example.domain.com&#39; pattern=&#39;^example\.domain\.com&#39; =&gt; matched</span>
<span class="err">[rid</span><span class="c">#13c4e40/initial] (4) RewriteCond: input=&#39;/search/0-0-0-0-0-0-0-0-0-2.html&#39; pattern=&#39;^/search/.*\.html&#39; =&gt; matched</span>
<span class="err">[rid</span><span class="c">#13c4e40/initial] (2) rewrite /search/0-0-0-0-0-0-0-0-0-2.html -&gt; /search.html?param|0-0-0-0-0-0-0-0-0-2</span>
<span class="err">[rid</span><span class="c">#13c4e40/initial] (3) split uri=/search.html?param|0-0-0-0-0-0-0-0-0-2 -&gt; uri=/search.html, args=param|0-0-0-0-0-0-0-0-0-2</span>
<span class="err">[rid</span><span class="c">#13c4e40/initial] (2) local path result: /search.html</span>
<span class="err">[rid</span><span class="c">#13c4e40/initial] (2) prefixed with document_root to /www/example.domain.com/search.html</span>
<span class="err">[rid</span><span class="c">#13c4e40/initial] (1) go-ahead with /www/example.domain.com/search.html [OK]</span>
</code></pre></div>
<p>看起来似乎没有问题……</p>
<p>为了更细致一点，在测试环境中用单进程方式启动apache，通过strace来跟踪httpd。更明确看到了rewrite之后的内部请求&rdquo;GET /search.html?param=0-0-0&hellip;&ldquo;完全没有问题。</p>
<p>于是找开发同事商量，询问这个.html?param=是如何完成翻页功能的。结果得知是html中有javascript，翻页就是通过js来完成的。</p>
<p>恍然大悟！js是在浏览器端完成解析工作的，那么在apache里rewrite的时候传输过去的args没有起到作用，服务器返回的永远是默认的html内容，即第一页内容。同事修改程序，将翻页方式改成另外的jsp来完成，我再修改rewrite规则到jsp上。一切OK了！</p>
      <a href="/2011/02/16/pseudo-static-problem-of-js-rewrite" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/02/14/compile-and-upgrading-of-the-linux-kernel" title="linux内核编译升级" rel="bookmark">linux内核编译升级</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-02-14 00:00:00 +0800">14 Feb 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>N年没更新的ipvsadm终于在今年春节前更新了，正好手头有lvs的任务，赶紧试试。lvs上说的很清楚，ipvsadm的1.2.26版仅工作于linux kernel2.6.28以上版本。所以首先要把现有的2.6.18的linux kernel升级。</p>
<ol>
  <li>
    <p>从kernel.org上获取高版本的kernel原文件：
wget http://www.kernel.org/pub/linux/kernel/v2.6/linux-2.6.37.tar.bz2
tar jxvf linux-2.6.37.tar.bz2 -C /usr/src</p>
  </li>
  <li>
    <p>做好源代码连接
ln -s /usr/src/linux-2.6.37 /usr/src/linux</p>
  </li>
  <li>
    <p>开始选择编译参数
cd /usr/src/linux
make mrproper #这一步是清除可能存在的其他内核编译结果
make menuconfig #采用字符界面选择，初次操作的就别改什么了。
make bzImage #生成vmlinuz
make modules
make modules_install #生成模块
make install  #把生成的System.map/initrd/vmlinuz等都mv到/boot下，并修改grub配置</p>
  </li>
  <li>
    <p>重启
sed -i &lsquo;s/default=1/default=0/&rsquo; /boot/grub/menu.lst
reboot</p>
  </li>
</ol>
<p>嗯，很好，然后等待，十分钟过去，依然ping不通(这么简单就搞定，我也懒得写这篇博文啦)……赶紧接显示器看看进展。启动界面停留在如下画面：
Unable to access resume device (LABEL=SWAP-sda9)
mount : could not find filesystem &lsquo;/dev/root&rsquo;
setup other filesystem
setting up now root fs
set up root :moving /dev faild:No such file or directory
no fstab.sys,mounting inernal defaults
setuproot:error mounting /proc :No such file or directory
setuproot:error mounting /sys:No such file or directory
switching to new root and running init
umounting old /dev
umounting old /proc
umounting old /sys
switchroot : mount faild : No such file or directory
kernel panic:not syncing :attempted to kill init
call trace
sysfs系统无法挂载……原来linux kernel2.6.3*中，在menuconfig中有个很重要的选项：
enable deprecated sysfs features which may confuse old userspace tools
help文档对这个选项的解释是：“<strong>Do not say Y, if the original kernel, that came with your distribution, has this option set to N.</strong>”</p>
<p><span style="color: #ff0000;">很不幸，RHEL5的/usr/src/kernels/2.6.18-92.el5-x86_64/.config中压根就没有CONFIG_SYSFS_DEPRECATED这行……所以必须选上这个选项。</span></p>
<p>选择老内核进入系统，重新来过一次编译，除了这个选项以外一切相同。重启就成功进入了！</p>
      <a href="/2011/02/14/compile-and-upgrading-of-the-linux-kernel" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/26/direct-operate-xen-vm-image" title="直接操作xen虚拟机镜像的办法" rel="bookmark">直接操作xen虚拟机镜像的办法</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-26 00:00:00 +0800">26 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cloud-ref" title="cloud" rel="category tag">cloud</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一台xen虚拟机，root密码忘记了，必须进入single模式修改root密码。步骤很熟练，xm shutdown domain &amp;&amp; xm create -c domain——但是出问题了——没出现grub的启动界面，直接进入系统启动过程了！</p>
<p>无法从正常操作流程上搞定，那么换一个思路，直接操作镜像文件（谢天谢地，还好是虚拟机），采用loop方式挂载镜像，然后上去改文件好了~</p>
<p>方法如下：</p>
<p>mount -o loop,offset=32256 /xen/disk.img /mnt
然后看/mnt/下的grub.conf，timeout=0，修改成timeout=5，保存退出。umount /mnt后重新使用xm cre -c就可以看到grub界面了~~</p>
<p>现在解释一下这个offset=32256是怎么来的。因为如果不加这串会报出“mount: you must specify the filesystem type”错误。</p>
<p>1、先file确定img文件，如下：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@localhost xen<span class="o">]</span><span class="c"># file /xen/cvs_backup</span>
/xen/cvs_backup: x86 boot sector;
partition 1: <span class="nv">ID</span><span class="o">=</span>0x83, active, starthead 1, startsector 63, 208782 sectors;
partition 2: <span class="nv">ID</span><span class="o">=</span>0x8e, starthead 0, startsector 208845, 62701695 sectors, code offset 0x48
</code></pre></div>
<p>可以看到这个镜像文件其实被格式化成了两个分区，其中第一个分区的起始块位置是63；
2、用fdisk确定具体的units，如下：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@localhost xen<span class="o">]</span><span class="c"># fdisk -lu /xen/cvs_backup</span>
last_lba<span class="o">()</span>: I don<span class="err">&#39;</span>t know how to handle files with mode 81ed
You must <span class="nb">set </span>cylinders.
You can <span class="k">do </span>this from the extra functions menu.
Disk /xen/cvs_backup: 0 MB, 0 bytes
255 heads, 63 sectors/track, 0 cylinders, total 0 sectors
<span class="nv">Units</span> <span class="o">=</span> sectors of 1 * <span class="nv">512</span> <span class="o">=</span> 512 bytes
Device Boot      Start         End      Blocks   Id  System
/xen/cvs_backup1   *          63      208844      104391   83  Linux
/xen/cvs_backup2          208845    62910539    31350847+  8e  Linux LVM
Partition 2 has different physical/logical endings:
<span class="nv">phys</span><span class="o">=(</span>1023, 254, 63<span class="o">)</span> <span class="nv">logical</span><span class="o">=(</span>3915, 254, 63<span class="o">)</span>
</code></pre></div>
<p>可见每个块的大小是512字节。那么虚拟机镜像文件对应的真实起始字节位置就是63*512=32256了。</p>
      <a href="/2011/01/26/direct-operate-xen-vm-image" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/20/problem-about-move-crossing-partition" title="图片分离小故障一例" rel="bookmark">图片分离小故障一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-20 00:00:00 +0800">20 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>有需求对某应用的图片和页面内容进行拆分。计划进行的很顺利，存储设备上成功分成了/vol/html和/vol/image，然后分别挂载在应用服务器上发布为html.domain.com和image.domain.com。但在恢复应用运行后出现一个问题：新图片的上传总是提示失败。</p>
<p>查看服务器上的日志，还好jvm-default.log记录的相当详细。上传程序首先在html.domain.com/dynamic/domain<em>/下创建一个tmp/，上传的图片</em>.jpg和缩略图s_<em>.jpg就暂存在该tmp/下。然后再mv到相应的image.domain.com/domain</em>/$date下。图片上传到tmp是成功的，特意选择一个比较偏僻的domain9，由系统来新建这个image.domain.com/domain*/$date，也成功了。</p>
<table>
  <tbody>
    <tr>
      <td>开发同事去检查程序，试图提供更详细的报错信息，然后发现报错的地方写的是if (!TmpPicReNameNewPic</td>
      <td>&nbsp;</td>
      <td>!TmpSmallPicReNameNewSmallPic ) {*};</td>
    </tr>
  </tbody>
</table>
<p>于是想到有一种可能，虽然存储还是同一个存储，但是分成了两次mount，或许linux系统就将该存储当成了两个磁盘，而rename方法在linux的实现是不可以跨磁盘操作的。见man文档：
  oldpath and newpath are not on the same mounted filesystem.
  (Linux permits a filesystem to be mounted at multiple points, but rename(2)
  does not work across different mount points, even if the same filesystem is
  mounted on both.)
解决办法有两种，一种是修改程序，把rename改成真正的mv(即先cp，然后rm) ；另一种是想办法只挂载一次存储。考虑到这个猜测有可能不正确，折腾程序比较麻烦，正好这次图文拆分也不是彻底的分离到不同服务器上，而是存储上的两个路径而已。决定先mount NetAppIp:/vol/ /mnt;ln -s /mnt/html /www/html.domain.com;ln -s /mnt/image /www/image.domain.com；重启服务再测试上传，果然成功了！</p>
      <a href="/2011/01/20/problem-about-move-crossing-partition" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/20/awk-efficiency" title="awk的效率" rel="bookmark">awk的效率</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-20 00:00:00 +0800">20 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>偶然和某人谈到日志处理。最简单常见的需求，日志中访问量最大的前十个IP及其访问次数。</p>
<table>
  <tbody>
    <tr>
      <td>最常见的shell命令：cat access.log</td>
      <td> cut -d &lsquo; &lsquo; -f 4 </td>
      <td>sort</td>
      <td>uniq -c</td>
      <td>sort -nr</td>
      <td>head</td>
    </tr>
  </tbody>
</table>
<table>
  <tbody>
    <tr>
      <td>我最常用的awk命令：awk &lsquo;{a[$4]++}END{for(i in a){print a[i],i}}&rsquo; access.log</td>
      <td>sort -nr</td>
      <td>head</td>
    </tr>
  </tbody>
</table>
<p>对方表示上一种速度最快，而我说是下一种。</p>
<p>最后找到一个13G大小的access.log，用time命令分别检测命令用时。结果处理一个13GB的日志，shell花了13分钟，awk花了1分半钟……</p>
      <a href="/2011/01/20/awk-efficiency" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/13/learning-accel-dynamic-data" title="读《基于动态内容的缓存加速技术》笔记" rel="bookmark">读《基于动态内容的缓存加速技术》笔记</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-13 00:00:00 +0800">13 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>《程序员》2010年11月刊的86-89四页，刊登了F5售前技术顾问，原VIACDN(TOM的CDN部门，后来独立运营)架构师徐超的文章《基于动态内容的缓存加速技术——F5 Web Accelerator产品技术剖析》。</p>
<p>文章的前三分之一内容，主要是讲述RFC2616和一般浏览器、服务器的具体实现。已经比较熟悉了，略过……</p>
<p>然后进入关键内容。</p>
<p>“让浏览器缓存能够为动态页面工作”：
A. 修改Transfer-Encoding: chunked的内容输出Content-Length。
这个squid已经做到了。其实质就是在获取url的body时，累加每个chunk的size，直到碰上MSB为0的last-chunk标记。
B. 添加Last-Modified。
这个squid差一步。squid实质已经获取了文件在本地的mtime，但只在源header不存在last-modified的时候才用于LM-factor算法。
C. 删除Expires。
大概是为了统一成HTTP/1.1的header，所以选择了删除expires？或者就是纯粹了节省代码吧……
D. 修改Cache-Control。有Expires按这个设定max-age，或者按配置设定；有private的修改成public；添加must-revalidated。
这个squid用header_access和header_replace就能完成。</p>
<p>“Web Accelerator如何识别动态页面的更新并保持更新”：
A. 预加载。
这个通过squid的补丁html prefetching可以完成
B. 根据上一章节的修改结果，浏览器对&rdquo;动态html&rdquo;每次都可以发送IMS到F5。F5向源站请求该html，并比对缓存内容。
其他过程和一般的IMS过程一样，关键在比对缓存内容。如果这个&rdquo;动态&rdquo;只是html文字内容的更新，还是正常范围；如果&rdquo;动态交互&rdquo;的结果还包括其他CSS/JS/JPG/GIF的变动，这个功能就比较有用了。
根据预加载的功能，每次确认html时重新预比对。考虑到CSS/JS/JPG/GIF一般来说都是会输出Last-Modified的，这个比对返回结果应该比较快。都没问题的话，跳过这步；
如果有部分文件mtime也变动了，开始预加载，并另存为一个带有版本号的url(比如logo.gif;pv=***)，用&rsquo;,&rsquo;而不能用&rsquo;?&rsquo;，因为?在浏览器上是不缓存的；
同时修改主文件html的内容，替换url链接为新版本号的url。最后发送这个新版本html给浏览器。
这种版本号控制的方法也节省了缓存更新时的删除操作IO，而统一交给LRU之类的完成。
想到LRU，一个疑问：当缓存不足时，假如logo.gif已经被prune出去了，那这个时候的F5怎么办？几个猜测办法：
1、浪费一点带宽和时间，以新版本号url的形式重新进入缓存；
2、用一个版本号/mtime的K-V数据库完成url版本控制；
3、F5作为特定类型给某些网站使用，就不考虑海量文件的问题。
最后，我还是觉得url版本控制这种事情，还是由网站开发人员来做CMS比较靠谱。</p>
<p>“反向动态代理”
上面的方式，确实保证了数据&rdquo;实时&rdquo;性，而且充分利用了浏览器缓存，但一次刷新引发F5和源站之间几十上百次的比对，还是比较郁闷的。所以当网站的&rdquo;动态&rdquo;结构比较清晰时，比如一个论坛，明确知道帖子列表变动就是因为有人发帖了；而且可以从发帖的POST请求url里推导出版面url的，可以采用这种技术。
一旦接收到POST请求，F5自动根据配置purge版面url的缓存。而不用去比对。</p>
<p>“MultiConnect技术”
因为浏览器对同一域名并发连接很少，所以F5可以自动替换html里的url，根据配置把image.x.com换成img1.x.com/img2.x.com/img3.x.com……前提是你的DNS上确实有这些解析。
不过要注意，域名太多也会拖慢浏览器速度的。dns解析需要时间。</p>
<p>总之，个人感觉这些技术还是比较现实的，但都用很强的应用场景针对性。呵呵~</p>
      <a href="/2011/01/13/learning-accel-dynamic-data" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/12/resin-status" title="resin-status" rel="bookmark">resin-status</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-12 00:00:00 +0800">12 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>和apache、nginx一样，resin也自带了一个比较简易的status模块，只需要在resin.conf里配置就行了。在里添加如下一段：</p>
<div class="highlight"><pre><code class="xml">    <span class="nt">&lt;servlet-mapping</span> <span class="na">servlet-class=</span><span class="s">&#39;com.caucho.servlets.ResinStatusServlet&#39;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;url-pattern&gt;</span>/resin-status<span class="nt">&lt;/url-pattern&gt;</span>
      <span class="nt">&lt;init</span> <span class="na">enable=</span><span class="s">&quot;read&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
</code></pre></div>
<p>重启resin即可。</p>
<p>然后curl访问http://127.0.0.1:8080/resin-status就可以看到输出了。</p>
<p>用浏览器的话，大致如下图：
<img src="/images/uploads/resin.jpg" alt="resin" /></p>
<p>可以关注线程数、连接数、内存使用大小和请求处理数。</p>
<p>如果要做监控的话，直接从html里获取相应数值即可。</p>
<p>唯一需要稍微注意的是请求处理数。因为其他的都是AVERAGE，只有这个是COUNTER型的。要是想很方便的看到rps。可以采用如下方法查看：</p>
<div class="highlight"><pre><code class="bash"><span class="c"># a=`curl -s http://127.0.0.1:8081/resin-status|awk -F/ &#39;/Invocation/{print $NF}&#39;`;sleep 1;curl -s http://10.168.168.56:8081/resin-status|awk -F/ &#39;/Invocation/{print($NF-&#39;$a&#39;}&#39;</span>
718
</code></pre></div>
<p>这里比较有趣的是因为这行的数据本身是有个括号的，所以就有了各种各样的写法和报错了。一并贴上来，可以体会一下awk的系统变量/内部函数/字符类型的用法：</p>
<div class="highlight"><pre><code class="bash"><span class="c"># a=`curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF}&#39;`;sleep 10;curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF-&#39;$a&#39;}&#39;</span>
awk: cmd. line:1: /Invocation/<span class="o">{</span>print <span class="nv">$NF</span>-3949612<span class="o">)}</span>
awk: cmd. line:1:                               ^ syntax error
<span class="c"># a=`curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF}&#39;`;sleep 10;curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF-&#39;&quot;$a&quot;&#39;}&#39;</span>
awk: cmd. line:1: /Invocation/<span class="o">{</span>print <span class="nv">$NF</span>-4025373<span class="o">)}</span>
awk: cmd. line:1:                               ^ syntax error
<span class="c"># a=`curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF}&#39;`;sleep 10;curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF-&quot;&#39;$a&#39;&quot;}&#39;</span>
7607
<span class="c"># a=`curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print substr($NF,0,length($NF)-1)}&#39;`;sleep 10;curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF-&#39;$a&#39;}&#39;</span>
7927
<span class="c"># a=`curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print $NF}&#39;`;sleep 10;curl -s http://127.0.0.1:8080/resin-status|awk -F/ &#39;/Invocation/{print($NF-&#39;$a&#39;}&#39;</span>
7212
</code></pre></div>
      <a href="/2011/01/12/resin-status" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/11/construct-http-auth-header" title="HTTP的auth请求模拟" rel="bookmark">HTTP的auth请求模拟</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-11 00:00:00 +0800">11 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>开发同事需要在程序中调用一个“安全级别比较高”的url，起初没觉得有啥问题，我们wget或者curl的时候，按照标准url的格式（即&rsquo;请求方法://用户名:密码@域名/文件路径&rsquo;）写就完全OK了。不过很快同事转来了报错：</p>
<p><span style="color:#000000;font-family:Verdana;font-size:x-small;"><span style="font-family:Verdana;font-size:x-small;"><span style="font-family:Verdana;font-size:x-small;">java.io.IOException: Server returned HTTP response code: 401 for URL: <a href="http://gundong:gdxw6354@editornew.china.com/interface/addcategory.php?parentid=2&amp;id=2&amp;name=gbox_%D0%C7%BC%CA%D5%F9%B0%D4&amp;groupname=game&amp;code=satrcraft&amp;m=09286f9d135d5debe7052bea42a27eef">http://test:test1234@test.domain.com/interface/addcategory.php?parentid=2&amp;id=2&amp;name=gbox_%D0%C7%BC%CA%D5%F9%B0%D4&amp;groupname=game&amp;code=satrcraft&amp;m=09286f9d135d5debe7052bea42a27eef</a></span></span></span>
原来用的是IO的方式，我用telnet模拟一下，结果还真是这样：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@cms ~<span class="o">]</span><span class="c"># telnet test.domain.com 80</span>
Trying 123.124.125.126...
Connected to test.domain.com <span class="o">(</span>123.124.125.126<span class="o">)</span>.
Escape character is <span class="s1">&#39;^]&#39;</span>.
GET http://test:test1234@test.domain.com/interface/addcategory.php?parentid<span class="o">=</span>2&amp;amp;id<span class="o">=</span>2&amp;amp;name<span class="o">=</span>gbox_%D0%C7%BC%CA%D5%F9%B0%D4&amp;amp;groupname<span class="o">=</span>game&amp;amp;code<span class="o">=</span>satrcraft&amp;amp;m<span class="o">=</span>09286f9d135d5debe7052bea42a27eef HTTP/1.0
HTTP/1.1 401 Authorization Required
Date: Tue, 11 Jan 2011 03:39:37 GMT
Server: Apache/1.3.37 <span class="o">(</span>Unix<span class="o">)</span> PHP/4.4.9
WWW-Authenticate: Basic <span class="nv">realm</span><span class="o">=</span><span class="s2">&quot;CMS-Testdotcom&quot;</span>
Connection: close
Content-Type: text/html; <span class="nv">charset</span><span class="o">=</span>iso-8859-1
</code></pre></div>
<p>查了一下HTTP协议，原来auth是走的另外一个header完成Authorization，其格式是Authorization: Basic &lsquo;encoded_base64(user:passwd)&rsquo;。服务器会自动的用decoded_base64()解析字符串得到真正的用户名和密码。原来wget和curl这些工具不单单是发个请求这么简单啊~~</p>
<p>重新试验，先计算test:test1234的base64值：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@cms ~<span class="o">]</span><span class="c"># echo test:test1234|openssl base64</span>
<span class="nv">dGVzdDp0ZXN0MTIzNAo</span><span class="o">=</span>
<span class="o">[</span>root@cms ~<span class="o">]</span><span class="c"># telnet test.domain.com 80</span>
Trying 123.124.125.126...
Connected to test.domain.com <span class="o">(</span>123.124.125.126<span class="o">)</span>.
Escape character is <span class="s1">&#39;^]&#39;</span>.
GET http://test.domain.com/interface/addcategory.php?parentid<span class="o">=</span>2&amp;amp;id<span class="o">=</span>2&amp;amp;name<span class="o">=</span>gbox_%D0%C7%BC%CA%D5%F9%B0%D4&amp;amp;groupname<span class="o">=</span>game&amp;amp;code<span class="o">=</span>satrcraft&amp;amp;m<span class="o">=</span>09286f9d135d5debe7052bea42a27eef HTTP/1.0
Authorization: Basic <span class="nv">dGVzdDp0ZXN0MTIzNAo</span><span class="o">=</span>
HTTP/1.1 200 OK
Date: Tue, 11 Jan 2011 05:21:32 GMT
Server: Apache/1.3.37 <span class="o">(</span>Unix<span class="o">)</span> PHP/4.4.9
X-Powered-By: PHP/4.4.9
Connection: close
Content-Type: text/html
2 <span class="o">||</span> 2|| gbox_星际争霸 <span class="o">||</span> satrcraft <span class="o">||</span> game &lt;br/&gt;09286f9d135d5debe7052bea42a27eef&lt;br/&gt;2Connection closed by foreign host.
</code></pre></div>
<p>果然就可以了~~</p>
      <a href="/2011/01/11/construct-http-auth-header" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/10/mysqlreport-guide" title="mysqlreport指南" rel="bookmark">mysqlreport指南</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-10 00:00:00 +0800">10 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#database-ref" title="database" rel="category tag">database</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>mysqlreport是mysql性能监测时最常用的工具，对了解mysql运行状态和配置调整都有很大的帮助。找了一些mysql的资料，发现大多数是关于php+mysql开发的，服务配置基本就是固定的几条。干脆找上mysqlreport的官网，啃下来这篇指南。翻译都是随着我个人的语言习惯，对直接能用mysql命令上看到结果的英文则保留下来。方便以后查找：</p>
<p>原文地址：<a href="http://hackmysql.com/mysqlreportguide">http://hackmysql.com/mysqlreportguide</a></p>
<h1 id="mysqlreport">《mysqlreport指南》</h1>
<p>本指南的写作目的是解释mysqlreport上出具的各种数据。通过指南，你可以在阅读完mysqlreport的报告后，完整的解释并且理解一个最根本的问题——而这也正是你使用mysqlreport的目的所在——（我的）MySQL服务器到底运行的怎么样？</p>
<p>当前的mysqlreport版本会自动生成一份尽可能完整的数据报表，最多可达14节121行。您不必再像以前那样输入各种各样的参数定义了。不过如果您的mysql服务配置上关闭了某些部分的话，报表的相关部分也会随之关闭。比如，你关闭了<code>query cache</code>，那么mysqlreport的第4节&rsquo;Query Cache&rsquo;也就不存在了。所以报表长度是浮动的。</p>
<p>为了便于理解和观察，本指南采用了对一份完整报表做出逐行解释的方法。下面就是将要被详细解析的那份报表，为了方便，在最前端加上了行号。</p>
<div class="highlight"><pre><code class="mysql"><span class="mi">1</span> <span class="n">MySQL</span> <span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span>              <span class="n">uptime</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">26</span>       <span class="n">Fri</span> <span class="n">Sep</span>  <span class="mi">1</span> <span class="mi">19</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">02</span> <span class="mi">2006</span>
<span class="mi">2</span>
<span class="mi">3</span> <span class="n">__</span> <span class="k">Key</span> <span class="n">_________________________________________________________________</span>
<span class="mi">4</span> <span class="n">Buffer</span> <span class="n">used</span>   <span class="mi">380</span><span class="p">.</span><span class="mi">00</span><span class="n">k</span> <span class="n">of</span> <span class="mi">512</span><span class="p">.</span><span class="mi">00</span><span class="n">M</span>  <span class="o">%</span><span class="n">Used</span><span class="p">:</span>   <span class="mi">0</span><span class="p">.</span><span class="mi">07</span>
<span class="mi">5</span>   <span class="n">Current</span>      <span class="mi">59</span><span class="p">.</span><span class="mi">32</span><span class="n">M</span>            <span class="o">%</span><span class="k">Usage</span><span class="p">:</span>  <span class="mi">11</span><span class="p">.</span><span class="mi">59</span>
<span class="mi">6</span> <span class="k">Write</span> <span class="n">hit</span>      <span class="mi">97</span><span class="p">.</span><span class="mi">04</span><span class="o">%</span>
<span class="mi">7</span> <span class="k">Read</span> <span class="n">hit</span>       <span class="mi">99</span><span class="p">.</span><span class="mi">58</span><span class="o">%</span>
<span class="mi">8</span>
<span class="mi">9</span> <span class="n">__</span> <span class="n">Questions</span> <span class="n">___________________________________________________________</span>
<span class="mi">10</span> <span class="n">Total</span>          <span class="mi">98</span><span class="p">.</span><span class="mi">06</span><span class="n">k</span>   <span class="mi">47</span><span class="p">.</span><span class="mi">46</span><span class="o">/</span><span class="n">s</span>
<span class="mi">11</span>   <span class="n">DMS</span>          <span class="mi">81</span><span class="p">.</span><span class="mi">23</span><span class="n">k</span>   <span class="mi">39</span><span class="p">.</span><span class="mi">32</span><span class="o">/</span><span class="n">s</span>  <span class="o">%</span><span class="n">Total</span><span class="p">:</span>  <span class="mi">82</span><span class="p">.</span><span class="mi">84</span>
<span class="mi">12</span>   <span class="n">QC</span> <span class="n">Hits</span>      <span class="mi">16</span><span class="p">.</span><span class="mi">58</span><span class="n">k</span>    <span class="mi">8</span><span class="p">.</span><span class="mi">02</span><span class="o">/</span><span class="n">s</span>           <span class="mi">16</span><span class="p">.</span><span class="mi">91</span>
<span class="mi">13</span>   <span class="n">COM_QUIT</span>        <span class="mi">200</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">10</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">20</span>
<span class="mi">14</span>   <span class="n">Com_</span>            <span class="mi">131</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">06</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">13</span>
<span class="mi">15</span>   <span class="o">-</span><span class="n">Unknown</span>         <span class="mi">82</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">04</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">08</span>
<span class="mi">16</span> <span class="n">Slow</span> <span class="mi">5</span> <span class="n">s</span>            <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>  <span class="o">%</span><span class="n">DMS</span><span class="p">:</span>   <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>  <span class="n">Log</span><span class="p">:</span>  <span class="k">ON</span>
<span class="mi">17</span> <span class="n">DMS</span>            <span class="mi">81</span><span class="p">.</span><span class="mi">23</span><span class="n">k</span>   <span class="mi">39</span><span class="p">.</span><span class="mi">32</span><span class="o">/</span><span class="n">s</span>           <span class="mi">82</span><span class="p">.</span><span class="mi">84</span>
<span class="mi">18</span>   <span class="k">SELECT</span>       <span class="mi">64</span><span class="p">.</span><span class="mi">44</span><span class="n">k</span>   <span class="mi">31</span><span class="p">.</span><span class="mi">19</span><span class="o">/</span><span class="n">s</span>           <span class="mi">65</span><span class="p">.</span><span class="mi">72</span>         <span class="mi">79</span><span class="p">.</span><span class="mi">33</span>
<span class="mi">19</span>   <span class="k">INSERT</span>       <span class="mi">16</span><span class="p">.</span><span class="mi">75</span><span class="n">k</span>    <span class="mi">8</span><span class="p">.</span><span class="mi">11</span><span class="o">/</span><span class="n">s</span>           <span class="mi">17</span><span class="p">.</span><span class="mi">08</span>         <span class="mi">20</span><span class="p">.</span><span class="mi">61</span>
<span class="mi">20</span>   <span class="k">UPDATE</span>           <span class="mi">41</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">02</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">04</span>          <span class="mi">0</span><span class="p">.</span><span class="mi">05</span>
<span class="mi">21</span>   <span class="k">REPLACE</span>           <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>          <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">22</span>   <span class="k">DELETE</span>            <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>          <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">23</span> <span class="n">Com_</span>              <span class="mi">131</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">06</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">13</span>
<span class="mi">24</span>   <span class="n">change_db</span>       <span class="mi">119</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">06</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">12</span>
<span class="mi">25</span>   <span class="n">show_fields</span>       <span class="mi">9</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">01</span>
<span class="mi">26</span>   <span class="n">show_status</span>       <span class="mi">2</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">27</span>
<span class="mi">28</span> <span class="n">__</span> <span class="k">SELECT</span> <span class="k">and</span> <span class="n">Sort</span> <span class="n">_____________________________________________________</span>
<span class="mi">29</span> <span class="n">Scan</span>               <span class="mi">38</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">02</span><span class="o">/</span><span class="n">s</span> <span class="o">%</span><span class="k">SELECT</span><span class="p">:</span>   <span class="mi">0</span><span class="p">.</span><span class="mi">06</span>
<span class="mi">30</span> <span class="n">Range</span>              <span class="mi">14</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">02</span>
<span class="mi">31</span> <span class="n">Full</span> <span class="k">join</span>           <span class="mi">3</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">32</span> <span class="n">Range</span> <span class="k">check</span>         <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">33</span> <span class="n">Full</span> <span class="n">rng</span> <span class="k">join</span>       <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">34</span> <span class="n">Sort</span> <span class="n">scan</span>          <span class="mi">14</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="o">/</span><span class="n">s</span>
<span class="mi">35</span> <span class="n">Sort</span> <span class="n">range</span>         <span class="mi">26</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="o">/</span><span class="n">s</span>
<span class="mi">36</span> <span class="n">Sort</span> <span class="n">mrg</span> <span class="n">pass</span>       <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>
<span class="mi">37</span>
<span class="mi">38</span> <span class="n">__</span> <span class="n">Query</span> <span class="n">Cache</span> <span class="n">_________________________________________________________</span>
<span class="mi">39</span> <span class="n">Memory</span> <span class="k">usage</span>   <span class="mi">17</span><span class="p">.</span><span class="mi">81</span><span class="n">M</span> <span class="n">of</span>  <span class="mi">32</span><span class="p">.</span><span class="mi">00</span><span class="n">M</span>  <span class="o">%</span><span class="n">Used</span><span class="p">:</span>  <span class="mi">55</span><span class="p">.</span><span class="mi">66</span>
<span class="mi">40</span> <span class="n">Block</span> <span class="n">Fragmnt</span>  <span class="mi">13</span><span class="p">.</span><span class="mi">05</span><span class="o">%</span>
<span class="mi">41</span> <span class="n">Hits</span>           <span class="mi">16</span><span class="p">.</span><span class="mi">58</span><span class="n">k</span>    <span class="mi">8</span><span class="p">.</span><span class="mi">02</span><span class="o">/</span><span class="n">s</span>
<span class="mi">42</span> <span class="n">Inserts</span>        <span class="mi">48</span><span class="p">.</span><span class="mi">50</span><span class="n">k</span>   <span class="mi">23</span><span class="p">.</span><span class="mi">48</span><span class="o">/</span><span class="n">s</span>
<span class="mi">43</span> <span class="n">Prunes</span>         <span class="mi">33</span><span class="p">.</span><span class="mi">46</span><span class="n">k</span>   <span class="mi">16</span><span class="p">.</span><span class="mi">20</span><span class="o">/</span><span class="n">s</span>
<span class="mi">44</span> <span class="n">Insrt</span><span class="p">:</span><span class="n">Prune</span>    <span class="mi">1</span><span class="p">.</span><span class="mi">45</span><span class="p">:</span><span class="mi">1</span>    <span class="mi">7</span><span class="p">.</span><span class="mi">28</span><span class="o">/</span><span class="n">s</span>
<span class="mi">45</span> <span class="n">Hit</span><span class="p">:</span><span class="k">Insert</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">34</span><span class="p">:</span><span class="mi">1</span>
<span class="mi">46</span>
<span class="mi">47</span> <span class="n">__</span> <span class="k">Table</span> <span class="n">Locks</span> <span class="n">_________________________________________________________</span>
<span class="mi">48</span> <span class="n">Waited</span>          <span class="mi">1</span><span class="p">.</span><span class="mi">01</span><span class="n">k</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">49</span><span class="o">/</span><span class="n">s</span>  <span class="o">%</span><span class="n">Total</span><span class="p">:</span>   <span class="mi">1</span><span class="p">.</span><span class="mi">24</span>
<span class="mi">49</span> <span class="n">Immediate</span>      <span class="mi">80</span><span class="p">.</span><span class="mi">04</span><span class="n">k</span>   <span class="mi">38</span><span class="p">.</span><span class="mi">74</span><span class="o">/</span><span class="n">s</span>
<span class="mi">50</span>
<span class="mi">51</span> <span class="n">__</span> <span class="kp">Tables</span> <span class="n">______________________________________________________________</span>
<span class="mi">52</span> <span class="n">Open</span>              <span class="mi">107</span> <span class="n">of</span> <span class="mi">1024</span>    <span class="o">%</span><span class="n">Cache</span><span class="p">:</span>  <span class="mi">10</span><span class="p">.</span><span class="mi">45</span>
<span class="mi">53</span> <span class="n">Opened</span>            <span class="mi">118</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">06</span><span class="o">/</span><span class="n">s</span>
<span class="mi">54</span>
<span class="mi">55</span> <span class="n">__</span> <span class="n">Connections</span> <span class="n">_________________________________________________________</span>
<span class="mi">56</span> <span class="n">Max</span> <span class="n">used</span>           <span class="mi">77</span> <span class="n">of</span>  <span class="mi">600</span>      <span class="o">%</span><span class="n">Max</span><span class="p">:</span>  <span class="mi">12</span><span class="p">.</span><span class="mi">83</span>
<span class="mi">57</span> <span class="n">Total</span>             <span class="mi">202</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">10</span><span class="o">/</span><span class="n">s</span>
<span class="mi">58</span>
<span class="mi">59</span> <span class="n">__</span> <span class="n">Created</span> <span class="n">Temp</span> <span class="n">________________________________________________________</span>
<span class="mi">60</span> <span class="n">Disk</span> <span class="k">table</span>         <span class="mi">10</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>
<span class="mi">61</span> <span class="k">Table</span>              <span class="mi">26</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="o">/</span><span class="n">s</span>    <span class="n">Size</span><span class="p">:</span>  <span class="mi">4</span><span class="p">.</span><span class="mi">00</span><span class="n">M</span>
<span class="mi">62</span> <span class="n">File</span>                <span class="mi">3</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>
<span class="mi">63</span>
<span class="mi">64</span> <span class="n">__</span> <span class="n">Threads</span> <span class="n">_____________________________________________________________</span>
<span class="mi">65</span> <span class="n">Running</span>            <span class="mi">55</span> <span class="n">of</span>   <span class="mi">77</span>
<span class="mi">66</span> <span class="n">Cache</span>               <span class="mi">0</span>              <span class="o">%</span><span class="n">Hit</span><span class="p">:</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">5</span>
<span class="mi">67</span> <span class="n">Created</span>           <span class="mi">201</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">10</span><span class="o">/</span><span class="n">s</span>
<span class="mi">68</span> <span class="n">Slow</span>                <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>
<span class="mi">69</span>
<span class="mi">70</span> <span class="n">__</span> <span class="n">Aborted</span> <span class="n">_____________________________________________________________</span>
<span class="mi">71</span> <span class="n">Clients</span>             <span class="mi">0</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>
<span class="mi">72</span> <span class="n">Connects</span>            <span class="mi">8</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="o">/</span><span class="n">s</span>
<span class="mi">73</span>
<span class="mi">74</span> <span class="n">__</span> <span class="n">Bytes</span> <span class="n">_______________________________________________________________</span>
<span class="mi">75</span> <span class="n">Sent</span>           <span class="mi">38</span><span class="p">.</span><span class="mi">46</span><span class="n">M</span>  <span class="mi">18</span><span class="p">.</span><span class="mi">62</span><span class="n">k</span><span class="o">/</span><span class="n">s</span>
<span class="mi">76</span> <span class="n">Received</span>        <span class="mi">7</span><span class="p">.</span><span class="mi">98</span><span class="n">M</span>   <span class="mi">3</span><span class="p">.</span><span class="mi">86</span><span class="n">k</span><span class="o">/</span><span class="n">s</span>
<span class="mi">77</span>
<span class="mi">78</span> <span class="n">__</span> <span class="n">InnoDB</span> <span class="n">Buffer</span> <span class="n">Pool</span> <span class="n">__________________________________________________</span>
<span class="mi">79</span> <span class="k">Usage</span>           <span class="mi">3</span><span class="p">.</span><span class="mi">95</span><span class="n">M</span> <span class="n">of</span>   <span class="mi">7</span><span class="p">.</span><span class="mi">00</span><span class="n">M</span>  <span class="o">%</span><span class="n">Used</span><span class="p">:</span>  <span class="mi">56</span><span class="p">.</span><span class="mi">47</span>
<span class="mi">80</span> <span class="k">Read</span> <span class="n">hit</span>       <span class="mi">99</span><span class="p">.</span><span class="mi">99</span><span class="o">%</span>
<span class="mi">81</span> <span class="n">Pages</span>
<span class="mi">82</span>   <span class="n">Free</span>            <span class="mi">195</span>            <span class="o">%</span><span class="n">Total</span><span class="p">:</span>  <span class="mi">43</span><span class="p">.</span><span class="mi">53</span>
<span class="mi">83</span>   <span class="n">Data</span>            <span class="mi">249</span>                     <span class="mi">55</span><span class="p">.</span><span class="mi">58</span> <span class="o">%</span><span class="n">Drty</span><span class="p">:</span>   <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">84</span>   <span class="n">Misc</span>              <span class="mi">4</span>                      <span class="mi">0</span><span class="p">.</span><span class="mi">89</span>
<span class="mi">85</span>   <span class="n">Latched</span>           <span class="mi">0</span>                      <span class="mi">0</span><span class="p">.</span><span class="mi">00</span>
<span class="mi">86</span> <span class="k">Reads</span>         <span class="mi">574</span><span class="p">.</span><span class="mi">56</span><span class="n">k</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="o">/</span><span class="n">s</span>
<span class="mi">87</span>   <span class="k">From</span> <span class="n">file</span>       <span class="mi">176</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">03</span>
<span class="mi">88</span>   <span class="n">Ahead</span> <span class="n">Rnd</span>         <span class="mi">4</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">89</span>   <span class="n">Ahead</span> <span class="k">Sql</span>         <span class="mi">2</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">90</span> <span class="n">Writes</span>        <span class="mi">160</span><span class="p">.</span><span class="mi">82</span><span class="n">k</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="o">/</span><span class="n">s</span>
<span class="mi">91</span> <span class="n">Flushes</span>         <span class="mi">1</span><span class="p">.</span><span class="mi">04</span><span class="n">k</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">92</span> <span class="n">Wait</span> <span class="n">Free</span>           <span class="mi">0</span>       <span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">93</span>
<span class="mi">94</span> <span class="n">__</span> <span class="n">InnoDB</span> <span class="k">Lock</span> <span class="n">_________________________________________________________</span>
<span class="mi">95</span> <span class="n">Waits</span>               <span class="mi">0</span>       <span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">96</span> <span class="n">Current</span>             <span class="mi">0</span>
<span class="mi">97</span> <span class="kt">Time</span> <span class="n">acquiring</span>
<span class="mi">98</span>   <span class="n">Total</span>             <span class="mi">0</span> <span class="n">ms</span>
<span class="mi">99</span>   <span class="n">Average</span>           <span class="mi">0</span> <span class="n">ms</span>
<span class="mi">100</span>  <span class="n">Max</span>               <span class="mi">0</span> <span class="n">ms</span>
<span class="mi">101</span>
<span class="mi">102</span> <span class="n">__</span> <span class="n">InnoDB</span> <span class="n">Data</span><span class="p">,</span> <span class="n">Pages</span><span class="p">,</span> <span class="n">Rows</span> <span class="n">____________________________________________</span>
<span class="mi">103</span> <span class="n">Data</span>
<span class="mi">104</span>   <span class="k">Reads</span>           <span class="mi">225</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">105</span>   <span class="n">Writes</span>          <span class="mi">799</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">106</span>   <span class="n">fsync</span>           <span class="mi">541</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">107</span>   <span class="n">Pending</span>
<span class="mi">108</span>     <span class="k">Reads</span>           <span class="mi">0</span>
<span class="mi">109</span>     <span class="n">Writes</span>          <span class="mi">0</span>
<span class="mi">110</span>     <span class="n">fsync</span>           <span class="mi">0</span>
<span class="mi">111</span>
<span class="mi">112</span> <span class="n">Pages</span>
<span class="mi">113</span>   <span class="n">Created</span>          <span class="mi">23</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">114</span>   <span class="k">Read</span>            <span class="mi">226</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">115</span>   <span class="n">Written</span>       <span class="mi">1</span><span class="p">.</span><span class="mi">04</span><span class="n">k</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">116</span>
<span class="mi">117</span> <span class="n">Rows</span>
<span class="mi">118</span>   <span class="n">Deleted</span>      <span class="mi">25</span><span class="p">.</span><span class="mi">04</span><span class="n">k</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">119</span>   <span class="n">Inserted</span>     <span class="mi">25</span><span class="p">.</span><span class="mi">04</span><span class="n">k</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">s</span>
<span class="mi">120</span>   <span class="k">Read</span>         <span class="mi">81</span><span class="p">.</span><span class="mi">91</span><span class="n">k</span>     <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="n">s</span>
<span class="mi">121</span>   <span class="n">Updated</span>           <span class="mi">0</span>       <span class="mi">0</span><span class="o">/</span><span class="n">s</span>
</code></pre></div>
<h1 id="section">报表抬头：第1行</h1>
<p>本行包括三部分信息：MySQL版本，MySQL运行时间，服务器当前时间。显示版本是为了提醒有些功能可能这台mysql没有；显示运行时间是为了评估报表数据的精准度。事实上，如果一台mysql运行时间连几个小时都没有的，生成的很可能是一份扭曲并且充满误导意见的报表。甚至几个小时都不够，因为它可能是在半夜没啥访问量的时候运行的几个小时。所以建议最少要运行过一个24小时，时间越长越能反应真实情况。
在本例中，运行时间只有34分钟，所以报表也不具有真实的代表意义。</p>
<h1 id="section-1">索引报表：3-7行</h1>
<p>索引报表是第一个主要章节，因为索引(key或者说index)对于mysql数据库，是最最最重要的。虽然报表不可能直接告诉你这个库的索引好还是不好，但它能告诉你这个索引缓冲区(key buffer)被利用的怎么样了。
注意：本报表仅汇总默认的MyISAM表的共享key buffer信息，而不会管管理员自建的其他空间。</p>
<h1 id="section-2">缓冲区使用情况：第4行</h1>
<p>对于mysql，我们的第一个问题就是：到底用了多少key buffer？如果不太多，没问题~因为mysql只会在有需求的时候才分配系统内存给key buffer。也就是说，my.cnf中定义了<code>key_buffer_size=512M</code>，不代表mysql启动时就创建一个512M大小的key buffer。</p>
<p>本行显示的，是mysql曾经使用过的key buffer峰值大小。而事实上，mysql应该用的更少，或者诡异的更多。这个更多的情况，mysql的术语叫“高水位”这个情况和my.cnf里的<code>key_buffer_size</code>是否足够大密切相关。当“水位”已经达到80-90%的时候，赶紧加大你的<code>key_buffer_size</code>吧。</p>
<p>注意：永远不用“担心”这个值超过95%，mysql文档指出，key buffer中的一部分会被mysql主程序用于内部数据结构，这些是mysqlreport无法统计的内容。所以，所谓的95%，其实已经是100%了……</p>
<h1 id="section-3">当前情况：第5行</h1>
<p>这行只有在mysql版本高于4.1.2时出现，因为之前mysql的<code>show status</code>中没有<code>key_blocks_unused</code>。这行数据显示的是mysql当前使用的key buffer大小。如果上行的used%太大的话，那么这行必然不会超过used，除非碰上那个传说中的bug了。综合这两行，相信对<code>key_buffer_size</code>的设置是否合理就有谱了~</p>
<p>本例中，mysql使用了60M的key buffer(12%)，这就很不错，离满负荷运行还早着呢。</p>
<h1 id="section-4">写命中：第6行</h1>
<p>从本质上说，索引是基于内存的。因为访问内存的速度比硬盘快太多了。不过，mysql从磁盘里进行一点点读写操作总是不可避免的。</p>
<p>这行数据显示了写索引的效率(具体意思是：写入磁盘的key与写入内存的key的比值)。这个值没有什么参考答案，而是取决于业务类型。如果mysql主要执行的是update/insert之类的操作，那么正常比值接近0%；如果执行的select居多，那比值超过90%也是正常的。不过如果你看到的是一个负数，那说明mysql总是在往那个慢的要死的磁盘里写索引，这就很不妙了。</p>
<p>要想知道到底比值正常与否，请参考之后的DMS报表内容。</p>
<h1 id="section-5">读命中：第7行</h1>
<p>比写命中重要多了的就是读命中。同样，这个值就是读自磁盘的key与读自内存的比值。这个比值最好别低于99%！！再低就有问题了——很可能就是key buffer太小。mysql没法从内存里读到，只好找硬盘了……
当然，如果你刚重启过一次mysql，那在一两个小时内，命中率低一点也是正常的。</p>
<h1 id="section-6">请求报表：9-26行</h1>
<p>第二个主要章节。它展示了很多关于mysql在做什么以及做的怎么样的内容。请求(question)包括SQL查询(query)，也包括mysql协议通讯。大家经常关注的一个性能是mysql的qps(每秒执行查询数)。不过从一个更广泛的眼光看来，这个衡量标准其实是很随意的……mysql需要处理很多其他的请求。本报表试图展现的，就是这么一个更完整的内容。</p>
<h1 id="section-7">总值：第10行</h1>
<p>本行第一列，回答自运行起mysql一共处理多少请求，第二列，得出自运行起平均每秒钟处理多少请求。大家可能以为第二列这个值就是我们想要的qps了。但mysql真的做了这么多事情么？继续往下看。
（再次提醒大家注意questions和queries的区别）</p>
<h1 id="dtq11-15">查询的总体分布报表(DTQ)：第11-15行</h1>
<p>所有的请求都可以被粗略的分入五类：数据操作语句(DMS)，查询缓存命中(QC Hits)，COM_QUIT，其他的COM_命令以及其他未知的东东。接下来的五行分别显示这些，从大到小排列。这样你可以一眼看出mysql最重要的任务是什么了。一般的说，DMS和QCHits是主角，COM_是必须的，额，路人甲……</p>
<p>再详细解释每行之前，提示一下，第三列的比值分母是上面那行的总值。比如本例中DMS占到了82.84%就挺不错的。</p>
<p>DMS包括：select/insert/replace/update/delete(其他的比较偏门，mysqlreport干脆就排除他们了)。正常的说，mysql最应该做的事情，就是这些DMS了。详细内容见17-22行。</p>
<p><code>QC Hits</code>是mysql从查询缓存里直接获取结果的数量。我们梦寐以求的就是让这个命中率变高，因为这意味着mysql响应变的相当快。但这也意味着你必须接受一定的数据差异性。详细理由见QC报表中的insert/prune和hit/insert比值部分。</p>
<p>在本例中QC Hits达到了16.91%，看来很不错的样子。可别被这么一条数据迷惑了，38-45行的QC报表会给你一个完全不一样的结论。</p>
<p>COM_QUIT，嗯，凑数的。</p>
<p>COM_，如果这个值比较高的话，或许会有些问题，详见23-26行。</p>
<p>Unknown，理想情况下，有上面四个类别就够了。因为有时候，mysql处理了几个请求，却没有记录相应的操作数。所以Unknown有+-两种。+说明mysqlreport统计的多了，-就是少了。这个类别浮动性很大，某些特定情况下，可能会排名很靠前，不过最好还是在最底下吧。</p>
<h1 id="section-8">慢查询：第16行</h1>
<p>第16行非常重要，展示的是mysql执行的慢查询数。默认情况下，配置的<code>long_query_time</code>是10秒钟。事实上，大家都觉得这太长了，一般都改成1秒，甚至更短，mysql在版本5以后，支持到微妙us级别的。</p>
<p>配置的<code>long_query_time</code>会在&rsquo;Slow&rsquo;后面显示，默认8个字符，所以如果配置的是&rsquo;9.999999 ms&rsquo;，只会显示成&rsquo;999.999 &lsquo;，不过应该不会这么无聊吧~</p>
<p>理想情况下最好这里永远都是0，不过不太可能，多少还是有点。只要第三列的比例低于0.05%就行。</p>
<p>第四列，DMS中的slow比值；第五列，慢查询日志是否记录。强烈建议选择ON。</p>
<h1 id="dms17-22">DMS：17-22行</h1>
<p>和DTQ一样，第一行也是总值，其余内容也是动态排名。这部分内容可以解释mysql服务器偏重于什么类型：select还是insert，或者其他。一般来说会是select吧。明确这个问题，对我们理解其他数值有很大的帮助。比如说：一个insert型的mysql，他的写比率接近1.0，同时带来比较高的表锁。然后很可能用innodb表；一个select型的mysql则相反，读比率高，表锁少，而且很可能用的是MyISAM表。</p>
<p>本例就是一个select型的。65.72%的总请求是select(在DMS的比例提高到79.33%)，显然我们可以朝着select的方向进行优化了。</p>
<h1 id="com23-26">COM_：23-26行</h1>
<p>这部分内容都很直观，在mysql协议里都有，像 <code>com_change_db</code> ，一眼就知道是干嘛的。</p>
<p>如果在DTQ排名里COM_比较高，那说明mysql忙着干自己的事情而不是响应SQL查询。比如说，如果一台mysql的 <code>com_rollback</code> 高，可能糟糕了，你的事物回滚失败了。结合之前的DTQ报表分析这个东西吧~
一般这些东西不能出什么问题，不过时不时看一眼还是有必要的。</p>
<h1 id="selectsort28-36">select/sort报表：28-36行</h1>
<p>select和sort都是select_的内容。其中最主要的是29和31行：scan和full join。scan展示的是对全表进行扫描的select语句个数。full join和scan很像，除了它还出现于多表查询。程序联合多表进行全表扫描，听起来就慢的可怕……总之，对于这两个数值，只有更低，没有最低！</p>
<h1 id="qc38-45">QC报表：38-45行</h1>
<p>只有mysql版本支持QC并且my.cnf开启了QC的时候该报表才会出现。</p>
<h1 id="section-9">内存使用：39行</h1>
<p>如果内存使用的接近最大设置值，在更下面的Prune数据上也会有反应，因为QC里的查询会被踢出来。</p>
<h1 id="section-10">内存碎片：40行</h1>
<p>内存块碎片(block fragmnt)的详细解释参见《MYSQL手册》的5.14.3章节所述：</p>
<pre><code>`query_cache_min_res_unit` 的默认值是4KB，大多数情况下足够用了。如果你有一个返回超小结果的海量查询，默认的块大小(即4KB)可能会导致大量的内存碎片，同样也浪费了很多空闲内存块。因为内存不足，碎片会强制删除(prune，我也不知道为啥不叫delete或者purge)QC里的部分内容。这时候你就得降低这个 `query_cache_min_res_unit` 设置。至于空闲块和QC的删除阀值，分别由 `Qcache_free_blocks` 和 `Qcache_lowmem_prunes` 定义。
</code></pre>
<p>内存碎片的计算方法是空闲内存块除以总内存块数。比值越大，碎片越多，10-20%就已经超出平均水平了。</p>
<p>本例的13.05%还是可以接受的，不过最好还是检查一下 <code>query_cache_min_res_unit</code> 是不是能调调~</p>
<h1 id="hitsinsertsprunes41-43">Hits/Inserts/Prunes：41-43行</h1>
<p>Hits是最重要的，它反映了select有多少是从QC里获得的应答，当然越多越好。至于insert和prune，或许从44行的比值中更好理解一下。之前有提到prune多说明qc太小，当然这只是一种可能而已。</p>
<p>本例中，只有55%的QC被利用，而碎片又不是太高。prune达到每秒16次，比QCHits高了一倍！打个不太恰当的（这话我加的，感觉比直接理解技术更难懂的比喻）比方：这台mysql的QC就像苹果树一样，苹果还没摘呢，树枝已经被砍掉了……</p>
<h1 id="insertprunehitinsert44-45">insert/prune和hit/insert比：44-45行</h1>
<p>insert/prune是一个波动性的QC指标。一个稳定运行中的QC，insert进QC的查询数量应该大于prune掉的查询数量。而一个不稳定的QC，比值或许是1:1，甚至偏向prune。这说明两个问题：1、QC大小不够；2、mysql试图缓存一切，结果帮了倒忙~</p>
<p>如果是第一种情况，简单的加大QC大小就够了。然后再观察碎片和内存使用率的情况。</p>
<p>但更多的时候是第二种情况。因为QC设置里开启的默认type1就是要求mysql尽可能的缓存一切东西。</p>
<p>mysql官方说明里这么解释这个<code>type 1</code>的：</p>
<pre><code>“缓存一切查询结果，除非查询时使用'select sql_no_cache'方式”。
</code></pre>
<p>可惜这个 <code>sql_no_cache</code> 基本没人用。另一个稍微好一些的方式是 <code>type 2 demand</code> ，解释如下：</p>
<pre><code>“只有在查询使用 `select sql_cache` 时才缓存查询结果”。
</code></pre>
<p>这个type对开发人员要求比较多，因为他们得明确指出哪些要缓存，哪些不要。不过也没人比他们更清楚到底哪些是该缓存的啦~</p>
<p>hit/insert用来反映QC的有效性。理想情况是：mysql插入一批稳定的查询到QC里，然后源源不断的命中这批结果……所以，如果QC的有效性足够，这个比值应该是偏向hit的。如果不幸的偏向了insert，那说明QC其实没起到太大的作用。比如说1:1，一次insert用了一次hit，然后就被替换了，这完全违背了使用QC的初衷。不过还有更糟的，比如0.34:1,一次都没用上，就被prune掉了……</p>
<p>本例的QCHits不低，hit/insert却不高。再考虑到内存使用和碎片情况也还可以。或许真的有必要换成type2的DEMAND了~~</p>
<h1 id="section-11">表锁报表：47-49行</h1>
<p>表锁报表包括两行，一行是总数，一行是当前数。锁等待对于数据库来说永远是糟糕的事情。第三列的总比值反应了一个综述的情况，无论如何不能高过10%，否则肯定就带来一大堆的索引和慢查询问题！</p>
<h1 id="section-12">表报表：51-53行</h1>
<p>也是两行，一行是当前mysql打开表的个数、表缓存的使用率，一行是mysql运行以来的平均值。</p>
<p>这里有两个值比较重要。一个是表缓存使用率，哪怕高到100%都行。不过要是真高到100%了，可能你的&rsquo;table_cache&rsquo;设置已经不够了，赶紧加大吧。第二个是当前打开表的比率，这个也能协助判断&rsquo;table_cache&rsquo;设置是否合理。一般这个值应该小于每秒1次。不过一个负载比较高而又运行的还不错的mysql，可能能达到每秒打开7次表，依然保持100%的表缓存~</p>
<h1 id="section-13">连接数报表：55-57行</h1>
<p>如果最大连接数曾经接近过100%，请加大&rsquo;max_connection&rsquo;设置。不过事实上，默认的100已经足够绝大多数哪怕相当繁忙的mysql使用了，盲目加大这个设置其实不对。一个mysql链接持续1秒钟，100个就是足足100秒。所以如果连接数太高，或者说一直在慢慢涨，问题很可能在别的地方，比如慢查询、糟糕的索引、甚至DNS解析太慢。在修改这个数的事情，还是先去研究一下为什么100个还不够呢？</p>
<p>至于每秒连接数，只要mysql运行正常，高低无所谓。不过大多数mysql这个值在每秒5次以下~~</p>
<h1 id="section-14">临时表报表：59-62行</h1>
<p>mysql可以在内存、磁盘甚至临时文件上创建临时表。这三种情况分别对应下面的三条报告。这些数据没有标准值，不过必须要知道的是磁盘上的临时表示最慢的。mysql一般也避免在磁盘上创建临时表，除非达到了&rsquo;tmp_table_size&rsquo;的阀值。这个阀值会显示在内存(Table)那行的Size列后面。至于内存和临时文件的数值到底该多少，取决于mysql数据库的硬件配置。</p>
<h1 id="section-15">线程、中断、流量报表：64-76行</h1>
<p>这三个报表是最重要的，系统级别的问题不用多说了都……</p>
<p>这里面有一个需要注意的地方：66行的线程命中率。每个mysql的连接都是一个单独的线程。mysql启动时，只创建不多的几个线程和一个线程缓存，以节省不断创建和销毁线程的开销，哪怕这个开销不怎么明显。当mysql的连接数超过了线程缓存数(由 <code>thread_cache_size</code> 定义)时，MySQL开始出现线程抖动(&lsquo;thread thrash&rsquo;)。为了接纳新的连接，mysql疯狂的创建新线程，结果自然是线程命中率大幅下滑。</p>
<p>线程抖动是问题么？Yahoo的Jeremy Zawondy在博客中写了如下一段话：</p>
<pre><code>所以上面这个故事的教训就是：如果你的服务器老是接受一些快速连接，想办法加大你的线程缓存吧，直到你的`show status`命令里`threads_created`不再飙升为止！你的CPU绝对会感谢你的。线程缓存不是啥大问题。可是你解决完真的大问题后，它就是最大的问题了……(汗)
</code></pre>
<p>所以，如果真出现线程抖动的话，加大&rsquo;thread_cache_size&rsquo;吧。</p>
<p>比如本例，线程缓存命中率只有可怜的0.05%！基本意味着每个连接都是新创建了线程。不过看看报表其他的内容，这也是必然的：缓存里一个线程都没有(66行)，201个线程被创建(67行),202个连接(57行)……</p>
<h1 id="innodb78-92">innodb缓冲池报表：78-92行</h1>
<p>mysql版本5.0.2之后才在<code>show status</code>里加入了innodb_内容。所以这部分报表只在该版本之后有效。</p>
<p>innodb存储引擎的重要特性就是它把表数据和索引都缓存在缓冲池里。缓冲池内的页大小是16KB，可以包含各种不同的数据类型。本报表就展示了这些页的数值。</p>
<p>注：因为mysqlreport比较老，对innodb的采集分析不如myisam多。</p>
<h1 id="section-16">使用率：79行</h1>
<p>这个可以类比第4行的 <code>key buffer used</code>。不过myisam引擎只缓存索引，而innodb也存数据。所以要想知道这个使用率的详细情况，还得看81-85行的内容。</p>
<p>显然，必须避免mysql运行到缓冲池溢出的地步。myisam溢出，只会导致性能下降(索引读写变慢)，而innodb的溢出问题就多了，因为几乎所有东西都依赖缓冲池。所以最好还是配置好自增长缓冲池(&lsquo;auto-extending buffer pool&rsquo;)吧。</p>
<h1 id="section-17">读命中：80行</h1>
<p>同样跟地7行的<code>key read hit</code>类似。不过对innodb来说这个数值更重要。缓冲池显示的是从内存读取的比例，所以一般都接近100%，绝大多数情况至少大于99.98%。</p>
<h1 id="section-18">页：81-85行</h1>
<p>各种各样的关于缓冲池中页的指标。比如82行的空闲页、83行的数据页、84行的杂页、85行的锁定页。</p>
<p>空闲页就是79行使用率的对立方。</p>
<p>数据页和空闲页一样是自描述的。我们没法知道这些页里有哪些数据类型。本行还有一列%Dirty，展示已经被修改过，但还没有被刷新到磁盘存储的数据页的比率。</p>
<p>另两样就更没什么可说的了。mysql手册上只是简单的这么描述这两样页：“用于管理分配行锁和自适应哈希索引导致的开销使用的页”和“目前正在读写、或者因为其他原因无法被刷新的页”。</p>
<h1 id="section-19">读：86-89行</h1>
<p>接下来的四行是关于innodb缓冲池的读情况的。86行是从内存读取的数量。在一个比较繁忙的innoDB引擎mysql服务器上，这个值应该非常大，因为innodb总是试图从内存里的缓冲池读取页。这个数值可以用来衡量innodb缓冲池的吞吐量。因为几乎所有inondb需要的东西都是在缓冲池里，所以缓冲池的读性能是越快越好。哪怕超过每秒200000次也不是不可能的。</p>
<p>87行的数值就小的多了。官方解释叫做“innodb无法从缓冲池获得而只能进行单页读取的逻辑读操作数”，其实就是从磁盘读的数量。</p>
<p>88行，随机读。官方解释“innodb启动的随机读取数。只有对表的大部分内容进行随机扫描的时候才会出现”。</p>
<p>89行，顺序读。官方解释“innodb启动的顺序读取数。只有进行全表扫描的时候才会出现”。全表扫描可不是什么好事，这个数值还是小点好。</p>
<h1 id="section-20">写：90行</h1>
<p>和86行类似，也可以用来衡量innodb的吞吐量。本行显示写的数量以及读写的比率。如果服务器主要操作是update和insert的话，这个值也会比较高。</p>
<h1 id="section-21">刷新：91行</h1>
<p>缓冲池的页刷新请求数。</p>
<h1 id="section-22">空闲等待：92行</h1>
<p>mysql手册上这么描述这个变量：
    一般情况下，innodb缓冲池的写操作是后台运行的。不过，如果出现必须要读写一个页可偏偏没有可用的新页时，（innodb）就只能先等待页的刷新了。这个变量就是这些等待的总数。只要缓冲池的大小设置得当，等待数应该会很小。</p>
<h1 id="innodb94-100">innodb锁报表：94-100行</h1>
<p>innodb的行锁变量是mysql5.0.3之后加入的。MyISAM引擎是表锁，而innoDB是行锁。所以当你使用innodb时这几个变量的值非常重要。</p>
<h1 id="section-23">等待：95行</h1>
<p>“等待某行解锁的累积次数”，最好是0次。</p>
<h1 id="section-24">当前：96行</h1>
<p>“当前正在等待解锁的行个数”，最好是0次。</p>
<h1 id="section-25">时间分析：97-100行</h1>
<p>98-100行显示了毫秒(ms)级行锁等待数据。分别是总值、平均值和最大值。同样最好是0次。</p>
<h1 id="innodb102-121">innoDB数据、页、行报表：102-121行</h1>
<p>这部分报告，一般广泛的用于衡量innodb引擎的吞吐量指标。</p>
<h1 id="section-26">数据：103-110行</h1>
<p>第一部分，数据，列出了四种类型的操作：读、写、刷新(fsync)和等待(pending)。</p>
<ol>
  <li>第一个类型：读，指的是整个innodb引擎完成所有的数据读取次数——注意：不是整个数据读取字节数或者类型，而是innodb完成的数据读取次数。</li>
  <li>第二个类型：写，和读一样也是次数的统计。</li>
  <li>第三个类型：刷新，同样的，innodb从内存写入磁盘的次数。这个值应该会比前两个小。</li>
  <li>第四个类型：等待，又被分成了三行(108-110)，分别是读、写、刷新的等待次数。</li>
</ol>
<h1 id="section-27">页：112-115行</h1>
<p>这部分包括三种自描述类型：创建、读取、写入，分别用来表示缓冲池中页的创建、读取和写入的数量和速率(即每秒操作数)。由于没有指出具体是哪种页，这几个数值也就是用来概述一下innodb引擎的吞吐量罢了。</p>
<h1 id="section-28">行：117-121行</h1>
<p>最后一部分，行，只是一些比较泛泛的数值。包括对行的delete/insert/read/update操作。这些数值会比较大，而速率部分同样也是些概述参考……</p>
<h1 id="section-29">结论</h1>
<p>现在我们已经阅读甚至分析完了整个报表，可以对本例mysql做出一个总体的评价了。</p>
<p>总的来说，这个服务器运行情况还是不错的，几个关键指标都很好：key buffer只用了12%，DMS和QCHits占了请求的99%，也没有什么Com_问题，表锁也不错，表缓存只用了10%，连接数很低。</p>
<p>至于innodb引擎，服务器也在使用，但比重不大。目前这些innodb的状态变量反映出的情况看，一些正常。</p>
<p>不过还是有些优化的余地。首先一点，也是最重要的一点，就是查询缓存QC不太稳定；然后是线程缓存，建议调高 <code>thread_cache_size</code>，知道线程缓存命中率回升到满意值~~</p>
      <a href="/2011/01/10/mysqlreport-guide" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/01/07/compute-flow-from-access_log-by-awk-2" title="日志计算(awk进阶)" rel="bookmark">日志计算(awk进阶)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-01-07 00:00:00 +0800">07 Jan 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <table>
  <tbody>
    <tr>
      <td>曾经用awk写过一个日志流量计算的单行命令。因为awk中没有sort函数，所以在中途采用了</td>
      <td>sort</td>
      <td>的方式，导致效率很低。在计算50GB+的日志时，运算时间慢的不可忍受。</td>
    </tr>
  </tbody>
</table>
<p>设想了很多方法来加快运算，比如舍弃awk改用perl来完成，如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$access_log</span> <span class="o">=</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="k">my</span> <span class="nv">$log_pattern</span> <span class="o">=</span> <span class="sx">qr&#39;^.*?:(\d\d:\d\d):(\S+\s){5}\d+\s(\d+).+&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%flow</span><span class="p">;</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$traffic</span><span class="p">,</span> <span class="nv">$result</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nb">open</span> <span class="n">FH</span><span class="p">,</span><span class="s">&quot;&lt; $access_log&quot;</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Cannot open access_log&quot;</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="k">my</span> <span class="nv">$log</span> <span class="o">=</span> <span class="sr">&lt;FH&gt;</span><span class="p">))</span> <span class="p">{</span>
<span class="err">  </span> <span class="err"> </span><span class="nv">$flow</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$3</span> <span class="k">if</span> <span class="nv">$log</span> <span class="o">=~</span><span class="sr"> /$log_pattern/</span><span class="p">;</span>
 <span class="err"> </span> <span class="err"> </span><span class="c1">#print $1.&quot; &quot;.$3.&quot; &quot;.$flow{$1} * 8 / 300 / 1024 / 1024,&quot;\n&quot;;</span>
<span class="p">}</span>
<span class="nb">close</span> <span class="n">FH</span><span class="p">;</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$key</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%flow</span> <span class="p">)</span> <span class="p">{</span>
<span class="err">  </span> <span class="err"> </span><span class="k">my</span> <span class="nv">$minute</span> <span class="o">=</span> <span class="nv">$1</span> <span class="k">if</span> <span class="nv">$key</span> <span class="o">=~</span><span class="sr"> /\d\d:\d(\d)/</span><span class="p">;</span>
<span class="err">  </span> <span class="err"> </span><span class="nv">$traffic</span> <span class="o">+=</span> <span class="nv">$flow</span><span class="p">{</span><span class="nv">$key</span><span class="p">};</span>
<span class="err">  </span> <span class="err"> </span><span class="k">if</span> <span class="p">(</span> <span class="nv">$minute</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span> <span class="ow">or</span> <span class="nv">$minute</span> <span class="o">==</span> <span class="s">&#39;5&#39;</span> <span class="p">)</span> <span class="p">{</span>
<span class="err">  </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="nv">$result</span> <span class="o">=</span> <span class="nv">$traffic</span> <span class="k">if</span> <span class="nv">$traffic</span> <span class="o">&gt;</span> <span class="nv">$result</span><span class="p">;</span>
<span class="err">  </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="nv">$traffic</span> <span class="o">=</span> <span class="s">&#39;0&#39;</span><span class="p">;</span>
<span class="err">  </span> <span class="err"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="k">print</span> <span class="nv">$result</span> <span class="o">*</span> <span class="mi">8</span> <span class="sr">/ 300 /</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
</code></pre></div>
<p>好吧，这个正则太过垃圾，请无视，但至少在管道和系统sort上浪费的时间还是大大的节省了的。</p>
<p>然后在CU上翻到一个老帖子，提供一个比较不错的awk思路，命令如下：</p>
<div class="highlight"><pre><code class="bash">awk <span class="s1">&#39;!b[substr($4,14,5)]++{print v,a[v]}{v=substr($4,14,5);a[v]+=$10}END{print v,a[v]}&#39;</span>
</code></pre></div>
<p>这里用substr()跟指定FS相比那个效率高未知，不过采用!b++的方式来判断某时间刻度结束，输出该时刻总和，在顺序输入日志的前提下，运算速度极快（就剩下一个加法和赋值了）。</p>
<p>注意：此处b[]内不能偷懒写v，!b[v]++永远只会输出时刻的第一行数值。</p>
<p>不过真实使用时不尽如人意。逻辑上推导了很久没发现问题，结果在重新运行前面的perl时看了看while中的print，发现这个日志因为是从各节点合并出来的日志，其时间并不是顺序排列的！！</p>
<p>另，刚知道gawk3.1以上提供了asort()和asorti()函数，可以研究一下~</p>
<p>采用time命令测试一下</p>
<div class="highlight"><pre><code class="bash">gawk <span class="s1">&#39;{a[substr($4,14,5)]+=$10}END{n=asorti(a,b);for(i=1;i&lt;=n;i++){print b[i],a[b[i]]*8/60/1024/1024}}&#39;</span> example.com_log | awk <span class="s1">&#39;{if($2&gt;a){a=$2;b=$1}}END{print b,a}&#39;</span>
</code></pre></div>
<p>一个35G的日志文件只用了6分钟。</p>
<p>然后更简单的</p>
<div class="highlight"><pre><code class="bash">gawk <span class="s1">&#39;{a[substr($4,14,5)]+=$10}END{n=asort(a);print a[n]*8/60/1024/1024}&#39;</span> example.com_log
</code></pre></div>
<p>不过简单的运行发现只比前一种快不到10秒钟。而前一种还能输出峰值的时间，可读性更好一些~</p>
      <a href="/2011/01/07/compute-flow-from-access_log-by-awk-2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page7">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page active">
      <a href="#">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li>
      <a href="/page9">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
              <li><a href="http://showmetheco.de/" title="Viacheslav Tykhanovskyi(PocketIO/Text::Haml)">No time to wait</a></li>
              <li><a href="http://blog.dataloop.io/" title="A new SaaS monitoring tool for DevOps & Operations">Dataloop.IO</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://junqili.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.sectop.org/" title="">kindle</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
          </ul>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
