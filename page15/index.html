<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/12/13/show-some-common-apps-compiler-options" title="查看一些常见应用的编译选项" rel="bookmark">查看一些常见应用的编译选项</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-13 00:00:00 +0800">13 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <ul>
  <li>nginx：</li>
</ul>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>rao@localhost ~<span class="o">]</span><span class="nv">$ </span>/home/nginx/sbin/nginx -V|grep conf
nginx version: 0.7.54
built by gcc 4.1.2 20080704 <span class="o">(</span>Red Hat 4.1.2-44<span class="o">)</span>
configure arguments: --prefix<span class="o">=</span>/home/nginx --with-pcre
--with-http_stub_status_module --without-http_memcached_module
--without-http_fastcgi_module
apache:
<span class="o">[</span>rao@localhost ~<span class="o">]</span><span class="nv">$ </span>cat /home/apache2/build/config.nice
<span class="c">#! /bin/sh</span>
<span class="c">#</span>
<span class="c"># Created by configure</span>
<span class="nv">CFLAGS</span><span class="o">=</span><span class="s2">&quot;-D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64&quot;</span>; <span class="nb">export</span>
CFLAGS
<span class="s2">&quot;./configure&quot;</span>
<span class="s2">&quot;--prefix=/home/apache2&quot;</span>
<span class="s2">&quot;--enable-static-support&quot;</span>
<span class="s2">&quot;--enable-rewrite&quot;</span>
<span class="s2">&quot;--with-mpm=worker&quot;</span>
<span class="s2">&quot;--enable-logio&quot;</span>
<span class="s2">&quot;--enable-so&quot;</span>
<span class="s2">&quot;--enable-mime-magic&quot;</span>
<span class="s2">&quot;--disable-cgid&quot;</span>
<span class="s2">&quot;--disable-cgi&quot;</span>
<span class="s2">&quot;--disable-userdir&quot;</span>
<span class="s2">&quot;--disable-dir&quot;</span>
<span class="s2">&quot;--disable-include&quot;</span>
<span class="s2">&quot;--disable-filter&quot;</span>
<span class="s2">&quot;--disable-env&quot;</span>
<span class="s2">&quot;--disable-setenvif&quot;</span>
<span class="s2">&quot;--disable-status&quot;</span>
<span class="s2">&quot;--disable-autoindex&quot;</span>
<span class="s2">&quot;--disable-asis&quot;</span>
<span class="s2">&quot;--disable-alias&quot;</span>
<span class="s2">&quot;--disable-actions&quot;</span>
<span class="s2">&quot;--disable-authn-file&quot;</span>
<span class="s2">&quot;--disable-authn-default&quot;</span>
<span class="s2">&quot;--disable-authz-default&quot;</span>
<span class="s2">&quot;--disable-authz-groupfile&quot;</span>
<span class="s2">&quot;--disable-authz-user&quot;</span>
<span class="s2">&quot;--disable-auth-basic&quot;</span>
<span class="s2">&quot;CFLAGS=-D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64&quot;</span>
<span class="s2">&quot;$@&quot;</span>
</code></pre></div>
<ul>
  <li>php:</li>
</ul>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>rao@localhost ~<span class="o">]</span><span class="nv">$ </span>php -i|grep configure
Configure <span class="nv">Command</span> <span class="o">=</span>&gt;  <span class="s1">&#39;./configure&#39;</span>
<span class="s1">&#39;--build=x86_64-redhat-linux-gnu&#39;</span> <span class="s1">&#39;--host=x86_64-redhat-linux-gnu&#39;</span>
<span class="s1">&#39;--target=x86_64-redhat-linux-gnu&#39;</span> <span class="s1">&#39;--program-prefix=&#39;</span>
<span class="s1">&#39;--prefix=/usr&#39;</span> <span class="s1">&#39;--exec-prefix=/usr&#39;</span> <span class="s1">&#39;--bindir=/usr/bin&#39;</span>
<span class="s1">&#39;--sbindir=/usr/sbin&#39;</span> <span class="s1">&#39;--sysconfdir=/etc&#39;</span> <span class="s1">&#39;--datadir=/usr/share&#39;</span>
<span class="s1">&#39;--includedir=/usr/include&#39;</span> <span class="s1">&#39;--libdir=/usr/lib64&#39;</span>
<span class="s1">&#39;--libexecdir=/usr/libexec&#39;</span> <span class="s1">&#39;--localstatedir=/var&#39;</span>
<span class="s1">&#39;--sharedstatedir=/usr/com&#39;</span> <span class="s1">&#39;--mandir=/usr/share/man&#39;</span>
<span class="s1">&#39;--infodir=/usr/share/info&#39;</span> <span class="s1">&#39;--cache-file=../config.cache&#39;</span>
<span class="s1">&#39;--with-libdir=lib64&#39;</span> <span class="s1">&#39;--with-config-file-path=/etc&#39;</span>
<span class="s1">&#39;--with-config-file-scan-dir=/etc/php.d&#39;</span> <span class="s1">&#39;--disable-debug&#39;</span>
<span class="s1">&#39;--with-pic&#39;</span> <span class="s1">&#39;--disable-rpath&#39;</span> <span class="s1">&#39;--without-pear&#39;</span> <span class="s1">&#39;--with-bz2&#39;</span>
<span class="s1">&#39;--with-curl&#39;</span> <span class="s1">&#39;--with-exec-dir=/usr/bin&#39;</span> <span class="s1">&#39;--with-freetype-dir=/usr&#39;</span>
<span class="s1">&#39;--with-png-dir=/usr&#39;</span> <span class="s1">&#39;--enable-gd-native-ttf&#39;</span> <span class="s1">&#39;--without-gdbm&#39;</span>
<span class="s1">&#39;--with-gettext&#39;</span> <span class="s1">&#39;--with-gmp&#39;</span> <span class="s1">&#39;--with-iconv&#39;</span> <span class="s1">&#39;--with-jpeg-dir=/usr&#39;</span>
<span class="s1">&#39;--with-openssl&#39;</span> <span class="s1">&#39;--with-png&#39;</span> <span class="s1">&#39;--with-pspell&#39;</span>
<span class="s1">&#39;--with-expat-dir=/usr&#39;</span> <span class="s1">&#39;--with-pcre-regex=/usr&#39;</span> <span class="s1">&#39;--with-zlib&#39;</span>
<span class="s1">&#39;--with-layout=GNU&#39;</span> <span class="s1">&#39;--enable-exif&#39;</span> <span class="s1">&#39;--enable-ftp&#39;</span>
<span class="s1">&#39;--enable-magic-quotes&#39;</span> <span class="s1">&#39;--enable-sockets&#39;</span> <span class="s1">&#39;--enable-sysvsem&#39;</span>
<span class="s1">&#39;--enable-sysvshm&#39;</span> <span class="s1">&#39;--enable-sysvmsg&#39;</span> <span class="s1">&#39;--enable-track-vars&#39;</span>
<span class="s1">&#39;--enable-trans-sid&#39;</span> <span class="s1">&#39;--enable-yp&#39;</span> <span class="s1">&#39;--enable-wddx&#39;</span>
<span class="s1">&#39;--with-kerberos&#39;</span> <span class="s1">&#39;--enable-ucd-snmp-hack&#39;</span>
<span class="s1">&#39;--with-unixODBC=shared,/usr&#39;</span> <span class="s1">&#39;--enable-memory-limit&#39;</span>
<span class="s1">&#39;--enable-shmop&#39;</span> <span class="s1">&#39;--enable-calendar&#39;</span> <span class="s1">&#39;--enable-dbx&#39;</span> <span class="s1">&#39;--enable-dio&#39;</span>
<span class="s1">&#39;--with-mime-magic=/usr/share/file/magic.mime&#39;</span> <span class="s1">&#39;--without-sqlite&#39;</span>
<span class="s1">&#39;--with-libxml-dir=/usr&#39;</span> <span class="s1">&#39;--with-xml&#39;</span> <span class="s1">&#39;--with-system-tzdata&#39;</span>
<span class="s1">&#39;--enable-force-cgi-redirect&#39;</span> <span class="s1">&#39;--enable-pcntl&#39;</span> <span class="s1">&#39;--with-imap=shared&#39;</span>
<span class="s1">&#39;--with-imap-ssl&#39;</span> <span class="s1">&#39;--enable-mbstring=shared&#39;</span>
<span class="s1">&#39;--enable-mbstr-enc-trans&#39;</span> <span class="s1">&#39;--enable-mbregex&#39;</span>
<span class="s1">&#39;--with-ncurses=shared&#39;</span> <span class="s1">&#39;--with-gd=shared&#39;</span> <span class="s1">&#39;--enable-bcmath=shared&#39;</span>
<span class="s1">&#39;--enable-dba=shared&#39;</span> <span class="s1">&#39;--with-db4=/usr&#39;</span> <span class="s1">&#39;--with-xmlrpc=shared&#39;</span>
<span class="s1">&#39;--with-ldap=shared&#39;</span> <span class="s1">&#39;--with-ldap-sasl&#39;</span> <span class="s1">&#39;--with-mysql=shared,/usr&#39;</span>
<span class="s1">&#39;--with-mysqli=shared,/usr/bin/mysql_config&#39;</span> <span class="s1">&#39;--enable-dom=shared&#39;</span>
<span class="s1">&#39;--with-dom-xslt=/usr&#39;</span> <span class="s1">&#39;--with-dom-exslt=/usr&#39;</span>
<span class="s1">&#39;--with-pgsql=shared&#39;</span> <span class="s1">&#39;--with-snmp=shared,/usr&#39;</span>
<span class="s1">&#39;--enable-soap=shared&#39;</span> <span class="s1">&#39;--with-xsl=shared,/usr&#39;</span>
<span class="s1">&#39;--enable-xmlreader=shared&#39;</span> <span class="s1">&#39;--enable-xmlwriter=shared&#39;</span>
<span class="s1">&#39;--enable-fastcgi&#39;</span> <span class="s1">&#39;--enable-pdo=shared&#39;</span>
<span class="s1">&#39;--with-pdo-odbc=shared,unixODBC,/usr&#39;</span>
<span class="s1">&#39;--with-pdo-mysql=shared,/usr&#39;</span> <span class="s1">&#39;--with-pdo-pgsql=shared,/usr&#39;</span>
<span class="s1">&#39;--with-pdo-sqlite=shared,/usr&#39;</span> <span class="s1">&#39;--enable-dbase=shared&#39;</span>
</code></pre></div>
<ul>
  <li>mysql:
据网上都说是cat /usr/bin/mysqlbug|grep conf，但我这的结果是压根没用……</li>
</ul>
      <a href="/2009/12/13/show-some-common-apps-compiler-options" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/12/04/magic-of-quotes" title="引号的魔力" rel="bookmark">引号的魔力</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-04 00:00:00 +0800">04 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@neteasesquid1 ~<span class="o">]</span><span class="c"># i=1.2.3.4;awk -v OFS=&quot;tt&quot; &#39;BEGIN{print &#39;&quot;$i&quot;&#39;,&quot;&#39;&quot;$i&quot;&#39;&quot;,&quot;&#39;$i&#39;&quot;,&quot;&quot;&#39;$i&#39;&quot;&quot;}&#39;</span>
1.20.30.4
1.2.3.4
1.2.3.4
1.20.30.4
</code></pre></div>
<p>以前用awk调用shell变量时，一般都是文字字符串，看不出什么问题来；今天突然用上ip，发现输出结果显示不正常。于是做了如上实验。
但是原因嘛，还是不知道……
继续做下一个实验：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>rcl@ubuntu:/win/learning/myshell<span class="o">]</span><span class="nv">$ i</span><span class="o">=</span>1.2.3;echo <span class="s2">&quot;1.2.3.4&quot;</span>|awk <span class="s1">&#39;/&#39;</span><span class="s2">&quot;$i&quot;</span><span class="s1">&#39;/{print}&#39;</span>
1.2.3.4
<span class="o">[</span>rcl@ubuntu:/win/learning/myshell<span class="o">]</span><span class="nv">$ i</span><span class="o">=</span>1.2.3;echo <span class="s2">&quot;1.2.3.4&quot;</span>|awk <span class="s1">&#39;/&quot;&#39;</span><span class="nv">$i</span><span class="s1">&#39;&quot;/{print}&#39;</span>
<span class="o">[</span>rcl@ubuntu:/win/learning/myshell<span class="o">]</span><span class="nv">$ i</span><span class="o">=</span>1.2.3;echo <span class="s2">&quot;1.2.3.4&quot;</span>|awk <span class="s1">&#39;/&#39;</span><span class="s2">&quot;$i&quot;</span><span class="s1">&#39;/{print &quot;&#39;</span><span class="nv">$i</span><span class="s1">&#39;&quot;}&#39;</span>
1.2.3
<span class="o">[</span>rcl@ubuntu:/win/learning/myshell<span class="o">]</span><span class="nv">$ i</span><span class="o">=</span>1.2.3;echo <span class="s2">&quot;1.2.3.4&quot;</span>|awk <span class="s1">&#39;/&#39;</span><span class="s2">&quot;$i&quot;</span><span class="s1">&#39;/{print &#39;</span><span class="s2">&quot;$i&quot;</span><span class="s1">&#39;}&#39;</span>
1.20.3
<span class="o">[</span>rcl@ubuntu:/win/learning/myshell<span class="o">]</span><span class="nv">$ i</span><span class="o">=</span>1.2.3;echo <span class="s2">&quot;1.20.3.4&quot;</span>|awk <span class="s1">&#39;/&#39;</span><span class="s2">&quot;$i&quot;</span><span class="s1">&#39;/{print}&#39;</span>
<span class="o">[</span>rcl@ubuntu:/win/learning/myshell<span class="o">]</span><span class="nv">$ i</span><span class="o">=</span>1.2.3;echo <span class="s2">&quot;1.20.3.4&quot;</span>|awk <span class="s1">&#39;/&quot;&#39;</span><span class="nv">$i</span><span class="s1">&#39;&quot;/{print}&#39;</span>
</code></pre></div>
<p>所以最终结果，在regex里，awk引用shell变量是&rsquo;&ldquo;$i&rdquo;&lsquo;，而在&rsquo;{}&rsquo;里则要写成&rdquo;&lsquo;$i&rsquo;&ldquo;。乱呀……</p>
      <a href="/2009/12/04/magic-of-quotes" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/23/sub-commands-in-sed" title="sed子命令集" rel="bookmark">sed子命令集</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-23 00:00:00 +0800">23 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>1．：
用法：
：lable
在脚本中标记一行，用于实现由b或t的控制转移。Label最多可以包含7个字符</p>
<p>2．=
用法：
=[address]=
将所寻址的行编写到标准输出</p>
<p>3．a
用法：
[address]a
text
在与address匹配的每行后面追加text。如果text多于一行，必须用反斜杠将这些行前面的换行符“隐藏”起来。Text将被没有用这种方法隐藏的第一个换行符结束。Text在模式空间中是不可用的并且后续的命令不能应用于它。当编辑命令的列表用完时，这个命令的结果将被输送到标准输出，而不管在模式空间中的当前行发生了什么。</p>
<p>4．b
用法：
[address1[,address2]]b[label]
无条件地将控制转移到脚本的其他位置的：label处。也就是说，label后面的命令是应用于当前行的下一个命令。如果没有指定label,
控制将一直到达脚本的末端，因此不再有命令作用于当前行。</p>
<p>5．c
用法：
[address1[,address2]]c
text
用text替代（改变）由地址选定的行。当指定的是一个行范围时，将所有的这些行作为一个组由text的一个副本来替代。每个text行后面的换行符必须用反斜杠将其转义，但最后一行除外。实际上，模式空间的内容被删除，因此后续的命令不能应用于它（或应用于text）</p>
<p>6．d
用法：
[address1[,address2]]d
从模式空间中删除行。因此行没有传递到标准输出。一个新的输入行被读取，并用脚本的第一个命令来编辑。</p>
<p>7．D
用法：
[address1[,address2]]D
删除由命令N创建的多行模式空间中的一部分（直到嵌入的换行符），并且用脚本的第一条命令恢复编辑。如果这个命令使模式空间为空，那么将读取一个新的输入行，和执行了d命令一样。</p>
<p>8．g
用法：
[address1[,address2]]g
将保持空间（参见h或H命令）中的内容复制到模式空间中，并将当前的内容清除。
9．G
用法：
[address1[,address2]]G
将换行符后的保持空间（参见h或H命令）内容追加到模式空间。如果保持空间为空，则将换行符添加到模式空间。
10．h
用法：
[address1[,address2]]h
将模式空间的内容复制到保存空间，即一个特殊的临时缓冲区。保存空间的当前内容被清除。
11．H
[address1],address2]]H
将换行符和模式空间的内容追加到保持空间中，即使保持空间为空，这个命令也追加换行符。
12．i
用法：
[address1]i
text
将text插入到每个和address匹配的行的前面
13．l
用法：
[address1[,address2]]l
列出模式空间的内容，将不可打印的字符表示为ASCII码。长的行被折行。
14．n
用法：
[address1[,address2]]n
读取下一个输入行到模式空间。当前行被送到标准输出。新行成为当前行并递增行计数器。将控制转到n后面的命令，而不是恢复到脚本的顶部。
15．N
用法：
[address1[,address2]]N
将下一个输入行追加到模式空间的内容之后；新添加的行与模式空间的当前内容用换行符分隔（这个命令用于实现跨两行的模式匹配。利用n来匹配嵌入的换行符，则可以实现多行匹配模式）。
16．p
用法：
[address1[,address2]]p
打印所寻址的行。注意这将导致输出的重复，除非默认的输出用”#n”或”-n”命令行选项限制。常用于改变流控制（d,n,b）的命令之前并可能阻止当前行被输出。
17．P
用法：
[address1[,address2]]P
打印由命令N创建的多行模式空间的第一部分（直接嵌入的换行符）。如果没有将N应用于某一行则和p相同。
18．q
用法：
[address]q
当遇到address时退出。寻址的行首先被写到输出（如果没有限制默认输出），包括前面的a或r命令为它追加的文本。
19．r
用法：
[address]r file
读取file的内容并追加到模式空间内容的后面。必须在r和文件名file之间保留一个空格。
20．s
用法：
[address1[,address2]]s/pattern/replacement/[flags]
用replacement代替每个寻址的pattern。如果使用了模式地址，那么模式//表示最后指定的模式地址。可以指定下面的标志：</p>
<pre><code>n 替代每个寻址的行的第n个/pattern/。N是1到512之间的任意数字，并且默认值为1。
g 替代每个寻址的行的所有/pattern/，而不只是第一个
p 如果替换成功则打印这一行。如果成功进行了多个替换，将打印这个行的多个副本。
w file 如果发生一次替换则将这行写入file。最多可以打开10个不同的file。
</code></pre>
<p>replacement是一个字符串,用来替换与正则表达式匹配的内容.在replacement部分,只有下列字符有特殊含义:</p>
<p>&amp; 用正则表达式匹配的内容进行替换
n
匹配第n个子串(n是一个数字),这个子串以前在pattern中用&rdquo;(&ldquo;和&rdquo;)&rdquo;指定.
当在替换部分包含&rdquo;与&rdquo;符号(&amp;),反斜杠()和替换命令的定界符时可用转义它们.另外,它用于转义换行符并创建多行replacement字符串.</p>
<p>s/pattern/replacememt/flag
如果flag是数字,那么指定对一行上某个位置的匹配.如果没有数字标志,则替换命令只替换第一个匹配串,因此&rdquo;1&rdquo;可以被看作是默认的数字标志.</p>
<p>替换元字符是反斜杠()、与符号(&amp;)和n。</p>
<p>反斜杠一般用于转义其他的元字符，但是它在替换字符串中也用于包含换行符。
例如对于如下的行：
column1(制表符)column2(制表符)column3(制表符)column4
使用如下替换语句：
s/制表符//2
注意，在反斜杠的后面不允许有空格。这个脚本产生下面的结果：
column1(制表符)column2
column3(制表符)column4
&ldquo;与&rdquo;符号(&amp;)作为元字符表示模式匹配的范围,不是被匹配的行.例如下面的命令:
s/UNIX/s-2&amp;0/g
可以将输入行:
on the UNIX Operating System.
替换成:
on the s-2UNIXs0 Operating System.
当正则表达式匹配单词的变化时,&rdquo;与&rdquo;符号特别有用.它允许指定一个可变的替换字符串.诸如&rdquo;See Section 1.4&rdquo;或&rdquo;See Section 12.9&rdquo;的引用都应该出现在圆括号中，如&rdquo;(See Section 12.9)&rdquo;.正则表达式可以匹配数字的不同组合，所以在替换字符串中可以使用&rdquo;&amp;&rdquo;并括起所匹配的内容：
s/See Section [1-9][0-9]<em>.[1-9][0-9]</em>/(&amp;)/
这里&rdquo;与&rdquo;符号用于在替换字符串中引用整个匹配内容．
n元字符用于选择被匹配的字符串的任意独立部分，并且在替换字符串中回调它．在sed中转义的圆括号括住正则表达式的任意部分并且保存以备回调．一行最多允许保存９次．例如，当节号出现在交叉引用中时要表示为用粗体：
s/(See Section )([1-9][0-9]<em>.[1-9][0-9]</em>)/1fB2fp/
再来看另外一个例子：
$ cat test1
first:second
one:two
$ sed &lsquo;s/(.<em>):(.</em>)/2:1/ test1
second:first
two:one</p>
<p>21．t
用法：
[address1[,address2]]t[label]
测试在寻址的行范围内是否成功执行了替换，如果是，则转移到有label标志的行（参见b和:)。如果没有给出label，控制将转移到脚本的底部。</p>
<p>22．w
用法：
[address1[,address2]]w file
将模式空间的内容追加到file。这个动作是在遇到命令时发生而不是在输出模式空间内容时发生。必须在w和这个文件名之间保留一个空格。在脚本中可以打开的最大文件数是10。如果文件不存在，这个命令将创建一个文件。如果文件存在，则每次执行脚本时将改写其内容，多重写入命令直接将输出写入到同一个文件并追加到这个文件的末端。</p>
<p>23．x
用法：
[address1[,address2]]x
交换模式空间和保持空间的内容。</p>
<p>24．y
用法：
[address1[,address2]]y/abc/xyz/
按位置将字符串abc中的字符替换成字符串xyz中相应字符。</p>
      <a href="/2009/11/23/sub-commands-in-sed" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/22/a-dynamic-data-storage-solution-for-cdn-ubdp" title="一种CDN中的动态数据存储方案——UbDP" rel="bookmark">一种CDN中的动态数据存储方案——UbDP</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-22 00:00:00 +0800">22 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上回百度到这篇文章，于是上维普下载了来看，为方便阅读，贴在这里。</p>
<p>原文出处《计算机应用》2008年8月第28卷第8期：</p>
<hr />
<p><strong>一种CDN中的动态数据存储方案——UbDP
</strong>汤迪斌，王劲林，倪宏
(1．中国科学院研究生院，北京100039；2．中国科学院声学研究所国家网络新媒体工程技术研究中心，北京100080)
(<a href="mailto:tangdihin@gmail.com">tangdihin@gmail.com</a>)</p>
<p><strong>摘要：</strong>CDN对于动态Web应用的加速通常采用数据缓存或复制技术。针对论坛、博客服务提供商等为注册用户提供个人信息发布平台的网站，提出了一种基于用户的数据分割方法：将数据按所属注册用户进行分割，分布到离该用户最近的数据库系统中。将数据库UID操作分散到多个数据库系统，消除了单个数据库系统的I／O瓶颈。
<strong>关键词：</strong>内容分发网络；分布式数据库；数据缓存；动态Web应用
<strong>中图分类号：TP3l1.133.1  文献标志码：A</strong></p>
<p>0 引言
尽管网络带宽和服务器性能在不断改善，用户访问迟延过大一直是Web应用的一个重要问题。随着流媒体的出现，迟延问题变得更加严重。导致Internet上内容传送迟延过大的原因主要有两个：1)缺乏对Internet的全局管理；2)有限的网络带宽和服务器资源总是跟不上网络负载增长的脚步。解决这个性能问题的基本办法就是将内容移到离最终用户较近的边缘服务器上。内容分发网络(Content Delivery Network，CDN)正是采用了这个办法，减小了访问迟延，提高了数据传输速率。目前CDN主要应用于静态内容的缓存，如静态页面、图片、音视频文件等。对于动态内容的缓存尚处在研究当中，目前主要有边缘计算(Edge Computing)[5,6]、数据库复制(Database Replication)[7,8]、内容感知数据缓存(Content-Aware Cache，CAC)[9-11]、内容无关数据缓存(Content-Blind Cache，CBC)[12,13]四种研究方向。文献[14]的研究表明复制和缓存方法的选择很大程度上依赖于具体的应用，没有一种技术能很好地适用各种Web应用。对于论坛类网站，内容无关缓存方案性能最佳，而对于Amazon类的电子商务网站，数据库复制才是最好的选择。</p>
<p>论坛和博客服务提供商网站的主要特点是：网站内容由大量注册用户产生，每个用户只能添加、修改和删除属于自己的内容，所以对数据库的写操作(UID、Update、Insert and Delete)来源于处于不同位置的用户。本文针对这类为注册用户提供个人信息发布的网站，提出了一种内容分发网络中基于用户的数据分割方法(User-based Data Partition，UbDP)方案：将数据按所属注册用户进行分割，分布到离该用户最近的数据库系统中。
l 内容缓存和内容复制技术
动态网站的普及，驱使CDN和数据库研究组织都在寻找适用于动态内容的先进缓存技术。文献总结了目前主要的四种动态内容缓存和复制技术方案。
边缘计算就是将生成动态页面的代码如PHP代码、ASP代码分发到合适的边缘服务器(Edge Server，ES)上，数据还是保存在内容提供商的原始服务器(Origin Server，OS)上。Es根据Session(用来标识不同的用户会话)、OS上的数据等信息为每个用户生成动态页面。这类方法的优点是结构简单，不需要对原有CDN结构做出调整。缺点是每个数据库查询都需要到0S上执行，增加了迟延，且0S很可能成为性能瓶颈。
数据库复制技术为了解决边缘计算的迟延和数据库瓶颈问题，将数据库也复制到多个ES上，这样ES就能在本地生成动态页面，较大地减小了用户迟延。但是，为了维护数据的一致性，UID操作需要在所有数据库服务器上执行一遍，这会增加大量额外的网络流量和服务器处理开销。</p>
<p>相对于数据库复制技术在ES中复制整个数据库，CAC方案中ES只缓存数据库的一部分。每次查询数据库时，Es都先检查本地数据库中的数据是否足够应答此次查询请求，这个过程称为查询包含检查。如果本地数据足够，则查询请求在本地执行；否则，请求被转发到0S上，ES会缓存查询结果以备后用。这种方案的主要缺点是查询包含检查的计算复杂度太高。
为了降低查询包含检查的计算复杂度，CBC方案得到了应用：ES中根本不运行数据库软件，而只是单独缓存各个数据库查询的结果。因为并不合并各缓存的查询结果，只有当查询语句完全相同时才算缓存命中，所以查询包含检查的计算复杂度大大降低。
以上四种方案都有一个共同的缺点，即所有的UID操作都需要在OS上执行，然后通过一定的策略更新ES上的缓存。这样，在数据库更新相当频繁的应用中，0S上的数据库势必成为系统的性能瓶颈。本文提出的UbDP很好地将UID操作分散到了多个数据库系统，解决了数据库瓶颈问题。
2 基于用户的数据分割
基于用户的数据分割方案应用于传统的CDN架构之上，增加了分布式数据库系统用于存储动态数据，而不改变CDN中原服务器的功能。
<strong>2.1系统架构</strong></p>
<p><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=62d80b5e0100fpe8&amp;url=http://static12.photo.sina.com.cn/orignal/62d80b5et727ea2f919eb&amp;690"><img title="一种CDN中的动态数据存储方案——UbDP" src="http://static12.photo.sina.com.cn/bmiddle/62d80b5et727ea2f919eb&amp;690" alt="一种CDN中的动态数据存储方案——UbDP" /></a></p>
<p>图1 UbDP系统架构</p>
<p>如图1所示。将CDN中的ES按照所在位置划分为有限的多个逻辑区域Region1、Region2、…RegionN，在每个区域内布置一套数据库系统，该数据库系统可以是单台数据库服务器，也可以是由多台数据库服务器组成的Master、Slave结构。数据库中除了存储用户数据外，还维护了用户和其主数据库(Home Database，HDB)的对应关系。每个区域还有一个数据库查询代理(Query Agent，QA)，接收所有查询请求，根据查询请求类型进行不同的数据库操作。
ES接收到用户HTTP请求后，根据需要向QA发送数据库查询请求，QA从自身缓存或后台数据库取得数据返回给ES，ES生成返回页面。
全局负载均衡器(Global Server Load Balancing，GSLB)的目的是在整个网络范围内，将用户请求定向到最近的节点。因此，就近性判断是其主要功能。</p>
<p><strong>2.2数据库查询代理</strong></p>
<p><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=62d80b5e0100fpe8&amp;url=http://static2.photo.sina.com.cn/orignal/62d80b5et78f27edbd2f1&amp;690"><img title="一种CDN中的动态数据存储方案——UbDP" src="http://static2.photo.sina.com.cn/bmiddle/62d80b5et78f27edbd2f1&amp;690" alt="一种CDN中的动态数据存储方案——UbDP" /></a></p>
<p>如图2所示，数据库查询代理QA由查询接口、查询分类器、单库查询缓存和多库查询代理组成。
将数据库查询分为三类：第一类为UID操作；第二类只需要查询一个用户的数据，称为单库查询，包括获取用户信息、获取文章内容等，如：
Q1：SELECT name FROM user WHERE userId = 2
Q2：SELECT title FROM post WHERE id = 3 and userId = 2;
Q1从用户表中获取id为2的用户名；Q2从博客文章表中获取用户2的id为3的文章标题。
第三类查询需要同时获取多个用户的数据，称为多库查询，包括用户积分榜、最新博客文章、博客搜索等，如：
Q3：SELECT userId FROM user ORDER BY score DESC LIMIT 0，10
Q4：SELECT postId FROM blog_index WHERE keyword=&rdquo;旅游&rdquo;
Q3获取积分最高的10个用户id；Q4从索引表中搜索包含关键字“旅游”的所有博客文章。
查询分类器接收到非UID查询请求后，根据是否包含“userld=”查询条件判断查询所属分类(如果包含“userld=”则是单库查询，否则为多库查询)，将请求转发给单库查询缓存或多库查询代理处理。单库查询缓存采用文献[13]中所述的CBC缓存方法，没有命中缓存时的处理流程如下图3所示，先解析出该请求涉及的用户，然后向同区域内的数据库获取该用户的HDB，将查询请求发往HDB，缓存并返回查询结果。</p>
<p><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=62d80b5e0100fpe8&amp;url=http://static16.photo.sina.com.cn/orignal/62d80b5et78f27fa6784f&amp;690"><img title="一种CDN中的动态数据存储方案——UbDP" src="http://static16.photo.sina.com.cn/bmiddle/62d80b5et78f27fa6784f&amp;690" alt="一种CDN中的动态数据存储方案——UbDP" /></a></p>
<p>多库查询代理内部也有一个CBC缓存模块，没有命中缓存时，将查询请求广播到所有数据库系统，综合各数据库查询结果，缓存并返回最终查询结果。为了提高响应速度，对于搜索类不需要对结果进行排序的多库查询，只需一个数据库返回结果，多库查询代理可以立即将结果返回给ES。
<strong>2.3主数据库选择策略</strong>
HDB的选择依赖于用户所在的位置，当用户所在位置发生变化时，系统为他选择的HDB也会变化。
1)设置用户注册或第一次登录时所使用ES所在区域为该用户的主区域(Home Region，HR)，HR内的数据库为该用户的HDB；HDB将该用户的HDB更新情况广播给所有数据库；
2)HDB记录所有它负责用户UID操作的来源区域；如果发现对于某个用户，上一个时问片断内来自某区域的UID操作多于本区域，则可以判断该用户暂时或永久迁移到了新区域，设置新区域内的数据库为该用户的HDB；
3)将该用户的最新信息同步到新HDB；此过程中，为了避免冲突，需要将该用户数据写锁定，不允许用户更新：选择用户离线时更新其HDB，可以减少写锁定带来的影响；
4)将该用户HDB更新情况广播到所有数据库。根据CDN的请求路由原则，用户请求总是被转发到最合适的Es。理想情况下，从同一个位置发起的多次请求，都会被转发到离用户最近的同一个ES上，称为理想ES。考虑到网络拥塞和ES的负载情况，大多数同一个位置发起的多次请求都会被转发到理想ES同一区域内的ES上。所以只有当用户所在位置发生大范围变动时，才需要更新HDB。实际应用中用户并不会经常性地变化所在区域，所以HDB变化的可能性很小，为用户提供服务的ES通常会和HDB位于网络迟延较小的同一区域内。由于将数据库的读写操作都移到了离用户较近的边缘服务器上，用户迟延大大减小。
3 性能分析
本文用RUBBoS对UbDP和数据集中存储内容无关缓存系统的性能进行了比较。RUBBoS是一个模拟了slashdot.org的基准测试程序，它主要包含了3个数据库表，分别存储了5000000个用户、6000篇文章和200000条评论。我们使用了RUBBoS的PHP实现来进行我们的试验。我们使用RUBBoS的ClientEmulator模拟用户会话来访问网站，用户的平均思考时间为7s，且符合TPC-W标准。边缘服务器和数据库服务器都是2.8GHzCPU，1GB内存，边缘服务器中使用Apache2.2.3和PHP5.2.4，数据库软件为MySQL5.0.22。用NISTNET来模拟广域网环境，图4中实线连接带宽为90Mbps，时延为10ms，表示网络节点在同一个区域内；虚线连接带宽为50Mbps，时延为100ms，表示网络节点位于不同的区域。试验方法是测量不同负载情况下的用户迟延即用户发出请求到收到回复之间的时间差。</p>
<p><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=62d80b5e0100fpe8&amp;url=http://static8.photo.sina.com.cn/orignal/62d80b5et78f29205e7a7&amp;690"><img title="一种CDN中的动态数据存储方案——UbDP" src="http://static8.photo.sina.com.cn/bmiddle/62d80b5et78f29205e7a7&amp;690" alt="一种CDN中的动态数据存储方案——UbDP" /></a></p>
<p>图5 用户只发表评论的性能结果</p>
<p>当用户只进行发表评论操作，即用户的每个请求都会产生数据库UID操作时，测试结果如图5所示。如果认为大于5000ms的用户等待时间是不可接受的，则采用UbDP后，系统的UID容量增加了约40％。系统容量并没有随着服务器的增加而线性增加，原因是：1)没有增加边缘服务器ES的数量，系统整体性能部分受限于ES的计算能力；2)采用UbDP引入了额外的数据库查询负载，每个UID操作前需要执行一个数据库读操作，导致了负载较低时，UbDP的迟延甚至大于内容无关缓存系统。
当用户进行普通浏览时(10％的用户会发表评论，其他用户只是浏览)，测试结果如图6所示。在并发用户会话数较小(140以下)时，采用UbDP后平均用户迟延略小于内容无关缓存系统，这是由于UbDP虽然引入了一次额外的数据库查询，但增加的额外查询是在网络迟延较小的本区域数据库上执行的，且原查询也有约一半的几率在本区域数据库上执行。随着并发用户会话数的增加，UbDP由于额外的数据库查询请求，更早进入满负载状态，用户平均迟延逐渐大于内容无关缓存系统。</p>
<p><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=62d80b5e0100fpe8&amp;url=http://static5.photo.sina.com.cn/orignal/62d80b5et78f29e83c744&amp;690"><img title="一种CDN中的动态数据存储方案——UbDP" src="http://static5.photo.sina.com.cn/bmiddle/62d80b5et78f29e83c744&amp;690" alt="一种CDN中的动态数据存储方案——UbDP" /></a></p>
<p>图6 用户普通浏览的性能结果</p>
<p>为了减少额外数据库查询带来的影响，町以在所有ES上增加一个CBC缓存模块，用来缓存用户和HDB的对应关系，CBC接近90％的缓存命中率较大提高了UbDP系统的总体性能(如图6虚线所示UbDP+ES-CBC)。
4 结语
针对论坛和博客服务提供商之类为注册用户提供个人信息发布平台的网站，本文提出了一种内容分发网络中用户分割的分布式数据库系统，通过将不同用户的数据分布到不同的数据库服务器上，有效地将数据库UID操作分散到了多个数据库上，系统的可扩展性大大提高；其代价是增加了额外的读数据库操作，使得在高负载(并发用户数大于140)时，系统性能略低于内容无关缓存系统，但通过在ES上增加CBC模块可以有效减小这一影响。
对于所有数据库表都直接或间接包含某个外键的应用场合，本文所述数据分割方法都适用。</p>
<p><strong>参考文献：</strong></p>
<p>[5]RABINOVICH M,ZHEN XIAO,AGARWAL A. Computing on the edge: A platform for replicating internet applications[C]//Proceedings of the Eighth International Workshop on Web Content Caching and Distribution.Norwell,MA,USA:Kluwer Academic Publishers,2004:57-77;
[6]RABINOVICH M,ZHEN XIAO,DOUGLIS F,et al. Moving edge side includes to the real edge-the clients[C]//Proceedings of the 4th conference on USENIX Symposium on Internet Technologies and Systems.Berkeley,CA,USA:USENIX Association.2003:12;
[7]CECCHET E.C-JDBC:a middleware framework for database clustering[J].IEEE Data Engineering Bulletin,2004,27(2):19-26;
[8]PLATTNER C,ALONSO G.Ganymed:Scalable replication for transactional Web applications[C]//Proceedings of the 5th ACM/IFIP/USENIX International Conference on Middleware.New York,NY,USA:Springer-Verlag,2004:155-174;
[9]AMIRI K,PARK S,TEWARI R,et al. DBProxy:A dynamic data cache for Web applications[C]//Proceedings of 19th Internation Conference on Data Engineering.Bangalore,India:IEEE Computer Society,2003:821-831;
[10]BORNHD C,ALTINEL M,MOHAN C，et al. Adaptive database caching with DBCache[J].IEEE Data Engineering Bulletin,2004,27(2):11-18.
[11]BUCHHLZ T,HOCHSTATTER I,LINNHOFFPOPIEN C.A profit maximizing distribution strategy for context-aware services[C]//Proceedings of Second IEEE International Workshop on Mobile Commerce and Services(WMCS&rsquo;05).Los Alamitos,USA:IEEE Computer Society,2005:144-153;
[12]OLSTON C,MANJHI A,GARROD C,et al. A sealability service for dynamic Web applications[C]//Proceedings of the Conference on Innovative Data Systems Research(CIDR).Asilomar,CA,USA:ACM Press,2005:56-69;
[13]SIVASUBRAMANIAN S,PIERRE G,VAN STEEN M,et al. GlobeCBC:Content-blind result caching for dynamic Web applications[R].Amsterdam,The Netherlands:Vrije Universiteit,2006;
[14]SIVASUBRAMANIAN S,PIERRE G,VAN STEEN M,ALONSO G.Analysis of caching and replication strategies for Web applications[J].IEEE Internet Computing,2007,11(1):60-66;
[15]Rice University,INRIA.RUBBoS:Bulletin Board Benchmark[EB/OL].[2008-01-21]. <a href="http://jmb.objeetWeb.org/rnbbos.html">http://jmb.objeetWeb.org/rnbbos.html</a>;
[16]National Institute of Standards and Technology.NIST net home page[EB/OL].[2008-01-21].http://www-x.antd.nist.gov/nistnet/;</p>
      <a href="/2009/11/22/a-dynamic-data-storage-solution-for-cdn-ubdp" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/21/zz-nginx-compile-optimization-test" title="nginx编译优化压力测试（转）" rel="bookmark">nginx编译优化压力测试（转）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-21 00:00:00 +0800">21 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>默认nginx使用的GCC编译参数是-O，需要更加优化可以使用以下两个参数：</p>
<pre><code>--with-cc-opt='-O3' --with-cpu-opt=*
</code></pre>
<p>具体是什么cpu可以grep name /proc/cpuinfo查看，如果是inter xeon，就写&ndash;with-cpu-opt=pentium，如果是AMD，就写&ndash;with-cpu-opt=opteron。这样编译针对特定CPU以及增加GCC的优化。</p>
<p>针对优化后的结果，我们进行测试，结果表明使用-O2以及以上的参数，可以微量增加性能1%左右，而O2和O3基本可以认为是相同的。</p>
<div class="highlight"><pre><code class="bash">./http_load -parallel 100 -seconds 10 urls
10811 fetches, 100 max parallel, 5.23252e+06 bytes, in 10 seconds
1.默认参数 -O
1087.2 fetches/sec, 526204 bytes/sec
msecs/connect: 45.5374 mean, 63.984 max, 1.008 min
msecs/first-response: 45.7679 mean, 64.201 max, 2.216 min
1088.9 fetches/sec, 527027 bytes/sec
msecs/connect: 45.0159 mean, 65.291 max, 0.562 min
msecs/first-response: 46.1236 mean, 67.397 max, 9.169 min
1102.2 fetches/sec, 533465 bytes/sec
msecs/connect: 44.5593 mean, 67.649 max, 0.547 min
msecs/first-response: 45.499 mean, 67.849 max, 2.495 min
2.优化编译后 -O2
1081.1 fetches/sec, 523252 bytes/sec
msecs/connect: 45.7144 mean, 63.324 max, 0.823 min
msecs/first-response: 46.1008 mean, 61.814 max, 4.487 min
1110.2 fetches/sec, 537337 bytes/sec
msecs/connect: 43.4943 mean, 60.066 max, 0.715 min
msecs/first-response: 45.756 mean, 62.076 max, 3.536 min
1107 fetches/sec, 535788 bytes/sec
msecs/connect: 44.872 mean, 3036.51 max, 0.609 min
msecs/first-response: 44.8625 mean, 59.831 max, 3.178 min
3.优化编译后 -O3
1097.5 fetches/sec, 531189 bytes/sec
msecs/connect: 45.1355 mean, 3040.24 max, 0.583 min
msecs/first-response: 45.3036 mean, 68.371 max, 4.416 min
1111.6 fetches/sec, 538014 bytes/sec
msecs/connect: 44.2514 mean, 64.831 max, 0.662 min
msecs/first-response: 44.8366 mean, 69.904 max, 3.928 min
1099.4 fetches/sec, 532109 bytes/sec
msecs/connect: 44.7226 mean, 61.445 max, 0.596 min
msecs/first-response: 45.4883 mean, 287.113 max, 3.336 min
</code></pre></div>
      <a href="/2009/11/21/zz-nginx-compile-optimization-test" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/21/squidclient-usage" title="squidclient用法" rel="bookmark">squidclient用法</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-21 00:00:00 +0800">21 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>squidclient是squid自带的一个小工具，一般用的最多的，就是-m purge URL了。
其实还有别的用法（看看help吧，不过这个慢慢来~~）先说一个大全式的用法（其他的具体用法，大不了用这里rep出来好了）：squidclient -p 80 mgr:info，显示如下：</p>
<p>[root@raocl ~]# /home/squid/bin/squidclient -p 80 mgr:info
    HTTP/1.0 200 OK
    Server:
    squid/2.6.STABLE21
    squid版本
    Date: Sat, 21 Nov 2009 03:58:45 GMT
    Content-Type: text/plain
    Expires: Sat, 21 Nov 2009 03:58:45 GMT
    Last-Modified: Sat, 21 Nov 2009 03:58:45 GMT
    X-Cache: MISS from cdn.21vianet.com
    Connection: close
    Squid Object Cache: Version 2.6.STABLE21
    Start Time: Sat, 21 Nov 2009 03:48:16 GMT
    Current Time: Sat, 21 Nov 2009 03:58:45 GMT
    Connection information for squid:
    Number of clients accessing
    cache: 1
    当前链接客户端数量
    Number of HTTP requests
    received: 2
    当前链接请求数
    Number of ICP messages
    received: 0
    Number of ICP messages
    sent: 0
    Number of queued ICP
    replies: 0
    Number of HTCP messages
    received: 0
    Number of HTCP messages
    sent: 0
    Request failure ratio:
    0.00
    Average HTTP requests per minute since
    start: 0.2
    每分钟链接请求数
    Average ICP messages per minute since
    start: 0.0
    Select loop called: 118332 times, 5.309 ms
    avg
    Cache information for squid:
    Request Hit Ratios: 5min: 0.0%,
    60min:
    0.0%
    五分钟cache请求数命中率
    Byte Hit Ratios: 5min: -0.0%,
    60min:
    100.0%
    五分钟cache字节数命中率
    Request Memory Hit Ratios: 5min:
    0.0%, 60min: 0.0%
    Request Disk Hit Ratios: 5min:
    0.0%, 60min: 0.0%
    Storage Swap size: 6224
    KB                                                         cache_dir使用大小
    Storage Mem size: 104
    KB                                                            cache_mem使用大小
    Mean Object Size: 4.60 KB
    Requests given to
    unlinkd: 0
    Median Service Times (seconds)  5
    min    60
    min:
    HTTP Requests
    (All):
    0.00000  0.00000
    Cache
    Misses:
    0.00000  0.00000
    Cache
    Hits:
    0.00000  0.00000
    Near
    Hits:
    0.00000  0.00000
    Not-Modified Replies:
    0.00000  0.00000
    DNS
    Lookups:
    0.00000  0.00000
    ICP
    Queries:
    0.00000  0.00000
    Resource usage for squid:
    UP Time: 628.201 seconds
    CPU Time: 0.216 seconds
    CPU Usage: 0.03%
    CPU Usage, 5 minute
    avg: 0.00%
    CPU Usage, 60 minute
    avg: 0.04%
    Process Data Segment Size via sbrk(): 3040
    KB
    Maximum Resident Size: 0 KB
    Page faults with physical i/o: 0
    Memory usage for squid via mallinfo():
    Total space in
    arena:    3052
    KB
    Ordinary
    blocks:
    3038
    KB
    7 blks
    Small
    blocks:
    0
    KB
    0 blks
    Holding
    blocks:
    231572
    KB
    5 blks
    Free Small
    blocks:
    0 KB
    Free Ordinary
    blocks:
    13 KB
    Total in
    use:
    234610 KB 100%
    Total
    free:
    13 KB 0%
    Total
    size:
    234624 KB
    Memory accounted for:
    Total
    accounted:
    571 KB
    memPoolAlloc calls: 76381
    memPoolFree calls: 71547
    File descriptor usage for squid:
    Maximum number of file
    descriptors:
    655360
    系统文件描述符个数
    Largest file desc currently in
    use:
    44
    使用过的最大个数
    Number of file desc currently in
    use:
    41
    目前使用中的个数
    Files queued for
    open:
    0
    Available number of file descriptors:
    655319
    Reserved number of file
    descriptors:   100
    Store Disk files
    open:
    0
    IO loop
    method:
    epoll
    Internal Data Structures:
    1379
    StoreEntries                                                              cache_dir中的文件个数
    26 StoreEntries with
    MemObjects
    mem中的文件个数
    25 Hot Object Cache
    Items
    热点文件个数
    1353 on-disk objects</p>
<p>另外，还有一个squidclient -p 80 mgr:objects，号称是慎用的大杀器，能够列出缓存文件列表——问题是：我找了个新开squid的测试机一试，发现列表显示内容是这个样子的：
    KEY 29E6623108A3E8A64DBBD016AB239AEA
    STORE_OK
    NOT_IN_MEMORY SWAPOUT_DONE
    PING_NONE
    CACHABLE,DISPATCHED,VALIDATED
    LV:1258460822 LU:1258461412 LM:1258460823
    EX:1260950400
    0 locks, 0 clients, 1 refs
    Swap Dir 0, File 0X000412
上头是32位MD5值么？谁看的懂呢……</p>
      <a href="/2009/11/21/squidclient-usage" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/21/show-full-path-in-squid-access-log" title="让squid访问日志显示完整url" rel="bookmark">让squid访问日志显示完整url</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-21 00:00:00 +0800">21 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一大串的header结束了，从上篇开始回到squid.conf本身的设置上来。</p>
<p>这里说一个小东西，一般用不上，但难保哪天就用了：</p>
<p>我们在access.log里，常看到很多url只显示到?，之后的东西就都忽略掉了，这一是为了醒目，反正都不缓存，显示干嘛；二是为了保密，说不定有些网站的GET就直接把什么秘密信息都明文传输呢？</p>
<p>但有时候特殊情况要求我们调试squid，比方说之前提到过的非得缓存?，却又没有提前告知，临时想要自己找完整url，怎么办？</p>
<p>其实有办法，squid配置中有一个strip_query_terms，就是管这事儿的。默认是on，只要改成off，就可以了~~嘿嘿，干坏事的机会到来了……</p>
      <a href="/2009/11/21/show-full-path-in-squid-access-log" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/21/intro-if-modified-since" title="cache驻留时间（四、If-Modified-Since）" rel="bookmark">cache驻留时间（四、If-Modified-Since）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-21 00:00:00 +0800">21 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>话接上回If-Modified-Since，当squid开启reload_into_ims on之后，no-cache头会在在浏览器上被转化成If-Modified-Since标识返回给web服务器。从整体架构考虑，因为squid上已经破坏了http协议的规定，那么web端就必须主动承担对网页过期的识别管理工作。嗯，要是所有的网站都能从一规划开始就这么搞，俺们干CDN的可就轻松了~~~</p>
<p>下面是一段php代码，简单的实现对If-Modified-Since标签的过期管理：</p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="nv">$headers</span> <span class="o">=</span> <span class="nb">apache_request_headers</span><span class="p">();</span>
<span class="c1">//读取整个header信息</span>
<span class="nv">$client_time</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$headers</span><span class="p">[</span><span class="s1">&#39;If-Modified-Since&#39;</span><span class="p">])</span> <span class="o">?</span>
<span class="nb">strtotime</span><span class="p">(</span><span class="nv">$headers</span><span class="p">[</span><span class="s1">&#39;If-Modified-Since&#39;</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="c1">//判断header信息是否包含If-Modified-Since标签，有则转换其时间为Unix格式，否则退出这段定义</span>
<span class="nv">$now</span><span class="o">=</span><span class="nb">gmmktime</span><span class="p">();</span>
<span class="c1">//web服务器的系统时间，为处理方便转换为GMT</span>
<span class="nv">$now_list</span><span class="o">=</span><span class="nb">gmmktime</span><span class="p">()</span><span class="o">-</span><span class="mi">60</span><span class="o">*</span><span class="mi">5</span><span class="p">;</span>
<span class="c1">//五分钟前的时间</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$client_time</span><span class="o">&lt;</span><span class="nv">$now</span> <span class="k">and</span> <span class="nv">$client_time</span>
<span class="o">&gt;</span><span class="nv">$now_list</span><span class="p">){</span>
<span class="c1">//判断浏览器时间是不是在当前的五分钟内</span>
<span class="nx">header</span><span class="p">(</span><span class="err">’</span><span class="nx">Last</span><span class="o">-</span><span class="nx">Modified</span><span class="o">:</span> <span class="err">‘</span><span class="o">.</span><span class="nb">gmdate</span><span class="p">(</span><span class="err">’</span><span class="nx">D</span><span class="p">,</span> <span class="nx">d</span> <span class="nx">M</span> <span class="nx">Y</span> <span class="nx">H</span><span class="o">:</span><span class="nx">i</span><span class="o">:</span><span class="nx">s</span><span class="err">’</span><span class="p">,</span>
<span class="nv">$client_time</span><span class="p">)</span><span class="o">.</span><span class="err">’</span> <span class="nx">GMT</span><span class="err">’</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="mi">304</span><span class="p">);</span>
<span class="k">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="c1">//判断为真，则给header加上时间为浏览器时间的Last-Modified标签，告知浏览器网页未过期</span>
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="nx">header</span><span class="p">(</span><span class="err">’</span><span class="nx">Last</span><span class="o">-</span><span class="nx">Modified</span><span class="o">:</span> <span class="err">‘</span><span class="o">.</span><span class="nb">gmdate</span><span class="p">(</span><span class="err">’</span><span class="nx">D</span><span class="p">,</span> <span class="nx">d</span> <span class="nx">M</span> <span class="nx">Y</span> <span class="nx">H</span><span class="o">:</span><span class="nx">i</span><span class="o">:</span><span class="nx">s</span><span class="err">’</span><span class="p">,</span> <span class="nv">$now</span><span class="p">)</span><span class="o">.</span><span class="err">’</span> <span class="nx">GMT</span><span class="err">’</span><span class="p">,</span>
<span class="k">true</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
<span class="c1">//否则给header加上时间为服务器系统时间的Last-Modified标签，告知浏览器网页过期，重新下载</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>这做一个范例，如果用其他的标签定义来控制过期，照葫芦画瓢就行了。比如用Expires控制，就写</p>
<pre><code>header('Expires: ' . gmdate ("D, d M Y H:i:s", gmmktime() + 60*5). " GMT");
</code></pre>
<p>题外话一句，php中关于date的函数很多，各种的格式不同，小心使用。好比这个新浪博客，就有一个小问题，如果你半夜写博客，过了零点以后发表，会提示错误；甚至如果你原先是10点发表的，隔了几天半月的哪天下午14点来修改保存，也会提示错误。非得要你改成当前分钟之前才行……</p>
      <a href="/2009/11/21/intro-if-modified-since" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/21/intro-etag" title="cache驻留时间（五、Etag）" rel="bookmark">cache驻留时间（五、Etag）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-21 00:00:00 +0800">21 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>浏览器的请求中，除了用If-Modified-Since去比对Last-Modified以外，还有另一个标签Etag，这个东东是web服务器比较有用的，squid倒没什么。不过大文件下载加速也有采用apache的系统，一并算在cache缓存里头讲吧：</p>
<p>Etag是为了更好的区分文件过期的标签。比如Last-Modified吧，如果我在一秒钟内更新两次这个文件，他的Last-Modified时间还是一样的。但Etag值不一样。听起来很浪费的样子，呵呵~~</p>
<p>Etag是由文件的inode、mtime、size三个数据通过计算得出来的字符串。这三个都可以通过stat命令查看得到。但问题就来了——一个LVS下挂了七八台RealServer，size固然得一样，mtime只要同步没有问题，也是一样，可这个inode，几乎就不太可能一样了——也就是说，当浏览器的请求被LVS转发到A服务器上时，取得了一个Etag值，一旦刷新重复请求，可能LVS又转发到B服务器，而这个文件在B服务器上计算出的Etag值是另一个。浏览器将判断文件不一致，重新下载！</p>
<p>这种情况，于网民，是用户体验度下降；于网站，是带宽重复占用；于服务器，是无效负载……</p>
<p>不过我们既然知道了原理，解决起来也很简单，只需要在apache的配置中，规定Etag的计算来源就行了。</p>
<p>默认的Etag计算是：FileETag INode MTime Size，如果改全局，只要改成FileETag MTime Size就可以了。如果是下面的某一部分，则写成FileETag -INode也行。
header信息就说到这里吧，最后提供一个<a href="http://en.wikipedia.org/wiki/List_of_HTTP_headers">wiki</a></p>
      <a href="/2009/11/21/intro-etag" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/21/intro-cache-object-size" title="cache驻留时间（六、大文件）" rel="bookmark">cache驻留时间（六、大文件）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-21 00:00:00 +0800">21 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>话说上回提到大文件下载，公司除了apache以外，有些也是用squid做的。这回说说这方面的设置。
下载业务，首先要注意到的，第一是多线程，第二是断点续传。</p>
<p>第一个参数：maximum_object_size——这个参数规定了squid能缓存的最大文件大小；
第二个参数：range_offset_limit——这个参数规定了squid能预先读取的文件大小；
第三个参数：quick_abort_(min|max|pct)——这几个参数规定了squid是否继续传输中断请求的文件；</p>
<p>第一个参数很熟悉，就不用说了。</p>
<p>第二个参数，squid的官方解释是：Sets a upper limit on how far into the the file a Range request may be to cause Squid to prefetch the whole file.</p>
<p>也就是说这个参数当客户端请求的header中带有range标签时（也就是多线程下载），如果文件大小在这个参数的规定范围内，squid会预读取这段文件作为缓存。
但是要注意了：如果你把range_offset_limit设的比maximum_object_size还大的话，squid按规则，会每次预读取完文件之后，再毫不犹豫的把它从cache里扔出去！！</p>
<p>这还不算完…如果网民这个线程开的比较猛，并发上20个线程来下载，对于squid，它却只认其中一个最快的一个线程，也就是说很有可能在第一次缓存的时候，真正下载的流量，是文件大小的20倍，于是很大可能又超过了maximum_object_size，squid又毫不犹豫抛弃掉……带宽不是用来这么玩的呀~~其结果我们也看得到，那就是cacti上上窜下跳的流量图。</p>
<p>第三个参数，当客户端中断请求后，squid会比对文件剩余部分的大小，如果小于min，就继续从源站下载；如果大于max，就放弃；如果达到了pct的比率，也继续——嗯，很像refresh_pattern的定义模式。</p>
<p>【基本上就是这些，另外，和maximum_object_size相关的还有一个maximum_object_size_in_memory，也就是能缓存在内存里的大小。这是另一个方向，要是够狠，完全可以把squid全跑在mem里（&ndash;enable-storeio）把cache_dir设成null……】</p>
<p>最后，如果修改了这些参数，对普通的小文件加速服务，会有一定的冲击，最好的办法，还是在后端的web架构上进行区分；其次，把squid进行区分，一部分专门跑下载，而其他的禁用掉range，向跑下载的邻居转发请求。不过sibling靠ICP获取一个列表的摘要，很可能假命中。这又需要对下载邻居进行详细限定，架构变得复杂无比。。。</p>
      <a href="/2009/11/21/intro-cache-object-size" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/20/intro-expires-cache-control" title="cache驻留时间（三、Expires/Cache-Control）" rel="bookmark">cache驻留时间（三、Expires/Cache-Control）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-20 00:00:00 +0800">20 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在谈cache的时候插入了上一篇回忆正则表达式的内容，是因为最近一个客户的古怪要求“url以/结尾或文件夹结尾的不能缓存”。</p>
<p>惯常的要求，大多有.*/$的缓存或者不缓存，这个文件夹不带/的结尾，可就没见过了。</p>
<p>思前想后，我觉得大概文件夹和文件的区别就是没有后缀名了吧。于是回忆了好一番正则表达式，最后写成下面那么一句：</p>
<div class="highlight"><pre><code class="squid"><span class="k">acl</span><span class="w"> </span>test<span class="w"> </span><span class="k">url_regex</span><span class="w"> </span>-i<span class="w"> </span>^&lt;a<span class="w"> </span>href=&quot;http://www.test.com/.*/[^.]*&quot;&gt;http://www.test.com/.*/[^.]*&lt;/a&gt;$<span class="w"></span>
cache<span class="w"> </span><span class="no">deny</span><span class="w"> </span>test<span class="w"></span>
</code></pre></div>
<p>测试访问结果都是MISS/200——可惜还没高兴起来呢，赫然发现其header里写着：</p>
<pre><code>Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-ridate, post-check=0,
pre-check=0
Pragma: no-cache
</code></pre>
<p>敢情MISS不是我的acl起作用了，是人家web端早就定义好了……
转过头来，继续研究cache和header的关系。今天就看这个Expires、Cache-Control和Pragma：</p>
<ul>
  <li>
    <p>Expires 申明文件的过期时间，比如这里申明的是1981年——默认不缓存的设置一般就是1981年；</p>
  </li>
  <li>
    <p>Cache-Control 常见设定和说明见下图：
<img src="/images/uploads/cache-control.jpg" alt="" />
而且对于网民本地的浏览器来说，不同的操作，导致的结果也不同；</p>
  </li>
  <li>
    <p>Pragma
这个的说明不好找，大约是在HTTP1.0里使用的一种定义，我就见过no-cache一个选项，而且在HTTP1.1里，强烈警告不要使用这个标签。</p>
  </li>
</ul>
<p>概念都复述完了，然后是办法：squid可以在refresh_pattern段里使用各种选项把这些header一一忽略，当然，这些个个都是有违http精神的做法~~除了上期提到的ignore-reload以外，还有：ignore-no-cache ignore-private ignore-no-store ignore-auth ignore-revalidate(这些对2.6都要打补丁，更高版本集成了)。
这样的处理以后，关于客户端的网页缓存控制，就由web服务器对浏览器的If-Modified-Since进行判别控制了，可以说，除非是web方面有经验的做这方面的工作，不然的话，CDN上出错的概率很大……
最后提一句：文前提到的这个客户，后来我居然发现他有个文件夹目录是http://www.test.com/update/v2.4，无语了，天知道还有什么别的稀奇古怪的目录命名……</p>
      <a href="/2009/11/20/intro-expires-cache-control" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/19/use-awk-as-one-line-command" title="awk单行实践" rel="bookmark">awk单行实践</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-19 00:00:00 +0800">19 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>客户提交一份预加载文件列表，采用了如下格式：
http://www.a.com/a/b/
a b c d e f g
h i j k l m n
http://www.b.com/b/c/
o p q r s t
u v w x y z
http://www.c.com/d/e
http://www.d.com/f/g
必须要把文件整理成完整的url，才好操作。
最初的设想，是以带http开头的行为RS，以n为OFS，然后打印RS
$0。随后发现这个想法问题多多——最主要的一点是：直接print $0的话，输出结果是不显示OFS的。
然后我才想到用for循环打印所有列的话，默认就已经分行了，不用定义OFS和ORS。
剩下的问题就是RS，然而不管我怎么写正则匹配表达式，结果都搞不定……唉
最后只能放弃这个想法，采用比较繁琐的办法：</p>
<p>awk -v RS=&rdquo;http&rdquo; &lsquo;{if($2==&rdquo;&rdquo;){print RS$1&gt;url}else{for(i=2;i&lt;=NF;i++){print RS$1$i&gt;url}}}&rsquo; URLFILE</p>
<p>需要注意的一点，这里RS$1$i之间有没有空格（但不能是逗号）都不影响结果，但如果是{x=$1}{print RS x$i}的话，RS和x之间就必须有空格！
这样5000个错乱的url，一敲回车就输出成一个url文件，列好了完整的url列表。然后for;do wget;done搞定预加载~~</p>
      <a href="/2009/11/19/use-awk-as-one-line-command" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/19/regular-expression" title="正则表达式" rel="bookmark">正则表达式</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-19 00:00:00 +0800">19 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>系统整理一下正则表达式：
    “.”匹配除了&rdquo;n&rdquo;以外的任一字符；
    “<em>”匹配前一字符任意次；【“.</em>”匹配任意个字符】
    “^”匹配行首；
    “$”匹配行尾；【“^$”匹配空行】
    “[ ]”匹配其中某个字符；【“[^ ]”匹配此外任一字符】
    “”匹配单词边界，即完整单词；
    “?”匹配前一字符0或1次；
    “+”匹配前一字符非0次；【可能要用转义一下】
    “{ }”匹配次数；</p>
      <a href="/2009/11/19/regular-expression" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/19/intro-lm-factor-algorithm" title="cache驻留时间（二、LM-factor算法）" rel="bookmark">cache驻留时间（二、LM-factor算法）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-19 00:00:00 +0800">19 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>好吧，满足某人的好奇，花开两朵，各表一枝了。
今天又看到关于LM-factor的另一种说法，特摘录如下：
<img src="/images/uploads/lm-factor.gif" alt="" />
上面这张图来自于《Squid.Definitive.Guide》第七章，对squid的LM-factor算法作出了一个很直观的描述。
请注意这张图的起始时间坐标：Last-Modified，这个是由squid读取的原始web数据所规定的。
然后就是Date，这个是原始数据进入squid的缓冲的时间。
最后就是Expires，这个就是原始数据在squid中的缓冲过期时间。
可以很容易的得出结论，对于LM-factor算法来说，原始数据在squid中的缓冲时间为
(原始数据进入squid的缓冲的时间-原始web数据所规定的Last-Modified时间)<em>percent
所以，我们可以郑重得出结论，在squid的refresh_pattern设置中，percent与Min、Max两个值是完全没有关系！
最后总结一下，对于squid来说，缓冲的数据在cache中的存活时间是这样决定的：
如果有定义refresh_pattern：只要满足以下两个条件之一，缓冲对象过期
缓冲对象在squid的cache缓冲的时间大于refresh_pattern定义的max
缓冲对象在squid的cache缓冲的时间大于(原始数据进入squid的缓冲的时间-原始web数据所规定的Last-Modified时间)</em>percent
用编程语言来描述，就是
if
((CURRENT_DATE-DATE)
elif
((CURRENT_DATE-DATE)/(DATE-LM_DATE)
elif
((CURRENT_DATE-DATE)&gt;max){STABLE}
else{STABLE}</p>
      <a href="/2009/11/19/intro-lm-factor-algorithm" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/18/intro-refresh_pattern" title="cache驻留时间（一、refresh_pattern）" rel="bookmark">cache驻留时间（一、refresh_pattern）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-18 00:00:00 +0800">18 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上一篇举了个缓存时间的事故，现在说说普通情况下影响这个的配置：</p>
<p>首先，refresh_pattern规则仅仅应用到没有明确过时期限的响应。原始服务器能使用Expires头部，或者Cache-Control:max-age指令来指定过时期限。</p>
<p>然后，介绍一下LM-factor算法：</p>
<p>LM-factor=(response age)/(resource age)</p>
<pre><code>响应年龄（即response age）=当前时间-对象进入cache的时间
源年龄（即resource age）=对象进入cache的时间-对象的last_modified
</code></pre>
<p>就好比上篇，因为Last-Modified错误，源年龄变成了三年，而响应年龄相对三年来说太短了，所以LM-factor也就很小很小，永远达不到警戒线……</p>
<p>最后常用刷新选项：</p>
<p>** ignore-reload
该选项导致squid忽略请求里的任何no-cache指令。如果希望内容一进入cache就不删除，直到被主动purge掉为止，可以加上ignore-reload选项,这个我们常用在mp3,wma,wmv,gif之类。</p>
<p>** override-expire
该选项导致squid在检查Expires头部之前，先检查min值。这样，一个非零的min时间让squid返回一个未确认的cache命中，即使该响应准备过期。</p>
<p>** override-lastmod
该选项导致squid在检查LM-factor百分比之前先检查min值。</p>
<p>** reload-into-ims
该选项导致squid以no-cache指令传送确认请求。换句话说，squid在转发请求之前，对该请求增加一个If-Modified-Since头部。注意这点仅仅在目标有Last-Modified时间戳时才能工作。外面进来的请求保留no-cache指令，以便它到达原始服务器。
一般情况可以使用reload-into-ims。它其实是强行控制对象的超时时间，这违反了http协议的精神，但是在带宽较窄的场合，可以提高明显系统相应时间。
以上这段是网上百度的，其实最后一段是废话，squid缓存选项，各个都是有违http协议精神的……</p>
      <a href="/2009/11/18/intro-refresh_pattern" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/18/guess-the-cdn-accel-for-games" title="游戏CDN加速猜想" rel="bookmark">游戏CDN加速猜想</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-18 00:00:00 +0800">18 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>没事去国内几个主要的CDN商网站看了看各个的CDN产品说明和解决方案，基本上大同小异（其实连小异我都没怎么找到）。唯一让我惊讶的是蓝汛Chinacache——蓝汛在自己网站上写着“游戏应用加速”，内容如下：</p>
<p>游戏运营商只需要从一点接入ChinaCache的CDN网络，通过ChinaCache的应用加速服务，不论玩家在国内或者国外，无论何时何地，从任何电信运营商接入，玩家的客户端都能够与游戏运营商的服务器之间高速传递游戏数据，从而保证中国南北甚至全球玩家都可以畅快淋漓的参与即时游戏；</p>
<p><img src="http://www.chinacache.com/uploadfile/20080110170409857.jpg" alt="" /></p>
<p>图中的CCR，百度了一下，好像是蓝汛的自动调整流量导向的监控管理平台。</p>
<p>这个图画的不明不白的，对我理解其加速实在是有害无益——话说回来，似乎所有公司的公开解决方案都是这么云里雾里——不如自己去假设：</p>
<p>网游的架构，大体应该是客户端的动作，按照代码生成一个.dat临时文件，并随时上传到服务器端；服务器端定时以及当客户端主动保存时，将该临时文件的数据记录进数据库中存储；等到客户端重新读档（或者掉线回档）时，从数据库中读取最近一次保存的数据。</p>
<p>【以上说法来自我的室友，也是我公司游戏部的同事】</p>
<p>这是上下两个过程，对于往下走的读档流程来说，实在没什么太大的加速价值，因为它是个一锤子买卖（除非是搞成分布式数据库，但这跟CDN什么关系？）；对于往上走的存档流程来说，倒是有些地方可以想想？</p>
<p>关键就在这个.dat临时文件上。我们完全可以让cache服务器缓存这些文件，然后定时上传到上级节点或者源站；还需要开发一个触发器，以便客户端主动存档使用。</p>
<p>不过这些想法，都是建立在尽量传统的CDN理解即内容分发上。而蓝汛一向号称自己有独一无二的动态应用加速手段，从网上找到的GAD白皮书来看，核心还是路由优化而已。恐怕游戏应用加速，也逃脱不了这个范围。
在边写这篇笔记边百度的时候，发现一篇论文《一种CDN中的动态数据存储方案——UbDP》，打算想办法下载全文来看看，其摘要如下：“
CDN对于动态Web应用的加速通常采用数据缓存或复制技术。针对论坛、博客服务提供商等为注册用户提供个人信息发布平台的网站，提出了一种基于用户的数据分割方法：将数据按所属注册用户进行分割，分布到离该用户最近的数据库系统中。将数据库UID操作分散到多个数据库系统，消除了单个数据库系统的I/O瓶颈。
”
相信不会让人失望。</p>
      <a href="/2009/11/18/guess-the-cdn-accel-for-games" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/18/a-strange-accident-of-squid" title="squid一次诡异事故" rel="bookmark">squid一次诡异事故</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-18 00:00:00 +0800">18 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>前几天出了一次诡异的事情。某客户在半夜2点钟更新了其网站的内容后，按照刷新规则，squid应该在15分钟内也更新成新内容的。但实际情况却是新网页一刷新没准就变成旧的，一直到5点左右这种现象才算是消失了。</p>
<p>用前段时间写的age测试脚本检查全部服务器，赫然发现有些服务器上的测试文件的age卡在102164686，也就是三年多！</p>
<p>经过整整一个下午的刷新观察，所有的服务器都陆续出现过这种情况，然后不定什么时间age又突然回复正常计数一段时间…等了很久，捕捉到一个现象，就是金华节点的测试age在896的时候，我一刷新，变成102164686了。也就可以认为，这个服务器的age计数在到达15分钟去源站比对文件的时候，突然变成102164686了。</p>
<table>
  <tbody>
    <tr>
      <td>因为之前脚本过滤了其他信息，只显示HTTP1/0</td>
      <td>Age</td>
      <td>Cache三行。于是改手动wget看全部信息。结果无意的刷新几遍后，赫然发现有一次header里的Date居然是2006年！难道是这台机器有问题？确认本机date无误后，我又登陆其他节点几台机器一一试验，都出现这个情况……于是在crontab里执行每5分钟从源站wget一次测试文件，过两天来看看结果，如下所示：</td>
    </tr>
  </tbody>
</table>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@squid1 ~<span class="o">]</span><span class="c"># cat /root/wget.log|awk &#39;/Last/{print $0}&#39; |sort -n |uniq -c</span>
803   Last-Modified: Thu, 12 Nov 2009 05:58:12 GMT
1   Last-Modified: Thu, 24 Aug 2006 00:09:51 GMT
1   Last-Modified: Thu, 24 Aug 2006 00:24:52 GMT
1   Last-Modified: Thu, 24 Aug 2006 00:29:51 GMT
1   Last-Modified: Thu, 24 Aug 2006 00:44:51 GMT
1   Last-Modified: Thu, 24 Aug 2006 00:49:51 GMT
<span class="o">[</span>root@squid1 ~<span class="o">]</span><span class="c"># cat /root/wget.log|awk &#39;/Last/{print $5}&#39; |sort -n |uniq -c</span>
381 2006
803 2009
</code></pre></div>
<p>源站文件的Last-Modified时间居然在变化！而且除了正确的2009年时间不变外，2006年的时间居然是随着时间走的（crontab是5分钟，wget日志里每次Last-Modified的时间也是隔5分钟）……</p>
<p>由此基本确定是客户源站的问题，我的理解是：当cache服务器到时去源站比对时间时，如果碰上源站这会儿时间是2009年，就更新文件并重计age；如果碰上源站这会儿时间是2006年了，那cache比源站还新，自然没法变动了……</p>
<p>但让我不解的是：header信息里Date字段时间变化，还可以说是服务器系统时间不正常，文件的Last-Modified为什么会这样变化呢？！</p>
      <a href="/2009/11/18/a-strange-accident-of-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/17/a-error-page-problem-of-squid" title="squid的一点小问题" rel="bookmark">squid的一点小问题</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-17 00:00:00 +0800">17 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>网站运行，出错是必然的。squid提供了一整套多国语言的错误信息页面，放在share/errors/目录下。
但是，让人很尴尬的一点是：squid默认的english错误页面中，居然会公开显示客户源站的IP地址。而有一部分客户，用CDN的目的之一就是要用CDN来分担攻击流量，保护自己。这下可好。生生给暴露出去了。
而附带的简体中文页面中，刚好就没这个信息。真不知道是在讽刺国人攻击性太强，心理太黑暗了么……
不管怎么说，得把这个改掉。最简单的办法，修改english页面，删除掉ERR_CONNECT_FAIL里那个关键的信息。关键的就是下面这一段：</p>
<p>Connection to %I Failed</p>
<p>这个%I，就是源站IP。修改成Connection Failed。显示结果就OK了。
这一次成了，难保下一次别的错误信息里又出什么别的问题。干脆的办法，把错误信息定位到中文包上去。
网上办法多多。</p>
<p>最根本的，在源代码编译的时候，就加上&ndash;enable-err-language=Simplify_Chinese；</p>
<p>最简单的，删除掉English目录，创建一个同名链接链接到Simplify_Chinese目录上；</p>
<p>最实用的，在squid.conf里加上一句配置语句“error_directory /home/squid/share/errors/Simplify_Chinese”，重启服务，即可。</p>
      <a href="/2009/11/17/a-error-page-problem-of-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/16/configure-ssl-support-of-squid" title="squid的SSL配置" rel="bookmark">squid的SSL配置</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-16 00:00:00 +0800">16 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>公司新进客户，要求加速它的论坛，比较奇怪的是，整个论坛居然都是https协议的网页。所以得做443端口的配置。
如果只是端口，一个https_port 443就够了。麻烦的地方在证书（之前就有客户死活不肯给证书，于是只能给做个端口转发，顶天了算是路由优化，何苦往CDN里投钱……）。
在拿到证书后，squid.conf里添加这么一句，SSL配置就算是完成了。但测试的时候问题可就多多了</p>
<div class="highlight"><pre><code class="squid">https_port<span class="w"> </span><span class="m">443</span><span class="w"> </span>cert=/test_ssl/server.cer<span class="w"> </span>key=/test_ssl/server.key<span class="w"> </span>defaultsite=bbs.test.com<span class="w"></span>
</code></pre></div>
<p>客户源站在江苏电信，之前的普通静态加速时，为了更好的达到回源效果，所有的网通节点服务器都采用了二级代理的方式，通过BGP回源。  <br />
在按照普通域名走父方式配置完毕后，wget该客户的论坛首页做测试，所有的网通节点返回的状态码倒是200，可首页文件总字节数，只有209！用IE打开一看，赫然是一个“Hello
World！”暴汗……  <br />
改为直接回源后，立马恢复正常。实在不知道这个你好页面是哪里蹦出来的！  <br />
把这个问题交给百哥和谷婶，大家伙都说只要加上一条never_direct allow all就可以强制转发https协议到上级cache服务器就可以了。但我测试的结果很遗憾——209依然——不可行！</p>
<p>和同事讨论没什么办法，大家认为这个应该是父节点要采用的证书应该是另外一种，因为他既要接受子的请求，又要去源站发起请求。目前情况下，只能取消走父配置，统一直接回源而已。然后缓存，刷新时间等等测试一一通过。唉~
[root@squid1 ~]# wget -S -O /dev/null https://bbs.test.com/attachments/month<em>0910/20091014_c30caa02ae844a8dbe58M7PIVoPJPjMh.jpg &ndash;no-check-certificate
&ndash;20:20:28&ndash;
https://bbs.test.com/attachments/month</em>0910/20091014_c30caa02ae844a8dbe58M7PIVoPJPjMh.jpg
Resolving bbs.test.com&hellip; 1.2.3.4
Connecting to bbs.test.com|1.2.3.4|:443&hellip; connected.
WARNING: cannot verify bbs.test.com&rsquo;s certificate, issued by
<code>/C=BE/OU=Domain Validation CA/O=GlobalSign nv-sa/CN=GlobalSign Domain Validation CA':
Unable to locally verify the issuer's authority.
HTTP request sent, awaiting response...
HTTP/1.0 200 OK
Date: Mon, 16 Nov 2009 09:02:07 GMT
Server: Apache/2.2.9 (Unix) DAV/2 mod_ssl/2.2.9 OpenSSL/0.9.8h PHP/5.2.6 mod_apreq2-20051231/2.6.0 mod_perl/2.0.4 Perl/v5.10.0
Last-Modified: Wed, 14 Oct 2009 13:52:59 GMT
ETag: "efc217-1801e-475e57b0924c0"
Accept-Ranges: bytes
Content-Length: 98334
Content-Type: image/jpeg
Age: 1
X-Cache: HIT from cdn.21vianet.com
Connection: keep-alive
Length: 98334 (96K) [image/jpeg]
Saving to: </code>/dev/null&rsquo;
100%[===================================================================================================================&gt;]
98,334
356K/s   in
0.3s
20:20:34 (356 KB/s) - `/dev/null&rsquo; saved [98334/98334]</p>
<p>这里要注意两个地方。</p>
<p>第一，刷新配置的匹配字段不再是^http://bbs.test.com/.<em>而是^https://bbs.test.com/.</em>，不然的话，age值就按之后的默认配置计数了；  <br />
第二，wget测试的时候，必须使用“&ndash;no-check-certificate”参数，否则没法测试；同理，如果是用curl测试，也必须加上“-k”或者“&ndash;insecure”参数。</p>
<p>curl的结果类似下面这样：</p>
<p>[root@squid1 ~]# curl -I https://bbs.test.com/attachments/month_0910/20091014_c30caa02ae844a8dbe58M7PIVoPJPjMh.jpg -k
HTTP/1.0 200 OK
Date: Mon, 16 Nov 2009 09:02:07 GMT
Server: Apache/2.2.9 (Unix) DAV/2 mod_ssl/2.2.9 OpenSSL/0.9.8h
PHP/5.2.6 mod_apreq2-20051231/2.6.0 mod_perl/2.0.4
Perl/v5.10.0
Last-Modified: Wed, 14 Oct 2009 13:52:59 GMT
ETag: &ldquo;efc217-1801e-475e57b0924c0&rdquo;
Accept-Ranges: bytes
Content-Length: 98334
Content-Type: image/jpeg
Age: 187
X-Cache: HIT from cdn.21vianet.com
Connection: close</p>
      <a href="/2009/11/16/configure-ssl-support-of-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/14/anti-hotlinking-in-squid" title="squid防盗链配置" rel="bookmark">squid防盗链配置</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-14 00:00:00 +0800">14 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>做网站的，谁愿意自己辛辛苦苦的成果就被别人轻松转载，如果是文字的，一般也就禁鼠标右键，再没什么好办法（当然，名人好打官司另说），但如果是图片，影音的文件，大可以利用http协议的header信息进行控制，这就是大多数web服务器日志要记录的referer。
公司新进一测试客户，就要求CDN方配合做防盗链。</p>
<p>公司自然有规范，直接ctrl+c、ctrl+v就搞定。但这些句子，还是值得细细研究一下的。
相关语句如下：</p>
<div class="highlight"><pre><code class="squid"><span class="k">acl</span><span class="w"> </span>test_domain<span class="w"> </span><span class="k">dstdomain</span><span class="w"> </span>.test.com<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>null_referer<span class="w"> </span><span class="k">referer_regex</span><span class="w"> </span>.<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>right_referer<span class="w"> </span><span class="k">referer_regex</span><span class="w"> </span>-i<span class="w"></span>
^http://test.com<span class="w"> </span>^http://.*.test.com<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>test_domain<span class="w"> </span>!null_referer<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">deny</span><span class="w"> </span>test_domain<span class="w"> </span>!right_referer<span class="w"></span>
</code></pre></div>
<p>第一关键点，是第一行的那个“.”，“.”匹配的是除了“n”以外的任何一个字符。那么!null_referer也就是“n”，也就是说第一条access定义的，是允许referer为空行；</p>
<p>第二关键点，是access的“!”，“!”就是非，那么!right_referer定义的就是一切除了test.com以外的域名，也就是说第二条access定义的，是不允许所有其他网站。</p>
<p>这样的结果，也就是只有从test自己的网站，或者直接在浏览器地址栏里输入完整url，才能看到文件（linux上常用的wget、curl，默认的referer也是空，所以也可以。我又试试迅雷，其referer也是空，那么估计下载工具也都是这样）</p>
<p>（比较奇怪的一点是：squid的日志里，空不显示为“ ”，而是“-”，很能迷惑人呀！）</p>
<p>于是我想到新浪和百度呀这些博客之间转来转去的图片，一般都显示一个空图，但点开来（或许还要再刷一次）也一样能看。可见防盗链都是这么做的。</p>
<p>如果真就狠到了连直接url查看也不让，那就把null_referer的定义删除掉，自然也就可以了……</p>
<p>试到这里，发现另一个问题：nagios的监控，一般也是空referer的，如果真这么狠的要求，这个监控也得改了。
因为不管是curl还是wget，都可以伪装referer。
两个的伪装语法分别是：
curl -e &ldquo;http://www.test.com&rdquo; -x $squidip:80 http://www.test.com/test.gif
wget http://www.test.com/test.gif &ndash;refer=&rdquo;http://www.test.com&rdquo; -e &ldquo;http_proxy=$squidip&rdquo;</p>
<p>我对nagios不熟，不知道里面具体是用什么去check的，大概也差不离吧？
最后，像新浪百度这样的盗链显示图片怎么做的？也就是一句话的事，如下：</p>
<div class="highlight"><pre><code class="squid"><span class="k">deny_info</span><span class="w"> </span>http://www.test.com/你盗链啦.gif<span class="w"></span>
right_referer<span class="w"></span>
</code></pre></div>
      <a href="/2009/11/14/anti-hotlinking-in-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/12/awk-variable-3" title="awk变量（三续）" rel="bookmark">awk变量（三续）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-12 00:00:00 +0800">12 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <table>
  <tbody>
    <tr>
      <td>网上闲逛，偶然看到一句统计TCP连接数的命令如右：netstat -n</td>
      <td>awk &lsquo;/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}&rsquo;</td>
    </tr>
  </tbody>
</table>
<p>要统计TCP连接数，其实用上wc命令，倒不甚难。不过为了熟悉NF的用途，便细细试试这条吧。
先看试验中netstat -n的结果：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@raocl rao<span class="o">]</span><span class="c"># netstat -n |awk &#39;/^tcp/{print $0}&#39;</span>
tcp 0 0 211.151.70.76:80 60.12.137.170:3157 SYN_RECV
tcp 0 0 211.151.70.76:80 117.136.0.184:53476 SYN_RECV
tcp 0 0 211.151.70.76:80 112.193.8.170:4281 SYN_RECV
tcp 0 0 211.151.70.76:80 112.65.48.252:62480 ESTABLISHED
tcp 0 0 211.151.70.76:80 113.205.102.168:3230 ESTABLISHED
tcp 0 0 211.151.70.76:80 198.54.202.250:2714 ESTABLISHED
tcp 0 1370 211.151.70.76:80 222.44.43.141:2070 FIN_WAIT1
tcp 0 0 211.151.70.76:80 220.248.86.74:53112 ESTABLISHED
……（下略）
</code></pre></div>
<p>然后详细打印一下那条命令里NF的每一个变化使用值：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@raocl rao<span class="o">]</span><span class="c"># netstat -n | awk &#39;/^tcp/ {print ++S[$NF],S[$NF],$NF,NF}&#39;</span>
……（上略）
532 532 ESTABLISHED 6
8 8 LAST_ACK 6
533 533 ESTABLISHED 6
534 534 ESTABLISHED 6
33 33 TIME_WAIT 6
535 535 ESTABLISHED 6
536 536 ESTABLISHED 6
</code></pre></div>
<p>也就是利用awk的行处理特性，遍历了所有tcp开头的行。定义出不同状态命名的数组下标，并分别++计数赋值给数组元素。
最后，打印数组S，如下：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@tinysquid2 ~<span class="o">]</span><span class="c"># netstat -n | awk &#39;/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}&#39;</span>
TIME_WAIT 18
FIN_WAIT1 33
FIN_WAIT2 1
ESTABLISHED 508
SYN_RECV 5
LAST_ACK 11
</code></pre></div>
      <a href="/2009/11/12/awk-variable-3" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/12/an-example-of-regular-expression" title="正则表达式一例" rel="bookmark">正则表达式一例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-12 00:00:00 +0800">12 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>前篇只记录了一些正则表达式，没有例子来说明。今天说个简单的例子。</p>
<p>squid中定义refresh_pattern，客户要求有http://www.a.com/b/0/到http://www.a.com/b/20/一共21个目录下的所有文件缓存一定时间。起先随意写了http://www.a.com/b/.*，结果在access.log里发现http://www.a.com/b/下，还有很多除了0-20以外的目录。这就没办法了，只能改。</p>
<p>如果一路写上二十一条refresh，实在麻烦。于是改琢磨正则匹配。</p>
<table>
  <tbody>
    <tr>
      <td>最后结果是http://www.a.com/b/(1{0,1}[0-9]</td>
      <td>20)/.*</td>
    </tr>
  </tbody>
</table>
<pre><code>其中1{0,1}是一部分，{}规定之前的“1”占用0-1位；
[0-9]是第二部分，表示这一位上为0-9的任意一个数字；
两个合在一起，就是(0位)1[0-9]=0-9，（1位）1[0-9]=10-19，也就是0-19；
最后第三部分，单独的20；
全部就是0-20了。
</code></pre>
      <a href="/2009/11/12/an-example-of-regular-expression" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/04/intro-getopts" title="shell技巧——getopts" rel="bookmark">shell技巧——getopts</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-04 00:00:00 +0800">04 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在写sh脚本的时候，常常需要运行时输入一些数据。之前已经知道用基本的$*，执行的情况，大概就是$0 $1 $2 $3……
那么，那些系统命令里的参数又是怎么做出来的呢？我们自己的脚本如何搞出来$0-$1的效果呢？这就是getopts的作用了。举例如下：</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
<span class="nb">echo</span> <span class="s2">&quot;OPTIND starts at $OPTIND&quot;</span>
<span class="k">while </span><span class="nb">getopts</span> <span class="s2">&quot;:pq:&quot;</span> optname
<span class="k">do</span>
<span class="k">    case</span> <span class="s2">&quot;$optname&quot;</span> in
    <span class="s2">&quot;p&quot;</span><span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;Option $optname is specified&quot;</span>
        ;;
    <span class="s2">&quot;q&quot;</span><span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;Option $optname has value $OPTARG&quot;</span>
        ;;
    <span class="s2">&quot;?&quot;</span><span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;Unknown option $OPTARG&quot;</span>
        ;;
    <span class="s2">&quot;:&quot;</span><span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;No argument value for option $OPTARG&quot;</span>
        ;;
    *<span class="o">)</span>
        <span class="c"># Should not occur</span>
        <span class="nb">echo</span> <span class="s2">&quot;Unknown error while processing options&quot;</span>
        ;;
    <span class="k">esac</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;OPTIND is now $OPTIND&quot;</span>
<span class="k">done</span>
</code></pre></div>
<p>在使用getopts命令的时候，shell会自动产生两个变量OPTIND和OPTARG。</p>
<p>OPTIND初始值为1，其含义是下一个待处理的参数的索引。只要存在，getopts命令返回true，所以一般getopts命令使用while循环；</p>
<p>OPTARG是当getopts获取到其期望的参数后存入的位置。而如果不在其期望内，则$optname被设为?并将该意外值存入OPTARG；如果$optname需要拥有具体设置值而实际却没有，则$optname被设为:并将丢失设置值的optname存入OPTARG；</p>
<p>对于$optname，可以用后标:来表示是否需要值；而前标:则表示是否开启静默模式。</p>
      <a href="/2009/11/04/intro-getopts" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/04/dist-shell" title="分布式shell程序" rel="bookmark">分布式shell程序</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-04 00:00:00 +0800">04 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>除了用expect+for循环以外，今天偶然看到分布式shell这个概念。随手百度一些资料，放到这里，等过段时间试试~~</p>
<p><a href="http://www.netfort.gr.jp/~dancer/software/dsh.html.en">DSH——dancer&rsquo;s shell / distributed shell</a></p>
<p>开发者是在debian/ubuntu上做的，依赖libdshconfig，如果要部署在其他linux发行版上，还得好好编译一番。
<a href="http://www.theether.org/pssh/">pssh</a> ——这个系列很全，ssh/scp/rsync/nuke/slurp都有。
这个默认下载是rpm包。
<a href="http://sourceforge.net/apps/mediawiki/clusterssh/index.php?title=Main_Page">cssh</a>
这个是用perl编写的，感觉普通使用的时候就像是SecureCRT、XShell这些windows平台上的ssh工具一样标签组管理登陆，但多了一个向组服务器同时发送命令的功能。
还有更多工具，见下：
<a href="http://www.gentoo.org/news/zh_cn/gmn/20080930-newsletter.xml">http://www.gentoo.org/news/zh_cn/gmn/20080930-newsletter.xml</a></p>
      <a href="/2009/11/04/dist-shell" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/04/awk-variable-2" title="awk变量（再续）" rel="bookmark">awk变量（再续）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-04 00:00:00 +0800">04 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在squid自动配置脚本里，用到了sed的/r把一个文件的内容插入另一个文件。今天看到awk对两个文件的处理方法，要通过不少运算，不怎么方便。不过作为加深对NR和FNR的不同的理解，还是有些作用。
先说下NR和FNR的不同。
在一次awk中，NR是从头计算到尾的，而FNR是每打开一个文件，就重新计算：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@raocl ~<span class="o">]</span><span class="c"># awk &#39;{print NR,FNR,$0}&#39; ts st</span>
1 1 123 456
2 2 abc def
3 3 ABC DEF
4 4 654 321
5 1 123 456
6 2 abc def
7 3 ABC DEF
8 4 654 321
</code></pre></div>
<p>下面转载一个例子：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@raocl ~<span class="o">]</span><span class="c"># cat a</span>
1000 北京市 地级 北京市 北京市
1100 天津市 地级 天津市 天津市
1210 石家庄市 地级 石家庄市 河北省
1210 晋州市 县级 石家庄市 河北省
1243 滦县 县级 唐山市 河北省
1244 滦南县 县级 唐山市 河北省
<span class="o">[</span>root@raocl ~<span class="o">]</span><span class="c"># cat b</span>
110000,北京市
120000,天津市
130000,河北省
130131,平山县
130132,元氏县
<span class="o">[</span>root@raocl ~<span class="o">]</span><span class="c"># awk &#39;BEGIN{FS=&quot;[|,]&quot;;OFS=&quot;,&quot;}NRFNR{print</span>
<span class="nv">$1</span>,<span class="nv">$2</span>,a<span class="o">[</span><span class="nv">$2</span><span class="o">]}</span><span class="err">&#39;</span> a b
110000,北京市,1000
120000,天津市,1100
130000,河北省,
130131,平山县,
130132,元氏县,
</code></pre></div>
<p>解释：
NRFNR也就是到文件b的时候，打印文件b的第1、2列和之前创建的数组a[北京市]等。</p>
      <a href="/2009/11/04/awk-variable-2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page14">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page active">
      <a href="#">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li>
      <a href="/page16">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
              <li><a href="http://showmetheco.de/" title="Viacheslav Tykhanovskyi(PocketIO/Text::Haml)">No time to wait</a></li>
              <li><a href="http://blog.dataloop.io/" title="A new SaaS monitoring tool for DevOps & Operations">Dataloop.IO</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://junqili.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.sectop.org/" title="">kindle</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
          </ul>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
