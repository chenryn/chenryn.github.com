<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">标签</a></li>
      	<li><a href="/archive.html">归档</a></li>
      	<li><a href="/errata.html">《网站运维技术与实践》勘误</a></li>
      	<li><a href="/projects.html">学习记录</a></li>
      	<li><a href="/categories.html">分类</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><a href="http://chenlinux.com/poetry/index.html" />诗文集</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/10/21/elasticearch-simple-usage" title="【Logstash系列】ElasticSearch的几点使用事项" rel="bookmark">【Logstash系列】ElasticSearch的几点使用事项</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-10-21 00:00:00 +0800">21 Oct 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前已经写过一些ES的使用，也翻译了一篇官网上关于ES存储日志的建议日志。今天稍微总结一下近期以来实践出来的方案。</p>
      <a href="/2012/10/21/elasticearch-simple-usage" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/10/17/juggernaut-for-syslog-check" title="用Juggernaut实时推送syslog分析结果" rel="bookmark">用Juggernaut实时推送syslog分析结果</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-10-17 00:00:00 +0800">17 Oct 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>大家一般都会用rsyslog或者syslog-ng之类的收集系统日志。不过收集之后的处理就各种各样了。这里提供一个简单的处理，按日期保存成文件，然后定时分析新增内容，通过websocket推送到页面报警。这对于像磁盘错误等信息比较有用。因为等nagios之类的监控反应出来，故障可能就已经到你措手不及的地步了。</p>
      <a href="/2012/10/17/juggernaut-for-syslog-check" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/10/02/gather-take-in-perl5" title="Perl5里的gather/take" rel="bookmark">Perl5里的gather/take</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-10-02 00:00:00 +0800">02 Oct 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>九月末的YAPC::Asia上，Larry Wall展示了一下怎么把一个perl5上很标准的排序脚本改造成perl6脚本。主要是条件语句不再用()了，子函数传参方式，对象化操作等等。唯独有个命令是之前未见过的：gather/take。用这个可以减少临时变量的使用。</p>
      <a href="/2012/10/02/gather-take-in-perl5" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/09/26/jsonp-for-new-version-amcharts" title="用javascript操作新版本amcharts" rel="bookmark">用javascript操作新版本amcharts</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-26 00:00:00 +0800">26 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>新版本的amcharts用js和html5改写。不再简单的用settings.xml而是写成js的object了。好在例子依然详细。下面贴一段从数据库里取值并绘制成多栏图式的代码：
{% highlight javascript %}</p>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>amStock Example</title>
        <link rel="stylesheet" href="../amcharts/style.css" type="text/css" />
        <script src="../javascripts/jquery-1.7.2.min.js" type="text/javascript"></script>
        <script src="../amcharts/amstock.js" type="text/javascript"></script>
        <script type="text/javascript">
            var chart;
            var dataProvider = [];
            AmCharts.ready(function() {
                $.ajax({
                    type: "GET",
                    dataType:"jsonp",
                    url: "http://api.domain.com/database/table/find",
                    data: {"body":'{"sort":[["date",-1]], "limit":10000}'},
                    jsonp:'jsonpCallback',
                    jsonpCallback:'jsonCallbackFunction',
                    success: function(data){
                    },
                    error: function(jqXHR, textStatus, errorThrown){
                        alert(jqXHR);
                        alert(textStatus);
                        alert(errorThrown);
                    },
                });
            });
            function jsonCallbackFunction(data) {
                parseJSON(data);
                createStockChart();
            }
            function createStockChart() {
                chart = new AmCharts.AmStockChart();
                chart.pathToImages = "../amcharts/images/";
                var categoryAxesSettings = new AmCharts.CategoryAxesSettings();
                //定义显示的最小时间段，前提是X轴是Date对象
                categoryAxesSettings.minPeriod = "hh";
                chart.categoryAxesSettings = categoryAxesSettings;
</script></head></html>
      <a href="/2012/09/26/jsonp-for-new-version-amcharts" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/09/21/json-event-for-logstash" title="【Logstash系列】数据格式之json-event" rel="bookmark">【Logstash系列】数据格式之json-event</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-21 00:00:00 +0800">21 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前的各种示例中，都没有提到logstash的输入输出格式。看起来就好像logstash比Message::Passing少了decoder/encoder一样。其实logstash也有类似的设定的，这就是format。有三种选择：plain/json/json_event。默认情况下是plain。也就是我们之前的通用做法，传文本给logstash，由logstash转换成json。</p>
      <a href="/2012/09/21/json-event-for-logstash" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/09/16/regexp-log-demo-for-nginx" title="【Message::Passing系列】Regexp::Log模板匹配变量" rel="bookmark">【Message::Passing系列】Regexp::Log模板匹配变量</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-16 00:00:00 +0800">16 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上面调用的Regexp::Log::Nginx是base Regexp::Log的实例，CPAN上已经提供了好些server的log regex，见<a href="http://search.cpan.org/search?query=Regexp%3A%3Alog&amp;mode=all">http://search.cpan.org/search?query=Regexp%3A%3Alog&amp;mode=all</a>。
{% highlight perl %}
    #!/usr/bin/perl
    package Regexp::Log::Nginx;
    use warnings;
    use strict;
    use base qw( Regexp::Log );
    use vars qw( $VERSION %DEFAULT %FORMAT %REGEXP );
    %DEFAULT = (
            format  =&gt; &lsquo;%date %status %remotehost %domain %request %originhost %responsetime %upstreamtime %bytes %referer %useragent %xforwarderfor&rsquo;,
            capture =&gt; [ &lsquo;ts&rsquo;, &lsquo;status&rsquo;, &lsquo;remotehost&rsquo;, &lsquo;url&rsquo;, &lsquo;oh&rsquo;, &lsquo;responsetime&rsquo;, &lsquo;upstreamtime&rsquo;, &lsquo;bytes&rsquo; ],
    );
    %FORMAT = (
            &lsquo;:default&rsquo; =&gt; &lsquo;%date %status %remotehost %domain %request %originhost %responsetime %upstreamtime %bytes %referer %useragent %xforwarderfor&rsquo;,
    );
    %REGEXP = (
            &lsquo;%date&rsquo; =&gt; &lsquo;(?#=date)[(?#=ts)\d{2}\/\w{3}\/\d{4}(?::\d{2}){3}(?#!ts) [-+]\d{4}](?#!date)&rsquo;,
            &lsquo;%status&rsquo; =&gt; &lsquo;(?#=status)\d+(?#!status)&rsquo;,
            &lsquo;%remotehost&rsquo; =&gt; &lsquo;(?#=remotehost)\S+(?#!remotehost)&rsquo;,
            &lsquo;%domain&rsquo; =&gt; &lsquo;(?#=domain).<em>?(?#!domain)&rsquo;,
            &lsquo;%request&rsquo; =&gt; &lsquo;(?#=request)-|(?#=method)\w+(?#!method) (?#=url).</em>?(?#!url) (?#=version)HTTP/\d.\d(?#!version)(?#!request)&rsquo;,
            &lsquo;%originhost&rsquo; =&gt; &lsquo;(?#=originhost)-|(?#=oh).<em>?(?#!oh):\d+(?#!originhost)&rsquo;,
            &lsquo;%responsetime&rsquo; =&gt; &lsquo;(?#=responsetime)-|.</em>?(?#!responsetime)&rsquo;,
            &lsquo;%upstreamtime&rsquo; =&gt; &lsquo;(?#=upstreamtime).<em>?(?#!upstreamtime)&rsquo;,
            &lsquo;%bytes&rsquo; =&gt; &lsquo;(?#=bytes)\d+(?#!bytes)&rsquo;,
            &lsquo;%referer&rsquo; =&gt; &lsquo;(?#=referer)"(?#=ref).</em>?(?#!ref)"(?#!referer)&rsquo;,
            &lsquo;%useragent&rsquo; =&gt; &lsquo;(?#=useragent)"(?#=ua).<em>?(?#!ua)"(?#!useragent)&rsquo;,
            &lsquo;%xforwarderfor&rsquo; =&gt; &lsquo;(?#=xforwarderfor)"(?#=xff).</em>?(?#!xff)"(?#!xforwarderfor)&rsquo;,
    );
    1;
{% endhighlight %}</p>
      <a href="/2012/09/16/regexp-log-demo-for-nginx" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/09/16/message-passing-filter-demo" title="【Message::Passing系列】过滤器实例" rel="bookmark">【Message::Passing系列】过滤器实例</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-16 00:00:00 +0800">16 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p><a href="http://github.com/suretec">Message::Passing</a>是Suretec公司为自己的VoIP业务开发的logstash山寨版。这几个月更新还是比较快的。比之前我刚关注它时改变很大。比如Message::Passing::Output::ElasticSearch已经出来了，还有专门的Message::Passing::Filter::ToLogstash，连命令行方式Message::Passing::Role::Script都采用了MooX::Options构建，相当的OO了。</p>
      <a href="/2012/09/16/message-passing-filter-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/09/16/message-passing-agent" title="【Message::Passing系列】客户端收集脚本" rel="bookmark">【Message::Passing系列】客户端收集脚本</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-16 00:00:00 +0800">16 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>最后编写一段日志收集的agent：
{% highlight perl %}
    #!/usr/bin/perl
    package NginxLogCollector;
    use Moo;
    use MooX::Options;
    use Message::Passing::DSL;
    use MooX::Types::MooseLike::Base qw/ Str /;
    use namespace::clean -except =&gt; [qw( meta _options_data _options_config )];
    with &lsquo;Message::Passing::Role::Script&rsquo;;
    option filename =&gt; (
        is =&gt; &lsquo;ro&rsquo;,
        isa =&gt; Str,
        default =&gt; sub { &lsquo;/data/nginx/logs/access.log&rsquo; },
    );
    option rabbitmq =&gt; (
        is =&gt; &lsquo;ro&rsquo;,
        isa =&gt; Str,
        default =&gt; sub { &lsquo;10.3.18.199&rsquo; },
    );
    sub build_chain {
        my $self = shift;
        message_chain {
            output rabbitmq =&gt; (
                class =&gt; &lsquo;AMQP&rsquo;,
                exchange_name =&gt; &lsquo;logcollect&rsquo;,
    # 目前测试结果，发现Input::AMQP无法接收到非topic的exchange
    # CPAN上有关RabbitMQ的模块都是这个哥们写的，POD简略到没有一样，表示无语下
    #            exchange_type =&gt; &lsquo;direct&rsquo;,
                hostname =&gt; $self-&gt;rabbitmq,
                username =&gt; &lsquo;guest&rsquo;,
                password =&gt; &lsquo;guest&rsquo;,
            );
            output debug =&gt; (
                class =&gt; &lsquo;STDOUT&rsquo;,
            );
            encoder(&ldquo;encoder&rdquo;,
                class =&gt; &lsquo;JSON&rsquo;,
                output_to =&gt; &lsquo;rabbitmq&rsquo;,
                output_to =&gt; &lsquo;debug&rsquo;,
            );
            filter grok =&gt; (
                class =&gt; &lsquo;GrokLike&rsquo;,
                output_to =&gt; &lsquo;encoder&rsquo;,
            );
            filter logstash =&gt; (
                class =&gt; &lsquo;ToLogstash&rsquo;,
                output_to =&gt; &lsquo;grok&rsquo;,
            );
            decoder(&ldquo;decoder&rdquo;,
                class =&gt; &lsquo;JSON&rsquo;,
                output_to =&gt; &lsquo;logstash&rsquo;,
            );
            input nginxlog =&gt; (
                class =&gt; &lsquo;FileTail&rsquo;,
                output_to =&gt; &lsquo;decoder&rsquo;,
                filename =&gt; $self-&gt;filename,
           );
        };
    }
    <strong>PACKAGE</strong>-&gt;start unless caller;
    1;
{% endhighlight %}
目前就做到这步，之后从rabbitmq里往elasticsearch写的还没搞。从上面的chain可以很清除的看到和logstash一样的管道思想，input-&gt;decoder-&gt;filter-&gt;encoder-&gt;output。巧的是两种写法中，decode/encode那个写法跟puppet的DSL定义特别的像。哈哈～</p>
      <a href="/2012/09/16/message-passing-agent" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/09/16/elasticsearch-bulk-index-speed-testing" title="【Message::Passing系列】ElasticSearch的bulk_index速度测试" rel="bookmark">【Message::Passing系列】ElasticSearch的bulk_index速度测试</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-16 00:00:00 +0800">16 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>连续尝试了logstash的elasticsearch/elasticsearch_http/elasticsearch_river三个putput模块，发现其index/bulk/river三种插入方式的实际运行效果速度居然没有差异。而使用perl脚本测试，单例下index不到300msg/sec，bulk接近2500msg/sec，几乎翻了10倍。</p>
      <a href="/2012/09/16/elasticsearch-bulk-index-speed-testing" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/09/06/intro-rex" title="(R)?ex介绍" rel="bookmark">(R)?ex介绍</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-06 00:00:00 +0800">06 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>按说这文章好像轮不到我写。几个线上运用着的哥们都不出手，我勉强记录一些<a href="http://rexify.org/">官网</a>上没写example但实际应该蛮常用的功能吧：</p>
      <a href="/2012/09/06/intro-rex" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/08/26/translate-using-elasticsearch-for-logs" title="【翻译】用ElasticSearch存储日志" rel="bookmark">【翻译】用ElasticSearch存储日志</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-08-26 00:00:00 +0800">26 Aug 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <h1 id="section">介绍</h1>
      <a href="/2012/08/26/translate-using-elasticsearch-for-logs" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/08/23/systemtap-probe-nginx-http-header-parse-line" title="用systemtap定位nginx1.2在header解析时的报错" rel="bookmark">用systemtap定位nginx1.2在header解析时的报错</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-08-23 00:00:00 +0800">23 Aug 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一个url请求，在经过代理层访问应用层后，会报502错误。检查发现应用层是Nginx0.7.64+Resin3的结构，代理层是Nginx1.2。直接访问Nginx0.7.64是没问题的，访问Nginx1.2就会返回&rdquo;upstream sent invalid header while reading response header from upstream&rdquo;。</p>
      <a href="/2012/08/23/systemtap-probe-nginx-http-header-parse-line" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/08/20/coro-async-pool-demo" title="Coro::Semaphore和async_pool示例" rel="bookmark">Coro::Semaphore和async_pool示例</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-08-20 00:00:00 +0800">20 Aug 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#testing-ref" title="testing" rel="category tag">testing</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前有一个<a href="http://chenlinux.com/2012/07/19/anyevent-fork-http-load-runner-demo/">AnyEvent和Fork写的http压测工具</a>，评论里有大神教导说用Coro控制并发更有效更方便。于是改写了下面的版本。从被压测的nginx server上，可以看到ESTABLISHED的数量确实大大增加，“”并发”两个字算是做到了。</p>
      <a href="/2012/08/20/coro-async-pool-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/07/30/plack-middleware-demo" title="一个Plack::Middleware的实例" rel="bookmark">一个Plack::Middleware的实例</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-30 00:00:00 +0800">30 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>做一个文件上传的网页，想稍微华丽一点，显示进度条出来。在Apache和Catalyst下都有现成的模块，不过Dancer上还没有。看了一下代码，Dancer::Request里没有像Catalyst那样暴露prepare_body_chunk方法。所以需要在plack上利用psgi.input来做。尽量重用现有代码，所以progress.css和progress.js都直接从Catalyst/Plugin/UploadProgress/example/Upload/root/static/里复制。
{% highlight perl %}
package Plack::Middleware::UploadProgress;
use strict;
use CHI;
use Carp;
use HTTP::Body;
use Plack::Request;
use Plack::TempBuffer;
use parent qw(Plack::Middleware);</p>
      <a href="/2012/07/30/plack-middleware-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/07/30/dancer-plugin-demo" title="一个Dancer::Plugin的实例" rel="bookmark">一个Dancer::Plugin的实例</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-30 00:00:00 +0800">30 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>公司内部工具统一使用passport认证登录，于是写这么一个小plugin，用来给dancer做的网站使用统一认证。
passport的原理很简单，将原先的页面url带入session转到passport的login，然后由passport通过user/password或者kerberos确认是否正确，并返回一个ticket参数，然后拿这个ticket再到passport的verify上校验一次username，正确的话写入session即可。代码如下：
{% highlight perl %}
package Dancer::Plugin::Auth::Passport;
use Dancer &lsquo;:syntax&rsquo;;
use Dancer::Plugin;
use Furl; 
use warnings;
use strict;</p>
      <a href="/2012/07/30/dancer-plugin-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/07/19/anyevent-fork-http-load-runner-demo" title="用AnyEvent和ForkManager写一个http协议的压测工具" rel="bookmark">用AnyEvent和ForkManager写一个http协议的压测工具</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-19 00:00:00 +0800">19 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#testing-ref" title="testing" rel="category tag">testing</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>话不多说，先上第一版的代码：
{% highlight perl %}
use Time::HiRes qw/time/;
use AnyEvent::HTTP;
use AnyEvent;
use Coro;</p>
      <a href="/2012/07/19/anyevent-fork-http-load-runner-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/07/07/intro-ipc-locker" title="IPC::Locker模块介绍" rel="bookmark">IPC::Locker模块介绍</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-07 00:00:00 +0800">07 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>当你需要给一个集群的某项服务做简单的排他性管理的时候，强力推荐Veripool公司的一系列模块：IPC::Locker、Schedule::Load。</p>
      <a href="/2012/07/07/intro-ipc-locker" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/07/02/anyevent-httpd-demo" title="AnyEvent::HTTPD和AnyEvent::HTTP使用实例" rel="bookmark">AnyEvent::HTTPD和AnyEvent::HTTP使用实例</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-02 00:00:00 +0800">02 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>很简单的一个实例，就是开一个端口接受url请求，然后向squid提交这个url的刷新。
{% highlight perl %}
use AnyEvent::HTTPD;
use AnyEvent::HTTP;</p>
      <a href="/2012/07/02/anyevent-httpd-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/06/29/coro-intro" title="【翻译】Coro::Intro文档" rel="bookmark">【翻译】Coro::Intro文档</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-29 00:00:00 +0800">29 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>
</div>
      <a href="/2012/06/29/coro-intro" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/06/14/intro-stf" title="STF介绍" rel="bookmark">STF介绍</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-14 00:00:00 +0800">14 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>STF项目，全称&rdquo;<a href="http://en.wikipedia.org/wiki/Professional_wrestling_holds#STF">Stepover Toehold Facelock</a>&ldquo;，原因是项目发起人喜欢这个动作，我勒个去……当然作者也给它找了个靠谱一点的解释，叫STorage Farm。</p>
      <a href="/2012/06/14/intro-stf" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/06/13/use-redis-and-grok-pattern-for-logstash" title="【Logstash系列】使用Redis并自定义Grok匹配" rel="bookmark">【Logstash系列】使用Redis并自定义Grok匹配</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-13 00:00:00 +0800">13 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前提到，用RabbitMQ作为消息队列。但是这个东西实在太过高精尖，不懂erlang不会调优的情况下，很容易挂掉——基本上我这里试验结果跑不了半小时日志传输就断了。所以改用简单易行的redis来干这个活。</p>
      <a href="/2012/06/13/use-redis-and-grok-pattern-for-logstash" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/06/10/install-mogilefs" title="MogileFS安装" rel="bookmark">MogileFS安装</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-10 00:00:00 +0800">10 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>纯属凑数的更新，写写安装过程而已。没有调优，没有测评，嗯……</p>
      <a href="/2012/06/10/install-mogilefs" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/06/08/intro-trafficserver-ssd-branch-in-taobao" title="淘宝TrafficServer的SSD分支测试与介绍" rel="bookmark">淘宝TrafficServer的SSD分支测试与介绍</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-08 00:00:00 +0800">08 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>同事介绍说淘宝有关于trafficserver的一个分支支持SSD的。下来试试。<a href="http://gitorious.org/trafficserver/taobao/commits/tbtrunk_ssd">下载地址</a></p>
      <a href="/2012/06/08/intro-trafficserver-ssd-branch-in-taobao" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/06/08/create-python-module-for-ganglia" title="用ganglia监控trafficserver" rel="bookmark">用ganglia监控trafficserver</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-08 00:00:00 +0800">08 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>trafficserver提供了几种很不错的性能监控方式。首先是一个模仿cisco的shell工具./bin/traffic_shell——这个工具可以set变量，也可以show变量，另一个是类似squidclient的./bin/traffic_line工具——这个工具同样可以set和show变量，不过这里变量更接近源代码函数名的样子，相当于调用API了。此外还有Perl和Web的其他方式……</p>
      <a href="/2012/06/08/create-python-module-for-ganglia" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2012/06/01/dist-logstash-and-elasticsearch" title="【Logstash系列】用rabbitmq和elasticsearch搭建分布式日志收集存储系统" rel="bookmark">【Logstash系列】用rabbitmq和elasticsearch搭建分布式日志收集存储系统</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-01 00:00:00 +0800">01 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上上篇讲到怎样用MRI的ruby在客户端收集日志。今天主要注意服务器端，考虑grok、elastic、web这几个功能在JRuby上才好。所以服务器端可以再开一个JRuby的进程。</p>
      <a href="/2012/06/01/dist-logstash-and-elasticsearch" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page4">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page active">
      <a href="#">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li class="page">
      <a href="/page17">17</a>
    </li>
    <li>
      <a href="/page6">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
              <li><a href="http://showmetheco.de/" title="Viacheslav Tykhanovskyi(PocketIO/Text::Haml)">No time to wait</a></li>
              <li><a href="http://blog.dataloop.io/" title="A new SaaS monitoring tool for DevOps & Operations">Dataloop.IO</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://planeteria.org/perl6/" title="Perl6 文集">Planet Perl 6</a></li>
              <li><a href="http://www.metaforsoftware.com/blog/" title="">metafor</a></li>
              <li><a href="http://blog.kablamo.org/" title="Eric Johnson，一个游走在伦敦和北京的 Perler">kablamo</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.lark.net.cn/" title="王剑">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://junqili.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://blog.l8ii.com/" title="刘侨">LairdNote</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="booklists" class="nav nav-list">
          <li class="nav-header">我写的第一本技术书籍</li>
          <li><a href='http://product.china-pub.com/3769604'><img src='http://images.china-pub.com/ebook3765001-3770000/3769604/shupi.jpg' border='0' alt='网站运维技术与实践'/></a></li>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
