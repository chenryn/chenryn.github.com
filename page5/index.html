<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/05/31/use-ruby-1.8-for-logstash-agent" title="【Logstash系列】使用原版Ruby1.8运行logstash的客户端程序" rel="bookmark">【Logstash系列】使用原版Ruby1.8运行logstash的客户端程序</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-05-31 00:00:00 +0800">31 May 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在一般情况下，我们实验logstash都是直接用官网上下载的jar包，然后java运行即可。但如果在大规模场景下，这样其实并不是运维的最佳实践：</p>
<ol>
  <li>并不是所有设备都默认或者很方便的可以安装java；</li>
  <li>默认使用的JRuby执行效率比MRI的版本低一些，为了大规模运维管理，一般部署puppet的时候附加yum/apt获取的是Ruby1.8.7。</li>
</ol>
<p>花了一点时间了解了一下代码结构，发现这点其实是可以做到的。从github上clone代码，在其中的example、bin和lib目录中都看到大量对应官网文档的input/filter/output的东东。</p>
<p>根据我对logstash的了解，仅保留input的file、syslog和remote_luby，filter里的grok，output里的elasticsearch和rabbitmq。然后看lib/logstash/*的具体模块，只有三个模块提到了必须使用java后台。</p>
<p>于是第一步，修改Gemile，只留下必备的模块。
第二步，通过bundle管理工具加载安装。
第三步，通过命令行方式指定配置变量和参数。
第四步，把所属包打包发送到其他设备测试。</p>
<p>现在保留的Gemfile如下：</p>
<div class="highlight"><pre><code class="ruby"><span class="n">source</span> <span class="ss">:rubygems</span>
<span class="n">gem</span> <span class="s2">&quot;cabin&quot;</span><span class="p">,</span> <span class="s2">&quot;0.4.4&quot;</span> <span class="c1"># for logging. apache 2 license</span>
<span class="n">gem</span> <span class="s2">&quot;bunny&quot;</span> <span class="c1"># for amqp support, MIT-style license</span>
<span class="n">gem</span> <span class="s2">&quot;uuidtools&quot;</span> <span class="c1"># for naming amqp queues, License ???</span>
<span class="n">gem</span> <span class="s2">&quot;filewatch&quot;</span><span class="p">,</span> <span class="s2">&quot;0.3.3&quot;</span>  <span class="c1"># for file tailing, BSD License</span>
<span class="n">gem</span> <span class="s2">&quot;jls-grok&quot;</span><span class="p">,</span> <span class="s2">&quot;0.10.6&quot;</span> <span class="c1"># for grok filter, BSD License</span>
<span class="n">gem</span> <span class="s2">&quot;json</span>
<span class="s2">gem &quot;</span><span class="n">mail</span><span class="s2">&quot;</span>
<span class="s2">gem &quot;</span><span class="n">minitest</span><span class="s2">&quot; # License: Ruby</span>
<span class="s2">gem &quot;</span><span class="n">statsd</span><span class="o">-</span><span class="n">ruby</span><span class="s2">&quot;, &quot;</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">0</span><span class="s2">&quot; # outputs/statsd, # License: As-Is</span>
<span class="s2">group :test do</span>
<span class="s2">  gem &quot;</span><span class="n">mocha</span><span class="s2">&quot;</span>
<span class="s2">  gem &quot;</span><span class="n">shoulda</span><span class="s2">&quot;</span>
<span class="s2">end</span>
</code></pre></div>
<p>然后客户端的运行，这里有点小问题，默认要求必须大于Ruby1.9.2的版本才行。但是通读一遍，发现其实只是用到了Ruby1.9.2里一个全局变量RUBY_ENGINE来判断自己是不是JRuby，这个对等判断很容易修改成为RUBY_DESCRIPTION变量的正则匹配判断。之后就OK了。</p>
<p>具体替换代码如下：</p>
<div class="highlight"><pre><code class="ruby"><span class="c1"># if RUBY_ENGINE == &#39;JRuby&#39; </span>
  <span class="k">if</span> <span class="no">RUBY_DESCRIPTION</span> <span class="o">=~</span> <span class="n">m</span><span class="o">/^</span><span class="no">Ruby</span><span class="o">/</span>
</code></pre></div>
<p>最后把挑好的lib/*.rb和bin/logstash、etc/logstash打包发送到其他设备。运行也没问题。写上不同的server和agent.conf启动起来一看，果然就传输过去了。
目前就到这步，随后随时更新</p>
      <a href="/2012/05/31/use-ruby-1.8-for-logstash-agent" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/05/25/nginx-auth-by-perl-and-lua" title="用perl和lua在nginx中验证url" rel="bookmark">用perl和lua在nginx中验证url</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-05-25 00:00:00 +0800">25 May 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>和三年前的博客一样，还是时间加密钥加路径的加密方式。不过这次改用nginx，这样不用重新缓存后面的squid文件了。
先用ngx_lua做：</p>
<div class="highlight"><pre><code class="nginx">    <span class="k">set</span> <span class="nv">$expire</span> <span class="s">&quot;600&quot;</span><span class="p">;</span>
    <span class="k">set</span> <span class="nv">$salt</span> <span class="s">&quot;mysalt&quot;</span><span class="p">;</span>
    <span class="k">location</span> <span class="p">~</span><span class="sr">*</span> <span class="s">\.mp3</span>$ <span class="p">{</span>
<span class="c1">#local m = ngx.re.match(ngx.var.uri,&quot;^/([0-9]{4})/([0-9]{2})/([0-9]{2})/([0-9]{2})/([0-9]{2})/([0-9a-z]{32})(/.*)&quot;)</span>
<span class="c1">#用ngx.re.match就不能%d,用string.match就不能{2}，郁闷</span>
<span class="c1">#而且ngx.re.match所有的捕获都在m数组里，这点类似perl的m//返回。</span>
        <span class="kn">rewrite_by_lua</span> <span class="s">&#39;</span>
        <span class="s">local</span> <span class="s">date</span> <span class="p">=</span> <span class="p">{}</span>
        <span class="kn">local</span> <span class="s">md5str</span>
        <span class="s">local</span> <span class="s">path</span>
        <span class="s">date.year,date.month,date.day,date.hour,date.min,md5str,path</span> <span class="p">=</span> <span class="s">string.match(ngx.var.uri,&quot;^/(%d+)/(%d+)/(%d+)/(%d+)/(%d+)/(%w+)(/%S+)&quot;)</span>
        <span class="s">if</span> <span class="s">date.year</span> <span class="p">==</span> <span class="s">nil</span> <span class="s">then</span>
             <span class="s">ngx.exit(404)</span>
        <span class="s">end</span>
        <span class="s">local</span> <span class="s">time1</span> <span class="p">=</span> <span class="s">tonumber(os.time(date))</span>
        <span class="s">local</span> <span class="s">time2</span> <span class="p">=</span> <span class="s">tonumber(ngx.time())</span>
        <span class="s">if</span> <span class="s">md5str</span> <span class="p">==</span> <span class="s">ngx.md5(ngx.var.salt..date.year..date.month..date.day..date.hour..date.min..path)</span> <span class="s">then</span>
            <span class="s">if</span> <span class="s">time2</span> <span class="s">-</span> <span class="s">time1</span> <span class="s">&lt;</span> <span class="s">tonumber(ngx.var.expire)</span> <span class="s">then</span>
                <span class="s">ngx.req.set_uri(path)</span>
            <span class="s">else</span>
                <span class="s">ngx.exit(405)</span>
            <span class="s">end</span>
        <span class="s">else</span>
            <span class="s">ngx.exit(403)</span>
        <span class="s">end</span>
        <span class="s">&#39;</span><span class="p">;</span>  
        <span class="kn">proxy_pass</span>         <span class="s">http://backend</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span>   <span class="s">Host</span>     <span class="nv">$host</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>然后用nginx_perl做：</p>
<div class="highlight"><pre><code class="nginx">    <span class="k">perl_require</span> <span class="s">POSIX.pm</span><span class="p">;</span>
    <span class="k">perl_require</span> <span class="s">Digest/MD5.pm</span><span class="p">;</span>
    <span class="k">perl_set</span> <span class="nv">$realurl</span> <span class="s">&#39;</span>
    <span class="s">sub</span> <span class="p">{</span>
        <span class="kn">my</span> <span class="nv">$secret</span> <span class="p">=</span> <span class="s">&quot;mysalt&quot;</span><span class="p">;</span>
        <span class="kn">my</span> <span class="nv">$expire</span> <span class="p">=</span> <span class="mi">600</span><span class="p">;</span>
        <span class="kn">my</span> <span class="nv">$r</span> <span class="p">=</span> <span class="s">shift</span><span class="p">;</span>
        <span class="kn">if</span> <span class="s">(</span> <span class="nv">$r-&gt;uri</span> <span class="p">=~</span> <span class="sr">m#^/(\d</span><span class="p">{</span><span class="kn">4})/(\d{2})/(\d{2})/(\d{2})/(\d{2})/(\w{32})(/\S+\.mp3)</span><span class="c1">#oi ) {</span>
            <span class="s">my</span> <span class="s">(</span><span class="nv">$year,</span> <span class="nv">$mon,</span> <span class="nv">$mday,</span> <span class="nv">$hour,</span> <span class="nv">$min,</span> <span class="nv">$md5,</span> <span class="nv">$path</span><span class="s">)</span> <span class="p">=</span> <span class="s">(</span><span class="nv">$1,</span> <span class="nv">$2,</span> <span class="nv">$3,</span> <span class="nv">$4,</span> <span class="nv">$5,</span> <span class="nv">$6,</span> <span class="nv">$7</span><span class="s">)</span><span class="p">;</span>
            <span class="kn">my</span> <span class="nv">$str</span> <span class="p">=</span> <span class="s">Digest::MD5::md5_hex(</span><span class="nv">$secret</span> <span class="s">.</span> <span class="nv">$year</span> <span class="s">.</span> <span class="nv">$mon</span> <span class="s">.</span> <span class="nv">$mday</span> <span class="s">.</span> <span class="nv">$hour</span> <span class="s">.</span> <span class="nv">$min</span> <span class="s">.</span> <span class="nv">$path</span><span class="s">)</span><span class="p">;</span>
            <span class="kn">my</span> <span class="nv">$reqtime</span> <span class="p">=</span> <span class="s">POSIX::mktime(00,</span> <span class="nv">$min,</span> <span class="nv">$hour,</span> <span class="nv">$mday,</span> <span class="nv">$mon</span> <span class="s">-</span> <span class="mi">1</span><span class="s">,</span> <span class="nv">$year</span> <span class="s">-</span> <span class="mi">1900</span><span class="s">)</span><span class="p">;</span>
            <span class="kn">my</span> <span class="nv">$now</span> <span class="p">=</span> <span class="s">time</span><span class="p">;</span>
            <span class="kn">if</span> <span class="s">(</span> <span class="nv">$str</span> <span class="s">eq</span> <span class="nv">$md5</span> <span class="s">and</span> <span class="nv">$now</span> <span class="s">-</span> <span class="nv">$reqtime</span> <span class="s">&lt;</span> <span class="nv">$expire</span> <span class="s">)</span> <span class="p">{</span>
                    <span class="kn">return</span> <span class="nv">$path</span><span class="p">;</span>
            <span class="p">}</span> <span class="kn">else</span> <span class="p">{</span>
                <span class="kn">return</span> <span class="s">&quot;error&quot;</span><span class="p">;</span>
            <span class="p">}</span>;
        <span class="p">}</span> <span class="kn">else</span> <span class="p">{</span>
            <span class="kn">return</span> <span class="s">&quot;error&quot;</span><span class="p">;</span>
        <span class="p">}</span>;
    <span class="p">}</span><span class="k">&#39;</span><span class="p">;</span>
  <span class="k">server</span> <span class="p">{</span> 
    <span class="kn">location</span> <span class="p">~</span><span class="sr">*</span> <span class="s">\.mp3</span>$ <span class="p">{</span>
                <span class="kn">if</span> <span class="s">(</span><span class="nv">$realurl</span> <span class="p">=</span> <span class="s">&quot;error&quot;)</span> <span class="p">{</span> <span class="kn">return</span> <span class="mi">403</span><span class="p">;</span> <span class="p">}</span>
                <span class="kn">proxy_pass</span>         <span class="s">http://music_store_local</span><span class="nv">$realurl</span><span class="p">;</span>
                <span class="kn">proxy_set_header</span>   <span class="s">Host</span>             <span class="nv">$host</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div>
<p>然后用http_load测试单url响应情况，基本效率一样。在压力比较大(lo上跑大概200MB/s，再大就可能出错了)的情况下，第一字节响应时间大概比直接请求squid多一个数量级（从0.4ms到4ms）  <br />
这个情况下，squid的cpu%在130％，nginx_perl的worker是25％，nginx_lua的是19％。</p>
      <a href="/2012/05/25/nginx-auth-by-perl-and-lua" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/05/22/puppet-reports-analysis-by-web" title="【puppet系列】网页展示puppet的客户端报告" rel="bookmark">【puppet系列】网页展示puppet的客户端报告</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-05-22 00:00:00 +0800">22 May 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上篇说到怎样使用ENC脚本控制puppet的客户端配置，这篇说如何监控和展示客户端运行状态报告。</p>
<p>目前还是使用puppet默认的store方式，也就是报告都存在/var/lib/puppet/reports/$host/$dates.yaml里。所以分析只要针对这个目录下的文件即可，主要使用File::Stat和File::Find两个模块搞定。注意这两个模块在Perl5.16里是默认内核模块了~~</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">autodie</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Stat</span> <span class="sx">qw/:stat/</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">YAML::</span><span class="n">Syck</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">AnyEvent::Filesys::</span><span class="n">Notify</span><span class="p">;</span>
<span class="k">use</span> <span class="n">EV</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$interval</span> <span class="o">=</span> <span class="s">&quot;60&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$watch_dir</span> <span class="o">=</span> <span class="s">&quot;/var/lib/puppet/reports&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$periodic</span> <span class="o">=</span> <span class="nn">EV::</span><span class="n">periodic</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$interval</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$dirs</span> <span class="o">=</span> <span class="n">watchdir</span><span class="p">(</span><span class="nv">$interval</span><span class="p">);</span>
    <span class="n">process</span><span class="p">(</span> <span class="nv">$_</span><span class="p">,</span> <span class="s">&#39;No reports return.&#39;</span> <span class="p">)</span> <span class="k">for</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$dirs</span><span class="p">};</span>
<span class="p">};</span>
<span class="k">my</span> <span class="nv">$notifier</span> <span class="o">=</span> <span class="nn">AnyEvent::Filesys::</span><span class="n">Notify</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
    <span class="n">dirs</span>     <span class="o">=&gt;</span> <span class="p">[</span> <span class="nv">$watch_dir</span><span class="p">,</span> <span class="p">],</span>
    <span class="n">interval</span> <span class="o">=&gt;</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">filter</span>   <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="nb">shift</span> <span class="o">=~</span><span class="sr"> /\.yaml$/</span> <span class="p">},</span>
    <span class="n">cb</span>       <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">@events</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@events</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=~</span> <span class="sr">m/^(created|modified)$/</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">;</span>
                <span class="k">my</span> <span class="nv">$logs</span> <span class="o">=</span> <span class="n">LoadFile</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;logs&#39;</span><span class="p">};</span>
                <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$logs</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;level&#39;</span><span class="p">}</span> <span class="ow">eq</span> <span class="s">&#39;err&#39;</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="n">process</span><span class="p">(</span> <span class="nv">$file</span><span class="p">,</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;message&#39;</span><span class="p">}</span> <span class="p">);</span>
                    <span class="p">};</span>
                <span class="p">};</span>
            <span class="p">};</span>
        <span class="p">};</span>
    <span class="p">},</span>
<span class="p">);</span>
<span class="nn">EV::</span><span class="n">loop</span><span class="p">();</span>
<span class="k">sub </span><span class="nf">process</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$path</span><span class="p">,</span> <span class="nv">$message</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$path</span> <span class="o">=~</span> <span class="sr">m/\/([^\/]+\.opi\.com)/</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">print</span> <span class="nv">$1</span><span class="p">,</span><span class="s">&quot; has err: &quot;</span><span class="p">,</span><span class="nv">$message</span><span class="p">,</span><span class="s">&quot;\n&quot;</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">watchdir</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$interval</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$dirs</span> <span class="o">=</span> <span class="nb">grep</span> <span class="p">{</span> <span class="nb">time</span> <span class="o">-</span> <span class="nb">stat</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nv">$interval</span> <span class="p">}</span> <span class="nb">glob</span><span class="p">(</span><span class="s">&quot;${watch_dir}/*&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$dirs</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>上面这个脚本，通过libev的timer和io分别完成对diretory的mtime的遍历和对file的inotify的监听。process作为公共处理函数，可以随意改造成sms/email/msn等等方式。  <br />
定时器没有用AnyEvent的封装，因为没看到AE有periodic，只有timer。而在io运行的时候，timer是中断的。如果不停有文件inotify发生，timer就没法进行了……periodic的方式与timer不同，是绝对定时而不是相对定时——虽然我个人的浅薄理解觉得应该也被io阻塞，但试验结果是OK的。</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">autodie</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Dancer</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Template</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">YAML::</span><span class="n">Syck</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Find</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Stat</span> <span class="sx">qw/:stat/</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw/strftime/</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Data::Section::</span><span class="n">Simple</span> <span class="sx">qw/get_data_section/</span><span class="p">;</span>
<span class="n">set</span> <span class="n">port</span>   <span class="o">=&gt;</span> <span class="s">&quot;8080&quot;</span><span class="p">;</span>
<span class="n">set</span> <span class="n">daemon</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">set</span> <span class="n">logger</span> <span class="o">=&gt;</span> <span class="s">&#39;console&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$tt</span> <span class="o">=</span> <span class="n">Template</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
<span class="c1">#                       DEBUG =&gt; &#39;all&#39;,</span>
                      <span class="p">);</span>
<span class="k">my</span> <span class="nv">$ds_check</span> <span class="o">=</span> <span class="n">get_data_section</span><span class="p">(</span><span class="s">&#39;check.tt&#39;</span><span class="p">);</span>
<span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$html</span> <span class="o">=</span> <span class="s">&#39;&lt;form action=&quot;/ppcheck&quot;&gt;&#39;</span><span class="p">;</span>
    <span class="nv">$html</span> <span class="o">.=</span> <span class="s">&#39;Write an interval minutes for reports timestamp check: &#39;</span><span class="p">;</span>
    <span class="nv">$html</span> <span class="o">.=</span> <span class="s">&#39;&lt;input type=&quot;text&quot; name=&quot;interval&quot;/&gt; &lt;input type=&quot;submit&quot; value=&quot;submit&quot; /&gt;&#39;</span><span class="p">;</span>
    <span class="nv">$html</span> <span class="o">.=</span> <span class="s">&#39;&lt;/form&gt;&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$html</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">get</span> <span class="s">&#39;/ppcheck&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$interval</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;interval&#39;</span><span class="p">}</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">||</span> <span class="mi">300</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$watch_dir</span> <span class="o">=</span> <span class="s">&quot;/var/lib/puppet/reports&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="s">&quot;Too large number&quot;</span> <span class="k">if</span> <span class="nv">$interval</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">;</span>   <span class="c1"># one day</span>
    <span class="k">my</span> <span class="nv">$context</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nv">$context</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;dirs&#39;</span><span class="p">}</span> <span class="o">=</span> <span class="n">watch_timeout</span><span class="p">(</span> <span class="nv">$interval</span><span class="p">,</span> <span class="nv">$watch_dir</span> <span class="p">);</span>
    <span class="nv">$context</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;logs&#39;</span><span class="p">}</span> <span class="o">=</span> <span class="n">watch_errlogs</span><span class="p">(</span> <span class="nv">$interval</span><span class="p">,</span> <span class="nv">$watch_dir</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$output</span><span class="p">;</span>
    <span class="nv">$tt</span><span class="o">-&gt;</span><span class="n">process</span><span class="p">(</span><span class="o">\</span><span class="nv">$ds_check</span><span class="p">,</span> <span class="nv">$context</span><span class="p">,</span> <span class="o">\</span><span class="nv">$output</span><span class="p">);</span>
<span class="c1">#    $tt-&gt;process(\*DATA, $context, \$output);</span>
<span class="c1">#    seek *DATA, 1234, 0;</span>
    <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">watch_timeout</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$interval</span><span class="p">,</span> <span class="nv">$watch_dir</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@dirs</span> <span class="o">=</span> <span class="nb">grep</span> <span class="p">{</span> <span class="nb">time</span> <span class="o">-</span> <span class="nb">stat</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nv">$interval</span> <span class="p">}</span> <span class="nb">glob</span><span class="p">(</span><span class="s">&quot;${watch_dir}/*&quot;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">@ret</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nv">@dirs</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$dirtime</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%F %T&quot;</span><span class="p">,</span> <span class="nb">localtime</span><span class="p">(</span><span class="nb">stat</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">9</span><span class="p">]));</span>
        <span class="k">my</span> <span class="nv">$dirname</span> <span class="o">=</span> <span class="nv">$1</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">=~</span> <span class="n">s</span><span class="c1">#([^/]+\.opi\.com)#$1#;</span>
        <span class="nb">push</span> <span class="nv">@ret</span><span class="p">,</span> <span class="p">{</span><span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">$dirname</span><span class="p">,</span> <span class="nb">time</span> <span class="o">=&gt;</span> <span class="nv">$dirtime</span><span class="p">,</span> <span class="p">};</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="o">\</span><span class="nv">@ret</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">watch_errlogs</span> <span class="p">{</span>
    <span class="k">my</span><span class="p">(</span> <span class="nv">$interval</span><span class="p">,</span> <span class="nv">$watch_dir</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span><span class="p">(</span> <span class="nv">$wanted</span><span class="p">,</span> <span class="nv">$list_reporter</span> <span class="p">)</span> <span class="o">=</span> <span class="n">find_file_by_mtime</span><span class="p">(</span><span class="nv">$interval</span><span class="p">);</span>
    <span class="nn">File::Find::</span><span class="n">find</span><span class="p">(</span> <span class="nv">$wanted</span><span class="p">,</span> <span class="nv">$watch_dir</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">@ret</span> <span class="o">=</span> <span class="nv">$list_reporter</span><span class="o">-&gt;</span><span class="p">();</span>
    <span class="k">return</span> <span class="o">\</span><span class="nv">@ret</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">find_file_by_mtime</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$interval</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@found</span> <span class="o">=</span> <span class="p">();</span>
    <span class="k">my</span> <span class="nv">$finder</span> <span class="o">=</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">-</span><span class="n">f</span> <span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">name</span> <span class="o">&amp;&amp;</span> <span class="nb">time</span> <span class="o">-</span> <span class="nb">stat</span><span class="p">(</span><span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">name</span><span class="p">)</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nv">$interval</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$yaml</span> <span class="o">=</span> <span class="nn">YAML::Syck::</span><span class="n">LoadFile</span><span class="p">(</span><span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">name</span><span class="p">);</span>
            <span class="k">my</span> <span class="nv">@logs</span> <span class="o">=</span> <span class="nb">grep</span> <span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;level&#39;</span><span class="p">}</span> <span class="ow">eq</span> <span class="s">&#39;err&#39;</span> <span class="p">}</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$yaml</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;logs&#39;</span><span class="p">}};</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nv">@logs</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nb">push</span> <span class="nv">@found</span><span class="p">,</span> <span class="p">{</span> <span class="n">host</span> <span class="o">=&gt;</span> <span class="nv">$yaml</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;host&#39;</span><span class="p">},</span> <span class="n">message</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;message&#39;</span><span class="p">},</span> <span class="p">};</span>
            <span class="p">};</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="k">my</span> <span class="nv">$reporter</span> <span class="o">=</span> <span class="k">sub </span><span class="p">{</span> <span class="nv">@found</span> <span class="p">};</span>
    <span class="k">return</span><span class="p">(</span> <span class="nv">$finder</span><span class="p">,</span> <span class="nv">$reporter</span> <span class="p">);</span>
<span class="p">};</span>
<span class="n">dance</span><span class="p">;</span>
<span class="bp">__DATA__</span>
<span class="nv">@@</span> <span class="nv">check</span><span class="o">.</span><span class="n">tt</span>
<span class="o">&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;timeoutdirs&quot;</span><span class="o">&gt;</span>
<span class="n">List</span> <span class="n">of</span> <span class="n">nodes</span> <span class="n">whose</span> <span class="n">report</span> <span class="n">is</span> <span class="n">timeout:</span> <span class="o">&lt;</span><span class="n">br</span> <span class="o">/&gt;</span>
<span class="sr">&lt;ul&gt;</span>
<span class="p">[</span><span class="nv">%</span> <span class="nv">FOREACH</span> <span class="n">dir</span> <span class="n">IN</span> <span class="n">dirs</span> <span class="nv">%</span><span class="err">]</span>
<span class="err">&lt;</span><span class="nv">li</span> <span class="n">style</span><span class="o">=</span><span class="s">&quot;width:200px;float:left&quot;</span><span class="o">&gt;</span><span class="p">[</span><span class="nv">%</span> <span class="nv">dir</span><span class="o">.</span><span class="n">name</span> <span class="nv">%</span><span class="err">]&lt;/</span><span class="nv">li</span><span class="o">&gt;&lt;</span><span class="n">li</span> <span class="n">style</span><span class="o">=</span><span class="s">&quot;width:200px;margin:0;float:left&quot;</span><span class="o">&gt;</span><span class="p">[</span><span class="nv">%</span> <span class="nv">dir</span><span class="o">.</span><span class="nb">time</span> <span class="nv">%</span><span class="err">]&lt;/</span><span class="nv">li</span><span class="o">&gt;</span>
<span class="p">[</span><span class="nv">%</span> <span class="nv">END</span> <span class="nv">%</span><span class="err">]</span>
<span class="err">&lt;/</span><span class="nv">ul</span><span class="o">&gt;</span>
<span class="sr">&lt;/div&gt;</span>
<span class="o">&lt;</span><span class="n">br</span> <span class="sr">/&gt;&lt;hr /</span><span class="o">&gt;&lt;</span><span class="n">br</span> <span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;runerrlogs&quot;</span><span class="o">&gt;</span>
<span class="n">Error</span> <span class="n">messages</span> <span class="n">of</span> <span class="n">running</span> <span class="n">nodes:</span> <span class="o">&lt;</span><span class="n">br</span> <span class="o">/&gt;</span>
<span class="sr">&lt;ul&gt;</span>
<span class="p">[</span><span class="nv">%</span> <span class="nv">FOREACH</span> <span class="nb">log</span> <span class="n">IN</span> <span class="n">logs</span> <span class="nv">%</span><span class="err">]</span>
<span class="err">&lt;</span><span class="nv">li</span> <span class="n">style</span><span class="o">=</span><span class="s">&quot;width:200px;float:left&quot;</span><span class="o">&gt;</span><span class="p">[</span><span class="nv">%</span> <span class="nv">log</span><span class="o">.</span><span class="n">host</span> <span class="nv">%</span><span class="err">]&lt;/</span><span class="nv">li</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">li</span> <span class="n">style</span><span class="o">=</span><span class="s">&quot;width:400px;margin:0;float:left&quot;</span><span class="o">&gt;</span><span class="p">[</span><span class="nv">%</span> <span class="nv">log</span><span class="o">.</span><span class="n">message</span> <span class="nv">%</span><span class="err">]&lt;/</span><span class="nv">li</span><span class="o">&gt;</span>
<span class="p">[</span><span class="nv">%</span> <span class="nv">END</span> <span class="nv">%</span><span class="err">]</span>
<span class="err">&lt;/</span><span class="nv">ul</span><span class="o">&gt;</span>
<span class="sr">&lt;/div&gt;</span>
</code></pre></div>
<p>这个脚本实现的功能其实和上面那个类似。不过报警改成web页面，event触发改成web请求触发。  <br />
这里两个新难点：</p>
<p>其一是没有inotify后如何根据web请求参数查找范围内新建的报表。File::Find模块只有一个函数find(\&amp;wanted,@dirs)。其中&amp;wanted是不能传参进去的。  <br />
在CPAN上看到一个叫做File::Find::Closures的模块，提供了一系列可以给File::Find使用的&amp;wanted函数，包括一个示例。于是稍微改造一下，就写成了find_file_by_mtime()函数。</p>
<p>其二是因为偷懒没有用dancer建立完整项目，使用了perl virtual file来提供template。所以不能直接使用Dancer的template &lsquo;ttname&rsquo;, {var=&gt;$var};定义了。  <br />
Template::Toolkit提供的process()可以操作的template来源很多，可以是字符串／文件／句柄。所以process(*DATA)也是生效的。但是问题出现了：这样启动后，第一次访问正常；第二次访问返回空！  <br />
打开Template的DEBUG看到，第二次访问的时候，从*DATA里读不到数据了。也就是说，必须重新seek回去——而且试验证明seek的起始点是shebang行。。。。  <br />
所以只能先从__DATA__里读出数据，然后以字符串形式传递给process()了。    </p>
<p>这里用到了Data::Section模块。从CloudForecast项目里学来的。CloudForecast中的web页面，使用的Text::Xslate模板技术读取__DATA__。其中包括有index／server／servers／service等页面。也就是说，在一个__DATA__里实现了多个virtual file。用的就是Data::Section::Simple模块。以@@为标签分割即可。</p>
      <a href="/2012/05/22/puppet-reports-analysis-by-web" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/05/18/puppet-external-nodes-classifier" title="【puppet系列】puppet使用ENC定义节点" rel="bookmark">【puppet系列】puppet使用ENC定义节点</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-05-18 00:00:00 +0800">18 May 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>今天研究puppet dashboard。主要有ENC和reports两个功能。其中ENC功能相当扯淡，因为你在web上点击添加的class/node/group，是没有任何依赖性检查(比如node命名是否符合fqdn，class是否存在)的，随便咋填绝无报错和拒绝！而且也没有提供类似report的导入工具，一旦启用就要完全重新手工输入所有配置……所以无论是从导入角度还是管理角度，自己实现一个靠谱点的ENC都是有必要的。    </p>
<p>关于puppet的ENC配置，参见<a href="http://docs.puppetlabs.com/guides/external_nodes.html">ENC的文档</a>    </p>
<p>主要就是修改puppet.conf里两个配置：    </p>
<ul>
  <li><code>node_terminus</code>，由plain修改成exec；</li>
  <li><code>external_nodes</code>，由none修改为ENC脚本的路径。    </li>
</ul>
<p>类似如下：</p>
<pre><code>[master]    
node_terminus = exec    
external_nodes = /etc/puppet/webui/external_nodes    
</code></pre>
<p>脚本输入输出的说明：    </p>
<pre><code>Its only argument is the name of the node to be classified, and it returns a YAML document describing the node.
</code></pre>
<p>注意到此为止配置修改不算结束！文档中提到，puppet是支持同时开启ENC和site.pp配置的。puppet会自动merge两个配置。但是debug运行时可以看到，这个merge是按照node级别进行的。也就是说：    </p>
<ol>
  <li>puppet master收到一个node的请求，如果 <code>node_terminus</code> 配置为exec，输出node的fqdn给 <code>external_nodes</code>；    </li>
  <li>收到 <code>external_nodes</code> 的返回，为一个yaml体或者空；    </li>
  <li>加载site.pp，这是按照文本顺序进行的。如果都是import &ldquo;module&rdquo;，那么最后就进入module的parameter和template处理。    </li>
  <li>如果已经存在，检查是全局变量还是类，全局变量的话报错，类的话覆盖为site.pp中最后定义的类。  <br />
<strong>2013年4月10日更新：感谢<a href="http://weibo.com/liucy1983">@liu.cy</a>指出这里变量和类的区别</strong></li>
</ol>
<p>所以为了方便起见，请删除掉site.pp中的<code>import "node/*.pp"</code> 这行配置。我在这里就被郁闷了很久。</p>
<p>然后是我这里的想法是尽量不更改pp的语法，只是提供一个把group里的ip到fqdn的转化然后查找cluster配置组合成yaml。  <br />
也就是说有一个group的配置目录，其配置文件为&rdquo;groupname.pp&rdquo;，内容如下：</p>
<div class="highlight"><pre><code class="ruby"><span class="n">group</span> <span class="s2">&quot;groupname&quot;</span> <span class="p">{</span>
    <span class="vg">$string</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
    <span class="vg">$arrays</span> <span class="o">=</span> <span class="o">[</span><span class="mi">123</span><span class="p">,</span> <span class="n">abc</span><span class="o">]</span>
    <span class="kp">include</span> <span class="n">module1</span><span class="p">,</span> <span class="n">module2</span>
<span class="p">}</span>
</code></pre></div>
<p>还有一个iplist的配置目录，其配置文件为“groupname.iplist”，内容如下：</p>
<div class="highlight"><pre><code class="squid"><span class="mf">1.2.3.4</span><span class="w"></span>
<span class="mf">2.3.4.5</span><span class="w"></span>
</code></pre></div>
<p>那么以后服务器组有啥变更，只需要修改一下iplist就好了，不用重启puppet进程。    </p>
<p>所以有两个脚本，一个是 <code>external_node</code> 脚本：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/bin/env perl</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">autodie</span><span class="p">;</span>
<span class="k">use</span> <span class="n">DBI</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">YAML::</span><span class="n">Syck</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$base_dir</span> <span class="o">=</span> <span class="s">&quot;/etc/puppet/webui&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="k">my</span> <span class="nv">$group</span> <span class="o">=</span> <span class="n">sqlite_select</span><span class="p">(</span><span class="nv">$node</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$hash</span> <span class="o">=</span> <span class="n">pp2hashref</span><span class="p">(</span><span class="nv">$group</span><span class="p">);</span>
<span class="k">print</span> <span class="n">Dump</span><span class="p">(</span><span class="nv">$hash</span><span class="p">);</span>
<span class="c1"># ENC要求退出值必须为0 </span>
<span class="nb">exit</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">pp2hashref</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$group</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&quot;${base_dir}/group/${group}.pp&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$i</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="sr">&lt;$fh&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="sr"> /^#|^\s*$|}$/</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">next</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr"> /^group\s+&quot;(\w+)&quot;/</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nb">die</span> <span class="s">&quot;group name do not match,check please!&quot;</span> <span class="k">unless</span> <span class="nv">$1</span> <span class="o">=~</span> <span class="sr">m/$group/i</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr"> /^\s*?\$(\w+)\s*=\s*&quot;(.+)&quot;$/</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;parameters&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$1&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr"> /^\s*?include\s+(.+)$/</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;classes&quot;</span><span class="p">}}</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/,\s*/</span><span class="p">,</span> <span class="nv">$1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr"> /^\s*\$(\w+)\s*=\s*\[([^]]+)]?/</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$i</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
            <span class="nb">grep</span> <span class="p">{</span> <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;parameters&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$i&quot;</span><span class="p">}},</span> <span class="nv">$_</span> <span class="p">}</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/,\s*/</span><span class="p">,</span> <span class="nv">$2</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr"> /^\s*([^]]+)]?/</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nb">grep</span> <span class="p">{</span> <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;parameters&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$i&quot;</span><span class="p">}},</span> <span class="nv">$_</span> <span class="p">}</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/,\s*/</span><span class="p">,</span> <span class="nv">$1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">next</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;parameters&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;clustername&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$group</span><span class="p">;</span>
    <span class="c1"># ENC要求输出的yaml中必须提供environment参数 </span>
    <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;environment&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;production&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">sqlite_select</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$node</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$dbh</span> <span class="o">=</span> <span class="n">DBI</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span><span class="s">&quot;dbi:SQLite:dbname=${base_dir}/node_info.db&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,{</span><span class="n">RaiseError</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span><span class="n">AutoCommit</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">});</span>
    <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&quot;select node_group from node_info where node_fqdn = ?&quot;</span><span class="p">);</span>
    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;$node&quot;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;node_group&quot;</span><span class="p">};</span>
    <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">();</span>
    <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>一个是维护sqlite的脚本：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/bin/env perl</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">autodie</span><span class="p">;</span>
<span class="k">use</span> <span class="n">DBI</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Net::</span><span class="n">Nslookup</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$base_dir</span> <span class="o">=</span> <span class="s">&quot;/etc/puppet/webui&quot;</span><span class="p">;</span>
<span class="n">sqlite_update</span><span class="p">();</span>
<span class="k">sub </span><span class="nf">ip_conv</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="n">nslookup</span><span class="p">(</span><span class="n">host</span> <span class="o">=&gt;</span> <span class="s">&quot;$ip&quot;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=&gt;</span> <span class="s">&quot;PTR&quot;</span><span class="p">);</span>
    <span class="c1"># ENC的输入参数为全小写格式，所以sqlite中也必须存储小写格式的主机名 </span>
    <span class="k">return</span> <span class="nb">lc</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">sqlite_rebuild</span> <span class="p">{</span>
    <span class="c1"># 配置系统变动不大，且puppet本身还有一层也是用sqlite的node配置缓存层，</span>
    <span class="c1"># 所以这里不用复杂的select判断再update或者insert，直接重建sqlite </span>
    <span class="nb">unlink</span> <span class="s">&quot;${base_dir}/node_info.db&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$dbh</span> <span class="o">=</span> <span class="n">DBI</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span><span class="s">&quot;dbi:SQLite:dbname=${base_dir}/node_info.db&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,{</span><span class="n">RaiseError</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span><span class="n">AutoCommit</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">});</span>
    <span class="k">my</span> <span class="nv">$sql</span> <span class="o">=</span> <span class="s">&#39;create table node_info (node_fqdn, node_group)&#39;</span><span class="p">;</span>
    <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="k">do</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
    <span class="c1"># sqlite支持简单事务，所以要即时提交 </span>
    <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">();</span>
    <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&#39;replace into node_info values(?,?)&#39;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">@groups</span> <span class="o">=</span> <span class="nb">grep</span> <span class="p">{</span> <span class="sr">s/^${base_dir}\/iplist\/(\w+?).list$/$1/</span> <span class="p">}</span> <span class="nb">glob</span><span class="p">(</span><span class="s">&quot;${base_dir}/iplist/*&quot;</span><span class="p">);</span>
    <span class="k">print</span> <span class="nv">$_</span><span class="p">,</span><span class="s">&quot;\n&quot;</span> <span class="k">for</span> <span class="nv">@groups</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span> <span class="nv">@groups</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$group</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
        <span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&quot;${base_dir}/iplist/${group}.list&quot;</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$fh&gt;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$fqdn</span> <span class="o">=</span> <span class="n">ip_conv</span><span class="p">(</span><span class="nv">$_</span><span class="p">);</span>
            <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;$fqdn&quot;</span><span class="p">,</span> <span class="s">&quot;$group&quot;</span><span class="p">);</span>
            <span class="nb">die</span> <span class="nv">$</span><span class="nn">DBI::</span><span class="nv">errstr</span> <span class="k">if</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">();</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">();</span>
    <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div>
<p>以上是ENC的配置。继续分析puppet dashboard，除了ENC外，另一个功能就是reports，相比ENC来说，reports功能还算稍微靠谱一点，用http方式替换puppet自身的store方式，并存数据在mysql里。目前使用dashboard的人主要也就是在用这个功能。  <br />
但是我个人认为，一般情况下运维不可能专门开一个页面看着puppet，也不太会有必要按照时间段查看状态报表汇总图这个东东，真正要紧的，是及时接到运行错误的报警以便上机处理。所以这里最后是一个监控reports的脚本，目前还没看到http方式的reports数据格式，所以暂时继续使用store的方式，然后采用Linux文件系统的inotify方式报警。</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!env perl</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">YAML::</span><span class="n">Syck</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">AnyEvent::Filesys::</span><span class="n">Notify</span><span class="p">;</span>
<span class="k">use</span> <span class="n">EV</span><span class="p">;</span>
<span class="c1"># 使用AE的这个扩展而不直接用Linux::Inotify2模块，方便万一之后迁移到BSD主机</span>
<span class="c1"># 而且异步回调的方式性能更好，在压力较大时不会阻塞丢失事件 </span>
<span class="k">my</span> <span class="nv">$notifier</span> <span class="o">=</span> <span class="nn">AnyEvent::Filesys::</span><span class="n">Notify</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
    <span class="n">dirs</span>     <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(/var/lib/puppet/reports)</span><span class="p">],</span>
    <span class="n">interval</span> <span class="o">=&gt;</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="c1"># 在puppetd请求的时候，会在目录下先生成临时文件，完成后再mv成正式的，所以要过滤</span>
    <span class="n">filter</span>   <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="nb">shift</span> <span class="o">=~</span><span class="sr"> /\.yaml$/</span> <span class="p">},</span>
    <span class="n">cb</span>       <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@_</span> <span class="p">)</span> <span class="p">{</span>
            <span class="c1"># 一般这里会是两个type，创建的created和修改的modified，因为文件名只精确到分钟，如果两次运行在一分钟内，文件名就一样</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="n">type</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">;</span>
                <span class="k">my</span> <span class="nv">$logs</span> <span class="o">=</span> <span class="n">LoadFile</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;logs&#39;</span><span class="p">};</span>
                <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$logs</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;level&#39;</span><span class="p">}</span> <span class="ow">eq</span> <span class="s">&#39;err&#39;</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="n">process</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;message&#39;</span><span class="p">});</span>
                    <span class="p">};</span>
                <span class="p">};</span>
            <span class="p">};</span>
        <span class="p">};</span>
    <span class="p">},</span>
<span class="p">);</span>
<span class="nn">EV::</span><span class="n">loop</span><span class="p">();</span>
<span class="k">sub </span><span class="nf">process</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$path</span><span class="p">,</span> <span class="nv">$message</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$path</span> <span class="o">=~</span> <span class="sr">m/\/([^\/]+)\/\d{12}\.yaml$/</span> <span class="p">)</span> <span class="p">{</span>
        <span class="c1"># 这里用nagios还是email方式处理都可以，代码略</span>
        <span class="k">print</span> <span class="nv">$1</span><span class="p">,</span><span class="s">&quot; has err: &quot;</span><span class="p">,</span><span class="nv">$message</span><span class="p">,</span><span class="s">&quot;\n&quot;</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
      <a href="/2012/05/18/puppet-external-nodes-classifier" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/05/10/quick-start-for-puppet-facter-erb" title="【puppet系列】puppet安装／Facter插件和puppet模板编写" rel="bookmark">【puppet系列】puppet安装／Facter插件和puppet模板编写</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-05-10 00:00:00 +0800">10 May 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>使用puppet管理集群配置是个很靠谱的做法。跟其他同类产品相比，第一他的DSL语法很丰富够灵活，第二围绕他的生态圈活跃，资料比较多。</p>
<h1 id="puppet">puppet安装</h1>
<p>由于关注热度比较高，所以各种简便安装办法都出来了。大家可以各自选择，走yum、apt或者src都行。我这里演示一下用rubygems的办法。优点是不用像yum那样找epel源，而且版本够新，缺点是没有yum自动出来的配置目录和管理脚本。</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/usr/bin/env bash</span>
<span class="c"># Set Curlrc for https</span>
<span class="nb">echo</span> <span class="s1">&#39;insecure&#39;</span> &gt;&gt; ~/.curlrc
<span class="c"># Install git</span>
curl -L get-git.rvm.io | sudo bash
<span class="c"># Install RVM</span>
curl -L get.rvm.io | sudo bash -s stable
<span class="c"># Install Last Ruby</span>
<span class="nb">source</span> <span class="s2">&quot;/usr/local/rvm/scripts/rvm&quot;</span>
rvm install 1.9.3
<span class="c"># Use GEM Mirror in Taobao</span>
gem sources -r http://rubygems.org/
gem sources -a http://rubygems.taobao.org/
<span class="c"># Install puppet</span>
gem install puppet --no-ri --no-rdoc
groupadd puppet
useradd -g puppet -s /bin/false -M puppet
<span class="c"># Get default puppet config</span>
mkdir /etc/puppet
puppet --genconfig &gt; /etc/puppet/puppet.conf
</code></pre></div>
<p>需要说明一点，puppet对集群的识别高度依赖fdqn，所以必须保证主机名和IP的一一对应。我的环境里因为本身kerberos认证也是fdqn依赖的，所以反而省事不少，其他环境中，估计折腾dns或者hosts也是个大步骤。    </p>
<h1 id="facter">facter简介</h1>
<p>在安装puppet的时候，会顺带安装好facter工具，这个工具是用来探测本机各类变量，提供给puppetd使用的。    </p>
<p>因为facter也是ruby写的。所以我们可以自己根据其规则书写补充工具获取更多的变量，方便之后定制模块和类资源。</p>
<h1 id="puppetca">puppetca认证</h1>
<p>安装完成后需要建立认证关系。puppet没有像其他通用系统一样借用sshkey的认证，而是自己维护了一套，所以有这么个单独的章节：    </p>
<p>首先是客户端上的申请，没有单独的命令，就跟一次正常请求一样即可：    </p>
<div class="highlight"><pre><code class="bash">    puppetd --test --server master.pp.domain.com    
</code></pre></div>
<p>注意：因为puppet2.7和ruby1.9.2以上版本在ssl上的冲突，所以新版本ruby的client需要多几步处理：    </p>
<div class="highlight"><pre><code class="bash">scp master.puppet.domain.com:/etc/puppet/ssl/certs/ca.pem /etc/puppet/ssl/certs/
<span class="nb">hash</span><span class="o">=</span><span class="sb">`</span>openssl x509 -hash -noout -in /etc/puppet/ssl/certs/ca.pem<span class="sb">`</span>
ln -s /etc/puppet/ssl/certs/ca.pem /etc/pki/tls/certs/<span class="k">${</span><span class="nv">hash</span><span class="k">}</span>.0
</code></pre></div>
<p>这样才能正常申请cert。    </p>
<p>然后在主控端上审批。首先可以puppetca &ndash;list查看有多少请求过来的client是未认证的。然后运行如下命令通过：    </p>
<div class="highlight"><pre><code class="bash">    puppetca -s -a    
</code></pre></div>
<p>(吐槽一下，内网上已经有这么多认证了，还搞一套pp的，还搞出问题来了，有够无聊的，强烈希望pp提供一个开关)</p>
<h1 id="sitepp">site.pp简介</h1>
<p>/etc/puppet/manifests/site.pp是puppetmaster的总入口。在这里主要完成几个工作：加载模块(import &ldquo;module&rdquo;)；加载节点配置(node {})。    </p>
<p>模块的名字，就是直接来自于/etc/puppet/modules/dir_name的命名；而node里include包含的class类名，则是modules/dir_name/manifests/init.pp中写的名字。    </p>
<p>一般来说，这两个可以保持一致方便管理。但是规则毕竟如此，碰到不一致的还是要懂（我就是碰上不一致的样例才研究的）。    </p>
<p>node配置太多的话，可以另外写在别的目录和配置文件里。在site.pp中只要<code>include 'nodes/*.pp'</code>这样就可以了。</p>
<p>node配置主要三个部分：    </p>
<ol>
  <li>node的fdqn的正则匹配；    </li>
  <li>node的变量赋值；    </li>
  <li>node的特定类；    </li>
</ol>
<p>比如下面这个例子：</p>
<div class="highlight"><pre><code class="ruby"><span class="n">node</span> <span class="s2">&quot;cache[0-9]\.domain\.com&quot;</span> <span class="p">{</span>
  <span class="vg">$var</span> <span class="o">=</span> <span class="s2">&quot;strings&quot;</span>
  <span class="vg">$array</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="o">]</span>
  <span class="kp">include</span> <span class="n">facter</span> <span class="n">squid</span>
<span class="p">}</span>
</code></pre></div>
<h1 id="modules">modules简介</h1>
<p>模块中一定有manifests/init.pp作为入口，然后根据其中的定义，另外有templates和files作为辅助目录。    </p>
<p>init.pp中可以使用require &lsquo;other.pp&rsquo;指令来加载模块的其他配置。    </p>
<p>init.pp中可以使用puppet的各种资源，包括file、service、exec、package、cron、user等等。    </p>
<p>各种资源下有各种属性和方法可用，这里就不展开讲了，一来我也没掌握多少，二来真写全了够出书了。主要写关于file的几个，因为linux的本质就是All is file嘛~    </p>
<ol>
  <li>content:直接在puppet配置里写file的内容，一般只会在测试的时候这么直接用。更多的是用template(&lsquo;class/class.template.erb&rsquo;)的方式调用模板文件。    </li>
  <li>source:直接下载puppetmaster上的原始文件，具体url写法是puppet:///module/file。    </li>
  <li>notify:在客户端搞定file的写入后准备触发的下一个操作，一般用来重启服务(可以用service方法，也可以用exec方法)等等。    </li>
  <li>ensure:file的状态。比如absent是如果已存在的就删除掉；present是如果不存在就新建；directory是目录；latest是最新的包版本等等。    </li>
  <li>path:file在客户端的真是存放路径。如果没有定义，就是用name配置。    </li>
  <li>mode:file在客户端的权限，也就是644,755之类的。</li>
</ol>
<h1 id="template">template简介</h1>
<p>puppet用的erb模板引擎，也是RoR中用的模板引擎。看起来和Perl5中的Template::Toolkit相当的一样。尤其是&lt;%%&gt;里使用=和-的表现。    </p>
<p>我们可以在puppet里用erb完成比puppet语法复杂的多的功能，比如根据node的变量进行运算、循环、判断等等。    </p>
<h1 id="squid">squid示例</h1>
<p>最后举例今天完成的一个简单的squid的配置。</p>
<p>首先是/etc/puppet/manifests/site.pp：    </p>
<div class="highlight"><pre><code class="ruby"><span class="n">import</span> <span class="s2">&quot;squid&quot;</span>
<span class="n">node</span> <span class="s2">&quot;cache[0-9]\.domain\.com&quot;</span> <span class="p">{</span>
  <span class="vg">$cache_peers</span> <span class="o">=</span> <span class="o">[</span> <span class="s1">&#39;1.2.3.4&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3.5&#39;</span><span class="o">]</span>
  <span class="vg">$http_port</span> <span class="o">=</span> <span class="s2">&quot;8080&quot;</span>
  <span class="vg">$fs_type</span> <span class="o">=</span> <span class="s2">&quot;aufs&quot;</span>
<span class="c1">#  单独区分coss，是因为squid源码被修改过后，关于COSS的配置跟磁盘都是特制的，不能像原版那样计算了 </span>
<span class="c1">#  $fs_type = &quot;coss&quot;</span>
<span class="c1">#  $coss_options = &quot;/data/coss/stripe0 32 backstore=/data/coss/stripe4,32 max-size=1024768 block-size=1024&quot;</span>
  <span class="kp">include</span> <span class="n">facter</span> <span class="n">squid</span>
<span class="p">}</span>
</code></pre></div>
<p>然后是/etc/puppet/modules/facter/manifests/init.pp:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="n">facter</span> <span class="p">{</span>
    <span class="n">file</span> <span class="p">{</span> <span class="s2">&quot;df.rb&quot;</span><span class="p">:</span>
        <span class="n">path</span>   <span class="o">=&gt;</span> <span class="s2">&quot;/usr/lib/ruby/gems/1.8/gems/facter-1.6.8/lib/facter/df.rb&quot;</span><span class="p">,</span>
        <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">file</span><span class="p">,</span>
        <span class="n">mode</span>   <span class="o">=&gt;</span> <span class="mi">644</span><span class="p">,</span>
        <span class="n">source</span> <span class="o">=&gt;</span> <span class="s2">&quot;puppet:///modules/facter/df.rb&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>关于给facter写插件，网站的资料说的path都是直接在#{rubysitedir}/facter目录下。但我这里实际情况却不是(好吧，暴露了我的实验机并没有按照上面说的用rvm安装ruby而是yum的)。  <br />
<strong>2013年1月31日更正：</strong>
更优的做法应该是放在<code>#{puppetdir}/modules/yourmodule/lib/facter/</code>下，然后作为pluginsync发下去。
<strong>更正以上</strong></p>
<p>然后是对应的/etc/puppet/modules/facter/files/df.rb:</p>
<div class="highlight"><pre><code class="ruby"><span class="n">data_dir_list</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">df</span> <span class="o">=</span> <span class="ss">Facter</span><span class="p">:</span><span class="ss">:Util</span><span class="o">::</span><span class="no">Resolution</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="s2">&quot;/bin/df -m 2&gt;/dev/null&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">each_line</span> <span class="k">do</span> <span class="o">|</span><span class="n">l</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">l</span> <span class="o">=~</span> <span class="sr">/^\/dev\/\w+\s+(\d+).+\/(data\d*)$/</span>
    <span class="n">data_dir_list</span><span class="o">[</span><span class="vg">$2</span><span class="o">]</span> <span class="o">=</span> <span class="vg">$1</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="no">Facter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;DataDirCount&quot;</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">setcode</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">data_dir_list</span><span class="o">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span>
      <span class="n">data_dir_list</span><span class="o">.</span><span class="n">length</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">data_dir_list</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span>
  <span class="no">Facter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;DirSize_</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">setcode</span> <span class="k">do</span>
      <span class="n">v</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>实现很简单，实质就是执行df -m，获取挂载点为/data、/data1&hellip;的目录数以及各目录的总大小，然后把结果添加到facter里。之所以要加这么个插件，是因为之后squid的缓存目录，需要根据目录数量和大小自动计算，而标准的facter里没有这方面的信息，无法传递相关变量。    </p>
<p>下面正式进入squid模块部分。看/etc/puppet/modules/squid/manifests/init.pp:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="n">squid</span> <span class="p">{</span>
    <span class="n">service</span> <span class="p">{</span> <span class="s2">&quot;squid&quot;</span><span class="p">:</span>
        <span class="k">ensure</span>    <span class="o">=&gt;</span> <span class="n">running</span><span class="p">,</span>
        <span class="n">subscribe</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s2">&quot;squid.conf&quot;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">file</span> <span class="p">{</span> <span class="s2">&quot;squid.conf&quot;</span><span class="p">:</span>
        <span class="n">path</span>    <span class="o">=&gt;</span> <span class="s2">&quot;/tmp/squid.conf&quot;</span><span class="p">,</span>
        <span class="n">notify</span>  <span class="o">=&gt;</span> <span class="no">Service</span><span class="o">[</span><span class="s2">&quot;squid&quot;</span><span class="o">]</span><span class="p">,</span>
        <span class="n">content</span> <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="s2">&quot;squid/squid.conf.erb&quot;</span><span class="p">),</span>
        <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>这里只写了service和file两个，实际上还应该有package保证client上确实有squid软件，有file保证/etc/init.d/squid脚本存在等等。注意其中file里的notify和service里的subscribe正好是对应的意思。    </p>
<p>最后是/etc/puppet/squid/template/squid.conf.erb:</p>
<div class="highlight"><pre><code class="squid">&lt;%<span class="w"> </span>if<span class="w"> </span>(fs_type<span class="w"> </span>==<span class="w"> </span>&#39;aufs&#39;)<span class="w"> </span>-%&gt;<span class="w"></span>
<span class="k">cache_dir</span><span class="w"> </span>aufs<span class="w"> </span>/data/fcache<span class="w"> </span>&lt;%=<span class="w"> </span>Integer(dirsize_data.to_i*0.8)<span class="w"> </span>%&gt;<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">256</span><span class="w"></span>
&lt;%<span class="w"> </span>if<span class="w"> </span>(datadircount.to_i<span class="w"> </span>&gt;<span class="w"> </span><span class="m">1</span>)<span class="w"> </span>-%&gt;<span class="w"></span>
&lt;%<span class="w"> </span><span class="m">1</span>.upto(datadircount.to_i<span class="w"> </span>-<span class="w"> </span><span class="m">1</span>).each<span class="w"> </span>do<span class="w"> </span>|i|<span class="w"> </span>-%&gt;<span class="w"></span>
&lt;%<span class="w"> </span>size<span class="w"> </span>=<span class="w"> </span>eval<span class="w"> </span>&quot;dirsize_data#{i}&quot;<span class="w"> </span>-%&gt;<span class="w"></span>
<span class="k">cache_dir</span><span class="w"> </span>aufs<span class="w"> </span>/data&lt;%=<span class="w"> </span>i<span class="w"> </span>%&gt;/fcache<span class="w"> </span>&lt;%=<span class="w"> </span>Integer(size.to_i*0.8)<span class="w"> </span>%&gt;<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">256</span><span class="w"></span>
&lt;%<span class="w"> </span>end<span class="w"> </span>-%&gt;<span class="w"></span>
&lt;%<span class="w"> </span>end<span class="w"> </span>-%&gt;<span class="w"></span>
&lt;%<span class="w"> </span>else<span class="w"> </span>%&gt;<span class="w"></span>
<span class="k">cache_dir</span><span class="w"> </span>coss<span class="w"> </span>&lt;%=<span class="w"> </span>coss_options<span class="w"> </span>%&gt;<span class="w"></span>
&lt;%<span class="w"> </span>end<span class="w"> </span>%&gt;<span class="w"></span>
<span class="k">cache_mem</span><span class="w"> </span>&lt;%=<span class="w"> </span>Integer(memorysize.to_i<span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.45<span class="w"> </span>*<span class="w"> </span><span class="m">1024</span>)<span class="w"> </span>%&gt;<span class="w"> </span>MB<span class="w"></span>
<span class="k">visible_hostname</span><span class="w"> </span>&lt;%=<span class="w"> </span>fqdn<span class="w"> </span>%&gt;<span class="w"></span>
<span class="k">http_port</span><span class="w"> </span>&lt;%=<span class="w"> </span><span class="k">http_port</span><span class="w"> </span>%&gt;<span class="w"> </span>vhost<span class="w"></span>
&lt;%<span class="w"> </span>cache_peers.each<span class="w"> </span>do<span class="w"> </span>|peer|<span class="w"> </span>-%&gt;<span class="w"></span>
<span class="k">cache_peer</span><span class="w"> </span>&lt;%=<span class="w"> </span>peer<span class="w"> </span>%&gt;<span class="w"> </span><span class="no">parent</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="no">no-query</span><span class="w"> </span>originserver<span class="w"> </span><span class="no">round-robin</span><span class="w"></span>
&lt;%<span class="w"> </span>end<span class="w"> </span>%&gt;<span class="w"></span>
</code></pre></div>
<p>这里只贴跟模板变量相关的部分。初学ruby，被to_i方法搞得很是郁闷，还好像eval方法之类的很像很眼熟~~  <br />
模板里cache_peers等，是在node配置里定义的；memorysize等，是facter获取的。</p>
      <a href="/2012/05/10/quick-start-for-puppet-facter-erb" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/05/08/collect-log-variables-by-ngx-lua" title="通过lua统计nginx内部变量数据" rel="bookmark">通过lua统计nginx内部变量数据</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-05-08 00:00:00 +0800">08 May 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>统计nginx的请求数据，一般有几个办法，一个是logrotate，通过access.log计算，这个很详细，但是实时性差一些；一个是Tengine提供的pipe，这个实时性更好，但是管道如果出现堵塞，麻烦就多了～这两种办法，归根结底都是把日志记录在本地(pipe方式如果要长期保留依然要记磁盘)然后由脚本完成计算。今天这里说另一种方法：在nginx内部，随着每次请求完成一些基础的数据统计，然后输出到存储里供长期调用。  <br />
代码如下：</p>
<div class="highlight"><pre><code class="nginx"><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">photo.domain.com</span><span class="p">;</span>
    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">set</span> <span class="nv">$str</span> <span class="nv">$uri</span><span class="p">;</span>
        <span class="kn">content_by_lua</span> <span class="s">&#39;</span>
            <span class="s">local</span> <span class="s">url</span> <span class="p">=</span> <span class="s">ngx.var.uri</span>
            <span class="s">local</span> <span class="s">res</span> <span class="p">=</span> <span class="s">ngx.location.capture(&quot;/proxy&quot;,</span> <span class="p">{</span><span class="kn">vars</span> <span class="p">=</span> <span class="p">{</span> <span class="kn">str</span> <span class="p">=</span> <span class="s">url</span> <span class="err">}}</span><span class="s">)</span>
            <span class="s">ngx.print(res.body)</span>
            <span class="s">ngx.shared.log_dict:set(&quot;url&quot;,</span> <span class="s">url)</span>
            <span class="s">local</span> <span class="s">upstream_stat</span> <span class="p">=</span> <span class="s">ngx.var.status</span>
            <span class="s">local</span> <span class="s">upstream_time</span> <span class="p">=</span> <span class="s">tonumber(ngx.var.upstream_response_time)</span>
            <span class="s">local</span> <span class="s">redis</span> <span class="p">=</span> <span class="s">require</span> <span class="s">&quot;resty.redis&quot;</span>
            <span class="s">local</span> <span class="s">red</span> <span class="p">=</span> <span class="s">redis:new()</span>
            <span class="s">local</span> <span class="s">ok,</span> <span class="s">err</span> <span class="p">=</span> <span class="s">red:connect(&quot;127.0.0.1&quot;,</span> <span class="mi">6379</span><span class="s">)</span>
            <span class="s">if</span> <span class="s">upstream_stat</span> <span class="p">~</span><span class="sr">=</span> <span class="s">&quot;200&quot;</span> <span class="s">then</span>
                <span class="s">red:sadd(&quot;url&quot;,url)</span>
                <span class="s">red:incr(url)</span>
                <span class="s">red:incr(url..&quot;:time&quot;,</span> <span class="s">upstream_time)</span>
            <span class="s">end</span>
         <span class="s">&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="s">/dict_status</span> <span class="p">{</span>
        <span class="kn">content_by_lua</span> <span class="s">&#39;</span>
            <span class="s">local</span> <span class="s">url</span> <span class="p">=</span> <span class="s">ngx.shared.log_dict:get(&quot;url&quot;)</span>
            <span class="s">ngx.say(url)</span>
         <span class="s">&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="s">/redis_status</span> <span class="p">{</span>
        <span class="kn">content_by_lua</span> <span class="s">&#39;</span>
            <span class="s">local</span> <span class="s">redis</span> <span class="p">=</span> <span class="s">require</span> <span class="s">&quot;resty.redis&quot;</span>
            <span class="s">local</span> <span class="s">red</span> <span class="p">=</span> <span class="s">redis:new()</span>
            <span class="s">local</span> <span class="s">ok,err</span> <span class="p">=</span> <span class="s">red:connect(&quot;127.0.0.1&quot;,</span> <span class="mi">6379</span><span class="s">)</span>
            <span class="s">local</span> <span class="s">urlist,err</span> <span class="p">=</span> <span class="s">red:sort(&quot;url&quot;,&quot;limit&quot;,&quot;0&quot;,&quot;1&quot;,&quot;desc&quot;,&quot;by&quot;,&quot;*&quot;)</span>
            <span class="s">if</span> <span class="s">not</span> <span class="s">urlist</span> <span class="s">then</span>
                <span class="s">ngx.say(err)</span>
                <span class="s">return</span>
            <span class="s">end</span>
            <span class="s">for</span> <span class="s">i</span> <span class="p">=</span> <span class="mi">1</span><span class="s">,</span> <span class="c1">#urlist do</span>
                <span class="s">local</span> <span class="s">avg</span> <span class="p">=</span> <span class="s">red:get(urlist[i])</span>
                <span class="s">local</span> <span class="s">sum</span> <span class="p">=</span> <span class="s">red:get(urlist[i]..&quot;:time&quot;)</span>
                <span class="s">ngx.say(urlist[i],&quot;\tavg_time:&quot;,avg/sum,</span> <span class="s">&quot;\tsum:&quot;,sum)</span>
            <span class="s">end</span>
         <span class="s">&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="s">/proxy</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span> <span class="s">http://backend_fmn_xnimg_cn</span><span class="nv">$str</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="s">&#39;fmn.rrimg.com&#39;</span><span class="p">;</span> 
        <span class="kn">include</span> <span class="s">conf.d/proxy.conf</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>ngx_lua里的指令有set/rewrite/header_filter/log/content/access_by_lua等，它们各自处于nginx处理流程中的某一步，所以有些日志变量可能不一定都能读取到。还有header_filter和log两个不能调用subrequest和output的API(也就是只能使用上例代码中的ngx.shared.DICT方式，但只支持简单的key-value),content不能和proxy_pass在一起等等……</p>
<p>不过content里可以调用ngx.location.capture()来subrequest其他location，比如这里利用/proxy来完成原来的proxy_pass的功能。  <br />
因为subrequest后$uri有变化，所以pass必须写对真正的url的全路径。这就靠之前的set $str来传递变量了。    </p>
<p>最终运行结果：</p>
<pre><code># curl http://fmn.rrimg.cn/redis_status    
/test avg_time:0.73 sum:12
</code></pre>
      <a href="/2012/05/08/collect-log-variables-by-ngx-lua" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/04/30/reading-notes-about-linux-system" title="Linux系统调优读书笔记" rel="bookmark">Linux系统调优读书笔记</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-04-30 00:00:00 +0800">30 Apr 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>今天在图书馆看书，摘抄一些有意思的细节。</p>
<h1 id="linux">Linux服务器性能调整</h1>
<p>Linux内存布局NUMA：  <br />
    非一致性读取 每个节点；  <br />
    每个节点下有 多个管理区(ZONE)内存块；  <br />
    内存块包括：  <br />
        ZONE_DMA 0~16MB  <br />
        ZONE_NORMAL 16~896MB
        ZONE_HIGHMEM 896MB~结束  <br />
    32位处理器下，用户空间3GB，内核空间1GB；  <br />
        内核空间除去ZONE_DMA和ZONE_NORMAL后只剩下128MB用来vmalloc/kmap等操作；  <br />
        kmap操作用来虚拟化页表数据位，可以在32位处理器下支持64GB内存。 <br />
    NUMA结构下8节点的互连结构，只是3个相互最近的互连；  <br />
    不同节点之间的定时器很难一致，通常选一个做唯一定时。    </p>
<p>多处理SMP：  <br />
    松耦合系统：每个处理器都有自己的总线、内存和IO系统；  <br />
    紧耦合系统：只运行一个OS；  <br />
      对称系统均分任务；  <br />
      非对称系统有一个主控处理器；  <br />
        cache是否共享？内存、总线和IO子系统肯定是共享的，cache会带来一致性问题；  <br />
        锁竞争导致的开销，所以N个处理器不能达到N倍效率提升；  <br />
        affinity即绑定进程到CPU，让进程跟cache更近。  <br />
          linux里进程是高权的线程（一般说法是反过来说线程是小型的进程）    </p>
<p>集群cluster：  <br />
    高性能：分布式任务并行处理，100+节点，通称为计算机；  <br />
    高可用：故障问题，最多16节点，通常2~4节点，通称为企业服务器。    </p>
<p>系统跟踪前提：  <br />
    容量足够；开销较小；场景可重现；尽量无其他进程干扰除非是场景本身需要。    </p>
<p>strace命令场景：  <br />
    判断IO阻塞，内存分配及其频率等。    </p>
<p>OProfile：
    opcontrol命令：设置的count要足够大，否则中断本身次数会影响结果。</p>
<p>内核调度器：  <br />
    优先级0~MAX_PRIO(140)；  <br />
    0~100为实时任务；  <br />
    101~140为分时任务，即nice命令调整的-20~19。    </p>
<p>I/O调度器：  <br />
    deadline：  <br />
      read_expire;  <br />
      seek_cost=(x+stream_unit-1)/stream_unit，默认stream_unit为4字节；  <br />
      write_starved：读优先N次后才写；    </p>
<p>文件系统：  <br />
    hdparm：MaxMultSect参数，默认16，当前都支持32位输出了。    </p>
<p>网络：  <br />
    tcp_window_scaling、tcp_sack、tcp_fsack等。    </p>
<p>进程间通信：  <br />
    ipcs -u查看状态；  <br />
    ipcs -l查看限制。    </p>
<p>数据库：  <br />
    OLTP在线事务处理的业务类型类似小文件，一般文件块大小在2KB左右；  <br />
    DSS决策支持系统的业务类型类似大文件，一般文件块大小在8KB以上。    </p>
<h1 id="section">网站性能监测与优化</h1>
<p>Netflix的Jiffy是客户端收集的开源项目；  <br />
  sqmphoniq即是服务器端分析，也要客户端js的支持；  <br />
  Episodes同上。    </p>
<h1 id="jruby">JRuby语言实战技术</h1>
<p>类与超类：  <br />
    所有类的超类都是Object；  <br />
    所有类都是类Class的对象。</p>
<h1 id="hadoop">Hadoop实战</h1>
<p>chukwa监控系统：  <br />
    在HDFS和Map/Reduce的基础上，即意味着日志非tail方式，而是有collector先行合并成大文件再存储到HDFS；  <br />
    致力于2000+节点，1TB+日志量的集群日志分析，即意味着非实时性；  <br />
    数据结果目前还是存MySQL里再web展示，可能会转移到HBase上。  <br />
    流程架构类似如下：  <br />
        N个agents(每台server一个) &ndash;HTTP&ndash;&gt; M个collectors(每百个agent一个) &ndash;sink&ndash;&gt; HDFS &ndash;map/reduce&ndash;&gt; MySQL &lt;&ndash;JSP/JS&ndash;&gt; Web(HICC)  <br />
    整个流程跟logstash很类似，但是logstash没有固定hadoop平台，所以不用sink这步，实时性更好；而agent的input代码段就类似于执行类似map的工作，output段就是reduce结果了。</p>
      <a href="/2012/04/30/reading-notes-about-linux-system" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/04/21/backup-blog-to-51cto" title="51CTO博客自动发布脚本" rel="bookmark">51CTO博客自动发布脚本</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-04-21 00:00:00 +0800">21 Apr 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/bin/env perl</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Util</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">YAML::</span><span class="n">Syck</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Perl6::</span><span class="n">Say</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">XMLRPC::</span><span class="n">Lite</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Data::</span><span class="n">Dumper</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$f</span> <span class="o">=</span> <span class="nn">File::</span><span class="n">Util</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@blogs</span> <span class="o">=</span> <span class="nb">grep</span> <span class="p">{</span><span class="sr">/\.markdown$/</span><span class="p">}</span> <span class="nv">$f</span><span class="o">-&gt;</span><span class="n">list_dir</span><span class="p">(</span><span class="s">&#39;../_posts&#39;</span><span class="p">,</span> <span class="s">&#39;--recurse&#39;</span><span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">@blogs</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$yaml</span> <span class="o">=</span> <span class="n">LoadFile</span><span class="p">(</span><span class="nv">$_</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$title</span> <span class="o">=</span> <span class="nv">$yaml</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;title&#39;</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$text</span> <span class="o">=</span> <span class="nv">$f</span><span class="o">-&gt;</span><span class="n">load_file</span><span class="p">(</span><span class="s">&quot;$_&quot;</span><span class="p">);</span>
    <span class="n">upload</span><span class="p">(</span><span class="nv">$title</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">upload</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$title</span><span class="p">,</span> <span class="nv">$text</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$username</span> <span class="o">=</span> <span class="s">&#39;username&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$password</span> <span class="o">=</span> <span class="s">&#39;password&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$blogid</span>   <span class="o">=</span> <span class="s">&#39;123456&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$proxyurl</span> <span class="o">=</span> <span class="s">&#39;http://blogname.blog.51cto.com/xmlrpc.php&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nn">XMLRPC::</span><span class="n">Lite</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">(</span><span class="nv">$proxyurl</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">call</span><span class="p">(</span><span class="s">&#39;metaWeblog.newPost&#39;</span><span class="p">,</span> <span class="nv">$blogid</span><span class="p">,</span> <span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">,</span> <span class="p">{</span> <span class="n">title</span> <span class="o">=&gt;</span> <span class="s">&quot;$title&quot;</span><span class="p">,</span> <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&quot;$text&quot;</span><span class="p">,</span> <span class="n">categories</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s">&#39;【创作类型:原创】&#39;</span><span class="p">,</span><span class="s">&#39;IT管理&#39;</span><span class="p">,</span> <span class="p">]},</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span>
    <span class="n">say</span> <span class="s">&quot;newPost id -- &quot;</span> <span class="o">.</span> <span class="nv">$res</span> <span class="k">if</span> <span class="nv">$res</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>目前还有几个问题：</p>
<ol>
  <li>虽然写了创作类型是原创，但是发布后还是转载；</li>
  <li>categories的数组生成的xml格式是<array><data><value><base64>，但通过wireshark抓包windows live writer看到能被api接收的格式应该是<array><data><value><string>。在XMLRPC::Lite的代码中，有as_base64/as_string等好几个方法，但是找到从哪里定义使用，目前简单的采用注释掉了XMLRPC::Lite::Serializer::new()方法里的base64键值对，但是理论上应该不用修改源码的；</string></value></data></array></base64></value></data></array></li>
  <li>最后一个最关键的问题，不管我在服务器上是用utf8还是gb2312，上传后都是乱码。估计第一个问题其实也是由此产生的。</li>
</ol>
      <a href="/2012/04/21/backup-blog-to-51cto" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/04/18/get-location-of-some-companys" title="获取造价百强公司的真实位置" rel="bookmark">获取造价百强公司的真实位置</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-04-18 00:00:00 +0800">18 Apr 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>很久没更新，没用技术，今天稍微geek一下下。给老婆搜索她行业百强公司的具体地点，看看如果换单位的话是否方便出行~代码如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl</span>
<span class="k">use</span> <span class="nn">Data::</span><span class="n">Dumper</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">LWP::</span><span class="n">UserAgent</span><span class="p">;</span>
<span class="k">use</span> <span class="n">URI</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Web::</span><span class="n">Scraper</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">JSON::</span><span class="n">XS</span><span class="p">;</span>
<span class="c1"># 处理中文需要指定输入输出都用utf8格式，否则会有wide character in print的warning提示 </span>
<span class="k">use</span> <span class="n">utf8</span><span class="p">;</span>
<span class="nb">binmode</span><span class="p">(</span><span class="bp">STDIN</span><span class="p">,</span> <span class="s">&#39;:encoding(utf8)&#39;</span><span class="p">);</span>
<span class="nb">binmode</span><span class="p">(</span><span class="bp">STDOUT</span><span class="p">,</span> <span class="s">&#39;:encoding(utf8)&#39;</span><span class="p">);</span>
<span class="nb">binmode</span><span class="p">(</span><span class="bp">STDERR</span><span class="p">,</span> <span class="s">&#39;:encoding(utf8)&#39;</span><span class="p">);</span>
<span class="c1"># 百度地图搜索的查询结果返回的是json数据，需要转换成perl的哈希格式 </span>
<span class="k">sub </span><span class="nf">decode_map_json</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$map_json</span> <span class="o">=</span> <span class="n">decode_json</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="c1"># 如果是距离搜索，那么$map_json-&gt;{&quot;content&quot;}-&gt;[0]-&gt;{&quot;lines&quot;}-&gt;[0]-&gt;[2]是距离；$map_json-&gt;{&quot;taxi&quot;}-&gt;{&quot;detail&quot;}-&gt;[0]-&gt;{&quot;totalPrice&quot;}是打的费用。</span>
    <span class="k">return</span> <span class="nv">$map_json</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;content&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;addr&quot;</span><span class="p">};</span>
<span class="p">};</span>
<span class="c1"># 用LWP发起地图查询请求 </span>
<span class="k">sub </span><span class="nf">get_map_json</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$company</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$ua</span> <span class="o">=</span> <span class="nn">LWP::</span><span class="n">UserAgent</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$ua</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;http://map.baidu.com/?qt=s&amp;wd=&#39;</span><span class="o">.</span><span class="nv">$company</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="n">decoded_content</span> <span class="k">if</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="n">is_success</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1"># 采用Web::Scraper获取网页里的XPath内容 </span>
<span class="k">sub </span><span class="nf">get_company</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$ori_uri</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="c1"># 可以在firefox里直接查看元素的XPath，在google chrome里则需要安装Xpath Helper工具。</span>
    <span class="c1"># 安装完成后，使用Ctrl+Shift+X快捷键呼出顶端Xpath调试框，然后按住Shift键，用鼠标左键点击网页元素，上边框里就出现元素的Xpath和content了。</span>
    <span class="c1"># 注意复制过来的Xpath里的@会被perl理解成是数组的标示，所以要加上逃逸符\才行。</span>
    <span class="k">my</span> <span class="nv">$tweets</span> <span class="o">=</span> <span class="n">scraper</span> <span class="p">{</span>
        <span class="n">process</span> <span class="s">&quot;/html/body/div[\@class=&#39;index-main layout&#39;]/div[\@class=&#39;index-main layout&#39;]/div[\@class=&#39;index-content bcolor&#39;]/div[\@class=&#39;cont&#39;]/div[\@id=&#39;fontzoom&#39;]/span[\@id=&#39;BodyLabel&#39;]/div/table&quot;</span><span class="p">,</span> <span class="s">&quot;list&quot;</span> <span class="o">=&gt;</span> <span class="n">scraper</span> <span class="p">{</span>
            <span class="c1"># 第一个scraper里不能获取tbody，原因未知。所以分成两步，先获取一个到table的scraper，再获取tbody里面的TEXT。</span>
            <span class="n">process</span> <span class="s">&quot;tbody tr td:nth-child(2)&quot;</span><span class="p">,</span> <span class="s">&#39;cont[]&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;TEXT&#39;</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$tweets</span><span class="o">-&gt;</span><span class="n">scrape</span><span class="p">(</span><span class="n">URI</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$ori_uri</span><span class="p">));</span>
    <span class="k">return</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;list&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;cont&#39;</span><span class="p">};</span>
<span class="p">};</span>
<span class="k">my</span> <span class="nv">$company</span> <span class="o">=</span> <span class="n">get_company</span><span class="p">(</span><span class="s">&#39;http://www.ceca.org.cn/show.aspx?id=2006&#39;</span><span class="p">);</span>
<span class="k">foreach</span><span class="p">(</span><span class="nv">@$company</span><span class="p">){</span>
    <span class="k">print</span> <span class="nv">$_</span><span class="p">,</span><span class="s">&quot;\t&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$json</span> <span class="o">=</span> <span class="n">get_map_json</span><span class="p">(</span><span class="nv">$_</span><span class="p">);</span>
    <span class="k">print</span> <span class="n">decode_map_json</span><span class="p">(</span><span class="nv">$json</span><span class="p">),</span><span class="s">&quot;\n&quot;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>输出结果如下：    </p>
<pre><code>单位名称	
上海东方投资监理有限公司	中国·上海市江宁路1306弄7号富丽大厦23楼
中冶京诚工程技术有限公司	白广路4号
中铁工程设计咨询集团有限公司	
中冶赛迪工程技术股份有限公司	重庆市渝中区双钢路一号
中国电力工程顾问集团西南电力设计院	
上海第一测量师事务所有限公司	澳门路519弄1-5号
中竞发（北京）工程造价咨询有限公司	知春路108号豪景大厦A座13层
</code></pre>
<p>搜狗地图的api只是js的，不方便弄。不然直接获取从当前地点到目的地点的距离和耗时就更好了~~百度地图页面上就没看到有api提供，虽然用着，还是鄙视一下~~</p>
      <a href="/2012/04/18/get-location-of-some-companys" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/04/16/configs-automatically-effective-for-elastic-monitor" title="弹性集群监控中的配置自动生效问题研究" rel="bookmark">弹性集群监控中的配置自动生效问题研究</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-04-16 00:00:00 +0800">16 Apr 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>最近跟<a href="http://weibo.com/fedoracore">@画圈圈的星星</a> 聊天，说到nagios在大规模集群运用中一个比较严重的瓶颈：修改配置需要重启进程。 <br />
听起来似乎不是什么问题，我个人之前对nagios的追求，也都放在怎么样提供一个及时高效的监控和数据展示上面&mdash;-这两个问题在 <code>mod_gearman</code> 和 <code>pnp4nagios</code> 的协助下已经很给力了。    </p>
<p>但是聊天中提到了一个新的场景，事实上早在两个月前，<a href="http://weibo.com/tjpm">@GNUer</a> 就提到过类似的场景，就是当 nagios 监控的是这样一个弹性集群的时候：</p>
<pre><code>集群设备数以千记，甚至是上万的规模；
而且设备上运行着复杂的应用，每台设备都有几十上百的监控项需求；
为了提供高可靠性，集群以资源池的方式运行，即设备随时可能更改当前应用角色，在idle/lb/cache/web/app/db/storage等之间切换；
</code></pre>
<p>以上。    </p>
<p>尤其是最后一条，假如这个更改频率快到了每分钟都有变更，那么 nagios 重启进程这点就足以打死它了。实际运行中我们可以知道，当 <code>nagios reload</code> 的时候，这个命令的执行本身就要花费远大于1分钟的时间。    </p>
<p>临时的办法，就是在更改后不主动 reload，而是在 crontab 里定时去做。损失一些监控实时性。一般来说，还不至于真的同一台设备一分钟内连续更改角色并且需要分别监控的。    </p>
<p>但是真要做到实时，应该怎么做呢？    </p>
<p>首先想到的是 <code>mod_gearman</code> 的基础上进行改造。我们之前已经知道，<code>mod_gearman</code> 上是可以分别有 host_check/service_check/check_result 几个 jobs 的。那么，我们可以跳过 config 阶段，自己写 gearman client 发送 job 。这一步很容易。难点是 check_result 被 nagios 回收后，我们自己发的 job，其 host/service 在 nagios 的 service_list 结构里是不存在的&hellip;&hellip;所以还要自己写 gearman worker 来回收 result，具体来说，必须要做的事情包括有：根据 performance_data 来 create 和 update 相应的 rrds；根据 exit status 来启动 notification。这个工作内容一下子达到自己重写一个比较完整的监控系统的地步了，而且你如果通过原版的 cgi 查看，这部分内容还查看不到&hellip;&hellip;    </p>
<p>于是我在 github 上询问 <code>mod_gearman</code> 的作者<a href="https://github.com/sni">Sven Nierlein</a> ，他回答说：</p>
<pre><code>There is no such feature right now and it would be very hard to implement such thing in nagios or icinga.
It should be easier to implement something like that in shinken, but i guess it still takes 2-3 weeks of development.
</code></pre>
<p>好吧，比较失望的回答。尝试去瞄一眼 nagios-src，在 base/events.c 里可以看到，nagios 是在读取完全部 config 之后，才进入 loop，并提供 eventbroker 的 api 的。    </p>
<p>shinken 是完全重写过的披着 nagios 皮的监控系统，在 <a href="http://shinken.ideascale.com/">shinken 的 suggestion 征集页面</a> 上，我看到也有一位提议：<a href="http://shinken.ideascale.com/a/dtd/Arbiter-configuration-without-reloading-daemon/323455-10373">Arbiter configuration without reloading daemon</a>，不过应者寥寥，看来这种需求真的是极少数人才会碰到的。    </p>
<p>既然说到用 gearman，又说到监控，再回头看看去年提到的 cloudforecast。在 <code>ConfigLoader.pm</code> 中，可以看到一个 <code>watchdog</code> 方法。具体代码如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$watcher</span> <span class="o">=</span> <span class="nn">Filesys::Notify::</span><span class="n">Simple</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="o">\</span><span class="nv">@path</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$watcher</span><span class="o">-&gt;</span><span class="nb">wait</span><span class="p">(</span> <span class="k">sub </span><span class="p">{</span>
            <span class="k">my</span> <span class="nv">@path</span> <span class="o">=</span> <span class="nb">grep</span> <span class="p">{</span> <span class="nv">$_</span> <span class="o">!~</span> <span class="sr">m![/\\][\._]|\.bak$|~$!</span>  <span class="p">}</span> <span class="nb">map</span> <span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">path</span><span class="p">}</span> <span class="p">}</span> <span class="nv">@_</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">if</span> <span class="o">!</span> <span class="nv">@path</span><span class="p">;</span>
            <span class="nn">CloudForecast::</span><span class="n">Log</span><span class="o">-&gt;</span><span class="nb">warn</span><span class="p">(</span> <span class="s">&quot;File updates: &quot;</span> <span class="o">.</span> <span class="nb">join</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="nv">@path</span><span class="p">)</span> <span class="p">);</span>
            <span class="nb">sleep</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nb">kill</span> <span class="s">&#39;TERM&#39;</span><span class="p">,</span> <span class="nv">$parent_pid</span><span class="p">;</span>
            <span class="nb">exit</span><span class="p">;</span>
        <span class="p">}</span> <span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<p>可以看到，其实现方法是通过另起进程，通过 inotify 监听文件修改的方式，&rdquo;实时&rdquo;的重启主进程。实质上与 nagios 并无区别，都是要重新加载内存中保存的整个监控项配置列表。虽然没有大压力运用，但是可以猜测在预设环境中，重启耗时也会是瓶颈。    </p>
<p>另外一个监控系统 zabbix，与上面两个系统都不同，他的监控配置，不是通过文件方式存在监控服务器上，而是通过 web 操作保存在数据库里。整个 host/item/template 等等都是鼠标点击即可。    </p>
<p>zabbix 我的使用经验不多，只在三年前用它的预设步骤的方式监控过网页性能。印象中在 create graph 后需要等待一定时间后才能反映出结果。但不确定这个时间是监控项排队消耗的，还是监控进程重启消耗掉的。    </p>
<p>和<a href="http://weibo.com/frankymryao">@超大杯摩卡星冰乐</a> 询问了一下，只能猜测或许是通过循环 scan table 的方式&rdquo;实时&rdquo;的添加&rdquo;新&rdquo;监控项到监控进程的队列里。或许也得跟分析 nagios 一样看看代码才知道是否能在本文预设的弹性环境下适用了。</p>
      <a href="/2012/04/16/configs-automatically-effective-for-elastic-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/03/18/postgreSQL-DBA-2000-note2" title="PostgreSQL中国用户会DBA2000培训计划北京第二课笔记" rel="bookmark">PostgreSQL中国用户会DBA2000培训计划北京第二课笔记</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-03-18 00:00:00 +0800">18 Mar 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#database-ref" title="database" rel="category tag">database</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <h2 id="section">运行维护</h2>
<h3 id="vacuum">vacuum命令</h3>
<p>pgsql是multi-version concurrency control的，update和delete的操作并不会真正的修改原版本的内容，而只是做一个标记，最后需要用vacuum命令回收失效版本的位置。<br />
vacuum的主要作用：
1. 恢复或重用失效的空间；
2. 更新pgsql规划器的数据统计；
3. 避免事务ID的重复。
事务ID只有32位，差不多40亿左右。建议在达到10亿左右的时候就需要vacuum一次。<br />
在version8.*之后，默认就是用auto vacuum。注意auto vacuum不是定时启动，而是触发式的。</p>
<p>vacuum命令有两种形式：
1. vacuum，正常情况，不阻塞读写。
2. vacuum full，使用全表排他锁，不可读，产生最小大小的数据文件。不建议在7*24的生产环境使用。</p>
<p>vacuum full命令的操作原理简述：
1. 标记旧数据；
2. 移动数据成连续空间；
3. 截断文件。</p>
<h3 id="reindex">reindex命令</h3>
<p>在version7.4之后，该命令不再需要经常性运行了。<br />
执行该命令会阻塞写操作。读操作照常。</p>
<h3 id="analyze">analyze命令</h3>
<p>建议规划一个database范围的analyze，然后每天运行看效果。</p>
<h2 id="section-1">存储过程</h2>
<h3 id="plpgsql">pl/pgsql示例：</h3>
<div class="highlight"><pre><code class="sql"><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">func_name</span> <span class="p">(</span> <span class="k">option</span> <span class="k">type</span> <span class="p">)</span> <span class="k">RETURNS</span>
    <span class="k">type</span> <span class="k">AS</span> <span class="err">$$</span>
    <span class="p">...</span>
</code></pre></div>
<h3 id="section-2">触发器示例：</h3>
<div class="highlight"><pre><code class="sql"><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="k">trigger_name</span> <span class="p">(</span> <span class="k">option</span> <span class="k">type</span> <span class="p">)</span> <span class="k">RETURNS</span>
    <span class="n">tirgger</span> <span class="k">AS</span> <span class="err">$$</span>
<span class="k">DECLARE</span> <span class="p">...</span>
<span class="k">BEGIN</span>
    <span class="p">....</span>
    <span class="k">RETURN</span> <span class="k">NEW</span><span class="o">/</span><span class="k">NULL</span> <span class="cm">/*NULL就回滚上面的操作*/</span>
<span class="k">END</span>
</code></pre></div>
<h3 id="section-3">调试</h3>
<p>图形化安装时带有的pgadmin3里有一项debugger。<br />
配置：shared_preload_libraries=&rdquo;$libdir/plugins/plugin_debugger.so&rdquo;<br />
导入：debugger.sql</p>
<h2 id="section-4">监控</h2>
<ol>
  <li>data/pg_log/*.log</li>
</ol>
<p>标示等级一般为：通用等级LOG NOTICE，错误等级FATAL ERROR，提示等级LOG HINT
一般有一个startup.log文件记录启动过程；一些以时间为名字的日志，记录运行过程，每当文件超过10MB，每次重启，以及每过一整天的时候，就会生成一个新文件。</p>
<ol>
  <li>pgadmin3</li>
</ol>
<p>通过server status看锁状态，杀进程等。</p>
<ol>
  <li>psql命令</li>
</ol>
<div class="highlight"><pre><code class="sql"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">pg_stat_activetity</span><span class="p">;</span>
</code></pre></div>
<p>配置：log_min_duration_statement，设置慢查询日志的时限，单位为毫秒。</p>
<h2 id="section-5">集群</h2>
<h3 id="section-6">8.*时代</h3>
<p>复制以WAL File为单位，一旦丢失，就可能损失16MB的事务。而且standby不可读。</p>
<h3 id="section-7">9.*时代</h3>
<p>复制以WAL中的record为单位，且standby可以读操作，能设置成读写分离集群。
9.0中只有异步复制；9.1中有同步复制。</p>
<h3 id="section-8">主要方案</h3>
<p>PGPool II等</p>
      <a href="/2012/03/18/postgreSQL-DBA-2000-note2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/03/17/postgreSQL-DBA-2000-note1" title="PostgreSQL中国用户会DBA2000培训计划北京第一课笔记" rel="bookmark">PostgreSQL中国用户会DBA2000培训计划北京第一课笔记</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-03-17 00:00:00 +0800">17 Mar 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#database-ref" title="database" rel="category tag">database</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <h1 id="postgresql">PostgreSQL及中国用户会简介</h1>
<p>主讲人 李元佳 galy</p>
<h2 id="section">数据库分类</h2>
<p>商业数据库: Oracle, DB2, SQLserver, Sybase&hellip;
  开源数据库: MySQL, PostgreSQL, Firebird, SQLite, Apache Derby&hellip;</p>
<h2 id="postgresql-1">PostgreSQL沿革</h2>
<p>类BSD许可的，面向对象的，关系型数据库管理系统。</p>
<p>MIT &ndash;&gt; Ingres &ndash;&gt; Postgres &ndash;&gt; PostgreSQL ( 同源的还有SQLserver等 )</p>
<p>支持SQL2008标准的大部分功能特性，是各种RDBMS的SQL方言中最贴近标准的。</p>
<h1 id="postgresql-2">PostgreSQL简介</h1>
<p>主讲人 萧少聪 Scott.Siu</p>
<h2 id="section-1">用户与进程</h2>
<p><img src="/images/uploads/pgsql-process.png" alt="postgreSQL中用户与进程的联系" /></p>
<p>注意在上图中，不管是workmem还是sharebuffer，每个page都是8KB大小。</p>
<h2 id="section-2">复制流程</h2>
<p>stream replica的流程如下：</p>
<pre><code>client --&gt; postgres --&gt; WAL (not file)--&gt; slave --&gt; (return OK) --&gt; master --&gt; commit
</code></pre>
<p>在master上的流程细节如下：</p>
<pre><code>client --&gt; write-ahead log(WAL) buffer --&gt; commit --&gt; (async/fsync~~160%) --&gt; WAL Files (16MB * 132个)
   ^
   |--&gt; share buffer  --&gt; bgwriter --&gt; db files
             ^                            |
             |--        check point     &lt;-- ## 安装
</code></pre>
<p>linux: 注意使用独立的非root用户来安装启动pgsql。在version9.1后，可以跟SElinux结合使用，提高安全性。<br />
  win: 只能在NTFS文件系统上创建表空间。<br />
  窗口统一式安装，可以方便的安装stack builder套件。</p>
<h2 id="section-3">目录</h2>
<p>默认使用窗口安装的情况下，目录结构如下：</p>
<pre><code>/opt/PostgreSQL/9.1/
    |
    |--&gt; bin/
    |--&gt; doc/
    |--&gt; include/
    |--&gt; lib/
    |--&gt; share/
    |--&gt; install/
    |--&gt; data/
           |--&gt; base/		存放table和index的ID号
           |--&gt; global/
           |--&gt; pg_clog/	运行日志
           |--&gt; pg_xlog/	WAL日志
           |--&gt; pg_tblspc/	表空间ID，实质为到真实数据目录的软连接
           |--&gt; postgresql.conf
           |--&gt; pg_hba.conf
</code></pre>
<h2 id="section-4">创建</h2>
<ol>
  <li>使用bin/initdb命令；  </li>
  <li>修改data/pg_hba.conf里的连接地址段和登录权限；  </li>
  <li>修改data/postgresql.conf里的监听网卡。</li>
</ol>
<h2 id="section-5">启动与停止</h2>
<p>使用bin/pg_ctl命令。其停止命令可指定三种类型：</p>
<ol>
  <li>smart模式，即等待全部client连接断开后停止；  </li>
  <li>fast模式，即直接回滚全部尚未完成的事务后停止；  </li>
  <li>immediate模式，即立刻中止全部进程。</li>
</ol>
<h2 id="section-6">配置说明</h2>
<ol>
  <li>
    <p>work_mem:  <br />
并不是每个client连接的postgres进程分配一个work mem，而是SQL每一次的排序work使用一个work mem。包括join和order by。如果没有排序，就不用work mem。如果一条sql里同时使用了N次排序，那么就要使用N个work mem。所以理想的使用方法不是提供太大的work mem来排序，而是尽量缩小需要排序的数据大小，设置为4/8MB即可。  <br />
该配置是可以online修改的。命令如下：  <br />
 SET work_mem = 2048;
 SET work_mem = &lsquo;2MB&rsquo;;
上面两条命令等价。可以看书其计量单位为1KB，且类型为字符串，所以在自定义计量时需要用引号。</p>
  </li>
  <li>
    <p>share_buffers:  <br />
理论上为机器物理内存的40%大小。实际测试显示大于8GB后，性能不会有相应的提升，即可认为最大设置到8GB。</p>
  </li>
  <li>
    <p>temp_buffers:  <br />
无修改意义</p>
  </li>
  <li>
    <p>max_prepared_transactions:  <br />
并发事务数</p>
  </li>
  <li>
    <p>maintenance_work_mem:  <br />
vacuum、create index、alter table add foreign key等管理命令使用的work_mem，建议设置1G。因为这些命令经常涉及全表扫描。</p>
  </li>
</ol>
<h2 id="postgresql-3">postgreSQL的数据集概念</h2>
<pre><code>                      DataBase Cluster
                             |
                   |---------|---------|
                   |         |         |
                 user     database   tablespace
                             |
                           schema
</code></pre>
<p>这里的cluster不是HA cluster，而是数据集。<br />
  一个database里可以有多个schema，一个user可以有多个schema的管理权限，但一个schema只能归属于一个user。<br />
  默认有一个template0为schema的基础，不可修改，在template0基础上有template1，可以修改。实际创建schema时就是复制template1出来。
  创建user时，一般都会再创建一个同名的schema，并规定该schema的所属人为该user。这样在pgsql连接到database后，其默认schema即为该同名schema。</p>
<h2 id="section-7">备份与恢复</h2>
<h3 id="section-8">备份</h3>
<p>pg_dump命令，使用-s指定只备份数据结构，-t指定只备份数据内容。</p>
<h3 id="section-9">基于时间点的备份恢复</h3>
<ol>
  <li>select pg_start_backup(&lsquo;FullBackup&rsquo;);</li>
  <li>tar zcvf full_backup/week1.tgz /opt/PostgreSQL/9.1/data/</li>
  <li>
    <p>select pg_stop_backup();</p>
  </li>
  <li>tar zxvf full_backup/week1.tgz -C /</li>
  <li>echo &lsquo;restore_command=&rdquo;cp %f %p&rdquo;&rsquo; &gt; data/recovery.conf</li>
</ol>
      <a href="/2012/03/17/postgreSQL-DBA-2000-note1" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/03/10/go-deep-into-nginx-operation" title="加强了解nginx的几个问题" rel="bookmark">加强了解nginx的几个问题</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-03-10 00:00:00 +0800">10 Mar 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>被问到一些关于nginx或者说nginx运维相关的问题，记录下来几个值得思考的。这里面有些是自己曾经想到过但是浅浅的了解下就不放在心上的，有些是根本没想过这会成为一个&rdquo;有意思&rdquo;的问题的&hellip;&hellip;</p>
<h2 id="nginxclientip">1、nginx日志记录得到client的IP原理。</h2>
<p>nginx记录的client的IP分两种，一种是$remote_addr，一种是$http_x_forwarded_for。其中X-Forwarded-For里存放的是proxy加入的client端IP，通过http header传递的。而$remote_addr是TCP上的结果。但是具体如何不知道。今天回来翻nginx的src，先从定义nginx变量的ngx_http_variable.c看到$remote_addr是这样来的:</p>
<div class="highlight"><pre><code class="c"><span class="n">ngx_http_variable_remote_addr</span><span class="p">(</span><span class="kt">ngx_http_request_t</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
    <span class="kt">ngx_http_variable_value_t</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="kt">uintptr_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">v</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">connection</span><span class="o">-&gt;</span><span class="n">addr_text</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
    <span class="n">v</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">v</span><span class="o">-&gt;</span><span class="n">no_cacheable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">v</span><span class="o">-&gt;</span><span class="n">not_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">v</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">connection</span><span class="o">-&gt;</span><span class="n">addr_text</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">NGX_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>然后可以在ngx_http.h和ngx_http_request.h里看到</p>
<div class="highlight"><pre><code class="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ngx_http_request_s</span>     <span class="kt">ngx_http_request_t</span><span class="p">;</span>
<span class="p">...</span>
<span class="k">struct</span> <span class="n">ngx_http_request_s</span> <span class="p">{</span>
    <span class="kt">uint32_t</span>                          <span class="n">signature</span><span class="p">;</span>         <span class="cm">/* &quot;HTTP&quot; */</span>
    <span class="kt">ngx_connection_t</span>                 <span class="o">*</span><span class="n">connection</span><span class="p">;</span>
    <span class="kt">ngx_buf_t</span>                        <span class="o">*</span><span class="n">header_in</span><span class="p">;</span>
    <span class="kt">ngx_http_headers_in_t</span>             <span class="n">headers_in</span><span class="p">;</span>
    <span class="kt">ngx_http_headers_out_t</span>            <span class="n">headers_out</span><span class="p">;</span>
    <span class="kt">ngx_http_request_body_t</span>          <span class="o">*</span><span class="n">request_body</span><span class="p">;</span>
<span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p>然后在ngx_connection.c里看到</p>
<div class="highlight"><pre><code class="c"><span class="cp">#include &lt;ngx_core.h&gt;</span>
<span class="p">...</span>
<span class="kt">ngx_listening_t</span> <span class="o">*</span>
<span class="n">ngx_create_listening</span><span class="p">(</span><span class="kt">ngx_conf_t</span> <span class="o">*</span><span class="n">cf</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sockaddr</span><span class="p">,</span> <span class="kt">socklen_t</span> <span class="n">socklen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">ngx_listening_t</span>  <span class="o">*</span><span class="n">ls</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr</span>  <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
    <span class="n">u_char</span>            <span class="n">text</span><span class="p">[</span><span class="n">NGX_SOCKADDR_STRLEN</span><span class="p">];</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">ngx_array_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="o">-&gt;</span><span class="n">listening</span><span class="p">);</span>
    <span class="n">ngx_memzero</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">ngx_listening_t</span><span class="p">));</span>
    <span class="n">sa</span> <span class="o">=</span> <span class="n">ngx_palloc</span><span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">socklen</span><span class="p">);</span>
    <span class="n">ngx_memcpy</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">sockaddr</span><span class="p">,</span> <span class="n">socklen</span><span class="p">);</span>
    <span class="n">ls</span><span class="o">-&gt;</span><span class="n">sockaddr</span> <span class="o">=</span> <span class="n">sa</span><span class="p">;</span>
    <span class="n">len</span> <span class="o">=</span> <span class="n">ngx_sock_ntop</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">NGX_SOCKADDR_STRLEN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">ls</span><span class="o">-&gt;</span><span class="n">addr_text</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ngx_pnalloc</span><span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="n">ngx_memcpy</span><span class="p">(</span><span class="n">ls</span><span class="o">-&gt;</span><span class="n">addr_text</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">...</span>
<span class="p">};</span>
</code></pre></div>
<p>在ngx_core.h中，加载了</p>
<div class="highlight"><pre><code class="c"><span class="cp">#include &lt;ngx_socket.h&gt;</span>
</code></pre></div>
<p>所以结果就是说，nginx日志里记载的$remote_addr变量，就是由connection的socket里获得的。在socket.h里可以看到accept函数的定义：</p>
<div class="highlight"><pre><code class="c"><span class="kt">int</span> <span class="nf">accept</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">addrlen</span><span class="p">);</span>
</code></pre></div>
<p>另外，nginx上除了$remote_addr变量外，还有一个$binary_remote_addr变量。而且在ngx_http_variables.c里，根据是否是IPv6协议，做了区分，最终地址是通过r-&gt;connection结构体里的sockaddr-&gt;sin_addr获得。</p>
<p>目前就看到这里了&hellip;&hellip;关于socket如何从监听套接字上获得IP并建立连接套接字的，以后再继续研究TCP层上的知识。</p>
<h2 id="cookie-insert">2、cookie insert原理在负载均衡上是如何实现的。</h2>
<p>作7层负载均衡的时候，会遇到cookie类型的会话保持。</p>
<p>一般的session保持办法，是利用源地址哈希(source-hash)的办法，把同一个来源客户(实际通常是同一个C段的IP)，固定指向后端的同一台机器。</p>
<p>而利用cookie的办法，则是在负载均衡器上，给响应客户请求的http-response-header里Set-Cookie字段添加上有关内容，然后根据客户请求的http-request-header里Cookie的该字段内容，分发到和之前一样的后端服务器上。</p>
<p>在nginx上没有标准模块完成这个事情，不过可以用<a href="http://wiki.nginx.org/HttpMapModule">map功能</a>进行简单的模拟，如下：</p>
<div class="highlight"><pre><code class="nginx">    <span class="k">map</span> <span class="nv">$COOKIE_route</span> <span class="nv">$group</span> <span class="p">{</span>  
         <span class="kn">700003508</span>     <span class="s">admin</span><span class="p">;</span>  
         <span class="kn">~*3$</span>     <span class="s">admin</span><span class="p">;</span>  
         <span class="kn">default</span>   <span class="s">user</span><span class="p">;</span>  
     <span class="p">}</span>  
     <span class="k">upstream</span> <span class="s">backend_user</span> <span class="p">{</span>  
         <span class="kn">server</span>   <span class="n">10.3.24.11</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>  
     <span class="p">}</span>  
     <span class="k">upstream</span> <span class="s">backend_admin</span> <span class="p">{</span>  
         <span class="kn">server</span>   <span class="n">10.3.25.21</span><span class="p">:</span><span class="mi">8081</span><span class="p">;</span>  
     <span class="p">}</span>  
     <span class="k">server</span> <span class="p">{</span>  
         <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>  
         <span class="kn">server_name</span>  <span class="s">photo.domain.com</span><span class="p">;</span>  
         <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>  
             <span class="kn">proxy_pass</span>            <span class="s">http://backend_</span><span class="nv">$group</span><span class="p">;</span>  
         <span class="p">}</span>  
     <span class="p">}</span>  
</code></pre></div>
<p>不过nginx社区有第三方模块叫做&rdquo;nginx-sticky-module&rdquo;的，用来完成这个功能。项目托管在googlecode上，具体地址是<a href="http://code.google.com/p/nginx-sticky-module">http://code.google.com/p/nginx-sticky-module</a>。具体实现的效果是首先根据轮训RR随机到某台后端，然后在响应的Set-Cookie上加上route=md5(upstream)字段，第二次请求再处理的时候，发现有route字段，直接导向原来的那台服务器。</p>
<p>编译后启用配置如下：</p>
<div class="highlight"><pre><code class="nginx"><span class="k">upstream</span> <span class="p">{</span>
  <span class="kn">sticky</span> <span class="s">[name=route]</span> <span class="s">[domain=.domain.com]</span> <span class="s">[path=/]</span> <span class="s">[expires=1h]</span> <span class="s">[hash=index|md5|sha1]</span> <span class="s">[no_fallback]</span><span class="p">;</span>
  <span class="kn">server</span> <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span>
  <span class="kn">server</span> <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">9001</span><span class="p">;</span>
  <span class="kn">server</span> <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">9002</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="nginxworker80">3、nginx是多worker的，但是80端口只能有一个占用，这一段的工作原理是怎样的？</h2>
<p>这个问题的回答其实在第一个问题上已经部分涉及到了。就是socket的两个分类，一个是监听套接字，一个是连接套接字。占用80端口的，是使用的监听套接字。而worker里使用的，是accept之后建立的连接套接字。</p>
<p>正常情况下，nginx对worker加锁，在每一时刻，只有一个worker获得accept的权力。当监听的socket可以accept的时候，即有新链接时，主进程通过epoll的方式处理，先把这个事件保存起来，等通过锁的竞争选取一个worker后，再由这个worker真正的执行accept创建连接套接字，然后主进程返回监听状态。</p>
<p>代码中主要是ngx_trylock_accept_mutex()函数和ngx_process_events_and_timers()函数等，不过这个看不太懂，更多是根据别人的描述文章了。</p>
<h2 id="section">4、一致性哈希的原理。</h2>
<p>在7层负载均衡的时候，经常会利用到哈希。关于nginx上的url_hash和consistent_hash模块，我在2年前曾经简单的看过，博文链接如下：</p>
<ol>
  <li><a href="http://chenlinux.com/2010/03/15/consistent_hash/">url_hash的perl脚本模拟</a></li>
  <li><a href="http://chenlinux.com/2010/03/16/implement-consistent_hash-by-perl/">consistent_hash的perl脚本模拟</a></li>
</ol>
<p>两年后回头来看当初的脚本，真是很烂。不过从关键的uri和peer都取CRC32和取值做减法还是可以看出来一致性哈希的原理，即将节点通过哈希取值后均匀分布在一个0-9999999999的&rsquo;圆环&rsquo;上。然后要存储的url同样的算法取哈希值后，放进这个&rdquo;圆环&rdquo;里，顺时针方向离他最近的那个节点，即为他实际存储的节点。</p>
<p>在CPAN上，其实有<a href="http://search.cpan.org/~bradfitz/Set-ConsistentHash-0.92/lib/Set/ConsistentHash.pm">Set::ConsistentHash</a>模块可以看。如果是简单运用的话，<a href="http://search.cpan.org/~karavelov/Hash-ConsistentHash-0.05/lib/Hash/ConsistentHash.pm">Hash::ConsistentHash</a>模块是基于Set::ConsistentHash模块封装的易用版本。示例如下：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Hash::</span><span class="n">ConsistentHash</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">String::</span><span class="n">CRC32</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$chash</span> <span class="o">=</span> <span class="nn">Hash::</span><span class="n">ConsistentHash</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">buckets</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">A</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">B</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="n">C</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">},</span>
                                       <span class="n">hash_func</span><span class="o">=&gt;\&amp;</span><span class="n">crc32</span><span class="p">,</span>
                                     <span class="p">);</span>
<span class="k">my</span> <span class="nv">$server</span> <span class="o">=</span> <span class="nv">$chash</span><span class="o">-&gt;</span><span class="n">get_bucket</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">);</span>
</code></pre></div>
<h2 id="inotify">5、inotify丢事件。</h2>
<p>这个问题没有碰到过，只在网上看到过一篇<a href="http://doc.chinaunix.net/linux/201007/687123.shtml">Linux事件监控机制遗漏事件问题的相关分析</a>，里面提到&rdquo;发现在过于频繁的往目录下添加文件和目录的时候,会丢事件&rdquo;。但是只提到了这么个问题，然后通过重复添加监听解决问题，没有提到原因。</p>
<p>我个人疑心，会不会是sysctl参数没有设置好的原因呢？</p>
<p>sysctl里关于inotify的参数有三个，如下：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="nv">$ </span>sudo /sbin/sysctl -a|grep inotify
fs.inotify.max_queued_events <span class="o">=</span> 16384
fs.inotify.max_user_watches <span class="o">=</span> 8192
fs.inotify.max_user_instances <span class="o">=</span> 128
</code></pre></div>
<p>上示是默认值，明显偏小。比方sersync2方案中，启动前就要求修改这些值到50000000。如果启动的时候在sysctl范围内，启动时没问题的，但是迅速的添加到了范围外，那么应该就会出这个问题了。</p>
<p>当然，以上是我个人猜测，也说不准真的是inotify本身却有问题。</p>
<h2 id="nginxworkercpu">7、nginx的worker是怎么绑定到cpu上的？</h2>
<p>nginx有一个配置，就是启动多个worker的时候，可以使用cpu_affinity配置将worker分别绑定在不同的cpu上。</p>
<p>如果有8个cpu，那么相应参数就是：</p>
<p>00000001 00000010 00000100 00001000 00010000 00100000 01000000 10000000</p>
<p>也就是类似占位符一样一个位置代表一个CPU。如果按照普通理解的二进制，那么0011不是第三个CPU而是绑定在第1和第2个CPU上平均……</p>
<p>这种写法，是由操作系统决定的。在nginx的ngx_process_cycle.c中，相关内容如下：</p>
<div class="highlight"><pre><code class="c"><span class="cp">#include &lt;ngx_config.h&gt;</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ngx_worker_process_init</span><span class="p">(</span><span class="kt">ngx_cycle_t</span> <span class="o">*</span><span class="n">cycle</span><span class="p">,</span> <span class="kt">ngx_uint_t</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cpu_affinity</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sched_setaffinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="kt">cpu_set_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cpu_affinity</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>在ngx_config.h中:</p>
<div class="highlight"><pre><code class="c"><span class="cp">#elif (NGX_LINUX)</span>
<span class="cp">#include &lt;ngx_linux_config.h&gt;</span>
</code></pre></div>
<p>在ngx_linux_config.h中:</p>
<div class="highlight"><pre><code class="c"><span class="cp">#include &lt;sched.h&gt;</span>
</code></pre></div>
<p>其实可以直接通过man sched_setaffinity看说明：</p>
<div class="highlight"><pre><code class="c">       <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">sched</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
       <span class="kt">int</span> <span class="n">sched_setaffinity</span><span class="p">(</span><span class="kt">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpusetsize</span><span class="p">,</span>
                             <span class="kt">cpu_set_t</span> <span class="o">*</span><span class="n">mask</span><span class="p">);</span>
</code></pre></div>
<p>关于这个*mask，man文档之后描述如下：</p>
<pre><code>   The  actual  system
   call  interface is slightly different, with the mask being typed as unsigned long *, reflecting
   that the fact that the underlying implementation of CPU sets is a simple bitmask.
</code></pre>
<p>bitmask就是上面说到的那个意思了~~</p>
<h2 id="section-1">8、某应用经过7层负载均衡访问应用服务器，因业务需要设置了5秒无响应即返回502错误。有反馈说全网范围内5%的访问出现错误，如何判断问题具体出在哪里？</h2>
<p>这个问题目前我还想不到有什么特别简捷的办法。靠类似nagios那样的定时监测，肯定是很不容易抓到错误的。如果靠debug日志或者strace命令啊，tcpdump命令啊的，在高流量的情况下，又太容易淹没在海量的正常数据里了。</p>
<p>另一个猜测是连接数满了，TCP的或者HTTP的。不过按理说负载均衡器上应该有监控，不至于到这么危急的时候还是通过客户端访问来反馈问题&hellip;&hellip;</p>
      <a href="/2012/03/10/go-deep-into-nginx-operation" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/03/04/magic-about-perl-subroutine-return-value" title="perl函数返回值引起的误会" rel="bookmark">perl函数返回值引起的误会</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-03-04 00:00:00 +0800">04 Mar 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在微博上偶然看到有位<a href="http://weibo.com/iheartbeat" title="南唐古韵">@南唐古韵</a>童鞋发了一条关于perl的：</p>
<pre><code>发现perl的一个bug：（2**3）**2=8
</code></pre>
<p>显然perl不可能真的犯这么白痴的错误，那么问题在哪呢？我们先看看下面这个判断：</p>
<div class="highlight"><pre><code class="perl"><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="o">~</span><span class="p">]</span><span class="c1"># perl -e &#39;print &quot;OK&quot; if (2**3)**2 == 8&#39;</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="o">~</span><span class="p">]</span><span class="c1"># perl -e &#39;print &quot;OK&quot; if (2**3)**2 == 64&#39;</span>
<span class="n">OK</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="o">~</span><span class="p">]</span><span class="c1">#</span>
</code></pre></div>
<p>一目了然，运算肯定是正确的。那上面那位童鞋的话是怎么得出来的呢？稍微想想，猜他可能是这样：</p>
<div class="highlight"><pre><code class="perl"><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="o">~</span><span class="p">]</span><span class="c1"># perl -e &#39;print (2**3)**2&#39;</span>
<span class="mi">8</span>
</code></pre></div>
<p>哇，真的变成8啦？！</p>
<p>其实都是因为print搞的鬼啦~print作为内置的命令，我们在书写的时候经常用空格分隔开参数，而不记得其实标准的应该用中括号括起来的~
也就是说，其实上面那行命令应该是：</p>
<div class="highlight"><pre><code class="perl"><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="o">~</span><span class="p">]</span><span class="c1"># perl -e &#39;print(2**3) **2&#39;</span>
</code></pre></div>
<p>然后下一个问题：在print之后还有一个**2啊，既然前面已经执行完成一个print命令，后面再加个东西，咋不会报错呢？</p>
<p>这就是涉及到关键了，perl的print执行也是有返回值的，真为1，假为0。也就是说，上面的命令其实是先执行了2的3次方得到8，然后执行print输出&rdquo;8&rdquo;到STDOUT并且返回1；然后执行1的2次方得到1；程序结束。</p>
<p>我们可以这样验证一下：</p>
<div class="highlight"><pre><code class="perl"><span class="p">[</span><span class="n">root</span><span class="nv">@AY110907102215177d47d</span> <span class="o">~</span><span class="p">]</span><span class="c1"># perl -e &#39;print (2**3)**2&#39;</span>
<span class="mi">8</span><span class="p">[</span><span class="n">root</span><span class="nv">@AY110907102215177d47d</span> <span class="o">~</span><span class="p">]</span><span class="c1"># perl -e &#39;$r=print (2**3)**2;print $r&#39;</span>
<span class="mi">81</span><span class="p">[</span><span class="n">root</span><span class="nv">@AY110907102215177d47d</span> <span class="o">~</span><span class="p">]</span><span class="c1"># perl -e &#39;$r=print (2**3)*2;print $r&#39;</span>
<span class="mi">82</span><span class="p">[</span><span class="n">root</span><span class="nv">@AY110907102215177d47d</span> <span class="o">~</span><span class="p">]</span><span class="c1"># perl -e &#39;$r=print (2**3)*2,&quot;\n&quot;;print $r&#39;</span>
<span class="mi">82</span><span class="p">[</span><span class="n">root</span><span class="nv">@AY110907102215177d47d</span> <span class="o">~</span><span class="p">]</span><span class="c1"># perl -e &#39;$r=print (2**3,&quot;\n&quot;)*2;print $r&#39;</span>
<span class="mi">8</span>
<span class="mi">2</span><span class="p">[</span><span class="n">root</span><span class="nv">@AY110907102215177d47d</span> <span class="o">~</span><span class="p">]</span><span class="c1"># </span>
</code></pre></div>
<p>因为要给print造一个返回值为假的示例不太容易，所以举一个1*2=2/0*2=0来证明咯~至于加上的&rdquo;\n&rdquo;测试，更进一步证明它跟print无关啦~~</p>
      <a href="/2012/03/04/magic-about-perl-subroutine-return-value" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/02/29/intro-zen-load-balancer" title="ZenLoadBalancer试用(一)" rel="bookmark">ZenLoadBalancer试用(一)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-02-29 00:00:00 +0800">29 Feb 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在微博上看到一款叫做Zen LoadBalancer的负载均衡软件更新新闻。于是决定下载来看看，其官网地址是：<a href="http://www.zenloadbalancer.com/web/">http://www.zenloadbalancer.com/web/</a>。具体的说，是基于Debian构建的TCP/UDP负载均衡，通过perl的CGI页面完成对负载均衡的管理和监控，包括cluster功能(类似keepalived双机)。对后端real server的监控通过的是nagios-plugins里提供的check_http/check_smtp/check_ftp等一系列脚本完成的。监控通过SNMP完成，展示图像是rrd和GD::Graph。唯一没法知道的就是做负载均衡核心功能的pen这个东东，因为提供的是iso镜像，安装完后就直接有二进制文件在了，不知道这个pen到底是怎么做的……</p>
<h2 id="section">下载安装</h2>
<p>通过官网页面找到download即可，实际是托管在sf.net上。</p>
<p>安装步骤和普通的linux发行版光盘安装时一样的。作为实验，就只用电脑上的virtualbox挂载iso文件然后启动新虚拟机即可了。iso文件有225MB大，安装完成之后则是五百多兆，还是比较精简的了。</p>
<p>注意：在install的时候，会提示输入ip啊，gw啊之类的，如果有条件的话，最好就输正确的。因为在这步的时候zen就直接把输入结果写进zen配置文件而不是debian的/etc/network/interfaces了。然后每次重启zenloadbalancer都会根据zen的配置改变网络配置。</p>
<h2 id="section-1">项目路径和关键文件</h2>
<p>主要有两个启动脚本/etc/init.d/zenloadbalancer和/etc/init.d/mini_httpd，而zen的其他所有配置啊，执行文件啊，perl脚本啊，日志啊，都存放在/usr/local/zenloadbalancer目录下。</p>
<p>目录命名还算一目了然，主要有一个config和app比较混淆。</p>
<p>config里是用来存放负载均衡配置的地方，大多数情况下，这里的文件应该是通过webGUI自动生成的。包括if<em>*.conf指定网卡的(这也是唯一一个不全部由GUI生成的，如第一步所说，在install的时候会生成第一个eth0的配置)，cluster</em><em>.conf指定高可用集群的配置，</em>_farms.conf指定具体某个instance的配置(类似keepalived.conf里的一个virtual_server{}配置)。</p>
<p>app里包括了zen的主要应用，比如mini_httpd、pen、zeninotify等。其他的也没啥可看的，因为用不上改动。</p>
<p>pen里有man可以看，比较引人的就是它可以限制前后两段的链接数，包括单独设定到每个realserver的链接数。从启动脚本和man来看，应该就是类似lvs的NAT模式，不知道官网说的30000链接是社区版运行的结果，还是他们硬件版的结果~另一个比较怪异的事情是zen里带上了命令用来从realserver上获取日志，其man文档说是因为zen的负载均衡会传递给后端自己的IP，所以需要在zen收集原始ip，然后跟后端的日志合并？但是实际在运行的webGUI上看到明明有X-Forwarder-For支持。不知道是不是man没更新了？</p>
<p>mini_httpd是一个常用于嵌入式开发的webserver，支持HTTP/1.1协议，支持CGI，支持SSL。zen里就是用这个来发布其webGUI的。可以命令行参数启动，也可以写一个简单的配置文件。在我的测试中，默认配置文件启动是有问题的，每次连接都会被reset by peer。strace的结果显示mini_httpd进程fork出来的child总是异常退出。不过从配置文件里挑几个必要的参数写在命令行里启动就没问题了。</p>
<h2 id="webgui">webGUI介绍</h2>
<p>启动起来后，就可以登录操作的，默认采用了htpasswd控制访问权限，初始用户密码是admin/admin。首页是zenLB的监控图。</p>
<p>在farms的添加页里可以看到，负载均衡算法不多，就是轮训，哈希，权重，优先级。注意说明写的是每个clientIP做hash，而不是一般说的C段。而优先级的意思是：只在最高且相同优先级的server间均衡，除非都down掉了，才会指向低优先级的。</p>
<p>另外提供的功能还有：设定客户端保持时间，最大连接客户端数量，最大允许后端realserver数量，给httpheader加x-forwarder-for信息，启用nagios-plugins的外部监控等。</p>
<p>以上是tcp的配置，然后还可以具体的设置http/https的设置，注意https不是透传的，而是在zen上验证ssl，给后端的依然是http请求。</p>
<p>然后有zen自己的设置。主要有apt配置，可以添加apt源，包括zen自己的源，这样通过apt直接升级zenloadbalance。</p>
<p>然后有网卡设置。实际也就是通过ip addr命令添加咯。</p>
<p>然后有cluster设置。也就是在两台zenlb之间，通过ssh证书信任，共同使用另一个vip服务。也有master-slave抢占和slave-slave不抢占两种运行模式。两台zenlb之间，通过zenlate</p>
<p>ncy命令的UCARP服务来保持心跳，通过zeninotify传输master上的配置到slave。</p>
<p>然后还有日志、配置备份等功能……</p>
<p>页面上，还有一个和cluster VIP并列的选项是Vlan IP添加。但是在官网的指南上没看到相关内容，我点击后也没出现什么有意思的结果，怀疑会不会是未完成的功能。</p>
<p>基本上就是这样。手头没有机器给我折腾，只能笔记本电脑上解解眼馋了&hellip;</p>
      <a href="/2012/02/29/intro-zen-load-balancer" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/02/14/move-wordpress-to-github" title="从wordpress博客迁移到github记录" rel="bookmark">从wordpress博客迁移到github记录</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-02-14 00:00:00 +0800">14 Feb 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>因为原先托管wordpress博客的阿里云主机被通管局要求备案，加上通管局早令夕改的浪费我来回的快递费，于是决定搬迁到国外，github page的免费托管就此进入我的视界。</p>
<h2 id="github">第一步，申请github账号</h2>
<p>这步大同小异，想个好名字就是了。</p>
<h2 id="section">第二步，创建新项目</h2>
<p>也就是注册完毕后在页面上看到的<a href="https://github.com/repositories/new">&ldquo;New repository&rdquo;</a></p>
<p>在页面上填上项目名字。注意如果是要做博客的话，命名是有规范的，必须是yourusername.github.com这样子。</p>
<h2 id="git">第三步，设置本地git环境</h2>
<p>这步参见[&ldquo;help页面&rdquo;]:(http://help.github.com/win-set-up-git/)</p>
<h2 id="rubyjekyll">第四步，配置ruby和jekyll环境</h2>
<p>一般来说，linux设备上肯定都已经有了ruby，不过版本比较低，所以升级ruby再使用：</p>
<div class="highlight"><pre><code class="bash">    <span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c"># wget https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer</span>
    <span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c"># bash rvm-installer</span>
    <span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c"># rvm install 1.9.3</span>
    <span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c"># rvm --default 1.9.3</span>
    <span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c"># gem install jekyll</span>
</code></pre></div>
<p>这样就可以在本地运行jekyll查看博客效果了。</p>
<div class="highlight"><pre><code class="bash">    <span class="o">[</span>root@localhost youusername.github.com<span class="o">]</span><span class="c"># jekyll --server</span>
</code></pre></div>
<h2 id="section-1">第五步，创建本地博客目录</h2>
<p>这步，可以直接fork已有的github博客代码来用，比如：</p>
<div class="highlight"><pre><code class="bash">    <span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c"># git clone https://github.com/plusjade/jekyll-bootstrap.git yourusername.github.com</span>
    <span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c"># cd yourusername.github.com</span>
    <span class="o">[</span>root@localhost yourusername.github.com<span class="o">]</span><span class="c"># git remote set-url origin git@github.com:yourusername/yourusername.github.com.git</span>
    <span class="o">[</span>root@localhost yourusername.github.com<span class="o">]</span><span class="c"># git add .</span>
    <span class="o">[</span>root@localhost yourusername.github.com<span class="o">]</span><span class="c"># git commit -m &#39;first commit&#39;</span>
    <span class="o">[</span>root@localhost yourusername.github.com<span class="o">]</span><span class="c"># git push origin master</span>
</code></pre></div>
<h2 id="section-2">第六步，修改必要信息</h2>
<p>最重要的一步，创建目录下的CNAME信息，如果是fork的其他人的项目，那么修改CNAME的内容为自己的域名，比如blog.yourdomain.me。不然只能通过github的二级域名yourusername.github.com来访问了。
然后跟github无关的重要一步，上godaddy或者dnspod之类的地方，修改NS记录。注意这里，虽然上面文件叫CNAME，dns上却是要配置一个A记录，把A记录指向207.97.227.245即可。</p>
<h2 id="section-3">第七步，添加评论功能</h2>
<p>因为github提供的是一个静态页面托管，所以评论功能是需要用其他地方提供的。大家都用的是disqus的插件。所以上<a href="http://disqus.com/">disqus主页</a> 去申请一个账号吧。然后按照提示，将提供的插件代码键入_includes/post.html中&mdash;-不过一般来说，fork出来的都已经有了。</p>
<p>2012-03-16 补充：
最近也有其他的社会化第三方评论系统出现，可以使用微博、QQ来登录评论，免去上disqus注册之苦。大家可以上<a href="http://uyan.cc/getcode?index">友言</a>看看。</p>
<p>2012-04-29 补充：
今天收到友言的提示邮件，上去看了一下，其实友言是支持<a href="http://uyan.cc/setting/backup">xml导入评论</a>的。那么我们就可以把wp里的评论也一块导出来玩了：</p>
<div class="highlight"><pre><code class="perl">    <span class="c1">#!/usr/bin/perl</span>
    <span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">DBI</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">DBD::</span><span class="n">mysql</span><span class="p">;</span>
    <span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span> <span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;comments.xml&#39;</span> <span class="ow">or</span> <span class="nb">die</span> <span class="vg">$!</span><span class="p">;</span>
    <span class="k">print</span> <span class="nv">$fh</span> <span class="s">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#39;</span><span class="p">;</span> 
    <span class="k">print</span> <span class="nv">$fh</span> <span class="s">&#39;&lt;uyan xmlns=&quot;http://uyan.cc&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$dbh</span> <span class="o">=</span> <span class="n">DBI</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span><span class="s">&quot;DBI:mysql:database=blog;host=localhost;port=3306&quot;</span><span class="p">,</span> <span class="s">&quot;user&quot;</span><span class="p">,</span> <span class="s">&quot;passwd&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">RaiseError</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">});</span>
    <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="k">do</span><span class="p">(</span><span class="s">&#39;set names utf8&#39;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&#39;select p.post_title title, c.comment_author author, c.comment_author_url url, c.comment_date date, c</span>
<span class="s">    .comment_content content from wp_comments c, wp_posts p where c.comment_approved=&#39;</span><span class="mi">1</span><span class="s">&#39; and c.comment_post_ID = p.ID&#39;</span><span class="p">);</span>
    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">print</span> <span class="nv">$fh</span> <span class="s">&#39;&lt;post&gt;&lt;content&gt;&#39;</span><span class="o">.</span><span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;content&#39;</span><span class="p">}</span><span class="o">.</span><span class="s">&#39;&lt;/content&gt;&#39;</span><span class="p">;</span>
        <span class="k">print</span> <span class="nv">$fh</span> <span class="s">&#39;&lt;page_title&gt;&#39;</span><span class="o">.</span><span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;title&#39;</span><span class="p">}</span><span class="o">.</span><span class="s">&#39;&lt;/page_title&gt;&#39;</span><span class="p">;</span>
        <span class="k">print</span> <span class="nv">$fh</span> <span class="s">&#39;&lt;user_id&gt;0&lt;/user_id&gt;&#39;</span><span class="p">;</span>
        <span class="k">print</span> <span class="nv">$fh</span> <span class="s">&#39;&lt;comment_author&gt;&#39;</span><span class="o">.</span><span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;author&#39;</span><span class="p">}</span><span class="o">.</span><span class="s">&#39;&lt;/comment_author&gt;&#39;</span><span class="p">;</span>
        <span class="k">print</span> <span class="nv">$fh</span> <span class="s">&#39;&lt;time&gt;&#39;</span><span class="o">.</span><span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;date&#39;</span><span class="p">}</span><span class="o">.</span><span class="s">&#39;&lt;/time&gt;&#39;</span><span class="p">;</span>
        <span class="k">print</span> <span class="nv">$fh</span> <span class="s">&#39;&lt;from_type&gt;wordpress&lt;/from_type&gt;&#39;</span><span class="p">;</span>
        <span class="k">print</span> <span class="nv">$fh</span> <span class="s">&#39;&lt;page&gt;&#39;</span><span class="o">.</span><span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;url&#39;</span><span class="p">}</span><span class="o">.</span><span class="s">&#39;&lt;page&gt;&#39;</span><span class="p">;</span>
        <span class="k">print</span> <span class="nv">$fh</span> <span class="s">&#39;&lt;page_url&gt;&#39;</span><span class="o">.</span><span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;url&#39;</span><span class="p">}</span><span class="o">.</span><span class="s">&#39;&lt;/page_url&gt;&#39;</span><span class="p">;</span>
        <span class="k">print</span> <span class="nv">$fh</span> <span class="s">&#39;&lt;domain&gt;youdomain.com&lt;/domain&gt;&lt;/post&gt;&#39;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">print</span> <span class="nv">$fh</span> <span class="s">&#39;&lt;/uyan&gt;&#39;</span><span class="p">;</span>
</code></pre></div>
<h2 id="wordpress">第八步，导出wordpress博客文章</h2>
<p>jekyll提供了ruby脚本/usr/local/rvm/gems/ruby-1.9.3-p0/gems/jekyll-0.11.2/lib/jekyll/migrators/wordpress.rb来专门做这件事情，只需要运行如下命令即可：</p>
<div class="highlight"><pre><code class="bash">    <span class="o">[</span>root@localhost yourusername.github.com<span class="o">]</span><span class="c"># gem install sequel</span>
    <span class="o">[</span>root@localhost yourusername.github.com<span class="o">]</span><span class="c"># gem install mysql -- --with-mysql-config=/usr/bin/mysql_config</span>
    <span class="o">[</span>root@localhost yourusername.github.com<span class="o">]</span><span class="c"># ruby -rubygems -e &#39;require &quot;jekyll/migrators/wordpress&quot;; Jekyll::WordPress.process(&quot;database&quot;, &quot;user&quot;, &quot;pass&quot;)&#39;</span>
</code></pre></div>
<p>不过我这里运行有点问题，ruby又不太懂，再看完上面这个脚本的意思后，干脆放弃排错，直接用perl完成了如下这个脚本：</p>
<div class="highlight"><pre><code class="perl">    <span class="c1">#!env perl</span>
    <span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">DBI</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">DBD::</span><span class="n">mysql</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$dbh</span> <span class="o">=</span> <span class="n">DBI</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span><span class="s">&quot;DBI:mysql:database=blog;host=localhost;port=3306&quot;</span><span class="p">,</span> <span class="s">&quot;user&quot;</span><span class="p">,</span> <span class="s">&quot;passwd&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">RaiseError</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">});</span>
    <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="k">do</span><span class="p">(</span><span class="s">&#39;set names utf8&#39;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&quot;select post_title, post_name, post_date, post_content FROM wp_posts WHERE post_status = &#39;publish&#39; AND post_type = &#39;post&#39; order by id desc &quot;</span><span class="p">);</span>
    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$slug</span> <span class="o">=</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;post_name&#39;</span><span class="p">};</span>
        <span class="k">next</span> <span class="k">unless</span> <span class="nv">$slug</span> <span class="o">=~</span> <span class="sr">m/^\w/</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$title</span> <span class="o">=</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;post_title&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$date</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;post_date&#39;</span><span class="p">},</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$content</span> <span class="o">=</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;post_content&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$date</span> <span class="o">.</span> <span class="s">&#39;-&#39;</span> <span class="o">.</span> <span class="nv">$slug</span> <span class="o">.</span> <span class="s">&#39;.textile&#39;</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$header</span> <span class="o">=</span> <span class="s">&quot;---\nlayout: post\ntitle: &quot;</span> <span class="o">.</span> <span class="nv">$title</span> <span class="o">.</span> <span class="s">&quot;\ndate: &quot;</span> <span class="o">.</span> <span class="nv">$date</span> <span class="o">.</span> <span class="s">&quot;\n---\n\n&quot;</span><span class="p">;</span>
        <span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span> <span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s">&quot;$filename&quot;</span> <span class="ow">or</span> <span class="nb">die</span> <span class="vg">$!</span><span class="p">;</span>
        <span class="k">print</span> <span class="nv">$fh</span> <span class="nv">$header</span><span class="p">;</span>
        <span class="k">print</span> <span class="nv">$fh</span> <span class="s">&quot;$content\n&quot;</span><span class="p">;</span>
        <span class="nv">$fh</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">();</span>
    <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">();</span>
</code></pre></div>
<p>注意到中文url的不可读性，需要提前把wordpress的博客静态化url改成英文的。好在我一年前已经这么做了。
比较郁闷的一点是：wordpress的tag和category存放的表结构太恶心了，犹豫很久，最后放弃了导出博文对应category和tags的想法&hellip;</p>
      <a href="/2012/02/14/move-wordpress-to-github" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/02/13/using-perl-on-dotcloud" title="dotcloud试用" rel="bookmark">dotcloud试用</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-02-13 00:00:00 +0800">13 Feb 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cloud-ref" title="cloud" rel="category tag">cloud</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>dotcloud是日本的一个PAAS厂商。一年多前因为plack作者的加入推出了对perl的支持。我这几个月没事做，今天想起来试试看。用起来确实蛮舒服的。（注：大部分内容是网上已经有了的，我这只是记录一下自己的步骤）
## 第一步，申请账号</p>
<p>就跟普通的网站注册一样，填用户名密码邮箱，邮箱邮件激活——完毕。</p>
<h2 id="section">第二步，安装客户端</h2>
<p>跟安装其他python模块一样：</p>
<div class="highlight"><pre><code class="python"><span class="n">easy_install</span> <span class="n">pip</span> <span class="o">&amp;&amp;</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">dotcloud</span>
</code></pre></div>
<h2 id="section-1">第三步，个人密钥认证</h2>
<p>在dotcloud的个人主页( &ldquo;settings&rdquo;:http://www.dotcloud.com/account/settings )上就能看到个人密钥。然后在终端里输入密钥：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c"># dotcloud</span>
Enter your api key:
</code></pre></div>
<p>这个密钥就存在了~/.dotcloud/dotcloud.conf里，以后就不用再认证了。</p>
<h2 id="section-2">第四步，创建项目文件</h2>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c"># mkdir myapp-on-dotcloud &amp;&amp; cd myapp-on-dotcloud</span>
<span class="o">[</span>root@localhost myapp-on-dotcloud<span class="o">]</span><span class="c"># dotcloud create myapp-on-dotcloud</span>
<span class="o">[</span>root@localhost myapp-on-dotcloud<span class="o">]</span><span class="c"># dancer -a helloworld</span>
<span class="o">[</span>root@localhost myapp-on-dotcloud<span class="o">]</span><span class="c"># touch dotcloud.yml</span>
<span class="o">[</span>root@localhost myapp-on-dotcloud<span class="o">]</span><span class="c"># echo &quot;require &#39;bin/app.pl&#39;;&quot; &gt; helloworld/app.psgi</span>
</code></pre></div>
<p>用dotcloud命令创建项目myapp-on-dotcloud，并且在项目中运用dancer。唯一需要多加一个文件app.psgi，这个文件是云环境中psgi运行时需要读取的。</p>
<h2 id="section-3">修改云环境配置</h2>
<ul>
  <li>dotcloud.yml的配置，这相当于云环境的Basic File:</li>
</ul>
<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">www</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">perl</span>
  <span class="l-Scalar-Plain">approot</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">helloworld</span>
  <span class="l-Scalar-Plain">requirements</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Template::Toolkit</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">JSON</span>
<span class="l-Scalar-Plain">db</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mysql</span>
</code></pre></div>
<p>这个yaml文件，第一级是节点的名字，可以随意取名，主要的是type，必须是dotcloud支持的，比如静态文件的static，动态应用的perl，数据库的mysql等等。然后是approot，指定web应用的/路径。最后是requirements，不过这个也可以通过Makefile.PL文件来指明。</p>
<ul>
  <li>Makefile.PL的修改:</li>
</ul>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">ExtUtils::</span><span class="n">MakeMaker</span><span class="p">;</span>
<span class="n">WriteMakefile</span><span class="p">(</span>
    <span class="n">NAME</span>                <span class="o">=&gt;</span> <span class="s">&#39;helloworld&#39;</span><span class="p">,</span>
    <span class="n">AUTHOR</span>              <span class="o">=&gt;</span> <span class="sx">q{YOUR NAME &lt;youremail@example.com&gt;}</span><span class="p">,</span>
    <span class="n">VERSION_FROM</span>        <span class="o">=&gt;</span> <span class="s">&#39;lib/helloworld.pm&#39;</span><span class="p">,</span>
    <span class="n">ABSTRACT</span>            <span class="o">=&gt;</span> <span class="s">&#39;YOUR APPLICATION ABSTRACT&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="nv">$</span><span class="nn">ExtUtils::MakeMaker::</span><span class="nv">VERSION</span> <span class="o">&gt;=</span> <span class="mf">6.3002</span>
      <span class="p">?</span> <span class="p">(</span><span class="s">&#39;LICENSE&#39;</span><span class="o">=&gt;</span> <span class="s">&#39;perl&#39;</span><span class="p">)</span>
      <span class="p">:</span> <span class="p">()),</span>
    <span class="n">PL_FILES</span>            <span class="o">=&gt;</span> <span class="p">{},</span>
    <span class="n">PREREQ_PM</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="s">&#39;Test::More&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">&#39;YAML&#39;</span>       <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">&#39;Dancer&#39;</span>     <span class="o">=&gt;</span> <span class="mf">1.3080</span><span class="p">,</span>
        <span class="s">&#39;Plack&#39;</span>      <span class="o">=&gt;</span> <span class="mf">0.9985</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">dist</span>                <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">COMPRESS</span> <span class="o">=&gt;</span> <span class="s">&#39;gzip -9f&#39;</span><span class="p">,</span> <span class="n">SUFFIX</span> <span class="o">=&gt;</span> <span class="s">&#39;gz&#39;</span><span class="p">,</span> <span class="p">},</span>
    <span class="n">clean</span>               <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">FILES</span> <span class="o">=&gt;</span> <span class="s">&#39;helloworld-*&#39;</span> <span class="p">},</span>
<span class="p">);</span>
</code></pre></div>
<p>这个文件绝大多数是dancer命令自动创建的。唯一需要补充的一行是Plack。因为dotcloud不能自动根据dancer安装plack环境。</p>
<h2 id="section-4">第六步，上传项目，等待环境部署</h2>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@localhost myapp-on-dotcloud<span class="o">]</span><span class="c"># dotcloud push myapp-on-dotcloud</span>
</code></pre></div>
<p>然后可以看到程序首先是启动rsync命令，根据UNIX时间戳比对文件变化。上传新文件后，会根据最新的Makefile的配置安装相应的模块。最后初始化项目，创建相应的请求路由。</p>
<h2 id="section-5">第七步，检查环境数据</h2>
<p>运行dotcloud info myapp-on-dotcloud命令，即可看到如下输出：</p>
<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">db</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">mysql_masterslave</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
        <span class="l-Scalar-Plain">mysql_password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">A1BAAaAaaaA5Aa1aAAAa</span>
    <span class="l-Scalar-Plain">instances</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
    <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mysql</span>
<span class="l-Scalar-Plain">www</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/</span>
        <span class="l-Scalar-Plain">plack_env</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deployment</span>
        <span class="l-Scalar-Plain">static</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">static</span>
        <span class="l-Scalar-Plain">uwsgi_processes</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4</span>
    <span class="l-Scalar-Plain">instances</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
    <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">perl</span>
    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://myapp-on-dotcloud-user.dotcloud.com/</span>
</code></pre></div>
<p>于是我们就可以看到数据库的密码了。然后我们可以这样运用dotcloud的数据库：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@localhost helloworld<span class="o">]</span><span class="c"># dotcloud run myapp-on-dotcloud.db -- mysql -uroot -pA1BAAaAaaaA5Aa1aAAAa</span>
<span class="c"># mysql -uroot -pA1BAAaAaaaA5Aa1aAAAa</span>
Welcome to the MySQL monitor.  Commands end with ; or <span class="se">\g</span>.
Your MySQL connection id is 34
Server version: 5.1.41-3ubuntu12.10-log <span class="o">(</span>Ubuntu<span class="o">)</span>
Type <span class="s1">&#39;help;&#39;</span> or <span class="s1">&#39;\h&#39;</span> <span class="k">for </span>help. Type <span class="s1">&#39;\c&#39;</span> to clear the current input statement.
mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
+--------------------+
2 rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
mysql&gt; Bye
</code></pre></div>
<p>可以看到，创建出来的mysql节点，是带有replica功能的，而且默认没有创建项目同名的库，需要自己创建。
类似的，也可以通过ssh管理项目节点。详细的查看命令是dotcloud info raocl.www（看起来很面向对象化吧）：</p>
<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">aliases</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">myapp-on-dotcloud-user.dotcloud.com</span>
<span class="l-Scalar-Plain">build_revision</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rsync-1329106583210</span>
<span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/</span>
    <span class="l-Scalar-Plain">plack_env</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deployment</span>
    <span class="l-Scalar-Plain">static</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">static</span>
    <span class="l-Scalar-Plain">uwsgi_processes</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4</span>
<span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1329103902.969918</span>
<span class="l-Scalar-Plain">datacenter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Amazon-us-east-1a</span>
<span class="l-Scalar-Plain">image_version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">87ce0731fd95 (latest)</span>
<span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span>   <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ssh</span>
    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ssh://dotcloud@myapp-on-dotcloud-user.dotcloud.com:7478</span>
<span class="p-Indicator">-</span>   <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http</span>
    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://myapp-on-dotcloud-user.dotcloud.com/</span>
<span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">running</span>
<span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">perl</span>
</code></pre></div>
<p>这里可以清楚的看到节点是运行在amazon的EC2上的，开起来7478端口的ssh可用。当然没必要自己用ssh去链接，因为可以这样直接运行：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@localhost helloworld<span class="o">]</span><span class="c"># dotcloud ssh myapp-on-dotcloud.www</span>
<span class="c"># $SHELL</span>
dotcloud@myapp-on-dotcloud-default-www-0:~<span class="nv">$ </span>id
<span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>dotcloud<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
dotcloud@myapp-on-dotcloud-default-www-0:~<span class="nv">$ </span>w
 06:36:34 up 62 days, 21:20,  1 user,  load average: 1.26, 1.52, 2.07
USER     TTY      FROM              LOGIN@   IDLE   JCPU   PCPU WHAT
dotcloud@myapp-on-dotcloud-default-www-0:~<span class="nv">$ </span>ps auxwwf
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
dotcloud   189  0.0  0.0  70632  1556 ?        S    06:35   0:00 sshd: dotcloud@pts/0
dotcloud   190  0.0  0.0  19416  2100 pts/0    Ss   06:35   0:00  <span class="se">\_</span> /bin/bash
dotcloud   204  0.0  0.0  15292  1148 pts/0    R+   06:36   0:00      <span class="se">\_</span> ps auxwwf
dotcloud   146  0.0  0.0  42016 11608 ?        Ss   04:17   0:01 /usr/bin/python /usr/bin/supervisord.real
dotcloud   153  0.0  0.0  73500 22516 ?        S    04:17   0:00  <span class="se">\_</span> /usr/local/bin/uwsgi --pidfile /var/dotcloud/uwsgi.pid -s /var/dotcloud/uwsgi.sock --chmod-socket<span class="o">=</span>660 --master --processes 4 --psgi app.psgi --disable-logging
dotcloud   165  0.0  0.0  73500 19728 ?        S    04:17   0:00      <span class="se">\_</span> /usr/local/bin/uwsgi --pidfile /var/dotcloud/uwsgi.pid -s /var/dotcloud/uwsgi.sock --chmod-socket<span class="o">=</span>660 --master --processes 4 --psgi app.psgi --disable-logging
dotcloud   166  0.0  0.0  73500 19728 ?        S    04:17   0:00      <span class="se">\_</span> /usr/local/bin/uwsgi --pidfile /var/dotcloud/uwsgi.pid -s /var/dotcloud/uwsgi.sock --chmod-socket<span class="o">=</span>660 --master --processes 4 --psgi app.psgi --disable-logging
dotcloud   167  0.0  0.0  73500 19728 ?        S    04:17   0:00      <span class="se">\_</span> /usr/local/bin/uwsgi --pidfile /var/dotcloud/uwsgi.pid -s /var/dotcloud/uwsgi.sock --chmod-socket<span class="o">=</span>660 --master --processes 4 --psgi app.psgi --disable-logging
dotcloud   168  0.0  0.0  73500 19728 ?        S    04:17   0:00      <span class="se">\_</span> /usr/local/bin/uwsgi --pidfile /var/dotcloud/uwsgi.pid -s /var/dotcloud/uwsgi.sock --chmod-socket<span class="o">=</span>660 --master --processes 4 --psgi app.psgi --disable-logging
</code></pre></div>
<p>这下看到了，其实就是用uwsgi运行psgi程序。题外话：发现用的是supervisord做进程管理。
这个时候就可以通过http://myapp-on-dotcloud.dotcloud.com/访问到dancer的index页面了~熟悉的dancing。。。。可以看到，整个dotcloud环境是比较接近server环境的，除了上传的几个特殊文件以外，基本跟普通的dancer开发web一样。</p>
      <a href="/2012/02/13/using-perl-on-dotcloud" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/12/27/conf_run_mod_gearman" title="OMD系列(四)mod_gearman配置与运行" rel="bookmark">OMD系列(四)mod_gearman配置与运行</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-12-27 00:00:00 +0800">27 Dec 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上一篇提到了shinken，这是一个完全重写过的nagios-like系统，如果想尽可能的在原有nagios知识基础上进行高性能的分布式扩展，那么可以使用mod_gearman模块。这个模块可以从github.com上直接获取使用，地址是：
<a href="https://github.com/sni/mod_gearman">https://github.com/sni/mod_gearman</a>
当然，我们这里依然是直接采用了OMD分发的方式，事实上github上也是建议直接采用omd部署，包括升级也可以直接omd update~~（因为从源代码编译的话，在nagios3.2.2版本之前还需要打个patch才能支持eventhandler，既然都得重编译，直接搞新的得了）
在github的“How it works”和“Common Scenarios”两章节里，详细的用图例说明了mod_gearman的工作原理和各种配置情形。我这里就不重复贴了。大概的说，就是可以把nagios配置检测项中的hosts/services/eventhandlers/hostgroups/servicegroups都单独成队列，然后启动多个worker有针对性的完成队列里的任务，最后也是用单独的result队列回收检测结果。
嗯，从原理上来讲，hosts/services/eventhandlers的队列，属于load balance范围，而hostgroups/servicegroups的队列，属于distribute范围。
（mod_gearman还有send_gearman程序用来load balance接收NSCA分布式监控程序的数据，这里就不说了）</p>
<hr />
<p>概念讲完了，现在说配置。
要启用mod_gearman，方法和上篇启用shinken一样简单，运行omd config命令，在Distribute选项中选择Mod_gearman为on，然后omd start即可。
注意，omd分发中只带了mod_gearman.so和client/worker/init脚本，你必须自己yum install gearmand安装jobserver才行。
在配置完成重启动的时候，OMD就会自动的修改nagios.cfg里的broker_module配置为：</p>
<div class="highlight"><pre><code class="bash"> <span class="nv">broker_module</span><span class="o">=</span>.../mod_gearman.o <span class="nv">server</span><span class="o">=</span>localhost:4730 <span class="nv">eventhandler</span><span class="o">=</span>yes <span class="nv">services</span><span class="o">=</span>yes <span class="nv">hosts</span><span class="o">=</span>yes
</code></pre></div>
<p>同时启动1个</p>
<div class="highlight"><pre><code class="bash"> /omd/sites/monitor/version/sbin/gearmand --port<span class="o">=</span>4730 --pid-file<span class="o">=</span>/omd/sites/monitor/tmp/run/gearmand.pid --daemon --job-retries<span class="o">=</span>0 --threads<span class="o">=</span>10 --log-file<span class="o">=</span>/omd/sites/monitor/var/log/gearman/gearmand.log --verbose<span class="o">=</span>2 --listen<span class="o">=</span>localhost
</code></pre></div>
<p>老文章里写的gearmand默认端口都是7003，因为跟AFS冲突，所以现在的版本默认都是4730了；
同时启动3个</p>
<div class="highlight"><pre><code class="bash">/omd/sites/monitor/bin/mod_gearman_worker -d --config<span class="o">=</span>/omd/sites/monitor/etc/mod-gearman/worker.cfg --pidfile<span class="o">=</span>/omd/sites/monitor/tmp/run/gearman_worker.pid
</code></pre></div>
<p>OK，现在这5个worker，会由gearmand平均分配hosts/services/eventhandlers任务。一个基础的load balance就完成了。</p>
<hr />
<p>下一步就是前面命令里用到了的~/etc/mod-gearman/worker.cfg配置文件了。</p>
<div class="highlight"><pre><code class="bash">    <span class="nv">debug</span><span class="o">=</span>0
    <span class="nv">config</span><span class="o">=</span>/omd/sites/monitor/etc/mod-gearman/port.conf
    <span class="nv">eventhandler</span><span class="o">=</span>yes
    <span class="nv">services</span><span class="o">=</span>yes
    <span class="nv">hosts</span><span class="o">=</span>yes
    <span class="c">#hostgroups=name2,name3</span>
    <span class="c">#servicegroups=name1,name2,name3</span>
    <span class="nv">encryption</span><span class="o">=</span>yes
    <span class="nv">keyfile</span><span class="o">=</span>/omd/sites/monitor/etc/mod-gearman/secret.key
    <span class="nv">logfile</span><span class="o">=</span>/omd/sites/monitor/var/log/gearman/worker.log
    min-worker<span class="o">=</span>3
    max-worker<span class="o">=</span>50
    idle-timeout<span class="o">=</span>10
    max-jobs<span class="o">=</span>500
    spawn-rate<span class="o">=</span>1
    <span class="nv">fork_on_exec</span><span class="o">=</span>no
    <span class="nv">show_error_output</span><span class="o">=</span>yes
    <span class="nv">workaround_rc_25</span><span class="o">=</span>off
</code></pre></div>
<p>以上是默认生成的配置文件。主要是定义最小的worker数量，最大的worker数量，最多运行的任务数量，等待超时时间，有等待任务时派生新worker的速度，是否为每个插件采用fork方式执行（这里注释写的是默认yes，但是OMD生成配置默认却是no，不知为何）；另一部分配置就是关于lb和dist的了：hosts/services/eventhandlers的yes/no控制是否lb，hostgroups/servicegroups控制dist哪些group到具体的worker上。
假设我们现在有3个servicegroup，分别叫name1/name2/name3，那么开启选项后运行omd reload命令。查看gearmand的状态如下：</p>
<div class="highlight"><pre><code class="bash">    OMD<span class="o">[</span>monitor<span class="o">]</span>:~<span class="nv">$ </span>telnet 127.0.0.1 4730
    Trying 127.0.0.1...
    Connected to localhost <span class="o">(</span>127.0.0.1<span class="o">)</span>.
    Escape character is <span class="s1">&#39;^]&#39;</span>.
    status
    check_results	0	0	1
    worker_localhost	0	0	1
    servicegroup_name1	0	0	3
    servicegroup_name2	0	0	3
    servicegroup_name3	0	0	3
    host	0	0	3
    service	0	0	3
    eventhandler	0	0	3
    dummy	0	0	5
    .
</code></pre></div>
<p>表示有3个worker注册在gearman的这几个任务下了。
（如果不用OMD，那么上面这些修改配置，分别启动worker指定不同配置等等动作，都要自己完成，参见github里的Installation章节From Source部份）</p>
      <a href="/2011/12/27/conf_run_mod_gearman" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/12/20/shinken_discovery_runner" title="OMD系列(三)shinken的discovery配置与运行" rel="bookmark">OMD系列(三)shinken的discovery配置与运行</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-12-20 00:00:00 +0800">20 Dec 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上篇说到OMD的可以通过omd config选择core，有nagios和shinken两个选项。shinken是一个完全重写的监控系统，但是在外部接口上，又是nagios-like的，甚至可以单纯的只用shinken的WebUI给nagios使。所以OMD作为nagios周边的项目，也就把shinken加入到core选项里了。
不过经过试验发现，虽然omd的rpm是针对centos5.5的，代码中调用的有些命令版本却比较高，比如nmap命令使用了&ndash;traceroute选项，查ChangeLog发现是4.76版才加上的，而centos5上面的还是4.11版，所以要重新安装：</p>
<div class="highlight"><pre><code class="bash">wget http://nmap.org/dist/nmap-5.51-1.x86_64.rpm
yum remove nmap
yum install --nogpgcheck nmap-5.51-1.x86_64.rpm
</code></pre></div>
<p>又比如python，centos5默认安装的是2.4版，而nmap_parser中调用了2.5版才有的xml.tree.elementtree模块，所以也要升级。</p>
<div class="highlight"><pre><code class="bash">wget http://www.python.org/ftp/python/2.7.2/Python-2.7.2.tgz
tar zxvf Python-2.7.2.tgz
<span class="nb">cd </span>Python-2.7.2
./configure --prefix<span class="o">=</span>/usr/local/python2.7
make -j
make install
rm -f /usr/bin/python
<span class="c">#alternatives命令之前博客有介绍，其实就是文雅一点的替你做软连接和版本路径记录。</span>
<span class="c">#切换的时候用alternatives --config python命令选择就可以了。</span>
alternatives --install /usr/bin/python python /usr/local/python2.7/bin/python 1000
alternatives --install /usr/bin/python python /usr/bin/python2.4 500
wget http://peak.telecommunity.com/dist/ez_setup.py
python ez_setup.py
/usr/local/python2.7/bin/easy_install ElementTree
</code></pre></div>
<p>然后就可以试试nmap_discovery_runner.py和vmware_discovery_runner.py了。
命令行方式运行如下：</p>
<div class="highlight"><pre><code class="bash">/opt/omd/sites/dyxmonitor/lib/shinken/libexec/nmap_discovery_runner.py -t 127.0.0.1
Got our target <span class="o">[</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="o">]</span>
propose a tmppath /tmp/tmppTYexK
Launching <span class="nb">command</span>, sudo nmap 127.0.0.1 -T4 -O --traceroute -oX /tmp/tmppTYexK
Try to communicate
Got it <span class="o">(</span><span class="s1">&#39;\nStarting Nmap 5.51 ( http://nmap.org ) at 2011-12-20 15:45 CST\nNmap scan report for localhost (127.0.0.1)\nHost is up (0.000030s latency).\nNot shown: 995 closed ports\nPORT     STATE SERVICE\n22/tcp   open  ssh\n80/tcp   open  http\n111/tcp  open  rpcbind\n631/tcp  open  ipp\n3306/tcp open  mysql\nDevice type: general purpose\nRunning: Linux 2.6.X\nOS details: Linux 2.6.15 - 2.6.31\nNetwork Distance: 0 hops\n\nOS detection performed. Please report any incorrect results at http://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 2.05 seconds\n&#39;</span>, <span class="s1">&#39;&#39;</span><span class="o">)</span>
Can be <span class="o">(</span><span class="s1">&#39;Linux&#39;</span>, <span class="s1">&#39;2.6.X&#39;</span>, <span class="s1">&#39;100&#39;</span><span class="o">)</span>
Try to match <span class="o">(</span><span class="s1">&#39;Linux&#39;</span>, <span class="s1">&#39;2.6.X&#39;</span><span class="o">)</span>
localhost::isup<span class="o">=</span>1
localhost::os<span class="o">=</span>linux
localhost::osversion<span class="o">=</span>2.6.X
localhost::macvendor<span class="o">=</span>
localhost::openports<span class="o">=</span>22,80,111,631,3306
localhost::fqdn<span class="o">=</span>localhost
localhost::ip<span class="o">=</span>127.0.0.1
</code></pre></div>
<p>从输出中可以看到使用的nmap运行参数，主要是-O扫描操作系统，-T4指定快速，-oX指定输出成xml，然后用python去解析xml文件就是了。
然后运行omd的命令：</p>
<div class="highlight"><pre><code class="bash">su - monitor
mkdir -p etc/shinken/objects/discovery
shinken-discovery -o /omd/sites/monitor/etc/shinken/objects/discovery -r nmap -c /omd/sites/monitor/etc/shinken/shinken-discovery.d/discovery.cfg
</code></pre></div>
<p>然后发现新错误：在import shinken和multiprocessing的时候有问题。
因为etc/environment中需要定义PYTHONPATH=/omd/sites/monitor/lib/python:/omd/sites/monitor/lib/shinken:/usr/local/py2.7/lib/python2.7
而且，因为在/omd/sites/monitor/lib/python中有multiprocessing-2.6.2.1-py2.4-linux-x86_64.egg的存在，所以导致python2.7加载py2.4的multiprocessing失败，删除掉这个目录后，让python自动加载python2.7/lib下的multiprocessing，就可以了——当然，需要先easy_install multiprocessing才有。
等一会，在objects/discovery目录下给每个live的ip创建了一个文件夹，里面是host和service的cfg配置——但是因为~/bin/shinken-discovery脚本里的写法比较简单，生成的cfg里直接指定了template就是generic-host/service，然后除了description、command和host_name之外啥都木有……所以必须提前自己定义好一个模板。
OMD的监控配置文件指定位置是~/etc/nagios/conf.d/，所以扫描之后，还需要整合cfg到这个目录下。</p>
<hr />
<p>最后，shinken里有bottle框架的一个webui，但是我一直没找到如何运行……shinken-specific.d/module_webui.cfg里倒是有module定义：</p>
<div class="highlight"><pre><code class="bash">define module<span class="o">{</span>
    module_name      WebUI
    module_type      webui
    host             0.0.0.0       ; mean all interfaces
    port             7767
    auth_secret      CHANGE_ME
    modules          Apache_passwd
<span class="o">}</span>
define module<span class="o">{</span>
    module_name      Apache_passwd
    module_type      passwd_webui
    passwd           /omd/sites/dyxmonitor/etc/htpasswd
<span class="o">}</span>
</code></pre></div>
<p>但是启动后没有看到7767端口，也没有看到任何报错——这是最让我郁闷的一点，折腾三天，全部排错都靠strace而木有log。。。
所以最后还是用另一个nagios界面，trunk来启动web。trunk是一个基于perl的catalyst框架完成的页面。而omd自带了一个不小的perl5lib……这里又需要注意了：</p>
<ol>
  <li>OMD安装时，会自动配置一个$PERL5LIB变量，但是不知道为啥会把**/x86<em>64-linux-thread-multi记成**/x86</em>64-linux，所以需要在~/etc/environment中自己重新写一次PERL5LIB。</li>
  <li>因为centos5.4自带的perl版本是5.8.8；如果像我这样自己又另外安装了更高版本的perl，比如5.14.2，那么omd自带的这些perl5lib会有&rdquo;undefined symbol: Perl_Gthr_key_ptr&rdquo;的错误。所以老老实实用perl5.8.8好了……</li>
</ol>
<p>说老实话，觉得trunk跟classic nagios的页面没什么不同……</p>
      <a href="/2011/12/20/shinken_discovery_runner" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/12/20/omd_configurations_basic" title="OMD系列(二)基础配置和目录介绍" rel="bookmark">OMD系列(二)基础配置和目录介绍</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-12-20 00:00:00 +0800">20 Dec 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>话接上篇，在su和omd start之后，可以看到挂载的一个目录。其/omd是/opt/omd的软连接。目录结构如下：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>monitor@localhost tmp<span class="o">]</span><span class="nv">$ </span>ll /opt/omd/sites/dyxmonitor/
total 12
lrwxrwxrwx  1 monitor dyxmonitor   11 Dec 19 18:15 bin -&gt; version/bin
drwxr-xr-x 21 monitor dyxmonitor 4096 Dec 19 18:15 etc
lrwxrwxrwx  1 monitor dyxmonitor   15 Dec 19 18:15 include -&gt; version/include
lrwxrwxrwx  1 monitor dyxmonitor   11 Dec 19 18:15 lib -&gt; version/lib
drwxr-xr-x  5 monitor dyxmonitor 4096 Dec 19 18:15 <span class="nb">local</span>
lrwxrwxrwx  1 monitor dyxmonitor   13 Dec 19 18:15 share -&gt; version/share
drwxr-xr-x 14 monitor dyxmonitor  300 Dec 19 23:32 tmp
drwxr-xr-x 12 monitor dyxmonitor 4096 Dec 19 18:15 var
lrwxrwxrwx  1 monitor dyxmonitor   19 Dec 19 18:15 version -&gt; ../../versions/0.50
</code></pre></div>
<p>软连接的部分，都是所有omd共用的；tmp就是挂载的tmpfs用来加速数据读写的；var是日志和由前端生成的数据(比如rrd)存放地点；etc是配置文件存放地点，具体内容包括：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>monitor@localhost etc<span class="o">]</span><span class="nv">$ </span>ls
apache       cron.d       htpasswd  logrotate.conf  mod-gearman  nsca        rc.d            thruk
check_mk     dokuwiki     init.d    logrotate.d     nagios       omd         rrdcached.conf  xinetd.conf
check_multi  environment  jmx4perl  mk-livestatus   nagvis       pnp4nagios  shinken         xinetd.d
</code></pre></div>
<p>其中，htpasswd定义了auth的用户名密码，默认是omdadmin:omd；
rrdcached.conf定义了rrdcached的过期时间，用来缓解rrdtools的压力；
apache/mode.conf是/opt/omd/apache/monitor.conf里Include的文件，实质是apache/apache-own.conf的软连接；调用了apache/proxy-port.conf来反向代理5000端口的实质页面。
apache/apache.conf是真正的5000端口运行的配置文件，里面Include了apache/conf.d/*.conf——这些conf都是外面不同插件目录里的apache.conf的软连接：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>monitor@localhost conf.d<span class="o">]</span><span class="nv">$ </span>ll
total 24
-rw-r--r-- 1 monitor monitor 119 Dec 19 18:15 01_python.conf
-rw-r--r-- 1 monitor monitor 482 Dec 19 18:15 02_fcgid.conf
-rw-r--r-- 1 monitor monitor 252 Dec 19 18:15 auth.conf
lrwxrwxrwx 1 monitor monitor  26 Dec 19 18:15 check_mk.conf -&gt; ../../check_mk/apache.conf
lrwxrwxrwx 1 monitor monitor  26 Dec 19 18:15 dokuwiki.conf -&gt; ../../dokuwiki/apache.conf
lrwxrwxrwx 1 monitor monitor  25 Dec 19 23:29 nagios.conf -&gt; ../../shinken/apache.conf
lrwxrwxrwx 1 monitor monitor  24 Dec 19 18:15 nagvis.conf -&gt; ../../nagvis/apache.conf
-rw-r--r-- 1 monitor monitor 519 Dec 19 18:15 omd.conf
lrwxrwxrwx 1 monitor monitor  28 Dec 19 18:15 pnp4nagios.conf -&gt; ../../pnp4nagios/apache.conf
-rw-r--r-- 1 monitor monitor 117 Dec 19 18:15 site.conf
lrwxrwxrwx 1 monitor monitor  23 Dec 19 18:15 thruk.conf -&gt; ../../thruk/apache.conf
-rw-r--r-- 1 monitor monitor 283 Dec 19 18:15 var_www.conf
</code></pre></div>
<p>另外，在etc下还有omd/site.conf配置文件。这是本site的主配置文件，看起来可能不太清楚，所以omd提供了更直观的修改办法，那就是仿UI的omd config命令：
<img src="/images/uploads/omd.png" alt="" title="omd" width="300" height="173" class="alignnone size-medium wp-image-2830" />
通过这种类似setup的方式直接搞定就可以了。
默认情况下，web页面的首页访问url地址是/monitor/omd/，这个页面上列出了classic nagios、check_mk、nagvis、pnp4nagios和dokuwiki的访问效果截图和地址，可以点击进入查看。然后再用omd config定义Web UI的default选择就是了。一旦定义完成，配置会自动修改，下次再访问/monitor/omd/，就会自动跳转了。
注：/monitor/是因为我create的site名字是monitor
另，修改config后，发现mod_gearman不可用。原因是omd的rpm发布里没有带gearmand的实现，必须自己另外搞定gearman的jobserver~~</p>
      <a href="/2011/12/20/omd_configurations_basic" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/12/19/omd_intro_install_on_centos5" title="OMD系列(一)简介与安装" rel="bookmark">OMD系列(一)简介与安装</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-12-19 00:00:00 +0800">19 Dec 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>OMD，全称Open Monitoring Distribution，是一个围绕Nagios core构建的分布式开源监控集。在nagios基础上融合了NRPE、NSCA、check_mk、mod_gearman、pnp4nagios、nagvis、rrdcached等插件，以完成高性能的、可视化的，分权限管理的监控系统。
（我是在看mod_gearman的安装介绍时看到的，感觉这种一体式的安装很爽）
项目主页是<a href="http://omdistro.org" target="_blank">http://omdistro.org</a>，提供了rh、debian、suse和src各种安装模式。
比如在centos5上面，只需要简单的操作即可：</p>
<div class="highlight"><pre><code class="bash">rpm -Uvh http://download.fedora.redhat.com/pub/epel/5/i386/epel-release-5-4.noarch.rpm
<span class="c">#单独装graphviz是因为epel里的版本有冲突</span>
yum install graphviz-gd.x86_64
<span class="c">#已经有rhel6上的版本，而5.4提供最高只到0.45，mod_gearman从0.48才加入，所以试试5.5的，发现也没问题~~</span>
yum install --nogpgcheck http://omdistro.org/attachments/download/121/omd-0.50-rh55-25.x86_64.rpm
</code></pre></div>
<p>然后运行omd create monitor即可。
omd会自动在linux系统上添加一个monitor用户，然后其他操作可以在su - monitor后再继续，这样比较安全，而且可以看到的是，create的时候，还挂载了tmpfs到/omd/sites/monitor/tmp，以提供更高的性能。
切换到monitor用户后，运行omd start，即可启动。
先写到这里，慢慢看具体配置。</p>
      <a href="/2011/12/19/omd_intro_install_on_centos5" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/12/19/intro_open_flash_chart" title="Chart::OFC试用" rel="bookmark">Chart::OFC试用</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-12-19 00:00:00 +0800">19 Dec 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>这几天ppt看的比较多，一样一样来玩。今天先说OFC，之前有试过amcharts和fusioncharts。amcharts最全最漂亮（尤其是有scroll和map），可惜图上都自动标上了amcharts.com的字样；fusioncharts的free版本，也蛮好用的，虽然scroll怪怪的居然靠的是点击控制。比较相同的一点就是，这两都只提供了php、python等的模块，如果是perl写的网页，那只能通过提供xml/json数据给js控制的办法。稍微一点点遗憾……
这次在cpan上终于看到一个chart控制的模块，叫Chart::OFC。这个OFC的项目地址如下：
<a href="http://teethgrinder.co.uk/open-flash-chart/" target="_blank">http://teethgrinder.co.uk/open-flash-chart/</a>
其实用法上没什么特殊，无非是省略一点点xml代码，通过OO的方式自动生成而已。让我觉得蛮好玩的是官网上作者的声明。因为他曾经在维护公司一个付费的flash chart项目时，给甲方发信要求修改bug，等了一个月没反应。于是自己现学as语言开始自己搞= =！然后念念不忘的提示说：要重视客户的反馈。。。。。。哈哈
这个项目目前用as3改写，所以新版本叫OFC2了，不过作者自己也说不太稳定，建议继续用OFC1.9.7，所以先不说Chart::OFC2，继续用Chart::OFC好了：</p>
<div class="highlight"><pre><code class="perl"><span class="n">get</span> <span class="s">&#39;/ofc_data&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">use</span> <span class="nn">Chart::</span><span class="n">OFC</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$line_array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">..</span> <span class="mi">20</span><span class="p">];</span>
    <span class="k">my</span> <span class="nv">$bars_array</span><span class="p">;</span> <span class="nv">@$bars_array</span> <span class="o">=</span> <span class="nb">map</span> <span class="p">{</span><span class="nv">$_</span> <span class="o">-</span> <span class="mf">2.5</span><span class="p">}</span> <span class="nv">@$line_array</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$leng</span> <span class="o">=</span> <span class="nv">$#$line_array</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$bars</span> <span class="o">=</span> <span class="nn">Chart::OFC::Dataset::</span><span class="n">Bar</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="nb">values</span> <span class="o">=&gt;</span> <span class="nv">$bars_array</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="nn">Chart::OFC::Dataset::</span><span class="n">Line</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="nb">values</span> <span class="o">=&gt;</span> <span class="nv">$line_array</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$x_axis</span> <span class="o">=</span> <span class="nn">Chart::OFC::</span><span class="n">XAxis</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">axis_label</span> <span class="o">=&gt;</span> <span class="s">&#39;X Axis&#39;</span><span class="p">,</span> <span class="n">label_steps</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tick_steps</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=&gt;</span> <span class="nv">$line_array</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$y_axis</span> <span class="o">=</span> <span class="nn">Chart::OFC::</span><span class="n">YAxis</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">axis_label</span> <span class="o">=&gt;</span> <span class="s">&#39;Y Axis&#39;</span><span class="p">,</span> <span class="n">max</span> <span class="o">=&gt;</span> <span class="nv">$leng</span><span class="p">,</span> <span class="n">label_steps</span> <span class="o">=&gt;</span> <span class="mi">2</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$grid</span> <span class="o">=</span> <span class="nn">Chart::OFC::</span><span class="n">Grid</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">title</span>    <span class="o">=&gt;</span> <span class="s">&#39;My Grid Chart&#39;</span><span class="p">,</span>
                                      <span class="n">datasets</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="nv">$bars</span><span class="p">,</span> <span class="nv">$line</span> <span class="p">],</span>
                                      <span class="n">x_axis</span>   <span class="o">=&gt;</span> <span class="nv">$x_axis</span><span class="p">,</span>
                                      <span class="n">y_axis</span>   <span class="o">=&gt;</span> <span class="nv">$y_axis</span><span class="p">,</span>
                                    <span class="p">);</span>
    <span class="k">return</span> <span class="nv">$grid</span><span class="o">-&gt;</span><span class="n">as_ofc_data</span><span class="p">();</span>
<span class="p">};</span>
<span class="n">get</span> <span class="s">&#39;/ofc_test&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">template</span> <span class="s">&#39;ofc&#39;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>然后ofc.tt是这样：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;content-type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;/ofc/js/swfobject.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;my_chart&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
<span class="kd">var</span> <span class="nx">so</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SWFObject</span><span class="p">(</span><span class="s2">&quot;/ofc/actionscript/open-flash-chart.swf&quot;</span><span class="p">,</span> <span class="s2">&quot;ofc&quot;</span><span class="p">,</span> <span class="s2">&quot;500&quot;</span><span class="p">,</span> <span class="s2">&quot;200&quot;</span><span class="p">,</span> <span class="s2">&quot;9&quot;</span><span class="p">,</span> <span class="s2">&quot;#FFFFFF&quot;</span><span class="p">);</span>
<span class="nx">so</span><span class="p">.</span><span class="nx">addVariable</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;/ofc_data&quot;</span><span class="p">);</span>
<span class="nx">so</span><span class="p">.</span><span class="nx">addParam</span><span class="p">(</span><span class="s2">&quot;allowScriptAccess&quot;</span><span class="p">,</span> <span class="s2">&quot;always&quot;</span> <span class="p">);</span><span class="c1">//&quot;sameDomain&quot;);</span>
<span class="nx">so</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;my_chart&quot;</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;div&gt;</span>boo<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>运行即可。
这里chart主要分两种，pie和grid。
bar和line都是grid的。Chart::OFC的pod里举例是pie的，我这里写的举例是grid的，来自Chart::OFC::Grid的说明；
在DataSet中可以看到，area、candle和scatter都是从Line.pm模块extends出来的（嗯，这个模块是用Moose构建滴），所以具体生成的时候都是用grid。
<img src="/images/uploads/ofc.png" alt="" title="ofc" width="600" height="240" class="alignnone size-full wp-image-2824" /></p>
<hr />
<p>另外，CPAN上还有一个模块是给XML/SWF Chart生成数据的，不过那个东东也是要buy滴……
再另，有木有仪表盘的charts可用呢……</p>
      <a href="/2011/12/19/intro_open_flash_chart" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/12/15/learning_dancer_plugin_simplecrud" title="Dancer::Plugin::SimpleCRUD模块学习" rel="bookmark">Dancer::Plugin::SimpleCRUD模块学习</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-12-15 00:00:00 +0800">15 Dec 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Dancer圣临历中介绍了一个新插件Dancer::Plugin::SimpleCRUD。可以很快的生成对数据库表的create/read/update/delete。大概阅读了一下代码。主要就是使用HTML::FromDatabase模块生成read的页面，用CGI::FormBuilder模块生成create/update/delete的页面，用Dancer::Plugin::Database::Handle模块操作数据库。因为是Simple，所以html代码都是固定的，不甚美观。但是思路可以学习，通过这两个模块，可以自己结合Dancer的template系统做CRUD了。
先来说HTML::FromDatabase模块，这个只涉及select，所以特别简单：</p>
<div class="highlight"><pre><code class="perl"><span class="n">any</span> <span class="p">[</span><span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="s">&#39;post&#39;</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="s">&#39;/add/:element&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$element</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;element&#39;</span><span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">method</span> <span class="ow">eq</span> <span class="s">&#39;GET&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&quot;select * from $element&quot;</span><span class="p">);</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">();</span>
        <span class="k">my</span> <span class="nv">$table</span> <span class="o">=</span> <span class="nn">HTML::Table::</span><span class="n">FromDatabase</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="o">-</span><span class="n">sth</span> <span class="o">=&gt;</span> <span class="nv">$sth</span> <span class="p">)</span><span class="o">-&gt;</span><span class="n">getTable</span><span class="p">;</span>
        <span class="n">template</span> <span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">table</span> <span class="o">=&gt;</span> <span class="nv">$table</span> <span class="p">};</span>
    <span class="p">};</span>
<span class="o">...</span>
<span class="p">};</span>
</code></pre></div>
<p>这样就可以了，getTable方法的返回是一个字符串(内容就是table/tr/td代码)，直接传递给tmpl就行了~~
然后看CGI::FromBuilder模块：</p>
<div class="highlight"><pre><code class="perl"><span class="n">any</span> <span class="p">[</span><span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="s">&#39;post&#39;</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="s">&#39;/add/:element&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$element</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;element&#39;</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$paramsobj</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">method</span> <span class="ow">eq</span> <span class="s">&#39;POST&#39;</span> <span class="p">?</span> <span class="p">{</span> <span class="n">params</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">params</span><span class="p">()</span> <span class="p">}</span> <span class="p">}</span> <span class="p">:</span> <span class="nb">undef</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@fields</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$element</span> <span class="ow">eq</span> <span class="s">&#39;food&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">@fields</span> <span class="o">=</span> <span class="sx">qw/fid name shelf/</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$element</span> <span class="ow">eq</span> <span class="s">&#39;market&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">@fields</span> <span class="o">=</span> <span class="sx">qw/mid name location/</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="nv">$element</span> <span class="ow">eq</span> <span class="s">&#39;price&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">@fields</span> <span class="o">=</span> <span class="sx">qw/fid mid price time/</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Error element&quot;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">my</span> <span class="nv">$form</span> <span class="o">=</span> <span class="nn">CGI::</span><span class="n">FormBuilder</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="n">params</span> <span class="o">=&gt;</span> <span class="nv">$paramsobj</span><span class="p">,</span>
        <span class="n">fields</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@fields</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&quot;select * from $element order by fid desc&quot;</span><span class="p">);</span>
    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$default_hashref</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$action</span> <span class="o">=</span> <span class="nv">$default_hashref</span> <span class="p">?</span> <span class="s">&#39;update&#39;</span> <span class="p">:</span> <span class="s">&#39;insert&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">method</span> <span class="ow">eq</span> <span class="s">&#39;POST&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="n">submitted</span> <span class="o">&amp;&amp;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="n">validate</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$success</span> <span class="o">=</span> <span class="n">database</span><span class="o">-&gt;</span><span class="n">quick_update</span><span class="p">(</span><span class="s">&quot;$element&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">name</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">}},</span> <span class="p">{</span><span class="n">shelf</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;shelf&#39;</span><span class="p">}</span> <span class="p">});</span>
        <span class="n">redirect</span> <span class="s">&quot;/add/$element&quot;</span> <span class="k">if</span> <span class="nv">$success</span><span class="p">;</span>
        <span class="k">return</span> <span class="s">&quot;update error&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="c1">#        return $form-&gt;render(values =&gt; $default_hashref,</span>
        <span class="k">my</span> <span class="nv">$hash</span> <span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="nb">values</span> <span class="o">=&gt;</span> <span class="nv">$default_hashref</span><span class="p">,</span>
                             <span class="n">title</span>  <span class="o">=&gt;</span> <span class="nv">$element</span><span class="p">,</span>
                             <span class="n">action</span> <span class="o">=&gt;</span> <span class="s">&quot;/add/$element&quot;</span><span class="p">,</span>
                             <span class="n">method</span> <span class="o">=&gt;</span> <span class="s">&quot;post&quot;</span><span class="p">,</span>
                            <span class="p">);</span>
        <span class="n">template</span> <span class="s">&#39;crud&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">hash</span> <span class="o">=&gt;</span> <span class="nv">$hash</span><span class="p">,</span> <span class="p">};</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>这里的关键，就是$paramsobj变量。否则无法区分GET和POST的。
和HTML::FromDatabase一样，有个render()直接返回内容是组装好的html代码的字符串；另外，CGI::FormBuilder模块还提供一个prepare()方法，返回的是hash——因为render()返回的html代码是完整的html/head/body&hellip;（事实上CGI::FormBuilder模块的构造器还提供指定js函数和css格式的参数）；所以如果要加进template里，可以把prepare()返回的hash传递给tmpl去操作！
然后还发现一个小问题，如果table里一条数据都没有，fields为undef，模块运行有问题的……
最后，<em>quick_update()是Dancer::Plugin::Database::Handle模块里提供的，这个模块里提供了一系列_quick</em>*()方法，用来快速操作数据库。</p>
      <a href="/2011/12/15/learning_dancer_plugin_simplecrud" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/12/12/nginx_perl_demo" title="nginx_perl试用" rel="bookmark">nginx_perl试用</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-12-12 00:00:00 +0800">12 Dec 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>因为空闲时间比较多，所以在CPAN上乱翻，看到了nginx_perl这个项目(原名Nginx::Engine)，现在托管在github.com上。地址见：
https://github.com/zzzcpan/nginx-perl
这个模块的目的，是在nginx内置官方perl模块的基础上，实现一系列异步非阻塞的api。用connector/writer/reader完成类似proxy的功能（这里因为是交给perl完成，所以不单单局限在http上了），用take_connection/give_connection完成类似websocket的功能，用ssl_handshaker完成ssl的解析，用timer完成定时器，用resolver完成域名解析…使用方法简单来说，就是用main_count_inc/finalize_request控制计数器，用NGX_READ/NGX_WRITE/NGX_CLOSE等控制callback。
其他内容和apache的mod_perl，或者nginx.org的perl类似。最新版的POD地址如下：
http://zzzcpan.github.com/nginx-perl/Nginx.html
最后举例一个自己写的简单的例子：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="n">HelloWorld</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Nginx</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="c1">#用来在nginx启动的时候做的事情，这里单纯显示一下</span>
<span class="k">sub </span><span class="nf">init_worker</span> <span class="p">{</span>
    <span class="nb">warn</span> <span class="s">&#39;nginx_perl start [OK]&#39;</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">#这里是nginx的http模块中调用的handler，alexander有计划改成tcp级别的</span>
<span class="k">sub </span><span class="nf">handler</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$r</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
<span class="c1">#增加主循环的计数器</span>
    <span class="nv">$r</span><span class="o">-&gt;</span><span class="n">main_count_inc</span><span class="p">;</span>
<span class="c1">#使用非阻塞的连接器连接127.0.0.1的80端口，10秒超时</span>
    <span class="n">ngx_connector</span> <span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
<span class="c1">#如果连接出问题，会记录在$!中</span>
        <span class="k">if</span> <span class="p">(</span><span class="vg">$!</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$r</span><span class="o">-&gt;</span><span class="n">send_http_header</span><span class="p">(</span><span class="s">&#39;text/html&#39;</span><span class="p">);</span>
            <span class="nv">$r</span><span class="o">-&gt;</span><span class="k">print</span><span class="p">(</span><span class="s">&quot;Connection failed, $!\n&quot;</span><span class="p">);</span>
            <span class="nv">$r</span><span class="o">-&gt;</span><span class="n">send_special</span><span class="p">(</span><span class="n">NGX_HTTP_LAST</span><span class="p">);</span>
<span class="c1">#不管怎么处理这次连接，最后一定要记得用$r-&gt;finalize_request()，会decrease之前$r-&gt;main_count_inc;里加上的计数。</span>
            <span class="nv">$r</span><span class="o">-&gt;</span><span class="n">finalize_request</span><span class="p">(</span><span class="n">NGX_OK</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">NGX_CLOSE</span><span class="p">;</span>
        <span class="p">};</span>
<span class="c1">#返回$c是建立的连接</span>
        <span class="k">my</span> <span class="nv">$c</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$req_buf</span> <span class="o">=</span> <span class="s">&quot;GET /index.php HTTP/1.0\x0d\x0a&quot;</span><span class="o">.</span>
              <span class="s">&quot;Host: chenlinux.com\x0d\x0a&quot;</span><span class="o">.</span>
              <span class="s">&quot;Connection: close\x0d\x0a&quot;</span><span class="o">.</span>
              <span class="s">&quot;\x0d\x0a&quot;</span><span class="p">;</span>
<span class="c1">#这里记住定义buffer的时候不要搞成undef了，会报段错误的，不过俄国佬回信说他修复了</span>
        <span class="k">my</span> <span class="nv">$res_buf</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
<span class="c1">#非阻塞写入，超时10秒</span>
        <span class="n">ngx_writer</span> <span class="nv">$c</span><span class="p">,</span> <span class="nv">$req_buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="vg">$!</span><span class="p">)</span> <span class="p">{</span>
                 <span class="o">......</span>
            <span class="p">};</span>
            <span class="nv">$req_buf</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
<span class="c1">#之前的buffer测试就是这里，如果加一个warn，就不会报错……汗</span>
<span class="c1">#warn &quot;$req_buf\n$res_buf\n&quot;;</span>
<span class="c1">#写入完成后，开始调用读取</span>
            <span class="k">return</span> <span class="n">NGX_READ</span><span class="p">;</span>
        <span class="p">};</span>
<span class="c1">#读取到buffer，最短0字节，最长8000字节，超时10秒</span>
        <span class="n">ngx_reader</span> <span class="nv">$c</span><span class="p">,</span> <span class="nv">$res_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="vg">$!</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">......</span>
            <span class="p">}</span>
            <span class="nv">$r</span><span class="o">-&gt;</span><span class="n">send_http_header</span><span class="p">(</span><span class="s">&#39;text/html&#39;</span><span class="p">);</span>
            <span class="nv">$r</span><span class="o">-&gt;</span><span class="k">print</span><span class="p">(</span><span class="nv">$res_buf</span><span class="p">);</span>
            <span class="nv">$r</span><span class="o">-&gt;</span><span class="n">send_special</span><span class="p">(</span><span class="n">NGX_HTTP_LAST</span><span class="p">);</span>
            <span class="nv">$r</span><span class="o">-&gt;</span><span class="n">finalize_request</span><span class="p">(</span><span class="n">NGX_OK</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">NGX_CLOSE</span><span class="p">;</span>
        <span class="p">};</span>
<span class="c1">#这个是connector的语句，表示连接成功后调用写入</span>
        <span class="k">return</span> <span class="n">NGX_WRITE</span><span class="p">;</span>
    <span class="p">};</span>
<span class="c1">#各个非阻塞调用完成后的返回，NGX_DONE只能用在http的handler里，不能在ngx_*r里用，里面请用NGX_CLOSE。</span>
    <span class="k">return</span> <span class="n">NGX_DONE</span><span class="p">;</span>
<span class="p">};</span>
<span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>另：源码中带有一个真正的反向http的例子Nginx::Util和一个Redis的例子。并且与nodejs读取redis的性能做了对比。可以参见~~
<strong style="display:block;margin:12px 0 4px"><a href="http://www.slideshare.net/chenryn/perlnginx" title="Perl在nginx里的应用" target="_blank">Perl在nginx里的应用</a></strong></p>
      <a href="/2011/12/12/nginx_perl_demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2011/11/04/test_websocket_with_dancer" title="websocket体验" rel="bookmark">websocket体验</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-11-04 00:00:00 +0800">04 Nov 2011</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>因为看到mojo在宣传其内置websocket支持，去CPAN上search了一下，发现Dancer也有plugin做websocket用。稍微看了一下，很显然没看mojo的内嵌代码，而dancer的plugin代码倒是相当简单。
简单的说，就是通过AnyMQ、Plack和Web::Hippie的组合完成。注意的是，因为Web::Hippie使用了AnyEvent::Handle管理websocket的fh，AnyMQ也使用AnyEvent管理message queue，所以在启动plackup的时候，必须使用AnyEvent核心的Twiggy服务器。
Plugin里硬编码很多。比较重要的地方就是&rdquo;set plack_middlewares_map&rdquo;，plack_middlewares_map是dancer新加的功能，这里用URLMap来mount &lsquo;/_hippie&rsquo;到Web::Hippie::Pipe和AnyMQ上。也就是说，使用websocket的访问路径，必须固定为&rsquo;^/_hippie/.*&lsquo;这样。
然后像两个get方法，&rsquo;/new_listener&rsquo;和&rsquo;/message&rsquo;，这两个访问路径是Web::Hippie里写死的，不能改。好在一般应用也不会直接访问这个。
最后有三个register到Dancer的方法，&rsquo;ws_on_message&rsquo;、&rsquo;ws_on_new_listener&rsquo;和&rsquo;ws_send&rsquo;，前两个用来覆盖上面提到的get的两个route的具体信息，一般不用前面两个，因为这样就意味着页面的js里无法控制websocket了（个人理解，不知道对否？）后面那个类似把websocket改成普通的params方式请求响应（用curl/wget可以请求的那种）。</p>
<hr />
<p>好了，大概的机理就是这样，现在做个小东西试试看。cpanm和dancer的运用之前写过，就略过了。lib/WS_test.pm如下：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="n">WS_test</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">WebSocket</span><span class="p">;</span>
<span class="n">get</span> <span class="s">&#39;/ws&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">template</span> <span class="s">&#39;websocket&#39;</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>views/websocket.tt如下：</p>
<div class="highlight"><pre><code class="perl"><span class="sr">&lt;html&gt;</span>
<span class="sr">&lt;head&gt;</span>
<span class="sr">&lt;script&gt;</span>
<span class="n">var</span> <span class="n">ws_path</span> <span class="o">=</span> <span class="s">&quot;ws://chenlinux.com:8080/_hippie/ws&quot;</span><span class="p">;</span>
<span class="n">var</span> <span class="nb">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebSocket</span><span class="p">(</span><span class="n">ws_path</span><span class="p">);</span>
<span class="nb">socket</span><span class="o">.</span><span class="n">onopen</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s">&#39;conn-status&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">innerHTML</span> <span class="o">=</span> <span class="s">&#39;Connected&#39;</span><span class="p">;</span>
<span class="p">};</span>
<span class="nb">socket</span><span class="o">.</span><span class="n">onmessage</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">var</span> <span class="n">data</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s">&#39;textmsg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">msg</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">function</span> <span class="n">send_msg</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">var</span> <span class="n">name</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span><span class="p">;</span>
    <span class="n">var</span> <span class="n">talk</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s">&#39;ownmsg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">;</span>
    <span class="nb">socket</span><span class="o">.</span><span class="nb">send</span><span class="p">(</span><span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">({</span> <span class="n">name:</span> <span class="n">name</span><span class="p">,</span><span class="n">msg:</span> <span class="n">talk</span> <span class="p">}));</span>
<span class="p">}</span>
<span class="sr">&lt;/script&gt;</span>
<span class="sr">&lt;/head&gt;</span>
<span class="sr">&lt;body&gt;</span>
<span class="n">Connection</span> <span class="n">Status:</span> <span class="o">&lt;</span><span class="n">br</span> <span class="sr">/&gt;&lt;span id=&quot;conn-status&quot;&gt; Disconnected &lt;/s</span><span class="n">pan</span><span class="o">&gt;&lt;</span><span class="n">br</span> <span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">textarea</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;textmsg&quot;</span> <span class="n">cols</span><span class="o">=</span><span class="s">&quot;55&quot;</span> <span class="n">rows</span><span class="o">=</span><span class="s">&quot;10&quot;</span><span class="o">&gt;</span><span class="sr">&lt;/textarea&gt;</span><span class="o">&lt;</span><span class="n">hr</span> <span class="o">/&gt;</span>
<span class="n">nickname:</span> <span class="o">&lt;</span><span class="n">input</span> <span class="n">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;name&quot;</span> <span class="sr">/&gt;&lt;br /</span><span class="o">&gt;</span>
<span class="n">messages:</span> <span class="o">&lt;</span><span class="n">textarea</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;ownmsg&quot;</span><span class="o">&gt;</span><span class="sr">&lt;/textarea&gt;</span><span class="o">&lt;</span><span class="n">br</span> <span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">input</span> <span class="n">value</span><span class="o">=</span><span class="s">&quot;send&quot;</span> <span class="n">type</span><span class="o">=</span><span class="n">button</span> <span class="n">onclick</span><span class="o">=</span><span class="s">&quot;send_msg()&quot;</span> <span class="o">/&gt;</span>
<span class="sr">&lt;/body&gt;</span>
<span class="sr">&lt;/html&gt;</span>
</code></pre></div>
<p>ok，然后启动server就行了：</p>
<div class="highlight"><pre><code class="bash">sudo twiggy --listen :8080 bin/app.pl
</code></pre></div>
<p>然后访问http://chenlinux.com:8080/ws/看看效果吧~一个小聊天室就出来了。
不过还有点问题，就是根据加入聊天室的时间先后，信息看不全……估计应该是AnyMQ的问题，个人对MQ了解不多，还需要继续看代码……</p>
      <a href="/2011/11/04/test_websocket_with_dancer" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page4">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page active">
      <a href="#">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li>
      <a href="/page6">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
              <li><a href="http://showmetheco.de/" title="Viacheslav Tykhanovskyi(PocketIO/Text::Haml)">No time to wait</a></li>
              <li><a href="http://blog.dataloop.io/" title="A new SaaS monitoring tool for DevOps & Operations">Dataloop.IO</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://junqili.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.sectop.org/" title="">kindle</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
          </ul>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
