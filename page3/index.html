<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
            <li><a href="/errata.html">《网站运维技术与实践》勘误</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/04/02/parse-puppet-dsl-using-perl6" title="用 Perl6 解析 puppet 的配置语法" rel="bookmark">用 Perl6 解析 puppet 的配置语法</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-04-02 00:00:00 +0800">02 Apr 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>前段时间看到报道说，puppet 的作者本来是用 perl 完成的原型设计，后来改用的 ruby。所以我想，目前这个 puppet 的 DSL 设计，用 perl 来完成的话，应该如何做。</p>
<p>这里碰到一个问题，就是 puppet 中 <code>resource_type</code> 的 <code>title</code> 后面有个冒号，这事儿比较麻烦，不过这时候我突然想到了 Perl6 ，稍微翻了一下文档，发现这事用 Perl6 来实现很容易：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">v6</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">infix</span><span class="p">:&lt;:&gt;($a, %b){</span>
    <span class="k">return</span> <span class="nv">$a</span><span class="p">,</span> <span class="nv">%b</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">service</span><span class="p">(&amp;service) {</span>
    <span class="k">my</span> <span class="nv">@res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">service</span><span class="o">.</span><span class="p">();</span>
    <span class="n">say</span> <span class="nv">@res</span><span class="o">.</span><span class="nb">shift</span> <span class="o">=&gt;</span> <span class="nv">@res</span><span class="o">.</span><span class="n">hash</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">class</span> <span class="nn">nginx::</span><span class="n">install</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$nginxparams</span> <span class="o">=</span> <span class="s">&quot;nginx&quot;</span><span class="p">;</span>
	<span class="n">service</span> <span class="p">{</span> <span class="s">&quot;$nginxparams&quot;</span><span class="p">:</span>
        <span class="n">conf</span> <span class="o">=&gt;</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
        <span class="n">source</span> <span class="o">=&gt;</span> <span class="s">&quot;http&quot;</span> 
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>运行结果如下：</p>
<div class="highlight"><pre><code class="perl"><span class="n">perl6</span> <span class="sr">/data/</span><span class="n">perl6</span><span class="sr">/script/</span><span class="n">puppet</span><span class="o">-</span><span class="n">style</span><span class="o">.</span><span class="n">pl</span>
<span class="s">&quot;nginx&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s">&quot;conf&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;#&quot;</span><span class="p">,</span> <span class="s">&quot;source&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;http&quot;</span><span class="p">}</span>
</code></pre></div>
<p>当然实际上 puppet 要复杂很多，这里其实更多是为了说明 Perl6 如何自定义操作符~</p>
      <a href="/2013/04/02/parse-puppet-dsl-using-perl6" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/04/01/use-mojo-commandline-for-rpmbuild" title="用 Mojo 命令行抓取数据完成自动更新 rpm 构建" rel="bookmark">用 Mojo 命令行抓取数据完成自动更新 rpm 构建</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-04-01 00:00:00 +0800">01 Apr 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>我一直很喜欢 <code>Dancer</code> 里的 keyword 方式，所以很少使用 <code>Mojolicious</code> 框架来写网站，不过 <code>Mojo::UserAgent</code> 和 <code>Mojo::DOM</code> 在一起作为爬虫工具使用，真是太方便了。这两天需要自己打包 <code>tengine</code> ，考虑自动化因素，需要从 <code>tengine</code> 和 其他第三方模块的 <code>github</code> 托管网页上定期查询其更新，都是一行代码就搞定了。整个 <code>Build.PL</code> 如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/env perl</span>
<span class="k">use</span> <span class="nn">Modern::</span><span class="n">Perl</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">IPC::</span><span class="n">Run</span> <span class="sx">qw(run)</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Slurp</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(strftime)</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Template</span><span class="p">;</span>
<span class="k">use</span> <span class="n">ojo</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@ModuleList</span> <span class="o">=</span> <span class="sx">qw(</span>
<span class="sx">    renren/ngx_http_accounting_module</span>
<span class="sx">    agentzh/echo-nginx-module</span>
<span class="sx">    agentzh/chunkin-nginx-module</span>
<span class="sx">    simpl/ngx_devel_kit</span>
<span class="sx">    calio/form-input-nginx-module</span>
<span class="sx">    chaoslawful/lua-nginx-module</span>
<span class="sx">    renren/ngx_http_consistent_hash</span>
<span class="sx">)</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$TengineMD5</span> <span class="o">=</span> <span class="p">(</span><span class="nb">split</span><span class="p">(</span><span class="sr">/ /</span><span class="p">,</span> <span class="n">g</span><span class="p">(</span><span class="s">&quot;http://tengine.taobao.org/download_cn.html&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dom</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;.one_col li span&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
<span class="n">write_file</span><span class="p">(</span><span class="s">&quot;md5.txt&quot;</span><span class="p">,</span> <span class="s">&quot;firstimetorun&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="o">-</span><span class="n">f</span> <span class="s">&quot;md5.txt&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$TengineOldMD5</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span> <span class="s">&quot;md5.txt&quot;</span> <span class="p">);</span>
<span class="n">say</span> <span class="nv">$TengineOldMD5</span><span class="p">;</span>
<span class="n">say</span> <span class="nv">$TengineMD5</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span> <span class="nv">$TengineMD5</span> <span class="ow">ne</span> <span class="nv">$TengineOldMD5</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">gettarball</span><span class="p">(</span><span class="o">\</span><span class="nv">@ModuleList</span><span class="p">);</span>
    <span class="n">write_file</span><span class="p">(</span><span class="s">&quot;md5.txt&quot;</span><span class="p">,</span> <span class="nv">$TengineMD5</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">gettarball</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$ModuleList</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$TengineUrl</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="s">&quot;http://tengine.taobao.org/download_cn.html&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dom</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;.one_col li a&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">href</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$TengineVersion</span> <span class="o">=</span> <span class="nv">$1</span> <span class="k">if</span> <span class="nv">$TengineUrl</span> <span class="o">=~</span> <span class="sr">m!download/tengine-(.*).tar.gz!</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$TengineRelease</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y%m%d%H%M&quot;</span><span class="p">,</span><span class="nb">localtime</span><span class="p">);</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;wget&#39;</span><span class="p">,</span> <span class="s">&quot;http://tengine.taobao.org/${TengineUrl}&quot;</span><span class="p">,</span> <span class="s">&#39;-O&#39;</span><span class="p">,</span> <span class="s">&quot;SOURCES/tengine-${TengineVersion}.tar.gz&quot;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">@ModuleFile</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="k">for</span> <span class="k">my</span> <span class="nv">$Module</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$ModuleList</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{;</span>
        <span class="k">my</span> <span class="nv">$GitUrl</span> <span class="o">=</span> <span class="s">&quot;https://github.com/${Module}&quot;</span><span class="p">;</span>
        <span class="n">say</span> <span class="nv">$GitUrl</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$GitCommit</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="s">&quot;${GitUrl}&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dom</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;.sha&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
        <span class="p">(</span> <span class="k">my</span> <span class="nv">$StoreName</span> <span class="o">=</span> <span class="nv">$Module</span> <span class="p">)</span> <span class="o">=~</span> <span class="sr">s!/!-!</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$StoreFile</span> <span class="o">=</span> <span class="s">&quot;${StoreName}-${GitCommit}.tar.gz&quot;</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@ModuleFile</span><span class="p">,</span> <span class="p">[</span> <span class="s">&quot;Source${i}&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;${StoreName}-${GitCommit}&quot;</span> <span class="p">];</span>
        <span class="n">run</span><span class="p">(</span><span class="s">&#39;wget&#39;</span><span class="p">,</span> <span class="s">&quot;${GitUrl}/tarball/master&quot;</span><span class="p">,</span> <span class="s">&#39;-O&#39;</span><span class="p">,</span> <span class="s">&quot;SOURCES/$StoreFile&quot;</span><span class="p">);</span>
        <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">unlink</span><span class="p">(</span><span class="s">&#39;SPECS/tengine.spec&#39;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$template</span> <span class="o">=</span> <span class="n">Template</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
    <span class="nv">$template</span><span class="o">-&gt;</span><span class="n">process</span><span class="p">(</span><span class="s">&quot;tengine.spec.tt&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="n">TengineVersion</span> <span class="o">=&gt;</span> <span class="nv">$TengineVersion</span><span class="p">,</span>
        <span class="n">TengineRelease</span> <span class="o">=&gt;</span> <span class="nv">$TengineRelease</span><span class="p">,</span>
        <span class="n">TengineAddons</span>  <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@ModuleFile</span><span class="p">,</span>
    <span class="p">},</span> <span class="s">&quot;SPECS/tengine.spec&quot;</span><span class="p">);</span>
    <span class="n">buildrpm</span><span class="p">(</span><span class="nv">$TengineVersion</span><span class="p">,</span> <span class="nv">$TengineRelease</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">buildrpm</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$TengineVersion</span><span class="p">,</span> <span class="nv">$TengineRelease</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$out</span><span class="p">,</span> <span class="nv">$err</span> <span class="p">);</span>
    <span class="n">run</span> <span class="p">[</span><span class="s">&#39;rpmbuild&#39;</span><span class="p">,</span> <span class="s">&#39;-bb&#39;</span><span class="p">,</span> <span class="s">&#39;SPECS/tengine.spec&#39;</span><span class="p">],</span> <span class="nb">undef</span><span class="p">,</span> <span class="o">\</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$err</span><span class="p">;</span>
    <span class="n">mail2author</span><span class="p">(</span><span class="nv">$err</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">mail2author</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$output</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$body</span> <span class="o">=</span> <span class="nv">$output</span> <span class="p">?</span> <span class="s">&quot;Build Error: $output&quot;</span> <span class="p">:</span> <span class="s">&quot;Build OK&quot;</span><span class="p">;</span>
    <span class="n">p</span><span class="p">(</span><span class="s">&quot;http://email.notify.d.xiaonei.com/eml/tengine-build/chenlin.rao&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">DNT</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">}</span> <span class="o">=&gt;</span> <span class="nv">$body</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>直接 <code>g</code> 就是 GET 方法， <code>p</code> 就是 POST 方法。然后 <code>-&gt;dom-&gt;at()</code> 后采用类似 <code>jQuery</code> 的写法就可以直接定位，然后还可以用 <code>-&gt;text</code> 来获取内容，或者 <code>-&gt;{attr}</code> 来获取属性值。</p>
<p>顺带，今天刚知道原来 <code>Template</code> 模块也有 <code>filter</code> 可用。<code>tengine.spec.tt</code> 中就用了一个大写过滤：</p>
<div class="highlight"><pre><code class="bash">Summary:    a HTTP and reverse proxy server
Name:       tengine
Version:    <span class="o">[</span>% TengineVersion %<span class="o">]</span>
Release:    <span class="o">[</span>% TengineRelease %<span class="o">]</span>
Source0:    %<span class="o">{</span>name<span class="o">}</span>-%<span class="o">{</span>version<span class="o">}</span>.tar.gz
Source1:    init.nginx
Source2:    logrotate.nginx
Source3:    nginx-renren-conf.tar.gz
<span class="o">[</span>% FOREACH Module IN TengineAddons -%<span class="o">]</span>
<span class="o">[</span>% Module.0 %<span class="o">]</span>:    <span class="o">[</span>% Module.1 %<span class="o">]</span>.tar.gz
<span class="o">[</span>% END %<span class="o">]</span>
Group:      System Environment/Daemons
License:    BSD
BuildRoot:  %<span class="o">{</span>_tmppath<span class="o">}</span>/%<span class="o">{</span>name<span class="o">}</span>-%<span class="o">{</span>version<span class="o">}</span>-%<span class="o">{</span>release<span class="o">}</span>
Requires:      pcre,zlib,lua
BuildRequires: pcre-devel,zlib-devel,lua-devel
Requires<span class="o">(</span>post<span class="o">)</span>:    chkconfig
Conflicts:     nginx
%description
Nginx with modules: 1<span class="o">)</span> ngx_http_consistent_hash; 2<span class="o">)</span> ngx_http_accounting_module; 3<span class="o">)</span> agentzh-chunkin-nginx-module. 
%prep
<span class="c">#%setup -q </span>
%setup -n tengine-%<span class="o">{</span>version<span class="o">}</span>
tar zxvf %<span class="o">{</span>SOURCE3<span class="o">}</span>
<span class="o">[</span>% FOREACH Module IN TengineAddons -%<span class="o">]</span>
tar zxvf %<span class="o">{[</span>% Module.0 FILTER upper %<span class="o">]}</span>
<span class="o">[</span>% END %<span class="o">]</span>
...;
</code></pre></div>
      <a href="/2013/04/01/use-mojo-commandline-for-rpmbuild" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/03/28/intro-haml" title="Haml 简介" rel="bookmark">Haml 简介</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-03-28 00:00:00 +0800">28 Mar 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Haml 是 Ruby 社区的一种 HTML 标记语言，它利用强制缩进和类似 jQuery 属性标签的风格，简化书写 HTML 的工作。文档见：<a href="http://haml.info/docs.html">http://haml.info/docs.html</a>。</p>
<p>下面是一段官网上的快速入门，从标准的 erb 模板转变成 haml 模板：</p>
<div class="highlight"><pre><code class="ruby"><span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;content&#39;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s1">&#39;left column&#39;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;</span><span class="no">Welcome</span> <span class="n">to</span> <span class="n">our</span> <span class="n">site!</span><span class="o">&lt;</span><span class="sr">/h2&gt;</span>
<span class="sr">    &lt;p&gt;&lt;%= print_infomation %&gt;&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="sr">/div&gt;</span>
<span class="sr">  &lt;div class=&#39;right&#39; id=&#39;item&lt;%= item.id %&gt;&#39;&gt;</span>
<span class="sr">    &lt;%= render :partial =&gt; &quot;item&quot; %&gt;</span>
<span class="sr">  &lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/div&gt;</span>
</code></pre></div>
<p>用 haml 只用这么写：</p>
<div class="highlight"><pre><code class="ruby"><span class="c1">#content</span>
  <span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">column</span>
    <span class="o">%</span><span class="n">h2</span> <span class="no">Welcome</span> <span class="n">to</span> <span class="n">our</span> <span class="n">site!</span>
    <span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">print_information</span>
  <span class="o">.</span><span class="n">right</span><span class="p">{</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s2">&quot;item</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="o">=</span> <span class="n">render</span> <span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s2">&quot;sidebar&quot;</span>
</code></pre></div>
<p>看起来相当 cool，回头在 CPAN 上一翻，原来 perl 社区也有 port 过来的 <a href="https://metacpan.org/module/Text::Haml">Text::Haml</a> 了。根据 perl 的特点有所改变，但是省键盘的特点依然在。</p>
<p>下面是一个例子：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Text::</span><span class="n">Haml</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$haml</span> <span class="o">=</span> <span class="nn">Text::</span><span class="n">Haml</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
<span class="k">my</span> <span class="nv">$hash</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">title</span> <span class="o">=&gt;</span> <span class="s">&#39;my title&#39;</span><span class="p">,</span>
    <span class="n">content</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">line1</span> <span class="o">=&gt;</span> <span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="n">line2</span> <span class="o">=&gt;</span> <span class="s">&quot;test2&quot;</span> <span class="p">}</span>
<span class="p">};</span>
<span class="k">print</span> <span class="nv">$haml</span><span class="o">-&gt;</span><span class="n">render_file</span><span class="p">(</span><span class="s">&#39;test.haml&#39;</span><span class="p">,</span> <span class="nv">%$hash</span><span class="p">);</span>
</code></pre></div>
<p><code>test.haml</code> 如下：</p>
<div class="highlight"><pre><code class="perl"><span class="nv">%html</span><span class="p">{</span> <span class="p">:</span><span class="n">xmlns</span> <span class="o">=&gt;</span> <span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="p">,</span> <span class="p">:</span><span class="n">lang</span> <span class="o">=&gt;</span> <span class="s">&quot;zh&quot;</span><span class="p">}</span>
  <span class="nv">%head</span>
    <span class="nv">%title</span><span class="o">=</span> <span class="nv">$title</span>
  <span class="nv">%body</span>
    <span class="c1">#content</span>
      <span class="o">.</span><span class="n">container</span>
        <span class="nv">%strong</span><span class="o">=</span> <span class="nv">$title</span>
        <span class="o">-</span> <span class="k">for</span> <span class="k">my</span> <span class="nv">$line</span> <span class="p">(</span> <span class="nb">keys</span> <span class="nv">%$content</span> <span class="p">)</span> <span class="p">{</span>
            <span class="o">.</span><span class="n">row</span><span class="o">-</span><span class="n">fluid</span><span class="o">=</span> <span class="nv">$content</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$line</span><span class="p">}</span>
        <span class="o">-</span> <span class="p">}</span>
</code></pre></div>
<p>生成的 HTML 内容如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">&#39;http://www.w3.org/1999/xhtml&#39;</span> <span class="na">lang=</span><span class="s">&#39;zh&#39;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>my title<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&#39;content&#39;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&#39;container&#39;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;strong&gt;</span>my title<span class="nt">&lt;/strong&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&#39;row-fluid&#39;</span><span class="nt">&gt;</span>test<span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&#39;row-fluid&#39;</span><span class="nt">&gt;</span>test2<span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>Text::Haml 还提供了一个初始化参数 <code>vars_as_subs</code>，可以把变量变成同名函数，这样写起来就更像 ruby 了。不过目前只能是纯变量，复杂语句还是不行，所以好看不中用……</p>
<p>Text::Haml 向 Text::Xslate 学习，也提供了  <code>cache_dir</code>, <code>filter</code> 等等功能，所以性能和功能方面应该也不差。</p>
<p><a href="https://metacpan.org/module/Template::Tookit">Template::Tookit</a> 也有插件 <a href="https://metacpan.org/module/Template::Plugin::Haml">Template::Plugin::Haml</a> 可以参看。</p>
<h3 id="wrappertt">wrapper.tt</h3>
<div class="highlight"><pre><code class="perl"><span class="o">!!!</span> <span class="mi">5</span>
<span class="nv">%html</span>
<span class="p">[</span><span class="nv">%</span> <span class="nv">content</span> <span class="nv">%</span><span class="err">]</span>
</code></pre></div>
<h3 id="hellott">hello.tt</h3>
<div class="highlight"><pre><code class="perl"><span class="p">[</span><span class="nv">%</span><span class="err">-</span> <span class="nv">message</span><span class="o">=</span><span class="s">&#39;Hello World&#39;</span> <span class="nv">%</span><span class="err">]</span>
<span class="err">[%-</span> <span class="nv">USE</span> <span class="n">Haml</span> <span class="o">-</span><span class="nv">%</span><span class="err">]</span>
<span class="err">[%-</span> <span class="nv">WRAPPER</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">tt</span> <span class="o">|</span> <span class="n">haml</span> <span class="o">-</span><span class="nv">%</span><span class="err">]</span>
<span class="err">[%-</span> <span class="nv">FILTER</span> <span class="n">haml</span> <span class="o">-</span><span class="nv">%</span><span class="err">]</span>
 <span class="err">%</span><span class="nv">head</span>
  <span class="nv">%meta</span><span class="p">{:</span><span class="n">charset</span> <span class="o">=&gt;</span> <span class="s">&quot;utf-8&quot;</span><span class="p">}</span>
  <span class="nv">%title</span> <span class="n">hello</span>
 <span class="nv">%body</span>
  <span class="nv">%p</span> <span class="p">[</span><span class="nv">%</span> <span class="nv">message</span> <span class="nv">%</span><span class="err">]</span>
  <span class="err">%</span><span class="nv">ul</span>
  <span class="p">[</span><span class="nv">%</span><span class="err">-</span> <span class="nv">total</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">WHILE</span> <span class="n">total</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="nv">%</span><span class="err">]</span>
   <span class="err">%</span><span class="nv">li</span> <span class="p">[</span><span class="nv">%</span> <span class="nv">total</span><span class="o">=</span><span class="n">total</span><span class="o">+</span><span class="mi">1</span> <span class="nv">%</span><span class="err">][%</span> <span class="nv">total</span> <span class="nv">%</span><span class="err">]</span>
  <span class="err">[%-</span> <span class="nv">END</span> <span class="o">-</span><span class="nv">%</span><span class="err">]</span>
<span class="err">[%-</span> <span class="nv">END</span> <span class="o">-</span><span class="nv">%</span><span class="err">]</span>
</code></pre></div>
<p>perl 三大 web 框架 Catalyst/Mojo/Dancer也都有对应的模板插件。</p>
      <a href="/2013/03/28/intro-haml" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/03/27/distributed-nagios-by-mod-gearman" title="用 Mod_Gearman 实现 Nagios 分布式" rel="bookmark">用 Mod_Gearman 实现 Nagios 分布式</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-03-27 00:00:00 +0800">27 Mar 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在 2011 年年底，我曾经连续写过四篇介绍 OMD 的文章。</p>
<ol>
  <li><a href="http://chenlinux.com/2011/12/19/omd_intro_install_on_centos5/">http://chenlinux.com/2011/12/19/omd_intro_install_on_centos5/</a></li>
  <li><a href="http://chenlinux.com/2011/12/27/conf_run_mod_gearman/">http://chenlinux.com/2011/12/27/conf_run_mod_gearman/</a></li>
  <li><a href="http://chenlinux.com/2011/12/20/omd_configurations_basic/">http://chenlinux.com/2011/12/20/omd_configurations_basic/</a></li>
  <li><a href="http://chenlinux.com/2011/12/20/shinken_discovery_runner/">http://chenlinux.com/2011/12/20/shinken_discovery_runner/</a></li>
</ol>
<p>不过之前都停留在代码观摩和安装文档的阶段。这几天刚好有点需求，真正测试了一下如何利用 mod_gearman 实现 分布式的 Nagios 监测集群。</p>
<p>OMD 的安装一如既往的简单，尤其是作为中控端，不需要讲究太多通用性，可以选择使用 ubuntu 系统，直接通过 deb 安装：</p>
<div class="highlight"><pre><code class="bash">wget http://omdistro.org/attachments/download/197/omd-0.56_0.wheezy_i386.deb
dpkg -i omd-0.56_0.wheezy_i386.deb
omd create cdn-monitor
su - cdn-monitor
omd start
</code></pre></div>
<p>这就已经启动了。</p>
<p>不过要使用 mod_gearman 的话，还需要通过 <code>omd config</code> 界面开启。</p>
<p>默认开启之后，是运行在本机多 worker 的 Load Balance 状态下。我们现在要做的是把worker拆分到其他机房去变成 Distributed 状态。</p>
<p><img src="/images/uploads/sample_distributed.png" alt="distributed" /></p>
<p>图上已经列出 server 和 worker 的主要配置不同。我们只需要照着这样改就可以了。</p>
<p>不过在作为纯 worker 端的机房服务器上，我们没有必要安装完整的 OMD 了，这厮安装包都有100MB大……</p>
<p><a href="http://mod-gearman.org/download/v1.4.2/">http://mod-gearman.org/download/v1.4.2/</a> 上提供了 mod_gearman 的独立安装包，我们只需要根据服务器发行版选择下载就可以，这里以 CentOS6 为例，相信现在这个也应该是服务器的主流。</p>
<div class="highlight"><pre><code class="bash">wget http://mod-gearman.org/download/v1.4.2/rhel6/x86_64/gearmand-0.25-1.rhel6.x86_64.rpm
wget http://mod-gearman.org/download/v1.4.2/rhel6/x86_64/mod_gearman-1.4.2-1.e.rhel6.x86_64.rpm
rpm -ivh gearmand-0.25-1.rhel6.x86_64.rpm mod_gearman-1.4.2-1.e.rhel6.x86_64.rpm
</code></pre></div>
<p>除了图中列出的几行关键配置以外，还有两个地方是需要修改的：</p>
<h3 id="gearmand-">gearmand 的监听</h3>
<p>OMD 安装的 gearmand 默认是监听在 127.0.0.1 上的，需要修改<code>/omd/sites/cdn-monitor/etc/mod-gearman/port.conf</code> 文件变成可以被其他机器访问的 IP 地址并重启。</p>
<p>同样 分布式的 <code>/etc/mod_gearman/mod_gearman_worker.conf</code> 里，也需要修改 server 配置并重启服务。</p>
<h3 id="encryption-">encryption 配置</h3>
<p>OMD 默认启用 encryption 并且会在 <code>/omd/sites/cdn/etc/mod-gearman/</code> 下生成 <code>secret.key</code> 文件。</p>
<p>但是 <code>mod_gearman</code> 默认开启 encryption ，却不可能知道中控端的密码，所以默认是在配置文件中指定的 <code>key=should_be_changed</code>。这里我们需要修改一致：</p>
<div class="highlight"><pre><code class="bash">scp nagios:/omd/sites/cdn/etc/mod-gearman/secret.key /etc/mod_gearman/
sed <span class="s1">&#39;s!#keyfile.*!keyfile=/etc/mod_gearman/secret.key!&#39;</span> /etc/mod_gearman/mod_gearman_worker.conf
service mod_gearman_worker restart
</code></pre></div>
<p>事情还没完。这时候你会在 webUI 上看到分配给这个 worker 的检测全部报错，退出码 127。具体内容是：&rdquo;/omd/sites/cdn-monitor/lib/nagios/plugins/check_http do not exists&rdquo;之类的话。</p>
<p>因为，在 OMD 上，commands.cfg 上，配置的 <code>$USER1$/check_http</code> 替换为具体路径后，直接 <code>add_task</code> 到 gearmand 里，所以 worker 上收到 command 并执行也就是这样的了。目前还没有发现可以在 worker 端替换 commands 字符串的简单办法。所以，我们还得自己创建一个软链接：</p>
<div class="highlight"><pre><code class="bash">mkdir -p /omd/sites/cdn-monitor/lib/nagios/
yum install -y nagios-plugins-all --enablerepo<span class="o">=</span>epel
ln -s /usr/lib64/nagios/plugins /omd/sites/cdn-monitor/lib/nagios/plugins
</code></pre></div>
<p>OK，现在这个机房(即nagios配置中的hostgroup)的监测任务，就都分发给本机房的 worker 来进行了。比如 <code>check_http</code> 任务，可以看到原先跨机房访问带来的几十毫秒的延时，都变成了一两毫秒。</p>
      <a href="/2013/03/27/distributed-nagios-by-mod-gearman" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/03/18/logrotate-configuration-files-mode" title="logrotate 配置文件强制为 0644 属性" rel="bookmark">logrotate 配置文件强制为 0644 属性</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-03-18 00:00:00 +0800">18 Mar 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在一次包更新后，发现 Nginx 服务器的每晚日志切割不再进行了。找遍了各种地方，最后在一次偶然的<code>ls -l</code>中发现：</p>
<div class="highlight"><pre><code class="bash"><span class="c"># ll /etc/logrotate.d/</span>
total 64
-rw-r--r-- 1 root root  326 2012-08-04 06:08 apache2
-rw-r--r-- 1 root root   84 2009-02-08 05:18 apt
-rw-r--r-- 1 root root   79 2008-12-05 17:15 aptitude
-rw-r--r-- 1 root root  330 2008-03-08 05:36 atop
-rw-r--r-- 1 root root  232 2011-11-10 14:33 dpkg
-rw-r--r-- 1 root root  267 2013-01-31 13:20 foreman-proxy
-rw-r--r-- 1 root root  151 2007-09-29 19:23 iptraf
-rw-r--r-- 1 root root  880 2012-10-29 17:10 mysql-server
-rwxr-xr-x 1 root root  356 2012-08-05 00:17 nginx
-rw-r--r-- 1 root root 1061 2008-03-08 05:36 psaccs_atop
-rw-r--r-- 1 root root  512 2008-03-08 05:36 psaccu_atop
-rw-r--r-- 1 root root  260 2012-06-23 00:52 rabbitmq-server
-rw-r--r-- 1 root root  126 2012-06-09 00:22 redis-server
-rw-r--r-- 1 root root  515 2012-09-27 02:40 rsyslog
-rw-r--r-- 1 root root  285 2008-11-18 21:20 stunnel4
</code></pre></div>
<p>这里的nginx多了可执行权限。于是我尝试性的执行了<code>chmod -x nginx</code>；结果居然真的恢复了。</p>
<p>这事儿说起来蛮奇怪了。于是去 <a href="https://fedorahosted.org/logrotate">https://fedorahosted.org/logrotate</a> 找来 logrotate 的源码看，结果在<code>logrotate-3.8.3/config.c</code> 里发现这么一段：</p>
<div class="highlight"><pre><code class="c"> <span class="mi">661</span>                 <span class="nf">if</span> <span class="p">((</span><span class="n">sb</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">07533</span><span class="p">)</span> <span class="o">!=</span> <span class="mo">0400</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">662</span>                         <span class="n">message</span><span class="p">(</span><span class="n">MESS_DEBUG</span><span class="p">,</span>
 <span class="mi">663</span>                                 <span class="s">&quot;Ignoring %s because of bad file mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
 <span class="mi">664</span>                                 <span class="n">configFile</span><span class="p">);</span>
 <span class="mi">665</span>                         <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
 <span class="mi">666</span>                         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">667</span>                 <span class="p">}</span>
</code></pre></div>
<p>只有文件权限是 0644 的时候，配置文件才会被读取！0755 的与结果是 0511，不等于 0400。相关 <code>st_mode</code> 的内容可以通过 <code>man 2 stat</code> 查看。</p>
<p>可以写一小段 perl 代码来验证：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl</span>
<span class="k">my</span> <span class="nv">$mode</span> <span class="o">=</span> <span class="p">(</span><span class="nb">stat</span><span class="p">(</span><span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">2</span><span class="p">];</span>
<span class="nb">printf</span> <span class="s">&quot;Permissions are %04o\n&quot;</span><span class="p">,</span> <span class="nv">$mode</span> <span class="o">&amp;</span> <span class="mo">07533</span><span class="p">;</span>
</code></pre></div>
<p>在 <a href="https://fedorahosted.org/logrotate/browser/tags/r3-8-3/CHANGES">ChangeLog</a> 里，看到如下一段话：</p>
<pre><code>2.1 -&gt; 2.2:
    - ignore nonnormal files when reading config files from a directory
    - (these were suggested and originally implemented by
      Henning Schmiedehausen)
</code></pre>
<p>不过比较早了，就懒得从历史堆里再翻为什么当初会有这么个提议了…………</p>
      <a href="/2013/03/18/logrotate-configuration-files-mode" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/03/15/puppet-provider-development" title="Puppet 自定义 Provider" rel="bookmark">Puppet 自定义 Provider</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-03-15 00:00:00 +0800">15 Mar 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Puppet 默认提供了相当多的资源类型，不过我们还可以更进一步的扩展这个庞大的阵营。比如在 <code>package</code> 类型的资源里，我们看到 puppet 除了系统级别的<code>yum</code>,<code>apt</code>之类意外，还提供了 <code>gem</code>,<code>pip</code> 来管理 ruby 和 python 的 package。那么很自然的，我们就可以进一步扩充 <code>package</code> 来管理 perl 的 package 。只需要新加一个 provider 就可以了。</p>
<p>关于 provider 开发的原理说明，见 <a href="http://docs.puppetlabs.com/guides/provider_development.html">http://docs.puppetlabs.com/guides/provider_development.html</a>。</p>
<p>下面是 <code>/etc/puppet/modules/production/myclass/lib/puppet/provider/package/cpan.rb</code> 的内容，他会被 puppet 以 <code>pluginsync</code> 的方式下发。</p>
<div class="highlight"><pre><code class="ruby"><span class="c1"># 加载父类，这里是扩展 package 功能</span>
<span class="nb">require</span> <span class="s1">&#39;puppet/provider/package&#39;</span>
<span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Type</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="ss">:package</span><span class="p">)</span><span class="o">.</span><span class="n">provide</span> <span class="ss">:cpan</span><span class="p">,</span> <span class="ss">:parent</span> <span class="o">=&gt;</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Provider</span><span class="o">::</span><span class="no">Package</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;CPAN modules support.  You can pass any `source` which `cpanm` support, </span>
<span class="s2">    like URL, git repos and local tar.gz. If source is not present at all,</span>
<span class="s2">    the module will be installed from the default CPAN source.</span>
<span class="s2">    You must install App::cpanminus, App::pmodinfo, App::pmuninstall before.&quot;</span>
  <span class="n">has_feature</span> <span class="ss">:versionable</span>
  <span class="c1"># 下面这个是 Puppet::Provider 提供的私有方法，用来指定类内部适用的系统命令</span>
  <span class="c1"># puppet agent 会通过对这个的运行测试来确认该 provider 是否适用于本机</span>
  <span class="c1"># 所以在使用这个 provider 之前，要先通过其他方式在 node 上安装好这三个命令</span>
  <span class="n">commands</span> <span class="ss">:cpanmcmd</span> <span class="o">=&gt;</span> <span class="s2">&quot;cpanm&quot;</span>
  <span class="n">commands</span> <span class="ss">:pmodinfocmd</span> <span class="o">=&gt;</span> <span class="s2">&quot;pmodinfo&quot;</span>
  <span class="n">commands</span> <span class="ss">:pmuninstallcmd</span> <span class="o">=&gt;</span> <span class="s2">&quot;pm-uninstall&quot;</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">pmodlist</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="n">pmodlist_command</span> <span class="o">=</span> <span class="o">[</span><span class="n">command</span><span class="p">(</span><span class="ss">:pmodinfocmd</span><span class="p">),</span><span class="o">]</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:local</span><span class="o">]</span>
      <span class="n">pmodlist_command</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;-l&quot;</span>
    <span class="k">else</span>
      <span class="n">pmodlist_command</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;-c&quot;</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="nb">name</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:justme</span><span class="o">]</span>
      <span class="n">pmodlist_command</span> <span class="o">&lt;&lt;</span> <span class="nb">name</span>
      <span class="c1"># execute 是 Puppet::Util::Execution 提供的方法，接受数组传入，输出标准输出结果字符串</span>
      <span class="n">list</span> <span class="o">=</span> <span class="o">[</span><span class="n">execute</span><span class="p">(</span><span class="n">pmodlist_command</span><span class="p">)</span><span class="o">].</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">set</span><span class="o">|</span> <span class="n">pmodsplit</span><span class="p">(</span><span class="n">set</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">reject</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">nil?</span> <span class="p">}</span>
    <span class="k">else</span>
      <span class="n">list</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">pmodlist_command</span><span class="p">)</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">set</span><span class="o">|</span> <span class="n">pmodsplit</span><span class="p">(</span><span class="n">set</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">reject</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">nil?</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="nb">name</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:justme</span><span class="o">]</span>
      <span class="k">return</span> <span class="n">list</span><span class="o">.</span><span class="n">shift</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="n">list</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">pmodsplit</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">desc</span> <span class="o">=~</span> <span class="sr">/^(\S+) version is (.+)\.(\n  Last cpan version: (.+))?/</span>
      <span class="nb">name</span> <span class="o">=</span> <span class="vg">$1</span>
      <span class="c1"># 整个rb是从gem.rb复制过来的，gem list -r所有版本列成一行，split成一个数组</span>
      <span class="c1"># 这里为了改动少点，就照样做成数组</span>
      <span class="n">versions</span> <span class="o">=</span> <span class="o">[</span><span class="vg">$2</span><span class="o">]</span>
      <span class="k">if</span> <span class="n">latest_version</span> <span class="o">=</span> <span class="vg">$3</span>
        <span class="n">versions</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="vg">$4</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="p">{</span>
        <span class="ss">:name</span>     <span class="o">=&gt;</span> <span class="nb">name</span><span class="p">,</span>
        <span class="ss">:ensure</span>   <span class="o">=&gt;</span> <span class="n">versions</span><span class="p">,</span>
        <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:cpan</span>
      <span class="p">}</span>
    <span class="k">else</span>
      <span class="no">Puppet</span><span class="o">.</span><span class="n">warning</span> <span class="s2">&quot;Could not match </span><span class="si">#{</span><span class="n">desc</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">unless</span> <span class="n">desc</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">empty?</span>
      <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># 这个 instances 方法是 provider 必须提供，在package里就是本地模块的列表</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">instances</span><span class="p">(</span><span class="n">justme</span> <span class="o">=</span> <span class="kp">false</span><span class="p">)</span>
    <span class="n">pmodlist</span><span class="p">(</span><span class="ss">:local</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="nb">hash</span><span class="o">|</span>
      <span class="kp">new</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># 往下的方法都是 package 要求提供的</span>
  <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="n">useversion</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="o">[</span><span class="n">command</span><span class="p">(</span><span class="ss">:cpanmcmd</span><span class="p">)</span><span class="o">]</span>
    <span class="c1"># cpanm 指定安装版本的命令格式是这样： cpanm Dancer@1.000</span>
    <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="o">+=</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">]</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">].</span><span class="n">is_a?</span> <span class="no">Symbol</span><span class="p">)</span> <span class="ow">and</span> <span class="n">useversion</span>
    <span class="n">command</span> <span class="o">&lt;&lt;</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">fail</span> <span class="s2">&quot;Could not install: </span><span class="si">#{</span><span class="n">output</span><span class="o">.</span><span class="n">chomp</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;failed&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">latest</span>
    <span class="n">pmodinfo_options</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:justme</span> <span class="o">=&gt;</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">}</span>
    <span class="nb">hash</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">pmodlist</span><span class="p">(</span><span class="n">pmodlist_options</span><span class="p">)</span>
    <span class="c1"># 这里就是前面要用数组的原因了</span>
    <span class="nb">hash</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span>
  <span class="k">end</span>
  <span class="c1"># 请求本地是否存在具体某个包</span>
  <span class="k">def</span> <span class="nf">query</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">pmodlist</span><span class="p">(</span><span class="ss">:justme</span> <span class="o">=&gt;</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">,</span> <span class="ss">:local</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">uninstall</span>
    <span class="n">pmuninstallcmd</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>在一台没有安装 cpanm 等命令的主机上运行 <code>puppet agent --debug</code>，可以看到这么一行输出：</p>
<pre><code>debug: Puppet::Type::Package::ProviderCpan: file cpanm does not exist
</code></pre>
      <a href="/2013/03/15/puppet-provider-development" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/03/14/JPush-example" title="极光推送demo" rel="bookmark">极光推送demo</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-03-14 00:00:00 +0800">14 Mar 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前已经陆续写过很多种告警的方式。今天再稍微试验一种更新潮一些的 —— 手机推送通知。原先我的想法是移植 HTML5 的 websocket + notification 页面到手机上。但是发现手机上的浏览器都还没有 notification 功能。即便是用 PhoneGap 包装 HTML5 应用，PhoneGap 的 notification API 也不是我想象中的状态栏通知，而是类似 js 的 alert 对话框。</p>
<p>不过这个时候我发现了极光推送。嗯，本来蛮有挑战的事情顿时变成了十分钟内解决的小菜：</p>
<p>整个过程如下：</p>
<h3 id="section">注册帐号</h3>
<p>官网地址: <a href="http://jpush.cn">http://jpush.cn</a></p>
<h3 id="section-1">新建应用</h3>
<p>都是纯页面操作，填写应用名称而已。</p>
<h3 id="example-">下载 example 包</h3>
<p>在应用详情里有下载链接。</p>
<h3 id="adt-eclipse--example">用 adt eclipse 打开 example</h3>
<p>adt eclipse 直接从 android 官网下载 adt-bundle-linux-x86-20130219.tar.gz 解压即可运行。更多配置见 android 官网说明。</p>
<p>然后在 File 菜单栏选择 new -&gt; android application project 就可以新建自己的项目。然后创建自己的 workspace，把下好的 JPush example 包解压倒入workspace，然后就可以 run 了。</p>
<p>不过这里 run 会启动一个 android 虚拟机，很可能是连不上网的，原因似乎是 android vm 默认是 10.0.0.0 网段。</p>
<p>其实这时候我们会在 <code>workspace/push-example/bin/</code> 下发现一个 <code>push-example.apk</code> 文件。复制出来，通过豌豆荚或者别的什么工具直接装进自己手机就可以运行了。</p>
<h3 id="section-2">测试页面发送通知</h3>
<p>在极光的 portal 页面 <a href="http://www.jpush.cn/apps/${your app key}/notification">http://www.jpush.cn/apps/${your app key}/notification</a> 上可以直接提交通知内容。然后你就可以在手机状态栏通知上看到啦！</p>
<h3 id="section-3">测试命令行发送通知</h3>
<p>文档见<a href="http://docs.jpush.cn/pages/viewpage.action?pageId=2621796">http://docs.jpush.cn/pages/viewpage.action?pageId=2621796</a>。</p>
<p>比如通过简易通知推送接口发送如下：</p>
<div class="highlight"><pre><code class="bash">    <span class="c">#!/bin/sh</span>
    <span class="c">#下面两个是你新建应用后就分配的</span>
    <span class="nv">APP_KEY</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">API_MasterSecret</span><span class="o">=</span><span class="nv">$2</span>
    <span class="c">#自赠序列号，这个最好是通过mysql的auto_increment管理</span>
    <span class="nv">sendno</span><span class="o">=</span>2
    <span class="c">#这里有1,2,3,4,分别对应对指定IMEI/tag/alias/all的用户推送</span>
    <span class="nv">receiver_type</span><span class="o">=</span>4
    <span class="nv">verification_code</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -ne <span class="s2">&quot;$sendno$receiver_type$API_MasterSecret&quot;</span> | md5sum | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
    <span class="c">#platform包括android,ios等等，可以用逗号分开写多个</span>
    curl http://api.jpush.cn:8800/sendmsg/v2/notification -d <span class="s2">&quot;sendno=${sendno}&amp;app_key=${APP_KEY}&amp;receiver_type=${receiver_type}&amp;platform=android&amp;txt=123&amp;verification_code=${verification_code}&quot;</span>
</code></pre></div>
<p>然后收到如下响应：</p>
<div class="highlight"><pre><code class="bash">    <span class="o">{</span><span class="s2">&quot;sendno&quot;</span> :<span class="s2">&quot;2&quot;</span>, <span class="s2">&quot;errcode&quot;</span>:0,  <span class="s2">&quot;errmsg&quot;</span>:<span class="s2">&quot;Succeed&quot;</span><span class="o">}</span>
</code></pre></div>
<p>手机也同时响起~成功。</p>
      <a href="/2013/03/14/JPush-example" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/02/25/nginx-testing-10Gibps" title="Nginx 万兆网络环境测试" rel="bookmark">Nginx 万兆网络环境测试</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-02-25 00:00:00 +0800">25 Feb 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#testing-ref" title="testing" rel="category tag">testing</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <ul id="markdown-toc">
  <li><a href="#section">测试目标</a></li>
  <li><a href="#section-1">测试设备</a></li>
  <li><a href="#section-2">测试环境说明</a></li>
  <li><a href="#section-3">特别注意事项</a>    <ul>
      <li><a href="#keepalive">Keepalive</a></li>
      <li><a href="#rpspps">RPS、PPS与流量吞吐率</a></li>
      <li><a href="#section-4">压缩</a></li>
      <li><a href="#section-5">规则集</a></li>
      <li><a href="#section-6">实际网络情况</a></li>
    </ul>
  </li>
  <li><a href="#section-7">测试项目</a>    <ul>
      <li><a href="#section-8">测试一</a></li>
      <li><a href="#section-9">测试二</a></li>
      <li><a href="#section-10">测试三</a></li>
      <li><a href="#section-11">测试四</a></li>
      <li><a href="#section-12">测试五</a></li>
      <li><a href="#section-13">测试六</a></li>
      <li><a href="#section-14">测试七</a></li>
    </ul>
  </li>
  <li><a href="#section-15">术语及缩写说明</a></li>
  <li><a href="#section-16">附注</a></li>
</ul>
<h1 id="section">测试目标</h1>
<p>本次测试的目标是将nginx作为7层负载均衡软件，应用于万兆环境下，获得</p>
<ul>
  <li>
    <p>极限性能</p>
  </li>
  <li>
    <p>在服务质量保证约束条件下的极限性能</p>
  </li>
  <li>
    <p>提升极限性能的方法</p>
  </li>
  <li>
    <p>在万兆环境下部署的一般方法和特殊注意事项</p>
  </li>
</ul>
<p>同时，由于nginx还作为静态页面的提供者，附带还进行获得nginx作为静态文件服务器的</p>
<ul>
  <li>
    <p>极限性能</p>
  </li>
  <li>
    <p>在服务质量保证约束条件下的极限性能</p>
  </li>
  <li>
    <p>提升极限性能的方法</p>
  </li>
  <li>
    <p>在万兆环境下部署的一般方法和特殊注意事项</p>
  </li>
</ul>
<p>操作系统是一个很大的影响因素，在测试开始，会对操作系统版本进行选择，以确定哪个是更合适的平台。</p>
<h1 id="section-1">测试设备</h1>
<p>测试设备如下</p>
<ul>
  <li>
    <p>万兆网卡X520-DA2</p>
  </li>
  <li>
    <p>万兆交换机DCS-7124SX-F</p>
  </li>
  <li>
    <p>万兆DA线</p>
  </li>
  <li>
    <p>SNB服务器</p>
  </li>
  <li>
    <p>WSM服务器</p>
  </li>
</ul>
<h1 id="section-2">测试环境说明</h1>
<p>所有测试服务器连接在同一个万兆交换机下，处于同一个网段。</p>
<p>服务器划分为</p>
<ul>
  <li>
    <p>服务器（以S简称）：提供静态或动态页面，次要测试对象</p>
  </li>
  <li>
    <p>7层负载均衡（以LB简称）：提供负载均衡功能，主要测试对象</p>
  </li>
  <li>
    <p>客户端（以C简称）：提供测试压力</p>
  </li>
</ul>
<h1 id="section-3">特别注意事项</h1>
<h2 id="keepalive">Keepalive</h2>
<p>由于LB和S数量少，高RPS情况下，LB如果采用短连接方式连接S，LB的outgoing port会很快用尽。</p>
<p>解决的方法有两种：</p>
<ol>
  <li>
    <p>S采用多IP配置，模拟众多S的情况，减小每个S所要消耗的LB outgoing port；</p>
  </li>
  <li>
    <p>LB与S之间采用keepalive连接</p>
  </li>
</ol>
<p>短连接的方式下，CPU会有相当一部分消耗在三次握手上，这主要是操作系统开销（小包处理），以及nginx初始化会话上下文的开销。</p>
<h2 id="rpspps">RPS、PPS与流量吞吐率</h2>
<p>极限测试下，PPS考验服务器的CPU能力；而HTTP协议请求头的处理也是CPU密集型任务。</p>
<p>相同流量吞吐率下</p>
<ul>
  <li>
    <p>较小的响应意味着较高的RPS</p>
  </li>
  <li>
    <p>当响应小于一个最大TCP报文长度时，响应越小，也意味着PPS越高</p>
  </li>
</ul>
<p>极限测试中，需要测试以下三种情形</p>
<ul>
  <li>
    <p>全部是大报文。可以通过构造响应为一个最大TCP报文长度实现</p>
  </li>
  <li>
    <p>全部是小报文。可以通过构造响应为最小HTTP响应实现</p>
  </li>
  <li>
    <p>混合报文。可以通过构造响应为一个或两个TCP报文，一个是最大TCP报文长度，另外一个的长度可以控制，来满足特定的混合比例</p>
  </li>
</ul>
<p>流量吞吐率是一个表观指标，但我们更关心的是在带宽足够的条件下，RPS指标（的范围）。</p>
<h2 id="section-4">压缩</h2>
<p>在我们的实际使用中，LB是不负责压缩的。但测试中需要测试压缩对RPS的影响。需要考察压缩方面的优化方法。</p>
<h2 id="section-5">规则集</h2>
<p>负载均衡规则集大小对性能会有影响。由于规则集处理开销正比于RPS，测试中应对较大的规则集进行测试以找出影响大小和可能的优化措施。</p>
<h2 id="section-6">实际网络情况</h2>
<p>一般而言，极限性能是最理想情况。在本次测试中，我们还需要测试接近实际网络情况下的极限性能，这可以通过引入丢包率、延时来模拟。</p>
<h1 id="section-7">测试项目</h1>
<h2 id="section-8">测试一</h2>
<p>测试目标：了解nginx的带宽满载的最小文件大小 （web服务器模式），确定之后测试的文件大小上限</p>
<p>测试工具：ab</p>
<p>测试方法：</p>
<ol>
  <li>
    <p>S上Nginx做简单配置，使其成为web server；</p>
  </li>
  <li>
    <p>在C1上使用 <测试工具> 对S测试10000字节文件，每次减小1000字节，至带宽和RPS均为最高为止。</测试工具></p>
  </li>
  <li>
    <p>根据第二步测试情况调整文件大小，以逼近S的带宽恰好满载且CPU占用率最高时的情况，并记录最终的阈值大小和RPS/PPS指标。</p>
  </li>
</ol>
<p>测试结果：</p>
<table>
  <thead>
    <tr>
      <th><strong>文件大小(Bytes)</strong></th>
      <th><strong>CPU idle(%)</strong></th>
      <th><strong>带宽(MBps)</strong></th>
      <th style="text-align: right"><strong>PPS</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>10K</td>
      <td>65</td>
      <td>1140</td>
      <td style="text-align: right">606K</td>
    </tr>
    <tr>
      <td>3K</td>
      <td>12</td>
      <td>1135</td>
      <td style="text-align: right">1060K</td>
    </tr>
    <tr>
      <td>2590</td>
      <td>0</td>
      <td>1088</td>
      <td style="text-align: right">1138K</td>
    </tr>
    <tr>
      <td>1K</td>
      <td>0</td>
      <td>585</td>
      <td style="text-align: right">783K</td>
    </tr>
  </tbody>
</table>
<p>在采用kernel的pktgen发包测试中，苏能达到的最大PPS为1200K。2590Bytes文件测试中的PPS已经很接近纯发包测试的极限，所以最终，最充
分利用CPU和带宽的文件大小是2590Bytes。</p>
<h2 id="section-9">测试二</h2>
<p>测试目标：了解 nginx 的大致性能（web服务器模式）</p>
<p>测试工具：ab</p>
<p>测试方法：</p>
<ol>
  <li>
    <p>S上Nginx做简单配置，使其成为web server；</p>
  </li>
  <li>
    <p>在C1上使用 <测试工具> 对S分别测试空文件、616字节文件(半个包长度)、1232字节文件（即含header字节数为1448，整TCP包长度）、1
233字节文件（超过一个TCP/IP包大小1字节）和2590字节文件；3. 测试中记录S的网络吞吐量和CPU状况；C1的RPS，PPS指标波动情况。</测试工具></p>
  </li>
</ol>
<p>测试预期：</p>
<ol>
  <li>
    <p>吞吐量应超过1Gbps；</p>
  </li>
  <li>
    <p>吞吐量接近5Gbps；</p>
  </li>
  <li>
    <p>适当调整网卡等其他配置，应使RPS超过50万（原有百兆环境下的极限值）。</p>
  </li>
</ol>
<p>初步测试：</p>
<p>1、在CentOS6.2系统上，十次测试平均结果发现空文件的RPS仅为458005，响应时间0.88715ms，S带宽121M，未能达到预期。</p>
<p>2、检查发现CentOS6.2的ixgbe驱动版本为3.4.8，与最新版本差距较大，升级ixgbe驱动至最新版3.11.33。</p>
<p>更新后原先的8核client已经无法压满server，更换Client设备，ab并发由50×8提高到50×24，测试不同的InterruptThrottle
Rate条件下数据如下：</p>
<p>1000：</p>
<p><img src="/images/Nginx-testing-10Gibps/c568fc0.png" alt="" /></p>
<p>1500：</p>
<p><img src="/images/Nginx-testing-10Gibps/m15b564f6.png" alt="" /></p>
<p>2500：</p>
<p><img src="/images/Nginx-testing-10Gibps/85b1bbd.png" alt="" /></p>
<p>3500：</p>
<p><img src="/images/Nginx-testing-10Gibps/335545b5.png" alt="" /></p>
<p>4500：</p>
<p><img src="/images/Nginx-testing-10Gibps/m25052f88.png" alt="" /></p>
<p>根据以上数据可知，在ITR1500的情况下，空文件的RPS最高，对比数据如下：</p>
<table>
  <thead>
    <tr>
      <th><strong>ITR</strong></th>
      <th><strong>RPS</strong></th>
      <th><strong>带宽(MBps)</strong></th>
      <th><strong>user%</strong></th>
      <th><strong>sys%</strong></th>
      <th style="text-align: right"><strong>irq%</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1000</td>
      <td>688425</td>
      <td>186.886</td>
      <td>30.112</td>
      <td>52.936</td>
      <td style="text-align: right">16.951</td>
    </tr>
    <tr>
      <td>1500</td>
      <td>691614</td>
      <td>187.408</td>
      <td>30.125</td>
      <td>52.208</td>
      <td style="text-align: right">17.667</td>
    </tr>
    <tr>
      <td>2500</td>
      <td>682326</td>
      <td>183.277</td>
      <td>29.191</td>
      <td>53.253</td>
      <td style="text-align: right">17.556</td>
    </tr>
    <tr>
      <td>3500</td>
      <td>650367</td>
      <td>175.477</td>
      <td>26.803</td>
      <td>56.732</td>
      <td style="text-align: right">16.382</td>
    </tr>
    <tr>
      <td>4500</td>
      <td>630178</td>
      <td>169.474</td>
      <td>26.417</td>
      <td>56.708</td>
      <td style="text-align: right">16.833</td>
    </tr>
  </tbody>
</table>
<p>（注：表格中RPS和带宽数据均为峰值，CPU数据为平稳运行期的中间时刻采样值。下同）</p>
<p>所以在新驱动ITR1500的条件下，重新测试616,1232,1233,2590字节的数据：</p>
<p>616：</p>
<p><img src="/images/Nginx-testing-10Gibps/m2c94d5e6.png" alt="" /></p>
<p>1232：</p>
<p><img src="/images/Nginx-testing-10Gibps/3bd4c0bf.png" alt="" /></p>
<p>1233：</p>
<p><img src="/images/Nginx-testing-10Gibps/m1cb568d3.png" alt="" /></p>
<p>2590</p>
<p><img src="/images/Nginx-testing-10Gibps/m73a60e04.png" alt="" /></p>
<p>测试过程出现剧烈的吞吐量波动，在原有的itr1500的条件下服务极不稳定。</p>
<p>总结ITR1500条件下各文件大小的测试数据对比如下：</p>
<table>
  <thead>
    <tr>
      <th>文件大小(Btyes)</th>
      <th>RPS</th>
      <th><strong>带宽(MBps)</strong></th>
      <th>CPU usr%</th>
      <th>CPU sys%</th>
      <th style="text-align: right">CPU irq%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>691614</td>
      <td>187.408</td>
      <td>30.125</td>
      <td>52.208</td>
      <td style="text-align: right">17.667</td>
    </tr>
    <tr>
      <td>616</td>
      <td>586296</td>
      <td>459.435</td>
      <td>29.583</td>
      <td>54.250</td>
      <td style="text-align: right">16.083</td>
    </tr>
    <tr>
      <td>1232</td>
      <td>579103</td>
      <td>838.146</td>
      <td>29.471</td>
      <td>50.563</td>
      <td style="text-align: right">16.048</td>
    </tr>
    <tr>
      <td>1233</td>
      <td>513099</td>
      <td>772.826</td>
      <td>28.417</td>
      <td>48.875</td>
      <td style="text-align: right">22.708</td>
    </tr>
    <tr>
      <td>2590</td>
      <td>418226</td>
      <td>1173.760</td>
      <td>23.343</td>
      <td>41.934</td>
      <td style="text-align: right">18.216</td>
    </tr>
  </tbody>
</table>
<p>另经测试，ITR上调到15000后，2590字节文件测试的S吞吐量恢复成稳定满带宽运行。而且支持并发到80×24。对比ITR5000/10000/15000
条件下数据：</p>
<p>ITR5000图</p>
<p><img src="/images/Nginx-testing-10Gibps/m7333a2.png" alt="" /></p>
<p>ITR10000图：</p>
<p><img src="/images/Nginx-testing-10Gibps/m7721129e.png" alt="" /></p>
<p>ITR15000图：</p>
<p><img src="/images/Nginx-testing-10Gibps/a58a533.png" alt="" /></p>
<p>2.59KB文件在不同ITR下的测试数据对比如下：</p>
<table>
  <thead>
    <tr>
      <th>ITR</th>
      <th>RPS</th>
      <th><strong>带宽(MBps)</strong></th>
      <th>usr%</th>
      <th>sys%</th>
      <th>irq%</th>
      <th style="text-align: right">错误进程</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1500</td>
      <td>418226</td>
      <td>1173.760</td>
      <td>23.343</td>
      <td>41.934</td>
      <td>18.216</td>
      <td style="text-align: right">6</td>
    </tr>
    <tr>
      <td>5000</td>
      <td>418216</td>
      <td>1172.530</td>
      <td>24.250</td>
      <td>55.792</td>
      <td>19.667</td>
      <td style="text-align: right">3</td>
    </tr>
    <tr>
      <td>10000</td>
      <td>417989</td>
      <td>1171.960</td>
      <td>24.625</td>
      <td>52.958</td>
      <td>22.292</td>
      <td style="text-align: right">2</td>
    </tr>
    <tr>
      <td>15000</td>
      <td>404330</td>
      <td>1132.490</td>
      <td>23.802</td>
      <td>52.855</td>
      <td>23.343</td>
      <td style="text-align: right">0</td>
    </tr>
  </tbody>
</table>
<h2 id="section-10">测试三</h2>
<p>测试目标：了解nginx配置对性能的影响(access_log)</p>
<p>测试工具：ab</p>
<p>测试方法：</p>
<ol>
  <li>
    <p>S上做简单配置，关闭 access_log 后进行测试；</p>
  </li>
  <li>
    <p>再测试关闭 access_log buffer 的情况（对比测试二的 access_log buffer=1024k 的情况）</p>
  </li>
  <li>
    <p>在C1上使用 <测试工具> 对S分别测试空文件(ITR为1500)</测试工具></p>
  </li>
  <li>
    <p>测试中记录CPU占用率，网络吞吐量，RPS和平均响应时间指标</p>
  </li>
</ol>
<p>测试结果：</p>
<p>1、设置<code>access_log /data/access_log main;</code>的情况：</p>
<p>与关闭日志相比，吞吐量下降，并且无法支持相同数并发（平均有20%的ab进程退出），只能在30×24的并发数情况下完成稳定测试。</p>
<p><img src="/images/Nginx-testing-10Gibps/604d3126.png" alt="" /></p>
<p>2、将日志写入SSD磁盘，验证是否有性能提升。</p>
<p><img src="/images/Nginx-testing-10Gibps/m34c0cd58.png" alt="" /></p>
<p>由上两图对比，可见虽然将日志写入SSD对RPS稍有提升，但离关闭日志的70万差距甚远，更换SSD没有实质的意义。</p>
<p>3、普通磁盘上设置buffer=1024k参数</p>
<p><img src="/images/Nginx-testing-10Gibps/5637f0f7.png" alt="" /></p>
<p>4、设置buffer=64k参数</p>
<p><img src="/images/Nginx-testing-10Gibps/m3d18099f.png" alt="" /></p>
<p>5、设置buffer=4k参数</p>
<p><img src="/images/Nginx-testing-10Gibps/m160f2f0b.png" alt="" /></p>
<p>可见在使用buffer参数后，RPS明显提升到和关闭日志时一个数量级的水准。而buffer的大小，从4k到1024k，也可以提高10%左右。</p>
<p>测试三各项数据对比如下：</p>
<table>
  <thead>
    <tr>
      <th><strong>配置</strong></th>
      <th><strong>RPS</strong></th>
      <th><strong>带宽(MBps)</strong></th>
      <th><strong>Usr%</strong></th>
      <th><strong>Sys%</strong></th>
      <th><strong>irq%</strong></th>
      <th style="text-align: right"><strong>稳定并发</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>关闭日志</td>
      <td>691614</td>
      <td>187.408</td>
      <td>30.125</td>
      <td>52.208</td>
      <td>17.667</td>
      <td style="text-align: right">50*24</td>
    </tr>
    <tr>
      <td>打开日志</td>
      <td>180148</td>
      <td>49.074</td>
      <td>8.966</td>
      <td>21.337</td>
      <td>4.483</td>
      <td style="text-align: right">30*24</td>
    </tr>
    <tr>
      <td>使用SSD</td>
      <td>144347</td>
      <td>39.179</td>
      <td>10.875</td>
      <td>25.708</td>
      <td>5.750</td>
      <td style="text-align: right">30*24</td>
    </tr>
    <tr>
      <td>buffer4K</td>
      <td>588767</td>
      <td>159.297</td>
      <td>27.613</td>
      <td>55.352</td>
      <td>16.951</td>
      <td style="text-align: right">50*24</td>
    </tr>
    <tr>
      <td>buffer64K</td>
      <td>593022</td>
      <td>160.172</td>
      <td>26.845</td>
      <td>57.065</td>
      <td>16.048</td>
      <td style="text-align: right">50*24</td>
    </tr>
    <tr>
      <td>buffer1M</td>
      <td>659290</td>
      <td>177.959</td>
      <td>32.042</td>
      <td>51.875</td>
      <td>16.000</td>
      <td style="text-align: right">50*24</td>
    </tr>
  </tbody>
</table>
<h2 id="section-11">测试四</h2>
<p>测试目标：了解nginx配置对性能的影响(tcp_nopush off)</p>
<p>测试工具：ab</p>
<p>测试方法：</p>
<ol>
  <li>
    <p>S上做简单配置，同时关闭tcp_nopush off;</p>
  </li>
  <li>
    <p>在C1上使用 <测试工具> 对S分别测试1232字节文件和1233字节文件</测试工具></p>
  </li>
  <li>
    <p>测试中记录网络吞吐量，RPS和PPS指标</p>
  </li>
</ol>
<p>测试预期：</p>
<p>根据对TCP_NOPUSH的理解，在关闭此参数的情况下，1232字节文件的rps应该和开启状态下有较大差别。</p>
<p>测试结果：</p>
<p>1232字节文件数据：</p>
<p>当ITR为1500时：</p>
<p><img src="/images/Nginx-testing-10Gibps/51d7bf66.png" alt="" /></p>
<p>峰值带宽比测试二中的数据稍差，但是运行不稳定，CPU的波动与rps图相对应，尝试加大并发则有client进程出现connection timeout错误。</p>
<p>加大itr到15000后波动变的比较稳定。但RPS下降到40万，与测试二相差接近30%。数据如下：</p>
<p><img src="/images/Nginx-testing-10Gibps/m21d6c756.png" alt="" /></p>
<p>该项测试相关数据对比如下：</p>
<table>
  <thead>
    <tr>
      <th><strong>配置</strong></th>
      <th><strong>RPS</strong></th>
      <th><strong>带宽(MBps)</strong></th>
      <th><strong>Usr%</strong></th>
      <th><strong>Sys%</strong></th>
      <th><strong>Irq%</strong></th>
      <th style="text-align: right"><strong>退出进程</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>tcp_nopush on+ITR1500</td>
      <td>579103</td>
      <td>838.146</td>
      <td>29.471</td>
      <td>50.563</td>
      <td>16.048</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td>tcp_nopush off+ITR1500</td>
      <td>543050</td>
      <td>817.746</td>
      <td>27.095</td>
      <td>51.438</td>
      <td>21.467</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td>tcp_nopush off+ITR15000</td>
      <td>393416</td>
      <td>593.411</td>
      <td>22.458</td>
      <td>55.583</td>
      <td>21.958</td>
      <td style="text-align: right">0</td>
    </tr>
  </tbody>
</table>
<h2 id="section-12">测试五</h2>
<p>测试目标：了解nginx的大致性能（代理模式）</p>
<p>测试工具：ab</p>
<p>测试方法：</p>
<ol>
  <li>
    <p>S上nginx做简单配置，使其成为webserver，作为后端；</p>
  </li>
  <li>
    <p>LB上nginx做简单配置，使其成为L7 HTTP 代理，所有请求代理至S。LB后端keepalive在测试中测试两种情况，即打开和关闭</p>
  </li>
  <li>
    <p>在C1/C2上使用 <测试工具> 对LB分别测试空文件、1232字节文件和2590字节文件</测试工具></p>
  </li>
  <li>
    <p>测试中记录S和LB的CPU占用率，网络吞吐量，RPS三个指标</p>
  </li>
</ol>
<p>测试预期：</p>
<ol>
  <li>
    <p>Keepalive关闭时，可能需要对LB的内核参数进行调整才能够完成测试；</p>
  </li>
  <li>
    <p>Keepalive关闭时，仅调整内核参数可能不够，S需绑定多个IP地址，LB需使用S的多个IP地址；</p>
  </li>
</ol>
<p>测试结果：</p>
<p>（注：因为C1/C2的主板架构/CPU配置不一。8核的C2会先于24核的C1结束测试，后半段数据不如前半段稳定，不过单C1运行也基本可以逼近LB极限，不影响
数据采集和判断。）</p>
<p>1、空文件：</p>
<p><img src="/images/Nginx-testing-10Gibps/m45af05e8.png" alt="" /></p>
<p>2、1232字节文件</p>
<p><img src="/images/Nginx-testing-10Gibps/4687c6d4.png" alt="" /></p>
<p>3、2590字节文件</p>
<p><img src="/images/Nginx-testing-10Gibps/m449464d4.png" alt="" /></p>
<p>4、10K字节文件</p>
<p><img src="/images/Nginx-testing-10Gibps/m3622cdb6.png" alt="" /></p>
<p>根据测试二的经验，非空文件ITR为15000时表现更稳定，修改后数据如下：</p>
<p>1、1232字节：</p>
<p><img src="/images/Nginx-testing-10Gibps/9098f14.png" alt="" /></p>
<p>2、2590字节：</p>
<p><img src="/images/Nginx-testing-10Gibps/m7d14ebde.png" alt="" /></p>
<p>3、10k字节文件</p>
<p><img src="/images/Nginx-testing-10Gibps/278a77c9.png" alt="" /></p>
<p>4、100k字节文件</p>
<p><img src="/images/Nginx-testing-10Gibps/ffd255.png" alt="" /></p>
<p>关闭proxy_keepalive，使用2台Client测试，并发2400。空文件测试带宽只能压到18MBps，LB和S的CPU
idle都在85%以上。平均响应时间长达40ms。限于环境，压力测试无法继续进行。</p>
<p>本测试proxy_keepalive情况时各项数据对比如下：</p>
<table>
  <thead>
    <tr>
      <th><strong>ITR+文件大小</strong></th>
      <th><strong>RPS</strong></th>
      <th><strong>带宽(MBps)</strong></th>
      <th><strong>Usr%</strong></th>
      <th><strong>Sys%</strong></th>
      <th style="text-align: right"><strong>Irq%</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ITR1500+0Byte</td>
      <td>392406</td>
      <td>165.185</td>
      <td>39.533</td>
      <td>26.647</td>
      <td style="text-align: right">30.234</td>
    </tr>
    <tr>
      <td>ITR1500+1232Bytes</td>
      <td>369582</td>
      <td>588.209</td>
      <td>41.142</td>
      <td>28.595</td>
      <td style="text-align: right">28.929</td>
    </tr>
    <tr>
      <td>ITR1500+2590Bytes</td>
      <td>296866</td>
      <td>898.885</td>
      <td>34.250</td>
      <td>29.417</td>
      <td style="text-align: right">36.167</td>
    </tr>
    <tr>
      <td>ITR1500+10KBytes</td>
      <td>118163</td>
      <td>1167.280</td>
      <td>17.870</td>
      <td>18.319</td>
      <td style="text-align: right">15.218</td>
    </tr>
    <tr>
      <td>ITR15000+1232Bytes</td>
      <td>370590</td>
      <td>588.422</td>
      <td>41.167</td>
      <td>28.375</td>
      <td style="text-align: right">29.208</td>
    </tr>
    <tr>
      <td>ITR15000+2590Bytes</td>
      <td>297289</td>
      <td>897.755</td>
      <td>34.890</td>
      <td>28.429</td>
      <td style="text-align: right">35.682</td>
    </tr>
    <tr>
      <td>ITR15000+10KBytes</td>
      <td>118033</td>
      <td>1168.160</td>
      <td>21.137</td>
      <td>21.426</td>
      <td style="text-align: right">25.752</td>
    </tr>
    <tr>
      <td>ITR15000+100KBytes</td>
      <td>11388</td>
      <td>1168.890</td>
      <td>4.798</td>
      <td>12.542</td>
      <td style="text-align: right">10.522</td>
    </tr>
  </tbody>
</table>
<h2 id="section-13">测试六</h2>
<p>测试目标：nginx LB在多域名情况下的性能</p>
<p>测试工具：ab</p>
<p>测试方法：</p>
<p>1、S上nginx做简单配置，使其成为webserver，作为后端；</p>
<p>2、LB上nginx使用我司实际代理配置(800+域名)，使其成为L7 HTTP
代理，所有请求代理至S。LB后端keepalive在测试中测试两种情况，即打开和关闭</p>
<p>3、在C1上使用 <测试工具> 对LB分别测试单域名和随机多域名空文件请求</测试工具></p>
<p>4、测试中记录S和LB的CPU占用率，网络吞吐量，RPS三个指标</p>
<p>测试预期：</p>
<p>多域名代理情况下性能应和直接通过IP访问在一个数量级内。</p>
<p>测试结果：</p>
<p>1、单域名：</p>
<p><img src="/images/Nginx-testing-10Gibps/m76022a04.png" alt="" /></p>
<p>2、随机域名。因为测试在2台服务器上一共开启了32个ab进程，即随机选出32个域名做的测试，结果如下：</p>
<p><img src="/images/Nginx-testing-10Gibps/41f8c534.png" alt="" /></p>
<p>3、关闭keepalive的情况：</p>
<p><img src="/images/Nginx-testing-10Gibps/m6f56712d.png" alt="" /></p>
<p>可见代理模式使用多个domain和upstream配置，对性能没有太大影响。有影响的依然是keepalive是否开启。具体数据对比如下：</p>
<table>
  <thead>
    <tr>
      <th><strong>测试条件</strong></th>
      <th><strong>RPS</strong></th>
      <th><strong>带宽(MBps)</strong></th>
      <th><strong>Usr%</strong></th>
      <th><strong>Sys%</strong></th>
      <th style="text-align: right"><strong>Irq%</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>IP访问</td>
      <td>392406</td>
      <td>165.185</td>
      <td>39.533</td>
      <td>26.647</td>
      <td style="text-align: right">30.234</td>
    </tr>
    <tr>
      <td>单域名</td>
      <td>377292</td>
      <td>179.832</td>
      <td>41.091</td>
      <td>26.811</td>
      <td style="text-align: right">29.559</td>
    </tr>
    <tr>
      <td>多域名</td>
      <td>384513</td>
      <td>185.632</td>
      <td>43.297</td>
      <td>27.186</td>
      <td style="text-align: right">28.185</td>
    </tr>
    <tr>
      <td>No keepalive</td>
      <td>34879</td>
      <td>28.310</td>
      <td>5.973</td>
      <td>7.341</td>
      <td style="text-align: right">9.083</td>
    </tr>
  </tbody>
</table>
<h2 id="section-14">测试七</h2>
<p>测试目标：其他常见server性能对比</p>
<p>测试工具：ab</p>
<p>测试方法：</p>
<p>Resin4pro加临时lisence，默认配置(关闭日志)，测试空文件。</p>
<p>测试结果：</p>
<p><img src="/images/Nginx-testing-10Gibps/m2e7e1790.png" alt="" /></p>
<p>与nginx的webserver模式对比如下：</p>
<table>
  <thead>
    <tr>
      <th><strong>Webserver</strong></th>
      <th><strong>RPS</strong></th>
      <th><strong>带宽(MBps)</strong></th>
      <th><strong>Usr%</strong></th>
      <th><strong>Sys%</strong></th>
      <th style="text-align: right"><strong>Irq%</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>resin4</td>
      <td>44873</td>
      <td>32.353</td>
      <td>3.884</td>
      <td>4.545</td>
      <td style="text-align: right">10.455</td>
    </tr>
    <tr>
      <td>Nginx1.2</td>
      <td>691614</td>
      <td>187.408</td>
      <td>30.125</td>
      <td>52.208</td>
      <td style="text-align: right">17.667</td>
    </tr>
  </tbody>
</table>
<h1 id="section-15">术语及缩写说明</h1>
<p>RPS: Requests per Second，每秒请求数</p>
<p>PPS: Packets per second，每秒报文数</p>
<h1 id="section-16">附注</h1>
<p>生成图片的 GNUplot 脚本见<a href="http://chenlinux.com/2012/11/22/gnuplot-to-draw-multi-graph">http://chenlinux.com/2012/11/22/gnuplot-to-draw-multi-graph</a>。</p>
      <a href="/2013/02/25/nginx-testing-10Gibps" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/02/22/setup-stf2" title="STF 2.0 安装测试" rel="bookmark">STF 2.0 安装测试</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-02-22 00:00:00 +0800">22 Feb 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>STF 更新到 2.0 版本，支持使用 redis 队列做任务分发，比原先的 Q4M 容易上手多了；新增了 cluster 概念，虽然目前看没什么用，不过估计以后肯定要在这方面做文章的。</p>
<p>部署步骤如下：</p>
<div class="highlight"><pre><code class="bash">    <span class="c"># 因为 stf 要求在 Perl5.12 以上运行，CentOS6 还是 5.10 的老版本，所以直接用 Debian 测试了</span>
    apt-get install -y memcached redis-server libmysqlclient-dev libdbd-mysql-perl
    <span class="c"># 设置 mysql-server 包安装时需要的问答</span>
    <span class="nb">echo </span>mysql-server-5.5 mysql-server/root_password <span class="k">select </span>123456 | debconf-set-selections
    <span class="nb">echo </span>mysql-server-5.5 mysql-server/root_password_again <span class="k">select </span>123456 | debconf-set-selections
    apt-get install mysql-server-5.5
    <span class="c"># 系统依赖解决，开始 perl 部分</span>
    git clone git://github.com/stf-storage/stf.git
    <span class="nb">cd </span>stf
    cpanm Redis Data::Dumper::Concise
    cpanm --installdeps .
    <span class="c"># 创建 mysql 库和用户</span>
    mysql -uroot -p -e <span class="s1">&#39;create database stf&#39;</span>
    mysql -uroot -p -e <span class="s1">&#39;grant all privileges on stf.* to stf@&quot;%&quot; identified by &quot;654321&quot;&#39;</span>
    <span class="c"># 默认监听本机，分布式系统肯定是要放开这个的</span>
    sed -i <span class="s1">&#39;s/127.0.0.1/0.0.0.0/&#39;</span> /etc/mysql/my.cnf
    service mysql restart
    <span class="c"># 导入 sql 建表</span>
    mysql -ustf -p stf &lt; misc/stf.sql
    <span class="c"># 给 worker 和 dispatcher 设置队列使用 redis</span>
    <span class="nb">export </span><span class="nv">STF_QUEUE_TYPE</span><span class="o">=</span>Redis
    <span class="nb">export </span><span class="nv">STF_REDIS_HOSTPORT</span><span class="o">=</span>192.168.0.101:6379
    <span class="c"># 所有的角色都要有自己独有的 hostid</span>
    <span class="nb">export </span><span class="nv">STF_HOST_ID</span><span class="o">=</span>1
    <span class="nb">export </span><span class="nv">STF_HOME</span><span class="o">=</span>/root/stf
    <span class="c"># 启动 dispatcher，这里目前还只会用 plack，不知道怎么用 nginx/apache</span>
    <span class="nb">export </span><span class="nv">USE_PLACK_REPROXY</span><span class="o">=</span>1
    <span class="c"># 研究阶段可以打开 debug 看系统是怎么分发怎么平衡怎么确定使用哪个storage的file的过程</span>
    <span class="nb">export </span><span class="nv">STF_DEBUG</span><span class="o">=</span>1
    plackup -a etc/dispatcher.psgi
    <span class="c"># 启动 worker</span>
    ./bin/stf-worker
    <span class="c"># 启动管理界面网站，可以通过 web 添加 cluster 和 storage</span>
    plackup -a etc/admin.psgi -p 9000 &amp;
    <span class="c"># 一个 cluster 下至少需要有 3 个 storage，这里用三个目录三个端口来模拟</span>
    mkdir -p /data<span class="o">{</span>1,2,3<span class="o">}</span>
    <span class="nb">export </span><span class="nv">STF_STORAGE_ROOT</span><span class="o">=</span>/data1
    plackup -a etc/storage.psgi -p 8888 &amp;
    <span class="nb">export </span><span class="nv">STF_STORAGE_ROOT</span><span class="o">=</span>/data2
    plackup -a etc/storage.psgi -p 8889 &amp;
    <span class="nb">export </span><span class="nv">STF_STORAGE_ROOT</span><span class="o">=</span>/data3
    plackup -a etc/storage.psgi -p 8890 &amp;
</code></pre></div>
<p>然后上 9000 端口的 web 添加 cluster 和 storage，如下截图：</p>
<p><img src="/images/uploads/stf-admin1.png" alt="cluster" /></p>
<p><img src="/images/uploads/stf-admin.png" alt="storage" /></p>
<p>最后测试一下上传下载，如果上面 psgi 是 DEBUG 运行的，就可以看到详细的过程了。</p>
<div class="highlight"><pre><code class="bash">    lwp-request -m PUT http://192.168.0.101/bucket
    ^D
    lwp-request -m PUT http://192.168.0.101:5000/bucket/test.txt
    <span class="nb">test</span>
    ^D
    lwp-request http://192.168.0.101:5000/bucket/test.txt
    ls /data1/p/e/g/k/pegkuclninhsyqxftuzpwcuhgughpa.txt
    ls /data2/p/e/g/k/pegkuclninhsyqxftuzpwcuhgughpa.txt
</code></pre></div>
<p><strong>2013 年 03 月 20 日更新</strong></p>
<p>前面测试记录的，都是纯 perl 的部分。实际运用的时候，有些地方是可以用 nginx 来替代的。</p>
<p>源代码包中，apache-sample.conf 比 nginx-sample.conf 要全面的多。不过其实还是 nginx 配置起来容易，比如给 dispatcher.psgi 加上 nginx 代理，只需要这样就可以了：</p>
<div class="highlight"><pre><code class="nginx"><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">stf</span><span class="p">;</span>
    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span> <span class="s">http://192.168.0.101:5000/</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="s">/reproxy</span> <span class="p">{</span>
        <span class="kn">internal</span><span class="p">;</span>
        <span class="kn">set</span> <span class="nv">$reproxy</span> <span class="nv">$upstream_http_x_reproxy_url</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="nv">$reproxy</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>然后我们就可以直接通过 <code>http://192.168.0.101/bucket/test.txt</code> 来访问了。</p>
      <a href="/2013/02/22/setup-stf2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/01/31/puppet-define-type-and-custom-function" title="Puppet 自定义 type 和 function" rel="bookmark">Puppet 自定义 type 和 function</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-01-31 00:00:00 +0800">31 Jan 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Puppet 除了原有 DSL 以外，还提供了不少接口方便大家开发插件来更简单的完成一些高级功能。</p>
<h1 id="define-type">Define Type</h1>
<p>比如我们要维护一个上千域名组成的 ProxyServer 集群，其域名配置是相近的。那么我们就可以提炼出 template 里会变化的部分作为参数。由此定义出一个 type 如下：</p>
<div class="highlight"><pre><code class="ruby">    <span class="n">define</span> <span class="ss">nginx</span><span class="p">:</span><span class="ss">:vhost4proxy</span><span class="p">(</span>
        <span class="vg">$iplist</span> <span class="o">=</span> <span class="o">[]</span><span class="p">,</span>
        <span class="vg">$domainlist</span> <span class="o">=</span> <span class="o">[]</span><span class="p">,</span>
        <span class="vg">$extconf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="vg">$nginx_proxy_name</span>    <span class="o">=</span> <span class="vg">$name</span>
        <span class="vg">$nginx_proxy_servers</span> <span class="o">=</span> <span class="vg">$iplist</span>
        <span class="vg">$nginx_server_names</span>  <span class="o">=</span> <span class="vg">$domainlist</span>
        <span class="n">file</span> <span class="p">{</span> <span class="s2">&quot;${nginx_proxy_name}.server.conf&quot;</span><span class="p">:</span>
            <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">file</span><span class="p">,</span>
            <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/etc/nginx/conf.d&#39;</span><span class="o">]</span><span class="p">,</span>
            <span class="n">path</span>    <span class="o">=&gt;</span> <span class="s2">&quot;/etc/nginx/conf.d/${nginx_proxy_name}.server.conf&quot;</span><span class="p">,</span>
            <span class="n">content</span> <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;nginx/vhost_proxy.conf.erb&#39;</span><span class="p">),</span>
            <span class="n">notify</span>  <span class="o">=&gt;</span> <span class="no">Service</span><span class="o">[</span><span class="s1">&#39;nginx&#39;</span><span class="o">]</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
<p>然后在 template 里使用参数来生成结果：</p>
<div class="highlight"><pre><code class="ruby">    <span class="n">upstream</span> <span class="o">&lt;</span><span class="sx">%= nginx_proxy_name %&gt; {</span>
<span class="sx">            consistent_hash $request_uri;</span>
<span class="sx">    &lt;% nginx_proxy_servers.each do |ip| -%&gt;</span>
<span class="sx">            server &lt;%=</span> <span class="n">ip</span> <span class="sx">%&gt;;</span>
<span class="sx">    &lt;% end %&gt;</span>
    <span class="p">}</span>
    <span class="n">server</span> <span class="p">{</span>
        <span class="n">listen</span> <span class="mi">80</span><span class="p">;</span>
        <span class="n">server_name</span> <span class="o">&lt;</span><span class="sx">% scope.lookupvar(&quot;nginx_server_names&quot;).each </span><span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span> <span class="o">-</span><span class="sx">%&gt; &lt;%= name -%&gt;</span><span class="o">&lt;</span><span class="sx">% end %&gt;;</span>
<span class="sx">    </span>
<span class="sx">        location / {</span>
<span class="sx">            proxy_pass       http://&lt;%= scope.lookupvar(&quot;nginx_proxy_name&quot;) %&gt;</span><span class="p">;</span>
            <span class="kp">include</span>          <span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">proxy</span><span class="o">.</span><span class="n">conf</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="o">&lt;</span><span class="sx">% if </span><span class="n">has_variable?</span><span class="p">(</span><span class="s2">&quot;extconf&quot;</span><span class="p">)</span> <span class="sx">%&gt;</span>
<span class="sx">        &lt;%= scope.lookupvar(&quot;extconf&quot;) %&gt;</span>
    <span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
    <span class="p">}</span>
</code></pre></div>
<p>这样我们只需要在 puppet 中这样调用，就可以直接生成对应的配置了：</p>
<div class="highlight"><pre><code class="ruby">    <span class="ss">nginx</span><span class="p">:</span><span class="ss">:vhost4proxy</span><span class="p">(</span><span class="s1">&#39;server1&#39;</span><span class="p">:</span>
        <span class="o">[</span><span class="s1">&#39;1.1.1.1 weight=2&#39;</span><span class="p">,</span> <span class="s1">&#39;2.2.2.2 weight=3&#39;</span><span class="o">]</span><span class="p">,</span>
        <span class="o">[</span><span class="s1">&#39;server1.domain&#39;</span><span class="p">,</span> <span class="s1">&#39;server1.alias.domain&#39;</span><span class="o">]</span><span class="p">,</span>
        <span class="s1">&#39;access_log /path/to/other_log format&#39;</span>
    <span class="p">)</span>
</code></pre></div>
<h1 id="custom-function">Custom Function</h1>
<p>不过用上面 define type 还不能完全解决我们提出的问题。因为在 puppet 配置里写几千行 nginx::vhost4proxy 也是一件很可怕的事情！</p>
<p>这时候可以更进一步，把 vhost4proxy 的调用过程隐藏成一个 function，如下：</p>
<div class="highlight"><pre><code class="ruby">    <span class="nb">require</span> <span class="s1">&#39;yaml&#39;</span>
    <span class="k">module</span> <span class="nn">Puppet::Parser::Functions</span>
      <span class="n">newfunction</span><span class="p">(</span><span class="ss">:gen_proxy_confd</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:statement</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">args</span><span class="o">|</span>
        <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Parser</span><span class="o">::</span><span class="no">Functions</span><span class="o">.</span><span class="n">autoloader</span><span class="o">.</span><span class="n">loadall</span>
        <span class="n">resource_type</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
        <span class="n">yaml_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
        <span class="no">Dir</span><span class="o">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">yaml_dir</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">yaml_file</span><span class="o">|</span>
          <span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">yaml_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">yaml_file</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="k">next</span> <span class="k">unless</span> <span class="n">file_path</span><span class="o">[-</span><span class="mi">5</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">].</span><span class="n">eql?</span><span class="p">(</span><span class="s1">&#39;.yaml&#39;</span><span class="p">)</span>
          <span class="n">res_params</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
          <span class="n">function_create_resources</span><span class="p">(</span><span class="o">[</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">res_params</span><span class="o">]</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
</code></pre></div>
<p>然后只要把原先传递给 vhost4proxy 的参数写成 yaml 文件放好就行了。</p>
<div class="highlight"><pre><code class="yaml">    <span class="l-Scalar-Plain">---</span> 
    <span class="l-Scalar-Plain">server1</span><span class="p-Indicator">:</span> 
      <span class="l-Scalar-Plain">iplist</span><span class="p-Indicator">:</span> 
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">1.1.1.1 weight=2</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">2.2.2.2 weight=3</span>
      <span class="l-Scalar-Plain">domainlist</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">server1.domain</span>
        <span class="p-Indicator">-</span> <span class="s">&#39;*.server1.alias.domain&#39;</span>
      <span class="l-Scalar-Plain">extconf</span><span class="p-Indicator">:</span> <span class="p-Indicator">|-</span>
        <span class="no">chunkin on;</span>
        <span class="no">error_page 411 = @my_411_error;</span>
        <span class="no">location @my_411_error {</span>
            <span class="no">chunkin_resume;</span>
        <span class="no">}</span>
        <span class="no">access_log /path/to/other_log format;</span>
</code></pre></div>
<p>大家看起来是不是有点眼熟？没错，这个 yaml 的思路完全是借鉴了 hiera 的写法。但是 hiera 的设计是垂直继承的，不适合这里假设的平面式的情况 —— 当然，如果你觉得把这几千个 yaml 都写在一个大 yaml 文件里也不费劲的话。就不用上我这么折腾了~~</p>
<p>最后在 puppet 配置中只用一行就搞定全部：</p>
<div class="highlight"><pre><code class="ruby">    <span class="n">gen_proxy_confd</span><span class="p">(</span><span class="s1">&#39;nginx::vhost4proxy&#39;</span><span class="p">,</span><span class="s2">&quot;${modulepath}/nginx/yaml&quot;</span><span class="p">)</span>
</code></pre></div>
<h1 id="section">要点</h1>
<p>type 基本没有什么难度，因为他还是属于 puppet DSL 的运用。可以在其他配置文件内部直接写 define type，不过 puppet-lint 工具会报一个 warnings，所以建议还是单独拆分出来。</p>
<p>function 首先是路径和命名问题。</p>
<ol>
  <li>要把写 function 的文件放在 <code>${modulepath}/yourmodule/lib/puppet/parser/functions/</code> 路径下；</li>
  <li>和其他 type、class 一样，文件名必须和 function 一致，puppet 才能 autoload；</li>
  <li>格式是固定的，注意有两种:type，statement和rvalue。如果你的 function 目的是返回一个值给 puppet 继续使用，要指定好。默认是 statement；</li>
  <li>在自定义 function 里调用其他 function 有两种办法，一种写全路径 <code>Puppet::Parser::Functions.function('file')</code>；一种是使用 <code>Puppet::Parser::Functions.autoloader.loadall</code> 加载全部 function，然后用 <code>function_**</code> 的方式来调用；</li>
  <li>示例中最关键的一个是调用了 <code>function_create_resources</code> 。<code>create_resources</code> 用来批量创建资源。直接在 puppet 配置文件里使用的时候，接收的是列表参数。但是在 Ruby 里直接使用 <code>function_create_resources</code> 的话，接收的是一个匿名数组作为唯一参数。</li>
  <li>function 和 type 在 puppet 中可以认为是 class 的一种，所以它们也是有自己的作用域的。所以看到传递参数时写的是 &ldquo;nginx::vhost4proxy&rdquo;。</li>
</ol>
<h1 id="section-1">参考内容</h1>
<p>关于 Facts 在 function 中的运用，rvalue 的示例等更多内容见官网：<a href="http://docs.puppetlabs.com/guides/custom_functions.html">http://docs.puppetlabs.com/guides/custom_functions.html</a>。</p>
<p>关于 puppet 自带的各种 function 的说明，见官网(很多也没写)：<a href="http://docs.puppetlabs.com/references/latest/function.html">http://docs.puppetlabs.com/references/latest/function.html</a>。</p>
<h1 id="section-2">鸣谢</h1>
<p>感谢 <a href="http://weibo.com/liucy1983">@liu.cy</a> 童鞋提醒我变量作用域的问题。function 的调试过程很痛苦。</p>
      <a href="/2013/01/31/puppet-define-type-and-custom-function" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/01/11/systemtap-to-debug-kmsg-dump" title="用 systemtap 调试 kmsg dump" rel="bookmark">用 systemtap 调试 kmsg dump</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-01-11 00:00:00 +0800">11 Jan 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>google 之前推出了一个 netoops 的 patch，可以让 linux kernel 在崩溃的时候通过 udp 协议把信息发送到远端主机上。我之前在 CentOS6.2 的内核上做过测试，详细做法可以参见淘宝内核组 wiki 的<a href="http://kernel.taobao.org/index.php/Documents/Kernel_build">编译使用淘宝内核</a>和 <a href="kernel.taobao.org/index.php/Documents/Kernel_netoops_howto">netoops 使用指南</a>。唯一有区别的地方就是淘宝使用的 RedHat6 的内核在 CentOS6 上有签名问题，需要自己从 CentOS 官网 ftp 下载 src.rpm 来用 —— 当然如果要自己搞定编译那步，少不了就要自己修改 config-genaric 和 kernel.spc 文件了。</p>
<p>昨天同事升级修改到 CentOS6.3 内核( 2.6.32.220 -&gt; 2.6.32.279 )上。结果发现修改冲突代码编译通过后，再使用 soft dump 方式测试，远端主机 nc 收不到结果了。</p>
<p>稍微 grep 一下代码，发现是在 <code>kernel/printk.c</code> 里定义 <code>void kmsg_dump()</code> 的。好了，使用 systemtap 来检查这里： </p>
<div class="highlight"><pre><code class="c">    <span class="n">stap</span> <span class="o">-</span><span class="n">ve</span> <span class="err">&#39;</span><span class="n">probe</span> <span class="n">kernel</span><span class="p">.</span><span class="n">function</span><span class="p">(</span><span class="s">&quot;kmsg_dump&quot;</span><span class="p">){</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="err">$$</span><span class="n">vars</span><span class="err">$$</span><span class="p">)}</span><span class="err">&#39;</span>
</code></pre></div>
<p>结果发现在 soft dump 的时候有输出，也就是说调用了 <code>kmsg_dump()</code>。</p>
<p>比较 2.6.32.220 和 2.6.32.279 的代码，发现在 <code>kmsg_dump()</code> 里，新内核多了一点判断，如果reason 低于 <code>KERNEL_OOPS</code> 而且没有设置 <code>always_kmsg_dump</code> 变量，那么直接返回不再 <code>dumper-&gt;dump()</code> 了。</p>
<div class="highlight"><pre><code class="c"><span class="mi">1546</span>    <span class="k">if</span> <span class="p">((</span><span class="n">reason</span> <span class="o">&gt;</span> <span class="n">KMSG_DUMP_OOPS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">always_kmsg_dump</span><span class="p">)</span>
<span class="mi">1547</span>            <span class="k">return</span><span class="p">;</span> 
</code></pre></div>
<p>我们验证一下是不是这个原因：</p>
<div class="highlight"><pre><code class="c">    <span class="n">stap</span> <span class="o">-</span><span class="n">gve</span> <span class="err">&#39;</span><span class="n">probe</span> <span class="n">kernel</span><span class="p">.</span><span class="n">statement</span><span class="p">(</span><span class="s">&quot;*@kernel/printk.c:1548&quot;</span><span class="p">)</span>  <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="err">$$</span><span class="n">parms</span><span class="err">$$</span><span class="p">)</span> <span class="p">}</span><span class="err">&#39;</span>
</code></pre></div>
<p>显然测试的时候 reason 是 <code>KERNEL_SOFT</code>，这个是不好调的，那么我们可以调整这个变量，找了一下没发现这个可以在 sysctl 什么的里面，所以继续用 systemtap 搞定：</p>
<div class="highlight"><pre><code class="c">    <span class="n">stap</span> <span class="o">-</span><span class="n">gve</span> <span class="err">&#39;</span><span class="n">probe</span> <span class="n">kernel</span><span class="p">.</span><span class="n">statement</span><span class="p">(</span><span class="s">&quot;*@kernel/printk.c:1545&quot;</span><span class="p">)</span>  <span class="p">{</span> <span class="err">$</span><span class="n">always_kmsg_dump</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="err">$</span><span class="n">always_kmsg_dump</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="err">$$</span><span class="n">parms</span><span class="err">$$</span><span class="p">)</span> <span class="p">}</span><span class="err">&#39;</span>
</code></pre></div>
<p>果然搞定。</p>
      <a href="/2013/01/11/systemtap-to-debug-kmsg-dump" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/01/10/update-puppet-to-3.0" title="升级 Puppet 到 3.0 及其他附件简介" rel="bookmark">升级 Puppet 到 3.0 及其他附件简介</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-01-10 00:00:00 +0800">10 Jan 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>今天把 puppet 从2.7 升级到了 3.0。同时放弃了之前通过 ENC 定义所有 top scope variable 的做法，改成只定义一个 role 变量，然后在各个 module 里根据 $role 加载不同的module::role ，把变量都写在 module::role 里。</p>
<p>经历过上次事故后，我对全局变量已经大大的有不安全感，包括 puppet 3.0 新进内核的 hiera (<a href="http://docs.puppetlabs.com/puppet/3/reference/lang_classes.html#using-hierainclude">官网介绍文档</a>中也说是&rdquo;like a lightweight ENC&rdquo;)。虽然 module::role 看起来很多是重复内容，还是让人工的操作多经过一些检测才放心。</p>
<p>从 2.7 升级到 3.0 没有太多的不适应。官网上列了很多<a href="http://docs.puppetlabs.com/puppet/3/reference/release_notes.html">不同</a>。不过实际上基本没改动什么。</p>
<ul>
  <li>运行命令统一成 <code>puppet command</code> 的形式，2.7的时候还保留的一堆命令都没有了。</li>
  <li><code>--apply</code> 改成 <code>--catalog</code>  了。不过这个其实我没用过。</li>
  <li><code>pluginsync</code> 默认开启了。这个是替代 <code>factsync</code> 的。2.7 的时候默认还是关闭。给 facter 写插件应该是很容易而且很必要的事情。</li>
  <li>master 内置 webserver 取消了。也就是说原先各种优化文档里的 <code>--servertype=mongrel</code> 没用了。但是 3.0 变成了标准 Rack 应用。直接在 <code>/etc/puppet/rack</code> 下运行 <code>rackup -s thin -p 18140 -D -P /tmp/puppetmaster.pid</code> 就可以了。</li>
  <li>自然对应的 rack 配置文件 <code>config.ru</code> 改了，看 example 就好。</li>
  <li><code>include</code> 可以传递数组</li>
  <li>agent 的 lockfile 把 fork running 和 disabled 区分成两个文件了。不知道能不能消灭掉原先 agent 跑着跑着僵死的情况。</li>
</ul>
<p>以上是官网列举的主要内容。以下还有我__实际测试中发现的问题__：</p>
<ul>
  <li>agent 的 puppet.conf 里需要添加一行 <code>preferred_serialization_format = yaml</code>，否则默认使用 pson 会直接报错。</li>
</ul>
<hr />
<p>今天重温了一下 github 在 puppetconf 上的讲演<a href="https://speakerdeck.com/jnewland/chatops">《chatops》</a>。当然对其中的 hubot 不是重点关注。主要是其中提到的 rodjek 的几个 puppet 相关的项目觉得蛮有用的。</p>
<ul>
  <li>puppet-lint </li>
</ul>
<p>地址：<a href="https://github.com/rodjek/puppet-lint.git">https://github.com/rodjek/puppet-lint.git</a></p>
<p>这是一个语法格式检查器，如果 ERROR 会 <code>exit 1</code>。之前两天我还刚在 CPAN 上发现过一个 <a href="https://metacpan.org/module/Puppet::Tidy">Puppet::Tidy</a> 模块。不过目前为止，这两个都不是很满意：</p>
<ol>
  <li>puppet-lint 只能检查格式而不会替你修改格式。</li>
  <li>puppet-tidy 可以修改格式但是它对格式的检查太简陋了。</li>
</ol>
<p>当然比 puppet-tidy 稍微好一些的 puppet-lint 也不是很精准，比如他会对所有用双引号定义的变量报 &ldquo;WARNING: double quoted string containing no variables&rdquo;；而 puppet-tidy 更奇怪的给我 ip 地址的最后一段再加上了一个单引号变成了下面这个样子：</p>
<div class="highlight"><pre><code class="perl">    <span class="nv">$iplist</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;192.168.1.&#39;2&#39;&quot;</span><span class="p">,</span><span class="s">&quot;192.168.1.&#39;3&#39;&quot;</span><span class="p">]</span>
</code></pre></div>
<p>只能说规范化任重道远。</p>
<ul>
  <li>puppet-profiler</li>
</ul>
<p>地址：<a href="https://github.com/rodjek/puppet-profiler.git">https://github.com/rodjek/puppet-profiler.git</a></p>
<p>这是一个 agent 执行的调试器，不过至今为止功能也还很简单：就是执行一次 </p>
<div class="highlight"><pre><code class="bash">    puppet agent --test --evaltrace --nocolor
</code></pre></div>
<p>排序各个 Resource 的执行耗时，并打印前十名。</p>
<ul>
  <li>rspec-puppet</li>
</ul>
<p>地址：<a href="https://github.com/rodjek/rspec-puppet">https://github.com/rodjek/rspec-puppet</a></p>
<p>这是一个 puppet 的 rspec 测试工具扩展。注意他依赖于 <code>puppetlabs_spec_helper</code> 但是 gem 里却没写。。。</p>
<p>使用方法看 github 上的说明比较详细了，稍后我再单写一篇介绍。</p>
      <a href="/2013/01/10/update-puppet-to-3.0" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/01/10/rspec-puppet-intro" title="给 puppet 写 Rspec 测试用例" rel="bookmark">给 puppet 写 Rspec 测试用例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-01-10 00:00:00 +0800">10 Jan 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上文提到 github 给 puppet 开发的几个附件。其中有扩展 rspec 的 rubygems 模块叫做 rspec-puppet。官网见：<a href="http://rspec-puppet.com">http://rspec-puppet.com</a></p>
<p>照着官网 <a href="http://rspec-puppet.com/tutorial/">Tutorial</a>，很容易能写出来测试用例。我这样ruby入门没看完的水准，从发现这个gem到写完第一个测试用例，也就花了不到半个小时。</p>
<h1 id="section">安装</h1>
<div class="highlight"><pre><code class="bash">    gem install puppetlabs_spec_helper rspec_puppet
</code></pre></div>
<h1 id="section-1">创建测试用例环境</h1>
<p>以测试 nginx 模块为例：</p>
<div class="highlight"><pre><code class="bash">    <span class="nb">cd</span> /etc/puppet/modules/nginx
    rspec-puppet-init
</code></pre></div>
<p>这个 init 脚本其实就是执行了一串 <code>mkdir -p</code> 和 <code>ln -s</code> 命令，最后生成一个总的 Rakefile 。详情见官网<a href="http://rspec-puppet.com/setup/">Setup</a>。</p>
<h1 id="section-2">编写测试用例</h1>
<p>扩展给 Rspec 增加的方法其实不多，官网 <a href="http://rspec-puppet.com/matchers/">Matchers</a> 页面上有说。主要就是下面几个：</p>
<ul>
  <li><code>include_class()</code></li>
  <li><code>contain_&lt;resource&gt;()</code></li>
  <li><code>run()</code></li>
  <li><code>.with()</code></li>
  <li><code>.without()</code></li>
</ul>
<p>现在来写我们的第一个测试用例 <code>/etc/puppet/modules/nginx/spec/classes/common_spec.rb</code> 吧：</p>
<div class="highlight"><pre><code class="ruby">    <span class="c1"># 这个文件被 init 自动生成在 /etc/puppet/modules/nginx/spec/ 下了</span>
    <span class="c1"># 其内容就是加入这个目录下所有的文件</span>
    <span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
    <span class="c1"># 这里定义你要测试的 puppet module</span>
    <span class="n">describe</span> <span class="s1">&#39;nginx&#39;</span> <span class="k">do</span>
        <span class="n">it</span> <span class="k">do</span>
            <span class="n">should</span> <span class="n">include_class</span><span class="p">(</span><span class="s1">&#39;nginx::sysctl&#39;</span><span class="p">)</span>
            <span class="n">should</span> <span class="n">include_class</span><span class="p">(</span><span class="s1">&#39;nginx::install&#39;</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">describe</span> <span class="s1">&#39;nginx::common&#39;</span> <span class="k">do</span>
        <span class="c1"># 使用let定义变量</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:node</span><span class="p">)</span> <span class="p">{</span> <span class="s1">&#39;common-nginx-2.domain.com&#39;</span> <span class="p">}</span>
        <span class="c1"># 不定义的话，测试中只有从前面:node 生成的 hostname,domain,fqdn 三个</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:facts</span><span class="p">)</span> <span class="p">{</span> <span class="p">{</span>
            <span class="ss">:ipaddress_eth0</span> <span class="o">=&gt;</span> <span class="s1">&#39;192.168.1.2&#39;</span><span class="p">,</span>
            <span class="ss">:processorcount</span> <span class="o">=&gt;</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span>
        <span class="p">}</span> <span class="p">}</span>
        <span class="n">it</span> <span class="k">do</span>
            <span class="n">should</span> <span class="n">include_class</span><span class="p">(</span><span class="s1">&#39;nginx::common&#39;</span><span class="p">)</span>
            <span class="c1"># 注意这里要写 Resource 的名字，而不是 file 的 path</span>
            <span class="c1"># 这个是下面 .with 检查的 :param</span>
            <span class="n">should</span> <span class="n">contain_file</span><span class="p">(</span><span class="s1">&#39;proxy.conf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">({</span>
                <span class="s1">&#39;ensure&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mode&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;0644&#39;</span><span class="p">,</span>
                <span class="s1">&#39;path&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;/etc/nginx/conf.d/proxy.conf&#39;</span>
            <span class="p">})</span>
        <span class="k">end</span>
        <span class="n">context</span> <span class="s1">&#39;access_log&#39;</span> <span class="k">do</span>
            <span class="n">expect_line</span> <span class="o">=</span> <span class="s1">&#39;access_log /data/nginx/logs/access.log main buffer=16k;&#39;</span>
            <span class="n">it</span> <span class="k">do</span>
                <span class="c1"># 注意这里是把整个 content 作为 String 对象传递</span>
                <span class="n">should</span> <span class="n">contain_file</span><span class="p">(</span><span class="s1">&#39;nginx.conf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">with_content</span><span class="p">(</span><span class="sr">/</span><span class="si">#{</span><span class="n">expect_line</span><span class="si">}</span><span class="sr">/</span><span class="p">)</span>
            <span class="k">end</span>
        <span class="k">end</span>
        <span class="n">context</span> <span class="s1">&#39;upstream&#39;</span> <span class="k">do</span>
            <span class="n">expect_line</span> <span class="o">=</span> <span class="s1">&#39;192.168.1.2:80;&#39;</span>
            <span class="n">it</span> <span class="k">do</span>
                <span class="n">should</span> <span class="n">contain_file</span><span class="p">(</span><span class="s1">&#39;upstream.conf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">with_content</span><span class="p">(</span><span class="sr">/</span><span class="si">#{</span><span class="n">expect_line</span><span class="si">}</span><span class="sr">/</span><span class="p">)</span>
            <span class="k">end</span>
        <span class="k">end</span>
        <span class="n">context</span> <span class="s1">&#39;conf.d&#39;</span> <span class="k">do</span>
            <span class="n">it</span> <span class="k">do</span>
                <span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;/etc/puppet/modules/nginx/files/conf.d&#39;</span>
                <span class="c1"># eq 是 rspec 本身的方法</span>
                <span class="no">Dir</span><span class="o">.</span><span class="n">entries</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
            <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>
</code></pre></div>
<p>然后你就可以运行测试了：</p>
<div class="highlight"><pre><code class="bash">    <span class="nb">cd</span> /etc/puppet/modules/nginx
    rake spec
</code></pre></div>
<p>如果测试用例有失败，会在终端看到错误信息。</p>
<p>注意到，rspec 是以 <code>do ... end</code> 来计算 examples 个数的。在一个 <code>do ... end</code> 里写多个 should 或者 expect，也算一个 example。</p>
      <a href="/2013/01/10/rspec-puppet-intro" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/01/06/limit-bandwidth-of-one-process" title="限制单个进程的带宽" rel="bookmark">限制单个进程的带宽</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-01-06 00:00:00 +0800">06 Jan 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>限制带宽简直就是系统管理员的永恒话题之一。当然我这里就不讨论端口限速什么的了，百度一下一大把。但如果要的是限制某个特定进程的带宽，事情就有趣多了。</p>
<h1 id="iptables">iptables</h1>
<p>大多数文档还是提供的传统思路，用 <code>iptables</code> 的 <code>owner</code> 模块，给 <code>--pid-owner</code> 加上 <code>MARK</code>，然后 <code>tc</code> 里针对这个 MARK 做限速。用法和限制如 <a href="http://lists.netisland.net/archives/plug/plug-2004-09/msg00454.html">http://lists.netisland.net/archives/plug/plug-2004-09/msg00454.html</a> 说的这样。不过和这个快十年前的文章相比，现在的服务器上，基本已经普及了 SMP ，更进一步的，内核已经在自动发现支持 SMP 的时候，在 iptables 里把 owner 模块的 pid/cmd/sid 三个 match 都去掉了！现在的 owner 里只有 uid/gid 两个。所以这条路，在生产环境上基本行不通。</p>
<p>在 <a href="http://unix.stackexchange.com/questions/34116/how-can-i-limit-the-bandwidth-used-by-a-process">stackexchange</a> 上，大家集思广益、献策献宝，又提出了另外两个工具，那个叫 <code>pipeviewer</code> 的应用场景比较特定(楼主问题是发生在 sshfs 上)，就不多说了。剩下这个 <code>trickle</code> 真是小众利器。值得一提：</p>
<h1 id="trickle">trickle</h1>
<p>官方主页：<a href="http://monkey.org/~marius/pages/?page=trickle">http://monkey.org/~marius/pages/?page=trickle</a></p>
<p>这是一个在 BSD 上诞生的项目，官网上说只在 i386 的 linux 验证过。不过我在 x86_64 的 linux 替大家尝试了一把，没有问题~</p>
<div class="highlight"><pre><code class="bash">    yum install libevent-devel
    wget http://monkey.org/~marius/trickle/trickle-1.06.tar.gz
    tar zvxf trickle-1.06.tar.gz
    <span class="nb">cd </span>trickle-1.06
    ./configure
    <span class="c"># 生成的 config.h 里重复定义了 in_addr_t 结构体</span>
    <span class="c"># 跟 include 的 /usr/include/netinet/in.h 里冲突</span>
    <span class="c"># 会报错 &quot;error: two or more data types in declaration specifiers&quot;</span>
    sed -i <span class="s1">&#39;s!\(#define in_addr_t\)!//\1!&#39;</span> config.h
    make
    make install
</code></pre></div>
<p>命令使用非常简单：</p>
<div class="highlight"><pre><code class="bash">    trickle -s -d 100 wget http://domain/path/to/file.suffix -O /dev/null
</code></pre></div>
<ul>
  <li>-s 表示独立运行，因为 trickle 还有一个 trickled 管理端可以用；</li>
  <li>-d 表示下载方向；</li>
  <li>-u 表示上传方向，两个的单位都是KB/s。</li>
</ul>
<p>这个工具使用了 ELF 的 preloader 机制，在命令执行的时候替换掉标准库中的 socket recv() 和 send() 部分，达到限速的效果。其原理图在<a href="http://monkey.org/~marius/trickle/trickle.pdf">官方PDF</a> 中，如下：</p>
<p><img src="/images/uploads/trickle.png" alt="" /></p>
<p><strong>不过总监大人及时提示我们： 由于该机制的限制，此工具对静态编译的程序无效，对采用 suid 的程序无效！</strong></p>
<h1 id="cgroup">cgroup</h1>
<p>排除上面两个无效，其实 trickle 依然无法覆盖全部应用场景 —— 比如说已经启动的后台进程长期运行，我有 pid ，但是不想中断掉重新起来；或者说这个进程可能我想让他白天跑 10MBps 晚上跑 40MBps 这样动态的。</p>
<p>这个时候就需要动用一些高级工具了，欢迎 <code>CGROUP</code> 上场。</p>
<p><code>cgroup</code> 有 <code>net_cls</code> 控制器。不过和其他控制器不太一样的是它不直接控制网络读写，只是给网络包打上一个标记，然后把专业的事情交给专业的 TC 去做。嗯，思路和原先的 iptable 是很类似的。</p>
<p>参考文档很少，感觉大家使用 cgroup 都集中在 cpu 和 blkio 方面了。目前所见只有 <a href="https://access.redhat.com/knowledge/articles/215353">redhat</a> 这个 pdf：<a href="http://vger.kernel.org/netconf2009_slides/Network%20Control%20Group%20Whitepaper.odt">http://vger.kernel.org/netconf2009_slides/Network%20Control%20Group%20Whitepaper.odt</a> 。实施步骤如下：</p>
<h2 id="tc">启用 tc</h2>
<div class="highlight"><pre><code class="bash">    tc qdisc del dev eth0 root
    tc qdisc add dev eth0 root handle 1: htb
    tc class add dev eth0 parent 1: classid 1: htb rate 1000mbit ceil 1000mbit
    tc class add dev eth0 parent 1: classid 1:3 htb rate 10mbit 
    tc class add dev eth0 parent 1: classid 1:4 htb rate 10kbit
    tc filter add dev eth0 protocol ip parent 1:0 prio 1 handle 1: cgroup
</code></pre></div>
<h2 id="cgroup-1">配置 cgroup</h2>
<div class="highlight"><pre><code class="bash">    <span class="c"># 命令行使用</span>
    mount -t cgroup net_cls -o net_cls /cgroup/net_cls/
    <span class="nb">cd</span> !<span class="err">$</span>
    cgcreate -g net_cls:test
    <span class="nb">echo</span> <span class="s1">&#39;0x10004&#39;</span> &gt; /cgroup/net_cls/test/net_cls.classid 
    <span class="c"># 然后可以导出成文件之后通过工具管理</span>
    yum install -y libcgroup
    cgsnapshot -s &gt; /etc/cgconfig.conf
    /etc/init.d/cgconfig restart
</code></pre></div>
<h2 id="cgroup-">测试 cgroup 效果</h2>
<div class="highlight"><pre><code class="bash">    <span class="nb">time </span>scp bigfile root@192.168.0.26:/tmp/
    <span class="nb">time </span>cgexec -g net_cls:test scp bigfile root@192.168.0.26:/tmp/
    <span class="nb">echo</span> <span class="nv">$$</span> &gt; /cgroup/net_cls/test/tasks
    tc class change dev eth0 parent 1: classid 1:4 htb rate 1mbit
    <span class="nb">time </span>scp bigfile root@192.168.0.26:/tmp/
</code></pre></div>
<p>可以看到后两次的速度比第一次慢很多。</p>
<p>第三次也被限制住，是因为 cgroup 会自动把子进程的 pid 也加入 tasks 里。</p>
<h1 id="section">总结及其它</h1>
<ul>
  <li>trickle 在 download 的时候限制非常管用，在 upload 的时候大概起始速度会比限制值高几倍，然后以 100KB/s 的速度往下减。感觉是 smooth 的问题，不过调整相关参数也没见到区别。</li>
  <li>cgroup 给 tc 打标签的办法，看到 tc 限制下的速度波动比较大，猜测 tc 应该是类似 10 秒钟统计一次平均值是否超过限制这样的行为？</li>
</ul>
      <a href="/2013/01/06/limit-bandwidth-of-one-process" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/30/report-of-this-year" title="2012 年个人总结" rel="bookmark">2012 年个人总结</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-30 00:00:00 +0800">30 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>2012 年还剩下最后 30 个小时。总结一下这一年。</p>
<p>4 月是本年度最重要的一个月，在这个月换工作到了人人，告别了之前八个月乱七八糟的工作状态，再不换，人就要被玩残了。感谢<a href="http://weibo.com/u/1653644220">@懒桃儿吃桃儿</a>的飞速决断。作为自我激励，在换工作的那个周末去搞定了人生大事（好吧，其实压根不是啥激励，应该叫水到渠成）……</p>
<p>9 月是另一个关键点，入职的第一个季度总结，确认自己虽然荒废了八个月，但还没掉队。既然安心自己不至于失业，也就顺带去转职了房奴。</p>
<p>技术博客上还是说点技术点的。</p>
<h1 id="logstash--elasticsearch-">第一、大半年的事情在和 <code>logstash</code> + <code>ElasticSearch</code> 系统打交道。</h1>
<p>这个偶然在 oschina 上看到的项目，已经成为我心目中 <code>splunk</code> 的最佳开源替代品。从 5 月动手测试，到现在为止，写过 2 个相关的 ppt，做过 1 次技术分享，发了 8 篇相关原创博客文章，翻译了 2 篇官网文章，在微博和 QQ 上和大概 10 个左右的朋友交流了搭建、优化的心得。考虑是不是搞个地方存一下这些交流。前几天看 <code>CloudFoundry</code> 里都有专门的 <code>ElasticSearch</code> 组件。相信云时代这个穷人版 <code>splunk</code> 可以走得更远 —— 嗯，不会写 java 用 <code>hadoop</code> 的运维真的都可以试试。</p>
<h1 id="perl-">第二、Perl 相关。</h1>
<p>本年度关于 <code>Perl</code> 最多的运用是 <code>Dancer</code> web开发框架。在 dancer 和 twitter bootstrap 的帮助下做的内部运维工具网站看起来还有那么点意思。使用过程中学会用 IRC 工具和社区进行交流，提供了一个 plugin-upload-progress 的想法，发了两个 patch ，一个给 plugin-flashmessage 同时支持使用 <code>coderef</code> 的 TT2 和 <code>object</code> 的 Text::Xslate 模版，一个给 plugin-auth-extensible 的角色认证加上正则匹配的特性。虽然扶凯已经全面转向使用 <code>Mojolicious</code> 框架了，不过我依然喜欢 dancer 这种广泛使用关键字的方式 —— 少写好多 <code>$self-&gt;</code> 或者 <code>app-&gt;</code> 呢~ 另一个记忆深刻的是某天有人热心的上来说：“我们要多写博客宣传 Dancer 在云计算的运用”，被作者喷还不如给我多写两个插件……</p>
<p>然后是 <code>Message::Passing</code> 框架，这是 <code>logstash</code> 项目的 perl port。不过个人纯属好玩和不服气，看完代码当作学习 perl 的 Moo 对象系统了。值得一提是虽然没线上用，倒是找了个周末写了两个模块 <code>Message::Passing::Filter::Regexp</code> 和 <code>Message::Passing::Output::PocketIO</code> 上传到 CPAN 了。总算不是光拿不贡献的 perler 了。然后发现 <code>Test::More</code> 真的蛮不错的，写第二个模块的时候基本就是先写好 test 再写 lib 了，据说这叫 TDD ？</p>
<p>然后是 <code>Rex</code> 项目，这是一个类似 <code>func</code> 和 <code>capistrano</code> 的项目。这类项目和 <code>puppet</code>、<code>chef</code>、<code>cfengine</code> 和 <code>lcfg</code> 的区别，我觉得是运行目的。cf 系要求的是保持 agent 的配置一致，而 rex 等的目的是给同类目的执行同类任务。这个区别在 2008 年的 sysadmin 里就已经解释过，不过似乎很多人一直在重复问~ 因为 perl 目前还没有像 ruby 的 rakefile 这样流行的任务清单控制(其实有个日本人写的pake，不过在日本人的诸多 modern perl 项目里，我觉得这个 clone 的不咋地)，所以我现在都用 Rexfile 来做 task 了，也算一种用法。顺带给只能用 <code>Net::SSH2</code> 的 Rex 提交了 <code>Net::OpenSSH</code> 驱动，不过作者很负责任的说要等自己搞出来一套 KerberOS5 认证环境测试我的 pull request 是否能运行后才 merge …… 国内还有哪里用 krb5 认证滴？</p>
<p>最后是 <code>SmokePing</code> 项目。说实话真没想到这么有名的监控项目代码乱成这个样子。好几次涌现出改写整个项目的疯狂念头，不过看看时间表，想想 rrd 那部分代码看不太懂，放弃了。只好在边边角角上做点修改 —— 顺带再次证明，在 web 开发方面，perl 不是输给了 php/python/ruby ，而是不会 css/js 的 perler 输给了那些会 css/js 的phper/pythoner/rubyer……</p>
<p>附带提一下 <code>nginx_perl</code> 项目，这个和 <code>nginx_lua</code> 一样的全流程非阻塞式的东东，最终我还是没找到机会真正用上，白瞎偶去年底很开心的给它写 ppt 推介了。大抵还用 perl 的同学觉得用 <code>Nginx</code> 内置的阻塞式的 perl 已经够用了？</p>
<h1 id="section">第三、运维、测试</h1>
<p>要感谢人人这个平台，日常运维之余完成了几个测试，<code>Apache Traffic Server</code> 的因为前设条件比较多，结论不具有普遍性；<code>Nginx</code> 的万兆网络环境测试还是很有趣的 —— 嗯，虽然最后的脚本依然很难看，拿不出手见人，不过结果还是有力的。<a href="http://weibo.com/u/2266920742">@张纹华</a> ，你的框架要好好搞~</p>
<p><code>Squid</code> 从我工作以来就在折腾，看样子是要继续折腾下去。感谢 <code>systemtap</code> 工具，或许明年我在缓慢的学习 C 语言开发的同时，尽量快的搞定那两个问题吧，阿弥陀佛，哈利路亚……</p>
<p><code>puppet</code> 已经风靡全球，也确实还算好用。我从接触开始就一眼相中了 ENC 接口，不过好像问一圈没谁注意这个。大多数人直接把 hostname 规划和 puppet 连起来了。这部分到底怎样才是 best practice ，还要慢慢看了。</p>
<p><code>fpm</code> 命令行工具，又是一个 <a href="https://github.com/jordansissel">jordansissel</a> 的 ruby 项目。一般情况下的 package 生成，绝对够用，和 logstash 一样也是我有事没事就推广一下的好东东。</p>
<p><code>linux</code> 的邮件列表订阅之后迅速的被我过滤掉了，那么多邮件，你们是怎么看过来的，kernel 学习任重道远。</p>
<h1 id="section-1">第四、学习</h1>
<p>上半年，<a href="http://weibo.com/kandeng">@邓侃</a> 博士在北航的云计算公开课基本都去听了。虽然个人工作重点完全不在这方面，不过依然觉得是有所得的。顺带想起某节课后和 <a href="http://weibo.com/ovise">@R_exify</a> 在北航东门外的肯德基里推导怎么设计一个对外透明的 MySQLaaS。大概吹牛就是这样子的……</p>
<p>关于 lua，ruby，javascript，基本都是用到临头抱佛脚，不过对 ruby 和 js 都有深入学习的想法，但是我怨念已久的 C 啊，啥时侯才能学会你。不知道为什么对 python 就是没感觉。话说昨晚在微博上看到有人说看 python 的源码觉得它的 OO 和 lua 很像。顿时我就很郁闷，因为之前我看 lua 的时候觉得 lua 实现的 OO 和 Perl5 很像的好吧。尼玛大家都像来像去的，你们 Pythoner 整天鄙视 Perl 干吗……</p>
<p>关于 CloudFoundry ，关注来关注去，基本停留在看新闻的阶段，一行代码没瞄过，连一个 micro 环境都没搭建过。嗯，不过考虑到毕竟看了不少新闻，还是留一笔。</p>
<p>关于微博，有微博之后，学习成本确实降低了，因为很多问题你可以直接圈人……不过我的同学朋友们肯定对我的微博内容是“眼不见心不烦”了的。哈哈~</p>
<h1 id="section-2">总之，这是无比充实的一年。</h1>
<p>排除掉每个季度末，比如现在，对下季度工作计划的茫然外。</p>
<p>感谢自己依然充满对知识的渴望，让年终的总结显得这么充实和踏实。</p>
      <a href="/2012/12/30/report-of-this-year" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/30/how-to-install-external-binary-as-perl-modules-dependment" title="perl 模块打包加入外部依赖程序" rel="bookmark">perl 模块打包加入外部依赖程序</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-30 00:00:00 +0800">30 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Perl 社区并不是所有的东西都发布在 CPAN 上。甚至专门有一个 <code>Module::ThirdParty</code> 模块记录这些非 CPAN 的 perl 项目列表。其中最有名的应该就属写博客的 <code>Movable Type</code> 和做监控的 <code>SmokePing</code> 了。</p>
<p>但是如果个人图方便又想把 smokeping 打包方便部署使用的时候，就会发现一点小问题：打包成rpm，很多 perl 的依赖模块不一定在系统 repo 里存在；打包成 perl 的模块，smokeping 最常用的几个 probe 比如 fping、curl 什么的，又是非 perl 程序，cpanm 没法解决这个 <code>requires_external_bin</code> ，最多只能报错退出。</p>
<p>其实这里可以采取一些别的办法，虽然笨一些，但是解决问题。</p>
<p>首先还是让我们创建一个示例模块：</p>
<div class="highlight"><pre><code class="bash">    cpanm Module::Starter Module::Build
    module-starter --module Alien::FPing --author<span class="o">=</span><span class="s2">&quot;Jeff Rao&quot;</span> --email<span class="o">=</span><span class="s2">&quot;myname@gmail.com&quot;</span> --mb
</code></pre></div>
<p>然后就会在本目录下创建一个 Alien-FPing 目录，自带好了 <code>Build.PL</code> 等模块文件。这里使用了 <code>Alien::</code> 的名字空间，是一个潜规则，有些项目依赖 C 源码的库和头文件，就用 perl 包一层来安装，都放在这个空间下，比如 <code>Alien::V8</code>, <code>Alien::Gearmand</code>, <code>Alien::IE7</code> 等等。</p>
<p>现在让我们下载 fping 的源码放到模块里：</p>
<div class="highlight"><pre><code class="bash">    mkdir Alien-FPing/src
    wget http://www.fping.org/dist/fping-3.4.tar.gz -O Alien-FPing/src/fping-3.4.tar.gz
</code></pre></div>
<p>接下来应该就是编写 <code>Build.PL</code> 了。不过为了尽量让 <code>Build.PL</code> 看起来简洁而且一眼看出目的。我们最好把编译操作单独定义一个模块来使用：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="nn">Alien::FPing::</span><span class="n">Build</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">base</span> <span class="sx">qw(Module::Build)</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">File::</span><span class="n">Spec</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Archive::</span><span class="n">Tar</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$RootDir</span> <span class="o">=</span> <span class="nn">File::</span><span class="n">Spec</span><span class="o">-&gt;</span><span class="n">rel2abs</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$SrcDir</span> <span class="o">=</span> <span class="nn">File::</span><span class="n">Spec</span><span class="o">-&gt;</span><span class="n">catdir</span><span class="p">(</span><span class="nv">$RootDir</span><span class="p">,</span> <span class="s">&quot;src&quot;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$FPingVersion</span> <span class="o">=</span> <span class="s">&#39;3.4&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$FPingName</span> <span class="o">=</span> <span class="s">&quot;fping-${FPingVersion}&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$FPingSrc</span> <span class="o">=</span> <span class="s">&quot;${FPingName}.tar.gz&quot;</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">ACTION_build</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
        <span class="nb">chdir</span><span class="p">(</span><span class="nv">$SrcDir</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span>  <span class="o">!-</span><span class="n">x</span> <span class="s">&quot;/usr/sbin/fping&quot;</span> <span class="ow">and</span> <span class="o">!-</span><span class="n">d</span> <span class="nv">$FPingName</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$tar</span> <span class="o">=</span> <span class="nn">Archive::</span><span class="n">Tar</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
            <span class="nv">$tar</span><span class="o">-&gt;</span><span class="nb">read</span><span class="p">(</span><span class="nv">$FPingSrc</span><span class="p">);</span>
            <span class="nv">$tar</span><span class="o">-&gt;</span><span class="n">extract</span><span class="p">();</span>
            <span class="nb">chdir</span><span class="p">(</span><span class="nv">$FPingName</span><span class="p">);</span>
            <span class="nb">system</span><span class="p">(</span><span class="s">&#39;./configure&#39;</span><span class="p">,</span> <span class="s">&#39;--prefix=/usr/&#39;</span><span class="p">,</span> <span class="s">&#39;--enable-ipv6&#39;</span><span class="p">);</span>
            <span class="nb">system</span><span class="p">(</span><span class="s">&#39;make&#39;</span><span class="p">);</span>
            <span class="nb">system</span><span class="p">(</span><span class="s">&#39;make install&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$self</span><span class="o">-&gt;</span><span class="nn">SUPER::</span><span class="n">ACTION_build</span><span class="p">();</span>
    <span class="p">};</span>
    <span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>几乎就是调用 shell 而已，唯一需要讲一下的就是这个 <code>ACTION_build</code>。这是 <code>Module::Build</code> 定义好的提供给 <code>subclass</code> 用的方法，事实上 <code>./Build help</code> 看得到的所有 action 都有类似的方法可以用。</p>
<p>然后稍微修改一下 Build.PL 如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="mf">5.006</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">warnings</span> <span class="n">FATAL</span> <span class="o">=&gt;</span> <span class="s">&#39;all&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">lib</span> <span class="s">&#39;inc&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Alien::FPing::</span><span class="n">Build</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$builder</span> <span class="o">=</span> <span class="nn">Alien::FPing::</span><span class="n">Build</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="n">module_name</span>         <span class="o">=&gt;</span> <span class="s">&#39;Alien::FPing&#39;</span><span class="p">,</span>
        <span class="n">license</span>             <span class="o">=&gt;</span> <span class="s">&#39;perl&#39;</span><span class="p">,</span>
        <span class="n">dist_author</span>         <span class="o">=&gt;</span> <span class="sx">q{Jeff Rao &lt;myname@gmail.com&gt;}</span><span class="p">,</span>
        <span class="n">dist_version_from</span>   <span class="o">=&gt;</span> <span class="s">&#39;lib/Alien/FPing.pm&#39;</span><span class="p">,</span>
        <span class="n">release_status</span>      <span class="o">=&gt;</span> <span class="s">&#39;stable&#39;</span><span class="p">,</span>
        <span class="n">configure_requires</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&#39;Module::Build&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">build_requires</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&#39;Test::More&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">requires</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="c1">#&#39;ABC&#39;              =&gt; 1.6,</span>
            <span class="c1">#&#39;Foo::Bar::Module&#39; =&gt; 5.0401,</span>
        <span class="p">},</span>
        <span class="n">add_to_cleanup</span>     <span class="o">=&gt;</span> <span class="p">[</span> <span class="s">&#39;Alien-FPing-*&#39;</span> <span class="p">],</span>
        <span class="n">create_makefile_pl</span> <span class="o">=&gt;</span> <span class="s">&#39;traditional&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="nv">$builder</span><span class="o">-&gt;</span><span class="n">create_build_script</span><span class="p">();</span>
</code></pre></div>
<p>把 <code>Module::Build</code> 替换成 <code>Alien::FPing::Build</code> 而已，其他都不用动。</p>
<p>然后试一下吧：</p>
<div class="highlight"><pre><code class="bash">    <span class="nb">cd </span>Alien-FPing
    perl Build.PL
    ./Build
</code></pre></div>
<p>看到编译输出，并且成功安装有 <code>/usr/sbin/fping</code> 了吧。现在可以打包了。注意默认生成的 ignore.txt 里，是排除掉了 inc 目录的，需要去除掉，然后修改 <code>MANIFEST</code> 文件加入 inc 和 src 里的文件，然后再打包出来的 perl 模块就可以直接用了。</p>
<div class="highlight"><pre><code class="bash">    sed -i <span class="s1">&#39;/inc/d&#39;</span> ignore.txt
    <span class="nb">echo</span> <span class="s1">&#39;inc/Alien/FPing/Build.pm&#39;</span> &gt;&gt; MANIFEST
    <span class="nb">echo</span> <span class="s1">&#39;src/fping-3.4.tar.gz&#39;</span> &gt;&gt; MANIFEST
    ./Build dist
</code></pre></div>
      <a href="/2012/12/30/how-to-install-external-binary-as-perl-modules-dependment" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/22/simple-local-website-for-sysadmin-advent-clone" title="给 Sysadmin Advent 快速搭建本地浏览网站" rel="bookmark">给 Sysadmin Advent 快速搭建本地浏览网站</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-22 00:00:00 +0800">22 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一年一度的 advent 集合中，除了 perl 的部分，还有 sysadmin 的也很吸引我等运维的眼球。不过 sysadmin 的一直是发表在blogspot 上，光荣的被 GFW 认证了。虽然说翻墙应该是这年头越来越普及的技能，但是能提供免墙的办法，想来那真真是极好的。</p>
<p>这里提供一个私以为很不错的办法。因为我很开心的发现 sysadvent 有托管在 github 上。</p>
<div class="highlight"><pre><code class="bash">    sudo apt-get install git
    git clone git://github.com/jordansissel/sysadvent.git
    sudo wget http://xrl.us/cpanm --no-check-certificate -O /sbin/cpanm
    sudo chmod +x /sbin/cpanm
    cpanm Plack DocLife
</code></pre></div>
<p>好了，准备工作完毕。然后在 sysadvent 目录下创建 app.psgi 文件如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="nn">Plack::</span><span class="n">Builder</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Plack::App::</span><span class="n">Directory</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">DocLife::</span><span class="n">Markdown</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$html_app</span> <span class="o">=</span> <span class="nn">DocLife::</span><span class="n">Markdown</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="n">root</span> <span class="o">=&gt;</span> <span class="s">&#39;.&#39;</span><span class="p">,</span>
        <span class="n">base_url</span> <span class="o">=&gt;</span> <span class="s">&#39;/html/&#39;</span><span class="p">,</span>
        <span class="n">suffix</span> <span class="o">=&gt;</span> <span class="s">&#39;.html&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$md_app</span> <span class="o">=</span> <span class="nn">DocLife::</span><span class="n">Markdown</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="n">root</span> <span class="o">=&gt;</span> <span class="s">&#39;.&#39;</span><span class="p">,</span>
        <span class="n">suffix</span> <span class="o">=&gt;</span> <span class="s">&#39;.md&#39;</span><span class="p">,</span>
        <span class="n">base_url</span> <span class="o">=&gt;</span> <span class="s">&#39;/md/&#39;</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$dir_app</span> <span class="o">=</span> <span class="nn">Plack::App::</span><span class="n">Directory</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">({</span>
        <span class="n">root</span> <span class="o">=&gt;</span> <span class="s">&#39;.&#39;</span><span class="p">,</span>
    <span class="p">});</span>
    <span class="n">builder</span> <span class="p">{</span>
        <span class="n">mount</span> <span class="s">&#39;/md&#39;</span> <span class="o">=&gt;</span> <span class="nv">$md_app</span><span class="p">;</span>
        <span class="n">mount</span> <span class="s">&#39;/html&#39;</span> <span class="o">=&gt;</span> <span class="nv">$html_app</span><span class="p">;</span>
        <span class="n">mount</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="n">builder</span> <span class="p">{</span>
            <span class="n">enable</span> <span class="s">&quot;Plack::Middleware::SimpleContentFilter&quot;</span><span class="p">,</span>
            <span class="n">filter</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
                <span class="n">s</span><span class="c1">#(/\d{4}/\d{2}/\S+\.md)#/md\1#;</span>
                <span class="n">s</span><span class="c1">#(/\d{4}/\d{2}/\S+\.html)#/html\1#;</span>
            <span class="p">};</span>
            <span class="nv">$dir_app</span>
        <span class="p">};</span>
    <span class="p">};</span>
</code></pre></div>
<p><code>Plack::App::Directory</code> 模块是 <code>Plack</code> 自带的一个静态目录自动索引发布模块。不过他会把 markdown 当成 &ldquo;text/plain&rdquo; 发布，不好看。所以这里引入了另一个 <code>DocLife</code> 模块。他可以自动把 markdown 和 pod 格式的文档美化转换成 html 格式。本来 <code>DocLife</code> 本身也提供目录索引功能，不过他的问题是他不考虑 MIME 问题，会把 png 等图片也以 &ldquo;text/plain&rdquo; 发布。所以我们用 <code>Plack::App::URLMap</code> 把两个模块挂在到一起，然后用 <code>Plack::Middleware::SimpleContentFilter</code> 过滤内容，替换原本的目录链接成针对性的目录。</p>
<p>大功告成！运行命令开始享受世界级运维们的分享吧：</p>
<div class="highlight"><pre><code class="bash">    plackup &amp;
    open localhost:5000
</code></pre></div>
<table>
  <tbody>
    <tr>
      <td>注：另外有个 <code>Plack::App::Directory::Markdown</code> 模块，不过他写死了只处理 md，连 html 都被 <code>next</code>。比较好玩的是这个模块自己把 bootstrap.css</td>
      <td>js 给放到 <code>__DATA__</code> 块里一起分发了，页面倒是更好看一点。</td>
    </tr>
  </tbody>
</table>
      <a href="/2012/12/22/simple-local-website-for-sysadmin-advent-clone" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/22/intro-dancer-plugin-adapter" title="Dancer::Plugin::Adapter 模块介绍" rel="bookmark">Dancer::Plugin::Adapter 模块介绍</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-22 00:00:00 +0800">22 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Dancer 活跃的社区和强大又方便的插件开发导致出现了太多好玩的插件，有位新同学在刚上手的这两周内就已经往 CPAN 提交了四个插件了。</p>
<p>今天这里介绍一个刚在 IRC 上被推荐的东东，额，这个插件的作者跟上面提到的同学说：大哥，看看偶这个模块吧，就不用你这么辛苦的啥都写新插件了。</p>
<p><a href="https://metacpan.org/module/Dancer::Plugin::Adapter">Dancer::Plugin::Adapter</a> 模块的作用，就是当你的项目需要在多处使用某个模块的时候，不用频繁的到处去new，直接在 config.yml 里一定义，它会自动给你实例化成 <code>Dancer::Object</code>，然后缓存住，你就可以直接用 service 关键词调用了。</p>
<p>用法示例：</p>
<div class="highlight"><pre><code class="perl">    <span class="c1"># in config.yml</span>
    <span class="n">plugins:</span>
      <span class="n">Adapter:</span>
        <span class="n">ua:</span>
          <span class="n">class:</span> <span class="nn">HTTP::</span><span class="n">Tiny</span>
          <span class="n">options:</span>
            <span class="n">max_redirect:</span> <span class="mi">3</span>
        <span class="n">postmark:</span>
          <span class="n">class:</span> <span class="nn">WWW::</span><span class="n">Postmark</span>
          <span class="n">options:</span> <span class="n">POSTMARK_API_TEST</span>
    <span class="c1"># in your app</span>
    <span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">Adapter</span><span class="p">;</span>
    <span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
      <span class="nb">eval</span> <span class="p">{</span>
        <span class="n">service</span><span class="p">(</span><span class="s">&quot;postmark&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span>
          <span class="n">from</span>    <span class="o">=&gt;</span> <span class="s">&#39;me@domain.tld&#39;</span><span class="p">,</span>
          <span class="n">to</span>      <span class="o">=&gt;</span> <span class="s">&#39;you@domain.tld, them@domain.tld&#39;</span><span class="p">,</span>
          <span class="n">subject</span> <span class="o">=&gt;</span> <span class="s">&#39;an email message&#39;</span><span class="p">,</span>
          <span class="n">body</span>    <span class="o">=&gt;</span> <span class="s">&quot;hi guys, what&#39;s up?&quot;</span>
        <span class="p">);</span>
      <span class="p">};</span>
      <span class="k">return</span> <span class="vg">$@</span> <span class="p">?</span> <span class="s">&quot;Error: $@&quot;</span> <span class="p">:</span> <span class="s">&quot;Mail sent&quot;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">get</span> <span class="s">&#39;/proxy/:url&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
      <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="n">service</span><span class="p">(</span><span class="s">&#39;ua&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;url&#39;</span><span class="p">}</span> <span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">success</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">content</span><span class="p">};</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="n">template</span> <span class="s">&#39;error&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">response</span> <span class="o">=&gt;</span> <span class="nv">$res</span> <span class="p">};</span>
      <span class="p">}</span>
    <span class="p">};</span>
</code></pre></div>
<p>话说我还是喜欢上代码，不喜欢完整的翻译 POD 啊…………</p>
      <a href="/2012/12/22/intro-dancer-plugin-adapter" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/22/elasticsearch-amcharts-demo" title="用 Amcharts 和 ElasticSearch 做日志分析" rel="bookmark">用 Amcharts 和 ElasticSearch 做日志分析</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-22 00:00:00 +0800">22 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前有一篇从 ElasticSearch 官网摘下来的博客<a href="http://chenlinux.com/2012/11/18/data-visualization-with-elasticsearch-and-protovis">《【翻译】用ElasticSearch和Protovis实现数据可视化》</a>。不过一来 Protovis 已经过时，二来 不管是 Protovis 的进化品 D3 还是 Highchart 什么的，我觉得在多图方面都还不如 amcharts 好用。所以在最后依然选择了老牌的 amcharts 完成。</p>
<p>展示品的大概背景还是 webserver 日志，嗯，这个需求应该是最有代表性的了。我们需要对webserver的性能有所了解。之前有一篇文章<a href="http://chenlinux.com/2012/11/22/tatsumaki-demo/">《Tatsumaki框架的小demo一个》</a>，讲的是通过 <code>terms_stats</code> 获取固定时段内请求时间的平均值。其实这个demo是可以参照官网博客修改成纯js应用的。因为 Tatsumaki 在这里除了处理 HTTP 请求参数，什么都没干。而且这个demo目的是展示 perl 框架的处理，所以amchart方面直接就写死了各种变量。</p>
<p>但是还有一种需求，比如你需要的是针对某个情况超过某个百分比的分时走势统计。这时候必须多次请求 ES 来做运算，再让 js 做，不是说不行，但是多一倍数据在网络中传输，就不如在服务器端封装 API 了 —— 其实是我 js 太烂这种事情，我会告诉你们么。。。</p>
<p>先上两张效果图，其实这个布局我是从 facetgrapher 项目偷来的，但这个项目只适合比较不同 index 之间同时间段的数据，我建议作者修改，作者说&rdquo;我自己js也是半吊子水平&rdquo;。。。</p>
<p><img src="/images/uploads/amchart-column.png" alt="分地区错误情况统计" title="分地区错误情况统计" /></p>
<p><img src="/images/uploads/amchart-line.png" alt="实时分运营商错误比例统计" title="实时分运营商错误比例统计" /></p>
<p><strong>2013 年 2 月 21 日更新：利用 bullet 大小来表示 hasErr 的程度</strong></p>
<p>查询的 ES 库情况如下：</p>
<div class="highlight"><pre><code class="bash">    <span class="nv">$ </span>curl <span class="s2">&quot;http://10.4.16.68:9200/demo-photo/log/_mapping?pretty=1&quot;</span>
    <span class="o">{</span>
      <span class="s2">&quot;log&quot;</span> : <span class="o">{</span>
        <span class="s2">&quot;properties&quot;</span> : <span class="o">{</span>
          <span class="s2">&quot;brower&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;date&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;date&quot;</span>,
            <span class="s2">&quot;format&quot;</span> : <span class="s2">&quot;dateOptionalTime&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;fromArea&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>,
            <span class="s2">&quot;index&quot;</span> : <span class="s2">&quot;not_analyzed&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;hasErr&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;requestUrl&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>,
            <span class="s2">&quot;index&quot;</span> : <span class="s2">&quot;not_analyzed&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;timeCost&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;long&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;userId&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;xnforword&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="nv">$ </span>curl <span class="s2">&quot;http://10.4.16.68:9200/demo-photo/log/_search?pretty=1&amp;size=1&quot;</span> -d <span class="s1">&#39;{&quot;query&quot;:{&quot;match_all&quot;:{}}}&#39;</span>
    <span class="o">{</span>
      <span class="s2">&quot;took&quot;</span> : 14,
      <span class="s2">&quot;timed_out&quot;</span> : <span class="nb">false</span>,
      <span class="s2">&quot;_shards&quot;</span> : <span class="o">{</span>
        <span class="s2">&quot;total&quot;</span> : 10,
        <span class="s2">&quot;successful&quot;</span> : 10,
        <span class="s2">&quot;failed&quot;</span> : 0
      <span class="o">}</span>,
      <span class="s2">&quot;hits&quot;</span> : <span class="o">{</span>
        <span class="s2">&quot;total&quot;</span> : 2330679,
        <span class="s2">&quot;max_score&quot;</span> : 1.0,
        <span class="s2">&quot;hits&quot;</span> : <span class="o">[</span> <span class="o">{</span>
          <span class="s2">&quot;_index&quot;</span> : <span class="s2">&quot;demo-photo&quot;</span>,
          <span class="s2">&quot;_type&quot;</span> : <span class="s2">&quot;log&quot;</span>,
          <span class="s2">&quot;_id&quot;</span> : <span class="s2">&quot;iSI5xic7Qg2p9Sqk5yp-pQ&quot;</span>,
          <span class="s2">&quot;_score&quot;</span> : 1.0, <span class="s2">&quot;_source&quot;</span> : <span class="o">{</span><span class="s2">&quot;hasErr&quot;</span>:<span class="s2">&quot;false&quot;</span>,<span class="s2">&quot;date&quot;</span>:<span class="s2">&quot;2012-12-06T15:04:21,983&quot;</span>,<span class="s2">&quot;userId&quot;</span>:<span class="s2">&quot;123456789&quot;</span>,<span class="s2">&quot;requestUrl&quot;</span>:<span class="s2">&quot;http://photo.demo.domain.com/path/to/your/app/test.jpg&quot;</span>,<span class="s2">&quot;brower&quot;</span>:<span class="s2">&quot;chrome17.0.963.84&quot;</span>,<span class="s2">&quot;timeCost&quot;</span>:750,<span class="s2">&quot;xnforword&quot;</span>:<span class="o">[</span><span class="s2">&quot;192.168.1.123&quot;</span>,<span class="s2">&quot;10.10.10.10&quot;</span><span class="o">]</span>,<span class="s2">&quot;fromArea&quot;</span>:<span class="s2">&quot;CN-UNI-OTHER&quot;</span><span class="o">}</span>
        <span class="o">}</span> <span class="o">]</span>
      <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div>
<p>然后后台是我惯用的 Dancer 框架：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="n">AnalysisDemo</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">Ajax</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">ElasticSearch</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(strftime)</span><span class="p">;</span>
    <span class="nb">no</span>  <span class="n">warnings</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$elsearch</span>         <span class="o">=</span> <span class="n">ElasticSearch</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="p">{</span> <span class="nv">%</span><span class="p">{</span> <span class="n">config</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">plugins</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ElasticSearch</span><span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$index_prefix</span>     <span class="o">=</span> <span class="s">&#39;demo-&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$type</span>             <span class="o">=</span> <span class="s">&#39;log&#39;</span><span class="p">;</span>
    <span class="c1"># 这里是对ip库的归类。数据是需要提前导入ES的，这可以是logstash发挥作用</span>
    <span class="k">my</span> <span class="nv">$default_provider</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">yidong</span>    <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(CN-CRN CN-CMN)</span><span class="p">],</span>
        <span class="n">jiaoyu</span>    <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(CN-CER CN-CST)</span><span class="p">],</span>
        <span class="n">dianxin</span>   <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(CN-CHN)</span><span class="p">],</span>
        <span class="n">liantong</span>  <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(CN-UNI CN-CNC)</span><span class="p">],</span>
        <span class="n">guangdian</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(CN-SCN)</span><span class="p">],</span>
        <span class="n">haiwai</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(OS)</span><span class="p">],</span>
    <span class="p">};</span>
    <span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="c1"># 通过 state API 获取 ES 集群现有的所有index列表</span>
        <span class="c1"># 因为是一个域名一个index，这样就有了前段页面上的域名下拉选择框</span>
        <span class="k">my</span> <span class="nv">$indices</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">cluster_state</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">routing_table</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">indices</span><span class="p">};</span>
        <span class="n">template</span> <span class="s">&#39;demo/chart&#39;</span><span class="p">,</span>
          <span class="p">{</span>
            <span class="n">providers</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%$default_provider</span> <span class="p">],</span>
            <span class="n">datasources</span> <span class="o">=&gt;</span>
              <span class="p">[</span> <span class="nb">grep</span> <span class="p">{</span> <span class="sr">/^$index_prefix/</span> <span class="o">&amp;&amp;</span> <span class="sr">s/$index_prefix//</span> <span class="p">}</span> <span class="nb">keys</span> <span class="nv">%$indices</span> <span class="p">],</span>
            <span class="n">inputfrom</span> <span class="o">=&gt;</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%F\T%T&quot;</span><span class="p">,</span> <span class="nb">localtime</span><span class="p">(</span><span class="nb">time</span><span class="p">()</span><span class="o">-</span><span class="mi">864000</span><span class="p">)),</span>
            <span class="n">inputto</span> <span class="o">=&gt;</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%F\T%T&quot;</span><span class="p">,</span> <span class="nb">localtime</span><span class="p">()),</span>
          <span class="p">};</span>
    <span class="p">};</span>
    <span class="c1"># 这里把 api 拆成服务商和区域两个，没啥特殊原因，因为是分两回写的，汗</span>
    <span class="c1"># 其实可以看到最开始的请求参数类似，最后json的field名字都一样</span>
    <span class="n">ajax</span> <span class="s">&#39;/api/provider&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">$param</span> <span class="o">=</span> <span class="n">from_json</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$index</span> <span class="o">=</span> <span class="nv">$index_prefix</span> <span class="o">.</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;datasource&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$from</span>  <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;from&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;now-10d&#39;</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$to</span>    <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;to&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;now&#39;</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$providers</span> <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;provider&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$pct</span><span class="p">,</span> <span class="nv">$chartData</span> <span class="p">);</span>
        <span class="k">for</span> <span class="k">my</span> <span class="nv">$provider</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$providers</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$provider_pct</span><span class="p">;</span>
            <span class="c1"># 这里是比较麻烦的一点，因为一个区域在ip库里可能标记成多个，比如铁通和移动，现在都是移动</span>
            <span class="k">for</span> <span class="k">my</span> <span class="nv">$area</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$default_provider</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$provider</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="n">pct_count</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
                <span class="k">for</span> <span class="k">my</span> <span class="nv">$time</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$res</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
                    <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">error</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">error</span><span class="p">};</span>
                    <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">slow</span><span class="p">}</span>  <span class="o">+=</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">slow</span><span class="p">};</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c1"># 这里因为可能没有错误，所以前面关闭了常用的 warnings 警告</span>
            <span class="k">for</span> <span class="k">my</span> <span class="nv">$time</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$provider_pct</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">my</span> <span class="nv">$right_pct</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
                <span class="nv">$right_pct</span> <span class="o">=</span>
                  <span class="mi">100</span> <span class="o">-</span>
                  <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">slow</span><span class="p">}</span> <span class="o">/</span> <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">}</span>
                  <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
                <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$provider</span><span class="p">}</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%.2f&quot;</span><span class="p">,</span> <span class="nv">$right_pct</span><span class="p">;</span>
                <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Err&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%.2f&quot;</span><span class="p">,</span>
                  <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">error</span><span class="p">}</span> <span class="o">/</span> <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">}</span>
                  <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
                <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Size&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%.0f&quot;</span><span class="p">,</span>
                  <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Err&quot;</span><span class="p">};</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">for</span> <span class="k">my</span> <span class="nv">$time</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%$pct</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">date</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$time</span><span class="p">;</span>
            <span class="k">for</span> <span class="k">my</span> <span class="nv">$provider</span> <span class="p">(</span> <span class="nv">@$providers</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$provider</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$provider</span><span class="p">}</span> <span class="o">||</span> <span class="mi">100</span><span class="p">;</span>
                <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Err&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Err&quot;</span><span class="p">}</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
                <span class="c1"># 百分比太低，所以翻 5 倍来作为 bullet 的大小</span>
                <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Size&quot;</span><span class="p">}</span> <span class="o">=</span>
                  <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Size&quot;</span><span class="p">}</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">};</span>
            <span class="nb">push</span> <span class="nv">@$chartData</span><span class="p">,</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">type</span> <span class="o">=&gt;</span> <span class="s">&quot;line&quot;</span><span class="p">,</span>
            <span class="n">categoryField</span> <span class="o">=&gt;</span> <span class="s">&quot;date&quot;</span><span class="p">,</span>
            <span class="n">graphList</span> <span class="o">=&gt;</span> <span class="nv">$providers</span><span class="p">,</span>
            <span class="n">chartData</span> <span class="o">=&gt;</span> <span class="nv">$chartData</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="n">to_json</span><span class="p">(</span><span class="nv">$res</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="n">ajax</span> <span class="s">&#39;/api/area&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">$param</span> <span class="o">=</span> <span class="n">from_json</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$index</span> <span class="o">=</span> <span class="nv">$index_prefix</span> <span class="o">.</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;datasource&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$limit</span> <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;limit&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="mi">50</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$from</span>  <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;from&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;now-10d&#39;</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$to</span>    <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;to&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;now&#39;</span><span class="p">;</span>
        <span class="c1"># 这是后来写的，尽可能把 sub 拆分了，所以 ajax 这里就很简略</span>
        <span class="c1"># 当然因为不考虑多运营商的问题，本身也容易一些</span>
        <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="n">pct_terms</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">return</span> <span class="n">to_json</span><span class="p">(</span><span class="nv">$res</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">sub </span><span class="nf">pct_terms</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$area_all_count</span> <span class="o">=</span> <span class="n">area_terms</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>    <span class="nv">$limit</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$area_err_count</span> <span class="o">=</span> <span class="n">area_terms</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$error</span><span class="p">,</span> <span class="nv">$chartData</span> <span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$area_err_count</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$error</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">}</span> <span class="p">}</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$area_all_count</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nb">push</span> <span class="nv">@$chartData</span><span class="p">,</span> <span class="p">{</span>
                <span class="n">area</span>  <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">},</span>
                <span class="n">error</span> <span class="o">=&gt;</span> <span class="nv">$error</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">}</span> <span class="p">}</span> <span class="o">||</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">right</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">}</span> <span class="o">-</span> <span class="nv">$error</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">}</span> <span class="p">},</span>
            <span class="p">};</span>
        <span class="p">}</span>
        <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">type</span> <span class="o">=&gt;</span> <span class="s">&quot;column&quot;</span><span class="p">,</span>
            <span class="n">categoryField</span> <span class="o">=&gt;</span> <span class="s">&quot;area&quot;</span><span class="p">,</span>
            <span class="n">graphList</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(right error)</span><span class="p">],</span>
            <span class="n">chartData</span> <span class="o">=&gt;</span> <span class="nv">$chartData</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="nv">$res</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">sub </span><span class="nf">pct_count</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$level</span> <span class="o">=</span> <span class="nv">$area</span> <span class="ow">eq</span> <span class="s">&#39;OS&#39;</span> <span class="p">?</span> <span class="mi">3000</span> <span class="p">:</span> <span class="mi">2000</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$all_count</span>  <span class="o">=</span> <span class="n">histo_count</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>      <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$slow_count</span> <span class="o">=</span> <span class="n">histo_count</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$level</span><span class="p">,</span>   <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$err_count</span>  <span class="o">=</span> <span class="n">histo_count</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="s">&#39;hasErr&#39;</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$res</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$slow_count</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="nb">time</span><span class="p">}</span> <span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">slow</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$err_count</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="nb">time</span><span class="p">}</span> <span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">error</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$all_count</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="nb">time</span><span class="p">}</span> <span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$res</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1"># 下面开始的两个才是真正发 ES 请求的地方</span>
    <span class="k">sub </span><span class="nf">area_terms</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$level</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
            <span class="nb">index</span>  <span class="o">=&gt;</span> <span class="nv">$index</span><span class="p">,</span>
            <span class="n">type</span>   <span class="o">=&gt;</span> <span class="nv">$type</span><span class="p">,</span>
            <span class="n">size</span>   <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">facets</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">area</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">facet_filter</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="ow">and</span> <span class="o">=&gt;</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="n">range</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                    <span class="n">date</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                        <span class="n">from</span> <span class="o">=&gt;</span> <span class="nv">$from</span><span class="p">,</span>
                                        <span class="n">to</span>   <span class="o">=&gt;</span> <span class="nv">$to</span>
                                    <span class="p">},</span>
                                <span class="p">},</span>
                            <span class="p">},</span>
                            <span class="p">{</span>
                                <span class="n">numeric_range</span> <span class="o">=&gt;</span>
                                  <span class="p">{</span> <span class="n">timeCost</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">gte</span> <span class="o">=&gt;</span> <span class="nv">$level</span><span class="p">,</span> <span class="p">},</span> <span class="p">},</span>
                            <span class="p">},</span>
                        <span class="p">],</span>
                    <span class="p">},</span>
                    <span class="c1"># 使用最简单的 terms facets API，因为只用计数就好了</span>
                    <span class="n">terms</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="n">field</span> <span class="o">=&gt;</span> <span class="s">&quot;fromArea&quot;</span><span class="p">,</span>
                        <span class="n">size</span>  <span class="o">=&gt;</span> <span class="nv">$limit</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">);</span>
        <span class="k">return</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">facets</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">area</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">terms</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="k">sub </span><span class="nf">histo_count</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$level</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="c1"># 根据 level 参数判断使用 hasErr 还是 timeCost 列数据</span>
        <span class="k">my</span> <span class="nv">$level_ref</span> <span class="o">=</span>
          <span class="nv">$level</span> <span class="ow">eq</span> <span class="s">&#39;hasErr&#39;</span>
          <span class="p">?</span> <span class="p">{</span> <span class="n">term</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">hasErr</span> <span class="o">=&gt;</span> <span class="s">&#39;true&#39;</span> <span class="p">}</span> <span class="p">}</span>
          <span class="p">:</span> <span class="p">{</span> <span class="n">numeric_range</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">timeCost</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ow">gt</span> <span class="o">=&gt;</span> <span class="nv">$level</span> <span class="p">}</span> <span class="p">}</span> <span class="p">};</span>
        <span class="k">my</span> <span class="nv">$facets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">pct</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">facet_filter</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="c1"># 这里条件比较多，所以要用 bool API，不能用 and 了</span>
                    <span class="n">bool</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="c1"># must 可以提供多个条件作为 AND 数组</span>
                        <span class="c1"># 此外还有 must_not 作为 AND NOT 数组</span>
                        <span class="c1"># should 作为 OR 数组</span>
                        <span class="n">must</span> <span class="o">=&gt;</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="n">range</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                    <span class="n">date</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                        <span class="n">from</span> <span class="o">=&gt;</span> <span class="nv">$from</span><span class="p">,</span>
                                        <span class="n">to</span>   <span class="o">=&gt;</span> <span class="nv">$to</span>
                                    <span class="p">},</span>
                                <span class="p">},</span>
                            <span class="p">},</span>
                            <span class="p">{</span> <span class="n">prefix</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">fromArea</span> <span class="o">=&gt;</span> <span class="nv">$area</span> <span class="p">}</span> <span class="p">},</span>
                            <span class="nv">$level_ref</span><span class="p">,</span>
                        <span class="p">],</span>
                    <span class="p">},</span>
                <span class="p">},</span>
                <span class="c1"># 这里是需要针对专门的时间列做汇总，所以用 date_histogram 了，具体说明之前有博客</span>
                <span class="n">date_histogram</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">field</span>    <span class="o">=&gt;</span> <span class="s">&quot;date&quot;</span><span class="p">,</span>
                    <span class="n">interval</span> <span class="o">=&gt;</span> <span class="s">&quot;1h&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
            <span class="nb">index</span>  <span class="o">=&gt;</span> <span class="nv">$index</span><span class="p">,</span>
            <span class="n">type</span>   <span class="o">=&gt;</span> <span class="nv">$type</span><span class="p">,</span>
            <span class="n">facets</span> <span class="o">=&gt;</span> <span class="nv">$facets</span><span class="p">,</span>
            <span class="n">size</span>   <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="k">return</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">facets</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">pct</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">entries</span><span class="p">};</span>
    <span class="p">}</span>
</code></pre></div>
<p>其实把里面请求的hash拆开来一个个定义，然后根据情况组合，但是不方便察看作为 demo 的整体情况。</p>
<p>然后看template里怎么写。这里虽然有两个效果图，但是只有一个template哟：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;[% $request.uri_base %]/amcharts/style.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;[% $request.uri_base %]/amcharts/amcharts.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
  <span class="kd">var</span> <span class="nx">chart</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">createAmChart</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 清空原有图形</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#chartdiv&quot;</span><span class="p">).</span><span class="nx">empty</span><span class="p">();</span>
    <span class="c1">// 如果是时间轴线图，需要把date字符转成Date对象</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">==</span> <span class="s2">&quot;date&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">date</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmSerialChart</span><span class="p">();</span>
    <span class="c1">// 拖动条等图片的路径</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">pathToImages</span> <span class="o">=</span> <span class="s2">&quot;/amcharts/images/&quot;</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">dataProvider</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">categoryField</span><span class="p">;</span>
    <span class="c1">// 如果是柱状图，可以显示 3D 效果</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;column&#39;</span> <span class="p">)</span> <span class="p">{</span>
<span class="c1">//      chart.rotate = true;</span>
      <span class="nx">chart</span><span class="p">.</span><span class="nx">depth3D</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
      <span class="nx">chart</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">categoryAxis</span> <span class="o">=</span> <span class="nx">chart</span><span class="p">.</span><span class="nx">categoryAxis</span><span class="p">;</span>
    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">fillAlpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">fillColor</span> <span class="o">=</span> <span class="s2">&quot;#FAFAFA&quot;</span><span class="p">;</span>
    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">axisAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">gridPosition</span> <span class="o">=</span> <span class="s2">&quot;start&quot;</span><span class="p">;</span>
    <span class="c1">// 时间轴需要解析Date对象</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">==</span> <span class="s2">&quot;date&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">parseDates</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">minPeriod</span> <span class="o">=</span> <span class="s2">&quot;hh&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">valueAxis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>
    <span class="nx">valueAxis</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="nx">valueAxis</span><span class="p">.</span><span class="nx">axisAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// 指定柱状图为叠加模式，这里有多种模式可以看文档</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;column&#39;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">valueAxis</span><span class="p">.</span><span class="nx">stackType</span> <span class="o">=</span> <span class="s2">&quot;regular&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis</span><span class="p">);</span>
    <span class="c1">// 这里有个有趣的事情，如果不把graph当数组直接循环，效果也没问题</span>
    <span class="c1">// 我只能猜测是 addGraph 后数据其实已经缓存到 chart 了</span>
    <span class="kd">var</span> <span class="nx">graph</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#FF6600&#39;</span><span class="p">,</span> <span class="s1">&#39;#FCD202&#39;</span><span class="p">,</span> <span class="s1">&#39;#B0DE09&#39;</span><span class="p">,</span> <span class="s1">&#39;#0D8ECF&#39;</span><span class="p">,</span> <span class="s1">&#39;#2A0CD0&#39;</span><span class="p">,</span> <span class="s1">&#39;#CD0D74&#39;</span><span class="p">,</span> <span class="s1">&#39;#CC0000&#39;</span><span class="p">,</span> <span class="s1">&#39;#00CC00&#39;</span><span class="p">,</span> <span class="s1">&#39;#0000CC&#39;</span><span class="p">,</span> <span class="s1">&#39;#DDDDDD&#39;</span><span class="p">,</span> <span class="s1">&#39;#999999&#39;</span><span class="p">,</span> <span class="s1">&#39;#333333&#39;</span><span class="p">,</span> <span class="s1">&#39;#990000&#39;</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmGraph</span><span class="p">();</span>
      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">valueField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;column&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">valueField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">descriptionField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;Err&quot;</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletSizeField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;Size&quot;</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bullet</span> <span class="o">=</span> <span class="s2">&quot;round&quot;</span><span class="p">;</span>
        <span class="c1">// 设定为空心圆圈</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletColor</span> <span class="o">=</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletBorderAlpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="c1">// amchart 本来有默认颜色，不过前面因为修改了圆内的颜色，所以其他颜色无法继承默认设定了</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletBorderColor</span> <span class="o">=</span>  <span class="nx">colors</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineColor</span> <span class="o">=</span>  <span class="nx">colors</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineAlpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineThickness</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">balloonText</span> <span class="o">=</span> <span class="s2">&quot;[[value]]% / hasErr:[[description]]%&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">chart</span><span class="p">.</span><span class="nx">addGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="c1">// 加图例，这样可以在图上随时勾选察看具体某个数据，也方便某数据异常的时候影响察看其他</span>
    <span class="kd">var</span> <span class="nx">legend</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmLegend</span><span class="p">();</span>
    <span class="nx">legend</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">;</span>
    <span class="nx">legend</span><span class="p">.</span><span class="nx">horizontalGap</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="nx">legend</span><span class="p">.</span><span class="nx">switchType</span> <span class="o">=</span> <span class="s2">&quot;v&quot;</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">addLegend</span><span class="p">(</span><span class="nx">legend</span><span class="p">);</span>
    <span class="c1">// 加拖拉轴，这样可以拖动察看细节，这个功能很赞</span>
    <span class="kd">var</span> <span class="nx">scrollbar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartScrollbar</span><span class="p">();</span>
    <span class="nx">scrollbar</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="nx">graph</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">scrollbar</span><span class="p">.</span><span class="nx">graphType</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span><span class="p">;</span>
    <span class="nx">scrollbar</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">addChartScrollbar</span><span class="p">(</span><span class="nx">scrollbar</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartCursor</span><span class="p">();</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">addChartCursor</span><span class="p">(</span><span class="nx">cursor</span><span class="p">);</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;chartdiv&quot;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">drawChart</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">provider</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#provider :selected&quot;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
       <span class="nx">provider</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="p">);</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">datasource</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#datasource :selected&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">apitype</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;:radio:checked&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#from&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#to&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
      <span class="nx">processData</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;[% $request.uri_base %]/demo/api/&quot;</span> <span class="o">+</span> <span class="nx">apitype</span><span class="p">,</span>
      <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="s2">&quot;provider&quot;</span><span class="o">:</span><span class="nx">provider</span><span class="p">,</span> <span class="s2">&quot;datasource&quot;</span><span class="o">:</span><span class="nx">datasource</span><span class="p">,</span> <span class="s2">&quot;from&quot;</span><span class="o">:</span><span class="nx">from</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="o">:</span><span class="nx">to</span><span class="p">}),</span>
      <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
      <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
      <span class="nx">success</span> <span class="o">:</span> <span class="nx">createAmChart</span>
    <span class="p">});</span>
  <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">showselect</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#providers&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
  <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">hideselect</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#providers&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
  <span class="p">};</span>
<span class="nt">&lt;/script&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;well&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;from&quot;</span> <span class="na">name=</span><span class="s">&quot;from&quot;</span> <span class="na">value=</span><span class="s">&quot;[% $inputfrom %]&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;to&quot;</span> <span class="na">name=</span><span class="s">&quot;to&quot;</span> <span class="na">value=</span><span class="s">&quot;[% $inputto %]&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;datasource&quot;</span><span class="nt">&gt;</span>
%% for $datasources -&gt; $datasource {
            <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;[% $datasource %]&quot;</span><span class="nt">&gt;</span>[% $datasource %]<span class="nt">&lt;/option&gt;</span>
%% }
          <span class="nt">&lt;/select&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span2&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;radio&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">name=</span><span class="s">&quot;querytype&quot;</span> <span class="na">value=</span><span class="s">&quot;provider&quot;</span> <span class="na">onclick=</span><span class="s">&quot;showselect()&quot;</span><span class="nt">&gt;</span>服务商趋势
          <span class="nt">&lt;/label&gt;</span>
          <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;radio&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">name=</span><span class="s">&quot;querytype&quot;</span> <span class="na">value=</span><span class="s">&quot;area&quot;</span> <span class="na">checked</span> <span class="na">onclick=</span><span class="s">&quot;hideselect()&quot;</span><span class="nt">&gt;</span>分地区统计
          <span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary&quot;</span> <span class="na">onclick=</span><span class="s">&quot;drawChart()&quot;</span><span class="nt">&gt;</span>查询<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id =</span><span class="s">&quot;providers&quot;</span> <span class="na">class=</span><span class="s">&quot;controls hide&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;provider&quot;</span> <span class="na">multiple=</span><span class="s">&quot;mulitiple&quot;</span><span class="nt">&gt;</span>
%% for $providers -&gt; $provider {
            <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;[% $provider %]&quot;</span> <span class="na">selected</span><span class="nt">&gt;</span>[% $provider %]<span class="nt">&lt;/option&gt;</span>
%% }
          <span class="nt">&lt;/select&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span><span class="c">&lt;!--/well--&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chartdiv&quot;</span> <span class="na">style=</span><span class="s">&quot;width: 100%; height: 400px;&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
</code></pre></div>
      <a href="/2012/12/22/elasticsearch-amcharts-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/21/dancer-plugin-auth-extensible" title="学习 Dancer::Plugin::Auth::Extensible 模块" rel="bookmark">学习 Dancer::Plugin::Auth::Extensible 模块</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-21 00:00:00 +0800">21 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>首先介绍一下 <code>Dancer::Plugin::Auth::Extensible</code> 模块。这是一个认证验证的框架，之前 Dancer 里这方面的框架是 RBAC ，不过 RBAC 是实现的 auth 对象，然后提供 <code>-&gt;asa</code>，<code>-&gt;can</code>，<code>-&gt;roles</code> 等方法。在使用的时候，需要自己在每个 route 里写 if 或者 switch 代码，显得比较繁琐。而 Extensible 模块提供了另一个（或者说是两个）思路。同时借此深入了解 <code>Dancer::Plugin</code> 和 <code>Dancer::Hook</code> 的用法，外加熟悉 perl 的一些不常见的对象使用。收获良多，不可不记。</p>
<p>上面之所以说算是两个思路。是因为在这个模块出来的短短十天内，其 0.001 和 0.010 版本已经完全从实现到使用方法都变了样子。下面先说 0.001 版。</p>
<p>这个原始版本的使用方法大概是这样的：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">get</span> <span class="s">&#39;/secret&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">:RequireRole(God) {</span> <span class="n">DestroyWorld</span><span class="p">();</span> <span class="p">};</span>
    <span class="n">get</span> <span class="s">&#39;/users&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">:RequireLogin {</span>
        <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="n">logged_in_user</span><span class="p">;</span>
        <span class="k">return</span> <span class="s">&quot;Hi there, $user-&gt;{username}&quot;</span><span class="p">;</span>
    <span class="p">};</span>
</code></pre></div>
<p>哇，我是第一次见到在 <code>sub</code> 后面还可以写这样的东西（好吧，暴露了本人的菜鸟本质）！赶紧打开模块的源代码，然后找到了相关的几行：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">attributes</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Scalar::</span><span class="n">Util</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Exporter</span> <span class="s">&#39;import&#39;</span><span class="p">;</span>
    <span class="k">our</span> <span class="nv">@EXPORT</span><span class="o">=</span><span class="sx">qw(MODIFY_CODE_ATTRIBUTES FETCH_CODE_ATTRIBUTES)</span><span class="p">;</span>
    <span class="n">hook</span> <span class="n">before</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">$route_handler</span> <span class="o">=</span> <span class="nb">shift</span> <span class="o">||</span> <span class="k">return</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$requires_login</span> <span class="o">=</span> <span class="n">get_attribs_by_type</span><span class="p">(</span>
            <span class="s">&#39;RequireLogin&#39;</span><span class="p">,</span> <span class="nv">$route_handler</span><span class="o">-&gt;</span><span class="n">code</span>
        <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$roles_required</span> <span class="o">=</span> <span class="n">get_attribs_by_type</span><span class="p">(</span>
            <span class="s">&#39;RequireRole&#39;</span><span class="p">,</span> <span class="nv">$route_handler</span><span class="o">-&gt;</span><span class="n">code</span>
        <span class="p">);</span>
        <span class="o">...</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">my</span> <span class="nv">%attrs</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">MODIFY_CODE_ATTRIBUTES</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$package</span><span class="p">,</span> <span class="nv">$subref</span><span class="p">,</span> <span class="nv">@attrs</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="nv">$attrs</span><span class="p">{</span> <span class="n">refaddr</span> <span class="nv">$subref</span> <span class="p">}</span> <span class="o">=</span> <span class="o">\</span><span class="nv">@attrs</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> 
    <span class="k">sub </span><span class="nf">FETCH_CODE_ATTRIBUTES</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$package</span><span class="p">,</span> <span class="nv">$subref</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$attrs</span> <span class="o">=</span> <span class="nv">$attrs</span><span class="p">{</span> <span class="n">refaddr</span> <span class="nv">$subref</span> <span class="p">};</span>
        <span class="k">return</span> <span class="nv">$attrs</span> <span class="p">?</span> <span class="nv">@$attrs</span> <span class="p">:</span> <span class="p">();</span>
    <span class="p">}</span>
    <span class="k">sub </span><span class="nf">get_attribs_by_type</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$coderef</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">unless</span> <span class="nv">$coderef</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">@desired_attribs</span> <span class="o">=</span> <span class="nb">grep</span> <span class="p">{</span> 
            <span class="sr">/^$type(?:\([^)]*\))?$/</span> 
        <span class="p">}</span> <span class="nn">attributes::</span><span class="n">get</span><span class="p">(</span><span class="nv">$coderef</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">if</span> <span class="o">!</span><span class="nv">@desired_attribs</span><span class="p">;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="nb">map</span> <span class="p">{</span>
                <span class="k">my</span> <span class="nv">$f</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
                <span class="nv">$f</span> <span class="o">=~</span> <span class="sr">s/^$type\(\s*([^)]*)\s*\)$/$1/</span><span class="p">;</span>
                <span class="nb">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">,</span> <span class="nv">$f</span><span class="p">);</span>
            <span class="p">}</span> <span class="nv">@desired_attribs</span>
        <span class="p">];</span>
    <span class="p">}</span>
</code></pre></div>
<p>代码中的 <code>$route_handler-&gt;code</code> 就是应用中写的 <code>sub {}</code>。<strong>整个代码中，最关键的部分是这句 <code>attributes::get($coderef)</code> ！</strong></p>
<p>首先有个小问题，因为 Dancer 里，get 是关键词，所以这里写了全路径。<code>attributes::get</code> 的介绍见 <a href="https://metacpan.org/module/attributes#Available-Subroutines">POD</a>，大意是会使用 <code>FETCH_type_ATTRIBUTES</code> 方法获取列表。因为这里 attribute 是 sub 的，所以 type 就是 CODE ，也就是用前面定义的 <code>FETCH_CODE_ATTRIBUTES</code>。<code>FETCH_type_ATTRIBUTES</code> 方法的说明见 <a href="https://metacpan.org/module/attributes#Package-specific-Attribute-Handling">POD</a>。</p>
<p>在<a href="https://metacpan.org/module/perlsub#Subroutine-Attributes">https://metacpan.org/module/perlsub#Subroutine-Attributes</a>中，建议我们看另一个更好用的模块来理解自定义属性的问题，这个模块是<a href="https://metacpan.org/module/Attribute::Handlers">Attribute::Handlers</a>。</p>
<p>然后是 0.010 版：</p>
<p>新版本的使用方法如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">get</span> <span class="s">&#39;/secret&#39;</span> <span class="o">=&gt;</span> <span class="n">require_any_role</span> <span class="p">[</span><span class="sx">qw(God Admin)</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="n">DestroyWorld</span><span class="p">();</span> <span class="p">};</span>
    <span class="n">get</span> <span class="s">&#39;/users&#39;</span> <span class="o">=&gt;</span> <span class="n">require_login</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="n">logged_in_user</span><span class="p">;</span>
        <span class="k">return</span> <span class="s">&quot;Hi there, $user-&gt;{username}&quot;</span><span class="p">;</span>
    <span class="p">};</span>
</code></pre></div>
<p>这种添加新关键词的写法更加的 dancer。所以能从实现中学到更有普适性的 <code>Dancer::Plugin</code> 开发方法。摘要代码如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="nn">Dancer::</span><span class="n">Plugin</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Dancer</span> <span class="sx">qw(:syntax)</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">require_any_role</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_build_wrapper</span><span class="p">(</span><span class="nv">@_</span><span class="p">,</span> <span class="s">&#39;any&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">register</span> <span class="n">require_any_role</span>  <span class="o">=&gt;</span> <span class="o">\&amp;</span><span class="n">require_any_role</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">_build_wrapper</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$require_role</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$coderef</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$mode</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">@role_list</span> <span class="o">=</span> <span class="nb">ref</span> <span class="nv">$require_role</span> <span class="ow">eq</span> <span class="s">&#39;ARRAY&#39;</span> 
            <span class="p">?</span> <span class="nv">@$require_role</span>
            <span class="p">:</span> <span class="nv">$require_role</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">sub </span><span class="p">{</span>
            <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="n">logged_in_user</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">execute_hook</span><span class="p">(</span><span class="s">&#39;login_required&#39;</span><span class="p">,</span> <span class="nv">$coderef</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">redirect</span> <span class="nv">$loginpage</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">my</span> <span class="nv">$role_match</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$mode</span> <span class="ow">eq</span> <span class="s">&#39;single&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$role_match</span><span class="o">++</span> <span class="k">if</span> <span class="n">user_has_role</span><span class="p">(</span><span class="nv">$require_role</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$mode</span> <span class="ow">eq</span> <span class="s">&#39;any&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">my</span> <span class="nv">%role_ok</span> <span class="o">=</span> <span class="nb">map</span> <span class="p">{</span> <span class="nv">$_</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">}</span> <span class="nv">@role_list</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">user_roles</span><span class="p">())</span> <span class="p">{</span>
                    <span class="nv">$role_match</span><span class="o">++</span> <span class="ow">and</span> <span class="k">last</span> <span class="k">if</span> <span class="nv">$role_ok</span><span class="p">{</span><span class="nv">$_</span><span class="p">};</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$mode</span> <span class="ow">eq</span> <span class="s">&#39;all&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$role_match</span><span class="o">++</span><span class="p">;</span>
                <span class="k">for</span> <span class="k">my</span> <span class="nv">$role</span> <span class="p">(</span><span class="nv">@role_list</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_has_role</span><span class="p">(</span><span class="nv">$role</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nv">$role_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="k">last</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$role_match</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$coderef</span><span class="o">-&gt;</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="n">execute_hook</span><span class="p">(</span><span class="s">&#39;permission_denied&#39;</span><span class="p">,</span> <span class="nv">$coderef</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">redirect</span> <span class="nv">$deniedpage</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="n">register_hook</span> <span class="sx">qw(login_required permission_denied)</span><span class="p">;</span>
</code></pre></div>
<p>主要摘要了几个部分：</p>
<ul>
  <li>第一，register</li>
</ul>
<p>摘要中就是 register 了一个关键词 require_any_role 。这样在启用了本 plugin 的应用里，你可以直接使用这个关键词。至于具体的 sub，没有什么特殊的。看前面的用法举例就知道了，传递一个 roles 的数组引用(或者单个role的话就是字符串，这个在后面有判断)和一个 sub 作为参数，也就是 <code>@_</code>。</p>
<ul>
  <li>第二，register_hook</li>
</ul>
<p>第一个是 <code>Dancer::Plugin</code> 的部分，第二个是 <code>Dancer::Hook</code> 的功能。注册一个叫 login_required 的 hook，然后在需要的地方运行 <code>execute_hook('login_required', $coderef)</code>。</p>
<p><code>register_hook</code> 接受 <code>$name</code> 和 <code>$coderef</code> 参数。如果只有 name 的话，<code>Dancer::Hook</code> 里也会自动生成一个 <code>$compiled_filter</code> ，作用就是除非你调用 <code>halt</code> 了，不然就输出一条 core 级别的日志(这里其实还用到了 <code>Dancer::Hook::Properties</code>，判断是否需要运行，默认初始化参数空的时候返回真，不运行 app，继续往下到记录日志)。然后，将这个对象传递给 <code>Dancer::Factory::Hook</code>。这里会把前面的生成的 coderef 加入到一个 <code>$class-&gt;hooks-&gt;{$hook_name}</code> 数组，而 name 加入到 <code>$self-&gt;registered_hooks</code> 数组。</p>
<p>在<code>execute_hook</code> 的时候，从前面的 <code>$self-&gt;registered_hooks</code> 判断是否有这个 name，然后从 <code>$class-&gt;hooks-&gt;{$hook_name}</code> 里依次取出全部 coderef 执行。</p>
<ul>
  <li>第三，any</li>
</ul>
<p>和前面 0.001 类似，这里也有一个关键词冲突的问题，前面的 get 和这里的 any 都是 <code>Dancer</code> 的关键词。不然的话，其实这里使用 <code>Perl6::Junction</code> 或者 <code>Syntax::Keyword::Junction</code> 模块是正当其时啊。我之前都用 <code>Perl6::Junction</code>，不过昨天的 Perl Advent Calendar 文章里推荐了后面这个 <code>Syntax::Keyword::Junction</code>，<a href="https://metacpan.org">meta::cpan</a> 上也都是两个喜欢。另外题外话说一句，那篇文章里推荐的另一个 <a href="https://metacpan.org/module/Function::Parameters">Function::Parameters</a> 可真是好东西，唯一问题是低于 Perl 5.014的版本用不了，因为他不是 source filter 而是 keyword plugin api 的。这是新版本的功能。</p>
<hr />
<p><strong>12 月 30 日附：</strong></p>
<p>在 github 上提交了一个短短的 patch ，给 DPAE 加上了 正则匹配 role 的功能，感谢 Perl5.10的强大，代码其实就修改一行足以实现：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">lib</span><span class="sr">/Dancer/</span><span class="n">Plugin</span><span class="sr">/Auth/</span><span class="n">Extensible</span><span class="o">.</span><span class="n">pm</span> <span class="nv">@</span> <span class="nv">891cd02</span>
    <span class="nv">@@</span> <span class="err">-</span><span class="nv">266</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">266</span><span class="p">,</span><span class="mi">9</span> <span class="nv">@@</span> <span class="nv">sub</span> <span class="n">_build_wrapper</span> <span class="p">{</span>
             <span class="k">my</span> <span class="nv">$role_match</span><span class="p">;</span>
             <span class="k">if</span> <span class="p">(</span><span class="nv">$mode</span> <span class="ow">eq</span> <span class="s">&#39;single&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">-</span>            <span class="nv">$role_match</span><span class="o">++</span> <span class="k">if</span> <span class="n">user_has_role</span><span class="p">(</span><span class="nv">$require_role</span><span class="p">);</span>
    <span class="o">+</span>            <span class="k">for</span> <span class="p">(</span><span class="n">user_roles</span><span class="p">())</span> <span class="p">{</span>
    <span class="o">+</span>                <span class="nv">$role_match</span><span class="o">++</span> <span class="ow">and</span> <span class="k">last</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">~~</span> <span class="nv">$require_role</span><span class="p">;</span>
    <span class="o">+</span>            <span class="p">}</span>
             <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$mode</span> <span class="ow">eq</span> <span class="s">&#39;any&#39;</span><span class="p">)</span> <span class="p">{</span>
                 <span class="k">my</span> <span class="nv">%role_ok</span> <span class="o">=</span> <span class="nb">map</span> <span class="p">{</span> <span class="nv">$_</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">}</span> <span class="nv">@role_list</span><span class="p">;</span>
                 <span class="k">for</span> <span class="p">(</span><span class="n">user_roles</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">/</span><span class="mo">01</span><span class="o">-</span><span class="n">basic</span><span class="o">.</span><span class="n">t</span> <span class="nv">@</span> <span class="nv">891cd02</span>
    <span class="nv">@@</span> <span class="err">-</span><span class="nv">81</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">81</span><span class="p">,</span><span class="mi">9</span> <span class="nv">@@</span> <span class="nv">response_status_is</span> <span class="p">[</span> <span class="n">GET</span> <span class="o">=&gt;</span> <span class="s">&#39;/allroles&#39;</span> <span class="p">],</span> <span class="mi">200</span><span class="p">,</span>
     <span class="n">response_status_is</span> <span class="p">[</span> <span class="n">GET</span> <span class="o">=&gt;</span> <span class="s">&#39;/regex/a&#39;</span> <span class="p">],</span> <span class="mi">200</span><span class="p">,</span>
         <span class="s">&quot;We can request a regex route when logged in&quot;</span><span class="p">;</span>
    <span class="o">+</span><span class="n">response_status_is</span> <span class="p">[</span> <span class="n">GET</span> <span class="o">=&gt;</span> <span class="s">&#39;/piss/regex&#39;</span> <span class="p">],</span> <span class="mi">200</span><span class="p">,</span>
    <span class="o">+</span>    <span class="s">&quot;We can request a route requiring a regex role we have&quot;</span><span class="p">;</span>
    <span class="o">+</span>
     <span class="c1"># ... but can&#39;t request something requiring a role we don&#39;t have</span>
     <span class="n">response_redirect_location_is</span>  <span class="p">[</span> <span class="n">GET</span> <span class="o">=&gt;</span> <span class="s">&#39;/piss&#39;</span> <span class="p">],</span>
         <span class="s">&#39;http://localhost/login/denied?return_url=%2Fpiss&#39;</span><span class="p">,</span>
    <span class="n">t</span><span class="sr">/lib/</span><span class="n">TestApp</span><span class="o">.</span><span class="n">pm</span> <span class="nv">@</span> <span class="nv">891cd02</span>
    <span class="nv">@@</span> <span class="err">-</span><span class="nv">39</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">39</span><span class="p">,</span><span class="mi">10</span> <span class="nv">@@</span> <span class="nv">get</span> <span class="s">&#39;/piss&#39;</span> <span class="o">=&gt;</span> <span class="n">require_role</span> <span class="n">BearGrylls</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
         <span class="s">&quot;You can drink piss&quot;</span><span class="p">;</span>
     <span class="p">};</span>
    <span class="o">+</span><span class="n">get</span> <span class="s">&#39;/piss/regex&#39;</span> <span class="o">=&gt;</span> <span class="n">require_role</span> <span class="sx">qr/beer/</span><span class="n">i</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="o">+</span>    <span class="s">&quot;You can drink piss now&quot;</span><span class="p">;</span>
    <span class="o">+</span><span class="p">};</span>
    <span class="o">+</span>
     <span class="n">get</span> <span class="s">&#39;/anyrole&#39;</span> <span class="o">=&gt;</span> <span class="n">require_any_role</span> <span class="p">[</span><span class="s">&#39;Foo&#39;</span><span class="p">,</span><span class="s">&#39;BeerDrinker&#39;</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
         <span class="s">&quot;Matching one of multiple roles works&quot;</span><span class="p">;</span>
     <span class="p">};</span>
</code></pre></div>
      <a href="/2012/12/21/dancer-plugin-auth-extensible" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/19/dancer-and-text-xslate" title="Dancer 框架使用 Text::XSlate 模版的注意事项" rel="bookmark">Dancer 框架使用 Text::XSlate 模版的注意事项</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-19 00:00:00 +0800">19 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Dancer 框架自带有一个 Simple 模版，不过推荐使用 <code>Template</code> 模块作为替代品。不过从性能上来说，TT2 比之前博客里陆续介绍过的 <code>HTML::Template</code> 和 <code>Text::MicroTemplate</code> 都要差。而这方面最好的，就是 <code>Text::XSlate</code> 模块了。今天尝试将一个 Dancer 应用迁移到 <code>Text::XSlate</code> 上。踩进两个坑，特此记录。</p>
<p>关于语法什么的，可以看 POD ，扶凯 有翻译的 中文版POD 。足以十分钟入门。就不多说了。</p>
<ul>
  <li>第一个坑：session 的处理</li>
</ul>
<p>website 少不了 session 的运用。在 template 里使用 <code>[% session.username %]</code> 可以很方便的控制显示面板还是登陆啊什么的。</p>
<p>不过切换成 XSlate 后（即 <code>&lt;: $session.username :&gt;</code>），请求会 crash 掉，报错大意是: <strong>$session 没有 username 这个 method</strong>。</p>
<p>XSlate 提供了 <code>dump</code> 语法糖，让我们可以直接使用 <code>&lt;: $session | dump :&gt;</code> 检查问题。这时候发现显示如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="nv">$VAR1</span> <span class="o">=</span> <span class="p">{</span> <span class="n">blessed</span><span class="p">(</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="s">&#39;2131232131&#39;</span><span class="p">,</span> <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;user1&#39;</span> <span class="p">}</span> <span class="p">),</span> <span class="nn">Dancer::Session::</span><span class="n">YAML</span> <span class="p">};</span>
</code></pre></div>
<p>尝试使用 <code>&lt;: $session.id :&gt;</code> ，发现可以正常输出 2131232131 。</p>
<p>进去看 <code>Dancer::Session</code> 的代码，原来在 <code>Dancer::Session::Abstract</code> 里，有这么一行：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">);</span>
</code></pre></div>
<p>说实话不太理解这行的用法，不过不妨碍我们用简单办法解决问题…… 在我们的应用中给 <code>Dancer::Session::YAML</code> 定义一个叫 username 的 method 就可以骗过去了：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="n">DancerApp</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Dancer::Session::</span><span class="n">YAML</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">Dancer</span><span class="p">::Session::YAML::username {</span>
        <span class="k">return</span> <span class="n">session</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">use</span> <span class="nn">Dancer::Plugin::Auth::</span><span class="n">Extensible</span><span class="p">;</span>
    <span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">:RequireLogin {</span> <span class="n">template</span> <span class="s">&#39;index&#39;</span> <span class="p">};</span>
    <span class="o">...</span><span class="p">;</span>
    <span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p><strong>2013 年 03 月 25 日更新</strong></p>
<p>今天莫莫也换成 Xslate 模板，顺带告诉我这里一个更通用和优雅的修改方式：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="n">DancerApp</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Dancer::Session::</span><span class="n">Abstract</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Dancer::Plugin::Auth::</span><span class="n">Extensible</span><span class="p">;</span>
    <span class="nn">Dancer::Session::</span><span class="n">Abstract</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">(</span> <span class="sx">qw(username)</span> <span class="p">);</span>
    <span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">:RequireLogin {</span> <span class="n">template</span> <span class="s">&#39;index&#39;</span> <span class="p">};</span>
    <span class="o">...</span><span class="p">;</span>
    <span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>这样可以在各种 Session 引擎下通用了。</p>
<p><strong>更新完毕</strong></p>
<ul>
  <li>第二个坑：flashmessage 的处理</li>
</ul>
<p>这是一个外加模块，叫做 <code>Dancer::Plugin::FlashMessage</code> 。用它配合模版的 layout 功能，可以很方便的给应用提供全局的消息通知。使用方法如下：</p>
<p>首先在模块里加载 flash 变量：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="nn">DancerApp::</span><span class="n">First</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">FlashMessage</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Dancer::Plugin::Auth::</span><span class="n">Extensible</span><span class="p">;</span>
    <span class="n">get</span> <span class="s">&#39;/first/:name&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">:RequireRole(&#39;MAN&#39;) {</span>
        <span class="n">flash</span> <span class="n">message</span> <span class="o">=&gt;</span> <span class="s">&#39;Hello! You are the first man here.&#39;</span><span class="p">;</span>
        <span class="n">template</span> <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="n">param</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span> <span class="p">};</span>
    <span class="p">};</span>
    <span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>然后在模版里判断显示：</p>
<div class="highlight"><pre><code class="html">    [% IF flash.message %]
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-success&quot;</span><span class="nt">&gt;</span>
        [% flash.message %]
      <span class="nt">&lt;/div&gt;</span>
    [% END %]
</code></pre></div>
<p>同样，在修改成 XSlate 后，模版是这样：</p>
<div class="highlight"><pre><code class="html">    : if $flash.message {
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-success&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;:</span> <span class="na">flash</span><span class="err">.</span><span class="na">message</span> <span class="na">:</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    : }
</code></pre></div>
<p>结果发现页面上的 div 一直保持，而且显示着 <code>CODE(0x39a5c30)</code> 这样的字样。同样使用 <code>dump</code> 语法糖，看到 <code>$flash</code> 其实是 <code>{ message =&gt; sub {"DUMMY"} }</code>。</p>
<p>这个就有趣了，居然是个代码段~~于是翻源码来看：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">hook</span> <span class="n">before_template</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="nb">shift</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$token_name</span><span class="p">}</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">map</span> <span class="p">{</span> <span class="k">my</span> <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span> <span class="k">my</span> <span class="nv">$value</span><span class="p">;</span>
                <span class="p">(</span> <span class="nv">$key</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span> <span class="nb">defined</span> <span class="nv">$value</span> <span class="ow">and</span> <span class="k">return</span> <span class="nv">$value</span><span class="p">;</span>
                    <span class="k">my</span> <span class="nv">$flash</span> <span class="o">=</span> <span class="n">session</span><span class="p">(</span><span class="nv">$session_hash_key</span><span class="p">)</span> <span class="o">||</span> <span class="p">{};</span>
                    <span class="nv">$value</span> <span class="o">=</span> <span class="nb">delete</span> <span class="nv">$flash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$key</span><span class="p">};</span>
                    <span class="n">session</span> <span class="nv">$session_hash_key</span><span class="p">,</span> <span class="nv">$flash</span><span class="p">;</span>
                    <span class="k">return</span> <span class="nv">$value</span><span class="p">;</span>
                <span class="p">}</span> <span class="p">);</span>
            <span class="p">}</span> <span class="p">(</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="n">session</span><span class="p">(</span><span class="nv">$session_hash_key</span><span class="p">)</span> <span class="o">||</span> <span class="p">{}</span> <span class="p">})</span>
        <span class="p">};</span>
    <span class="p">};</span>
</code></pre></div>
<p><code>map</code> 里面，确实是一个 <code>$key =&gt; sub {}</code> 。</p>
<p>这个时候我切换两个 template 做了个测试。在里面那个匿名 sub 里写了一行 <code>die;</code>。结果。XSlate “正常”运行过去，在页面上显示前面说过的 <code>CODE()</code>；而在 Template 模版下，500 了。看 console 的日志，发现 <code>die</code> 这个动作不是在 <code>before_template</code> 阶段发生的。而是在随后的 render 阶段，<code>Dancer::Template::Abstract</code> 里才挂了。</p>
<p>所以，最终，两个坑归结起来并成了一个问题：模版系统是支持 coderef 还是支持 object 的问题。就在我写着这句话的同时，IRC 上还为 <code>Dancer::Plugin::FlashMessage</code> 的新实现而争论不休。xdg 童鞋已经在我提问的一个小时内快速的搞出来一个把 flash &ldquo;object 化&rdquo;的 patch，而 bigpresh 童鞋坚定的认为应该把 <code>delete</code> 操作放在 <code>hook after_template</code> 里完成。原作者 <code>dams</code> 则&rdquo;相信&rdquo;更多的模版是支持 coderef 不支持 object 的。</p>
<p>不过我觉得，其实改动最小的办法，就是别用 <code>map</code> 这么高档的语法。拆成两段处理，确保传递给 <code>template_render</code> 的是字符串即可：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">hook</span> <span class="n">before_template</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">%hash</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$flash</span> <span class="o">=</span> <span class="n">session</span><span class="p">(</span><span class="nv">$session_hash_key</span><span class="p">)</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$flash</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$hash</span><span class="p">{</span><span class="nv">$_</span><span class="p">}</span> <span class="o">=</span> <span class="nb">delete</span> <span class="nv">$flash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$_</span><span class="p">};</span>
        <span class="p">};</span>
        <span class="n">session</span> <span class="nv">$session_hash_key</span><span class="p">,</span> <span class="nv">$flash</span><span class="p">;</span>
        <span class="nb">shift</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$token_name</span><span class="p">}</span> <span class="o">=</span> <span class="o">\</span><span class="nv">%hash</span><span class="p">;</span>
    <span class="p">};</span>
</code></pre></div>
<p>最后的最后，就在我测试完我的改动版本在两种模版下都可以运行的时候，dams 已经决定先同时保持 coderef 和 object 的写法并提供 setting 配置。然后慢慢搜集各种模版系统做覆盖测试。</p>
<p><strong>20 日增</strong></p>
<p>最后最后的最后，在 github 上搜到两个用 dancer 和 xslate 写的 repo。他们都采用了在应用 app 里自定义 <code>hook before_template</code> ，把 <code>session('username')</code> 和 <code>flash('message')</code> 两个变量传递给 <code>$token</code> 哈希的办法。</p>
      <a href="/2012/12/19/dancer-and-text-xslate" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/16/how-to-set-host-header-in-perl" title="perl发起HTTP请求时如何设置Host头" rel="bookmark">perl发起HTTP请求时如何设置Host头</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-16 00:00:00 +0800">16 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之所以写这么个内容，是今天突然发现之前有个脚本的效果完全不对。这个脚本是用 Furl 模块发 HTTP 请求。看 POD 的说明，以为这样写是生效的：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="nn">HTTP::</span><span class="n">Request</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Furl</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$r</span> <span class="o">=</span> <span class="nn">HTTP::</span><span class="n">Request</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">GET</span> <span class="o">=&gt;</span> <span class="s">&quot;http://192.168.0.2/path/to/file&quot;</span> <span class="p">);</span>
    <span class="nv">$r</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">(</span> <span class="n">Host</span> <span class="o">=&gt;</span> <span class="s">&quot;www.example.com&quot;</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$furl</span> <span class="o">=</span> <span class="n">Furl</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
    <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$furl</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="nv">$r</span><span class="p">);</span>
    <span class="n">say</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">();</span>
</code></pre></div>
<p>但是随后在 192.168.0.2 上发现日志记录中，Host 并没有修改成 www.example.com 。</p>
<p>然后尝试了各种 POD 上介绍的 header 写法，包括在 new HTTP::Request 的时候使用 <code>[Host =&gt; "www.example.com"]</code> 参数，在 <code>$furl-&gt;request</code> 的时候使用 <code>headers =&gt; [Host =&gt; "www.example.com"]</code> 参数。结果都一样。</p>
<p>然后只能改思路，用设置 proxy 的办法。结果发现 Furl 模块的 proxy 不可用……</p>
<p>POD 上是说直接在 new 的时候传递 %args 或者 \%args 就行。但是我使用的时候发现直接会报错：</p>
<pre><code>Passed malformed URL: 192.168.0.2
</code></pre>
<p>最后只能放弃使用 Furl 模块，改回古老的 LWP 模块。LWP 与 Coro 配合如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Coro</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">LWP::Protocol::Coro::</span><span class="n">http</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">LWP::</span><span class="n">UserAgent</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">co_http_get</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$domain</span><span class="p">,</span> <span class="nv">$urlpath</span><span class="p">,</span> <span class="nv">$iplist</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">@coros</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$msg</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$ua</span> <span class="o">=</span> <span class="nn">LWP::</span><span class="n">UserAgent</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$ip</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$iplist</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nb">push</span> <span class="nv">@coros</span><span class="p">,</span> <span class="n">async</span> <span class="p">{</span>
                <span class="nv">$ua</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">(</span><span class="s">&#39;http&#39;</span><span class="p">,</span> <span class="s">&quot;http://$ip:3128/&quot;</span><span class="p">);</span>
                <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$ua</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://$domain$urlpath&quot;</span><span class="p">);</span>
                <span class="nv">$msg</span> <span class="o">.=</span> <span class="s">&quot;$ip: &quot;</span> <span class="o">.</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">()</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nv">$_</span><span class="o">-&gt;</span><span class="nb">join</span> <span class="k">for</span> <span class="nv">@coros</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$msg</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">print</span> <span class="n">co_http_get</span><span class="p">(</span><span class="s">&quot;www.example.com&quot;</span><span class="p">,</span> <span class="s">&quot;/path/to/file&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sx">qw(192.168.0.1 192.168.0.2)</span><span class="p">]);</span>
</code></pre></div>
      <a href="/2012/12/16/how-to-set-host-header-in-perl" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/11/note-on-using-ElasticSearch-pm" title="不小心踩进ElasticSearch.pm模块的坑里了" rel="bookmark">不小心踩进ElasticSearch.pm模块的坑里了</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-11 00:00:00 +0800">11 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在今天以前，我一直认为perl的ElasticSearch.pm是除了原生java库以外封装最好的。不过今天踩进一个硕大的坑里，多亏 dancer-user 邮件列表里外国友人的帮助，才算爬了出来……</p>
<h1 id="section">事情是这样的</h1>
<p>用 dancer 搭建的一个 webserver 用来提供 api 给前端图表页面。dancer 收到 ajax 请求后组装成 json 发给 ElasticSearch。因为要算百分比，无法在单次请求内完成，不然的话直接从页面上发给 ES 服务器了。</p>
<p>这个 webserver 是之前已经创建过的。而且作用类似，也就是说，之前已经存在一个 <code>DancerApp/lib/DancerApp/First.pm</code> 里使用了 ElasticSearch 模块。相关代码如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">ElasticSearch</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$elsearch</span> <span class="o">=</span> <span class="n">ElasticSearch</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">config</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ElasticSearch</span><span class="p">}</span> <span class="p">);</span>
</code></pre></div>
<p>然后给新项目创建 <code>DancerApp/lib/DancerApp/Second.pm</code> 同样使用 ElasticSearch 模块，代码原样复制。然后在 <code>DancerApp/lib/DancerApp.pm</code> 里先后加载：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">FindBin</span> <span class="sx">qw($Bin)</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">lib</span> <span class="s">&quot;$Bin/../lib&quot;</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">DancerApp::</span><span class="n">First</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">DancerApp::</span><span class="n">Second</span><span class="p">;</span>
</code></pre></div>
<p>启动应用后访问页面。怪事出现了： <em>First 应用正常，Second 应用报错说 ElasticSearch 连接不上</em>。</p>
<p>仔细看报错信息，发现Second 里的 <code>$elsearch</code> 连接的不是 <code>config.yml</code> 里设定的 servers，而是模块默认的 <code>127.0.0.1:9200</code>。</p>
<p>更换<code>DancerApp/lib/DancerApp.pm</code> 里的加载次序，就变成了 <em>Second 正常，First 失败</em>。</p>
<p>试图使用下面的代码检查 <code>config</code> ，发现 config 里其他的设置都没问题，唯独和 ElasticSearch 相关的设定发生了变化：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="nn">Data::</span><span class="n">Dumper</span><span class="p">;</span>
    <span class="n">get</span> <span class="s">&#39;/config&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="k">return</span> <span class="n">Dumper</span> <span class="n">config</span> <span class="p">};</span>
</code></pre></div>
<p>结果中 <code>config-&gt;{ElasticSearch}</code> 只剩下 <code>trace_calls: 0</code> 一条设定， <code>servers</code>、<code>transport</code>、<code>no_refresh</code> 和 <code>max_requests</code> 都消失了！</p>
<h1 id="section-1">真相只有一个</h1>
<p>ElasticSearch 模块在初始化的时候，会把参数传递给 <code>ElasticSearch::Transport</code> 模块做具体的操作（包括之前我很欣赏的自动选择节点服务器）。而就在这里，问题出现了：</p>
<p><em>参数一直是以引用身份传递的，任何修改都会修改原始数据</em></p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$servers</span> <span class="o">=</span> <span class="nb">delete</span> <span class="nv">$params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">servers</span><span class="p">}</span>
        <span class="o">||</span> <span class="s">&#39;127.0.0.1:&#39;</span> <span class="o">.</span> <span class="nv">$transport_class</span><span class="o">-&gt;</span><span class="n">default_port</span><span class="p">;</span>
</code></pre></div>
<p>随着 <code>delete</code> 操作，悲剧就此发生了。Dancer 里的全局变量 <code>config-&gt;{ElasticSearch}</code> 中的 servers 元素就此消失……</p>
<h1 id="section-2">善后事宜</h1>
<p>解决办法很容易，在每个模块里初始化 ElasticSearch 实例的适合，传递一个全局 <code>config-&gt;{ElasticSearch}</code> 的_副本的引用_过去。</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$elsearch</span> <span class="o">=</span> <span class="n">ElasticSearch</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="p">{</span> <span class="nv">%</span><span class="p">{</span> <span class="n">config</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ElasticSearch</span><span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">);</span>
</code></pre></div>
<p>亲爱的 David Precious 童鞋已经把这个问题上报给 ElasticSearch.pm 开发者了。或许之后会由模块内部做副本操作。目前只能自己来了。</p>
<p>issue 地址：<a href="https://github.com/clintongormley/ElasticSearch.pm/issues/34">https://github.com/clintongormley/ElasticSearch.pm/issues/34</a></p>
      <a href="/2012/12/11/note-on-using-ElasticSearch-pm" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/10/gnuplot-to-draw-histogram-cluster" title="用gnuplot绘制直方图" rel="bookmark">用gnuplot绘制直方图</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-10 00:00:00 +0800">10 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>越来越喜欢用 gnuplot 画图了，因为有时候发现自己实在是不会用 Excel……</p>
<p>之前基本上用gnuplot画的都是时间轴形式的，诸位客官肯定已经看多了。但是 gnuplot 可不止是这点。还有一种很常见的功能也很方便，就是与时间无关的多个数据做对比的时候，还画成两条连线，就不如画成直方图更体现价值了。比如下面这组数据：</p>
<pre><code>地区	总数(A)	总数(B)
美洲	16682	20344
澳洲	4021	3672
欧洲	2902	2878
</code></pre>
<p>只需要几行配置，就可以生成很漂亮滴直方图对比了。</p>
<div class="highlight"><pre><code class="bash"><span class="nb">set </span>key right top Left reverse width 0 box 3
<span class="nb">set </span>xlabel <span class="s2">&quot;各大洲区域&quot;</span>
<span class="nb">set </span>ylabel <span class="s2">&quot;请求总数&quot;</span>
<span class="nb">set </span>ytics 0, 500
<span class="nb">set </span>mytics 5
<span class="nb">set </span>grid
<span class="nb">set </span>boxwidth 0.9 absolute
<span class="nb">set </span>style fill solid 1.00 border -1
<span class="nb">set </span>style histogram clustered gap 1 title offset character 0, 0, 0
<span class="nb">set </span>style data histograms
<span class="nb">set </span>terminal png size 1024, 512
<span class="nb">set </span>output <span class="s2">&quot;oversea.png&quot;</span>
plot <span class="s1">&#39;oversea.csv&#39;</span> using 2:xtic<span class="o">(</span>1<span class="o">)</span> ti col, <span class="s1">&#39;&#39;</span> u 3 ti col
</code></pre></div>
<p>注意如果行比较多，默认大小的图上X轴的标记就会挤在一块了，所以在 set terminal 后面设置图片大小，这和 set size 是不一样的。后者设置的相对值是本次要 plot 的图形在总画布上的比例大小。</p>
<p>plot 里 using 的两列也是和画 line 图时反过来的顺序，而且 X 轴的列要用 xtic() 包起来写，否则 gnuplot 会认为这应该是个自增序列，然后找不到 xrange 出错。</p>
<p>效果图如下：</p>
<p><img src="/images/uploads/gnuplot-boxes.png" alt="图片" /></p>
      <a href="/2012/12/10/gnuplot-to-draw-histogram-cluster" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/01/convert-docx-to-markdown" title="把docx文档转换成markdown格式发布" rel="bookmark">把docx文档转换成markdown格式发布</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-01 00:00:00 +0800">01 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>有些Word文档想搬到博客上来，而博客用的是markdown的格式。最简单的办法是在Word里转成html格式另存为，因为markdown和html是兼容的。不过word直接另存为的html里面带有“海量”的无聊样式，实在不方便之后我们再用vim的工具编辑。所以还是想办法整整。</p>
<p>相对来说，Word的docx格式比doc格式要容易处理，因为docx是微软特意推出的open xml格式。其实就是记录了文本内容的content.xml、附件media/*和对应附件路径的_ref.xml等的zip包而已。所以相对必须在Windows平台上调用WIN32OLE的API来处理的doc来说，我们在linux平台上也可以很容易的处理docx文件了。比如rubygems上就有一个很不错的gem叫<code>ydocx</code>。一般的docx库都是只抽取docx里的content文字，而这个ydocx很负责的把media/*也复制到docxname_files/images/*下面，并且在html里生成<code>&lt;img&gt;</code>标签了。</p>
<p>然后另一步就是把html转换成markdown，这在github上也有现成的repo叫<a href="https://github.com/cousine/downmark_it">downmark_it</a>。嗯，这名字一目了然就是反过来……</p>
<p>(<code>ydocx</code>用的是<code>nokogiri</code>，<code>downmark\_it</code>用的是<code>hpricot</code>，或许应该也改用<code>nokogiri</code>比较好~不过<code>nokogiri</code>官网可耻的被墙了)</p>
<h1 id="section">首先安装依赖</h1>
<div class="highlight"><pre><code class="bash">  apt-get install libxslt1-dev libxml2-dev
  gem install rubyzip htmlentities rmagick ydocx hpricot
  wget https://raw.github.com/cousine/downmark_it/master/downmark_it.rb
</code></pre></div>
<h1 id="section-1">编写转换脚本</h1>
<div class="highlight"><pre><code class="ruby">  <span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
  <span class="nb">require</span> <span class="s1">&#39;ydocx&#39;</span>
  <span class="vg">$:</span> <span class="o">&lt;&lt;</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span>
  <span class="nb">require</span> <span class="s1">&#39;downmark_it&#39;</span>
  <span class="n">filename</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">shift</span>
  <span class="n">ydocx</span> <span class="o">=</span> <span class="ss">YDocx</span><span class="p">:</span><span class="ss">:Document</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
  <span class="n">html</span> <span class="o">=</span> <span class="n">ydocx</span><span class="o">.</span><span class="n">to_html</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="no">DownmarkIt</span><span class="o">.</span><span class="n">to_markdown</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
</code></pre></div>
<p>这样就能看到输出了。目录里的每个章节都有引用格式凸现，美中不足是对word里的标题样式识别不太好，本来期望是可以自己生成<code>&lt;h1&gt;</code>、<code>&lt;h2&gt;</code>的，但是ydocx生成的html里只把第一个标题一变成<code>&lt;h1&gt;</code>，其他的都是普通的<code>&lt;p&gt;</code>。</p>
<p>另一个问题是上面脚本里直接调用to_html的方法，不会保存住unzip出来的images文件夹。自己再另写一段unzip的代码:</p>
<div class="highlight"><pre><code class="ruby">  <span class="nb">require</span> <span class="s1">&#39;fileutils&#39;</span>  
  <span class="nb">require</span> <span class="s1">&#39;zip/zip&#39;</span>  
  <span class="nb">require</span> <span class="s1">&#39;zip/zipfilesystem&#39;</span>  
  <span class="k">def</span> <span class="nf">unzip</span><span class="p">(</span><span class="n">zip_file</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">)</span>
    <span class="ss">Zip</span><span class="p">:</span><span class="ss">:ZipFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">zip_file</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">zf</span><span class="o">|</span>
      <span class="n">zf</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
        <span class="n">path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="no">FileUtils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">zf</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="p">{</span> <span class="kp">true</span> <span class="p">}</span>
      <span class="k">end</span>  
    <span class="k">end</span>  
  <span class="k">end</span>
  <span class="n">dirname</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;.docx&#39;</span><span class="p">)</span>
  <span class="n">unzip</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;/tmp/</span><span class="si">#{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="no">FileUtils</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="s2">&quot;/tmp/</span><span class="si">#{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">/media/&quot;</span><span class="p">,</span> <span class="s2">&quot;/images/&quot;</span><span class="p">)</span>
  <span class="no">FileUtils</span><span class="o">.</span><span class="n">rm_rf</span><span class="p">(</span><span class="s2">&quot;/tmp/</span><span class="si">#{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>比较普通的办法，是直接使用ydocx自带的脚本<code>docx2html --format none file.docx</code>，会在docx文档的同级目录下生成同名html和_files目录。然后再写一个单行脚本转成markdown的。</p>
      <a href="/2012/12/01/convert-docx-to-markdown" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page2">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page active">
      <a href="#">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li class="page">
      <a href="/page17">17</a>
    </li>
    <li>
      <a href="/page4">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
              <li><a href="http://showmetheco.de/" title="Viacheslav Tykhanovskyi(PocketIO/Text::Haml)">No time to wait</a></li>
              <li><a href="http://blog.dataloop.io/" title="A new SaaS monitoring tool for DevOps & Operations">Dataloop.IO</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://planeteria.org/perl6/" title="Perl6 文集">Planet Perl 6</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://junqili.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.sectop.org/" title="">kindle</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <a href='http://product.china-pub.com/3769604'><img src='http://images.china-pub.com/ebook3765001-3770000/3769604/zcover.jpg' border='0' alt='网站运维技术与实践'/></a>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
