<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
      	<li><a href="/tags.html">Tags</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/links.html">友情链接</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/08/20/coro-async-pool-demo" title="Coro::Semaphore和async_pool示例" rel="bookmark">Coro::Semaphore和async_pool示例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-08-20 00:00:00 +0800">20 Aug 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#testing-ref" title="testing" rel="category tag">testing</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>之前有一个<a href="http://chenlinux.com/2012/07/19/anyevent-fork-http-load-runner-demo/">AnyEvent和Fork写的http压测工具</a>，评论里有大神教导说用Coro控制并发更有效更方便。于是改写了下面的版本。从被压测的nginx server上，可以看到ESTABLISHED的数量确实大大增加，“”并发”两个字算是做到了。</p>
<p>先上普通的Coro::Semaphore控制并发的代码：</p>
<div class="highlight"><pre><code class="perl"><span class="c1"># 之前的fork和count部分完全一致，不重复帖了。</span>
<span class="k">sub </span><span class="nf">coro_get</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$count</span><span class="p">,</span> <span class="nv">$urls</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@coros</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$semaphore</span><span class="o">=</span> <span class="nn">Coro::</span><span class="n">Semaphore</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$ua</span>  <span class="o">=</span> <span class="nn">FurlX::</span><span class="n">Coro</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="mi">1</span> <span class="o">..</span> <span class="nv">$count...</span></code></pre></div>
</body></html>
      <a href="/2012/08/20/coro-async-pool-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/07/30/plack-middleware-demo" title="一个Plack::Middleware的实例" rel="bookmark">一个Plack::Middleware的实例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-30 00:00:00 +0800">30 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>做一个文件上传的网页，想稍微华丽一点，显示进度条出来。在Apache和Catalyst下都有现成的模块，不过Dancer上还没有。看了一下代码，Dancer::Request里没有像Catalyst那样暴露prepare_body_chunk方法。所以需要在plack上利用psgi.input来做。尽量重用现有代码，所以progress.css和progress.js都直接从Catalyst/Plugin/UploadProgress/example/Upload/root/static/里复制。</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">Plack::Middleware::</span><span class="n">UploadProgress</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">CHI</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Carp</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">HTTP::</span><span class="n">Body</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Plack:...</span></code></pre></div>
</body></html>
      <a href="/2012/07/30/plack-middleware-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/07/30/dancer-plugin-demo" title="一个Dancer::Plugin的实例" rel="bookmark">一个Dancer::Plugin的实例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-30 00:00:00 +0800">30 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>公司内部工具统一使用passport认证登录，于是写这么一个小plugin，用来给dancer做的网站使用统一认证。
passport的原理很简单，将原先的页面url带入session转到passport的login，然后由passport通过user/password或者kerberos确认是否正确，并返回一个ticket参数，然后拿这个ticket再到passport的verify上校验一次username，正确的话写入session即可。代码如下：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">Dancer::Plugin::Auth::</span><span class="n">Passport</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Dancer</span> <span class="s">':syntax'</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Dancer::</span><span class="n">Plugin</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Furl</span><span class="p">;</span> 
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
...</code></pre></div>
</body></html>
      <a href="/2012/07/30/dancer-plugin-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/07/19/anyevent-fork-http-load-runner-demo" title="用AnyEvent和ForkManager写一个http协议的压测工具" rel="bookmark">用AnyEvent和ForkManager写一个http协议的压测工具</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-19 00:00:00 +0800">19 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#testing-ref" title="testing" rel="category tag">testing</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>话不多说，先上第一版的代码：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Time::</span><span class="n">HiRes</span> <span class="sx">qw/time/</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">HTTP</span><span class="p">;</span>
<span class="k">use</span> <span class="n">AnyEvent</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Coro</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%code</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$count</span> <span class="o">=</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="k">my</span> <span class="nv">$url</span> <span class="o">=</span> <span class="s">"https://10.10.10.10/"</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$begin</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@coro</span> <span class="o">=</span> <span class="nb">map</span> <span class="p">{</span>
    <span class="n">async</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$cv</span> <span class="o">=</span> <span class="nn">AnyEvent::</span><span class="n">condvar</span><span class="p">;</span>
        <span class="nv">$cv</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$header_time</span><span class="p">;</span>
        <span class="n">http_request</span> <span class="n">GET</span> <span class="o">=&gt;</span> <span class="s">"$url"</span><span class="p">,</span>
            <span class="k">sub </span><span class="p">{</span>
  ...</code></pre></div>
</body></html>
      <a href="/2012/07/19/anyevent-fork-http-load-runner-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/07/07/intro-ipc-locker" title="IPC::Locker模块介绍" rel="bookmark">IPC::Locker模块介绍</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-07 00:00:00 +0800">07 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>当你需要给一个集群的某项服务做简单的排他性管理的时候，强力推荐Veripool公司的一系列模块：IPC::Locker、Schedule::Load。</p>
<p>今天先说IPC::Locker模块。部署很简单，直接在集群所有节点上运行cpanm IPC::Locker即可。该模块依赖几个都是perl的核心模块比如IO::Socket::INET、IO::Poll和POSIX。所以理论上你也可以把代码打个包分发。</p>
<p>随包分发的还有几个现成的脚本程序lockerd、lockersh、pidstat、pidstatd和pidwatch。</p>
<p>后面三个关注的remote设备上的pid是否存...</p>
</body></html>
      <a href="/2012/07/07/intro-ipc-locker" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/07/02/anyevent-httpd-demo" title="AnyEvent::HTTPD和AnyEvent::HTTP使用实例" rel="bookmark">AnyEvent::HTTPD和AnyEvent::HTTP使用实例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-02 00:00:00 +0800">02 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>很简单的一个实例，就是开一个端口接受url请求，然后向squid提交这个url的刷新。</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">HTTPD</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">HTTP</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$httpd</span> <span class="o">=</span> <span class="nn">AnyEvent::</span><span class="n">HTTPD</span><span class="o">-&gt;</span><span class="k">new</span> <span class="p">(</span><span class="n">port</span> <span class="o">=&gt;</span> <span class="mi">9090</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="s">"127.0.0.1"</span><span class="p">;</span>
<span class="nv">$httpd</span><span class="o">-&gt;</span><span class="n">reg_cb</span> <span class="p">(</span>
    <span class="s">'/'</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$httpd</span><span class="p">,</span> <span class="nv">$req</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$urlpath</span> <span class="o">=</span> <span class="nv">$req</span><span class="o">-&gt;</span><span class="n">url</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">;</span>
        <span class="n">http_request</span> <span class="n">PURGE</span> <span class="o">=&gt;</span> <span class="s">"http://${ip}${urlpath}"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=&gt;</span> <span class="p">{</span> <span class="s">"host"</span><span class="o">=&gt;</span><span class="s">"host.dom...</span></code></pre></div>
</body></html>
      <a href="/2012/07/02/anyevent-httpd-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/29/coro-intro" title="【翻译】Coro::Intro文档" rel="bookmark">【翻译】Coro::Intro文档</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-29 00:00:00 +0800">29 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <!-- INDEX BEGIN --><html><body>
<div name="index">
<p><a name="__index__"></a></p>
<ul>
	<li><a href="#coro%E7%AE%80%E4%BB%8B">Coro简介</a></li>
	<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AFcoro_">什么是Coro？</a></li>
	<li><a href="#%E5%8D%8F%E4%BD%9C%E7%BA%BF%E7%A8%8B">协作线程</a></li>
	<ul>
		<li><a href="#%E4%BF%A1%E5%8F%B7%E9%87%8F%E5%92%8C%E5%85%B6%E4%BB%96%E9%94%81">信号量和其他锁</a></li>
		<li><a href="#%E9%A2%91%E9%81%93">频道</a></li>
		<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%88%91%E7%9A%84_%E4%BB%80%E4%B9%88%E6%98%AF%E6%88%91%E4%BB%AC%E7%9A%84_">什么是我的，什么是我们的？</a></li>
		<li><a href="#%E8%B0%83%E8%AF%95">调试</a></li>
	</ul>
	<li><a href="#%E7%9C%9F%E5%AE%9E%E4%B8%96%E7%95%8C%E9%87%8C%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF">真实世界里的事件循环</a></li>
	<ul>
		<li><a href="#%E7%9C%9F%E5%AE%9E%E4%B8%96%E7%95%8C%E9%87%8C%E7%9A%84%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C">真实世界里的文件操作</a></li>
		<li><a href="#%E7%BF%BB%E8%BD%AC%E6%8E%A7%E5%88%B6____%E5%94%A4%E9%86%92%E5%87%BD%E6%95%B0">翻转控制 —— 唤醒函数</a></li>
	</ul>
	<li><a href="#%E5%85%B6%E4%BB%96%E6%A8%A1%E5%9D%97">其他模块</a></li>
	<li><a href="#%E4%BD%9C%E8%80%85">作者</a></li>
</ul>
<hr name="index">
</div>
<!-- INDEX END -->
<p>
</p>
<h1><a name="coro%E7%AE%80%E4%BB%8B">Coro简介</a></h1>
<p>这个教程准备给你介绍Coro模块家族的最主要的几个特性。</p>
<p>本文首先介绍一些基础概念，然后简单的概述一下Coro家族的情况。</p>
<p>
</p>
<hr>
<h1><a name="%E4%BB%80%E4%B9%88%E6%98%AFcoro_">什么是Coro？</a></h1>
<p>Coro最早是作为一个协程的简单实现的模块开始的。它允许你捕获当前的运行点并且跳到另一个点去，又随时可以再跳回来。作为一种非局部的跳转，和C语言里的<code>setjmp</code>/<code>longjmp</code>没什么不同。这就是<a href="/Coro/State.html">the Coro::State manpage</a>模块。</p>
<p>这有一个很天然的应用场合，就是在协作线程中内置一个调度器和结果集，这也是当前Coro最主要的应用场景。很多文档和论文把这些“协作线程(cooperative threads)”叫做“协程(coroutines)”或者更简单的就写...</p>
</body></html>
      <a href="/2012/06/29/coro-intro" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/14/intro-stf" title="STF介绍" rel="bookmark">STF介绍</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-14 00:00:00 +0800">14 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>STF项目，全称”<a href="http://en.wikipedia.org/wiki/Professional_wrestling_holds#STF">Stepover Toehold Facelock</a>“，原因是项目发起人喜欢这个动作，我勒个去……当然作者也给它找了个靠谱一点的解释，叫STorage Farm。</p>
<p>目前主要是日本三大门户之一<a href="http://blog.livedoor.com/">livedoor</a>和<a href="http://tou.ch/">loctouch</a>在使用。livedoor称其图片集群规模在70TB，400,000,000个对象(1,300,000,000个复制份)，高峰流量带宽400Mbps。按照这个数据计算，大概图片的平均大小是50KB的样子。</p>
<p>perl系原先已经有一个非常著名的分布式文件系统，叫MogileFS，作者说STF与MogileFS的不同时说到：</p>
<ol>
  <li>
    <p>STF整个是基于HTTP的，而且是PSGI的。这里我理解MogileFS内部是HTTP的，但是fs对外的api是非http的。而且因为时间较早的原因，mo...</p>
</li>
</ol>
</body></html>
      <a href="/2012/06/14/intro-stf" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/13/use-redis-and-grok-pattern-for-logstash" title="【Logstash系列】使用Redis并自定义Grok匹配" rel="bookmark">【Logstash系列】使用Redis并自定义Grok匹配</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-13 00:00:00 +0800">13 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>之前提到，用RabbitMQ作为消息队列。但是这个东西实在太过高精尖，不懂erlang不会调优的情况下，很容易挂掉——基本上我这里试验结果跑不了半小时日志传输就断了。所以改用简单易行的redis来干这个活。</p>
<p>之前的lib里，有inputs/redis.rb和outputs/redis.rb两个库，不过output有依赖，所以要先gem安装redis库，可以修改Gemfile，取消掉相关行的注释，搜redis即可。</p>
<p>然后修改agent.conf：</p>
<div class="highlight"><pre><code class="ruby"><span class="n">input</span> <span class="p">{</span>
  <span class="n">file</span> <span class="p">{</span>
    <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">"nginx"</span>
    <span class="n">path</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"/var/log/nginx/access.log"</span> <span class="o">]</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">output</span> <span class="p">{</span>
  <span class="n">redis</span> <span class="p">{</span>
    <span class="n">host</span> <span class="o">=&gt;</span> <span class="s2">"MyHome-1.domain.co...</span></code></pre></div>
</body></html>
      <a href="/2012/06/13/use-redis-and-grok-pattern-for-logstash" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/10/install-mogilefs" title="MogileFS安装" rel="bookmark">MogileFS安装</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-10 00:00:00 +0800">10 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>纯属凑数的更新，写写安装过程而已。没有调优，没有测评，嗯……</p>
<ul>
  <li>storage Node</li>
</ul>
<div class="highlight"><pre><code class="bash">cpanm MogileFS::Utils MogileFS::Client
<span class="c"># 因为MogileFS::Server的test里会测试mysql、sqlite、pgsql的支持，用不着，直接强制安装就好了</span>
cpanm --force MogileFS::Server
mkdir /etc/mogilefs
cat &gt; /etc/mogilefs/mogstored.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">maxconns = 10000</span>
<span class="s">httplisten = 0.0.0.0:7500</span>
<span class="s">mgmtlisten = 0.0.0.0:7501</span>
<span class="s">docroot=/data/mogstore</span>
<span class="s">EOF</span>
<span class="c"># 不在同一分区的磁盘采用软连接方式建立...</span></code></pre></div>
</body></html>
      <a href="/2012/06/10/install-mogilefs" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/08/intro-trafficserver-ssd-branch-in-taobao" title="淘宝TrafficServer的SSD分支测试与介绍" rel="bookmark">淘宝TrafficServer的SSD分支测试与介绍</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-08 00:00:00 +0800">08 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#CDN-ref" title="CDN" rel="category tag">CDN</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>同事介绍说淘宝有关于trafficserver的一个分支支持SSD的。下来试试。<a href="http://gitorious.org/trafficserver/taobao/commits/tbtrunk_ssd">下载地址</a></p>
<p>官方的ats安装过程很简单，这个分支稍微麻烦一些，因为有些包变成强制依赖了，包括：expat/openssl/pcre等。根据提示安装好再重新编译即可。</p>
<p>表面看几乎没什么差别，就是多了一个storage_ssd.config配置文件。</p>
<p>基础配置项说明网上都有，无外乎就是records.config里的监听，remap.config里的域名，storage.config里的目录。下面说几个比较怪异或者难受的地方：</p>
<ol>
  <li>
    <p>trafficserver极其依赖DNS解析。我在parents.config中定义了多个parents的IP:port后，打开records.config里的debug信息，包括http.*、dns.*、cdn.*和url.*，结果发现ats针对每个url，会在获取完parents后依然去请求dns解析...</p>
</li>
</ol>
</body></html>
      <a href="/2012/06/08/intro-trafficserver-ssd-branch-in-taobao" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/08/create-python-module-for-ganglia" title="用ganglia监控trafficserver" rel="bookmark">用ganglia监控trafficserver</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-08 00:00:00 +0800">08 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>trafficserver提供了几种很不错的性能监控方式。首先是一个模仿cisco的shell工具./bin/traffic_shell——这个工具可以set变量，也可以show变量，另一个是类似squidclient的./bin/traffic_line工具——这个工具同样可以set和show变量，不过这里变量更接近源代码函数名的样子，相当于调用API了。此外还有Perl和Web的其他方式……</p>
<p>注：有些变量是可以动态修改的，有些比如内存大小之类的必须重启才生效。</p>
<p>用shell工具最方便，因为你单写个show，会提示你所有可以show的参数。一般性能方面就是http-stats/http-trans-stats/proxy-stats/cache-stats这几个。淘宝ssd分支在这里增加了一个SSD吞吐量和RAM缓存命中率的显示。不过一开始，你会发现RAM Cache HITs一直是0.00%！！询问作者后才知道，为了尽量提高性能，默认配置下RAM命中后不统计数据直接pa...</p>
</body></html>
      <a href="/2012/06/08/create-python-module-for-ganglia" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/01/dist-logstash-and-elasticsearch" title="【Logstash系列】用rabbitmq和elasticsearch搭建分布式日志收集存储系统" rel="bookmark">【Logstash系列】用rabbitmq和elasticsearch搭建分布式日志收集存储系统</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-01 00:00:00 +0800">01 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>上上篇讲到怎样用MRI的ruby在客户端收集日志。今天主要注意服务器端，考虑grok、elastic、web这几个功能在JRuby上才好。所以服务器端可以再开一个JRuby的进程。</p>
<ul>
  <li>首先安装RabbitMQ的过程</li>
</ul>
<p>最简单的办法，采用epel的yum，或者apt安装。其次简单的办法，从rabbitmq上下载bin的tar.gz。 <br>
这里需要注意一下，rabbitmq-serve...</p>
</body></html>
      <a href="/2012/06/01/dist-logstash-and-elasticsearch" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/01/create-slides-by-using-spork-and-tt2" title="用Spork和Template::Toolkit生成slides胶片展示" rel="bookmark">用Spork和Template::Toolkit生成slides胶片展示</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-01 00:00:00 +0800">01 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>在不少技术集会上，大家都不再采用ppt而是使用pdf，甚至浏览器，编辑器来显示内容。利用js和css完成slide效果已经越来越花哨。另一个用vim的流派也让人很是惊叹~  <br>
那不会css的童鞋怎么办呢？这里有个笨办法。用Spork工具生成html页——反正slide一般内容不多，html代码重复一点也不浪费啥事儿~用template技术刚刚好。
Spork是一个在Sporx基础上构成的工具，可以直接cpan安装，不过默认情况下没有plugin。所以比较好的办法是上git找个带plugin的代码clone。这样页面样式好看点。  <br>
比方我用的这个就是Spork作者用的：<a href="https://github.com/ingydotnet/spork-pm">Spork-pm</a></p>
<p>新建一个slide的工程相当简单：</p>
<div class="highlight"><pre><code class="bash">git clone https://gith...</code></pre></div>
</body></html>
      <a href="/2012/06/01/create-slides-by-using-spork-and-tt2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/05/31/use-ruby-1.8-for-logstash-agent" title="【Logstash系列】使用原版Ruby1.8运行logstash的客户端程序" rel="bookmark">【Logstash系列】使用原版Ruby1.8运行logstash的客户端程序</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-05-31 00:00:00 +0800">31 May 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>在一般情况下，我们实验logstash都是直接用官网上下载的jar包，然后java运行即可。但如果在大规模场景下，这样其实并不是运维的最佳实践：</p>
<ol>
  <li>并不是所有设备都默认或者很方便的可以安装java；</li>
  <li>默认使用的JRuby执行效率比MRI的版本低一些，为了大规模运维管理，一般部署puppet的时候附加yum/apt获取的是Ruby1.8.7。</li>
</ol>
<p>花了一点时间了解了一下代码结构，发现这点其实是可以做到的。从github上clone代码，在其中的example、bin和lib目录中都看到大量对应官网文档的input/filter/output的东东。</p>
<p>根据我对logstash的了解，仅保留input的file、syslog和remote_luby，filter里的grok，output里的e...</p>
</body></html>
      <a href="/2012/05/31/use-ruby-1.8-for-logstash-agent" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/05/25/nginx-auth-by-perl-and-lua" title="用perl和lua在nginx中验证url" rel="bookmark">用perl和lua在nginx中验证url</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-05-25 00:00:00 +0800">25 May 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>和三年前的博客一样，还是时间加密钥加路径的加密方式。不过这次改用nginx，这样不用重新缓存后面的squid文件了。
先用ngx_lua做：</p>
<div class="highlight"><pre><code class="nginx">    <span class="k">set</span> <span class="nv">$expire</span> <span class="s">"600"</span><span class="p">;</span>
    <span class="k">set</span> <span class="nv">$salt</span> <span class="s">"mysalt"</span><span class="p">;</span>
    <span class="k">location</span> <span class="p">~</span><span class="sr">*</span> <span class="s">\.mp3</span>$ <span class="p">{</span>
<span class="c1">#local m = ngx.re.match(ngx.var.uri,"^/([0-9]{4})/([0-9]{2})/([0-9]{2})/([0-9]{2})/([0-9]{2})/([0-9a-z]{32})(/.*)")</span>
<span class="c1">#用ngx.re.match就不能%d,用string.match就不能{2}，郁闷</span>
<span class="c1">#而且ngx.re.match所有的捕获都在m数组里，这点类似perl的m//返回。</span>
     ...</code></pre></div>
</body></html>
      <a href="/2012/05/25/nginx-auth-by-perl-and-lua" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/05/22/puppet-reports-analysis-by-web" title="【puppet系列】网页展示puppet的客户端报告" rel="bookmark">【puppet系列】网页展示puppet的客户端报告</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-05-22 00:00:00 +0800">22 May 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#puppet-ref" title="puppet" rel="category tag">puppet</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>上篇说到怎样使用ENC脚本控制puppet的客户端配置，这篇说如何监控和展示客户端运行状态报告。</p>
<p>目前还是使用puppet默认的store方式，也就是报告都存在/var/lib/puppet/reports/$host/$dates.yaml里。所以分析只要针对这个目录下的文件即可，主要使用File::Stat和File::Find两个模块搞定。注意这两个模块在Perl5.16里是默认内核模块了~~</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">autodie</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Stat</span> <span class="sx">qw/:stat/</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">YAML::</span><span class="n">Syck</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">AnyEvent::Filesys::</span><span class="n">Notify</span><span class="p">;</span>
<span class="k">use</span> <span class="n">EV</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$inte...</span></code></pre></div>
</body></html>
      <a href="/2012/05/22/puppet-reports-analysis-by-web" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/05/18/puppet-external-nodes-classifier" title="【puppet系列】puppet使用ENC定义节点" rel="bookmark">【puppet系列】puppet使用ENC定义节点</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-05-18 00:00:00 +0800">18 May 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#puppet-ref" title="puppet" rel="category tag">puppet</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>今天研究puppet dashboard。主要有ENC和reports两个功能。其中ENC功能相当扯淡，因为你在web上点击添加的class/node/group，是没有任何依赖性检查(比如node命名是否符合fqdn，class是否存在)的，随便咋填绝无报错和拒绝！而且也没有提供类似report的导入工具，一旦启用就要完全重新手工输入所有配置……所以无论是从导入角度还是管理角度，自己实现一个靠谱点的ENC都是有必要的。    </p>
<p>关于puppet的ENC配置，参见<a href="http://docs.puppetlabs.com/guides/external_nodes.html">ENC的文档</a>    </p>
<p>主要就是修改puppet.conf里两个配置：    </p>
<ul>
  <li>
<code>node_terminus</code>，由plain修改成exec；</li>
  <li>
<code>external_nodes</code>，由none修改为ENC脚本的路径。    </li>
</ul>
<p>类似如下：...</p>
</body></html>
      <a href="/2012/05/18/puppet-external-nodes-classifier" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/05/10/quick-start-for-puppet-facter-erb" title="【puppet系列】puppet安装／Facter插件和puppet模板编写" rel="bookmark">【puppet系列】puppet安装／Facter插件和puppet模板编写</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-05-10 00:00:00 +0800">10 May 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#puppet-ref" title="puppet" rel="category tag">puppet</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>使用puppet管理集群配置是个很靠谱的做法。跟其他同类产品相比，第一他的DSL语法很丰富够灵活，第二围绕他的生态圈活跃，资料比较多。</p>
<h1 id="puppet">puppet安装</h1>
<p>由于关注热度比较高，所以各种简便安装办法都出来了。大家可以各自选择，走yum、apt或者src都行。我这里演示一下用rubygems的办法。优点是不用像yum那样找epel源，而且版本够新，缺点是没有yum自动出来的配置目录和管理脚本。</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/usr/bin/env bash</span>
<span class="c"># Set Curlrc for https</span>
<span class="nb">echo</span> <span class="s1">'insecure'</span> &gt;&gt; ~/.curlrc
<span class="c"># Install git</span>
curl -L get-git.rvm.io | sudo bash
<span class="c"># Install RVM</span>
curl -L get.rvm.io | sudo ...</code></pre></div>
</body></html>
      <a href="/2012/05/10/quick-start-for-puppet-facter-erb" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/05/08/collect-log-variables-by-ngx-lua" title="通过lua统计nginx内部变量数据" rel="bookmark">通过lua统计nginx内部变量数据</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-05-08 00:00:00 +0800">08 May 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>统计nginx的请求数据，一般有几个办法，一个是logrotate，通过access.log计算，这个很详细，但是实时性差一些；一个是Tengine提供的pipe，这个实时性更好，但是管道如果出现堵塞，麻烦就多了～这两种办法，归根结底都是把日志记录在本地(pipe方式如果要长期保留依然要记磁盘)然后由脚本完成计算。今天这里说另一种方法：在nginx内部，随着每次请求完成一些基础的数据统计，然后输出到存储里供长期调用。  <br>
代码如下：</p>
<div class="highlight"><pre><code class="nginx"><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">photo.domain.com</span><span class="p">;</span>
    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">set</span> <span class="nv">$str</span> <span class="nv">$uri</span><span class="p">;</span>
        <span class="kn">content_by_lua</span> <span class="s">'</span>
       ...</code></pre></div>
</body></html>
      <a href="/2012/05/08/collect-log-variables-by-ngx-lua" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/04/30/reading-notes-about-linux-system" title="Linux系统调优读书笔记" rel="bookmark">Linux系统调优读书笔记</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-04-30 00:00:00 +0800">30 Apr 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>今天在图书馆看书，摘抄一些有意思的细节。</p>
<h1 id="linux">Linux服务器性能调整</h1>
<p>Linux内存布局NUMA：  <br>
    非一致性读取 每个节点；  <br>
    每个节点下有 多个管理区(ZONE)内存块；  <br>
    内存块包括：  <br>
        ZONE_DMA 0~16MB  <br>
        ZONE_NORMAL 16~896MB
        ZONE_HIGHMEM 896MB~结束  <br>
    32位处理器下，用户空间3GB，内核空间1GB；  <br>
        内核空间除去ZONE_DMA和ZONE_NORMAL后只剩下128MB用来vmalloc/kmap等操作；  <br>
        kmap操作用来虚拟化页表数据位，可以在32位处理器下支持64GB内存。 <br>
    NUMA结构下8节点的互连结构，只是3个相互最...</p>
</body></html>
      <a href="/2012/04/30/reading-notes-about-linux-system" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/04/21/backup-blog-to-51cto" title="51CTO博客自动发布脚本" rel="bookmark">51CTO博客自动发布脚本</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-04-21 00:00:00 +0800">21 Apr 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body><div class="highlight"><pre><code class="perl"><span class="c1">#!/bin/env perl</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Util</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">YAML::</span><span class="n">Syck</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Perl6::</span><span class="n">Say</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">XMLRPC::</span><span class="n">Lite</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Data::</span><span class="n">Dumper</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$f</span> <span class="o">=</span> <span class="nn">File::</span><span class="n">Util</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@blogs</span> <span class="o">=</span> <span class="nb">grep</span> <span class="p">{</span><span class="sr">/\.markdown$/</span><span class="p">}</span> <span class="nv">$f</span><span class="o">-&gt;</span><span class="n">list_dir</span><span class="p">(</span><span class="s">'../_posts'</span><span class="p">,</span> <span class="s">'--recurse'</span><span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">@blogs</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$yaml</span> <span class="o">=</span> <span class="n">LoadFile</span><span class="p">(</span><span class="nv">$_</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$title</span> <span class="o">=</span> <span class="nv">$yaml</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">'title'</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$text</span> <span class="o">=</span> <span class="nv">$f</span><span class="o">-&gt;</span><span class="n">load_file</span><span class="p">(</span><span class="s">"$_"</span><span class="p">);</span>
    <span class="n">uploa...</span></code></pre></div></body></html>
      <a href="/2012/04/21/backup-blog-to-51cto" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/04/18/get-location-of-some-companys" title="获取造价百强公司的真实位置" rel="bookmark">获取造价百强公司的真实位置</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-04-18 00:00:00 +0800">18 Apr 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>很久没更新，没用技术，今天稍微geek一下下。给老婆搜索她行业百强公司的具体地点，看看如果换单位的话是否方便出行~代码如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl</span>
<span class="k">use</span> <span class="nn">Data::</span><span class="n">Dumper</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">LWP::</span><span class="n">UserAgent</span><span class="p">;</span>
<span class="k">use</span> <span class="n">URI</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Web::</span><span class="n">Scraper</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">JSON::</span><span class="n">XS</span><span class="p">;</span>
<span class="c1"># 处理中文需要指定输入输出都用utf8格式，否则会有wide character in print的warning提示 </span>
<span class="k">use</span> <span class="n">utf8</span><span class="p">;</span>
<span class="nb">binmode</span><span class="p">(</span><span class="bp">STDIN</span><span class="p">,</span> <span class="s">':encoding(utf8)'</span><span class="p">);</span>
<span class="nb">binmode</span><span class="p">(</span><span class="bp">STDOUT</span><span class="p">,</span> <span class="s">':encoding(utf8)'</span><span class="p">);</span>
<span class="nb">binmode</span><span class="p">(</span><span class="bp">STDERR</span><span class="p">,</span> <span class="s">':encoding(utf8)'</span><span class="p">);</span>
<span class="c1"># 百度地图搜索的查询结果返回的是json数据，需要转换成p...</span></code></pre></div>
</body></html>
      <a href="/2012/04/18/get-location-of-some-companys" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/04/16/configs-automatically-effective-for-elastic-monitor" title="弹性集群监控中的配置自动生效问题研究" rel="bookmark">弹性集群监控中的配置自动生效问题研究</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-04-16 00:00:00 +0800">16 Apr 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<p>最近跟<a href="http://weibo.com/fedoracore">@画圈圈的星星</a> 聊天，说到nagios在大规模集群运用中一个比较严重的瓶颈：修改配置需要重启进程。 <br>
听起来似乎不是什么问题，我个人之前对nagios的追求，也都放在怎么样提供一个及时高效的监控和数据展示上面—-这两个问题在 <code>mod_gearman</code> 和 <code>pnp4nagios</code> 的协助下已经很给力了。    </p>
<p>但是聊天中提到了一个新的场景，事实上早在两个月前，<a href="http://weibo.com/tjpm">@GNUer</a> 就提到过类似的场景，就是当 nagios 监控的是这样一个弹性集群的时候：</p>
<pre><code>集群设备数以千记，...</code></pre>
</body></html>
      <a href="/2012/04/16/configs-automatically-effective-for-elastic-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/03/18/postgreSQL-DBA-2000-note2" title="PostgreSQL中国用户会DBA2000培训计划北京第二课笔记" rel="bookmark">PostgreSQL中国用户会DBA2000培训计划北京第二课笔记</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-03-18 00:00:00 +0800">18 Mar 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#database-ref" title="database" rel="category tag">database</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <html><body>
<h2 id="section">运行维护</h2>
<h3 id="vacuum">vacuum命令</h3>
<p>pgsql是multi-version concurrency control的，update和delete的操作并不会真正的修改原版本的内容，而只是做一个标记，最后需要用vacuum命令回收失效版本的位置。<br>
vacuum的主要作用：
1. 恢复或重用失效的空间；
2. 更新pgsql规划器的数据统计；
3. 避免事务ID的重复。
事务ID只有32位，差不多40亿左右。建议在达到10亿左右的时候就需要vacuum一次。<br>
在version8.*之后，默认就是用auto vacuum。注意auto vacuum不是定时启动，而是触发式的。</p>
<p>vacuum命令有两种形式：
1. vacuum，正常情况，不阻...</p>
</body></html>
      <a href="/2012/03/18/postgreSQL-DBA-2000-note2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page2">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page active">
      <a href="#">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li>
      <a href="/page4">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
