<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/03/14/JPush-example" title="极光推送demo" rel="bookmark">极光推送demo</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-03-14 00:00:00 +0800">14 Mar 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前已经陆续写过很多种告警的方式。今天再稍微试验一种更新潮一些的 —— 手机推送通知。原先我的想法是移植 HTML5 的 websocket + notification 页面到手机上。但是发现手机上的浏览器都还没有 notification 功能。即便是用 PhoneGap 包装 HTML5 应用，PhoneGap 的 notification API 也不是我想象中的状态栏通知，而是类似 js 的 alert 对话框。</p>
<p>不过这个时候我发现了极光推送。嗯，本来蛮有挑战的事情顿时变成了十分钟内解决的小菜：</p>
<p>整个过程如下：</p>
<h3 id="section">注册帐号</h3>
<p>官网地址: <a href="http://jpush.cn">http://jpush.cn</a></p>
<h3 id="section-1">新建应用</h3>
<p>都是纯页面操作，填写应用名称而已。</p>
<h3 id="example-">下载 example 包</h3>
<p>在应用详情里有下载链接。</p>
<h3 id="adt-eclipse--example">用 adt eclipse 打开 example</h3>
<p>adt eclipse 直接从 android 官网下载 adt-bundle-linux-x86-20130219.tar.gz 解压即可运行。更多配置见 android 官网说明。</p>
<p>然后在 File 菜单栏选择 new -&gt; android application project 就可以新建自己的项目。然后创建自己的 workspace，把下好的 JPush example 包解压倒入workspace，然后就可以 run 了。</p>
<p>不过这里 run 会启动一个 android 虚拟机，很可能是连不上网的，原因似乎是 android vm 默认是 10.0.0.0 网段。</p>
<p>其实这时候我们会在 <code>workspace/push-example/bin/</code> 下发现一个 <code>push-example.apk</code> 文件。复制出来，通过豌豆荚或者别的什么工具直接装进自己手机就可以运行了。</p>
<h3 id="section-2">测试页面发送通知</h3>
<p>在极光的 portal 页面 <a href="http://www.jpush.cn/apps/${your app key}/notification">http://www.jpush.cn/apps/${your app key}/notification</a> 上可以直接提交通知内容。然后你就可以在手机状态栏通知上看到啦！</p>
<h3 id="section-3">测试命令行发送通知</h3>
<p>文档见<a href="http://docs.jpush.cn/pages/viewpage.action?pageId=2621796">http://docs.jpush.cn/pages/viewpage.action?pageId=2621796</a>。</p>
<p>比如通过简易通知推送接口发送如下：</p>
<div class="highlight"><pre><code class="bash">    <span class="c">#!/bin/sh</span>
    <span class="c">#下面两个是你新建应用后就分配的</span>
    <span class="nv">APP_KEY</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">API_MasterSecret</span><span class="o">=</span><span class="nv">$2</span>
    <span class="c">#自赠序列号，这个最好是通过mysql的auto_increment管理</span>
    <span class="nv">sendno</span><span class="o">=</span>2
    <span class="c">#这里有1,2,3,4,分别对应对指定IMEI/tag/alias/all的用户推送</span>
    <span class="nv">receiver_type</span><span class="o">=</span>4
    <span class="nv">verification_code</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -ne <span class="s2">&quot;$sendno$receiver_type$API_MasterSecret&quot;</span> | md5sum | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
    <span class="c">#platform包括android,ios等等，可以用逗号分开写多个</span>
    curl http://api.jpush.cn:8800/sendmsg/v2/notification -d <span class="s2">&quot;sendno=${sendno}&amp;app_key=${APP_KEY}&amp;receiver_type=${receiver_type}&amp;platform=android&amp;txt=123&amp;verification_code=${verification_code}&quot;</span>
</code></pre></div>
<p>然后收到如下响应：</p>
<div class="highlight"><pre><code class="bash">    <span class="o">{</span><span class="s2">&quot;sendno&quot;</span> :<span class="s2">&quot;2&quot;</span>, <span class="s2">&quot;errcode&quot;</span>:0,  <span class="s2">&quot;errmsg&quot;</span>:<span class="s2">&quot;Succeed&quot;</span><span class="o">}</span>
</code></pre></div>
<p>手机也同时响起~成功。</p>
      <a href="/2013/03/14/JPush-example" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/02/25/nginx-testing-10Gibps" title="Nginx 万兆网络环境测试" rel="bookmark">Nginx 万兆网络环境测试</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-02-25 00:00:00 +0800">25 Feb 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#testing-ref" title="testing" rel="category tag">testing</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <ul id="markdown-toc">
  <li><a href="#section">测试目标</a></li>
  <li><a href="#section-1">测试设备</a></li>
  <li><a href="#section-2">测试环境说明</a></li>
  <li><a href="#section-3">特别注意事项</a>    <ul>
      <li><a href="#keepalive">Keepalive</a></li>
      <li><a href="#rpspps">RPS、PPS与流量吞吐率</a></li>
      <li><a href="#section-4">压缩</a></li>
      <li><a href="#section-5">规则集</a></li>
      <li><a href="#section-6">实际网络情况</a></li>
    </ul>
  </li>
  <li><a href="#section-7">测试项目</a>    <ul>
      <li><a href="#section-8">测试一</a></li>
      <li><a href="#section-9">测试二</a></li>
      <li><a href="#section-10">测试三</a></li>
      <li><a href="#section-11">测试四</a></li>
      <li><a href="#section-12">测试五</a></li>
      <li><a href="#section-13">测试六</a></li>
      <li><a href="#section-14">测试七</a></li>
    </ul>
  </li>
  <li><a href="#section-15">术语及缩写说明</a></li>
  <li><a href="#section-16">附注</a></li>
</ul>
<h1 id="section">测试目标</h1>
<p>本次测试的目标是将nginx作为7层负载均衡软件，应用于万兆环境下，获得</p>
<ul>
  <li>
    <p>极限性能</p>
  </li>
  <li>
    <p>在服务质量保证约束条件下的极限性能</p>
  </li>
  <li>
    <p>提升极限性能的方法</p>
  </li>
  <li>
    <p>在万兆环境下部署的一般方法和特殊注意事项</p>
  </li>
</ul>
<p>同时，由于nginx还作为静态页面的提供者，附带还进行获得nginx作为静态文件服务器的</p>
<ul>
  <li>
    <p>极限性能</p>
  </li>
  <li>
    <p>在服务质量保证约束条件下的极限性能</p>
  </li>
  <li>
    <p>提升极限性能的方法</p>
  </li>
  <li>
    <p>在万兆环境下部署的一般方法和特殊注意事项</p>
  </li>
</ul>
<p>操作系统是一个很大的影响因素，在测试开始，会对操作系统版本进行选择，以确定哪个是更合适的平台。</p>
<h1 id="section-1">测试设备</h1>
<p>测试设备如下</p>
<ul>
  <li>
    <p>万兆网卡X520-DA2</p>
  </li>
  <li>
    <p>万兆交换机DCS-7124SX-F</p>
  </li>
  <li>
    <p>万兆DA线</p>
  </li>
  <li>
    <p>SNB服务器</p>
  </li>
  <li>
    <p>WSM服务器</p>
  </li>
</ul>
<h1 id="section-2">测试环境说明</h1>
<p>所有测试服务器连接在同一个万兆交换机下，处于同一个网段。</p>
<p>服务器划分为</p>
<ul>
  <li>
    <p>服务器（以S简称）：提供静态或动态页面，次要测试对象</p>
  </li>
  <li>
    <p>7层负载均衡（以LB简称）：提供负载均衡功能，主要测试对象</p>
  </li>
  <li>
    <p>客户端（以C简称）：提供测试压力</p>
  </li>
</ul>
<h1 id="section-3">特别注意事项</h1>
<h2 id="keepalive">Keepalive</h2>
<p>由于LB和S数量少，高RPS情况下，LB如果采用短连接方式连接S，LB的outgoing port会很快用尽。</p>
<p>解决的方法有两种：</p>
<ol>
  <li>
    <p>S采用多IP配置，模拟众多S的情况，减小每个S所要消耗的LB outgoing port；</p>
  </li>
  <li>
    <p>LB与S之间采用keepalive连接</p>
  </li>
</ol>
<p>短连接的方式下，CPU会有相当一部分消耗在三次握手上，这主要是操作系统开销（小包处理），以及nginx初始化会话上下文的开销。</p>
<h2 id="rpspps">RPS、PPS与流量吞吐率</h2>
<p>极限测试下，PPS考验服务器的CPU能力；而HTTP协议请求头的处理也是CPU密集型任务。</p>
<p>相同流量吞吐率下</p>
<ul>
  <li>
    <p>较小的响应意味着较高的RPS</p>
  </li>
  <li>
    <p>当响应小于一个最大TCP报文长度时，响应越小，也意味着PPS越高</p>
  </li>
</ul>
<p>极限测试中，需要测试以下三种情形</p>
<ul>
  <li>
    <p>全部是大报文。可以通过构造响应为一个最大TCP报文长度实现</p>
  </li>
  <li>
    <p>全部是小报文。可以通过构造响应为最小HTTP响应实现</p>
  </li>
  <li>
    <p>混合报文。可以通过构造响应为一个或两个TCP报文，一个是最大TCP报文长度，另外一个的长度可以控制，来满足特定的混合比例</p>
  </li>
</ul>
<p>流量吞吐率是一个表观指标，但我们更关心的是在带宽足够的条件下，RPS指标（的范围）。</p>
<h2 id="section-4">压缩</h2>
<p>在我们的实际使用中，LB是不负责压缩的。但测试中需要测试压缩对RPS的影响。需要考察压缩方面的优化方法。</p>
<h2 id="section-5">规则集</h2>
<p>负载均衡规则集大小对性能会有影响。由于规则集处理开销正比于RPS，测试中应对较大的规则集进行测试以找出影响大小和可能的优化措施。</p>
<h2 id="section-6">实际网络情况</h2>
<p>一般而言，极限性能是最理想情况。在本次测试中，我们还需要测试接近实际网络情况下的极限性能，这可以通过引入丢包率、延时来模拟。</p>
<h1 id="section-7">测试项目</h1>
<h2 id="section-8">测试一</h2>
<p>测试目标：了解nginx的带宽满载的最小文件大小 （web服务器模式），确定之后测试的文件大小上限</p>
<p>测试工具：ab</p>
<p>测试方法：</p>
<ol>
  <li>
    <p>S上Nginx做简单配置，使其成为web server；</p>
  </li>
  <li>
    <p>在C1上使用 <测试工具> 对S测试10000字节文件，每次减小1000字节，至带宽和RPS均为最高为止。</测试工具></p>
  </li>
  <li>
    <p>根据第二步测试情况调整文件大小，以逼近S的带宽恰好满载且CPU占用率最高时的情况，并记录最终的阈值大小和RPS/PPS指标。</p>
  </li>
</ol>
<p>测试结果：</p>
<table>
  <thead>
    <tr>
      <th><strong>文件大小(Bytes)</strong></th>
      <th><strong>CPU idle(%)</strong></th>
      <th><strong>带宽(MBps)</strong></th>
      <th style="text-align: right"><strong>PPS</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>10K</td>
      <td>65</td>
      <td>1140</td>
      <td style="text-align: right">606K</td>
    </tr>
    <tr>
      <td>3K</td>
      <td>12</td>
      <td>1135</td>
      <td style="text-align: right">1060K</td>
    </tr>
    <tr>
      <td>2590</td>
      <td>0</td>
      <td>1088</td>
      <td style="text-align: right">1138K</td>
    </tr>
    <tr>
      <td>1K</td>
      <td>0</td>
      <td>585</td>
      <td style="text-align: right">783K</td>
    </tr>
  </tbody>
</table>
<p>在采用kernel的pktgen发包测试中，苏能达到的最大PPS为1200K。2590Bytes文件测试中的PPS已经很接近纯发包测试的极限，所以最终，最充
分利用CPU和带宽的文件大小是2590Bytes。</p>
<h2 id="section-9">测试二</h2>
<p>测试目标：了解 nginx 的大致性能（web服务器模式）</p>
<p>测试工具：ab</p>
<p>测试方法：</p>
<ol>
  <li>
    <p>S上Nginx做简单配置，使其成为web server；</p>
  </li>
  <li>
    <p>在C1上使用 <测试工具> 对S分别测试空文件、616字节文件(半个包长度)、1232字节文件（即含header字节数为1448，整TCP包长度）、1
233字节文件（超过一个TCP/IP包大小1字节）和2590字节文件；3. 测试中记录S的网络吞吐量和CPU状况；C1的RPS，PPS指标波动情况。</测试工具></p>
  </li>
</ol>
<p>测试预期：</p>
<ol>
  <li>
    <p>吞吐量应超过1Gbps；</p>
  </li>
  <li>
    <p>吞吐量接近5Gbps；</p>
  </li>
  <li>
    <p>适当调整网卡等其他配置，应使RPS超过50万（原有百兆环境下的极限值）。</p>
  </li>
</ol>
<p>初步测试：</p>
<p>1、在CentOS6.2系统上，十次测试平均结果发现空文件的RPS仅为458005，响应时间0.88715ms，S带宽121M，未能达到预期。</p>
<p>2、检查发现CentOS6.2的ixgbe驱动版本为3.4.8，与最新版本差距较大，升级ixgbe驱动至最新版3.11.33。</p>
<p>更新后原先的8核client已经无法压满server，更换Client设备，ab并发由50×8提高到50×24，测试不同的InterruptThrottle
Rate条件下数据如下：</p>
<p>1000：</p>
<p><img src="/images/Nginx-testing-10Gibps/c568fc0.png" alt="" /></p>
<p>1500：</p>
<p><img src="/images/Nginx-testing-10Gibps/m15b564f6.png" alt="" /></p>
<p>2500：</p>
<p><img src="/images/Nginx-testing-10Gibps/85b1bbd.png" alt="" /></p>
<p>3500：</p>
<p><img src="/images/Nginx-testing-10Gibps/335545b5.png" alt="" /></p>
<p>4500：</p>
<p><img src="/images/Nginx-testing-10Gibps/m25052f88.png" alt="" /></p>
<p>根据以上数据可知，在ITR1500的情况下，空文件的RPS最高，对比数据如下：</p>
<table>
  <thead>
    <tr>
      <th><strong>ITR</strong></th>
      <th><strong>RPS</strong></th>
      <th><strong>带宽(MBps)</strong></th>
      <th><strong>user%</strong></th>
      <th><strong>sys%</strong></th>
      <th style="text-align: right"><strong>irq%</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1000</td>
      <td>688425</td>
      <td>186.886</td>
      <td>30.112</td>
      <td>52.936</td>
      <td style="text-align: right">16.951</td>
    </tr>
    <tr>
      <td>1500</td>
      <td>691614</td>
      <td>187.408</td>
      <td>30.125</td>
      <td>52.208</td>
      <td style="text-align: right">17.667</td>
    </tr>
    <tr>
      <td>2500</td>
      <td>682326</td>
      <td>183.277</td>
      <td>29.191</td>
      <td>53.253</td>
      <td style="text-align: right">17.556</td>
    </tr>
    <tr>
      <td>3500</td>
      <td>650367</td>
      <td>175.477</td>
      <td>26.803</td>
      <td>56.732</td>
      <td style="text-align: right">16.382</td>
    </tr>
    <tr>
      <td>4500</td>
      <td>630178</td>
      <td>169.474</td>
      <td>26.417</td>
      <td>56.708</td>
      <td style="text-align: right">16.833</td>
    </tr>
  </tbody>
</table>
<p>（注：表格中RPS和带宽数据均为峰值，CPU数据为平稳运行期的中间时刻采样值。下同）</p>
<p>所以在新驱动ITR1500的条件下，重新测试616,1232,1233,2590字节的数据：</p>
<p>616：</p>
<p><img src="/images/Nginx-testing-10Gibps/m2c94d5e6.png" alt="" /></p>
<p>1232：</p>
<p><img src="/images/Nginx-testing-10Gibps/3bd4c0bf.png" alt="" /></p>
<p>1233：</p>
<p><img src="/images/Nginx-testing-10Gibps/m1cb568d3.png" alt="" /></p>
<p>2590</p>
<p><img src="/images/Nginx-testing-10Gibps/m73a60e04.png" alt="" /></p>
<p>测试过程出现剧烈的吞吐量波动，在原有的itr1500的条件下服务极不稳定。</p>
<p>总结ITR1500条件下各文件大小的测试数据对比如下：</p>
<table>
  <thead>
    <tr>
      <th>文件大小(Btyes)</th>
      <th>RPS</th>
      <th><strong>带宽(MBps)</strong></th>
      <th>CPU usr%</th>
      <th>CPU sys%</th>
      <th style="text-align: right">CPU irq%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>691614</td>
      <td>187.408</td>
      <td>30.125</td>
      <td>52.208</td>
      <td style="text-align: right">17.667</td>
    </tr>
    <tr>
      <td>616</td>
      <td>586296</td>
      <td>459.435</td>
      <td>29.583</td>
      <td>54.250</td>
      <td style="text-align: right">16.083</td>
    </tr>
    <tr>
      <td>1232</td>
      <td>579103</td>
      <td>838.146</td>
      <td>29.471</td>
      <td>50.563</td>
      <td style="text-align: right">16.048</td>
    </tr>
    <tr>
      <td>1233</td>
      <td>513099</td>
      <td>772.826</td>
      <td>28.417</td>
      <td>48.875</td>
      <td style="text-align: right">22.708</td>
    </tr>
    <tr>
      <td>2590</td>
      <td>418226</td>
      <td>1173.760</td>
      <td>23.343</td>
      <td>41.934</td>
      <td style="text-align: right">18.216</td>
    </tr>
  </tbody>
</table>
<p>另经测试，ITR上调到15000后，2590字节文件测试的S吞吐量恢复成稳定满带宽运行。而且支持并发到80×24。对比ITR5000/10000/15000
条件下数据：</p>
<p>ITR5000图</p>
<p><img src="/images/Nginx-testing-10Gibps/m7333a2.png" alt="" /></p>
<p>ITR10000图：</p>
<p><img src="/images/Nginx-testing-10Gibps/m7721129e.png" alt="" /></p>
<p>ITR15000图：</p>
<p><img src="/images/Nginx-testing-10Gibps/a58a533.png" alt="" /></p>
<p>2.59KB文件在不同ITR下的测试数据对比如下：</p>
<table>
  <thead>
    <tr>
      <th>ITR</th>
      <th>RPS</th>
      <th><strong>带宽(MBps)</strong></th>
      <th>usr%</th>
      <th>sys%</th>
      <th>irq%</th>
      <th style="text-align: right">错误进程</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1500</td>
      <td>418226</td>
      <td>1173.760</td>
      <td>23.343</td>
      <td>41.934</td>
      <td>18.216</td>
      <td style="text-align: right">6</td>
    </tr>
    <tr>
      <td>5000</td>
      <td>418216</td>
      <td>1172.530</td>
      <td>24.250</td>
      <td>55.792</td>
      <td>19.667</td>
      <td style="text-align: right">3</td>
    </tr>
    <tr>
      <td>10000</td>
      <td>417989</td>
      <td>1171.960</td>
      <td>24.625</td>
      <td>52.958</td>
      <td>22.292</td>
      <td style="text-align: right">2</td>
    </tr>
    <tr>
      <td>15000</td>
      <td>404330</td>
      <td>1132.490</td>
      <td>23.802</td>
      <td>52.855</td>
      <td>23.343</td>
      <td style="text-align: right">0</td>
    </tr>
  </tbody>
</table>
<h2 id="section-10">测试三</h2>
<p>测试目标：了解nginx配置对性能的影响(access_log)</p>
<p>测试工具：ab</p>
<p>测试方法：</p>
<ol>
  <li>
    <p>S上做简单配置，关闭 access_log 后进行测试；</p>
  </li>
  <li>
    <p>再测试关闭 access_log buffer 的情况（对比测试二的 access_log buffer=1024k 的情况）</p>
  </li>
  <li>
    <p>在C1上使用 <测试工具> 对S分别测试空文件(ITR为1500)</测试工具></p>
  </li>
  <li>
    <p>测试中记录CPU占用率，网络吞吐量，RPS和平均响应时间指标</p>
  </li>
</ol>
<p>测试结果：</p>
<p>1、设置<code>access_log /data/access_log main;</code>的情况：</p>
<p>与关闭日志相比，吞吐量下降，并且无法支持相同数并发（平均有20%的ab进程退出），只能在30×24的并发数情况下完成稳定测试。</p>
<p><img src="/images/Nginx-testing-10Gibps/604d3126.png" alt="" /></p>
<p>2、将日志写入SSD磁盘，验证是否有性能提升。</p>
<p><img src="/images/Nginx-testing-10Gibps/m34c0cd58.png" alt="" /></p>
<p>由上两图对比，可见虽然将日志写入SSD对RPS稍有提升，但离关闭日志的70万差距甚远，更换SSD没有实质的意义。</p>
<p>3、普通磁盘上设置buffer=1024k参数</p>
<p><img src="/images/Nginx-testing-10Gibps/5637f0f7.png" alt="" /></p>
<p>4、设置buffer=64k参数</p>
<p><img src="/images/Nginx-testing-10Gibps/m3d18099f.png" alt="" /></p>
<p>5、设置buffer=4k参数</p>
<p><img src="/images/Nginx-testing-10Gibps/m160f2f0b.png" alt="" /></p>
<p>可见在使用buffer参数后，RPS明显提升到和关闭日志时一个数量级的水准。而buffer的大小，从4k到1024k，也可以提高10%左右。</p>
<p>测试三各项数据对比如下：</p>
<table>
  <thead>
    <tr>
      <th><strong>配置</strong></th>
      <th><strong>RPS</strong></th>
      <th><strong>带宽(MBps)</strong></th>
      <th><strong>Usr%</strong></th>
      <th><strong>Sys%</strong></th>
      <th><strong>irq%</strong></th>
      <th style="text-align: right"><strong>稳定并发</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>关闭日志</td>
      <td>691614</td>
      <td>187.408</td>
      <td>30.125</td>
      <td>52.208</td>
      <td>17.667</td>
      <td style="text-align: right">50*24</td>
    </tr>
    <tr>
      <td>打开日志</td>
      <td>180148</td>
      <td>49.074</td>
      <td>8.966</td>
      <td>21.337</td>
      <td>4.483</td>
      <td style="text-align: right">30*24</td>
    </tr>
    <tr>
      <td>使用SSD</td>
      <td>144347</td>
      <td>39.179</td>
      <td>10.875</td>
      <td>25.708</td>
      <td>5.750</td>
      <td style="text-align: right">30*24</td>
    </tr>
    <tr>
      <td>buffer4K</td>
      <td>588767</td>
      <td>159.297</td>
      <td>27.613</td>
      <td>55.352</td>
      <td>16.951</td>
      <td style="text-align: right">50*24</td>
    </tr>
    <tr>
      <td>buffer64K</td>
      <td>593022</td>
      <td>160.172</td>
      <td>26.845</td>
      <td>57.065</td>
      <td>16.048</td>
      <td style="text-align: right">50*24</td>
    </tr>
    <tr>
      <td>buffer1M</td>
      <td>659290</td>
      <td>177.959</td>
      <td>32.042</td>
      <td>51.875</td>
      <td>16.000</td>
      <td style="text-align: right">50*24</td>
    </tr>
  </tbody>
</table>
<h2 id="section-11">测试四</h2>
<p>测试目标：了解nginx配置对性能的影响(tcp_nopush off)</p>
<p>测试工具：ab</p>
<p>测试方法：</p>
<ol>
  <li>
    <p>S上做简单配置，同时关闭tcp_nopush off;</p>
  </li>
  <li>
    <p>在C1上使用 <测试工具> 对S分别测试1232字节文件和1233字节文件</测试工具></p>
  </li>
  <li>
    <p>测试中记录网络吞吐量，RPS和PPS指标</p>
  </li>
</ol>
<p>测试预期：</p>
<p>根据对TCP_NOPUSH的理解，在关闭此参数的情况下，1232字节文件的rps应该和开启状态下有较大差别。</p>
<p>测试结果：</p>
<p>1232字节文件数据：</p>
<p>当ITR为1500时：</p>
<p><img src="/images/Nginx-testing-10Gibps/51d7bf66.png" alt="" /></p>
<p>峰值带宽比测试二中的数据稍差，但是运行不稳定，CPU的波动与rps图相对应，尝试加大并发则有client进程出现connection timeout错误。</p>
<p>加大itr到15000后波动变的比较稳定。但RPS下降到40万，与测试二相差接近30%。数据如下：</p>
<p><img src="/images/Nginx-testing-10Gibps/m21d6c756.png" alt="" /></p>
<p>该项测试相关数据对比如下：</p>
<table>
  <thead>
    <tr>
      <th><strong>配置</strong></th>
      <th><strong>RPS</strong></th>
      <th><strong>带宽(MBps)</strong></th>
      <th><strong>Usr%</strong></th>
      <th><strong>Sys%</strong></th>
      <th><strong>Irq%</strong></th>
      <th style="text-align: right"><strong>退出进程</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>tcp_nopush on+ITR1500</td>
      <td>579103</td>
      <td>838.146</td>
      <td>29.471</td>
      <td>50.563</td>
      <td>16.048</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td>tcp_nopush off+ITR1500</td>
      <td>543050</td>
      <td>817.746</td>
      <td>27.095</td>
      <td>51.438</td>
      <td>21.467</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td>tcp_nopush off+ITR15000</td>
      <td>393416</td>
      <td>593.411</td>
      <td>22.458</td>
      <td>55.583</td>
      <td>21.958</td>
      <td style="text-align: right">0</td>
    </tr>
  </tbody>
</table>
<h2 id="section-12">测试五</h2>
<p>测试目标：了解nginx的大致性能（代理模式）</p>
<p>测试工具：ab</p>
<p>测试方法：</p>
<ol>
  <li>
    <p>S上nginx做简单配置，使其成为webserver，作为后端；</p>
  </li>
  <li>
    <p>LB上nginx做简单配置，使其成为L7 HTTP 代理，所有请求代理至S。LB后端keepalive在测试中测试两种情况，即打开和关闭</p>
  </li>
  <li>
    <p>在C1/C2上使用 <测试工具> 对LB分别测试空文件、1232字节文件和2590字节文件</测试工具></p>
  </li>
  <li>
    <p>测试中记录S和LB的CPU占用率，网络吞吐量，RPS三个指标</p>
  </li>
</ol>
<p>测试预期：</p>
<ol>
  <li>
    <p>Keepalive关闭时，可能需要对LB的内核参数进行调整才能够完成测试；</p>
  </li>
  <li>
    <p>Keepalive关闭时，仅调整内核参数可能不够，S需绑定多个IP地址，LB需使用S的多个IP地址；</p>
  </li>
</ol>
<p>测试结果：</p>
<p>（注：因为C1/C2的主板架构/CPU配置不一。8核的C2会先于24核的C1结束测试，后半段数据不如前半段稳定，不过单C1运行也基本可以逼近LB极限，不影响
数据采集和判断。）</p>
<p>1、空文件：</p>
<p><img src="/images/Nginx-testing-10Gibps/m45af05e8.png" alt="" /></p>
<p>2、1232字节文件</p>
<p><img src="/images/Nginx-testing-10Gibps/4687c6d4.png" alt="" /></p>
<p>3、2590字节文件</p>
<p><img src="/images/Nginx-testing-10Gibps/m449464d4.png" alt="" /></p>
<p>4、10K字节文件</p>
<p><img src="/images/Nginx-testing-10Gibps/m3622cdb6.png" alt="" /></p>
<p>根据测试二的经验，非空文件ITR为15000时表现更稳定，修改后数据如下：</p>
<p>1、1232字节：</p>
<p><img src="/images/Nginx-testing-10Gibps/9098f14.png" alt="" /></p>
<p>2、2590字节：</p>
<p><img src="/images/Nginx-testing-10Gibps/m7d14ebde.png" alt="" /></p>
<p>3、10k字节文件</p>
<p><img src="/images/Nginx-testing-10Gibps/278a77c9.png" alt="" /></p>
<p>4、100k字节文件</p>
<p><img src="/images/Nginx-testing-10Gibps/ffd255.png" alt="" /></p>
<p>关闭proxy_keepalive，使用2台Client测试，并发2400。空文件测试带宽只能压到18MBps，LB和S的CPU
idle都在85%以上。平均响应时间长达40ms。限于环境，压力测试无法继续进行。</p>
<p>本测试proxy_keepalive情况时各项数据对比如下：</p>
<table>
  <thead>
    <tr>
      <th><strong>ITR+文件大小</strong></th>
      <th><strong>RPS</strong></th>
      <th><strong>带宽(MBps)</strong></th>
      <th><strong>Usr%</strong></th>
      <th><strong>Sys%</strong></th>
      <th style="text-align: right"><strong>Irq%</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ITR1500+0Byte</td>
      <td>392406</td>
      <td>165.185</td>
      <td>39.533</td>
      <td>26.647</td>
      <td style="text-align: right">30.234</td>
    </tr>
    <tr>
      <td>ITR1500+1232Bytes</td>
      <td>369582</td>
      <td>588.209</td>
      <td>41.142</td>
      <td>28.595</td>
      <td style="text-align: right">28.929</td>
    </tr>
    <tr>
      <td>ITR1500+2590Bytes</td>
      <td>296866</td>
      <td>898.885</td>
      <td>34.250</td>
      <td>29.417</td>
      <td style="text-align: right">36.167</td>
    </tr>
    <tr>
      <td>ITR1500+10KBytes</td>
      <td>118163</td>
      <td>1167.280</td>
      <td>17.870</td>
      <td>18.319</td>
      <td style="text-align: right">15.218</td>
    </tr>
    <tr>
      <td>ITR15000+1232Bytes</td>
      <td>370590</td>
      <td>588.422</td>
      <td>41.167</td>
      <td>28.375</td>
      <td style="text-align: right">29.208</td>
    </tr>
    <tr>
      <td>ITR15000+2590Bytes</td>
      <td>297289</td>
      <td>897.755</td>
      <td>34.890</td>
      <td>28.429</td>
      <td style="text-align: right">35.682</td>
    </tr>
    <tr>
      <td>ITR15000+10KBytes</td>
      <td>118033</td>
      <td>1168.160</td>
      <td>21.137</td>
      <td>21.426</td>
      <td style="text-align: right">25.752</td>
    </tr>
    <tr>
      <td>ITR15000+100KBytes</td>
      <td>11388</td>
      <td>1168.890</td>
      <td>4.798</td>
      <td>12.542</td>
      <td style="text-align: right">10.522</td>
    </tr>
  </tbody>
</table>
<h2 id="section-13">测试六</h2>
<p>测试目标：nginx LB在多域名情况下的性能</p>
<p>测试工具：ab</p>
<p>测试方法：</p>
<p>1、S上nginx做简单配置，使其成为webserver，作为后端；</p>
<p>2、LB上nginx使用我司实际代理配置(800+域名)，使其成为L7 HTTP
代理，所有请求代理至S。LB后端keepalive在测试中测试两种情况，即打开和关闭</p>
<p>3、在C1上使用 <测试工具> 对LB分别测试单域名和随机多域名空文件请求</测试工具></p>
<p>4、测试中记录S和LB的CPU占用率，网络吞吐量，RPS三个指标</p>
<p>测试预期：</p>
<p>多域名代理情况下性能应和直接通过IP访问在一个数量级内。</p>
<p>测试结果：</p>
<p>1、单域名：</p>
<p><img src="/images/Nginx-testing-10Gibps/m76022a04.png" alt="" /></p>
<p>2、随机域名。因为测试在2台服务器上一共开启了32个ab进程，即随机选出32个域名做的测试，结果如下：</p>
<p><img src="/images/Nginx-testing-10Gibps/41f8c534.png" alt="" /></p>
<p>3、关闭keepalive的情况：</p>
<p><img src="/images/Nginx-testing-10Gibps/m6f56712d.png" alt="" /></p>
<p>可见代理模式使用多个domain和upstream配置，对性能没有太大影响。有影响的依然是keepalive是否开启。具体数据对比如下：</p>
<table>
  <thead>
    <tr>
      <th><strong>测试条件</strong></th>
      <th><strong>RPS</strong></th>
      <th><strong>带宽(MBps)</strong></th>
      <th><strong>Usr%</strong></th>
      <th><strong>Sys%</strong></th>
      <th style="text-align: right"><strong>Irq%</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>IP访问</td>
      <td>392406</td>
      <td>165.185</td>
      <td>39.533</td>
      <td>26.647</td>
      <td style="text-align: right">30.234</td>
    </tr>
    <tr>
      <td>单域名</td>
      <td>377292</td>
      <td>179.832</td>
      <td>41.091</td>
      <td>26.811</td>
      <td style="text-align: right">29.559</td>
    </tr>
    <tr>
      <td>多域名</td>
      <td>384513</td>
      <td>185.632</td>
      <td>43.297</td>
      <td>27.186</td>
      <td style="text-align: right">28.185</td>
    </tr>
    <tr>
      <td>No keepalive</td>
      <td>34879</td>
      <td>28.310</td>
      <td>5.973</td>
      <td>7.341</td>
      <td style="text-align: right">9.083</td>
    </tr>
  </tbody>
</table>
<h2 id="section-14">测试七</h2>
<p>测试目标：其他常见server性能对比</p>
<p>测试工具：ab</p>
<p>测试方法：</p>
<p>Resin4pro加临时lisence，默认配置(关闭日志)，测试空文件。</p>
<p>测试结果：</p>
<p><img src="/images/Nginx-testing-10Gibps/m2e7e1790.png" alt="" /></p>
<p>与nginx的webserver模式对比如下：</p>
<table>
  <thead>
    <tr>
      <th><strong>Webserver</strong></th>
      <th><strong>RPS</strong></th>
      <th><strong>带宽(MBps)</strong></th>
      <th><strong>Usr%</strong></th>
      <th><strong>Sys%</strong></th>
      <th style="text-align: right"><strong>Irq%</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>resin4</td>
      <td>44873</td>
      <td>32.353</td>
      <td>3.884</td>
      <td>4.545</td>
      <td style="text-align: right">10.455</td>
    </tr>
    <tr>
      <td>Nginx1.2</td>
      <td>691614</td>
      <td>187.408</td>
      <td>30.125</td>
      <td>52.208</td>
      <td style="text-align: right">17.667</td>
    </tr>
  </tbody>
</table>
<h1 id="section-15">术语及缩写说明</h1>
<p>RPS: Requests per Second，每秒请求数</p>
<p>PPS: Packets per second，每秒报文数</p>
<h1 id="section-16">附注</h1>
<p>生成图片的 GNUplot 脚本见<a href="http://chenlinux.com/2012/11/22/gnuplot-to-draw-multi-graph">http://chenlinux.com/2012/11/22/gnuplot-to-draw-multi-graph</a>。</p>
      <a href="/2013/02/25/nginx-testing-10Gibps" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/02/22/setup-stf2" title="STF 2.0 安装测试" rel="bookmark">STF 2.0 安装测试</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-02-22 00:00:00 +0800">22 Feb 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>STF 更新到 2.0 版本，支持使用 redis 队列做任务分发，比原先的 Q4M 容易上手多了；新增了 cluster 概念，虽然目前看没什么用，不过估计以后肯定要在这方面做文章的。</p>
<p>部署步骤如下：</p>
<div class="highlight"><pre><code class="bash">    <span class="c"># 因为 stf 要求在 Perl5.12 以上运行，CentOS6 还是 5.10 的老版本，所以直接用 Debian 测试了</span>
    apt-get install -y memcached redis-server libmysqlclient-dev libdbd-mysql-perl
    <span class="c"># 设置 mysql-server 包安装时需要的问答</span>
    <span class="nb">echo </span>mysql-server-5.5 mysql-server/root_password <span class="k">select </span>123456 | debconf-set-selections
    <span class="nb">echo </span>mysql-server-5.5 mysql-server/root_password_again <span class="k">select </span>123456 | debconf-set-selections
    apt-get install mysql-server-5.5
    <span class="c"># 系统依赖解决，开始 perl 部分</span>
    git clone git://github.com/stf-storage/stf.git
    <span class="nb">cd </span>stf
    cpanm Redis Data::Dumper::Concise
    cpanm --installdeps .
    <span class="c"># 创建 mysql 库和用户</span>
    mysql -uroot -p -e <span class="s1">&#39;create database stf&#39;</span>
    mysql -uroot -p -e <span class="s1">&#39;grant all privileges on stf.* to stf@&quot;%&quot; identified by &quot;654321&quot;&#39;</span>
    <span class="c"># 默认监听本机，分布式系统肯定是要放开这个的</span>
    sed -i <span class="s1">&#39;s/127.0.0.1/0.0.0.0/&#39;</span> /etc/mysql/my.cnf
    service mysql restart
    <span class="c"># 导入 sql 建表</span>
    mysql -ustf -p stf &lt; misc/stf.sql
    <span class="c"># 给 worker 和 dispatcher 设置队列使用 redis</span>
    <span class="nb">export </span><span class="nv">STF_QUEUE_TYPE</span><span class="o">=</span>Redis
    <span class="nb">export </span><span class="nv">STF_REDIS_HOSTPORT</span><span class="o">=</span>192.168.0.101:6379
    <span class="c"># 所有的角色都要有自己独有的 hostid</span>
    <span class="nb">export </span><span class="nv">STF_HOST_ID</span><span class="o">=</span>1
    <span class="nb">export </span><span class="nv">STF_HOME</span><span class="o">=</span>/root/stf
    <span class="c"># 启动 dispatcher，这里目前还只会用 plack，不知道怎么用 nginx/apache</span>
    <span class="nb">export </span><span class="nv">USE_PLACK_REPROXY</span><span class="o">=</span>1
    <span class="c"># 研究阶段可以打开 debug 看系统是怎么分发怎么平衡怎么确定使用哪个storage的file的过程</span>
    <span class="nb">export </span><span class="nv">STF_DEBUG</span><span class="o">=</span>1
    plackup -a etc/dispatcher.psgi
    <span class="c"># 启动 worker</span>
    ./bin/stf-worker
    <span class="c"># 启动管理界面网站，可以通过 web 添加 cluster 和 storage</span>
    plackup -a etc/admin.psgi -p 9000 &amp;
    <span class="c"># 一个 cluster 下至少需要有 3 个 storage，这里用三个目录三个端口来模拟</span>
    mkdir -p /data<span class="o">{</span>1,2,3<span class="o">}</span>
    <span class="nb">export </span><span class="nv">STF_STORAGE_ROOT</span><span class="o">=</span>/data1
    plackup -a etc/storage.psgi -p 8888 &amp;
    <span class="nb">export </span><span class="nv">STF_STORAGE_ROOT</span><span class="o">=</span>/data2
    plackup -a etc/storage.psgi -p 8889 &amp;
    <span class="nb">export </span><span class="nv">STF_STORAGE_ROOT</span><span class="o">=</span>/data3
    plackup -a etc/storage.psgi -p 8890 &amp;
</code></pre></div>
<p>然后上 9000 端口的 web 添加 cluster 和 storage，如下截图：</p>
<p><img src="/images/uploads/stf-admin1.png" alt="cluster" /></p>
<p><img src="/images/uploads/stf-admin.png" alt="storage" /></p>
<p>最后测试一下上传下载，如果上面 psgi 是 DEBUG 运行的，就可以看到详细的过程了。</p>
<div class="highlight"><pre><code class="bash">    lwp-request -m PUT http://192.168.0.101/bucket
    ^D
    lwp-request -m PUT http://192.168.0.101:5000/bucket/test.txt
    <span class="nb">test</span>
    ^D
    lwp-request http://192.168.0.101:5000/bucket/test.txt
    ls /data1/p/e/g/k/pegkuclninhsyqxftuzpwcuhgughpa.txt
    ls /data2/p/e/g/k/pegkuclninhsyqxftuzpwcuhgughpa.txt
</code></pre></div>
<p><strong>2013 年 03 月 20 日更新</strong></p>
<p>前面测试记录的，都是纯 perl 的部分。实际运用的时候，有些地方是可以用 nginx 来替代的。</p>
<p>源代码包中，apache-sample.conf 比 nginx-sample.conf 要全面的多。不过其实还是 nginx 配置起来容易，比如给 dispatcher.psgi 加上 nginx 代理，只需要这样就可以了：</p>
<div class="highlight"><pre><code class="nginx"><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">stf</span><span class="p">;</span>
    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span> <span class="s">http://192.168.0.101:5000/</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="s">/reproxy</span> <span class="p">{</span>
        <span class="kn">internal</span><span class="p">;</span>
        <span class="kn">set</span> <span class="nv">$reproxy</span> <span class="nv">$upstream_http_x_reproxy_url</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="nv">$reproxy</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>然后我们就可以直接通过 <code>http://192.168.0.101/bucket/test.txt</code> 来访问了。</p>
      <a href="/2013/02/22/setup-stf2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/01/31/puppet-define-type-and-custom-function" title="Puppet 自定义 type 和 function" rel="bookmark">Puppet 自定义 type 和 function</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-01-31 00:00:00 +0800">31 Jan 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Puppet 除了原有 DSL 以外，还提供了不少接口方便大家开发插件来更简单的完成一些高级功能。</p>
<h1 id="define-type">Define Type</h1>
<p>比如我们要维护一个上千域名组成的 ProxyServer 集群，其域名配置是相近的。那么我们就可以提炼出 template 里会变化的部分作为参数。由此定义出一个 type 如下：</p>
<div class="highlight"><pre><code class="ruby">    <span class="n">define</span> <span class="ss">nginx</span><span class="p">:</span><span class="ss">:vhost4proxy</span><span class="p">(</span>
        <span class="vg">$iplist</span> <span class="o">=</span> <span class="o">[]</span><span class="p">,</span>
        <span class="vg">$domainlist</span> <span class="o">=</span> <span class="o">[]</span><span class="p">,</span>
        <span class="vg">$extconf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="vg">$nginx_proxy_name</span>    <span class="o">=</span> <span class="vg">$name</span>
        <span class="vg">$nginx_proxy_servers</span> <span class="o">=</span> <span class="vg">$iplist</span>
        <span class="vg">$nginx_server_names</span>  <span class="o">=</span> <span class="vg">$domainlist</span>
        <span class="n">file</span> <span class="p">{</span> <span class="s2">&quot;${nginx_proxy_name}.server.conf&quot;</span><span class="p">:</span>
            <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">file</span><span class="p">,</span>
            <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/etc/nginx/conf.d&#39;</span><span class="o">]</span><span class="p">,</span>
            <span class="n">path</span>    <span class="o">=&gt;</span> <span class="s2">&quot;/etc/nginx/conf.d/${nginx_proxy_name}.server.conf&quot;</span><span class="p">,</span>
            <span class="n">content</span> <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;nginx/vhost_proxy.conf.erb&#39;</span><span class="p">),</span>
            <span class="n">notify</span>  <span class="o">=&gt;</span> <span class="no">Service</span><span class="o">[</span><span class="s1">&#39;nginx&#39;</span><span class="o">]</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
<p>然后在 template 里使用参数来生成结果：</p>
<div class="highlight"><pre><code class="ruby">    <span class="n">upstream</span> <span class="o">&lt;</span><span class="sx">%= nginx_proxy_name %&gt; {</span>
<span class="sx">            consistent_hash $request_uri;</span>
<span class="sx">    &lt;% nginx_proxy_servers.each do |ip| -%&gt;</span>
<span class="sx">            server &lt;%=</span> <span class="n">ip</span> <span class="sx">%&gt;;</span>
<span class="sx">    &lt;% end %&gt;</span>
    <span class="p">}</span>
    <span class="n">server</span> <span class="p">{</span>
        <span class="n">listen</span> <span class="mi">80</span><span class="p">;</span>
        <span class="n">server_name</span> <span class="o">&lt;</span><span class="sx">% scope.lookupvar(&quot;nginx_server_names&quot;).each </span><span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span> <span class="o">-</span><span class="sx">%&gt; &lt;%= name -%&gt;</span><span class="o">&lt;</span><span class="sx">% end %&gt;;</span>
<span class="sx">    </span>
<span class="sx">        location / {</span>
<span class="sx">            proxy_pass       http://&lt;%= scope.lookupvar(&quot;nginx_proxy_name&quot;) %&gt;</span><span class="p">;</span>
            <span class="kp">include</span>          <span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">proxy</span><span class="o">.</span><span class="n">conf</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="o">&lt;</span><span class="sx">% if </span><span class="n">has_variable?</span><span class="p">(</span><span class="s2">&quot;extconf&quot;</span><span class="p">)</span> <span class="sx">%&gt;</span>
<span class="sx">        &lt;%= scope.lookupvar(&quot;extconf&quot;) %&gt;</span>
    <span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
    <span class="p">}</span>
</code></pre></div>
<p>这样我们只需要在 puppet 中这样调用，就可以直接生成对应的配置了：</p>
<div class="highlight"><pre><code class="ruby">    <span class="ss">nginx</span><span class="p">:</span><span class="ss">:vhost4proxy</span><span class="p">(</span><span class="s1">&#39;server1&#39;</span><span class="p">:</span>
        <span class="o">[</span><span class="s1">&#39;1.1.1.1 weight=2&#39;</span><span class="p">,</span> <span class="s1">&#39;2.2.2.2 weight=3&#39;</span><span class="o">]</span><span class="p">,</span>
        <span class="o">[</span><span class="s1">&#39;server1.domain&#39;</span><span class="p">,</span> <span class="s1">&#39;server1.alias.domain&#39;</span><span class="o">]</span><span class="p">,</span>
        <span class="s1">&#39;access_log /path/to/other_log format&#39;</span>
    <span class="p">)</span>
</code></pre></div>
<h1 id="custom-function">Custom Function</h1>
<p>不过用上面 define type 还不能完全解决我们提出的问题。因为在 puppet 配置里写几千行 nginx::vhost4proxy 也是一件很可怕的事情！</p>
<p>这时候可以更进一步，把 vhost4proxy 的调用过程隐藏成一个 function，如下：</p>
<div class="highlight"><pre><code class="ruby">    <span class="nb">require</span> <span class="s1">&#39;yaml&#39;</span>
    <span class="k">module</span> <span class="nn">Puppet::Parser::Functions</span>
      <span class="n">newfunction</span><span class="p">(</span><span class="ss">:gen_proxy_confd</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:statement</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">args</span><span class="o">|</span>
        <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Parser</span><span class="o">::</span><span class="no">Functions</span><span class="o">.</span><span class="n">autoloader</span><span class="o">.</span><span class="n">loadall</span>
        <span class="n">resource_type</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
        <span class="n">yaml_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
        <span class="no">Dir</span><span class="o">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">yaml_dir</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">yaml_file</span><span class="o">|</span>
          <span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">yaml_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">yaml_file</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="k">next</span> <span class="k">unless</span> <span class="n">file_path</span><span class="o">[-</span><span class="mi">5</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">].</span><span class="n">eql?</span><span class="p">(</span><span class="s1">&#39;.yaml&#39;</span><span class="p">)</span>
          <span class="n">res_params</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
          <span class="n">function_create_resources</span><span class="p">(</span><span class="o">[</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">res_params</span><span class="o">]</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
</code></pre></div>
<p>然后只要把原先传递给 vhost4proxy 的参数写成 yaml 文件放好就行了。</p>
<div class="highlight"><pre><code class="yaml">    <span class="l-Scalar-Plain">---</span> 
    <span class="l-Scalar-Plain">server1</span><span class="p-Indicator">:</span> 
      <span class="l-Scalar-Plain">iplist</span><span class="p-Indicator">:</span> 
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">1.1.1.1 weight=2</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">2.2.2.2 weight=3</span>
      <span class="l-Scalar-Plain">domainlist</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">server1.domain</span>
        <span class="p-Indicator">-</span> <span class="s">&#39;*.server1.alias.domain&#39;</span>
      <span class="l-Scalar-Plain">extconf</span><span class="p-Indicator">:</span> <span class="p-Indicator">|-</span>
        <span class="no">chunkin on;</span>
        <span class="no">error_page 411 = @my_411_error;</span>
        <span class="no">location @my_411_error {</span>
            <span class="no">chunkin_resume;</span>
        <span class="no">}</span>
        <span class="no">access_log /path/to/other_log format;</span>
</code></pre></div>
<p>大家看起来是不是有点眼熟？没错，这个 yaml 的思路完全是借鉴了 hiera 的写法。但是 hiera 的设计是垂直继承的，不适合这里假设的平面式的情况 —— 当然，如果你觉得把这几千个 yaml 都写在一个大 yaml 文件里也不费劲的话。就不用上我这么折腾了~~</p>
<p>最后在 puppet 配置中只用一行就搞定全部：</p>
<div class="highlight"><pre><code class="ruby">    <span class="n">gen_proxy_confd</span><span class="p">(</span><span class="s1">&#39;nginx::vhost4proxy&#39;</span><span class="p">,</span><span class="s2">&quot;${modulepath}/nginx/yaml&quot;</span><span class="p">)</span>
</code></pre></div>
<h1 id="section">要点</h1>
<p>type 基本没有什么难度，因为他还是属于 puppet DSL 的运用。可以在其他配置文件内部直接写 define type，不过 puppet-lint 工具会报一个 warnings，所以建议还是单独拆分出来。</p>
<p>function 首先是路径和命名问题。</p>
<ol>
  <li>要把写 function 的文件放在 <code>${modulepath}/yourmodule/lib/puppet/parser/functions/</code> 路径下；</li>
  <li>和其他 type、class 一样，文件名必须和 function 一致，puppet 才能 autoload；</li>
  <li>格式是固定的，注意有两种:type，statement和rvalue。如果你的 function 目的是返回一个值给 puppet 继续使用，要指定好。默认是 statement；</li>
  <li>在自定义 function 里调用其他 function 有两种办法，一种写全路径 <code>Puppet::Parser::Functions.function('file')</code>；一种是使用 <code>Puppet::Parser::Functions.autoloader.loadall</code> 加载全部 function，然后用 <code>function_**</code> 的方式来调用；</li>
  <li>示例中最关键的一个是调用了 <code>function_create_resources</code> 。<code>create_resources</code> 用来批量创建资源。直接在 puppet 配置文件里使用的时候，接收的是列表参数。但是在 Ruby 里直接使用 <code>function_create_resources</code> 的话，接收的是一个匿名数组作为唯一参数。</li>
  <li>function 和 type 在 puppet 中可以认为是 class 的一种，所以它们也是有自己的作用域的。所以看到传递参数时写的是 &ldquo;nginx::vhost4proxy&rdquo;。</li>
</ol>
<h1 id="section-1">参考内容</h1>
<p>关于 Facts 在 function 中的运用，rvalue 的示例等更多内容见官网：<a href="http://docs.puppetlabs.com/guides/custom_functions.html">http://docs.puppetlabs.com/guides/custom_functions.html</a>。</p>
<p>关于 puppet 自带的各种 function 的说明，见官网(很多也没写)：<a href="http://docs.puppetlabs.com/references/latest/function.html">http://docs.puppetlabs.com/references/latest/function.html</a>。</p>
<h1 id="section-2">鸣谢</h1>
<p>感谢 <a href="http://weibo.com/liucy1983">@liu.cy</a> 童鞋提醒我变量作用域的问题。function 的调试过程很痛苦。</p>
      <a href="/2013/01/31/puppet-define-type-and-custom-function" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/01/11/systemtap-to-debug-kmsg-dump" title="用 systemtap 调试 kmsg dump" rel="bookmark">用 systemtap 调试 kmsg dump</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-01-11 00:00:00 +0800">11 Jan 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>google 之前推出了一个 netoops 的 patch，可以让 linux kernel 在崩溃的时候通过 udp 协议把信息发送到远端主机上。我之前在 CentOS6.2 的内核上做过测试，详细做法可以参见淘宝内核组 wiki 的<a href="http://kernel.taobao.org/index.php/Documents/Kernel_build">编译使用淘宝内核</a>和 <a href="kernel.taobao.org/index.php/Documents/Kernel_netoops_howto">netoops 使用指南</a>。唯一有区别的地方就是淘宝使用的 RedHat6 的内核在 CentOS6 上有签名问题，需要自己从 CentOS 官网 ftp 下载 src.rpm 来用 —— 当然如果要自己搞定编译那步，少不了就要自己修改 config-genaric 和 kernel.spc 文件了。</p>
<p>昨天同事升级修改到 CentOS6.3 内核( 2.6.32.220 -&gt; 2.6.32.279 )上。结果发现修改冲突代码编译通过后，再使用 soft dump 方式测试，远端主机 nc 收不到结果了。</p>
<p>稍微 grep 一下代码，发现是在 <code>kernel/printk.c</code> 里定义 <code>void kmsg_dump()</code> 的。好了，使用 systemtap 来检查这里： </p>
<div class="highlight"><pre><code class="c">    <span class="n">stap</span> <span class="o">-</span><span class="n">ve</span> <span class="err">&#39;</span><span class="n">probe</span> <span class="n">kernel</span><span class="p">.</span><span class="n">function</span><span class="p">(</span><span class="s">&quot;kmsg_dump&quot;</span><span class="p">){</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="err">$$</span><span class="n">vars</span><span class="err">$$</span><span class="p">)}</span><span class="err">&#39;</span>
</code></pre></div>
<p>结果发现在 soft dump 的时候有输出，也就是说调用了 <code>kmsg_dump()</code>。</p>
<p>比较 2.6.32.220 和 2.6.32.279 的代码，发现在 <code>kmsg_dump()</code> 里，新内核多了一点判断，如果reason 低于 <code>KERNEL_OOPS</code> 而且没有设置 <code>always_kmsg_dump</code> 变量，那么直接返回不再 <code>dumper-&gt;dump()</code> 了。</p>
<div class="highlight"><pre><code class="c"><span class="mi">1546</span>    <span class="k">if</span> <span class="p">((</span><span class="n">reason</span> <span class="o">&gt;</span> <span class="n">KMSG_DUMP_OOPS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">always_kmsg_dump</span><span class="p">)</span>
<span class="mi">1547</span>            <span class="k">return</span><span class="p">;</span> 
</code></pre></div>
<p>我们验证一下是不是这个原因：</p>
<div class="highlight"><pre><code class="c">    <span class="n">stap</span> <span class="o">-</span><span class="n">gve</span> <span class="err">&#39;</span><span class="n">probe</span> <span class="n">kernel</span><span class="p">.</span><span class="n">statement</span><span class="p">(</span><span class="s">&quot;*@kernel/printk.c:1548&quot;</span><span class="p">)</span>  <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="err">$$</span><span class="n">parms</span><span class="err">$$</span><span class="p">)</span> <span class="p">}</span><span class="err">&#39;</span>
</code></pre></div>
<p>显然测试的时候 reason 是 <code>KERNEL_SOFT</code>，这个是不好调的，那么我们可以调整这个变量，找了一下没发现这个可以在 sysctl 什么的里面，所以继续用 systemtap 搞定：</p>
<div class="highlight"><pre><code class="c">    <span class="n">stap</span> <span class="o">-</span><span class="n">gve</span> <span class="err">&#39;</span><span class="n">probe</span> <span class="n">kernel</span><span class="p">.</span><span class="n">statement</span><span class="p">(</span><span class="s">&quot;*@kernel/printk.c:1545&quot;</span><span class="p">)</span>  <span class="p">{</span> <span class="err">$</span><span class="n">always_kmsg_dump</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="err">$</span><span class="n">always_kmsg_dump</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="err">$$</span><span class="n">parms</span><span class="err">$$</span><span class="p">)</span> <span class="p">}</span><span class="err">&#39;</span>
</code></pre></div>
<p>果然搞定。</p>
      <a href="/2013/01/11/systemtap-to-debug-kmsg-dump" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/01/10/update-puppet-to-3.0" title="升级 Puppet 到 3.0 及其他附件简介" rel="bookmark">升级 Puppet 到 3.0 及其他附件简介</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-01-10 00:00:00 +0800">10 Jan 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>今天把 puppet 从2.7 升级到了 3.0。同时放弃了之前通过 ENC 定义所有 top scope variable 的做法，改成只定义一个 role 变量，然后在各个 module 里根据 $role 加载不同的module::role ，把变量都写在 module::role 里。</p>
<p>经历过上次事故后，我对全局变量已经大大的有不安全感，包括 puppet 3.0 新进内核的 hiera (<a href="http://docs.puppetlabs.com/puppet/3/reference/lang_classes.html#using-hierainclude">官网介绍文档</a>中也说是&rdquo;like a lightweight ENC&rdquo;)。虽然 module::role 看起来很多是重复内容，还是让人工的操作多经过一些检测才放心。</p>
<p>从 2.7 升级到 3.0 没有太多的不适应。官网上列了很多<a href="http://docs.puppetlabs.com/puppet/3/reference/release_notes.html">不同</a>。不过实际上基本没改动什么。</p>
<ul>
  <li>运行命令统一成 <code>puppet command</code> 的形式，2.7的时候还保留的一堆命令都没有了。</li>
  <li><code>--apply</code> 改成 <code>--catalog</code>  了。不过这个其实我没用过。</li>
  <li><code>pluginsync</code> 默认开启了。这个是替代 <code>factsync</code> 的。2.7 的时候默认还是关闭。给 facter 写插件应该是很容易而且很必要的事情。</li>
  <li>master 内置 webserver 取消了。也就是说原先各种优化文档里的 <code>--servertype=mongrel</code> 没用了。但是 3.0 变成了标准 Rack 应用。直接在 <code>/etc/puppet/rack</code> 下运行 <code>rackup -s thin -p 18140 -D -P /tmp/puppetmaster.pid</code> 就可以了。</li>
  <li>自然对应的 rack 配置文件 <code>config.ru</code> 改了，看 example 就好。</li>
  <li><code>include</code> 可以传递数组</li>
  <li>agent 的 lockfile 把 fork running 和 disabled 区分成两个文件了。不知道能不能消灭掉原先 agent 跑着跑着僵死的情况。</li>
</ul>
<p>以上是官网列举的主要内容。以下还有我__实际测试中发现的问题__：</p>
<ul>
  <li>agent 的 puppet.conf 里需要添加一行 <code>preferred_serialization_format = yaml</code>，否则默认使用 pson 会直接报错。</li>
</ul>
<hr />
<p>今天重温了一下 github 在 puppetconf 上的讲演<a href="https://speakerdeck.com/jnewland/chatops">《chatops》</a>。当然对其中的 hubot 不是重点关注。主要是其中提到的 rodjek 的几个 puppet 相关的项目觉得蛮有用的。</p>
<ul>
  <li>puppet-lint </li>
</ul>
<p>地址：<a href="https://github.com/rodjek/puppet-lint.git">https://github.com/rodjek/puppet-lint.git</a></p>
<p>这是一个语法格式检查器，如果 ERROR 会 <code>exit 1</code>。之前两天我还刚在 CPAN 上发现过一个 <a href="https://metacpan.org/module/Puppet::Tidy">Puppet::Tidy</a> 模块。不过目前为止，这两个都不是很满意：</p>
<ol>
  <li>puppet-lint 只能检查格式而不会替你修改格式。</li>
  <li>puppet-tidy 可以修改格式但是它对格式的检查太简陋了。</li>
</ol>
<p>当然比 puppet-tidy 稍微好一些的 puppet-lint 也不是很精准，比如他会对所有用双引号定义的变量报 &ldquo;WARNING: double quoted string containing no variables&rdquo;；而 puppet-tidy 更奇怪的给我 ip 地址的最后一段再加上了一个单引号变成了下面这个样子：</p>
<div class="highlight"><pre><code class="perl">    <span class="nv">$iplist</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;192.168.1.&#39;2&#39;&quot;</span><span class="p">,</span><span class="s">&quot;192.168.1.&#39;3&#39;&quot;</span><span class="p">]</span>
</code></pre></div>
<p>只能说规范化任重道远。</p>
<ul>
  <li>puppet-profiler</li>
</ul>
<p>地址：<a href="https://github.com/rodjek/puppet-profiler.git">https://github.com/rodjek/puppet-profiler.git</a></p>
<p>这是一个 agent 执行的调试器，不过至今为止功能也还很简单：就是执行一次 </p>
<div class="highlight"><pre><code class="bash">    puppet agent --test --evaltrace --nocolor
</code></pre></div>
<p>排序各个 Resource 的执行耗时，并打印前十名。</p>
<ul>
  <li>rspec-puppet</li>
</ul>
<p>地址：<a href="https://github.com/rodjek/rspec-puppet">https://github.com/rodjek/rspec-puppet</a></p>
<p>这是一个 puppet 的 rspec 测试工具扩展。注意他依赖于 <code>puppetlabs_spec_helper</code> 但是 gem 里却没写。。。</p>
<p>使用方法看 github 上的说明比较详细了，稍后我再单写一篇介绍。</p>
      <a href="/2013/01/10/update-puppet-to-3.0" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/01/10/rspec-puppet-intro" title="给 puppet 写 Rspec 测试用例" rel="bookmark">给 puppet 写 Rspec 测试用例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-01-10 00:00:00 +0800">10 Jan 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上文提到 github 给 puppet 开发的几个附件。其中有扩展 rspec 的 rubygems 模块叫做 rspec-puppet。官网见：<a href="http://rspec-puppet.com">http://rspec-puppet.com</a></p>
<p>照着官网 <a href="http://rspec-puppet.com/tutorial/">Tutorial</a>，很容易能写出来测试用例。我这样ruby入门没看完的水准，从发现这个gem到写完第一个测试用例，也就花了不到半个小时。</p>
<h1 id="section">安装</h1>
<div class="highlight"><pre><code class="bash">    gem install puppetlabs_spec_helper rspec_puppet
</code></pre></div>
<h1 id="section-1">创建测试用例环境</h1>
<p>以测试 nginx 模块为例：</p>
<div class="highlight"><pre><code class="bash">    <span class="nb">cd</span> /etc/puppet/modules/nginx
    rspec-puppet-init
</code></pre></div>
<p>这个 init 脚本其实就是执行了一串 <code>mkdir -p</code> 和 <code>ln -s</code> 命令，最后生成一个总的 Rakefile 。详情见官网<a href="http://rspec-puppet.com/setup/">Setup</a>。</p>
<h1 id="section-2">编写测试用例</h1>
<p>扩展给 Rspec 增加的方法其实不多，官网 <a href="http://rspec-puppet.com/matchers/">Matchers</a> 页面上有说。主要就是下面几个：</p>
<ul>
  <li><code>include_class()</code></li>
  <li><code>contain_&lt;resource&gt;()</code></li>
  <li><code>run()</code></li>
  <li><code>.with()</code></li>
  <li><code>.without()</code></li>
</ul>
<p>现在来写我们的第一个测试用例 <code>/etc/puppet/modules/nginx/spec/classes/common_spec.rb</code> 吧：</p>
<div class="highlight"><pre><code class="ruby">    <span class="c1"># 这个文件被 init 自动生成在 /etc/puppet/modules/nginx/spec/ 下了</span>
    <span class="c1"># 其内容就是加入这个目录下所有的文件</span>
    <span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
    <span class="c1"># 这里定义你要测试的 puppet module</span>
    <span class="n">describe</span> <span class="s1">&#39;nginx&#39;</span> <span class="k">do</span>
        <span class="n">it</span> <span class="k">do</span>
            <span class="n">should</span> <span class="n">include_class</span><span class="p">(</span><span class="s1">&#39;nginx::sysctl&#39;</span><span class="p">)</span>
            <span class="n">should</span> <span class="n">include_class</span><span class="p">(</span><span class="s1">&#39;nginx::install&#39;</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">describe</span> <span class="s1">&#39;nginx::common&#39;</span> <span class="k">do</span>
        <span class="c1"># 使用let定义变量</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:node</span><span class="p">)</span> <span class="p">{</span> <span class="s1">&#39;common-nginx-2.domain.com&#39;</span> <span class="p">}</span>
        <span class="c1"># 不定义的话，测试中只有从前面:node 生成的 hostname,domain,fqdn 三个</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:facts</span><span class="p">)</span> <span class="p">{</span> <span class="p">{</span>
            <span class="ss">:ipaddress_eth0</span> <span class="o">=&gt;</span> <span class="s1">&#39;192.168.1.2&#39;</span><span class="p">,</span>
            <span class="ss">:processorcount</span> <span class="o">=&gt;</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span>
        <span class="p">}</span> <span class="p">}</span>
        <span class="n">it</span> <span class="k">do</span>
            <span class="n">should</span> <span class="n">include_class</span><span class="p">(</span><span class="s1">&#39;nginx::common&#39;</span><span class="p">)</span>
            <span class="c1"># 注意这里要写 Resource 的名字，而不是 file 的 path</span>
            <span class="c1"># 这个是下面 .with 检查的 :param</span>
            <span class="n">should</span> <span class="n">contain_file</span><span class="p">(</span><span class="s1">&#39;proxy.conf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">({</span>
                <span class="s1">&#39;ensure&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mode&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;0644&#39;</span><span class="p">,</span>
                <span class="s1">&#39;path&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;/etc/nginx/conf.d/proxy.conf&#39;</span>
            <span class="p">})</span>
        <span class="k">end</span>
        <span class="n">context</span> <span class="s1">&#39;access_log&#39;</span> <span class="k">do</span>
            <span class="n">expect_line</span> <span class="o">=</span> <span class="s1">&#39;access_log /data/nginx/logs/access.log main buffer=16k;&#39;</span>
            <span class="n">it</span> <span class="k">do</span>
                <span class="c1"># 注意这里是把整个 content 作为 String 对象传递</span>
                <span class="n">should</span> <span class="n">contain_file</span><span class="p">(</span><span class="s1">&#39;nginx.conf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">with_content</span><span class="p">(</span><span class="sr">/</span><span class="si">#{</span><span class="n">expect_line</span><span class="si">}</span><span class="sr">/</span><span class="p">)</span>
            <span class="k">end</span>
        <span class="k">end</span>
        <span class="n">context</span> <span class="s1">&#39;upstream&#39;</span> <span class="k">do</span>
            <span class="n">expect_line</span> <span class="o">=</span> <span class="s1">&#39;192.168.1.2:80;&#39;</span>
            <span class="n">it</span> <span class="k">do</span>
                <span class="n">should</span> <span class="n">contain_file</span><span class="p">(</span><span class="s1">&#39;upstream.conf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">with_content</span><span class="p">(</span><span class="sr">/</span><span class="si">#{</span><span class="n">expect_line</span><span class="si">}</span><span class="sr">/</span><span class="p">)</span>
            <span class="k">end</span>
        <span class="k">end</span>
        <span class="n">context</span> <span class="s1">&#39;conf.d&#39;</span> <span class="k">do</span>
            <span class="n">it</span> <span class="k">do</span>
                <span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;/etc/puppet/modules/nginx/files/conf.d&#39;</span>
                <span class="c1"># eq 是 rspec 本身的方法</span>
                <span class="no">Dir</span><span class="o">.</span><span class="n">entries</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
            <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>
</code></pre></div>
<p>然后你就可以运行测试了：</p>
<div class="highlight"><pre><code class="bash">    <span class="nb">cd</span> /etc/puppet/modules/nginx
    rake spec
</code></pre></div>
<p>如果测试用例有失败，会在终端看到错误信息。</p>
<p>注意到，rspec 是以 <code>do ... end</code> 来计算 examples 个数的。在一个 <code>do ... end</code> 里写多个 should 或者 expect，也算一个 example。</p>
      <a href="/2013/01/10/rspec-puppet-intro" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/01/06/limit-bandwidth-of-one-process" title="限制单个进程的带宽" rel="bookmark">限制单个进程的带宽</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-01-06 00:00:00 +0800">06 Jan 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>限制带宽简直就是系统管理员的永恒话题之一。当然我这里就不讨论端口限速什么的了，百度一下一大把。但如果要的是限制某个特定进程的带宽，事情就有趣多了。</p>
<h1 id="iptables">iptables</h1>
<p>大多数文档还是提供的传统思路，用 <code>iptables</code> 的 <code>owner</code> 模块，给 <code>--pid-owner</code> 加上 <code>MARK</code>，然后 <code>tc</code> 里针对这个 MARK 做限速。用法和限制如 <a href="http://lists.netisland.net/archives/plug/plug-2004-09/msg00454.html">http://lists.netisland.net/archives/plug/plug-2004-09/msg00454.html</a> 说的这样。不过和这个快十年前的文章相比，现在的服务器上，基本已经普及了 SMP ，更进一步的，内核已经在自动发现支持 SMP 的时候，在 iptables 里把 owner 模块的 pid/cmd/sid 三个 match 都去掉了！现在的 owner 里只有 uid/gid 两个。所以这条路，在生产环境上基本行不通。</p>
<p>在 <a href="http://unix.stackexchange.com/questions/34116/how-can-i-limit-the-bandwidth-used-by-a-process">stackexchange</a> 上，大家集思广益、献策献宝，又提出了另外两个工具，那个叫 <code>pipeviewer</code> 的应用场景比较特定(楼主问题是发生在 sshfs 上)，就不多说了。剩下这个 <code>trickle</code> 真是小众利器。值得一提：</p>
<h1 id="trickle">trickle</h1>
<p>官方主页：<a href="http://monkey.org/~marius/pages/?page=trickle">http://monkey.org/~marius/pages/?page=trickle</a></p>
<p>这是一个在 BSD 上诞生的项目，官网上说只在 i386 的 linux 验证过。不过我在 x86_64 的 linux 替大家尝试了一把，没有问题~</p>
<div class="highlight"><pre><code class="bash">    yum install libevent-devel
    wget http://monkey.org/~marius/trickle/trickle-1.06.tar.gz
    tar zvxf trickle-1.06.tar.gz
    <span class="nb">cd </span>trickle-1.06
    ./configure
    <span class="c"># 生成的 config.h 里重复定义了 in_addr_t 结构体</span>
    <span class="c"># 跟 include 的 /usr/include/netinet/in.h 里冲突</span>
    <span class="c"># 会报错 &quot;error: two or more data types in declaration specifiers&quot;</span>
    sed -i <span class="s1">&#39;s!\(#define in_addr_t\)!//\1!&#39;</span> config.h
    make
    make install
</code></pre></div>
<p>命令使用非常简单：</p>
<div class="highlight"><pre><code class="bash">    trickle -s -d 100 wget http://domain/path/to/file.suffix -O /dev/null
</code></pre></div>
<ul>
  <li>-s 表示独立运行，因为 trickle 还有一个 trickled 管理端可以用；</li>
  <li>-d 表示下载方向；</li>
  <li>-u 表示上传方向，两个的单位都是KB/s。</li>
</ul>
<p>这个工具使用了 ELF 的 preloader 机制，在命令执行的时候替换掉标准库中的 socket recv() 和 send() 部分，达到限速的效果。其原理图在<a href="http://monkey.org/~marius/trickle/trickle.pdf">官方PDF</a> 中，如下：</p>
<p><img src="/images/uploads/trickle.png" alt="" /></p>
<p><strong>不过总监大人及时提示我们： 由于该机制的限制，此工具对静态编译的程序无效，对采用 suid 的程序无效！</strong></p>
<h1 id="cgroup">cgroup</h1>
<p>排除上面两个无效，其实 trickle 依然无法覆盖全部应用场景 —— 比如说已经启动的后台进程长期运行，我有 pid ，但是不想中断掉重新起来；或者说这个进程可能我想让他白天跑 10MBps 晚上跑 40MBps 这样动态的。</p>
<p>这个时候就需要动用一些高级工具了，欢迎 <code>CGROUP</code> 上场。</p>
<p><code>cgroup</code> 有 <code>net_cls</code> 控制器。不过和其他控制器不太一样的是它不直接控制网络读写，只是给网络包打上一个标记，然后把专业的事情交给专业的 TC 去做。嗯，思路和原先的 iptable 是很类似的。</p>
<p>参考文档很少，感觉大家使用 cgroup 都集中在 cpu 和 blkio 方面了。目前所见只有 <a href="https://access.redhat.com/knowledge/articles/215353">redhat</a> 这个 pdf：<a href="http://vger.kernel.org/netconf2009_slides/Network%20Control%20Group%20Whitepaper.odt">http://vger.kernel.org/netconf2009_slides/Network%20Control%20Group%20Whitepaper.odt</a> 。实施步骤如下：</p>
<h2 id="tc">启用 tc</h2>
<div class="highlight"><pre><code class="bash">    tc qdisc del dev eth0 root
    tc qdisc add dev eth0 root handle 1: htb
    tc class add dev eth0 parent 1: classid 1: htb rate 1000mbit ceil 1000mbit
    tc class add dev eth0 parent 1: classid 1:3 htb rate 10mbit 
    tc class add dev eth0 parent 1: classid 1:4 htb rate 10kbit
    tc filter add dev eth0 protocol ip parent 1:0 prio 1 handle 1: cgroup
</code></pre></div>
<h2 id="cgroup-1">配置 cgroup</h2>
<div class="highlight"><pre><code class="bash">    <span class="c"># 命令行使用</span>
    mount -t cgroup net_cls -o net_cls /cgroup/net_cls/
    <span class="nb">cd</span> !<span class="err">$</span>
    cgcreate -g net_cls:test
    <span class="nb">echo</span> <span class="s1">&#39;0x10004&#39;</span> &gt; /cgroup/net_cls/test/net_cls.classid 
    <span class="c"># 然后可以导出成文件之后通过工具管理</span>
    yum install -y libcgroup
    cgsnapshot -s &gt; /etc/cgconfig.conf
    /etc/init.d/cgconfig restart
</code></pre></div>
<h2 id="cgroup-">测试 cgroup 效果</h2>
<div class="highlight"><pre><code class="bash">    <span class="nb">time </span>scp bigfile root@192.168.0.26:/tmp/
    <span class="nb">time </span>cgexec -g net_cls:test scp bigfile root@192.168.0.26:/tmp/
    <span class="nb">echo</span> <span class="nv">$$</span> &gt; /cgroup/net_cls/test/tasks
    tc class change dev eth0 parent 1: classid 1:4 htb rate 1mbit
    <span class="nb">time </span>scp bigfile root@192.168.0.26:/tmp/
</code></pre></div>
<p>可以看到后两次的速度比第一次慢很多。</p>
<p>第三次也被限制住，是因为 cgroup 会自动把子进程的 pid 也加入 tasks 里。</p>
<h1 id="section">总结及其它</h1>
<ul>
  <li>trickle 在 download 的时候限制非常管用，在 upload 的时候大概起始速度会比限制值高几倍，然后以 100KB/s 的速度往下减。感觉是 smooth 的问题，不过调整相关参数也没见到区别。</li>
  <li>cgroup 给 tc 打标签的办法，看到 tc 限制下的速度波动比较大，猜测 tc 应该是类似 10 秒钟统计一次平均值是否超过限制这样的行为？</li>
</ul>
      <a href="/2013/01/06/limit-bandwidth-of-one-process" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/30/report-of-this-year" title="2012 年个人总结" rel="bookmark">2012 年个人总结</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-30 00:00:00 +0800">30 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>2012 年还剩下最后 30 个小时。总结一下这一年。</p>
<p>4 月是本年度最重要的一个月，在这个月换工作到了人人，告别了之前八个月乱七八糟的工作状态，再不换，人就要被玩残了。感谢<a href="http://weibo.com/u/1653644220">@懒桃儿吃桃儿</a>的飞速决断。作为自我激励，在换工作的那个周末去搞定了人生大事（好吧，其实压根不是啥激励，应该叫水到渠成）……</p>
<p>9 月是另一个关键点，入职的第一个季度总结，确认自己虽然荒废了八个月，但还没掉队。既然安心自己不至于失业，也就顺带去转职了房奴。</p>
<p>技术博客上还是说点技术点的。</p>
<h1 id="logstash--elasticsearch-">第一、大半年的事情在和 <code>logstash</code> + <code>ElasticSearch</code> 系统打交道。</h1>
<p>这个偶然在 oschina 上看到的项目，已经成为我心目中 <code>splunk</code> 的最佳开源替代品。从 5 月动手测试，到现在为止，写过 2 个相关的 ppt，做过 1 次技术分享，发了 8 篇相关原创博客文章，翻译了 2 篇官网文章，在微博和 QQ 上和大概 10 个左右的朋友交流了搭建、优化的心得。考虑是不是搞个地方存一下这些交流。前几天看 <code>CloudFoundry</code> 里都有专门的 <code>ElasticSearch</code> 组件。相信云时代这个穷人版 <code>splunk</code> 可以走得更远 —— 嗯，不会写 java 用 <code>hadoop</code> 的运维真的都可以试试。</p>
<h1 id="perl-">第二、Perl 相关。</h1>
<p>本年度关于 <code>Perl</code> 最多的运用是 <code>Dancer</code> web开发框架。在 dancer 和 twitter bootstrap 的帮助下做的内部运维工具网站看起来还有那么点意思。使用过程中学会用 IRC 工具和社区进行交流，提供了一个 plugin-upload-progress 的想法，发了两个 patch ，一个给 plugin-flashmessage 同时支持使用 <code>coderef</code> 的 TT2 和 <code>object</code> 的 Text::Xslate 模版，一个给 plugin-auth-extensible 的角色认证加上正则匹配的特性。虽然扶凯已经全面转向使用 <code>Mojolicious</code> 框架了，不过我依然喜欢 dancer 这种广泛使用关键字的方式 —— 少写好多 <code>$self-&gt;</code> 或者 <code>app-&gt;</code> 呢~ 另一个记忆深刻的是某天有人热心的上来说：“我们要多写博客宣传 Dancer 在云计算的运用”，被作者喷还不如给我多写两个插件……</p>
<p>然后是 <code>Message::Passing</code> 框架，这是 <code>logstash</code> 项目的 perl port。不过个人纯属好玩和不服气，看完代码当作学习 perl 的 Moo 对象系统了。值得一提是虽然没线上用，倒是找了个周末写了两个模块 <code>Message::Passing::Filter::Regexp</code> 和 <code>Message::Passing::Output::PocketIO</code> 上传到 CPAN 了。总算不是光拿不贡献的 perler 了。然后发现 <code>Test::More</code> 真的蛮不错的，写第二个模块的时候基本就是先写好 test 再写 lib 了，据说这叫 TDD ？</p>
<p>然后是 <code>Rex</code> 项目，这是一个类似 <code>func</code> 和 <code>capistrano</code> 的项目。这类项目和 <code>puppet</code>、<code>chef</code>、<code>cfengine</code> 和 <code>lcfg</code> 的区别，我觉得是运行目的。cf 系要求的是保持 agent 的配置一致，而 rex 等的目的是给同类目的执行同类任务。这个区别在 2008 年的 sysadmin 里就已经解释过，不过似乎很多人一直在重复问~ 因为 perl 目前还没有像 ruby 的 rakefile 这样流行的任务清单控制(其实有个日本人写的pake，不过在日本人的诸多 modern perl 项目里，我觉得这个 clone 的不咋地)，所以我现在都用 Rexfile 来做 task 了，也算一种用法。顺带给只能用 <code>Net::SSH2</code> 的 Rex 提交了 <code>Net::OpenSSH</code> 驱动，不过作者很负责任的说要等自己搞出来一套 KerberOS5 认证环境测试我的 pull request 是否能运行后才 merge …… 国内还有哪里用 krb5 认证滴？</p>
<p>最后是 <code>SmokePing</code> 项目。说实话真没想到这么有名的监控项目代码乱成这个样子。好几次涌现出改写整个项目的疯狂念头，不过看看时间表，想想 rrd 那部分代码看不太懂，放弃了。只好在边边角角上做点修改 —— 顺带再次证明，在 web 开发方面，perl 不是输给了 php/python/ruby ，而是不会 css/js 的 perler 输给了那些会 css/js 的phper/pythoner/rubyer……</p>
<p>附带提一下 <code>nginx_perl</code> 项目，这个和 <code>nginx_lua</code> 一样的全流程非阻塞式的东东，最终我还是没找到机会真正用上，白瞎偶去年底很开心的给它写 ppt 推介了。大抵还用 perl 的同学觉得用 <code>Nginx</code> 内置的阻塞式的 perl 已经够用了？</p>
<h1 id="section">第三、运维、测试</h1>
<p>要感谢人人这个平台，日常运维之余完成了几个测试，<code>Apache Traffic Server</code> 的因为前设条件比较多，结论不具有普遍性；<code>Nginx</code> 的万兆网络环境测试还是很有趣的 —— 嗯，虽然最后的脚本依然很难看，拿不出手见人，不过结果还是有力的。<a href="http://weibo.com/u/2266920742">@张纹华</a> ，你的框架要好好搞~</p>
<p><code>Squid</code> 从我工作以来就在折腾，看样子是要继续折腾下去。感谢 <code>systemtap</code> 工具，或许明年我在缓慢的学习 C 语言开发的同时，尽量快的搞定那两个问题吧，阿弥陀佛，哈利路亚……</p>
<p><code>puppet</code> 已经风靡全球，也确实还算好用。我从接触开始就一眼相中了 ENC 接口，不过好像问一圈没谁注意这个。大多数人直接把 hostname 规划和 puppet 连起来了。这部分到底怎样才是 best practice ，还要慢慢看了。</p>
<p><code>fpm</code> 命令行工具，又是一个 <a href="https://github.com/jordansissel">jordansissel</a> 的 ruby 项目。一般情况下的 package 生成，绝对够用，和 logstash 一样也是我有事没事就推广一下的好东东。</p>
<p><code>linux</code> 的邮件列表订阅之后迅速的被我过滤掉了，那么多邮件，你们是怎么看过来的，kernel 学习任重道远。</p>
<h1 id="section-1">第四、学习</h1>
<p>上半年，<a href="http://weibo.com/kandeng">@邓侃</a> 博士在北航的云计算公开课基本都去听了。虽然个人工作重点完全不在这方面，不过依然觉得是有所得的。顺带想起某节课后和 <a href="http://weibo.com/ovise">@R_exify</a> 在北航东门外的肯德基里推导怎么设计一个对外透明的 MySQLaaS。大概吹牛就是这样子的……</p>
<p>关于 lua，ruby，javascript，基本都是用到临头抱佛脚，不过对 ruby 和 js 都有深入学习的想法，但是我怨念已久的 C 啊，啥时侯才能学会你。不知道为什么对 python 就是没感觉。话说昨晚在微博上看到有人说看 python 的源码觉得它的 OO 和 lua 很像。顿时我就很郁闷，因为之前我看 lua 的时候觉得 lua 实现的 OO 和 Perl5 很像的好吧。尼玛大家都像来像去的，你们 Pythoner 整天鄙视 Perl 干吗……</p>
<p>关于 CloudFoundry ，关注来关注去，基本停留在看新闻的阶段，一行代码没瞄过，连一个 micro 环境都没搭建过。嗯，不过考虑到毕竟看了不少新闻，还是留一笔。</p>
<p>关于微博，有微博之后，学习成本确实降低了，因为很多问题你可以直接圈人……不过我的同学朋友们肯定对我的微博内容是“眼不见心不烦”了的。哈哈~</p>
<h1 id="section-2">总之，这是无比充实的一年。</h1>
<p>排除掉每个季度末，比如现在，对下季度工作计划的茫然外。</p>
<p>感谢自己依然充满对知识的渴望，让年终的总结显得这么充实和踏实。</p>
      <a href="/2012/12/30/report-of-this-year" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/30/how-to-install-external-binary-as-perl-modules-dependment" title="perl 模块打包加入外部依赖程序" rel="bookmark">perl 模块打包加入外部依赖程序</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-30 00:00:00 +0800">30 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Perl 社区并不是所有的东西都发布在 CPAN 上。甚至专门有一个 <code>Module::ThirdParty</code> 模块记录这些非 CPAN 的 perl 项目列表。其中最有名的应该就属写博客的 <code>Movable Type</code> 和做监控的 <code>SmokePing</code> 了。</p>
<p>但是如果个人图方便又想把 smokeping 打包方便部署使用的时候，就会发现一点小问题：打包成rpm，很多 perl 的依赖模块不一定在系统 repo 里存在；打包成 perl 的模块，smokeping 最常用的几个 probe 比如 fping、curl 什么的，又是非 perl 程序，cpanm 没法解决这个 <code>requires_external_bin</code> ，最多只能报错退出。</p>
<p>其实这里可以采取一些别的办法，虽然笨一些，但是解决问题。</p>
<p>首先还是让我们创建一个示例模块：</p>
<div class="highlight"><pre><code class="bash">    cpanm Module::Starter Module::Build
    module-starter --module Alien::FPing --author<span class="o">=</span><span class="s2">&quot;Jeff Rao&quot;</span> --email<span class="o">=</span><span class="s2">&quot;myname@gmail.com&quot;</span> --mb
</code></pre></div>
<p>然后就会在本目录下创建一个 Alien-FPing 目录，自带好了 <code>Build.PL</code> 等模块文件。这里使用了 <code>Alien::</code> 的名字空间，是一个潜规则，有些项目依赖 C 源码的库和头文件，就用 perl 包一层来安装，都放在这个空间下，比如 <code>Alien::V8</code>, <code>Alien::Gearmand</code>, <code>Alien::IE7</code> 等等。</p>
<p>现在让我们下载 fping 的源码放到模块里：</p>
<div class="highlight"><pre><code class="bash">    mkdir Alien-FPing/src
    wget http://www.fping.org/dist/fping-3.4.tar.gz -O Alien-FPing/src/fping-3.4.tar.gz
</code></pre></div>
<p>接下来应该就是编写 <code>Build.PL</code> 了。不过为了尽量让 <code>Build.PL</code> 看起来简洁而且一眼看出目的。我们最好把编译操作单独定义一个模块来使用：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="nn">Alien::FPing::</span><span class="n">Build</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">base</span> <span class="sx">qw(Module::Build)</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">File::</span><span class="n">Spec</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Archive::</span><span class="n">Tar</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$RootDir</span> <span class="o">=</span> <span class="nn">File::</span><span class="n">Spec</span><span class="o">-&gt;</span><span class="n">rel2abs</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$SrcDir</span> <span class="o">=</span> <span class="nn">File::</span><span class="n">Spec</span><span class="o">-&gt;</span><span class="n">catdir</span><span class="p">(</span><span class="nv">$RootDir</span><span class="p">,</span> <span class="s">&quot;src&quot;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$FPingVersion</span> <span class="o">=</span> <span class="s">&#39;3.4&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$FPingName</span> <span class="o">=</span> <span class="s">&quot;fping-${FPingVersion}&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$FPingSrc</span> <span class="o">=</span> <span class="s">&quot;${FPingName}.tar.gz&quot;</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">ACTION_build</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
        <span class="nb">chdir</span><span class="p">(</span><span class="nv">$SrcDir</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span>  <span class="o">!-</span><span class="n">x</span> <span class="s">&quot;/usr/sbin/fping&quot;</span> <span class="ow">and</span> <span class="o">!-</span><span class="n">d</span> <span class="nv">$FPingName</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$tar</span> <span class="o">=</span> <span class="nn">Archive::</span><span class="n">Tar</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
            <span class="nv">$tar</span><span class="o">-&gt;</span><span class="nb">read</span><span class="p">(</span><span class="nv">$FPingSrc</span><span class="p">);</span>
            <span class="nv">$tar</span><span class="o">-&gt;</span><span class="n">extract</span><span class="p">();</span>
            <span class="nb">chdir</span><span class="p">(</span><span class="nv">$FPingName</span><span class="p">);</span>
            <span class="nb">system</span><span class="p">(</span><span class="s">&#39;./configure&#39;</span><span class="p">,</span> <span class="s">&#39;--prefix=/usr/&#39;</span><span class="p">,</span> <span class="s">&#39;--enable-ipv6&#39;</span><span class="p">);</span>
            <span class="nb">system</span><span class="p">(</span><span class="s">&#39;make&#39;</span><span class="p">);</span>
            <span class="nb">system</span><span class="p">(</span><span class="s">&#39;make install&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$self</span><span class="o">-&gt;</span><span class="nn">SUPER::</span><span class="n">ACTION_build</span><span class="p">();</span>
    <span class="p">};</span>
    <span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>几乎就是调用 shell 而已，唯一需要讲一下的就是这个 <code>ACTION_build</code>。这是 <code>Module::Build</code> 定义好的提供给 <code>subclass</code> 用的方法，事实上 <code>./Build help</code> 看得到的所有 action 都有类似的方法可以用。</p>
<p>然后稍微修改一下 Build.PL 如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="mf">5.006</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">warnings</span> <span class="n">FATAL</span> <span class="o">=&gt;</span> <span class="s">&#39;all&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">lib</span> <span class="s">&#39;inc&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Alien::FPing::</span><span class="n">Build</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$builder</span> <span class="o">=</span> <span class="nn">Alien::FPing::</span><span class="n">Build</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="n">module_name</span>         <span class="o">=&gt;</span> <span class="s">&#39;Alien::FPing&#39;</span><span class="p">,</span>
        <span class="n">license</span>             <span class="o">=&gt;</span> <span class="s">&#39;perl&#39;</span><span class="p">,</span>
        <span class="n">dist_author</span>         <span class="o">=&gt;</span> <span class="sx">q{Jeff Rao &lt;myname@gmail.com&gt;}</span><span class="p">,</span>
        <span class="n">dist_version_from</span>   <span class="o">=&gt;</span> <span class="s">&#39;lib/Alien/FPing.pm&#39;</span><span class="p">,</span>
        <span class="n">release_status</span>      <span class="o">=&gt;</span> <span class="s">&#39;stable&#39;</span><span class="p">,</span>
        <span class="n">configure_requires</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&#39;Module::Build&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">build_requires</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&#39;Test::More&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">requires</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="c1">#&#39;ABC&#39;              =&gt; 1.6,</span>
            <span class="c1">#&#39;Foo::Bar::Module&#39; =&gt; 5.0401,</span>
        <span class="p">},</span>
        <span class="n">add_to_cleanup</span>     <span class="o">=&gt;</span> <span class="p">[</span> <span class="s">&#39;Alien-FPing-*&#39;</span> <span class="p">],</span>
        <span class="n">create_makefile_pl</span> <span class="o">=&gt;</span> <span class="s">&#39;traditional&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="nv">$builder</span><span class="o">-&gt;</span><span class="n">create_build_script</span><span class="p">();</span>
</code></pre></div>
<p>把 <code>Module::Build</code> 替换成 <code>Alien::FPing::Build</code> 而已，其他都不用动。</p>
<p>然后试一下吧：</p>
<div class="highlight"><pre><code class="bash">    <span class="nb">cd </span>Alien-FPing
    perl Build.PL
    ./Build
</code></pre></div>
<p>看到编译输出，并且成功安装有 <code>/usr/sbin/fping</code> 了吧。现在可以打包了。注意默认生成的 ignore.txt 里，是排除掉了 inc 目录的，需要去除掉，然后修改 <code>MANIFEST</code> 文件加入 inc 和 src 里的文件，然后再打包出来的 perl 模块就可以直接用了。</p>
<div class="highlight"><pre><code class="bash">    sed -i <span class="s1">&#39;/inc/d&#39;</span> ignore.txt
    <span class="nb">echo</span> <span class="s1">&#39;inc/Alien/FPing/Build.pm&#39;</span> &gt;&gt; MANIFEST
    <span class="nb">echo</span> <span class="s1">&#39;src/fping-3.4.tar.gz&#39;</span> &gt;&gt; MANIFEST
    ./Build dist
</code></pre></div>
      <a href="/2012/12/30/how-to-install-external-binary-as-perl-modules-dependment" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/22/simple-local-website-for-sysadmin-advent-clone" title="给 Sysadmin Advent 快速搭建本地浏览网站" rel="bookmark">给 Sysadmin Advent 快速搭建本地浏览网站</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-22 00:00:00 +0800">22 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一年一度的 advent 集合中，除了 perl 的部分，还有 sysadmin 的也很吸引我等运维的眼球。不过 sysadmin 的一直是发表在blogspot 上，光荣的被 GFW 认证了。虽然说翻墙应该是这年头越来越普及的技能，但是能提供免墙的办法，想来那真真是极好的。</p>
<p>这里提供一个私以为很不错的办法。因为我很开心的发现 sysadvent 有托管在 github 上。</p>
<div class="highlight"><pre><code class="bash">    sudo apt-get install git
    git clone git://github.com/jordansissel/sysadvent.git
    sudo wget http://xrl.us/cpanm --no-check-certificate -O /sbin/cpanm
    sudo chmod +x /sbin/cpanm
    cpanm Plack DocLife
</code></pre></div>
<p>好了，准备工作完毕。然后在 sysadvent 目录下创建 app.psgi 文件如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="nn">Plack::</span><span class="n">Builder</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Plack::App::</span><span class="n">Directory</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">DocLife::</span><span class="n">Markdown</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$html_app</span> <span class="o">=</span> <span class="nn">DocLife::</span><span class="n">Markdown</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="n">root</span> <span class="o">=&gt;</span> <span class="s">&#39;.&#39;</span><span class="p">,</span>
        <span class="n">base_url</span> <span class="o">=&gt;</span> <span class="s">&#39;/html/&#39;</span><span class="p">,</span>
        <span class="n">suffix</span> <span class="o">=&gt;</span> <span class="s">&#39;.html&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$md_app</span> <span class="o">=</span> <span class="nn">DocLife::</span><span class="n">Markdown</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="n">root</span> <span class="o">=&gt;</span> <span class="s">&#39;.&#39;</span><span class="p">,</span>
        <span class="n">suffix</span> <span class="o">=&gt;</span> <span class="s">&#39;.md&#39;</span><span class="p">,</span>
        <span class="n">base_url</span> <span class="o">=&gt;</span> <span class="s">&#39;/md/&#39;</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$dir_app</span> <span class="o">=</span> <span class="nn">Plack::App::</span><span class="n">Directory</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">({</span>
        <span class="n">root</span> <span class="o">=&gt;</span> <span class="s">&#39;.&#39;</span><span class="p">,</span>
    <span class="p">});</span>
    <span class="n">builder</span> <span class="p">{</span>
        <span class="n">mount</span> <span class="s">&#39;/md&#39;</span> <span class="o">=&gt;</span> <span class="nv">$md_app</span><span class="p">;</span>
        <span class="n">mount</span> <span class="s">&#39;/html&#39;</span> <span class="o">=&gt;</span> <span class="nv">$html_app</span><span class="p">;</span>
        <span class="n">mount</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="n">builder</span> <span class="p">{</span>
            <span class="n">enable</span> <span class="s">&quot;Plack::Middleware::SimpleContentFilter&quot;</span><span class="p">,</span>
            <span class="n">filter</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
                <span class="n">s</span><span class="c1">#(/\d{4}/\d{2}/\S+\.md)#/md\1#;</span>
                <span class="n">s</span><span class="c1">#(/\d{4}/\d{2}/\S+\.html)#/html\1#;</span>
            <span class="p">};</span>
            <span class="nv">$dir_app</span>
        <span class="p">};</span>
    <span class="p">};</span>
</code></pre></div>
<p><code>Plack::App::Directory</code> 模块是 <code>Plack</code> 自带的一个静态目录自动索引发布模块。不过他会把 markdown 当成 &ldquo;text/plain&rdquo; 发布，不好看。所以这里引入了另一个 <code>DocLife</code> 模块。他可以自动把 markdown 和 pod 格式的文档美化转换成 html 格式。本来 <code>DocLife</code> 本身也提供目录索引功能，不过他的问题是他不考虑 MIME 问题，会把 png 等图片也以 &ldquo;text/plain&rdquo; 发布。所以我们用 <code>Plack::App::URLMap</code> 把两个模块挂在到一起，然后用 <code>Plack::Middleware::SimpleContentFilter</code> 过滤内容，替换原本的目录链接成针对性的目录。</p>
<p>大功告成！运行命令开始享受世界级运维们的分享吧：</p>
<div class="highlight"><pre><code class="bash">    plackup &amp;
    open localhost:5000
</code></pre></div>
<table>
  <tbody>
    <tr>
      <td>注：另外有个 <code>Plack::App::Directory::Markdown</code> 模块，不过他写死了只处理 md，连 html 都被 <code>next</code>。比较好玩的是这个模块自己把 bootstrap.css</td>
      <td>js 给放到 <code>__DATA__</code> 块里一起分发了，页面倒是更好看一点。</td>
    </tr>
  </tbody>
</table>
      <a href="/2012/12/22/simple-local-website-for-sysadmin-advent-clone" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/22/intro-dancer-plugin-adapter" title="Dancer::Plugin::Adapter 模块介绍" rel="bookmark">Dancer::Plugin::Adapter 模块介绍</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-22 00:00:00 +0800">22 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Dancer 活跃的社区和强大又方便的插件开发导致出现了太多好玩的插件，有位新同学在刚上手的这两周内就已经往 CPAN 提交了四个插件了。</p>
<p>今天这里介绍一个刚在 IRC 上被推荐的东东，额，这个插件的作者跟上面提到的同学说：大哥，看看偶这个模块吧，就不用你这么辛苦的啥都写新插件了。</p>
<p><a href="https://metacpan.org/module/Dancer::Plugin::Adapter">Dancer::Plugin::Adapter</a> 模块的作用，就是当你的项目需要在多处使用某个模块的时候，不用频繁的到处去new，直接在 config.yml 里一定义，它会自动给你实例化成 <code>Dancer::Object</code>，然后缓存住，你就可以直接用 service 关键词调用了。</p>
<p>用法示例：</p>
<div class="highlight"><pre><code class="perl">    <span class="c1"># in config.yml</span>
    <span class="n">plugins:</span>
      <span class="n">Adapter:</span>
        <span class="n">ua:</span>
          <span class="n">class:</span> <span class="nn">HTTP::</span><span class="n">Tiny</span>
          <span class="n">options:</span>
            <span class="n">max_redirect:</span> <span class="mi">3</span>
        <span class="n">postmark:</span>
          <span class="n">class:</span> <span class="nn">WWW::</span><span class="n">Postmark</span>
          <span class="n">options:</span> <span class="n">POSTMARK_API_TEST</span>
    <span class="c1"># in your app</span>
    <span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">Adapter</span><span class="p">;</span>
    <span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
      <span class="nb">eval</span> <span class="p">{</span>
        <span class="n">service</span><span class="p">(</span><span class="s">&quot;postmark&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span>
          <span class="n">from</span>    <span class="o">=&gt;</span> <span class="s">&#39;me@domain.tld&#39;</span><span class="p">,</span>
          <span class="n">to</span>      <span class="o">=&gt;</span> <span class="s">&#39;you@domain.tld, them@domain.tld&#39;</span><span class="p">,</span>
          <span class="n">subject</span> <span class="o">=&gt;</span> <span class="s">&#39;an email message&#39;</span><span class="p">,</span>
          <span class="n">body</span>    <span class="o">=&gt;</span> <span class="s">&quot;hi guys, what&#39;s up?&quot;</span>
        <span class="p">);</span>
      <span class="p">};</span>
      <span class="k">return</span> <span class="vg">$@</span> <span class="p">?</span> <span class="s">&quot;Error: $@&quot;</span> <span class="p">:</span> <span class="s">&quot;Mail sent&quot;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">get</span> <span class="s">&#39;/proxy/:url&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
      <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="n">service</span><span class="p">(</span><span class="s">&#39;ua&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;url&#39;</span><span class="p">}</span> <span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">success</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">content</span><span class="p">};</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="n">template</span> <span class="s">&#39;error&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">response</span> <span class="o">=&gt;</span> <span class="nv">$res</span> <span class="p">};</span>
      <span class="p">}</span>
    <span class="p">};</span>
</code></pre></div>
<p>话说我还是喜欢上代码，不喜欢完整的翻译 POD 啊…………</p>
      <a href="/2012/12/22/intro-dancer-plugin-adapter" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/22/elasticsearch-amcharts-demo" title="用 Amcharts 和 ElasticSearch 做日志分析" rel="bookmark">用 Amcharts 和 ElasticSearch 做日志分析</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-22 00:00:00 +0800">22 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前有一篇从 ElasticSearch 官网摘下来的博客<a href="http://chenlinux.com/2012/11/18/data-visualization-with-elasticsearch-and-protovis">《【翻译】用ElasticSearch和Protovis实现数据可视化》</a>。不过一来 Protovis 已经过时，二来 不管是 Protovis 的进化品 D3 还是 Highchart 什么的，我觉得在多图方面都还不如 amcharts 好用。所以在最后依然选择了老牌的 amcharts 完成。</p>
<p>展示品的大概背景还是 webserver 日志，嗯，这个需求应该是最有代表性的了。我们需要对webserver的性能有所了解。之前有一篇文章<a href="http://chenlinux.com/2012/11/22/tatsumaki-demo/">《Tatsumaki框架的小demo一个》</a>，讲的是通过 <code>terms_stats</code> 获取固定时段内请求时间的平均值。其实这个demo是可以参照官网博客修改成纯js应用的。因为 Tatsumaki 在这里除了处理 HTTP 请求参数，什么都没干。而且这个demo目的是展示 perl 框架的处理，所以amchart方面直接就写死了各种变量。</p>
<p>但是还有一种需求，比如你需要的是针对某个情况超过某个百分比的分时走势统计。这时候必须多次请求 ES 来做运算，再让 js 做，不是说不行，但是多一倍数据在网络中传输，就不如在服务器端封装 API 了 —— 其实是我 js 太烂这种事情，我会告诉你们么。。。</p>
<p>先上两张效果图，其实这个布局我是从 facetgrapher 项目偷来的，但这个项目只适合比较不同 index 之间同时间段的数据，我建议作者修改，作者说&rdquo;我自己js也是半吊子水平&rdquo;。。。</p>
<p><img src="/images/uploads/amchart-column.png" alt="分地区错误情况统计" title="分地区错误情况统计" /></p>
<p><img src="/images/uploads/amchart-line.png" alt="实时分运营商错误比例统计" title="实时分运营商错误比例统计" /></p>
<p><strong>2013 年 2 月 21 日更新：利用 bullet 大小来表示 hasErr 的程度</strong></p>
<p>查询的 ES 库情况如下：</p>
<div class="highlight"><pre><code class="bash">    <span class="nv">$ </span>curl <span class="s2">&quot;http://10.4.16.68:9200/demo-photo/log/_mapping?pretty=1&quot;</span>
    <span class="o">{</span>
      <span class="s2">&quot;log&quot;</span> : <span class="o">{</span>
        <span class="s2">&quot;properties&quot;</span> : <span class="o">{</span>
          <span class="s2">&quot;brower&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;date&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;date&quot;</span>,
            <span class="s2">&quot;format&quot;</span> : <span class="s2">&quot;dateOptionalTime&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;fromArea&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>,
            <span class="s2">&quot;index&quot;</span> : <span class="s2">&quot;not_analyzed&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;hasErr&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;requestUrl&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>,
            <span class="s2">&quot;index&quot;</span> : <span class="s2">&quot;not_analyzed&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;timeCost&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;long&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;userId&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>
          <span class="o">}</span>,
          <span class="s2">&quot;xnforword&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;string&quot;</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="nv">$ </span>curl <span class="s2">&quot;http://10.4.16.68:9200/demo-photo/log/_search?pretty=1&amp;size=1&quot;</span> -d <span class="s1">&#39;{&quot;query&quot;:{&quot;match_all&quot;:{}}}&#39;</span>
    <span class="o">{</span>
      <span class="s2">&quot;took&quot;</span> : 14,
      <span class="s2">&quot;timed_out&quot;</span> : <span class="nb">false</span>,
      <span class="s2">&quot;_shards&quot;</span> : <span class="o">{</span>
        <span class="s2">&quot;total&quot;</span> : 10,
        <span class="s2">&quot;successful&quot;</span> : 10,
        <span class="s2">&quot;failed&quot;</span> : 0
      <span class="o">}</span>,
      <span class="s2">&quot;hits&quot;</span> : <span class="o">{</span>
        <span class="s2">&quot;total&quot;</span> : 2330679,
        <span class="s2">&quot;max_score&quot;</span> : 1.0,
        <span class="s2">&quot;hits&quot;</span> : <span class="o">[</span> <span class="o">{</span>
          <span class="s2">&quot;_index&quot;</span> : <span class="s2">&quot;demo-photo&quot;</span>,
          <span class="s2">&quot;_type&quot;</span> : <span class="s2">&quot;log&quot;</span>,
          <span class="s2">&quot;_id&quot;</span> : <span class="s2">&quot;iSI5xic7Qg2p9Sqk5yp-pQ&quot;</span>,
          <span class="s2">&quot;_score&quot;</span> : 1.0, <span class="s2">&quot;_source&quot;</span> : <span class="o">{</span><span class="s2">&quot;hasErr&quot;</span>:<span class="s2">&quot;false&quot;</span>,<span class="s2">&quot;date&quot;</span>:<span class="s2">&quot;2012-12-06T15:04:21,983&quot;</span>,<span class="s2">&quot;userId&quot;</span>:<span class="s2">&quot;123456789&quot;</span>,<span class="s2">&quot;requestUrl&quot;</span>:<span class="s2">&quot;http://photo.demo.domain.com/path/to/your/app/test.jpg&quot;</span>,<span class="s2">&quot;brower&quot;</span>:<span class="s2">&quot;chrome17.0.963.84&quot;</span>,<span class="s2">&quot;timeCost&quot;</span>:750,<span class="s2">&quot;xnforword&quot;</span>:<span class="o">[</span><span class="s2">&quot;192.168.1.123&quot;</span>,<span class="s2">&quot;10.10.10.10&quot;</span><span class="o">]</span>,<span class="s2">&quot;fromArea&quot;</span>:<span class="s2">&quot;CN-UNI-OTHER&quot;</span><span class="o">}</span>
        <span class="o">}</span> <span class="o">]</span>
      <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div>
<p>然后后台是我惯用的 Dancer 框架：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="n">AnalysisDemo</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">Ajax</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">ElasticSearch</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(strftime)</span><span class="p">;</span>
    <span class="nb">no</span>  <span class="n">warnings</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$elsearch</span>         <span class="o">=</span> <span class="n">ElasticSearch</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="p">{</span> <span class="nv">%</span><span class="p">{</span> <span class="n">config</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">plugins</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ElasticSearch</span><span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$index_prefix</span>     <span class="o">=</span> <span class="s">&#39;demo-&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$type</span>             <span class="o">=</span> <span class="s">&#39;log&#39;</span><span class="p">;</span>
    <span class="c1"># 这里是对ip库的归类。数据是需要提前导入ES的，这可以是logstash发挥作用</span>
    <span class="k">my</span> <span class="nv">$default_provider</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">yidong</span>    <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(CN-CRN CN-CMN)</span><span class="p">],</span>
        <span class="n">jiaoyu</span>    <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(CN-CER CN-CST)</span><span class="p">],</span>
        <span class="n">dianxin</span>   <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(CN-CHN)</span><span class="p">],</span>
        <span class="n">liantong</span>  <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(CN-UNI CN-CNC)</span><span class="p">],</span>
        <span class="n">guangdian</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(CN-SCN)</span><span class="p">],</span>
        <span class="n">haiwai</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(OS)</span><span class="p">],</span>
    <span class="p">};</span>
    <span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="c1"># 通过 state API 获取 ES 集群现有的所有index列表</span>
        <span class="c1"># 因为是一个域名一个index，这样就有了前段页面上的域名下拉选择框</span>
        <span class="k">my</span> <span class="nv">$indices</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">cluster_state</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">routing_table</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">indices</span><span class="p">};</span>
        <span class="n">template</span> <span class="s">&#39;demo/chart&#39;</span><span class="p">,</span>
          <span class="p">{</span>
            <span class="n">providers</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%$default_provider</span> <span class="p">],</span>
            <span class="n">datasources</span> <span class="o">=&gt;</span>
              <span class="p">[</span> <span class="nb">grep</span> <span class="p">{</span> <span class="sr">/^$index_prefix/</span> <span class="o">&amp;&amp;</span> <span class="sr">s/$index_prefix//</span> <span class="p">}</span> <span class="nb">keys</span> <span class="nv">%$indices</span> <span class="p">],</span>
            <span class="n">inputfrom</span> <span class="o">=&gt;</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%F\T%T&quot;</span><span class="p">,</span> <span class="nb">localtime</span><span class="p">(</span><span class="nb">time</span><span class="p">()</span><span class="o">-</span><span class="mi">864000</span><span class="p">)),</span>
            <span class="n">inputto</span> <span class="o">=&gt;</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%F\T%T&quot;</span><span class="p">,</span> <span class="nb">localtime</span><span class="p">()),</span>
          <span class="p">};</span>
    <span class="p">};</span>
    <span class="c1"># 这里把 api 拆成服务商和区域两个，没啥特殊原因，因为是分两回写的，汗</span>
    <span class="c1"># 其实可以看到最开始的请求参数类似，最后json的field名字都一样</span>
    <span class="n">ajax</span> <span class="s">&#39;/api/provider&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">$param</span> <span class="o">=</span> <span class="n">from_json</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$index</span> <span class="o">=</span> <span class="nv">$index_prefix</span> <span class="o">.</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;datasource&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$from</span>  <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;from&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;now-10d&#39;</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$to</span>    <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;to&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;now&#39;</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$providers</span> <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;provider&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$pct</span><span class="p">,</span> <span class="nv">$chartData</span> <span class="p">);</span>
        <span class="k">for</span> <span class="k">my</span> <span class="nv">$provider</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$providers</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$provider_pct</span><span class="p">;</span>
            <span class="c1"># 这里是比较麻烦的一点，因为一个区域在ip库里可能标记成多个，比如铁通和移动，现在都是移动</span>
            <span class="k">for</span> <span class="k">my</span> <span class="nv">$area</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$default_provider</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$provider</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="n">pct_count</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
                <span class="k">for</span> <span class="k">my</span> <span class="nv">$time</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$res</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
                    <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">error</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">error</span><span class="p">};</span>
                    <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">slow</span><span class="p">}</span>  <span class="o">+=</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">slow</span><span class="p">};</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c1"># 这里因为可能没有错误，所以前面关闭了常用的 warnings 警告</span>
            <span class="k">for</span> <span class="k">my</span> <span class="nv">$time</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$provider_pct</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">my</span> <span class="nv">$right_pct</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
                <span class="nv">$right_pct</span> <span class="o">=</span>
                  <span class="mi">100</span> <span class="o">-</span>
                  <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">slow</span><span class="p">}</span> <span class="o">/</span> <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">}</span>
                  <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
                <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$provider</span><span class="p">}</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%.2f&quot;</span><span class="p">,</span> <span class="nv">$right_pct</span><span class="p">;</span>
                <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Err&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%.2f&quot;</span><span class="p">,</span>
                  <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">error</span><span class="p">}</span> <span class="o">/</span> <span class="nv">$provider_pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">}</span>
                  <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
                <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Size&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%.0f&quot;</span><span class="p">,</span>
                  <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Err&quot;</span><span class="p">};</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">for</span> <span class="k">my</span> <span class="nv">$time</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%$pct</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">date</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$time</span><span class="p">;</span>
            <span class="k">for</span> <span class="k">my</span> <span class="nv">$provider</span> <span class="p">(</span> <span class="nv">@$providers</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$provider</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$provider</span><span class="p">}</span> <span class="o">||</span> <span class="mi">100</span><span class="p">;</span>
                <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Err&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Err&quot;</span><span class="p">}</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
                <span class="c1"># 百分比太低，所以翻 5 倍来作为 bullet 的大小</span>
                <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Size&quot;</span><span class="p">}</span> <span class="o">=</span>
                  <span class="nv">$pct</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$time</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;${provider}Size&quot;</span><span class="p">}</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">};</span>
            <span class="nb">push</span> <span class="nv">@$chartData</span><span class="p">,</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">type</span> <span class="o">=&gt;</span> <span class="s">&quot;line&quot;</span><span class="p">,</span>
            <span class="n">categoryField</span> <span class="o">=&gt;</span> <span class="s">&quot;date&quot;</span><span class="p">,</span>
            <span class="n">graphList</span> <span class="o">=&gt;</span> <span class="nv">$providers</span><span class="p">,</span>
            <span class="n">chartData</span> <span class="o">=&gt;</span> <span class="nv">$chartData</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="n">to_json</span><span class="p">(</span><span class="nv">$res</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="n">ajax</span> <span class="s">&#39;/api/area&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">$param</span> <span class="o">=</span> <span class="n">from_json</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$index</span> <span class="o">=</span> <span class="nv">$index_prefix</span> <span class="o">.</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;datasource&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$limit</span> <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;limit&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="mi">50</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$from</span>  <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;from&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;now-10d&#39;</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$to</span>    <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;to&#39;</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;now&#39;</span><span class="p">;</span>
        <span class="c1"># 这是后来写的，尽可能把 sub 拆分了，所以 ajax 这里就很简略</span>
        <span class="c1"># 当然因为不考虑多运营商的问题，本身也容易一些</span>
        <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="n">pct_terms</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">return</span> <span class="n">to_json</span><span class="p">(</span><span class="nv">$res</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">sub </span><span class="nf">pct_terms</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$area_all_count</span> <span class="o">=</span> <span class="n">area_terms</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>    <span class="nv">$limit</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$area_err_count</span> <span class="o">=</span> <span class="n">area_terms</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$error</span><span class="p">,</span> <span class="nv">$chartData</span> <span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$area_err_count</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$error</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">}</span> <span class="p">}</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$area_all_count</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nb">push</span> <span class="nv">@$chartData</span><span class="p">,</span> <span class="p">{</span>
                <span class="n">area</span>  <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">},</span>
                <span class="n">error</span> <span class="o">=&gt;</span> <span class="nv">$error</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">}</span> <span class="p">}</span> <span class="o">||</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">right</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">}</span> <span class="o">-</span> <span class="nv">$error</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">}</span> <span class="p">},</span>
            <span class="p">};</span>
        <span class="p">}</span>
        <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">type</span> <span class="o">=&gt;</span> <span class="s">&quot;column&quot;</span><span class="p">,</span>
            <span class="n">categoryField</span> <span class="o">=&gt;</span> <span class="s">&quot;area&quot;</span><span class="p">,</span>
            <span class="n">graphList</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw(right error)</span><span class="p">],</span>
            <span class="n">chartData</span> <span class="o">=&gt;</span> <span class="nv">$chartData</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="nv">$res</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">sub </span><span class="nf">pct_count</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$level</span> <span class="o">=</span> <span class="nv">$area</span> <span class="ow">eq</span> <span class="s">&#39;OS&#39;</span> <span class="p">?</span> <span class="mi">3000</span> <span class="p">:</span> <span class="mi">2000</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$all_count</span>  <span class="o">=</span> <span class="n">histo_count</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>      <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$slow_count</span> <span class="o">=</span> <span class="n">histo_count</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$level</span><span class="p">,</span>   <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$err_count</span>  <span class="o">=</span> <span class="n">histo_count</span><span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="s">&#39;hasErr&#39;</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$res</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$slow_count</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="nb">time</span><span class="p">}</span> <span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">slow</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$err_count</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="nb">time</span><span class="p">}</span> <span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">error</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$all_count</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="nb">time</span><span class="p">}</span> <span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$res</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1"># 下面开始的两个才是真正发 ES 请求的地方</span>
    <span class="k">sub </span><span class="nf">area_terms</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$level</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
            <span class="nb">index</span>  <span class="o">=&gt;</span> <span class="nv">$index</span><span class="p">,</span>
            <span class="n">type</span>   <span class="o">=&gt;</span> <span class="nv">$type</span><span class="p">,</span>
            <span class="n">size</span>   <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">facets</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">area</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">facet_filter</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="ow">and</span> <span class="o">=&gt;</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="n">range</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                    <span class="n">date</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                        <span class="n">from</span> <span class="o">=&gt;</span> <span class="nv">$from</span><span class="p">,</span>
                                        <span class="n">to</span>   <span class="o">=&gt;</span> <span class="nv">$to</span>
                                    <span class="p">},</span>
                                <span class="p">},</span>
                            <span class="p">},</span>
                            <span class="p">{</span>
                                <span class="n">numeric_range</span> <span class="o">=&gt;</span>
                                  <span class="p">{</span> <span class="n">timeCost</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">gte</span> <span class="o">=&gt;</span> <span class="nv">$level</span><span class="p">,</span> <span class="p">},</span> <span class="p">},</span>
                            <span class="p">},</span>
                        <span class="p">],</span>
                    <span class="p">},</span>
                    <span class="c1"># 使用最简单的 terms facets API，因为只用计数就好了</span>
                    <span class="n">terms</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="n">field</span> <span class="o">=&gt;</span> <span class="s">&quot;fromArea&quot;</span><span class="p">,</span>
                        <span class="n">size</span>  <span class="o">=&gt;</span> <span class="nv">$limit</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">);</span>
        <span class="k">return</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">facets</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">area</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">terms</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="k">sub </span><span class="nf">histo_count</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$level</span><span class="p">,</span> <span class="nv">$area</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="c1"># 根据 level 参数判断使用 hasErr 还是 timeCost 列数据</span>
        <span class="k">my</span> <span class="nv">$level_ref</span> <span class="o">=</span>
          <span class="nv">$level</span> <span class="ow">eq</span> <span class="s">&#39;hasErr&#39;</span>
          <span class="p">?</span> <span class="p">{</span> <span class="n">term</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">hasErr</span> <span class="o">=&gt;</span> <span class="s">&#39;true&#39;</span> <span class="p">}</span> <span class="p">}</span>
          <span class="p">:</span> <span class="p">{</span> <span class="n">numeric_range</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">timeCost</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ow">gt</span> <span class="o">=&gt;</span> <span class="nv">$level</span> <span class="p">}</span> <span class="p">}</span> <span class="p">};</span>
        <span class="k">my</span> <span class="nv">$facets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">pct</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">facet_filter</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="c1"># 这里条件比较多，所以要用 bool API，不能用 and 了</span>
                    <span class="n">bool</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="c1"># must 可以提供多个条件作为 AND 数组</span>
                        <span class="c1"># 此外还有 must_not 作为 AND NOT 数组</span>
                        <span class="c1"># should 作为 OR 数组</span>
                        <span class="n">must</span> <span class="o">=&gt;</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="n">range</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                    <span class="n">date</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                        <span class="n">from</span> <span class="o">=&gt;</span> <span class="nv">$from</span><span class="p">,</span>
                                        <span class="n">to</span>   <span class="o">=&gt;</span> <span class="nv">$to</span>
                                    <span class="p">},</span>
                                <span class="p">},</span>
                            <span class="p">},</span>
                            <span class="p">{</span> <span class="n">prefix</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">fromArea</span> <span class="o">=&gt;</span> <span class="nv">$area</span> <span class="p">}</span> <span class="p">},</span>
                            <span class="nv">$level_ref</span><span class="p">,</span>
                        <span class="p">],</span>
                    <span class="p">},</span>
                <span class="p">},</span>
                <span class="c1"># 这里是需要针对专门的时间列做汇总，所以用 date_histogram 了，具体说明之前有博客</span>
                <span class="n">date_histogram</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">field</span>    <span class="o">=&gt;</span> <span class="s">&quot;date&quot;</span><span class="p">,</span>
                    <span class="n">interval</span> <span class="o">=&gt;</span> <span class="s">&quot;1h&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
            <span class="nb">index</span>  <span class="o">=&gt;</span> <span class="nv">$index</span><span class="p">,</span>
            <span class="n">type</span>   <span class="o">=&gt;</span> <span class="nv">$type</span><span class="p">,</span>
            <span class="n">facets</span> <span class="o">=&gt;</span> <span class="nv">$facets</span><span class="p">,</span>
            <span class="n">size</span>   <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="k">return</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">facets</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">pct</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">entries</span><span class="p">};</span>
    <span class="p">}</span>
</code></pre></div>
<p>其实把里面请求的hash拆开来一个个定义，然后根据情况组合，但是不方便察看作为 demo 的整体情况。</p>
<p>然后看template里怎么写。这里虽然有两个效果图，但是只有一个template哟：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;[% $request.uri_base %]/amcharts/style.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;[% $request.uri_base %]/amcharts/amcharts.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
  <span class="kd">var</span> <span class="nx">chart</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">createAmChart</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 清空原有图形</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#chartdiv&quot;</span><span class="p">).</span><span class="nx">empty</span><span class="p">();</span>
    <span class="c1">// 如果是时间轴线图，需要把date字符转成Date对象</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">==</span> <span class="s2">&quot;date&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">date</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmSerialChart</span><span class="p">();</span>
    <span class="c1">// 拖动条等图片的路径</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">pathToImages</span> <span class="o">=</span> <span class="s2">&quot;/amcharts/images/&quot;</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">dataProvider</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">categoryField</span><span class="p">;</span>
    <span class="c1">// 如果是柱状图，可以显示 3D 效果</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;column&#39;</span> <span class="p">)</span> <span class="p">{</span>
<span class="c1">//      chart.rotate = true;</span>
      <span class="nx">chart</span><span class="p">.</span><span class="nx">depth3D</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
      <span class="nx">chart</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">categoryAxis</span> <span class="o">=</span> <span class="nx">chart</span><span class="p">.</span><span class="nx">categoryAxis</span><span class="p">;</span>
    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">fillAlpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">fillColor</span> <span class="o">=</span> <span class="s2">&quot;#FAFAFA&quot;</span><span class="p">;</span>
    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">axisAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">gridPosition</span> <span class="o">=</span> <span class="s2">&quot;start&quot;</span><span class="p">;</span>
    <span class="c1">// 时间轴需要解析Date对象</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">==</span> <span class="s2">&quot;date&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">parseDates</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">minPeriod</span> <span class="o">=</span> <span class="s2">&quot;hh&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">valueAxis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>
    <span class="nx">valueAxis</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="nx">valueAxis</span><span class="p">.</span><span class="nx">axisAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// 指定柱状图为叠加模式，这里有多种模式可以看文档</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;column&#39;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">valueAxis</span><span class="p">.</span><span class="nx">stackType</span> <span class="o">=</span> <span class="s2">&quot;regular&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis</span><span class="p">);</span>
    <span class="c1">// 这里有个有趣的事情，如果不把graph当数组直接循环，效果也没问题</span>
    <span class="c1">// 我只能猜测是 addGraph 后数据其实已经缓存到 chart 了</span>
    <span class="kd">var</span> <span class="nx">graph</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#FF6600&#39;</span><span class="p">,</span> <span class="s1">&#39;#FCD202&#39;</span><span class="p">,</span> <span class="s1">&#39;#B0DE09&#39;</span><span class="p">,</span> <span class="s1">&#39;#0D8ECF&#39;</span><span class="p">,</span> <span class="s1">&#39;#2A0CD0&#39;</span><span class="p">,</span> <span class="s1">&#39;#CD0D74&#39;</span><span class="p">,</span> <span class="s1">&#39;#CC0000&#39;</span><span class="p">,</span> <span class="s1">&#39;#00CC00&#39;</span><span class="p">,</span> <span class="s1">&#39;#0000CC&#39;</span><span class="p">,</span> <span class="s1">&#39;#DDDDDD&#39;</span><span class="p">,</span> <span class="s1">&#39;#999999&#39;</span><span class="p">,</span> <span class="s1">&#39;#333333&#39;</span><span class="p">,</span> <span class="s1">&#39;#990000&#39;</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmGraph</span><span class="p">();</span>
      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">valueField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;column&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">valueField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">descriptionField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;Err&quot;</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletSizeField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;Size&quot;</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bullet</span> <span class="o">=</span> <span class="s2">&quot;round&quot;</span><span class="p">;</span>
        <span class="c1">// 设定为空心圆圈</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletColor</span> <span class="o">=</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletBorderAlpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="c1">// amchart 本来有默认颜色，不过前面因为修改了圆内的颜色，所以其他颜色无法继承默认设定了</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletBorderColor</span> <span class="o">=</span>  <span class="nx">colors</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineColor</span> <span class="o">=</span>  <span class="nx">colors</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineAlpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineThickness</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">balloonText</span> <span class="o">=</span> <span class="s2">&quot;[[value]]% / hasErr:[[description]]%&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">chart</span><span class="p">.</span><span class="nx">addGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="c1">// 加图例，这样可以在图上随时勾选察看具体某个数据，也方便某数据异常的时候影响察看其他</span>
    <span class="kd">var</span> <span class="nx">legend</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmLegend</span><span class="p">();</span>
    <span class="nx">legend</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">;</span>
    <span class="nx">legend</span><span class="p">.</span><span class="nx">horizontalGap</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="nx">legend</span><span class="p">.</span><span class="nx">switchType</span> <span class="o">=</span> <span class="s2">&quot;v&quot;</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">addLegend</span><span class="p">(</span><span class="nx">legend</span><span class="p">);</span>
    <span class="c1">// 加拖拉轴，这样可以拖动察看细节，这个功能很赞</span>
    <span class="kd">var</span> <span class="nx">scrollbar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartScrollbar</span><span class="p">();</span>
    <span class="nx">scrollbar</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="nx">graph</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">scrollbar</span><span class="p">.</span><span class="nx">graphType</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span><span class="p">;</span>
    <span class="nx">scrollbar</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">addChartScrollbar</span><span class="p">(</span><span class="nx">scrollbar</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartCursor</span><span class="p">();</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">addChartCursor</span><span class="p">(</span><span class="nx">cursor</span><span class="p">);</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;chartdiv&quot;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">drawChart</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">provider</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#provider :selected&quot;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
       <span class="nx">provider</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="p">);</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">datasource</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#datasource :selected&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">apitype</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;:radio:checked&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#from&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#to&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
      <span class="nx">processData</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;[% $request.uri_base %]/demo/api/&quot;</span> <span class="o">+</span> <span class="nx">apitype</span><span class="p">,</span>
      <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="s2">&quot;provider&quot;</span><span class="o">:</span><span class="nx">provider</span><span class="p">,</span> <span class="s2">&quot;datasource&quot;</span><span class="o">:</span><span class="nx">datasource</span><span class="p">,</span> <span class="s2">&quot;from&quot;</span><span class="o">:</span><span class="nx">from</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="o">:</span><span class="nx">to</span><span class="p">}),</span>
      <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
      <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
      <span class="nx">success</span> <span class="o">:</span> <span class="nx">createAmChart</span>
    <span class="p">});</span>
  <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">showselect</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#providers&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
  <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">hideselect</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#providers&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
  <span class="p">};</span>
<span class="nt">&lt;/script&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;well&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;from&quot;</span> <span class="na">name=</span><span class="s">&quot;from&quot;</span> <span class="na">value=</span><span class="s">&quot;[% $inputfrom %]&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;to&quot;</span> <span class="na">name=</span><span class="s">&quot;to&quot;</span> <span class="na">value=</span><span class="s">&quot;[% $inputto %]&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;datasource&quot;</span><span class="nt">&gt;</span>
%% for $datasources -&gt; $datasource {
            <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;[% $datasource %]&quot;</span><span class="nt">&gt;</span>[% $datasource %]<span class="nt">&lt;/option&gt;</span>
%% }
          <span class="nt">&lt;/select&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span2&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;radio&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">name=</span><span class="s">&quot;querytype&quot;</span> <span class="na">value=</span><span class="s">&quot;provider&quot;</span> <span class="na">onclick=</span><span class="s">&quot;showselect()&quot;</span><span class="nt">&gt;</span>服务商趋势
          <span class="nt">&lt;/label&gt;</span>
          <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;radio&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">name=</span><span class="s">&quot;querytype&quot;</span> <span class="na">value=</span><span class="s">&quot;area&quot;</span> <span class="na">checked</span> <span class="na">onclick=</span><span class="s">&quot;hideselect()&quot;</span><span class="nt">&gt;</span>分地区统计
          <span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary&quot;</span> <span class="na">onclick=</span><span class="s">&quot;drawChart()&quot;</span><span class="nt">&gt;</span>查询<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id =</span><span class="s">&quot;providers&quot;</span> <span class="na">class=</span><span class="s">&quot;controls hide&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;provider&quot;</span> <span class="na">multiple=</span><span class="s">&quot;mulitiple&quot;</span><span class="nt">&gt;</span>
%% for $providers -&gt; $provider {
            <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;[% $provider %]&quot;</span> <span class="na">selected</span><span class="nt">&gt;</span>[% $provider %]<span class="nt">&lt;/option&gt;</span>
%% }
          <span class="nt">&lt;/select&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span><span class="c">&lt;!--/well--&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chartdiv&quot;</span> <span class="na">style=</span><span class="s">&quot;width: 100%; height: 400px;&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
</code></pre></div>
      <a href="/2012/12/22/elasticsearch-amcharts-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/21/dancer-plugin-auth-extensible" title="学习 Dancer::Plugin::Auth::Extensible 模块" rel="bookmark">学习 Dancer::Plugin::Auth::Extensible 模块</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-21 00:00:00 +0800">21 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>首先介绍一下 <code>Dancer::Plugin::Auth::Extensible</code> 模块。这是一个认证验证的框架，之前 Dancer 里这方面的框架是 RBAC ，不过 RBAC 是实现的 auth 对象，然后提供 <code>-&gt;asa</code>，<code>-&gt;can</code>，<code>-&gt;roles</code> 等方法。在使用的时候，需要自己在每个 route 里写 if 或者 switch 代码，显得比较繁琐。而 Extensible 模块提供了另一个（或者说是两个）思路。同时借此深入了解 <code>Dancer::Plugin</code> 和 <code>Dancer::Hook</code> 的用法，外加熟悉 perl 的一些不常见的对象使用。收获良多，不可不记。</p>
<p>上面之所以说算是两个思路。是因为在这个模块出来的短短十天内，其 0.001 和 0.010 版本已经完全从实现到使用方法都变了样子。下面先说 0.001 版。</p>
<p>这个原始版本的使用方法大概是这样的：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">get</span> <span class="s">&#39;/secret&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">:RequireRole(God) {</span> <span class="n">DestroyWorld</span><span class="p">();</span> <span class="p">};</span>
    <span class="n">get</span> <span class="s">&#39;/users&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">:RequireLogin {</span>
        <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="n">logged_in_user</span><span class="p">;</span>
        <span class="k">return</span> <span class="s">&quot;Hi there, $user-&gt;{username}&quot;</span><span class="p">;</span>
    <span class="p">};</span>
</code></pre></div>
<p>哇，我是第一次见到在 <code>sub</code> 后面还可以写这样的东西（好吧，暴露了本人的菜鸟本质）！赶紧打开模块的源代码，然后找到了相关的几行：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">attributes</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Scalar::</span><span class="n">Util</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Exporter</span> <span class="s">&#39;import&#39;</span><span class="p">;</span>
    <span class="k">our</span> <span class="nv">@EXPORT</span><span class="o">=</span><span class="sx">qw(MODIFY_CODE_ATTRIBUTES FETCH_CODE_ATTRIBUTES)</span><span class="p">;</span>
    <span class="n">hook</span> <span class="n">before</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">$route_handler</span> <span class="o">=</span> <span class="nb">shift</span> <span class="o">||</span> <span class="k">return</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$requires_login</span> <span class="o">=</span> <span class="n">get_attribs_by_type</span><span class="p">(</span>
            <span class="s">&#39;RequireLogin&#39;</span><span class="p">,</span> <span class="nv">$route_handler</span><span class="o">-&gt;</span><span class="n">code</span>
        <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$roles_required</span> <span class="o">=</span> <span class="n">get_attribs_by_type</span><span class="p">(</span>
            <span class="s">&#39;RequireRole&#39;</span><span class="p">,</span> <span class="nv">$route_handler</span><span class="o">-&gt;</span><span class="n">code</span>
        <span class="p">);</span>
        <span class="o">...</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">my</span> <span class="nv">%attrs</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">MODIFY_CODE_ATTRIBUTES</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$package</span><span class="p">,</span> <span class="nv">$subref</span><span class="p">,</span> <span class="nv">@attrs</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="nv">$attrs</span><span class="p">{</span> <span class="n">refaddr</span> <span class="nv">$subref</span> <span class="p">}</span> <span class="o">=</span> <span class="o">\</span><span class="nv">@attrs</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> 
    <span class="k">sub </span><span class="nf">FETCH_CODE_ATTRIBUTES</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$package</span><span class="p">,</span> <span class="nv">$subref</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$attrs</span> <span class="o">=</span> <span class="nv">$attrs</span><span class="p">{</span> <span class="n">refaddr</span> <span class="nv">$subref</span> <span class="p">};</span>
        <span class="k">return</span> <span class="nv">$attrs</span> <span class="p">?</span> <span class="nv">@$attrs</span> <span class="p">:</span> <span class="p">();</span>
    <span class="p">}</span>
    <span class="k">sub </span><span class="nf">get_attribs_by_type</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$coderef</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">unless</span> <span class="nv">$coderef</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">@desired_attribs</span> <span class="o">=</span> <span class="nb">grep</span> <span class="p">{</span> 
            <span class="sr">/^$type(?:\([^)]*\))?$/</span> 
        <span class="p">}</span> <span class="nn">attributes::</span><span class="n">get</span><span class="p">(</span><span class="nv">$coderef</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">if</span> <span class="o">!</span><span class="nv">@desired_attribs</span><span class="p">;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="nb">map</span> <span class="p">{</span>
                <span class="k">my</span> <span class="nv">$f</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
                <span class="nv">$f</span> <span class="o">=~</span> <span class="sr">s/^$type\(\s*([^)]*)\s*\)$/$1/</span><span class="p">;</span>
                <span class="nb">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">,</span> <span class="nv">$f</span><span class="p">);</span>
            <span class="p">}</span> <span class="nv">@desired_attribs</span>
        <span class="p">];</span>
    <span class="p">}</span>
</code></pre></div>
<p>代码中的 <code>$route_handler-&gt;code</code> 就是应用中写的 <code>sub {}</code>。<strong>整个代码中，最关键的部分是这句 <code>attributes::get($coderef)</code> ！</strong></p>
<p>首先有个小问题，因为 Dancer 里，get 是关键词，所以这里写了全路径。<code>attributes::get</code> 的介绍见 <a href="https://metacpan.org/module/attributes#Available-Subroutines">POD</a>，大意是会使用 <code>FETCH_type_ATTRIBUTES</code> 方法获取列表。因为这里 attribute 是 sub 的，所以 type 就是 CODE ，也就是用前面定义的 <code>FETCH_CODE_ATTRIBUTES</code>。<code>FETCH_type_ATTRIBUTES</code> 方法的说明见 <a href="https://metacpan.org/module/attributes#Package-specific-Attribute-Handling">POD</a>。</p>
<p>在<a href="https://metacpan.org/module/perlsub#Subroutine-Attributes">https://metacpan.org/module/perlsub#Subroutine-Attributes</a>中，建议我们看另一个更好用的模块来理解自定义属性的问题，这个模块是<a href="https://metacpan.org/module/Attribute::Handlers">Attribute::Handlers</a>。</p>
<p>然后是 0.010 版：</p>
<p>新版本的使用方法如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">get</span> <span class="s">&#39;/secret&#39;</span> <span class="o">=&gt;</span> <span class="n">require_any_role</span> <span class="p">[</span><span class="sx">qw(God Admin)</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="n">DestroyWorld</span><span class="p">();</span> <span class="p">};</span>
    <span class="n">get</span> <span class="s">&#39;/users&#39;</span> <span class="o">=&gt;</span> <span class="n">require_login</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="n">logged_in_user</span><span class="p">;</span>
        <span class="k">return</span> <span class="s">&quot;Hi there, $user-&gt;{username}&quot;</span><span class="p">;</span>
    <span class="p">};</span>
</code></pre></div>
<p>这种添加新关键词的写法更加的 dancer。所以能从实现中学到更有普适性的 <code>Dancer::Plugin</code> 开发方法。摘要代码如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="nn">Dancer::</span><span class="n">Plugin</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Dancer</span> <span class="sx">qw(:syntax)</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">require_any_role</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_build_wrapper</span><span class="p">(</span><span class="nv">@_</span><span class="p">,</span> <span class="s">&#39;any&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">register</span> <span class="n">require_any_role</span>  <span class="o">=&gt;</span> <span class="o">\&amp;</span><span class="n">require_any_role</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">_build_wrapper</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$require_role</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$coderef</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$mode</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">@role_list</span> <span class="o">=</span> <span class="nb">ref</span> <span class="nv">$require_role</span> <span class="ow">eq</span> <span class="s">&#39;ARRAY&#39;</span> 
            <span class="p">?</span> <span class="nv">@$require_role</span>
            <span class="p">:</span> <span class="nv">$require_role</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">sub </span><span class="p">{</span>
            <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="n">logged_in_user</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">execute_hook</span><span class="p">(</span><span class="s">&#39;login_required&#39;</span><span class="p">,</span> <span class="nv">$coderef</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">redirect</span> <span class="nv">$loginpage</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">my</span> <span class="nv">$role_match</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$mode</span> <span class="ow">eq</span> <span class="s">&#39;single&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$role_match</span><span class="o">++</span> <span class="k">if</span> <span class="n">user_has_role</span><span class="p">(</span><span class="nv">$require_role</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$mode</span> <span class="ow">eq</span> <span class="s">&#39;any&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">my</span> <span class="nv">%role_ok</span> <span class="o">=</span> <span class="nb">map</span> <span class="p">{</span> <span class="nv">$_</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">}</span> <span class="nv">@role_list</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">user_roles</span><span class="p">())</span> <span class="p">{</span>
                    <span class="nv">$role_match</span><span class="o">++</span> <span class="ow">and</span> <span class="k">last</span> <span class="k">if</span> <span class="nv">$role_ok</span><span class="p">{</span><span class="nv">$_</span><span class="p">};</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$mode</span> <span class="ow">eq</span> <span class="s">&#39;all&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$role_match</span><span class="o">++</span><span class="p">;</span>
                <span class="k">for</span> <span class="k">my</span> <span class="nv">$role</span> <span class="p">(</span><span class="nv">@role_list</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_has_role</span><span class="p">(</span><span class="nv">$role</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nv">$role_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="k">last</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$role_match</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$coderef</span><span class="o">-&gt;</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="n">execute_hook</span><span class="p">(</span><span class="s">&#39;permission_denied&#39;</span><span class="p">,</span> <span class="nv">$coderef</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">redirect</span> <span class="nv">$deniedpage</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="n">register_hook</span> <span class="sx">qw(login_required permission_denied)</span><span class="p">;</span>
</code></pre></div>
<p>主要摘要了几个部分：</p>
<ul>
  <li>第一，register</li>
</ul>
<p>摘要中就是 register 了一个关键词 require_any_role 。这样在启用了本 plugin 的应用里，你可以直接使用这个关键词。至于具体的 sub，没有什么特殊的。看前面的用法举例就知道了，传递一个 roles 的数组引用(或者单个role的话就是字符串，这个在后面有判断)和一个 sub 作为参数，也就是 <code>@_</code>。</p>
<ul>
  <li>第二，register_hook</li>
</ul>
<p>第一个是 <code>Dancer::Plugin</code> 的部分，第二个是 <code>Dancer::Hook</code> 的功能。注册一个叫 login_required 的 hook，然后在需要的地方运行 <code>execute_hook('login_required', $coderef)</code>。</p>
<p><code>register_hook</code> 接受 <code>$name</code> 和 <code>$coderef</code> 参数。如果只有 name 的话，<code>Dancer::Hook</code> 里也会自动生成一个 <code>$compiled_filter</code> ，作用就是除非你调用 <code>halt</code> 了，不然就输出一条 core 级别的日志(这里其实还用到了 <code>Dancer::Hook::Properties</code>，判断是否需要运行，默认初始化参数空的时候返回真，不运行 app，继续往下到记录日志)。然后，将这个对象传递给 <code>Dancer::Factory::Hook</code>。这里会把前面的生成的 coderef 加入到一个 <code>$class-&gt;hooks-&gt;{$hook_name}</code> 数组，而 name 加入到 <code>$self-&gt;registered_hooks</code> 数组。</p>
<p>在<code>execute_hook</code> 的时候，从前面的 <code>$self-&gt;registered_hooks</code> 判断是否有这个 name，然后从 <code>$class-&gt;hooks-&gt;{$hook_name}</code> 里依次取出全部 coderef 执行。</p>
<ul>
  <li>第三，any</li>
</ul>
<p>和前面 0.001 类似，这里也有一个关键词冲突的问题，前面的 get 和这里的 any 都是 <code>Dancer</code> 的关键词。不然的话，其实这里使用 <code>Perl6::Junction</code> 或者 <code>Syntax::Keyword::Junction</code> 模块是正当其时啊。我之前都用 <code>Perl6::Junction</code>，不过昨天的 Perl Advent Calendar 文章里推荐了后面这个 <code>Syntax::Keyword::Junction</code>，<a href="https://metacpan.org">meta::cpan</a> 上也都是两个喜欢。另外题外话说一句，那篇文章里推荐的另一个 <a href="https://metacpan.org/module/Function::Parameters">Function::Parameters</a> 可真是好东西，唯一问题是低于 Perl 5.014的版本用不了，因为他不是 source filter 而是 keyword plugin api 的。这是新版本的功能。</p>
<hr />
<p><strong>12 月 30 日附：</strong></p>
<p>在 github 上提交了一个短短的 patch ，给 DPAE 加上了 正则匹配 role 的功能，感谢 Perl5.10的强大，代码其实就修改一行足以实现：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">lib</span><span class="sr">/Dancer/</span><span class="n">Plugin</span><span class="sr">/Auth/</span><span class="n">Extensible</span><span class="o">.</span><span class="n">pm</span> <span class="nv">@</span> <span class="nv">891cd02</span>
    <span class="nv">@@</span> <span class="err">-</span><span class="nv">266</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">266</span><span class="p">,</span><span class="mi">9</span> <span class="nv">@@</span> <span class="nv">sub</span> <span class="n">_build_wrapper</span> <span class="p">{</span>
             <span class="k">my</span> <span class="nv">$role_match</span><span class="p">;</span>
             <span class="k">if</span> <span class="p">(</span><span class="nv">$mode</span> <span class="ow">eq</span> <span class="s">&#39;single&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">-</span>            <span class="nv">$role_match</span><span class="o">++</span> <span class="k">if</span> <span class="n">user_has_role</span><span class="p">(</span><span class="nv">$require_role</span><span class="p">);</span>
    <span class="o">+</span>            <span class="k">for</span> <span class="p">(</span><span class="n">user_roles</span><span class="p">())</span> <span class="p">{</span>
    <span class="o">+</span>                <span class="nv">$role_match</span><span class="o">++</span> <span class="ow">and</span> <span class="k">last</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">~~</span> <span class="nv">$require_role</span><span class="p">;</span>
    <span class="o">+</span>            <span class="p">}</span>
             <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$mode</span> <span class="ow">eq</span> <span class="s">&#39;any&#39;</span><span class="p">)</span> <span class="p">{</span>
                 <span class="k">my</span> <span class="nv">%role_ok</span> <span class="o">=</span> <span class="nb">map</span> <span class="p">{</span> <span class="nv">$_</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">}</span> <span class="nv">@role_list</span><span class="p">;</span>
                 <span class="k">for</span> <span class="p">(</span><span class="n">user_roles</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">/</span><span class="mo">01</span><span class="o">-</span><span class="n">basic</span><span class="o">.</span><span class="n">t</span> <span class="nv">@</span> <span class="nv">891cd02</span>
    <span class="nv">@@</span> <span class="err">-</span><span class="nv">81</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">81</span><span class="p">,</span><span class="mi">9</span> <span class="nv">@@</span> <span class="nv">response_status_is</span> <span class="p">[</span> <span class="n">GET</span> <span class="o">=&gt;</span> <span class="s">&#39;/allroles&#39;</span> <span class="p">],</span> <span class="mi">200</span><span class="p">,</span>
     <span class="n">response_status_is</span> <span class="p">[</span> <span class="n">GET</span> <span class="o">=&gt;</span> <span class="s">&#39;/regex/a&#39;</span> <span class="p">],</span> <span class="mi">200</span><span class="p">,</span>
         <span class="s">&quot;We can request a regex route when logged in&quot;</span><span class="p">;</span>
    <span class="o">+</span><span class="n">response_status_is</span> <span class="p">[</span> <span class="n">GET</span> <span class="o">=&gt;</span> <span class="s">&#39;/piss/regex&#39;</span> <span class="p">],</span> <span class="mi">200</span><span class="p">,</span>
    <span class="o">+</span>    <span class="s">&quot;We can request a route requiring a regex role we have&quot;</span><span class="p">;</span>
    <span class="o">+</span>
     <span class="c1"># ... but can&#39;t request something requiring a role we don&#39;t have</span>
     <span class="n">response_redirect_location_is</span>  <span class="p">[</span> <span class="n">GET</span> <span class="o">=&gt;</span> <span class="s">&#39;/piss&#39;</span> <span class="p">],</span>
         <span class="s">&#39;http://localhost/login/denied?return_url=%2Fpiss&#39;</span><span class="p">,</span>
    <span class="n">t</span><span class="sr">/lib/</span><span class="n">TestApp</span><span class="o">.</span><span class="n">pm</span> <span class="nv">@</span> <span class="nv">891cd02</span>
    <span class="nv">@@</span> <span class="err">-</span><span class="nv">39</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">39</span><span class="p">,</span><span class="mi">10</span> <span class="nv">@@</span> <span class="nv">get</span> <span class="s">&#39;/piss&#39;</span> <span class="o">=&gt;</span> <span class="n">require_role</span> <span class="n">BearGrylls</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
         <span class="s">&quot;You can drink piss&quot;</span><span class="p">;</span>
     <span class="p">};</span>
    <span class="o">+</span><span class="n">get</span> <span class="s">&#39;/piss/regex&#39;</span> <span class="o">=&gt;</span> <span class="n">require_role</span> <span class="sx">qr/beer/</span><span class="n">i</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="o">+</span>    <span class="s">&quot;You can drink piss now&quot;</span><span class="p">;</span>
    <span class="o">+</span><span class="p">};</span>
    <span class="o">+</span>
     <span class="n">get</span> <span class="s">&#39;/anyrole&#39;</span> <span class="o">=&gt;</span> <span class="n">require_any_role</span> <span class="p">[</span><span class="s">&#39;Foo&#39;</span><span class="p">,</span><span class="s">&#39;BeerDrinker&#39;</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
         <span class="s">&quot;Matching one of multiple roles works&quot;</span><span class="p">;</span>
     <span class="p">};</span>
</code></pre></div>
      <a href="/2012/12/21/dancer-plugin-auth-extensible" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/19/dancer-and-text-xslate" title="Dancer 框架使用 Text::XSlate 模版的注意事项" rel="bookmark">Dancer 框架使用 Text::XSlate 模版的注意事项</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-19 00:00:00 +0800">19 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Dancer 框架自带有一个 Simple 模版，不过推荐使用 <code>Template</code> 模块作为替代品。不过从性能上来说，TT2 比之前博客里陆续介绍过的 <code>HTML::Template</code> 和 <code>Text::MicroTemplate</code> 都要差。而这方面最好的，就是 <code>Text::XSlate</code> 模块了。今天尝试将一个 Dancer 应用迁移到 <code>Text::XSlate</code> 上。踩进两个坑，特此记录。</p>
<p>关于语法什么的，可以看 POD ，扶凯 有翻译的 中文版POD 。足以十分钟入门。就不多说了。</p>
<ul>
  <li>第一个坑：session 的处理</li>
</ul>
<p>website 少不了 session 的运用。在 template 里使用 <code>[% session.username %]</code> 可以很方便的控制显示面板还是登陆啊什么的。</p>
<p>不过切换成 XSlate 后（即 <code>&lt;: $session.username :&gt;</code>），请求会 crash 掉，报错大意是: <strong>$session 没有 username 这个 method</strong>。</p>
<p>XSlate 提供了 <code>dump</code> 语法糖，让我们可以直接使用 <code>&lt;: $session | dump :&gt;</code> 检查问题。这时候发现显示如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="nv">$VAR1</span> <span class="o">=</span> <span class="p">{</span> <span class="n">blessed</span><span class="p">(</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="s">&#39;2131232131&#39;</span><span class="p">,</span> <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;user1&#39;</span> <span class="p">}</span> <span class="p">),</span> <span class="nn">Dancer::Session::</span><span class="n">YAML</span> <span class="p">};</span>
</code></pre></div>
<p>尝试使用 <code>&lt;: $session.id :&gt;</code> ，发现可以正常输出 2131232131 。</p>
<p>进去看 <code>Dancer::Session</code> 的代码，原来在 <code>Dancer::Session::Abstract</code> 里，有这么一行：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">);</span>
</code></pre></div>
<p>说实话不太理解这行的用法，不过不妨碍我们用简单办法解决问题…… 在我们的应用中给 <code>Dancer::Session::YAML</code> 定义一个叫 username 的 method 就可以骗过去了：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="n">DancerApp</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Dancer::Session::</span><span class="n">YAML</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">Dancer</span><span class="p">::Session::YAML::username {</span>
        <span class="k">return</span> <span class="n">session</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">use</span> <span class="nn">Dancer::Plugin::Auth::</span><span class="n">Extensible</span><span class="p">;</span>
    <span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">:RequireLogin {</span> <span class="n">template</span> <span class="s">&#39;index&#39;</span> <span class="p">};</span>
    <span class="o">...</span><span class="p">;</span>
    <span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p><strong>2013 年 03 月 25 日更新</strong></p>
<p>今天莫莫也换成 Xslate 模板，顺带告诉我这里一个更通用和优雅的修改方式：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="n">DancerApp</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Dancer::Session::</span><span class="n">Abstract</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Dancer::Plugin::Auth::</span><span class="n">Extensible</span><span class="p">;</span>
    <span class="nn">Dancer::Session::</span><span class="n">Abstract</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">(</span> <span class="sx">qw(username)</span> <span class="p">);</span>
    <span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">:RequireLogin {</span> <span class="n">template</span> <span class="s">&#39;index&#39;</span> <span class="p">};</span>
    <span class="o">...</span><span class="p">;</span>
    <span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>这样可以在各种 Session 引擎下通用了。</p>
<p><strong>更新完毕</strong></p>
<ul>
  <li>第二个坑：flashmessage 的处理</li>
</ul>
<p>这是一个外加模块，叫做 <code>Dancer::Plugin::FlashMessage</code> 。用它配合模版的 layout 功能，可以很方便的给应用提供全局的消息通知。使用方法如下：</p>
<p>首先在模块里加载 flash 变量：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="nn">DancerApp::</span><span class="n">First</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">FlashMessage</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Dancer::Plugin::Auth::</span><span class="n">Extensible</span><span class="p">;</span>
    <span class="n">get</span> <span class="s">&#39;/first/:name&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">:RequireRole(&#39;MAN&#39;) {</span>
        <span class="n">flash</span> <span class="n">message</span> <span class="o">=&gt;</span> <span class="s">&#39;Hello! You are the first man here.&#39;</span><span class="p">;</span>
        <span class="n">template</span> <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="n">param</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span> <span class="p">};</span>
    <span class="p">};</span>
    <span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>然后在模版里判断显示：</p>
<div class="highlight"><pre><code class="html">    [% IF flash.message %]
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-success&quot;</span><span class="nt">&gt;</span>
        [% flash.message %]
      <span class="nt">&lt;/div&gt;</span>
    [% END %]
</code></pre></div>
<p>同样，在修改成 XSlate 后，模版是这样：</p>
<div class="highlight"><pre><code class="html">    : if $flash.message {
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-success&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;:</span> <span class="na">flash</span><span class="err">.</span><span class="na">message</span> <span class="na">:</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    : }
</code></pre></div>
<p>结果发现页面上的 div 一直保持，而且显示着 <code>CODE(0x39a5c30)</code> 这样的字样。同样使用 <code>dump</code> 语法糖，看到 <code>$flash</code> 其实是 <code>{ message =&gt; sub {"DUMMY"} }</code>。</p>
<p>这个就有趣了，居然是个代码段~~于是翻源码来看：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">hook</span> <span class="n">before_template</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="nb">shift</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$token_name</span><span class="p">}</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">map</span> <span class="p">{</span> <span class="k">my</span> <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span> <span class="k">my</span> <span class="nv">$value</span><span class="p">;</span>
                <span class="p">(</span> <span class="nv">$key</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span> <span class="nb">defined</span> <span class="nv">$value</span> <span class="ow">and</span> <span class="k">return</span> <span class="nv">$value</span><span class="p">;</span>
                    <span class="k">my</span> <span class="nv">$flash</span> <span class="o">=</span> <span class="n">session</span><span class="p">(</span><span class="nv">$session_hash_key</span><span class="p">)</span> <span class="o">||</span> <span class="p">{};</span>
                    <span class="nv">$value</span> <span class="o">=</span> <span class="nb">delete</span> <span class="nv">$flash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$key</span><span class="p">};</span>
                    <span class="n">session</span> <span class="nv">$session_hash_key</span><span class="p">,</span> <span class="nv">$flash</span><span class="p">;</span>
                    <span class="k">return</span> <span class="nv">$value</span><span class="p">;</span>
                <span class="p">}</span> <span class="p">);</span>
            <span class="p">}</span> <span class="p">(</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="n">session</span><span class="p">(</span><span class="nv">$session_hash_key</span><span class="p">)</span> <span class="o">||</span> <span class="p">{}</span> <span class="p">})</span>
        <span class="p">};</span>
    <span class="p">};</span>
</code></pre></div>
<p><code>map</code> 里面，确实是一个 <code>$key =&gt; sub {}</code> 。</p>
<p>这个时候我切换两个 template 做了个测试。在里面那个匿名 sub 里写了一行 <code>die;</code>。结果。XSlate “正常”运行过去，在页面上显示前面说过的 <code>CODE()</code>；而在 Template 模版下，500 了。看 console 的日志，发现 <code>die</code> 这个动作不是在 <code>before_template</code> 阶段发生的。而是在随后的 render 阶段，<code>Dancer::Template::Abstract</code> 里才挂了。</p>
<p>所以，最终，两个坑归结起来并成了一个问题：模版系统是支持 coderef 还是支持 object 的问题。就在我写着这句话的同时，IRC 上还为 <code>Dancer::Plugin::FlashMessage</code> 的新实现而争论不休。xdg 童鞋已经在我提问的一个小时内快速的搞出来一个把 flash &ldquo;object 化&rdquo;的 patch，而 bigpresh 童鞋坚定的认为应该把 <code>delete</code> 操作放在 <code>hook after_template</code> 里完成。原作者 <code>dams</code> 则&rdquo;相信&rdquo;更多的模版是支持 coderef 不支持 object 的。</p>
<p>不过我觉得，其实改动最小的办法，就是别用 <code>map</code> 这么高档的语法。拆成两段处理，确保传递给 <code>template_render</code> 的是字符串即可：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">hook</span> <span class="n">before_template</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">%hash</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$flash</span> <span class="o">=</span> <span class="n">session</span><span class="p">(</span><span class="nv">$session_hash_key</span><span class="p">)</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$flash</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$hash</span><span class="p">{</span><span class="nv">$_</span><span class="p">}</span> <span class="o">=</span> <span class="nb">delete</span> <span class="nv">$flash</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$_</span><span class="p">};</span>
        <span class="p">};</span>
        <span class="n">session</span> <span class="nv">$session_hash_key</span><span class="p">,</span> <span class="nv">$flash</span><span class="p">;</span>
        <span class="nb">shift</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$token_name</span><span class="p">}</span> <span class="o">=</span> <span class="o">\</span><span class="nv">%hash</span><span class="p">;</span>
    <span class="p">};</span>
</code></pre></div>
<p>最后的最后，就在我测试完我的改动版本在两种模版下都可以运行的时候，dams 已经决定先同时保持 coderef 和 object 的写法并提供 setting 配置。然后慢慢搜集各种模版系统做覆盖测试。</p>
<p><strong>20 日增</strong></p>
<p>最后最后的最后，在 github 上搜到两个用 dancer 和 xslate 写的 repo。他们都采用了在应用 app 里自定义 <code>hook before_template</code> ，把 <code>session('username')</code> 和 <code>flash('message')</code> 两个变量传递给 <code>$token</code> 哈希的办法。</p>
      <a href="/2012/12/19/dancer-and-text-xslate" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/16/how-to-set-host-header-in-perl" title="perl发起HTTP请求时如何设置Host头" rel="bookmark">perl发起HTTP请求时如何设置Host头</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-16 00:00:00 +0800">16 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之所以写这么个内容，是今天突然发现之前有个脚本的效果完全不对。这个脚本是用 Furl 模块发 HTTP 请求。看 POD 的说明，以为这样写是生效的：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="nn">HTTP::</span><span class="n">Request</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Furl</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$r</span> <span class="o">=</span> <span class="nn">HTTP::</span><span class="n">Request</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">GET</span> <span class="o">=&gt;</span> <span class="s">&quot;http://192.168.0.2/path/to/file&quot;</span> <span class="p">);</span>
    <span class="nv">$r</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">(</span> <span class="n">Host</span> <span class="o">=&gt;</span> <span class="s">&quot;www.example.com&quot;</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$furl</span> <span class="o">=</span> <span class="n">Furl</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
    <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$furl</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="nv">$r</span><span class="p">);</span>
    <span class="n">say</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">();</span>
</code></pre></div>
<p>但是随后在 192.168.0.2 上发现日志记录中，Host 并没有修改成 www.example.com 。</p>
<p>然后尝试了各种 POD 上介绍的 header 写法，包括在 new HTTP::Request 的时候使用 <code>[Host =&gt; "www.example.com"]</code> 参数，在 <code>$furl-&gt;request</code> 的时候使用 <code>headers =&gt; [Host =&gt; "www.example.com"]</code> 参数。结果都一样。</p>
<p>然后只能改思路，用设置 proxy 的办法。结果发现 Furl 模块的 proxy 不可用……</p>
<p>POD 上是说直接在 new 的时候传递 %args 或者 \%args 就行。但是我使用的时候发现直接会报错：</p>
<pre><code>Passed malformed URL: 192.168.0.2
</code></pre>
<p>最后只能放弃使用 Furl 模块，改回古老的 LWP 模块。LWP 与 Coro 配合如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Coro</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">LWP::Protocol::Coro::</span><span class="n">http</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">LWP::</span><span class="n">UserAgent</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">co_http_get</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$domain</span><span class="p">,</span> <span class="nv">$urlpath</span><span class="p">,</span> <span class="nv">$iplist</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">@coros</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$msg</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$ua</span> <span class="o">=</span> <span class="nn">LWP::</span><span class="n">UserAgent</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$ip</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$iplist</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nb">push</span> <span class="nv">@coros</span><span class="p">,</span> <span class="n">async</span> <span class="p">{</span>
                <span class="nv">$ua</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">(</span><span class="s">&#39;http&#39;</span><span class="p">,</span> <span class="s">&quot;http://$ip:3128/&quot;</span><span class="p">);</span>
                <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$ua</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://$domain$urlpath&quot;</span><span class="p">);</span>
                <span class="nv">$msg</span> <span class="o">.=</span> <span class="s">&quot;$ip: &quot;</span> <span class="o">.</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">()</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nv">$_</span><span class="o">-&gt;</span><span class="nb">join</span> <span class="k">for</span> <span class="nv">@coros</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$msg</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">print</span> <span class="n">co_http_get</span><span class="p">(</span><span class="s">&quot;www.example.com&quot;</span><span class="p">,</span> <span class="s">&quot;/path/to/file&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sx">qw(192.168.0.1 192.168.0.2)</span><span class="p">]);</span>
</code></pre></div>
      <a href="/2012/12/16/how-to-set-host-header-in-perl" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/11/note-on-using-ElasticSearch-pm" title="不小心踩进ElasticSearch.pm模块的坑里了" rel="bookmark">不小心踩进ElasticSearch.pm模块的坑里了</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-11 00:00:00 +0800">11 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在今天以前，我一直认为perl的ElasticSearch.pm是除了原生java库以外封装最好的。不过今天踩进一个硕大的坑里，多亏 dancer-user 邮件列表里外国友人的帮助，才算爬了出来……</p>
<h1 id="section">事情是这样的</h1>
<p>用 dancer 搭建的一个 webserver 用来提供 api 给前端图表页面。dancer 收到 ajax 请求后组装成 json 发给 ElasticSearch。因为要算百分比，无法在单次请求内完成，不然的话直接从页面上发给 ES 服务器了。</p>
<p>这个 webserver 是之前已经创建过的。而且作用类似，也就是说，之前已经存在一个 <code>DancerApp/lib/DancerApp/First.pm</code> 里使用了 ElasticSearch 模块。相关代码如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">ElasticSearch</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$elsearch</span> <span class="o">=</span> <span class="n">ElasticSearch</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">config</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ElasticSearch</span><span class="p">}</span> <span class="p">);</span>
</code></pre></div>
<p>然后给新项目创建 <code>DancerApp/lib/DancerApp/Second.pm</code> 同样使用 ElasticSearch 模块，代码原样复制。然后在 <code>DancerApp/lib/DancerApp.pm</code> 里先后加载：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">FindBin</span> <span class="sx">qw($Bin)</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">lib</span> <span class="s">&quot;$Bin/../lib&quot;</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">DancerApp::</span><span class="n">First</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">DancerApp::</span><span class="n">Second</span><span class="p">;</span>
</code></pre></div>
<p>启动应用后访问页面。怪事出现了： <em>First 应用正常，Second 应用报错说 ElasticSearch 连接不上</em>。</p>
<p>仔细看报错信息，发现Second 里的 <code>$elsearch</code> 连接的不是 <code>config.yml</code> 里设定的 servers，而是模块默认的 <code>127.0.0.1:9200</code>。</p>
<p>更换<code>DancerApp/lib/DancerApp.pm</code> 里的加载次序，就变成了 <em>Second 正常，First 失败</em>。</p>
<p>试图使用下面的代码检查 <code>config</code> ，发现 config 里其他的设置都没问题，唯独和 ElasticSearch 相关的设定发生了变化：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="nn">Data::</span><span class="n">Dumper</span><span class="p">;</span>
    <span class="n">get</span> <span class="s">&#39;/config&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="k">return</span> <span class="n">Dumper</span> <span class="n">config</span> <span class="p">};</span>
</code></pre></div>
<p>结果中 <code>config-&gt;{ElasticSearch}</code> 只剩下 <code>trace_calls: 0</code> 一条设定， <code>servers</code>、<code>transport</code>、<code>no_refresh</code> 和 <code>max_requests</code> 都消失了！</p>
<h1 id="section-1">真相只有一个</h1>
<p>ElasticSearch 模块在初始化的时候，会把参数传递给 <code>ElasticSearch::Transport</code> 模块做具体的操作（包括之前我很欣赏的自动选择节点服务器）。而就在这里，问题出现了：</p>
<p><em>参数一直是以引用身份传递的，任何修改都会修改原始数据</em></p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$servers</span> <span class="o">=</span> <span class="nb">delete</span> <span class="nv">$params</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">servers</span><span class="p">}</span>
        <span class="o">||</span> <span class="s">&#39;127.0.0.1:&#39;</span> <span class="o">.</span> <span class="nv">$transport_class</span><span class="o">-&gt;</span><span class="n">default_port</span><span class="p">;</span>
</code></pre></div>
<p>随着 <code>delete</code> 操作，悲剧就此发生了。Dancer 里的全局变量 <code>config-&gt;{ElasticSearch}</code> 中的 servers 元素就此消失……</p>
<h1 id="section-2">善后事宜</h1>
<p>解决办法很容易，在每个模块里初始化 ElasticSearch 实例的适合，传递一个全局 <code>config-&gt;{ElasticSearch}</code> 的_副本的引用_过去。</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$elsearch</span> <span class="o">=</span> <span class="n">ElasticSearch</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="p">{</span> <span class="nv">%</span><span class="p">{</span> <span class="n">config</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ElasticSearch</span><span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">);</span>
</code></pre></div>
<p>亲爱的 David Precious 童鞋已经把这个问题上报给 ElasticSearch.pm 开发者了。或许之后会由模块内部做副本操作。目前只能自己来了。</p>
<p>issue 地址：<a href="https://github.com/clintongormley/ElasticSearch.pm/issues/34">https://github.com/clintongormley/ElasticSearch.pm/issues/34</a></p>
      <a href="/2012/12/11/note-on-using-ElasticSearch-pm" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/10/gnuplot-to-draw-histogram-cluster" title="用gnuplot绘制直方图" rel="bookmark">用gnuplot绘制直方图</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-10 00:00:00 +0800">10 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>越来越喜欢用 gnuplot 画图了，因为有时候发现自己实在是不会用 Excel……</p>
<p>之前基本上用gnuplot画的都是时间轴形式的，诸位客官肯定已经看多了。但是 gnuplot 可不止是这点。还有一种很常见的功能也很方便，就是与时间无关的多个数据做对比的时候，还画成两条连线，就不如画成直方图更体现价值了。比如下面这组数据：</p>
<pre><code>地区	总数(A)	总数(B)
美洲	16682	20344
澳洲	4021	3672
欧洲	2902	2878
</code></pre>
<p>只需要几行配置，就可以生成很漂亮滴直方图对比了。</p>
<div class="highlight"><pre><code class="bash"><span class="nb">set </span>key right top Left reverse width 0 box 3
<span class="nb">set </span>xlabel <span class="s2">&quot;各大洲区域&quot;</span>
<span class="nb">set </span>ylabel <span class="s2">&quot;请求总数&quot;</span>
<span class="nb">set </span>ytics 0, 500
<span class="nb">set </span>mytics 5
<span class="nb">set </span>grid
<span class="nb">set </span>boxwidth 0.9 absolute
<span class="nb">set </span>style fill solid 1.00 border -1
<span class="nb">set </span>style histogram clustered gap 1 title offset character 0, 0, 0
<span class="nb">set </span>style data histograms
<span class="nb">set </span>terminal png size 1024, 512
<span class="nb">set </span>output <span class="s2">&quot;oversea.png&quot;</span>
plot <span class="s1">&#39;oversea.csv&#39;</span> using 2:xtic<span class="o">(</span>1<span class="o">)</span> ti col, <span class="s1">&#39;&#39;</span> u 3 ti col
</code></pre></div>
<p>注意如果行比较多，默认大小的图上X轴的标记就会挤在一块了，所以在 set terminal 后面设置图片大小，这和 set size 是不一样的。后者设置的相对值是本次要 plot 的图形在总画布上的比例大小。</p>
<p>plot 里 using 的两列也是和画 line 图时反过来的顺序，而且 X 轴的列要用 xtic() 包起来写，否则 gnuplot 会认为这应该是个自增序列，然后找不到 xrange 出错。</p>
<p>效果图如下：</p>
<p><img src="/images/uploads/gnuplot-boxes.png" alt="图片" /></p>
      <a href="/2012/12/10/gnuplot-to-draw-histogram-cluster" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/12/01/convert-docx-to-markdown" title="把docx文档转换成markdown格式发布" rel="bookmark">把docx文档转换成markdown格式发布</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-12-01 00:00:00 +0800">01 Dec 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>有些Word文档想搬到博客上来，而博客用的是markdown的格式。最简单的办法是在Word里转成html格式另存为，因为markdown和html是兼容的。不过word直接另存为的html里面带有“海量”的无聊样式，实在不方便之后我们再用vim的工具编辑。所以还是想办法整整。</p>
<p>相对来说，Word的docx格式比doc格式要容易处理，因为docx是微软特意推出的open xml格式。其实就是记录了文本内容的content.xml、附件media/*和对应附件路径的_ref.xml等的zip包而已。所以相对必须在Windows平台上调用WIN32OLE的API来处理的doc来说，我们在linux平台上也可以很容易的处理docx文件了。比如rubygems上就有一个很不错的gem叫<code>ydocx</code>。一般的docx库都是只抽取docx里的content文字，而这个ydocx很负责的把media/*也复制到docxname_files/images/*下面，并且在html里生成<code>&lt;img&gt;</code>标签了。</p>
<p>然后另一步就是把html转换成markdown，这在github上也有现成的repo叫<a href="https://github.com/cousine/downmark_it">downmark_it</a>。嗯，这名字一目了然就是反过来……</p>
<p>(<code>ydocx</code>用的是<code>nokogiri</code>，<code>downmark\_it</code>用的是<code>hpricot</code>，或许应该也改用<code>nokogiri</code>比较好~不过<code>nokogiri</code>官网可耻的被墙了)</p>
<h1 id="section">首先安装依赖</h1>
<div class="highlight"><pre><code class="bash">  apt-get install libxslt1-dev libxml2-dev
  gem install rubyzip htmlentities rmagick ydocx hpricot
  wget https://raw.github.com/cousine/downmark_it/master/downmark_it.rb
</code></pre></div>
<h1 id="section-1">编写转换脚本</h1>
<div class="highlight"><pre><code class="ruby">  <span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
  <span class="nb">require</span> <span class="s1">&#39;ydocx&#39;</span>
  <span class="vg">$:</span> <span class="o">&lt;&lt;</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span>
  <span class="nb">require</span> <span class="s1">&#39;downmark_it&#39;</span>
  <span class="n">filename</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">shift</span>
  <span class="n">ydocx</span> <span class="o">=</span> <span class="ss">YDocx</span><span class="p">:</span><span class="ss">:Document</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
  <span class="n">html</span> <span class="o">=</span> <span class="n">ydocx</span><span class="o">.</span><span class="n">to_html</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="no">DownmarkIt</span><span class="o">.</span><span class="n">to_markdown</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
</code></pre></div>
<p>这样就能看到输出了。目录里的每个章节都有引用格式凸现，美中不足是对word里的标题样式识别不太好，本来期望是可以自己生成<code>&lt;h1&gt;</code>、<code>&lt;h2&gt;</code>的，但是ydocx生成的html里只把第一个标题一变成<code>&lt;h1&gt;</code>，其他的都是普通的<code>&lt;p&gt;</code>。</p>
<p>另一个问题是上面脚本里直接调用to_html的方法，不会保存住unzip出来的images文件夹。自己再另写一段unzip的代码:</p>
<div class="highlight"><pre><code class="ruby">  <span class="nb">require</span> <span class="s1">&#39;fileutils&#39;</span>  
  <span class="nb">require</span> <span class="s1">&#39;zip/zip&#39;</span>  
  <span class="nb">require</span> <span class="s1">&#39;zip/zipfilesystem&#39;</span>  
  <span class="k">def</span> <span class="nf">unzip</span><span class="p">(</span><span class="n">zip_file</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">)</span>
    <span class="ss">Zip</span><span class="p">:</span><span class="ss">:ZipFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">zip_file</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">zf</span><span class="o">|</span>
      <span class="n">zf</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
        <span class="n">path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="no">FileUtils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">zf</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="p">{</span> <span class="kp">true</span> <span class="p">}</span>
      <span class="k">end</span>  
    <span class="k">end</span>  
  <span class="k">end</span>
  <span class="n">dirname</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;.docx&#39;</span><span class="p">)</span>
  <span class="n">unzip</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;/tmp/</span><span class="si">#{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="no">FileUtils</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="s2">&quot;/tmp/</span><span class="si">#{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">/media/&quot;</span><span class="p">,</span> <span class="s2">&quot;/images/&quot;</span><span class="p">)</span>
  <span class="no">FileUtils</span><span class="o">.</span><span class="n">rm_rf</span><span class="p">(</span><span class="s2">&quot;/tmp/</span><span class="si">#{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>比较普通的办法，是直接使用ydocx自带的脚本<code>docx2html --format none file.docx</code>，会在docx文档的同级目录下生成同名html和_files目录。然后再写一个单行脚本转成markdown的。</p>
      <a href="/2012/12/01/convert-docx-to-markdown" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/11/22/tatsumaki-demo" title="用 Tatsumaki 框架写 elasticsearch 界面" rel="bookmark">用 Tatsumaki 框架写 elasticsearch 界面</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-11-22 00:00:00 +0800">22 Nov 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Tatsumaki是Plack作者的一个小框架，亮点是很好的利用了psgi.streaming的接口可以async的完成响应。不过因为缺少周边支持，所以除了几个webchat的example，似乎没看到什么应用。笔者之前纯为练手，却用tatsumaki写了个sync响应的小demo，算是展示一下用tatsuamki做普通web应用的基础步骤吧：</p>
<p>(代码本来是作为一个ElasticSearch数据分析的平台，不过后来发现社区有人开始做纯js的内嵌进ElasticSearch的plugin了，所以撤了repo，这里贴下代码)</p>
<ul>
  <li>所有的psgi/plack应用都一样有自己的app.psgi文件：</li>
</ul>
<div class="highlight"><pre><code class="perl"><span class="k">our</span> <span class="nv">$VERSION</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>
<span class="c1">### app.psgi</span>
<span class="k">use</span> <span class="nn">Tatsumaki::</span><span class="n">Error</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Tatsumaki::</span><span class="n">Application</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Tatsumaki::</span><span class="n">HTTPClient</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Tatsumaki::</span><span class="n">Server</span><span class="p">;</span>
<span class="c1">### read config</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Basename</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">YAML::</span><span class="n">Syck</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$config</span> <span class="o">=</span> <span class="n">LoadFile</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s">&#39;/config.yml&#39;</span><span class="p">);</span>
<span class="c1">### elasticsearch init</span>
<span class="k">use</span> <span class="n">ElasticSearch</span><span class="p">;</span>
<span class="c1">#这里yml的写法借鉴Dancer::Plugin::ElasticSearch了</span>
<span class="k">my</span> <span class="nv">$elsearch</span> <span class="o">=</span> <span class="n">ElasticSearch</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;options&#39;</span><span class="p">}</span> <span class="p">);</span>
<span class="c1">### index init</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(strftime)</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$index</span> <span class="o">=</span> <span class="nb">join</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="p">(</span> <span class="p">(</span><span class="o">+</span><span class="nb">split</span><span class="p">(</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;index&#39;</span><span class="p">}</span> <span class="p">))[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strftime</span><span class="p">(</span> <span class="p">(</span><span class="o">+</span><span class="nb">split</span><span class="p">(</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;index&#39;</span><span class="p">}</span> <span class="p">))[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">localtime</span> <span class="p">)</span> <span class="p">);</span>
<span class="k">my</span> <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">};</span>
<span class="c1">#首页类，调用了模板</span>
<span class="nb">package</span> <span class="n">MainHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(Tatsumaki::Handler)</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">get</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;index.html&#39;</span><span class="p">);</span>
<span class="p">};</span>
<span class="c1">#具体的API类</span>
<span class="nb">package</span> <span class="n">ListHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(Tatsumaki::Handler)</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">get</span> <span class="p">{</span>
<span class="c1">#这里自动把urlpath切分好了</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$self</span><span class="p">,</span> <span class="nv">$group</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$interval</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">return</span> <span class="s">&#39;Not valid order&#39;</span> <span class="k">unless</span> <span class="nv">$order</span> <span class="ow">eq</span> <span class="s">&#39;count&#39;</span> <span class="ow">or</span> <span class="nv">$order</span> <span class="ow">eq</span> <span class="s">&#39;mean&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="s">&#39;Not valid interval&#39;</span> <span class="k">unless</span> <span class="nv">$interval</span> <span class="o">=~</span> <span class="n">m</span><span class="c1">#\d+(h|m|s)#;</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$key_field</span><span class="p">,</span> <span class="nv">$value_field</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$group</span> <span class="ow">eq</span> <span class="s">&#39;url&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$key_field</span> <span class="o">=</span> <span class="s">&#39;url&#39;</span><span class="p">;</span>
        <span class="nv">$value_field</span> <span class="o">=</span> <span class="s">&#39;responsetime&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$group</span> <span class="ow">eq</span> <span class="s">&#39;ip&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$key_field</span> <span class="o">=</span> <span class="s">&#39;oh&#39;</span><span class="p">;</span>
        <span class="nv">$value_field</span> <span class="o">=</span> <span class="s">&#39;upstreamtime&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#39;Not valid group field&#39;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="c1"># get index mapping and sort into array</span>
    <span class="k">my</span> <span class="nv">$mapping</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">(</span>
        <span class="nb">index</span> <span class="o">=&gt;</span> <span class="s">&quot;$index&quot;</span><span class="p">,</span>
        <span class="n">type</span>  <span class="o">=&gt;</span> <span class="s">&quot;$type&quot;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">@res_map</span><span class="p">;</span>
    <span class="k">for</span> <span class="k">my</span> <span class="nv">$property</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span> <span class="nv">$mapping</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$type</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$property</span> <span class="ow">eq</span> <span class="s">&#39;@fields&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">@fields</span><span class="p">;</span>
            <span class="nb">push</span> <span class="nv">@fields</span><span class="p">,</span> <span class="p">{</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="p">,</span> <span class="n">type</span> <span class="o">=&gt;</span> <span class="nv">$mapping</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$type</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$property</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$_</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">}</span> <span class="p">}</span>
                <span class="k">for</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span> <span class="nv">$mapping</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$type</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$property</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span> <span class="p">};</span>
            <span class="nb">push</span> <span class="nv">@res_map</span><span class="p">,</span> <span class="o">\</span><span class="nv">@fields</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">push</span> <span class="nv">@res_map</span><span class="p">,</span> <span class="p">{</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">$property</span><span class="p">,</span> <span class="n">type</span> <span class="o">=&gt;</span> <span class="nv">$mapping</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$type</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$property</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">}</span> <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1"># get value stat group by key field</span>
    <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
        <span class="nb">index</span> <span class="o">=&gt;</span> <span class="s">&quot;$index&quot;</span><span class="p">,</span>
        <span class="n">type</span>  <span class="o">=&gt;</span> <span class="s">&quot;$type&quot;</span><span class="p">,</span>
        <span class="n">size</span>  <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">query</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&quot;range&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="s">&#39;@timestamp&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">from</span> <span class="o">=&gt;</span> <span class="s">&quot;now-$interval&quot;</span><span class="p">,</span>
                    <span class="n">to</span>   <span class="o">=&gt;</span> <span class="s">&quot;now&quot;</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="n">facets</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&quot;$group&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="s">&quot;terms_stats&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="s">&quot;value_field&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;$value_field&quot;</span><span class="p">,</span>
                    <span class="s">&quot;key_field&quot;</span>   <span class="o">=&gt;</span> <span class="s">&quot;$key_field&quot;</span><span class="p">,</span>
                    <span class="s">&quot;order&quot;</span>       <span class="o">=&gt;</span> <span class="s">&quot;$order&quot;</span><span class="p">,</span>
                    <span class="s">&quot;size&quot;</span>        <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">}</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">@res_tbl</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">facets</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&quot;$group&quot;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">terms</span><span class="p">}}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$mean</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s">&quot;%.03f&quot;</span><span class="p">,</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">mean</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$code_count</span> <span class="o">=</span> <span class="n">code_count</span><span class="p">(</span><span class="nv">$key_field</span><span class="p">,</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$interval</span><span class="p">);</span>
        <span class="nb">push</span> <span class="nv">@res_tbl</span><span class="p">,</span> <span class="p">{</span>
            <span class="n">key</span>   <span class="o">=&gt;</span> <span class="nv">$key</span><span class="p">,</span>
            <span class="n">min</span>   <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">min</span><span class="p">},</span>
            <span class="n">max</span>   <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">max</span><span class="p">},</span>
            <span class="n">mean</span>  <span class="o">=&gt;</span> <span class="nv">$mean</span><span class="p">,</span>
            <span class="n">code</span>  <span class="o">=&gt;</span> <span class="nv">$code_count</span><span class="p">,</span>
            <span class="n">count</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">},</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="c1"># render可以接收参数，并且默认把$self带进去，具体key是handler</span>
    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;index.html&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">table</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@res_tbl</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@res_map</span> <span class="p">});</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">code_count</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$key_field</span><span class="p">,</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$interval</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
        <span class="nb">index</span> <span class="o">=&gt;</span> <span class="s">&quot;$index&quot;</span><span class="p">,</span>
        <span class="n">type</span>  <span class="o">=&gt;</span> <span class="s">&quot;$type&quot;</span><span class="p">,</span>
        <span class="n">size</span>  <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">query</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="n">range</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="s">&#39;@timestamp&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">from</span> <span class="o">=&gt;</span> <span class="s">&quot;now-$interval&quot;</span><span class="p">,</span>
                    <span class="n">to</span>   <span class="o">=&gt;</span> <span class="s">&quot;now&quot;</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="n">facets</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&quot;code&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">facet_filter</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">term</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="nv">$key_field</span> <span class="o">=&gt;</span> <span class="s">&quot;$key&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="n">terms</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">field</span> <span class="o">=&gt;</span> <span class="s">&quot;status&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">facets</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">code</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">terms</span><span class="p">}}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$result</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">term</span><span class="p">}}</span> <span class="o">=</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">count</span><span class="p">};</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">#画图数据API类，因为响应的是Ajax请求，所以这里开启了async，不过其实没意义了。因为这个ElasticSearch代码不是async格式的。应该改造用ElasticSearch::Transport::AEHTTP才能做到全程async。</span>
<span class="nb">package</span> <span class="n">ChartHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(Tatsumaki::Handler)</span><span class="p">;</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">asynchronous</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="k">use</span> <span class="n">JSON</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">post</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$api</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;api&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s">&#39;term&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s">&#39;oh&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;status&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s">&#39;200&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$field</span> <span class="o">=</span>  <span class="nv">$key</span> <span class="ow">eq</span> <span class="s">&#39;oh&#39;</span> <span class="p">?</span> <span class="s">&#39;upstreamtime&#39;</span> <span class="p">:</span> <span class="s">&#39;responsetime&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
        <span class="nb">index</span> <span class="o">=&gt;</span> <span class="s">&quot;$index&quot;</span><span class="p">,</span>
        <span class="n">type</span>  <span class="o">=&gt;</span> <span class="s">&quot;$type&quot;</span><span class="p">,</span>
        <span class="n">size</span>  <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">query</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="n">match_all</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="p">}</span>
        <span class="p">},</span>
        <span class="n">facets</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s">&quot;chart&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">facet_filter</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="ow">and</span> <span class="o">=&gt;</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="n">term</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                <span class="n">status</span> <span class="o">=&gt;</span> <span class="nv">$status</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="nv">$api</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">},</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="n">date_histogram</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="n">value_field</span> <span class="o">=&gt;</span> <span class="nv">$field</span><span class="p">,</span>
                    <span class="n">key_field</span> <span class="o">=&gt;</span> <span class="s">&#39;@timestamp&#39;</span><span class="p">,</span>
                    <span class="n">interval</span> <span class="o">=&gt;</span> <span class="s">&quot;1m&quot;</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">@result</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;facets&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;chart&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;entries&#39;</span><span class="p">}}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nb">push</span> <span class="nv">@result</span><span class="p">,</span> <span class="p">{</span>
           <span class="nb">time</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">},</span>
           <span class="n">count</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;count&#39;</span><span class="p">},</span>
           <span class="n">mean</span> <span class="o">=&gt;</span> <span class="nb">sprintf</span> <span class="s">&quot;%.3f&quot;</span><span class="p">,</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;mean&#39;</span><span class="p">}</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="n">header</span><span class="p">(</span><span class="s">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;application/json&#39;</span><span class="p">);</span>
    <span class="n">to_json</span><span class="p">(</span><span class="o">\</span><span class="nv">@result</span><span class="p">);</span>
<span class="p">};</span>
<span class="c1">#主函数</span>
<span class="nb">package</span> <span class="n">main</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Basename</span><span class="p">;</span>
<span class="c1">#通过Tatsumaki::Application绑定urlpath到不同的类上。注意下面listhandler那里用的正则捕获。对，上面类里传参就是这么来的。注意最多不超过$9。</span>
<span class="k">my</span> <span class="nv">$app</span> <span class="o">=</span> <span class="nn">Tatsumaki::</span><span class="n">Application</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">([</span>
    <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;MainHandler&#39;</span><span class="p">,</span>
    <span class="s">&#39;/api/chartdata&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;ChartHandler&#39;</span><span class="p">,</span>
    <span class="s">&#39;/api/(\w+)/(\w+)/(\w+)&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;ListHandler&#39;</span><span class="p">,</span>
<span class="p">]);</span>
<span class="c1">#指定template和static的路径。类似Dancer里的views和public</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="n">template_path</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s">&#39;/templates&#39;</span><span class="p">);</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="n">static_path</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s">&#39;/static&#39;</span><span class="p">);</span>
<span class="c1">#psgi app组建完成</span>
<span class="k">return</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="n">psgi_app</span><span class="p">;</span>
<span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>static里都是bootstrap的东西就不贴了。然后说说template。目前Tatsumaki只支持Text::MicroTemplate::File一种template，当然自己在handler里调用其他的template然后返回字符串也行。不过其实Text::MicroTemplate也蛮强大的。下面上例子：</p>
<div class="highlight"><pre><code class="html">%# 这就是Text::MicroTemplate强大的地方了，行首加个百分号就可以直接使用perl而不像TT那样尽量搞自己的语法
%# 配合render传来的handler(前面说了是类$self)，整个环境全可以任意调用。
% my $mapping = $_[0]-&gt;{&#39;mapping&#39;};
% my $table = $_[0]-&gt;{&#39;table&#39;};
%# 比如这里其实就是通过handler调用request了。
% my $group = $_[0]-&gt;{handler}-&gt;args-&gt;[0];
% my @codes = qw(200 206 302 304 400 403 404 499 502 503 504);
<span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span>
<span class="cp">        &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;title&gt;</span>Bubble -- a perl webui for logstash <span class="err">&amp;</span> elasticsearch<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/bootstrap/css/bootstrap.css&quot;</span> <span class="nt">&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/fontawesome/css/font-awesome.css&quot;</span> <span class="nt">&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/css/style.css&quot;</span> <span class="nt">&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/amcharts/style.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container-fluid&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row-fluid&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span3&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;well sidebar-nav&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav nav-list&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;nav-header&quot;</span><span class="nt">&gt;</span>查询<span class="nt">&lt;/li&gt;</span>
% for my $property ( @{ $mapping } ) {
%     if ( ref( $property ) eq &#39;ARRAY&#39; ) {
          <span class="nt">&lt;li&gt;</span>@fields<span class="nt">&lt;/li&gt;</span>
%          for ( @{$property} ) {
          <span class="nt">&lt;li&gt;</span>  - <span class="err">&lt;</span>%= $_-&gt;{&#39;name&#39;} %&gt; <span class="err">&lt;</span>%= $_-&gt;{&#39;type&#39;} %&gt;<span class="nt">&lt;/li&gt;</span>
%          }
%     } elsif ( $property-&gt;{&#39;type&#39;} ) {
          <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= $property-&gt;{&#39;name&#39;} %&gt; <span class="err">&lt;</span>%= $property-&gt;{&#39;type&#39;} %&gt;<span class="nt">&lt;/li&gt;</span>
%     }
% }
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span9&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;search&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;control-group&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;controls docs-input-sizes&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-small inline&quot;</span> <span class="na">id=</span><span class="s">&quot;esapi&quot;</span> <span class="na">name=</span><span class="s">&quot;api&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;option&gt;</span>匹配方式<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;option&gt;</span>prefix<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;option&gt;</span>term<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;option&gt;</span>text<span class="nt">&lt;/option&gt;</span>
            <span class="nt">&lt;/select&gt;</span>
            <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-small inline&quot;</span> <span class="na">id=</span><span class="s">&quot;eskey&quot;</span> <span class="na">name=</span><span class="s">&quot;key&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;option&gt;</span>查询列<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;option&gt;</span>oh<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;option&gt;</span>url<span class="nt">&lt;/option&gt;</span>
            <span class="nt">&lt;/select&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-big inline&quot;</span> <span class="na">id=</span><span class="s">&quot;esvalue&quot;</span> <span class="na">name=</span><span class="s">&quot;value&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;查询文本&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-small inline&quot;</span> <span class="na">id=</span><span class="s">&quot;esstatus&quot;</span> <span class="na">name=</span><span class="s">&quot;status&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;指定状态&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary&quot;</span> <span class="na">onclick=</span><span class="s">&quot;genchart()&quot;</span><span class="nt">&gt;</span>查看<span class="nt">&lt;/button&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chartdiv&quot;</span> <span class="na">style=</span><span class="s">&quot;display:none; width: 100%; height: 500px;&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;estable&quot;</span><span class="nt">&gt;</span>
% if ( $table ) {
        <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;table table-striped table-bordered table-condensed&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;thead&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
              <span class="nt">&lt;th&gt;</span><span class="err">&lt;</span>%= $group %&gt;<span class="nt">&lt;/th&gt;</span>
              <span class="nt">&lt;th&gt;</span>平均响应时间<span class="nt">&lt;/th&gt;</span>
              <span class="nt">&lt;th&gt;</span>最大响应时间<span class="nt">&lt;/th&gt;</span>
              <span class="nt">&lt;th&gt;</span>下载数<span class="nt">&lt;/th&gt;</span>
%     for ( @codes ) {
              <span class="nt">&lt;th&gt;</span><span class="err">&lt;</span>%= $_ %&gt;<span class="nt">&lt;/th&gt;</span>
%     }
            <span class="nt">&lt;/tr&gt;</span>
          <span class="nt">&lt;/thead&gt;</span>
          <span class="nt">&lt;tbody&gt;</span>
%     for my $list ( @{ $table } ) {
            <span class="nt">&lt;tr&gt;</span>
              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;key&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>
              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;mean&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>
              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;max&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>
              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;count&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>
%         for ( @codes ) {
%             if ( $list-&gt;{&#39;code&#39;}-&gt;{$_} ) {
              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;code&#39;}-&gt;{$_} %&gt;<span class="nt">&lt;/td&gt;</span>
%             } else {
              <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
%             }
%         }
            <span class="nt">&lt;/tr&gt;</span>
%     }
          <span class="nt">&lt;/tbody&gt;</span>
        <span class="nt">&lt;/table&gt;</span>
% }
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/javascripts/jquery-1.7.2.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/bootstrap/js/bootstrap.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/amcharts/amstock.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
  <span class="kd">var</span> <span class="nx">chart</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">chartProvider</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">function</span> <span class="nx">createStockChart</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmStockChart</span><span class="p">();</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">pathToImages</span> <span class="o">=</span> <span class="s2">&quot;/static/amcharts/images/&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">categoryAxesSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">CategoryAxesSettings</span><span class="p">();</span>
    <span class="nx">categoryAxesSettings</span><span class="p">.</span><span class="nx">parseDates</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">categoryAxesSettings</span><span class="p">.</span><span class="nx">minPeriod</span> <span class="o">=</span> <span class="s2">&quot;mm&quot;</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">categoryAxesSettings</span> <span class="o">=</span> <span class="nx">categoryAxesSettings</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">dataSet</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">DataSet</span><span class="p">();</span>
    <span class="nx">dataSet</span><span class="p">.</span><span class="nx">fieldMappings</span> <span class="o">=</span> <span class="p">[{</span>
      <span class="nx">fromField</span> <span class="o">:</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
      <span class="nx">toField</span> <span class="o">:</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="nx">fromField</span> <span class="o">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
      <span class="nx">toField</span> <span class="o">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="p">}];</span>
    <span class="nx">dataSet</span><span class="p">.</span><span class="nx">dataProvider</span> <span class="o">=</span> <span class="nx">chartProvider</span><span class="p">;</span>
    <span class="nx">dataSet</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">=</span> <span class="s2">&quot;date&quot;</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">dataSets</span> <span class="o">=</span> <span class="p">[</span><span class="nx">dataSet</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">stockPanel1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockPanel</span><span class="p">();</span>
    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">percentHeight</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">valueAxis1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>
    <span class="nx">valueAxis1</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">;</span>
    <span class="nx">valueAxis1</span><span class="p">.</span><span class="nx">axisColor</span> <span class="o">=</span> <span class="s2">&quot;#999999&quot;</span><span class="p">;</span>
    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis1</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">graph1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockGraph</span><span class="p">();</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">valueField</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">;</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;mean(ms)&quot;</span><span class="p">;</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;smoothedLine&quot;</span><span class="p">;</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">lineColor</span> <span class="o">=</span> <span class="s2">&quot;#999999&quot;</span><span class="p">;</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>
    <span class="nx">graph1</span><span class="p">.</span><span class="nx">useDataSetColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addStockGraph</span><span class="p">(</span><span class="nx">graph1</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">stockLegend1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockLegend</span><span class="p">();</span>
    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">stockLegend</span> <span class="o">=</span> <span class="nx">stockLegend1</span><span class="p">;</span>
    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">drawingIconsEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">stockPanel2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockPanel</span><span class="p">();</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">percentHeight</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">marginTop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">showCategoryAxis</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">valueAxis2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>
    <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">gridAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">axisThickness</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis2</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">graph2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockGraph</span><span class="p">();</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">valueAxis</span> <span class="o">=</span> <span class="nx">valueAxis2</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">valueField</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">balloonText</span> <span class="o">=</span> <span class="s2">&quot;[[value]]%&quot;</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;column&quot;</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">cornerRadiusTop</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">lineColor</span> <span class="o">=</span> <span class="s2">&quot;#FCD202&quot;</span><span class="p">;</span>
    <span class="nx">graph2</span><span class="p">.</span><span class="nx">useDataSetColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">addStockGraph</span><span class="p">(</span><span class="nx">graph2</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">stockLegend2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockLegend</span><span class="p">();</span>
    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">stockLegend</span> <span class="o">=</span> <span class="nx">stockLegend2</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">panels</span> <span class="o">=</span> <span class="p">[</span><span class="nx">stockPanel1</span><span class="p">,</span> <span class="nx">stockPanel2</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">sbsettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartScrollbarSettings</span><span class="p">();</span>
    <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="nx">graph2</span><span class="p">;</span>
    <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">graphType</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span><span class="p">;</span>
    <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">chartScrollbarSettings</span> <span class="o">=</span> <span class="nx">sbsettings</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cursorSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartCursorSettings</span><span class="p">();</span>
    <span class="nx">cursorSettings</span><span class="p">.</span><span class="nx">valueBalloonsEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">chartCursorSettings</span> <span class="o">=</span> <span class="nx">cursorSettings</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#chartdiv&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;chartdiv&quot;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">genchart</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;/api/chartdata&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">api</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#esapi&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="nx">key</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#eskey&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="nx">status</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#esstatus&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="nx">value</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#esvalue&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">time</span><span class="p">);</span>
        <span class="nx">chartProvider</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
          <span class="nx">date</span><span class="o">:</span> <span class="nx">date</span><span class="p">,</span>
          <span class="nx">count</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">count</span><span class="p">,</span>
          <span class="nx">mean</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">mean</span><span class="p">,</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="nx">createStockChart</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">};</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>效果如下：</p>
<p><img src="/images/uploads/tatsumaki.png" alt="查询表格并提交最多次的url绘图" title="查询表格并提交最多次的url绘图" /></p>
<hr />
<p><strong>2012 年 12 月 30 日附注：</strong></p>
<p>更好的纯 js 版本已经作为独立的 elasticsearch-plugin 项目发布在 github 上。地址：<a href="https://github.com/chenryn/elasticsearch-logstash-faceter">https://github.com/chenryn/elasticsearch-logstash-faceter</a> 。欢迎大家试用!!</p>
      <a href="/2012/11/22/tatsumaki-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/11/22/gnuplot-to-draw-multi-graph" title="用gnuplot绘制多图" rel="bookmark">用gnuplot绘制多图</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-11-22 00:00:00 +0800">22 Nov 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>以前已经提过多次gnuplot的简便快捷了。不过大多是最基本的单图上画条线之类的。这次碰到需求，稍微help了一下在一个图上画多个区域。主要需要注意的就是set size的定位点到底从什么角度算，说实话蛮麻烦的。</p>
<p>上文件：</p>
<div class="highlight"><pre><code class="bash">    <span class="nv">result</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">begin</span><span class="o">=</span><span class="sb">`</span>head -n 1 <span class="nv">$result</span>.txt | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
    <span class="nv">end</span><span class="o">=</span><span class="sb">`</span>tail -n 1 <span class="nv">$result</span>.txt | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
    cat &gt; conf/<span class="nv">$result</span>.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">    set terminal png</span>
<span class="s">    set output &quot;png/$result.png&quot;</span>
<span class="s">    set multiplot</span>
<span class="s">    set xdata time</span>
<span class="s">    set timefmt &quot;%H:%M:%S&quot;</span>
<span class="s">    set format x &quot;%M:%S&quot;</span>
<span class="s">    set size 1.0,0.5</span>
<span class="s">    set origin 0.0,0.5</span>
<span class="s">    set ylabel &quot;KRps&quot;</span>
<span class="s">    unset xtics</span>
<span class="s">    plot &quot;res/$result.txt&quot; using 1:(\$2/1000) with points linewidth 2 title &quot;&quot;</span>
<span class="s">    set origin 0.0,0.0</span>
<span class="s">    set size 1.0,0.35</span>
<span class="s">    set xtics</span>
<span class="s">    set xrange [&quot;$begin&quot;:&quot;$end&quot;]</span>
<span class="s">    set ylabel &quot;%usr:sys:irq&quot;</span>
<span class="s">    plot &quot;res/$result.csv&quot; using 2:(\$3+\$4+\$8) with boxes fs solid 1.0 title &quot;&quot;, \</span>
<span class="s">         &quot;res/$result.csv&quot; using 2:(\$3+\$4) with boxes fs solid 1.0 title &quot;&quot;, \</span>
<span class="s">         &quot;res/$result.csv&quot; using 2:3 with boxes fs solid 1.0 title &quot;&quot;</span>
<span class="s">    set origin 0.0,0.3</span>
<span class="s">    set size 1.0,0.25</span>
<span class="s">    unset xtics</span>
<span class="s">    set ylabel &quot;MBps&quot;</span>
<span class="s">    plot &quot;res/$result.csv&quot; using 2:(\$11/1024/1024) with boxes fs solid 0.7 linecolor rgb &quot;green&quot; title &quot;&quot;, \</span>
<span class="s">         &quot;res/$result.csv&quot; using 2:(\$12/1024/1024) with lines linewidth 2 linecolor rgb &quot;blue&quot; title &quot;&quot;</span>
<span class="s">    EOF</span>
    cat conf/<span class="nv">$result</span>.conf | gnuplot
</code></pre></div>
<p>注意：新增了一行xrange配置，如果不指定这个几张小图的xtics会不统一，而上面两张图的xtics又已经被unset了，结果看起来就跟不同步似的。</p>
<p>效果如下：
<img src="/images/uploads/gnuplot-multi.png" alt="图片" /></p>
      <a href="/2012/11/22/gnuplot-to-draw-multi-graph" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/11/19/syslog-realtime-warning-to-speech" title="syslog实时报警"说出来"" rel="bookmark">syslog实时报警"说出来"</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-11-19 00:00:00 +0800">19 Nov 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>syslog应该是大家最常用的，也基本可以说是最重要的服务器监控信息来源了。</p>
<p>syslog的传输，应该不用再说，哪怕在百度里搜都有足够多的靠谱结果。而关于报警的问题，之前我也写了好几篇，比如<a href="/2012/10/17/juggernaut-for-syslog-check">《用Juggernaut实时推送syslog分析结果》</a>讲了如何用websocket推送结果，<a href="/2012/11/09/chrome-app-demo">《Chrome的APP简单用法》</a>讲了如何利用chrome后台页面开机自动运行进行桌面提示。</p>
<p>那么，如果我既不想开网页看，也不好安装chrome浏览器，有没有够简便的办法接收呢？有！Linux社区从来不缺乏各种神奇工具。下面介绍两个同样强大的提示办法。</p>
<p>第一个，非chrome型的桌面通知notify-send命令，依发行版不同，可能属于libnotify-tools或者libnotify-bin包，自己搜索即可；</p>
<p>第二个，Espeak命令，著名Text To Speech软件，虽然电子音怪了点，但是支持中文而且文件很小，同样直接在源里安装即可。</p>
<p>下面就是如何把这两个强大的工具和server结合起来的问题了，出动胶水语言代表perl。代码如下：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Mojo::</span><span class="n">UserAgent</span><span class="p">;</span>
<span class="k">use</span> <span class="n">JSON</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$ua</span> <span class="o">=</span> <span class="nn">Mojo::</span><span class="n">UserAgent</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
<span class="k">my</span> <span class="p">(</span> <span class="nv">$sid</span><span class="p">,</span> <span class="nv">$ws</span> <span class="p">);</span>
<span class="c1"># 本来用Protocol::WebSocket::Handshake::Client模块，指定IP和端口，自动会获取sid拼ws地址的，不过测试发现open后没反应。奇怪</span>
<span class="n">LABEL:</span>
<span class="nv">$sid</span> <span class="o">=</span> <span class="p">(</span><span class="o">+</span><span class="nb">split</span><span class="p">(</span><span class="sr">/:/</span><span class="p">,</span> <span class="nv">$ua</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;http://syslog.domain.com:8080/socket.io/1/&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span>
<span class="nv">$ws</span> <span class="o">=</span> <span class="s">&quot;ws://syslog.domain.com:8080/socket.io/1/websocket/${sid}&quot;</span><span class="p">;</span>
<span class="nv">$ua</span><span class="o">-&gt;</span><span class="n">websocket</span><span class="p">(</span> <span class="nv">$ws</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$ua</span><span class="p">,</span> <span class="nv">$tx</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="nv">$tx</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&#39;3:::{&quot;type&quot;:&quot;subscribe&quot;,&quot;channel&quot;:&quot;syslog&quot;}&#39;</span><span class="p">);</span>
    <span class="nv">$tx</span><span class="o">-&gt;</span><span class="n">on</span><span class="p">(</span><span class="n">finish</span>  <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="c1"># 很怪的是，mojo::useragent的websocket client总是在不到一分钟内就进入on_finish状态，所以这里只好返回重连</span>
        <span class="nn">Mojo::</span><span class="n">IOLoop</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span>
        <span class="nb">goto</span> <span class="n">LABEL</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nv">$tx</span><span class="o">-&gt;</span><span class="n">on</span><span class="p">(</span><span class="n">message</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$tx</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">length</span><span class="p">(</span> <span class="nv">$msg</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$syslog</span> <span class="o">=</span> <span class="n">from_json</span><span class="p">(</span> <span class="nb">substr</span><span class="p">(</span> <span class="nv">$msg</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">);</span>
            <span class="n">notify</span><span class="p">(</span> <span class="nv">$syslog</span> <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">});</span>
<span class="p">});</span>
<span class="nn">Mojo::</span><span class="n">IOLoop</span><span class="o">-&gt;</span><span class="n">start</span> <span class="k">unless</span> <span class="nn">Mojo::</span><span class="n">IOLoop</span><span class="o">-&gt;</span><span class="n">is_running</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">notify</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">eq</span> <span class="s">&#39;btn&#39;</span><span class="p">;</span>
    <span class="nb">exec</span><span class="p">(</span><span class="s">&quot;notify-send \&quot;$data-&gt;[0] $data-&gt;[1]\&quot; \&quot;$data-&gt;[3] $data-&gt;[4]\&quot;&quot;</span><span class="p">);</span>
    <span class="c1"># 注意设定-s 120，默认是175，念得飞快</span>
    <span class="nb">exec</span><span class="p">(</span><span class="s">&quot;espeak -vzh+f2 -s 120 \&quot;$data-&gt;[1]\&quot;&quot;</span><span class="p">);</span> <span class="c1"># 指定中文报ip，不然很难听懂</span>
    <span class="c1"># f是女生，m是男声，至于第几个声音，我没听出来多大差别，都跟九十年代初电影里的机器人一样</span>
    <span class="nb">exec</span><span class="p">(</span><span class="s">&quot;espeak -ven+m2 -s 120 \&quot;$data-&gt;[3] $data-&gt;[4]\&quot;&quot;</span><span class="p">);</span> <span class="c1"># 指定英文报内容，不然用中文的声音念更难听懂</span>
<span class="p">};</span>
</code></pre></div>
<p>以上抛砖引玉，大家可以试试Ekho(余音)，这是国人开发的真人语音TTS开源软件，还支持粤语，文言文等选择，汗……</p>
      <a href="/2012/11/19/syslog-realtime-warning-to-speech" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/11/18/data-visualization-with-elasticsearch-and-protovis" title="【翻译】用ElasticSearch和Protovis实现数据可视化" rel="bookmark">【翻译】用ElasticSearch和Protovis实现数据可视化</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-11-18 00:00:00 +0800">18 Nov 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>搜索引擎最重要的目的，嗯，不出意料就是<code>搜索</code>。你传给它一个请求，然后它依照相关性返回你一串匹配的结果。我们可以根据自己的内容创造各种请求结构，试验各种不同的分析器，搜索引擎都会努力尝试提供最好的结果。</p>
<p>不过，一个现代的全文搜索引擎可以做的比这个更多。因为它的核心是基于一个为了高效查询匹配文档而高度优化过的数据结构——<a href="http://en.wikipedia.org/wiki/Index_\(search_engine\)#Inverted_indices">倒排索引</a>。它也可以为我们的数据完成复杂的<code>聚合</code>运算，在这里我们叫它facets。(不好翻译，后文对这个单词都保留英文)</p>
<p>facets通常的目的是提供给用户某个方面的导航或者搜索。 当你在网上商店搜索“相机”，你可以选择不同的制造商，价格范围或者特定功能来定制条件，这应该就是点一下链接的事情，而不是通过修改一长串查询语法。</p>
<p>一个<a href="http://blog.linkedin.com/2009/12/14/linkedin-faceted-search/">LinkedIn的导航</a>范例如下图所示：</p>
<p><img src="http://www.elasticsearch.cn/blog/images/dashboards/linkedin-faceted-search.png" alt="图片1" /></p>
<p>Facet搜索为数不多的几个可以把强大的请求能力开放给最终用户的办法之一，详见Moritz Stefaner的试验<a href="http://well-formed-data.net/archives/54/elastic-lists">“Elastic Lists”</a>，或许你会有更多灵感。</p>
<p>但是，除了链接和复选框，其实我们还能做的更多。比如利用这些数据画图，而这就是我们在这篇文章中要讲的。</p>
<h1 id="section">实时仪表板</h1>
<p>在几乎所有的分析、监控和数据挖掘服务中，或早或晚的你都会碰到这样的需求：“我们要一个仪表板！”。因为大家都爱仪表板，可能因为真的有用，可能单纯因为它漂亮~这时候，我们不用写任何<a href="http://en.wikipedia.org/wiki/Online_analytical_processing">OLAP</a>实现，用facets就可以完成一个很漂亮很给力的分析引擎。</p>
<p>下面的截图就是从一个<a href="http://ataxosocialinsider.cz/">社交媒体监控应用</a>上获取的。这个应用不单用ES来搜索和挖掘数据，还通过交互式仪表板提供数据聚合功能。</p>
<p><img src="http://www.elasticsearch.cn/blog/images/dashboards/dashboard.png" alt="图片2" /></p>
<p>当用户深入数据，添加一个关键字，使用一个自定义查询，所有的图都会实时更新，这就是facet聚合的工作方式。仪表板上不是数据定期计算好的的静态快照，而是一个用于数据探索的真正的交互式工具。</p>
<p>在本文中，我们将会学习到怎样从ES中获取数据，然后怎么创建这些图表。</p>
<h1 id="terms-facet">关系聚合(terms facet)的饼图</h1>
<p>第一个图，我们用ES中比较简单的<a href="http://elasticsearch.org/guide/reference/api/search/facets/terms-facet.html">terms</a>facet来做。这个facet会返回一个字段中最常见的词汇和它的计数值。</p>
<p>首先我们先插入一些数据。</p>
<div class="highlight"><pre><code class="bash">curl -X DELETE <span class="s2">&quot;http://localhost:9200/dashboard&quot;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;</span>
<span class="s1">             { &quot;title&quot; : &quot;One&quot;,</span>
<span class="s1">               &quot;tags&quot;  : [&quot;ruby&quot;, &quot;java&quot;, &quot;search&quot;]}</span>
<span class="s1">&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;</span>
<span class="s1">             { &quot;title&quot; : &quot;Two&quot;,</span>
<span class="s1">               &quot;tags&quot;  : [&quot;java&quot;, &quot;search&quot;] }</span>
<span class="s1">&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;</span>
<span class="s1">             { &quot;title&quot; : &quot;Three&quot;,</span>
<span class="s1">               &quot;tags&quot;  : [&quot;erlang&quot;, &quot;search&quot;] }</span>
<span class="s1">&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;</span>
<span class="s1">             { &quot;title&quot; : &quot;Four&quot;,</span>
<span class="s1">               &quot;tags&quot;  : [&quot;search&quot;] }</span>
<span class="s1">&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/_refresh&quot;</span>
</code></pre></div>
<p>你们都看到了，我们存储了一些文章的标签，每个文章可以多个标签，数据以JSON格式发送，这也是ES的文档格式。</p>
<p>现在，要知道文档的十大标签，我们只需要简单的请求：</p>
<div class="highlight"><pre><code class="bash">curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/_search?pretty=true&quot;</span> -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;query&quot; : { &quot;match_all&quot; : {} },</span>
<span class="s1">    &quot;facets&quot; : {</span>
<span class="s1">        &quot;tags&quot; : { &quot;terms&quot; : {&quot;field&quot; : &quot;tags&quot;, &quot;size&quot; : 10} }</span>
<span class="s1">    }</span>
<span class="s1">}</span>
<span class="s1">&#39;</span>
</code></pre></div>
<p>你看到了，我接受所有文档，然后定义一个terms facet叫做“tags”。这个请求会返回如下样子的数据：</p>
<div class="highlight"><pre><code class="javascript"><span class="p">{</span>
    <span class="s2">&quot;took&quot;</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="c1">// ... snip ...</span>
    <span class="s2">&quot;hits&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;total&quot;</span> <span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="c1">// ... snip ...</span>
    <span class="p">},</span>
    <span class="s2">&quot;facets&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;_type&quot;</span> <span class="o">:</span> <span class="s2">&quot;terms&quot;</span><span class="p">,</span>
            <span class="s2">&quot;missing&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;terms&quot;</span> <span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="s2">&quot;term&quot;</span> <span class="o">:</span> <span class="s2">&quot;search&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span> <span class="o">:</span> <span class="mi">4</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;term&quot;</span> <span class="o">:</span> <span class="s2">&quot;java&quot;</span><span class="p">,</span>   <span class="s2">&quot;count&quot;</span> <span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;term&quot;</span> <span class="o">:</span> <span class="s2">&quot;ruby&quot;</span><span class="p">,</span>   <span class="s2">&quot;count&quot;</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;term&quot;</span> <span class="o">:</span> <span class="s2">&quot;erlang&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>JSON中<code>facets</code>部分是我们关心的，特别是<code>facets.tags.terms</code>数组。它告诉我们有四篇文章打了search标签，两篇java标签，等等…….(当然，我们或许应该给请求添加一个<code>size</code>参数跳过前面的结果)</p>
<p>这种比例类型的数据最合适的可视化方案就是饼图，或者它的变体：油炸圈饼图。最终结果如下(你可能希望看这个<a href="http://www.elasticsearch.cn/blog/assets/dashboards/donut.html">可运行的实例</a>)：</p>
<p><img src="http://www.elasticsearch.cn/blog/images/dashboards/donut_chart.png" alt="图片3" /></p>
<p>我们将使用<a href="http://vis.stanford.edu/protovis/">Protovis</a>一个JavaScript的数据可视化工具集。Protovis是100%开源的，你可以想象它是数据可视化方面的RoR。和其他类似工具形成鲜明对比的是，它没有附带一组图标类型来供你“选择”。而是定义了一组原语和一个灵活的DSL，这样你可以非常简单的创建自定义的可视化。创建<a href="http://vis.stanford.edu/protovis/ex/pie.html">饼图</a>就非常简单。</p>
<p>因为ES返回的是JSON数据，我们可以通过Ajax调用加载它。不要忘记你可以clone或者下载实例的<a href="https://gist.github.com/966338">全部源代码</a>。</p>
<p>首先需要一个HTML文件来容纳图标然后从ES里加载数据：</p>
<div class="highlight"><pre><code class="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>ElasticSearch Terms Facet Donut Chart<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- Load JS libraries --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;jquery-1.5.1.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;protovis-r3.2.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;donut.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script&gt;</span>
        <span class="nx">$</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">load_data</span><span class="p">();</span> <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">load_data</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>   <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://localhost:9200/dashboard/article/_search?pretty=true&#39;</span>
                     <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span>
                     <span class="p">,</span> <span class="nx">data</span> <span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
                           <span class="s2">&quot;query&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;match_all&quot;</span> <span class="o">:</span> <span class="p">{}</span> <span class="p">},</span>
                           <span class="s2">&quot;facets&quot;</span> <span class="o">:</span> <span class="p">{</span>
                               <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">{</span>
                                   <span class="s2">&quot;terms&quot;</span> <span class="o">:</span> <span class="p">{</span>
                                       <span class="s2">&quot;field&quot;</span> <span class="o">:</span> <span class="s2">&quot;tags&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;size&quot;</span>  <span class="o">:</span> <span class="s2">&quot;10&quot;</span>
                                   <span class="p">}</span>
                               <span class="p">}</span>
                           <span class="p">}</span>
                       <span class="p">})</span>
                     <span class="p">,</span> <span class="nx">dataType</span> <span class="o">:</span> <span class="s1">&#39;json&#39;</span>
                     <span class="p">,</span> <span class="nx">processData</span><span class="o">:</span> <span class="kc">false</span>
                     <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="nx">statusText</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
                           <span class="k">return</span> <span class="nx">display_chart</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
                       <span class="p">}</span>
                     <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                           <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Error while loading data from ElasticSearch&quot;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
                           <span class="k">throw</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
                       <span class="p">}</span>
            <span class="p">});</span>
            <span class="kd">var</span> <span class="nx">display_chart</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">Donut</span><span class="p">().</span><span class="nx">data</span><span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">facets</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">terms</span><span class="p">).</span><span class="nx">draw</span><span class="p">();</span>
            <span class="p">};</span>
        <span class="p">};</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="c">&lt;!-- Placeholder for the chart --&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chart&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>文档加载后，我们通过Ajax收到和之前<code>curl</code>测试中一样的facet。在jQuery的Ajaxcallback里我们通过封装的<code>display_chart()</code>把返回的JSON传给<code>Donut()</code>函数.</p>
<p><code>Donut()</code>函数及注释如下： </p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// =====================================================================================================</span>
<span class="c1">// A donut chart with Protovis - See http://vis.stanford.edu/protovis/ex/pie.html</span>
<span class="c1">// =====================================================================================================</span>
<span class="kd">var</span> <span class="nx">Donut</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dom_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">dom_id</span><span class="p">)</span>  <span class="p">{</span>                <span class="c1">// Set the default DOM element ID to bind</span>
        <span class="nx">dom_id</span> <span class="o">=</span> <span class="s1">&#39;chart&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>                         <span class="c1">// Set the data for the chart</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">json</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">entries</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// Sort the data by term names, so the</span>
            <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">term</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">term</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>            <span class="c1">// color scheme for wedges is preserved</span>
        <span class="p">}),</span>                                             <span class="c1">// with any order</span>
        <span class="nx">values</span>  <span class="o">=</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">entries</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>         <span class="c1">// Create an array holding just the counts</span>
            <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
        <span class="p">});</span>
        <span class="c1">// console.log(&#39;Drawing&#39;, entries, values);</span>
        <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>                                    <span class="c1">// Dimensions and color scheme for the chart</span>
            <span class="nx">h</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
            <span class="nx">colors</span> <span class="o">=</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">Colors</span><span class="p">.</span><span class="nx">category10</span><span class="p">().</span><span class="nx">range</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">vis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">Panel</span><span class="p">()</span>                        <span class="c1">// Create the basis panel</span>
            <span class="p">.</span><span class="nx">width</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">margin</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nx">vis</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Wedge</span><span class="p">)</span>                               <span class="c1">// Create the &quot;wedges&quot; of the chart</span>
            <span class="p">.</span><span class="nx">def</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>                          <span class="c1">// Auxiliary variable to hold mouse over state</span>
            <span class="p">.</span><span class="nx">data</span><span class="p">(</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">)</span>               <span class="c1">// Pass the normalized data to Protovis</span>
            <span class="p">.</span><span class="nx">left</span><span class="p">(</span><span class="nx">w</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>                                  <span class="c1">// Set-up chart position and dimension</span>
            <span class="p">.</span><span class="nx">top</span><span class="p">(</span><span class="nx">w</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">outerRadius</span><span class="p">(</span><span class="nx">w</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">innerRadius</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>                            <span class="c1">// Create a &quot;donut hole&quot; in the center</span>
            <span class="p">.</span><span class="nx">angle</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>                       <span class="c1">// Compute the &quot;width&quot; of the wedge</span>
                <span class="k">return</span> <span class="nx">d</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">;</span>
             <span class="p">})</span>
            <span class="p">.</span><span class="nx">strokeStyle</span><span class="p">(</span><span class="s2">&quot;#fff&quot;</span><span class="p">)</span>                        <span class="c1">// Add white stroke</span>
            <span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s2">&quot;mouseover&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>            <span class="c1">// On &quot;mouse over&quot;, set the &quot;wedge&quot; as active</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">active</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">cursor</span><span class="p">(</span><span class="s1">&#39;pointer&#39;</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
             <span class="p">})</span>
            <span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span>  <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>            <span class="c1">// On &quot;mouse out&quot;, clear the active state</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">active</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s2">&quot;mousedown&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>           <span class="c1">// On &quot;mouse down&quot;, perform action,</span>
                <span class="kd">var</span> <span class="nx">term</span> <span class="o">=</span> <span class="nx">entries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">term</span><span class="p">;</span>    <span class="c1">// such as filtering the results...</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Filter the results by &#39;&quot;</span><span class="o">+</span><span class="nx">term</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="p">));</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Dot</span><span class="p">)</span>                <span class="c1">// Add the left part of he &quot;inline&quot; label,</span>
                                                        <span class="c1">// displayed inside the donut &quot;hole&quot;</span>
            <span class="p">.</span><span class="nx">visible</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>                      <span class="c1">// The label is visible when its wedge is active</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                       <span class="p">.</span><span class="nx">active</span><span class="p">()</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">fillStyle</span><span class="p">(</span><span class="s2">&quot;#222&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">lineWidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">radius</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;center&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Bar</span><span class="p">)</span>               <span class="c1">// Add the middle part of the label</span>
            <span class="p">.</span><span class="nx">fillStyle</span><span class="p">(</span><span class="s2">&quot;#222&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">width</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>                        <span class="c1">// Compute width:</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">d</span><span class="o">*</span><span class="mi">100</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>               <span class="c1">// add pixels for percents</span>
                              <span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span>
                       <span class="mi">10</span> <span class="o">+</span>                             <span class="c1">// add pixels for glyphs (%, etc)</span>
                       <span class="nx">entries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">]</span>              <span class="c1">// add pixels for letters (very rough)</span>
                           <span class="p">.</span><span class="nx">term</span><span class="p">.</span><span class="nx">length</span><span class="o">*</span><span class="mi">9</span><span class="p">;</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">top</span><span class="p">((</span><span class="nx">w</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mi">14</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Dot</span><span class="p">)</span>                <span class="c1">// Add the right part of the label</span>
            <span class="p">.</span><span class="nx">fillStyle</span><span class="p">(</span><span class="s2">&quot;#222&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">lineWidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">radius</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>          <span class="c1">// Add the text to label</span>
                   <span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Label</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">left</span><span class="p">((</span><span class="nx">w</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mi">7</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>                         <span class="c1">// Combine the text for label</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">d</span><span class="o">*</span><span class="mi">100</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;%&quot;</span> <span class="o">+</span>
                       <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">entries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">term</span> <span class="o">+</span>
                       <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="nx">values</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">textStyle</span><span class="p">(</span><span class="s2">&quot;#fff&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">canvas</span><span class="p">(</span><span class="nx">dom_id</span><span class="p">)</span>                        <span class="c1">// Bind the chart to DOM element</span>
            <span class="p">.</span><span class="nx">render</span><span class="p">();</span>                                  <span class="c1">// And render it.</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="p">{</span>                                            <span class="c1">// Create the public API</span>
        <span class="nx">data</span>   <span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
        <span class="nx">draw</span>   <span class="o">:</span> <span class="nx">draw</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>现在你们看到了，一个简单的JSON数据转换，我们就可以创建出丰富的有吸引力的关于我们文章标签分布的可视化图标。完整的例子在<a href="http://www.elasticsearch.cn/blog/assets/dashboards/donut.html">这里</a>。</p>
<p>当你使用完全不同的请求，比如显示某个特定作者的文章，或者特定日期内发表的文章，整个可视化都照样正常工作，代码是可以重用的。</p>
<h1 id="date-histogram-facets">日期直方图(date histogram facets)时间线</h1>
<p>Protovis让创建另一种常见的可视化类型也非常容易：<a href="http://vis.stanford.edu/protovis/ex/zoom.html">时间线</a>。任何类型的数据，只要和特定日期相关的，比如文章发表，事件发生，目标达成，都可以被可视化成时间线。</p>
<p>最终结果就像下面这样(同样可以看<a href="http://www.elasticsearch.cn/blog/assets/dashboards/timeline.html">运行版</a>)：</p>
<p><img src="http://www.elasticsearch.cn/blog/images/dashboards/timeline_chart.png" alt="图片4" /></p>
<p>好了，让我们往索引里存一些带有发表日期的文章吧：</p>
<div class="highlight"><pre><code class="bash">curl -X DELETE <span class="s2">&quot;http://localhost:9200/dashboard&quot;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;1&quot;,  &quot;published&quot; : &quot;2011-01-01&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;2&quot;,  &quot;published&quot; : &quot;2011-01-02&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;3&quot;,  &quot;published&quot; : &quot;2011-01-02&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;4&quot;,  &quot;published&quot; : &quot;2011-01-03&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;5&quot;,  &quot;published&quot; : &quot;2011-01-04&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;6&quot;,  &quot;published&quot; : &quot;2011-01-04&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;7&quot;,  &quot;published&quot; : &quot;2011-01-04&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;8&quot;,  &quot;published&quot; : &quot;2011-01-04&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;9&quot;,  &quot;published&quot; : &quot;2011-01-10&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;10&quot;, &quot;published&quot; : &quot;2011-01-12&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;11&quot;, &quot;published&quot; : &quot;2011-01-13&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;12&quot;, &quot;published&quot; : &quot;2011-01-14&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;13&quot;, &quot;published&quot; : &quot;2011-01-14&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;14&quot;, &quot;published&quot; : &quot;2011-01-15&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;15&quot;, &quot;published&quot; : &quot;2011-01-20&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;16&quot;, &quot;published&quot; : &quot;2011-01-20&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;17&quot;, &quot;published&quot; : &quot;2011-01-21&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;18&quot;, &quot;published&quot; : &quot;2011-01-22&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;19&quot;, &quot;published&quot; : &quot;2011-01-23&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/article&quot;</span> -d <span class="s1">&#39;{ &quot;t&quot; : &quot;20&quot;, &quot;published&quot; : &quot;2011-01-24&quot; }&#39;</span>
curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/_refresh&quot;</span>
</code></pre></div>
<p>我们用ES的<a href="http://www.elasticsearch.org/guide/reference/api/search/facets/date-histogram-facet.html">date histogram facet</a>来获取文章发表的频率。</p>
<div class="highlight"><pre><code class="bash">curl -X POST <span class="s2">&quot;http://localhost:9200/dashboard/_search?pretty=true&quot;</span> -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;query&quot; : { &quot;match_all&quot; : {} },</span>
<span class="s1">    &quot;facets&quot; : {</span>
<span class="s1">        &quot;published_on&quot; : {</span>
<span class="s1">            &quot;date_histogram&quot; : {</span>
<span class="s1">                &quot;field&quot;    : &quot;published&quot;,</span>
<span class="s1">                &quot;interval&quot; : &quot;day&quot;</span>
<span class="s1">            }</span>
<span class="s1">        }</span>
<span class="s1">    }</span>
<span class="s1">}</span>
<span class="s1">&#39;</span>
</code></pre></div>
<p>注意我们是怎么设置间隔为天的。这个很容易就可以替换成周，月 ，或者年。</p>
<p>请求会返回像下面这样的JSON：</p>
<div class="highlight"><pre><code class="javascript"><span class="p">{</span>
    <span class="s2">&quot;took&quot;</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="c1">// ... snip ...</span>
    <span class="s2">&quot;hits&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;total&quot;</span> <span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="c1">// ... snip ...</span>
    <span class="p">},</span>
    <span class="s2">&quot;facets&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;published&quot;</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;_type&quot;</span> <span class="o">:</span> <span class="s2">&quot;histogram&quot;</span><span class="p">,</span>
            <span class="s2">&quot;entries&quot;</span> <span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="s2">&quot;time&quot;</span> <span class="o">:</span> <span class="mi">1293840000000</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;time&quot;</span> <span class="o">:</span> <span class="mi">1293926400000</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span> <span class="o">:</span> <span class="mi">2</span> <span class="p">}</span>
                <span class="c1">// ... snip ...</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>我们要注意的是<code>facets.published.entries</code>数组，和上面的例子一样。同样需要一个HTML页来容纳图标和加载数据。机制既然一样，代码就直接看<a href="https://gist.github.com/900542/#file_chart.html">这里</a>吧。</p>
<p>既然已经有了JSON数据，用protovis创建时间线就很简单了，用一个自定义的<a href="http://vis.stanford.edu/protovis/ex/area.html">area chart</a>即可。</p>
<p>完整带注释的<code>Timeline()</code>函数如下：</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// =====================================================================================================</span>
<span class="c1">// A timeline chart with Protovis - See http://vis.stanford.edu/protovis/ex/area.html</span>
<span class="c1">// =====================================================================================================</span>
<span class="kd">var</span> <span class="nx">Timeline</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dom_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">dom_id</span><span class="p">)</span> <span class="p">{</span>                 <span class="c1">// Set the default DOM element ID to bind</span>
        <span class="nx">dom_id</span> <span class="o">=</span> <span class="s1">&#39;chart&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>                         <span class="c1">// Set the data for the chart</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">json</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">entries</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>                        <span class="c1">// Set-up the data</span>
            <span class="nx">entries</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>                              <span class="c1">// Add the last &quot;blank&quot; entry for proper</span>
              <span class="nx">count</span> <span class="o">:</span> <span class="nx">entries</span><span class="p">[</span><span class="nx">entries</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">count</span>   <span class="c1">// timeline ending</span>
            <span class="p">});</span>
        <span class="c1">// console.log(&#39;Drawing, &#39;, entries);</span>
        <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span>                                    <span class="c1">// Set-up dimensions and scales for the chart</span>
            <span class="nx">h</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="nx">max</span> <span class="o">=</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">entries</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">;}),</span>
            <span class="nx">x</span> <span class="o">=</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">Scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">entries</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">w</span><span class="p">),</span>
            <span class="nx">y</span> <span class="o">=</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">Scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">max</span><span class="p">).</span><span class="nx">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">h</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">vis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">Panel</span><span class="p">()</span>                        <span class="c1">// Create the basis panel</span>
            <span class="p">.</span><span class="nx">width</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">bottom</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">left</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">right</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">top</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
         <span class="nx">vis</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Label</span><span class="p">)</span>                              <span class="c1">// Add the chart legend at top left</span>
            <span class="p">.</span><span class="nx">top</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                 <span class="kd">var</span> <span class="nx">first</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">time</span><span class="p">);</span>
                 <span class="kd">var</span> <span class="nx">last</span>  <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">entries</span><span class="p">[</span><span class="nx">entries</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">2</span><span class="p">].</span><span class="nx">time</span><span class="p">);</span>
                 <span class="k">return</span> <span class="s2">&quot;Articles published between &quot;</span> <span class="o">+</span>
                     <span class="p">[</span> <span class="nx">first</span><span class="p">.</span><span class="nx">getDate</span><span class="p">(),</span>
                       <span class="nx">first</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="nx">first</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span>
                     <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s2">&quot; and &quot;</span> <span class="o">+</span>
                     <span class="p">[</span> <span class="nx">last</span><span class="p">.</span><span class="nx">getDate</span><span class="p">(),</span>
                       <span class="nx">last</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="nx">last</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span>
                     <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">);</span>
             <span class="p">})</span>
            <span class="p">.</span><span class="nx">textStyle</span><span class="p">(</span><span class="s2">&quot;#B1B1B1&quot;</span><span class="p">)</span>
         <span class="nx">vis</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Rule</span><span class="p">)</span>                               <span class="c1">// Add the X-ticks</span>
            <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">entries</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">visible</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">time</span><span class="p">;})</span>
            <span class="p">.</span><span class="nx">left</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">bottom</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">strokeStyle</span><span class="p">(</span><span class="s2">&quot;#33A3E1&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Label</span><span class="p">)</span>              <span class="c1">// Add the tick label (DD/MM)</span>
            <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
                 <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">time</span><span class="p">);</span>
                 <span class="k">return</span> <span class="p">[</span>
                     <span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">(),</span>
                     <span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
                 <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
             <span class="p">})</span>
            <span class="p">.</span><span class="nx">textStyle</span><span class="p">(</span><span class="s2">&quot;#2C90C8&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">textMargin</span><span class="p">(</span><span class="s2">&quot;5&quot;</span><span class="p">)</span>
         <span class="nx">vis</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Rule</span><span class="p">)</span>                               <span class="c1">// Add the Y-ticks</span>
            <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">ticks</span><span class="p">(</span><span class="nx">max</span><span class="p">))</span>                         <span class="c1">// Compute tick levels based on the &quot;max&quot; value</span>
            <span class="p">.</span><span class="nx">bottom</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">strokeStyle</span><span class="p">(</span><span class="s2">&quot;#eee&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Label</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">tickFormat</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">textStyle</span><span class="p">(</span><span class="s2">&quot;#c0c0c0&quot;</span><span class="p">)</span>
        <span class="nx">vis</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Panel</span><span class="p">)</span>                               <span class="c1">// Add container panel for the chart</span>
           <span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Area</span><span class="p">)</span>                                <span class="c1">// Add the area segments for each entry</span>
           <span class="p">.</span><span class="nx">def</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>                           <span class="c1">// Auxiliary variable to hold mouse state</span>
           <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">entries</span><span class="p">)</span>                               <span class="c1">// Pass the data to Protovis</span>
           <span class="p">.</span><span class="nx">bottom</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">left</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">x</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">);})</span>   <span class="c1">// Compute x-axis based on scale</span>
           <span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">y</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">);})</span>    <span class="c1">// Compute y-axis based on scale</span>
           <span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="s1">&#39;cardinal&#39;</span><span class="p">)</span>                     <span class="c1">// Make the chart curve smooth</span>
           <span class="p">.</span><span class="nx">segmented</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>                             <span class="c1">// Divide into &quot;segments&quot; (for interactivity)</span>
           <span class="p">.</span><span class="nx">fillStyle</span><span class="p">(</span><span class="s2">&quot;#79D0F3&quot;</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s2">&quot;mouseover&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>             <span class="c1">// On &quot;mouse over&quot;, set segment as active</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">active</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span>
               <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
           <span class="p">})</span>
           <span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span>  <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>             <span class="c1">// On &quot;mouse out&quot;, clear the active state</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">active</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
               <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
           <span class="p">})</span>
           <span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s2">&quot;mousedown&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>            <span class="c1">// On &quot;mouse down&quot;, perform action,</span>
               <span class="kd">var</span> <span class="nx">time</span> <span class="o">=</span> <span class="nx">entries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">time</span><span class="p">;</span>     <span class="c1">// eg filtering the results...</span>
               <span class="k">return</span> <span class="p">(</span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Timestamp: &#39;&quot;</span><span class="o">+</span><span class="nx">time</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="p">));</span>
           <span class="p">})</span>
           <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Line</span><span class="p">)</span>                  <span class="c1">// Add thick stroke to the chart</span>
           <span class="p">.</span><span class="nx">lineWidth</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">strokeStyle</span><span class="p">(</span><span class="s1">&#39;#33A3E1&#39;</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Dot</span><span class="p">)</span>                   <span class="c1">// Add the circle &quot;label&quot; displaying</span>
                                                        <span class="c1">// the count for this day</span>
           <span class="p">.</span><span class="nx">visible</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>                       <span class="c1">// The label is only visible when</span>
               <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>           <span class="c1">// its segment is active</span>
                          <span class="p">.</span><span class="nx">active</span><span class="p">()</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
            <span class="p">})</span>
           <span class="p">.</span><span class="nx">left</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span> <span class="p">})</span>
           <span class="p">.</span><span class="nx">bottom</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">y</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">);</span> <span class="p">})</span>
           <span class="p">.</span><span class="nx">fillStyle</span><span class="p">(</span><span class="s2">&quot;#33A3E1&quot;</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">lineWidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">radius</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">anchor</span><span class="p">(</span><span class="s2">&quot;center&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">pv</span><span class="p">.</span><span class="nx">Label</span><span class="p">)</span>             <span class="c1">// Add text to the label</span>
           <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">;})</span>
           <span class="p">.</span><span class="nx">textStyle</span><span class="p">(</span><span class="s2">&quot;#E7EFF4&quot;</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">canvas</span><span class="p">(</span><span class="nx">dom_id</span><span class="p">)</span>                        <span class="c1">// Bind the chart to DOM element</span>
           <span class="p">.</span><span class="nx">render</span><span class="p">();</span>                                  <span class="c1">// And render it.</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="p">{</span>                                            <span class="c1">// Create the public API</span>
        <span class="nx">data</span>   <span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
        <span class="nx">draw</span>   <span class="o">:</span> <span class="nx">draw</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>完整示例代码在<a href="http://www.elasticsearch.cn/blog/assets/dashboards/timeline.html">这里</a>。不过先去下载protovis提供的关于<a href="http://vis.stanford.edu/protovis/docs/area.html">area</a>的原始文档，然后观察当你修改<code>interpolate('cardinal')</code>成<code>interpolate('step-after')</code>后发生了什么。对于多个facet，画叠加的区域图，添加交互性，然后完全定制可视化应该都不是什么问题了。</p>
<p>重要的是注意，这个图表完全是根据你传递给ES的请求做出的响应，使得你有可能做到简单立刻的完成某项指标的可视化需求。比如“显示这个作者在这个主题上最近三个月的出版频率”。只需要提交这样的请求就够了：</p>
<div class="highlight"><pre><code class="bash"> author:John AND topic:Search AND published:<span class="o">[</span>2011-03-01 TO 2011-05-31<span class="o">]</span>
</code></pre></div>
<h1 id="section-1">总结</h1>
<p>当你需要为复杂的自定义查询做一个丰富的交互式的数据可视化时，使用ES的facets应该是最容易的办法之一，你只需要传递ES的JSON响应给<a href="http://vis.stanford.edu/protovis/">Protovis</a>这样的工具就好了。</p>
<p>通过模仿本文中的方法和代码，你可以在几小时内给你的数据跑通一个示例。</p>
      <a href="/2012/11/18/data-visualization-with-elasticsearch-and-protovis" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/11/18/coro" title="【翻译】Coro模块文档" rel="bookmark">【翻译】Coro模块文档</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-11-18 00:00:00 +0800">18 Nov 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <h1 id="section">名称</h1>
<p>Coro —— perl唯一真正的线程</p>
<h1 id="section-1">简要</h1>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Coro</span><span class="p">;</span>
    <span class="n">async</span> <span class="p">{</span>
        <span class="c1">#一些异步执行的线程</span>
        <span class="k">print</span> <span class="s">&quot;2\n&quot;</span><span class="p">;</span>
        <span class="n">cede</span><span class="p">;</span> <span class="c1">#切换回main线程</span>
        <span class="k">print</span> <span class="s">&quot;4\n&quot;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">print</span> <span class="s">&quot;1\n&quot;</span><span class="p">;</span>
    <span class="n">cede</span><span class="p">;</span> <span class="c1">#切换到coro线程</span>
    <span class="k">print</span> <span class="s">&quot;3\n&quot;</span><span class="p">;</span>
    <span class="n">cede</span><span class="p">;</span> <span class="c1">#再次切换</span>
    <span class="c1">#使用信号锁</span>
    <span class="k">my</span> <span class="nv">$lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Coro::</span><span class="n">Semaphore</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$locked</span><span class="p">;</span>
    <span class="nv">$lock</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">;</span>
    <span class="nv">$locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nv">$lock</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">;</span>
</code></pre></div>
<h1 id="section-2">描述</h1>
<p>如果想看教程式的介绍，请阅读<a href="http://search.cpan.org/perldoc?Coro::Intro">Coro::Intro</a>文档。这里主要介绍的是一些参考信息。</p>
<p>一般来说，本模块以协作线程(文档中简写成coro)的方式来汇总管理后续代码。他们和内核线程很像但是一般来说不会在SMP机器上同时并发执行。这个模块提供的线程特殊的格式保证了他只在必须的时候才会在你程序中标明了的地方切换线程，所以锁和并发访问都不太会成为问题。Coro模块让线程编程变得更安全，更容易了。</p>
<p>不像那些所谓的“Perl threads”(这并不是真的线程，而是windows进程仿真(详见下面同名章节)移植到UNIX的，实际工作还是进程)，Coro提供了一个完全共享的地址空间。这使得线程之间的通信变得非常容易。而且Coro线程也非常快：放弃掉你的perl程序中windows进程仿真的代码改用coro可以很容易的获得2到4倍的速度提升。一个并行矩阵乘法基准测试(高度密集的通信)用coro在单核上运行也比在4核上跑满perl伪线程快300倍。</p>
<p>Coro通过支持多个运行中的解释器共享数据做到的这点。这对写伪并行进程和事件驱动程序非常有用，比如多个HTTP协议的GET请求并发运行。可以看看<a href="http://search.cpan.org/perldoc?Coro::AnyEvent">Coro::AnyEvent</a>模块来学习怎样集成Coro到事件驱动环境里。</p>
<p>在这个模块里，一个县城被定义为“调用链+词法变量+包变量+C栈”。也就是说，一个线程有自己的调用链，自己的词法集，自己的关键性的全局变量(更多配置和背景知识见<a href="http://search.cpan.org/perldoc?Coro::State">Coro::State</a>模块)。</p>
<p>注意看文档结尾的<code>参考</code>区域——Coro模块的家族可是非常庞大的。</p>
<h1 id="coro">Coro线程生命周期</h1>
<p>在coro线程漫长而兴奋(或许也不)的生命中，它咬经过一系列的状态：</p>
<ul>
  <li>1、创建</li>
</ul>
<p>coro线程生命中的第一件事情当然是创建——创建方法就是调用<code>async块</code>函数：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
        <span class="c1">#这里写线程的代码</span>
    <span class="p">};</span>
</code></pre></div>
<p>你也可以传递参数给代码块，默认会存进<code>@_</code>里：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
         <span class="k">print</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="c1">#打印2</span>
    <span class="p">}</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">;</span>
</code></pre></div>
<p>这会创建一个新的coro线程并放进ready队列里，这意味着当CPU空闲后它会立刻运行。</p>
<p><code>async</code>会返回一个Coro对象——你可以把这个对象存起来给之后使用——这个对象就是一个运行中、准备运行或者等待事件中的线程。</p>
<p>另一个创建线程的办法是调用带有代码引用的<code>new</code>构造器：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">new</span> <span class="n">Coro</span> <span class="k">sub </span><span class="p">{</span>
         <span class="c1">#这里写线程代码</span>
    <span class="p">},</span> <span class="nv">@optional_arguments</span><span class="p">;</span>
</code></pre></div>
<p>这和调用<code>async</code>相当类似，唯一的区别就是新线程默认不会放进ready队列里。你不显式的放进去的话，这个线程就永远不会执行了。所以，<code>async</code>应该等于下面这样的写法：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$coro</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Coro</span> <span class="k">sub </span><span class="p">{</span>
         <span class="c1">#这里写线程代码</span>
    <span class="p">};</span>
    <span class="nv">$coro</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$coro</span><span class="p">;</span>
</code></pre></div>
<ul>
  <li>2、启动</li>
</ul>
<p>当新coro线程创建之后，只会保存一个代码引用和参数。并不立刻分配额外的内存给栈。这样可以保持coro线程的低内存使用水平。</p>
<p>只有当线程真正开始运行的时候，这些资源才会分配出来。</p>
<p>附加参数在coro创建的时候存进了<code>@_</code>里，这点和函数调用是一样的。</p>
<ul>
  <li>3、运行、阻塞</li>
</ul>
<p>当coro线程开始运行之后会发生很多事情。一般来说，它不会一口气跑到底(因为这种情况你肯定是直接用普通函数代替了)，它会让出CPU来等待其他外部事件。</p>
<p>只要coro线程还在运行，这个Coro对象就一直存在一个叫做<code>$Coro::current</code>的全局变量里。</p>
<p>一个底层的让出CPU的办法是调用调度器，调度器会选择一个新的线程来运行：</p>
<div class="highlight"><pre><code class="perl">    <span class="nn">Coro::</span><span class="n">schedule</span><span class="p">;</span>
</code></pre></div>
<p>因为运行中的线程不可能在ready队列里，所以啥都不做单纯调用调度器会永远的阻塞住coro线程——你必须安排好由某些事件或者线程唤醒coro线程，或者是在调度前直接把coro线程放进ready队列：</p>
<div class="highlight"><pre><code class="perl">    <span class="c1">#这其实就是Coro::cede做的</span>
    <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">current</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">;</span>
    <span class="nn">Coro::</span><span class="n">schedule</span><span class="p">;</span>
</code></pre></div>
<p>所有高级的同步方法(Coro::Semaphore, Coro::rouse_*)都是通过<code>-&gt;ready</code>和<code>Coro::schedule</code>来实现的。</p>
<p>当coro线程运行的时候，它可能被分配到一个C级别的线程，也可能从C级别的线程里被剥离，一切如Coro运行时所愿。当你的perl线程调用C级别的函数的时候，就需要分配到C线程，然后这个函数反过来调用perl，然后perl就要想办法切换协程。在你运行事件循环然后在回调中阻塞的时候经常会出现这个情况。还有一种情况是perl自己通过<code>tie</code>机制调用一些方法或者函数比如<code>AUTOLOAD</code>等等。</p>
<ul>
  <li>4、终止</li>
</ul>
<p>一段时间后，大多数线程都会终止。有很多办法来终止一个coro线程。最简单的就是从顶级代码引用里返回：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
        <span class="c1">#当从这里return后，coro线程自然就终止了</span>
    <span class="p">};</span>
    <span class="n">async</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">if</span> <span class="mf">0.5</span> <span class="o">&lt;</span>  <span class="nb">rand</span><span class="p">;</span> <span class="c1">#可能提前从这里就终止了</span>
        <span class="k">print</span> <span class="s">&quot;got a chance to print this\n&quot;</span><span class="p">;</span>
        <span class="c1">#或者在这里终止</span>
    <span class="p">};</span>
</code></pre></div>
<p>从协程里返回的任意值都可以由<code>-&gt;join</code>获取：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$coro</span> <span class="o">=</span> <span class="n">async</span> <span class="p">{</span>
         <span class="s">&quot;hello, world\n&quot;</span> <span class="c1">#返回一个字符串</span>
    <span class="p">}</span>
    <span class="k">my</span> <span class="nv">$hello_world</span> <span class="o">=</span> <span class="nv">$coro</span><span class="o">-&gt;</span><span class="nb">join</span><span class="p">;</span>
    <span class="k">print</span> <span class="nv">$hello_world</span><span class="p">;</span>
</code></pre></div>
<p>另一个办法就是调用<code>Coro::terminate</code>方法，在任意嵌套级别的子例程里都行：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
         <span class="nn">Coro::</span><span class="n">terminate</span> <span class="s">&quot;return value 1&quot;</span><span class="p">,</span> <span class="s">&quot;return value 2&quot;</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>还有一个办法是从另一个线程<code>-&gt;cancel</code>(或者<code>-&gt;safe_cancel</code>)一个coro线程：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$coro</span> <span class="o">=</span> <span class="n">async</span> <span class="p">{</span>
        <span class="nb">exit</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nv">$coro</span><span class="o">-&gt;</span><span class="n">cancel</span><span class="p">;</span> <span class="c1">#同样接收数据给-&gt;join获取</span>
</code></pre></div>
<p>取消操作通常<code>可能</code>会很危险——它有点像调用了<code>exit</code>却又没真的退出。然后可能把C库和XS模块遗留在一个古怪的状态。而且和其他的线程实现不一样的是，Coro关于取消方面的异常是安全的。在你想用Coro做些奇妙的事情而又被取消的情况下，Perl会一直保持一个一致的状态——那就是，确保线程被取消的时候，所有清理代码都被执行了——所以还有一个<code>-&gt;safe_cancel</code>方法。</p>
<p>所以，在一个XS的事件循环里取消一个线程可能不是最好的主意。不过在只有perl(比如<code>tie</code>方法或<code>AUTOLOAD</code>)的其他组合里这么处理是安全的。
最后，Coro线程对象在<code>-&gt;cancel</code>后自动的被取消引用了——和Perl里其他对象一样。虽然这不是什么普遍的情况，一个运行中的线程被<code>$Coro::current</code>引用，一个等待运行中的线程被ready队列引用，一个等待锁或者信号的线程被等待列表引用，等等等等……但取消的时候，所有队列都不再有这个线程了：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
         <span class="n">schedule</span><span class="p">;</span> <span class="c1">#切换到其他coro里，不进ready队列</span>
    <span class="p">};</span>
    <span class="n">cede</span><span class="p">;</span>
    <span class="c1">#现在上面的async被摧毁了，不再被任何地方引用。</span>
</code></pre></div>
<ul>
  <li>5、清理</li>
</ul>
<p>线程需要分配各种资源。大多数但不是所有在线程终止的时候会被清理返回。</p>
<p>清理非常像丢弃未捕获的异常：perl会按照它的方式去运行所有的子例程调用和代码块。它的方式里，它会释放所有的<code>my</code>变量，撤销所有的<code>local</code>变量，释放所有其他线程独立的资源。</p>
<p>所以，常见的释放资源的办法就是让他们成为my变量。</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
         <span class="k">my</span> <span class="nv">$big_cache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cache</span> <span class="o">...</span><span class="p">;</span>
    <span class="p">};</span>
</code></pre></div>
<p>如果不再有引用存在，<code>$big_cache</code>对象在线程终止的时候自然就释放掉了。</p>
<p>它并<code>不</code>会解锁Coro::Semaphore或类似的其他资源，这时候<code>guard</code>方法就派上用场了：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$sem</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Coro::</span><span class="n">Semaphore</span><span class="p">;</span>
    <span class="n">async</span> <span class="p">{</span>
         <span class="k">my</span> <span class="nv">$lock_guard</span> <span class="o">=</span> <span class="nv">$sem</span><span class="o">-&gt;</span><span class="n">guard</span><span class="p">;</span>
         <span class="c1">#如果我们在这里return，或者die，或者取消</span>
         <span class="c1">#信号也就唤醒了</span>
    <span class="p">}</span>
</code></pre></div>
<p>这个<code>Guard::guard</code>函数可以在你想要的时候出现在任意清理的时候(但是不能从代码块里切换到其他协程中)：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
         <span class="k">my</span> <span class="nv">$window</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Gtk2::</span><span class="n">window</span> <span class="s">&quot;toplevel&quot;</span><span class="p">;</span>
         <span class="c1">#window不会被自动清理，哪怕$window被释放了</span>
         <span class="c1">#所以用guard确保在出错的时候它可以被正确的毁灭</span>
         <span class="k">my</span> <span class="nv">$window_guard</span> <span class="o">=</span> <span class="nn">Guard::</span><span class="n">guard</span> <span class="p">{</span><span class="nv">$window</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">};</span>
         <span class="c1">#这样从这里开始我就安全了</span>
    <span class="p">};</span>
</code></pre></div>
<p>最后，<code>local</code>通常也是很方便的。比如临时替换一下coro线程的描述：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">sub </span><span class="nf">myfunction</span> <span class="p">{</span>
         <span class="nb">local</span> <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">current</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">desc</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;inside myfunction(@_)&quot;</span><span class="p">;</span>
         <span class="c1">#如果这里突然return或者die了，描述会重新存储过</span>
    <span class="p">}</span>
</code></pre></div>
<ul>
  <li>6、僵尸死亡万岁</li>
</ul>
<p>即便一个线程已经终止并且清理过它的资源了，Coro对象依然存在，而且存储着它的线程返回值。</p>
<p>这意味着线程终止并清理，不再有其他引用之后，Coro对象会自动释放掉。</p>
<p>而如果还有引用，Coro对象就还保留着，你可以调用<code>-&gt;join</code>多次来接收结果数据：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
         <span class="k">print</span> <span class="s">&quot;hi\n&quot;</span><span class="p">;</span>
         <span class="mi">1</span>
    <span class="p">};</span>
    <span class="c1">#运行上面的async，并且在从Coro::cede返回前释放所有资源</span>
    <span class="nn">Coro::</span><span class="n">cede</span><span class="p">;</span>
    <span class="p">{</span>
         <span class="k">my</span> <span class="nv">$coro</span> <span class="o">=</span> <span class="n">async</span> <span class="p">{</span>
              <span class="k">print</span> <span class="s">&quot;hi\n&quot;</span><span class="p">;</span>
              <span class="mi">1</span>
         <span class="p">};</span>
         <span class="c1">#运行上面的async并清理掉，但是不是放coro对象：</span>
         <span class="nn">Coro::</span><span class="n">cede</span><span class="p">;</span>
         <span class="c1">#可选的收取结果</span>
         <span class="k">my</span> <span class="nv">@results</span> <span class="o">=</span> <span class="nv">$coro</span><span class="o">-&gt;</span><span class="nb">join</span><span class="p">;</span>
         <span class="c1">#现在$coro超出范围了，可能被释放掉</span>
    <span class="p">};</span>
</code></pre></div>
<h1 id="section-3">全局变量</h1>
<ul>
  <li>$Coro::main</li>
</ul>
<p>这个变量存储了代表主程序的Coro对象。如果你可以<code>ready</code>好它，可以像操作coro一样操作它。在对比<code>$Coro::current</code>的时候特别有用，这样可以看到自己是不是运行在主程序里了。</p>
<ul>
  <li>$Coro::current</li>
</ul>
<p>这个变量代表当前coro(Coro调度器切换到的最后一个coro)。初始值和<code>$Coro::main</code>一样。</p>
<p>这个变量是__严格___只读_的。你可以复制到别的变量然后在其他Coro对象里使用，但不能修改这个变量本身。</p>
<ul>
  <li>$Coro::idle</li>
</ul>
<p>这个变量在集成Coro到事件循环的时候很有用。通常他更依赖<a href="http://search.cpan.org/perldoc?Coro::AnyEvent">Coro::AnyEvent</a>或者<a href="http://search.cpan.org/perldoc?Coro::EV">Coro::EV</a>，这是很漂亮的底层功能。</p>
<p>这个变量存储的Coro对象在没有其他ready线程的时候，就会被放进ready队列里(而不会调用其他ready钩子)。</p>
<p>默认实现是带着一个“致命的：检测到死锁”的提示die退出，然后跟着线程列表，因为程序没办法继续了。</p>
<p>钩子被<code>Coro::EV</code>和<code>Coro::AnyEvent</code>这样的模块重写以等待外部事件唤醒coro以便调度器运行。</p>
<p>这个技术的示例请参见<a href="http://search.cpan.org/perldoc?Coro::EV">Coro::EV</a>或者<a href="http://search.cpan.org/perldoc?Coro::AnyEvent">Coro::AnyEvent</a>模块。</p>
<h1 id="coro-1">简单的Coro创建</h1>
<ul>
  <li>async {&hellip;} [@args&hellip;]</li>
</ul>
<p>创建新coro返回他的Coro对象(通常用不上)。这个coro会被放进ready队列，当下一次调度来临的时候就自动运行。</p>
<p>第一个参数是要在coro里运行的代码块/闭包。当它返回时，coro自动终止。</p>
<p>剩余参数作为闭包的参数传递进去。</p>
<p>参见<code>Coro::State::new</code>构造器来了解当coro运行时coro环境的信息。</p>
<p>在coro里调用<code>exit</code>和在外头的效果是一样的，同样，如果coro线程die掉，程序整个退出，和在cor外面也一样。</p>
<p>如果你不想这样，你可以通过一个默认的<code>die</code>句柄，或者简单的用<code>eval</code>包装一下。</p>
<p>示例：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
         <span class="k">print</span> <span class="s">&quot;@_\n&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">;</span>
</code></pre></div>
<ul>
  <li>async_pool {&hellip;} [@args&hellip;]</li>
</ul>
<p>和<code>async</code>类似，不过用一个coro池，所以你不要对这个对象调用terminate或者join方法(然后我们也没禁止)。而且你可能得到一个coro是已经在执行其他代码的(这事儿说好也好，说不好也不好)。</p>
<p>从加强的的一面说，这个函数比完整的创建(和销毁)一个新coro快了两倍。所以你如果需要快速创建大批量的通用coro，使用<code>async_pool</code>，别用<code>async</code>。</p>
<p>代码块会在<code>eval</code>环境里运行，出现异常的时候抛出warning而不是终止程序，这和<code>async</code>一样。</p>
<p>当coro被重用的时候，像<code>on_destroy</code>这样的东西可能不会按照你想象的那样工作，除非你调用终止或者取消，这些都是跟池的目的相违背的(不过在异常的情况下还是很不错的)。</p>
<p>每次运行后，优先级都设置成<code>0</code>，跟踪被禁用，描述被清空，默认输出句柄被恢复。这样你可以改变所有这些东西。否则，coro会重用他们的“初始值”：最显著的就是如果你修改了每个线程的全局变量比如<code>$/</code>，你必须修复这个改变。最简单的做法就是用<code>local $/</code>这样。</p>
<p>空闲池的大小限定为<code>8</code>个空闲线程(这可以通过$Coro::POOL_SIZE改变)，但是有需求的恶化，非空闲的coro是多多益善的。</p>
<p>如果一个<code>async_pool</code>用了太多栈空间让你担心池里的coro章太猛了，你可以每秒钟运行<code>async_pool {terminate}</code>这样的代码来缓慢的补充池子。除此之外，当句柄用的栈涨到超过32KB(由$Coro::POOL_RSS设置)时，它就会被销毁。</p>
<h1 id="section-4">静态方法</h1>
<p>静态方法实际上就是对当前coro进行隐式操作的函数。</p>
<ul>
  <li>schedule</li>
</ul>
<p>调用调度器。调度器会从ready队列中查找下一个可以运行的coro并切换过去。这个“下一个可以运行的coro”就是有最高优先级的，在队列里等待时间最久的那个。如果一个都没有，就调用<code>$Coro::idle</code>钩子。</p>
<p>请注意：当前coro<code>不</code>会被放进ready队列里，所以调用这个函数后，这个coro不再会被调用知道有其他事件调用<code>-&gt;ready</code>来唤醒你。</p>
<p>这让<code>schedule</code>阻塞当前线程并等待事件：首先你要把当前coro记在一个变量里，然后安排好回调，在某些情况下可以用<code>-&gt;ready</code>来唤醒你，最后你调用<code>schedule</code>让自己进入沉睡。注意有很多办法可以唤醒coro，所以你要检测一下事件是否正确，比如把状态存储在一个变量里。</p>
<p>至于怎样等待回调，参见下面的__怎么等待回调__章节。</p>
<ul>
  <li>cede</li>
</ul>
<p>&ldquo;放弃&rdquo;到其他coro。这个函数把当前线程放进ready队列里然后调用<code>schedule</code>。它的效果是放弃当前的“时间片”给其他拥有更高优先级或者至少同级别的coro。一旦你的coro重新被轮到，它会自动恢复过来。</p>
<p>在其他语言里，这个函数经常被叫做<code>yield</code>。</p>
<ul>
  <li>Coro::cede_notself</li>
</ul>
<p>和cede类似，不过默认不会export出来，这个函数会不顾优先级强制cede给_其他_coro，在需要确保进程运行的时候还是有些用的。</p>
<ul>
  <li>terminate [arg&hellip;]</li>
</ul>
<p>带着给定的状态值终止当前coro(参见<a href="http://search.cpan.org/perldoc?cancel">cancel</a>)。这些状态值不会被直接返回，而是返回他们的引用。</p>
<ul>
  <li>Coro::on_enter BLOCK, Coro::on_leave BLOCK</li>
</ul>
<p>这两函数会在当前作用域内安装enter和leave。enter块会在on_enter 被调用，还有当前coro被调度器re-enter的时候执行。而leave快则是在当前coro被调度器阻塞，还有词法作用域被退出(意思就是exit、die、last等)的时候被执行。</p>
<p><em>在这些块里，不允许再调用调度器，也不允许异常</em>。这意味着，不用eval的情况下别想调用<code>die</code>命令，至于调度器更是什么办法都没法用了。</p>
<p>介于这些块都是和当前作用域绑定的，所以当当前作用域退出的时候，他们会自动删除。</p>
<p>这两函数实现了和计划中<code>dynamic-wind</code>做的一样的概念，在你想给一个特定coro本地化某些资源的时候比较有用。</p>
<p>使用这两函数的coro会相对的被放慢线程切换的速度(大概一个单独分配的块40%的样子，所以只要处理程序够快，线程切换依然很快)。</p>
<p>通过下面这个例子，可以更好的理解这些函数：切换当前时区到&rdquo;南极&rdquo;，这需要调用<code>tzset</code>，但是我们使用<code>on_enter</code>和<code>on_leave</code>，用来记忆/改变当前时区并存储之前的值。分别的，只有安装了这两函数的coro才会改变时区。</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(tzset)</span><span class="p">;</span>
    <span class="n">async</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$old</span><span class="o">\</span><span class="n">_tz</span><span class="p">;</span> <span class="o">\</span><span class="c1">#在这里存储外面的时区</span>
        <span class="nn">Coro::</span><span class="n">on</span><span class="o">\</span><span class="n">_enter</span> <span class="p">{</span>
            <span class="nv">$old</span><span class="o">\</span><span class="n">_tz</span> <span class="o">=</span> <span class="nv">$ENV</span><span class="p">{</span><span class="n">TZ</span><span class="p">};</span> <span class="o">\</span><span class="c1">#记忆旧的数值</span>
            <span class="nv">$ENV</span><span class="p">{</span><span class="n">TZ</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;Antarctica/South\_Pole&quot;</span><span class="p">;</span>
            <span class="n">tzset</span><span class="p">;</span> <span class="o">\</span><span class="c1">#启用新值</span>
        <span class="p">};</span>
        <span class="nn">Coro::</span><span class="n">on</span><span class="o">\</span><span class="n">_leave</span> <span class="p">{</span>
            <span class="nv">$ENV</span><span class="p">{</span><span class="n">TZ</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$old</span><span class="o">\</span><span class="n">_tz</span><span class="p">;</span>
            <span class="n">tzset</span><span class="p">;</span> <span class="o">\</span><span class="c1">#恢复旧值</span>
        <span class="p">};</span>
        <span class="o">\</span><span class="c1">#在这块，时区就是&quot;南极&quot;，不会被其他coro里的时区影响</span>
    <span class="p">};</span>
</code></pre></div>
<p>这可以用于给块本地化任何资源(locale，uid，当前工作目录等)，尽管当前有其他coro存在。</p>
<p>另一个有趣的例子，通过间隔计时器实现了时间片的多任务(下面的代码明显是可以优化的，不过当前足够跑任务了)：</p>
<div class="highlight"><pre><code class="perl">    <span class="o">\</span><span class="c1">#把给定块按时间分片</span>
    <span class="k">sub </span><span class="nf">timeslice</span><span class="p">(&amp;) {</span>
        <span class="k">use</span> <span class="nn">Time::</span><span class="n">HiRes</span> <span class="p">();</span>
        <span class="nn">Coro::</span><span class="n">on</span><span class="o">\</span><span class="n">_enter</span> <span class="p">{</span>
            <span class="o">\</span><span class="c1">#在进线程的时候，我们设置一个VTALRM信号以便cede</span>
            <span class="nv">$SIG</span><span class="p">{</span><span class="n">VTALRM</span><span class="p">}</span> <span class="o">=</span> <span class="k">sub </span><span class="p">{</span> <span class="n">cede</span> <span class="p">};</span>
            <span class="o">\</span><span class="c1">#然后启动一个间隔计时器</span>
            <span class="nn">Time::HiRes::</span><span class="n">setitimer</span> <span class="o">&amp;</span><span class="nn">Time::HiRes::</span><span class="n">ITIMER</span><span class="o">\</span><span class="n">_VIRTUAL</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="nn">Coro::</span><span class="n">on</span><span class="o">\</span><span class="n">_leave</span> <span class="p">{</span>
            <span class="o">\</span><span class="c1">#在离开线程的时候我们停止这个间隔计时器</span>
            <span class="nn">Time::HiRes::</span><span class="n">setitimer</span> <span class="o">&amp;</span><span class="nn">Time::HiRes::</span><span class="n">ITIMER</span><span class="o">\</span><span class="n">_VIRTUAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="o">&amp;</span><span class="p">{</span><span class="o">+</span><span class="nb">shift</span><span class="p">};</span>
    <span class="p">}</span> 
    <span class="o">\</span><span class="c1">#使用方法如下：</span>
    <span class="n">timeslice</span> <span class="p">{</span>
        <span class="o">\</span><span class="c1">#下面是一个死循环，一般情况下会垄断进程。</span>
        <span class="o">\</span><span class="c1">#不过现在它跑着一个时间片环境里，定期的会cede给其他线程。</span>
        <span class="k">while</span> <span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">};</span>
</code></pre></div>
<ul>
  <li>killall</li>
</ul>
<p>除当前运行的coro外，杀死/中断/取消所有coro。</p>
<p>注意，如果调用killall的coro不是主coro，当他试图释放一些主解释资源的时候，可能释放不干净。会存在一些一次性的资源泄露。</p>
<h1 id="coro-2">Coro对象方法</h1>
<p>下面是一些你可以在coro对象上调用(或者创建)的方法。</p>
<ul>
  <li>new Coro \&amp;sub [,@args&hellip;]</li>
</ul>
<p>创建一个新的coro并返回它。当sub返回的时候，coro自动终止，就像你带着返回值调用<code>terminate</code>的效果一样。要让coro运行，你要先调用rady方法把它放进ready队列里。</p>
<p>参考<code>async</code>和<code>Coro::State::new</code>查看更多关于coro环境的信息。</p>
<ul>
  <li>$success = $coro-&gt;ready</li>
</ul>
<p>将该coro放进它的ready队列的最后(每个优先级都有一个队列)并返回真。如果coro已经在ready队列里，不做任何操作并返回假。</p>
<p>这保证里当所有高优先级的coro和同优先级先准备好了的coro都恢复后，调度器会自动恢复这个coro。</p>
<ul>
  <li>$coro-&gt;suspend</li>
</ul>
<p>挂起指定coro。一个挂起的coro和其他coro一样工作，不同的是调度器不会选择挂起的coro做真正的执行。</p>
<p>当你想阻止某个coro运行又不打算销毁它，或者当你想暂时冻结某个coro(比方需要调试)等之后再恢复的时候，挂起就很有用了。</p>
<p>前者的一个场景可能是这样：fork之后挂起所有其他的coro但保持住他们不调用析构器，不过你可以继续创建新的coro。</p>
<ul>
  <li>$coro-&gt;resume</li>
</ul>
<p>当指定coro被挂起后，它就可以被恢复。注意如果一个已经在ready队列里的coro被挂起，调度器可能会把它踢出去，你会失去这次激活。</p>
<p>要避免这种情况的话，最好的办法是无条件的把挂起coro放进预备队列，每个同步机制都必然会保护自己不被虚假唤醒，Coro自然也有。</p>
<ul>
  <li>$state-&gt;is_new</li>
</ul>
<p>如果Coro对象还是“新”的，返回真，额，新的意思是还没运行过。这些状态基本只是由要调用的代码引用和参数组成。消耗的其他资源很少。转移到新状态后会自动分配一个perl解释器。</p>
<ul>
  <li>$state-&gt;is_zombie</li>
</ul>
<p>如果Coro对象被取消了，返回真。比如对象的资源因为<code>cancel</code>、<code>terminate</code>、<code>safe_cancel</code>释放了，或者可能就是简单的跑出范围了。</p>
<p>“僵尸”这个名字源自UNIX文化，当一个进程已经退出，除了退出状态什么资源都没有了的时候，就会被叫做“僵尸”。</p>
<ul>
  <li>$is_ready = $coro-&gt;is_ready</li>
</ul>
<p>如果Coro对象在预备队列里，返回真。它最终会被调度器调控，除非Coro对象被销毁。</p>
<ul>
  <li>$is_running = $coro-&gt;is_running</li>
</ul>
<p>如果Coro对象正在运行，返回真。只有一个Coro对象可以处于运行状态(但一个Coro对象可以有多个运行中的Coro::States)。</p>
<ul>
  <li>$is_suspended = $coro-&gt;is_suspended</li>
</ul>
<p>如果Coro对象被挂起，返回真。挂起的Coro永远不会被调度。</p>
<ul>
  <li>$coro-&gt;cancel (arg&hellip;)</li>
</ul>
<p>终止指定Coro线程，强制返回指定参数作为状态(默认为空列表)。如果指定Coro就是当前Coro，则无法返回。</p>
<p>这是一个相当残酷的释放coro的方式，而且还有一些限制——如果线程里有一个不希望被终止的C语言的回调，有些不忍言之事就要发生了；或者如果取消的线程上运行着复杂的清理程序，而这个清理程序又依赖于它的线程上下文，事情也不大会正常的工作。</p>
<p>要运行的清理程序代码(比如<code>guard</code>代码块)不会有线程上下文，也不允许再切换到其他线程。</p>
<p>另外，<code>-&gt;cancel</code>永远都是这么不管不顾的清理线程。所以如果你的清理代码很复杂或者你希望避免取消一个自己压根不知道怎么清理的C语言线程，建议使用<code>-&gt;throw</code>抛出异常，或者用<code>-&gt;safe_cancel</code>方法。</p>
<p>传递给<code>-&gt;cancel</code>的参数不会被复制，而是被直接引用(比如：你传递了<code>$var</code>，在调用修改这个变量之后，你也需要修改传递给<code>join</code>的返回值，所以最好别用这个)。</p>
<p>Coro的资源通常在这个调用返回之前就已经都释放或销毁掉了。不过这事可以被无限期的推迟，因为可能作为管理端的线程有时候要首先运行注销Coro对象。</p>
<ul>
  <li>$coro-&gt;safe_cancel($arg&hellip;)</li>
</ul>
<p>和<code>-&gt;cancel</code>很像。不过本质上，它是“安全”的。所以当线程并不处于一个可终止的状态的时候，它会抛出一个异常。</p>
<p>这个方法运行起来就像抛出一个不可被捕捉的异常——具体的说，它从线程的内部开始清理，所以所有的清理程序(比如<code>guard</code>块)，都是在线程的上下文中运行，并且可以随意阻塞。它的缺点就是不保证线程肯定可以终止，它可能会失败。而且，运行速度也比<code>cancel</code>和<code>terminal</code>慢。</p>
<p>一个线程，当它还没有被运行，或者没有C语言的上下文附加且在SLF函数内。</p>
<p>后面这两个的意思基本上就是线程不在被某些C函数(通常是XS模块)回调的perl函数里，也不在这些C函数通过Coro的XS级别的API调用运行中。</p>
<p>当本函数可以正常终止线程时，返回真；否则报错(即要么返回真要么不返回)。</p>
<p>为什么搞这么奇怪的接口？嗯，关于何时如何终止线程，有两种通用模式。一种是你希望当你想终止的时候就可以终止——当线程不可终止的时候，显然就会有问题了。所以需要<code>-&gt;safe_cancel</code>来报错。</p>
<p>第二种模式是，你很友好的问下先，如果不碰巧，那就先不终止线程了。看起来就像这样：</p>
<div class="highlight"><pre><code class="perl"> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">eval</span> <span class="p">{</span> <span class="nv">$coro</span><span class="o">-&gt;</span><span class="n">safe</span><span class="o">\</span><span class="n">_cancel</span> <span class="p">})</span> <span class="p">{</span>
        <span class="nb">warn</span> <span class="s">&quot;unable to cancel thread: $@&quot;</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>然而，你不应该总是先尝试安全的取消然后失败了再强行<code>-&gt;cancel</code>。这样是没道理的：因为你肯定要不就在线程里自己搞定清理代码，要不就是没有。有的话，用<code>-&gt;safe_cancel</code>；没有的话，<code>-&gt;cancel</code>更直接快捷。</p>
<ul>
  <li>$coro-&gt;schedule_to</li>
</ul>
<p>让当前线程进入休眠(类似<a href="http://search.cpan.org/perldoc?Coro::schedule">Coro::schedule</a>)，不过不会轮到ready队列的下一个线程，而是切换到给定的那个Coro对象(不管多少优先级)。coro的准备情况并不会被改变。</p>
<p>这是一个为特殊情况准备的高级方法——我很乐意听到它被实际运用了。</p>
<ul>
  <li>$coro-&gt;cede_to</li>
</ul>
<p>和<code>schedule_to</code>类似，但是是把当前线程放进ready队列里。它等效于暂时切换到给定的对象，过会儿再继续。</p>
<p>这是一个为特殊情况准备的高级方法——我很乐意听到它被实际运用了。</p>
<ul>
  <li>$coro-&gt;throw ([$scalar])</li>
</ul>
<p>如果<code>$throw</code>被定义了，那它会在下一个合适的时间点被coro作为异常抛出。否则就清理掉这个异常对象。</p>
<p>Coro会在每个类schedule函数返回时检查异常。这类函数包括<code>schedule</code>，<code>cede</code>，<code>Coro::Semaphore-&gt;down</code>，<code>Coro::Handle-&gt;readable</code>等等。大多数这些函数(都是Coro的一部分)检测这个情况，并且在异常pending的时候提前返回。</p>
<p>异常对象会在<code>$@</code>中和另一个特殊标量一起被抛出。即，如果它是字符串，不会有行号和和新行追加进来(跟<code>die</code>不一样)。</p>
<p>这可以被用来作为一个比<code>cancel</code>或者<code>safe_cancel</code>更柔和一些的询问一个coro是否结束的办法，虽然并不能保证异常一定会导致终止而且如果没有被捕获它可能会结束整个程序。</p>
<p>你也可以理解<code>throw</code>是类似带信号(这种情况就是一个标量)的<code>kill</code>。</p>
<ul>
  <li>$coro-&gt;join</li>
</ul>
<p>等待coro中止并返回线程给<code>terminal</code>或<code>cancel</code>返回的任意值。<code>join</code>可以并发的被多个线程调用。然后一旦<code>$coro</code>中止，一切都会恢复并且给出一个返回值。</p>
<ul>
  <li>$coro-&gt;on_destroy (\&amp;cb)</li>
</ul>
<p>注册一个回调函数在coro线程被销毁的时候被调用。具体的说是资源已经被释放，不过join还没开始。在任意情况下，只要<code>不</code>是die，这个回调函数都会传入终止/中止参数。</p>
<p>每个coro可以有任意多个<code>on_destroy</code>回调，而且目前为止，一旦添加，不可以再删除了。</p>
<ul>
  <li>$oldprio = $coro-&gt;prio ($newprio)</li>
</ul>
<p>设置(当没有参数的时候就是获取)coro线程的优先级。高优先级的会比低优先级的更早运行。优先级是有符号整数，目前是3到-4之间。你可以参考使用PRIO_***常量(提前导入标签:prio获取)；</p>
<div class="highlight"><pre><code class="perl">   <span class="n">PRIO</span><span class="o">\</span><span class="n">_MAX</span> <span class="o">&gt;</span> <span class="n">PRIO</span><span class="o">\</span><span class="n">_HIGH</span> <span class="o">&gt;</span> <span class="n">PRIO</span><span class="o">\</span><span class="n">_NORMAL</span> <span class="o">&gt;</span> <span class="n">PRIO</span><span class="o">\</span><span class="n">_LOW</span> <span class="o">&gt;</span> <span class="n">PRIO</span><span class="o">\</span><span class="n">_IDLE</span> <span class="o">&gt;</span> <span class="n">PRIO</span><span class="o">\</span><span class="n">_MIN</span>
       <span class="mi">3</span>    <span class="o">&gt;</span>     <span class="mi">1</span>     <span class="o">&gt;</span>      <span class="mi">0</span>      <span class="o">&gt;</span>    <span class="o">-</span><span class="mi">1</span>    <span class="o">&gt;</span>    <span class="o">-</span><span class="mi">3</span>     <span class="o">&gt;</span>    <span class="o">-</span><span class="mi">4</span>
   <span class="o">\</span><span class="c1"># 设置优先级为高</span>
   <span class="n">current</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="p">(</span><span class="n">PRIO</span><span class="o">\</span><span class="n">_HIGH</span><span class="p">);</span>
</code></pre></div>
<p>空闲的coro线程永远比其他存活的coro优先级要低。</p>
<p>修改当前coro的优先级即时生效，但是修改ready队列里的只会在下次调度(到它)的时候才生效。或者这算个bug，未来某个版本会修正。</p>
<ul>
  <li>$newprio = $coro-&gt;nice ($change)</li>
</ul>
<p>类似<code>prio</code>方法，不过是从优先级中减去给定的值(也就是说值越大优先级越低，类似UNIX里的nice命令)。</p>
<ul>
  <li>$olddesc = $coro-&gt;desc ($newdesc)</li>
</ul>
<p>设置(当没有参数的时候就是获取)coro线程的描述。这只是与coro关联的无格式的字符串。</p>
<p>这个方法只是简单的把<code>$coro-&gt;{desc}</code>成员设置为给定的字符串。你也可以自己修改这个成员。事实上，大家通常宁愿这样声明，比如在一个<a href="http://search.cpan.org/perldoc?Coro::Debug">Coro::Debug</a>的会话里：</p>
<div class="highlight"><pre><code class="perl">   <span class="k">sub </span><span class="nf">my</span><span class="p">\_long\_function {</span>
      <span class="nb">local</span> <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">current</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">desc</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;now in my\_long\_function&quot;</span><span class="p">;</span>
      <span class="o">...</span>
      <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">current</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">desc</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;my\_long\_function: phase 1&quot;</span><span class="p">;</span>
      <span class="o">...</span>
      <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">current</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">desc</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;my\_long\_function: phase 2&quot;</span><span class="p">;</span>
      <span class="o">...</span>
   <span class="p">}</span> 
</code></pre></div>
<h1 id="section-5">全局函数</h1>
<ul>
  <li>Coro::nready</li>
</ul>
<p>返回在ready状态(即通过调用<code>schedule</code>可以切换的)的coro线程个数。值为<code>0</code>的话，就意味着唯一可运行的就是当前运行的这个线程。所以<code>cede</code>是没效果的，而<code>schedule</code>会死锁到有哪个空闲函数激活别的coro。</p>
<ul>
  <li>my $guard = Coro::guard { &hellip; }</li>
</ul>
<p>这个函数还存在，不过早晚被废弃，请使用<code>Guard::guard</code>函数。</p>
<ul>
  <li>unblock_sub { &hellip; }</li>
</ul>
<p>这个有用的工具接收一个块或者代码引用，然后“unblock”它，并返回一个新的代码引用。unblock意思是：调用新的代码引用会立刻返回，不阻塞，无返回值。而原本的代码会被另一个新的coro调用。</p>
<p>这个函数存在的原因是：很多event库(比如<a href="http://search.cpan.org/perldoc?Event">Event</a>库)是非线程安全(比较弱格式的可重入性)的。这意味着你在回调总不可以阻塞。否则你就可能收到崩溃的报警。我目前唯一知道可以不用<code>unblock_sub</code>就安全的event库就是<a href="http://search.cpan.org/perldoc?EV">EV</a>了(但是当你所有的事件循环都被block后，你还是会进入死锁状态)。</p>
<p>Coro会尝试在你在事件循环中被阻塞的时候捕获异常(FATAL:$Coro::IDLE blocked itself)。当然这只是近乎完美，而且还要求你不能用自己的循环实现。</p>
<p>这个函数允许你的回调是阻塞的，因为他会在另一个可以被安全阻塞的coro里执行。一个很常见的例子就是当你用<a href="http://search.cpan.org/perldoc?Coro::AIO">Coro::AIO</a>模块时，函数让你刷结果到磁盘上。</p>
<p>简单的说：在有阻塞可能的函数里用<code>unblock_sub</code>代替<code>sub</code>。</p>
<p>如果你的函数无所谓阻塞(比如给另一个coro发个信息，或者把其他coro整理到ready队列里)，那就没理由用<code>unblock_sub</code>了。</p>
<p>注意你必须给C级别的事件循环中使用的回调函数使用<code>unblock_sub</code>。比如，当你使用一些用了<a href="http://search.cpan.org/perldoc?AnyEvent">AnyEvent</a>(而且你用的是<a href="http://search.cpan.org/perldoc?Coro::AnyEvent">Coro::AnyEvent</a>)的模块，这些模块提供的回调函数又是另一些事件回调的结果，你可不能阻塞掉它们，那么用<code>unblock_sub</code>吧。</p>
<ul>
  <li>$cb = rouse_cb</li>
</ul>
<p>创建并返回一个“唤醒式的回调”。这是一个代码引用，当被调用的时候，它就记下调用的参数副本，然后通知拥有这个回调的coro。</p>
<ul>
  <li>@args = rouse_wait [$cb]</li>
</ul>
<p>等待特定的唤醒回调(或者是本coro中最后创建的那个)。</p>
<p>一旦被调用(或者在<code>rouse_wait</code>之前被调用)，他将返回最初传递给唤醒回调的参数。在标量上下文中意味着是<code>最后</code>一个参数，就好比<code>rouse_wait</code>最后状态是<code>return ($a1,$a2,$a3...)</code>。</p>
<p>参见下面__怎么等待回调__章节的实际使用例子。</p>
<h1 id="section-6">怎么等待回调</h1>
<p>对于一个coro线程，等待回调是非常常见的。当你在另一个事件驱动程序或者事件驱动库里使用coro的时候，很自然的触发它。</p>
<p>通常时注册一个回调函数对应相应的事件，然后当这个事件触发的时候调用这些函数。不过，你可能只是想等待事件，简单到极致了。</p>
<p>比如<code>AnyEvent-&gt;child</code>注册了一个回调到特定子进程退出的时候：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$child_watcher</span> <span class="o">=</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">child</span> <span class="p">(</span><span class="n">pid</span> <span class="o">=&gt;</span> <span class="nv">$pid</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="o">...</span> <span class="p">});</span>
</code></pre></div>
<p>不过在coro里，你通常只需要这么写：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$status</span> <span class="o">=</span> <span class="n">wait_for_child</span> <span class="nv">$pid</span><span class="p">;</span>
</code></pre></div>
<p>Coro提供了两个特定的函数让这件事情变得很容易：C<coro::rouse_cb>和C<coro::rouse_wait>。</coro::rouse_wait></coro::rouse_cb></p>
<p>第一个函数，C<rouse_cb>，生成并返回一个回调，当这个回调被调用时，会自动保存参数并通知创建该回调的coro。</rouse_cb></p>
<p>第二个函数，C<rouse_wait>，等待回调被调用(通过C<schedule>命令进入休眠)并返回传递给回调的初始参数。
使用这两个函数，就可以很容易的实现上面说的C<wait_for_child>函数了：</wait_for_child></schedule></rouse_wait></p>
<div class="highlight"><pre><code class="perl">    <span class="k">sub </span><span class="nf">wait_for_child</span><span class="p">($)</span> <span class="p">{</span>
       <span class="k">my</span> <span class="p">(</span><span class="nv">$pid</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
      <span class="k">my</span> <span class="nv">$watcher</span> <span class="o">=</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">child</span> <span class="p">(</span><span class="n">pid</span> <span class="o">=&gt;</span> <span class="nv">$pid</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=&gt;</span> <span class="nn">Coro::</span><span class="n">rouse_cb</span><span class="p">);</span>
       <span class="k">my</span> <span class="p">(</span><span class="nv">$rpid</span><span class="p">,</span> <span class="nv">$rstatus</span><span class="p">)</span> <span class="o">=</span> <span class="nn">Coro::</span><span class="n">rouse_wait</span><span class="p">;</span>
       <span class="nv">$rstatus</span>
    <span class="p">}</span>
</code></pre></div>
<p>如果嫌C<rouse_cb>和C<rouse_wait>还不够灵活，你还可以用C<schedule>自己搞起：</schedule></rouse_wait></rouse_cb></p>
<div class="highlight"><pre><code class="perl">    <span class="k">sub </span><span class="nf">wait_for_child</span><span class="p">($)</span> <span class="p">{</span>
       <span class="k">my</span> <span class="p">(</span><span class="nv">$pid</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
      <span class="c1"># 把当前的coro存入$current,</span>
      <span class="c1"># 然后提供一个结果变量传递给-&gt;child的闭包</span>
      <span class="k">my</span> <span class="nv">$current</span> <span class="o">=</span> <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">current</span><span class="p">;</span>
      <span class="k">my</span> <span class="p">(</span><span class="nv">$done</span><span class="p">,</span> <span class="nv">$rstatus</span><span class="p">);</span>
      <span class="c1"># pass a closure to -&gt;child</span>
      <span class="k">my</span> <span class="nv">$watcher</span> <span class="o">=</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">child</span> <span class="p">(</span><span class="n">pid</span> <span class="o">=&gt;</span> <span class="nv">$pid</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
         <span class="nv">$rstatus</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="c1"># 记住$rstatus</span>
         <span class="nv">$done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1"># 标记$rstatus</span>
      <span class="p">});</span>
      <span class="c1">#等待闭包被调用</span>
      <span class="n">schedule</span> <span class="k">while</span> <span class="o">!</span><span class="nv">$done</span><span class="p">;</span>
      <span class="nv">$rstatus</span>
    <span class="p">}</span>
</code></pre></div>
<h1 id="section-7">错误和限制</h1>
<ul>
  <li>后端用pthread派生</li>
</ul>
<p>当coro使用pthread后端编译(不建议，但在一些BSD平台上不得不用，因为BSD的libcs完全不可用)的时候，coro无法生成fork。解决办法：修复glibc然后用snner后端。</p>
<ul>
  <li>每个进程的仿真(线程)</li>
</ul>
<p>这个模块不是perl的伪线程安全。所以你只能在第一个线程里使用coro(未来的版本可能去掉这个要求，实现每个线程自己的schedule，不过当前Coro::State模块还不支持)。我建议关闭线程支持使用进程。因为开启windows进程仿真后，插入速度只有perl代码的一半。</p>
<p>注意，使用另一个进程创建出来的线程会崩溃(报错是空指针)。</p>
<ul>
  <li>coro切换不是信号安全的</li>
</ul>
<p>你千万不要从一个处理sighal句柄的进程(指的是%SIG，大多数事件库都提供安全的信号)里切换到其他coro线程。_除非_你确信自己的做法不会中断Coro函数！</p>
<p>也就是说，你_绝对不_能调用任何可能阻塞当前coro的函数 —— <code>cede</code>，<code>schedule</code>，<code>Coro::Semaphore-&gt;down</code>或者其他使用了这些的函数。其他的命令，比如<code>ready</code>，则没问题。</p>
<h1 id="windows">windows进程仿真</h1>
<p>太多人看起来都对ithreads比较困惑（比如Chip Salzenberg就说我“无知，无能，愚蠢，上当了！”，而同一封邮件里他对perl的ithreads也是各种模糊的说法(比如说文件或者内存必须共享)，这说明他在这方面了解甚微——如果对Chip来说这都很难理解，估计对所有人都没那么容易搞明白的）。</p>
<p>下面贴一段我在2009年perl聚会上分享的《脚本语言中的线程》的超浓缩版：</p>
<p>所谓的“ithreads”最初是为了这两个理由才实现的：第一，在原生win32平台的perl上模拟unix进程；第二，替代旧的，真正的线程模型(&ldquo;5.005-threads&rdquo;)。</p>
<p>最后的实现用线程替代了操作系统进程。进程和线程的区别是：同一个进程内的线程间是共享内存的（以及其他状态，比如文件）。而进程间可不会共享任何东西（至少语义上不会）。也就是说一个线程做的修改可以是其他线程可见的，而进程的修改是其他进程不可见的。</p>
<p>“ithreads”就是这样工作的：创建新的ithreads进程时，所有状态都被复制（内存是物理上实际复制，文件和代码是逻辑上的复制）。然后，所有修改被隔离。在UNIX上，这个行为是通过操作系统进程实现的。不过UNIX通常会使用构建进系统的硬件来有效的做到这点。而windows进程仿真是通过软件模拟这个硬件操作(也很有效，不过当然还是比硬件慢很多)。</p>
<p>所以，如上面说过的，加载代码，修改代码，修改数据结构，都只是所属ithreads内部可见。同一个OS进程内的其他ithreads是看不到的。</p>
<p>这就是为什么“ithreads”根本没有给perl实现线程，而依然是进程的原因。在非windows平台上，它表现相当糟糕，就是因为你完全可以利用硬件定制的优势(比如fork模块，它可以给你(i-)threads的API，而且快很多)。</p>
<p>要在ithreads模型里共享数据，只能在线程间通过缓慢的复制语义来传输数据结构——共享数据是不存在的。</p>
<p>i-threads交互密集型的基准测试显示结果相当糟糕（事实上糟糕到了没法直接利用多核优势的Coro都比它快上数量级。因为Coro可以在线程间共享数据，详见我的分享）。</p>
<p>综上所述，i-threads是用线程来实现了进程，也就是用fork的进程来模拟，嗯，进程。启用i-threads完全是拖累perl程序的运行，在非windows平台下完全没有（顶多算微乎其微的有）实用性，反而是损害那些单线程的perl程序。</p>
<p>这就是我避免用&rdquo;ithreads&rdquo;这个名字的原因，因为这完全是误导，听起来就跟它为perl实现了某种线程模型似的。我更喜欢的是“windows进程模拟”这个名字，这才更准确和真实的描述了它的实际作用和行为。</p>
<h1 id="section-8">另见</h1>
<p>事件循环集合: <a href="http://search.cpan.org/perldoc?Coro::AnyEvent">Coro::AnyEvent</a>，<a href="http://search.cpan.org/perldoc?Coro::EV">Coro::EV</a>，<a href="http://search.cpan.org/perldoc?Coro::Event">Coro::Event</a>。</p>
<p>调试: <a href="http://search.cpan.org/perldoc?Coro::Debug">Coro::Debug</a>。</p>
<p>支持/实用工具: <a href="http://search.cpan.org/perldoc?Coro::Specific">Coro::Specific</a>，<a href="http://search.cpan.org/perldoc?Coro::Util">Coro::Util</a>。</p>
<p>锁和过程间通信: <a href="http://search.cpan.org/perldoc?Coro::Signal">Coro::Signal</a>，<a href="http://search.cpan.org/perldoc?Coro::Channel">Coro::Channel</a>，<a href="http://search.cpan.org/perldoc?Coro::Semaphore">Coro::Semaphore</a>，<coro::semaphoreset>，[Coro::RWLock](http://search.cpan.org/perldoc?Coro::RWLock)。</coro::semaphoreset></p>
<p>I/O和定时器: <a href="http://search.cpan.org/perldoc?Coro::Timer">Coro::Timer</a>，<a href="http://search.cpan.org/perldoc?Coro::Handle">Coro::Handle</a>，<a href="http://search.cpan.org/perldoc?Coro::Socket">Coro::Socket</a>，<a href="http://search.cpan.org/perldoc?Coro::AIO">Coro::AIO</a>。</p>
<p>和其他模块的结合: <a href="http://search.cpan.org/perldoc?Coro::LWP">Coro::LWP</a>(不过实用的话建议选择<a href="http://search.cpan.org/perldoc?AnyEvent::HTTP">AnyEvent::HTTP</a>)，<a href="http://search.cpan.org/perldoc?Coro::BDB">Coro::BDB</a>，<a href="http://search.cpan.org/perldoc?Coro::Storable">Coro::Storable</a>，<a href="http://search.cpan.org/perldoc?Coro::Select">Coro::Select</a>。</p>
<p>XS API: <a href="http://search.cpan.org/perldoc?Coro::MakeMaker">Coro::MakeMaker</a>。</p>
<p>底层配置，线程环境及延续机制: <a href="http://search.cpan.org/perldoc?Coro::State">Coro::State</a>。</p>
<h1 id="section-9">作者</h1>
<p>Marc Lehmann <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#115;&#099;&#104;&#109;&#111;&#114;&#112;&#064;&#115;&#099;&#104;&#109;&#111;&#114;&#112;&#046;&#100;&#101;">&#115;&#099;&#104;&#109;&#111;&#114;&#112;&#064;&#115;&#099;&#104;&#109;&#111;&#114;&#112;&#046;&#100;&#101;</a>
http://home.schmorp.de/</p>
      <a href="/2012/11/18/coro" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/11/09/chrome-app-demo" title="Chrome的APP简单用法" rel="bookmark">Chrome的APP简单用法</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-11-09 00:00:00 +0800">09 Nov 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>学习一下简单的chrome app写法。首先，chrome的ext和web app和packaged app就要分清楚。简单说，ext就是可以出现在地址栏右侧的，app是可以出现在任务栏右侧的。而web app其实就是用json描述了一个url地址，packaged app则是最接近普通桌面程序的，需要完整的带有html/css/js等内容。但同时，因为packaged app可以在关闭chrome浏览器后运行，所以有些浏览器上的API它也用不了。</p>
<p>首先上一个web app的demo，只要一个manifest.json在本地就够了。关键点是app里指定为url，permissions指定需要的权限。</p>
<div class="highlight"><pre><code class="javascript"><span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;WebApp&quot;</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;0.1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;app&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;urls&quot;</span><span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;http://www.domain.com/chrome/&quot;</span> <span class="p">],</span>
    <span class="s2">&quot;launch&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;web_url&quot;</span><span class="o">:</span> <span class="s2">&quot;http://www.domain.com/chrome/index.html&quot;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;permissions&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">,</span> <span class="s2">&quot;notifications&quot;</span><span class="p">],</span>
  <span class="s2">&quot;manifest_version&quot;</span><span class="o">:</span> <span class="mi">2</span>
<span class="p">}</span>
</code></pre></div>
<p>然后余下的事情就是web上的了。在<code>http://www.domain.com/chrome/index.html</code>里定义内容。比如我这是这样：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;&lt;head&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;openBackgroundWindow&quot;</span><span class="nt">&gt;</span>开启后台运行<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;closeBackgroundWindow&quot;</span><span class="nt">&gt;</span>关闭后台运行<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;index.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>然后把事情交给index.js来完成。这也是chrome app的通常做法，尽量拆分干净，尤其到packaged app的时候，压根就不让你在html里写script了。index.js如下：</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">bgWinUrl</span> <span class="o">=</span> <span class="s2">&quot;background.html#yay&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">bgWinName</span> <span class="o">=</span> <span class="s2">&quot;bgNotifier&quot;</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">openBackgroundWindow</span><span class="p">()</span> <span class="p">{</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">bgWinUrl</span><span class="p">,</span> <span class="nx">bgWinName</span><span class="p">,</span> <span class="s2">&quot;background&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">closeBackgroundWindow</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">bgWinUrl</span><span class="p">,</span> <span class="nx">bgWinName</span><span class="p">,</span> <span class="s2">&quot;background&quot;</span><span class="p">);</span>
  <span class="nx">w</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">}</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;DOMContentLoaded&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#openBackgroundWindow&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span>
    <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">openBackgroundWindow</span><span class="p">);</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#closeBackgroundWindow&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span>
    <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">closeBackgroundWindow</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>注意到这里的<code>background.html</code>加了锚点，原因我懒得看英文说明了，反正大意是不写个锚点有时候会出问题。</p>
<p>最后是background.html，内容参见之前博客里写的juggernaut。简单几十行。一个可以不再打开具体页面自动收报警消息的app就改造出来了～～</p>
<p>这时候进一步折腾的想法就出来了：既然叫app嘛，功能应该多一点，不单收报警，还能存下来，这样出去一趟回来可以看离线记录。</p>
<p>下面就说离线的packaged app。</p>
<p><code>manifest.json</code>的app里就不能写urls要写background了。文档中说background可以写scripts或者page，但是我实验发现scripts正常page不起作用(也确实不报错)。</p>
<div class="highlight"><pre><code class="javascript"><span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Packaged App&quot;</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;0.1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;app&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;background&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;scripts&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;juggernaut.js&quot;</span><span class="p">,</span> <span class="s2">&quot;filesystem.js&quot;</span><span class="p">,</span> <span class="s2">&quot;background.js&quot;</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;permissions&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">,</span> <span class="s2">&quot;notifications&quot;</span><span class="p">,</span> <span class="s2">&quot;unlimitedStorage&quot;</span><span class="p">],</span>
  <span class="s2">&quot;manifest_version&quot;</span><span class="o">:</span> <span class="mi">2</span>
<span class="p">}</span>
</code></pre></div>
<p>chrome app会自动把scripts数组<code>依次</code>加载。
这里需要注意修改一下默认的juggernaut/application.js，因为chrome packaged app没有浏览器框架，所以disconnect那有个报错，删除掉那三行即可。
然后background.js里最常见的功能是当点击app的时候弹出的页面，代码如下：</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">chrome</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">onLaunched</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">chrome</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s1">&#39;main.html&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="mi">400</span><span class="p">,</span>
    <span class="s1">&#39;height&#39;</span><span class="o">:</span> <span class="mi">500</span><span class="p">,</span>
    <span class="c1">//frame: &#39;none&#39;</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>如果css够好，可以开启<code>frame: none</code>，然后页面看不到一丝浏览器的样子，你就可以做得跟真的app一样有自己的控制了。</p>
<p>然后是文件操作。html5有file api。所以可以直接操作文件了：</p>
<div class="highlight"><pre><code class="javascript"><span class="nb">window</span><span class="p">.</span><span class="nx">webkitRequestFileSystem</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">TEMPORARY</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fs</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">getFile</span><span class="p">(</span><span class="s2">&quot;syslog.txt&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">create</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileEntry</span><span class="p">){</span>
        <span class="nx">fileEntry</span><span class="p">.</span><span class="nx">createWriter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fileWriter</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">bb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="s2">&quot;New File Ready\n&quot;</span><span class="p">],</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
            <span class="nx">fileWriter</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">bb</span><span class="p">);</span>
        <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
<span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
<span class="kd">function</span> <span class="nx">append_file</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">webkitRequestFileSystem</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">TEMPORARY</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fs</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">getFile</span><span class="p">(</span><span class="s2">&quot;syslog.txt&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">create</span><span class="o">:</span> <span class="kc">false</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileEntry</span><span class="p">){</span>
            <span class="nx">fileEntry</span><span class="p">.</span><span class="nx">createWriter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fileWriter</span><span class="p">){</span>
                <span class="nx">fileWriter</span><span class="p">.</span><span class="nx">seek</span><span class="p">(</span><span class="nx">fileWriter</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">bb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">msg</span><span class="p">],</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
                <span class="nx">fileWriter</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">bb</span><span class="p">);</span>
            <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
        <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>这里大多数网上的例子都还是用的<code>BlobBuilder()</code>，经过我试验，至少在chromium version24上，已经没有这个API了。</p>
<p>这里注意一个问题：Juggernaut同时收到多条消息，调用append_file()的话，会有文件锁问题。所以我加上一个缓冲控制：</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">message</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">append_file</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="mi">60000</span><span class="p">);</span>
<span class="nx">jug</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s2">&quot;syslog&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span><span class="p">;</span>
    <span class="nx">message</span> <span class="o">+=</span> <span class="nx">msg</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="nx">notification</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div>
<p>后台的工作大概就是这些。然后是弹出的main.html。记住之前提到的，不能在里面写js。所以html里除了写个div啥都没有，功能依然交给main.js来做：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;title&gt;</span>Storage test<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;main.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;bar&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">&quot;form&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;reload-window-button&quot;</span><span class="nt">&gt;</span>刷新<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;remove-window-button&quot;</span><span class="nt">&gt;</span>清空<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;close-window-button&quot;</span><span class="nt">&gt;</span>关闭<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&#39;log&#39;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">&#39;msg&#39;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>不过关于刷新页面的问题现在还比较茫然，试过metadata/reload/location.href等各种办法，都不起作用，只能在页面上右键选择刷新……</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">channel_file</span> <span class="o">=</span> <span class="s1">&#39;syslog.txt&#39;</span><span class="p">;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">webkitRequestFileSystem</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">TEMPORARY</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fs</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">getFile</span><span class="p">(</span><span class="nx">channel_file</span><span class="p">,</span> <span class="p">{},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileEntry</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fileEntry</span><span class="p">.</span><span class="nx">file</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
            <span class="nx">reader</span><span class="p">.</span><span class="nx">onloadend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">logul</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">logli</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">);</span>
                <span class="nx">logli</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
                <span class="nx">logul</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">logli</span><span class="p">,</span> <span class="nx">logul</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
            <span class="p">};</span>
            <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsText</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
            <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
        <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;remove-window-button&quot;</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">webkitRequestFileSystem</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">TEMPORARY</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fs</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fs</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">getFile</span><span class="p">(</span><span class="nx">channel_file</span><span class="p">,</span> <span class="p">{</span><span class="nx">create</span><span class="o">:</span> <span class="kc">false</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileEntry</span><span class="p">){</span>
                <span class="nx">fileEntry</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                    <span class="nx">fs</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">getFile</span><span class="p">(</span><span class="nx">channel_file</span><span class="p">,</span> <span class="p">{</span><span class="nx">create</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileEntry</span><span class="p">){</span>
                        <span class="nx">fileEntry</span><span class="p">.</span><span class="nx">createWriter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fileWriter</span><span class="p">){</span>
                            <span class="kd">var</span> <span class="nx">bb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="s2">&quot;Clean Over\n&quot;</span><span class="p">],</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
                            <span class="nx">fileWriter</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">bb</span><span class="p">);</span>
                        <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
                    <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
                <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
            <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
        <span class="p">},</span> <span class="nx">errorHandler</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;close-window-button&quot;</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;reload-window-button&quot;</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>以上。</p>
<p>最后，如果完成了，在浏览器上直接选择打包即可。不过新版本的chrome已经不再允许直接安装非web store的crx了……</p>
      <a href="/2012/11/09/chrome-app-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page2">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page active">
      <a href="#">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li>
      <a href="/page4">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
              <li><a href="http://showmetheco.de/" title="Viacheslav Tykhanovskyi(PocketIO/Text::Haml)">No time to wait</a></li>
              <li><a href="http://blog.dataloop.io/" title="A new SaaS monitoring tool for DevOps & Operations">Dataloop.IO</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://junqili.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.sectop.org/" title="">kindle</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
          </ul>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
