<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/10/17/juggernaut-for-syslog-check" title="用Juggernaut实时推送syslog分析结果" rel="bookmark">用Juggernaut实时推送syslog分析结果</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-10-17 00:00:00 +0800">17 Oct 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>大家一般都会用rsyslog或者syslog-ng之类的收集系统日志。不过收集之后的处理就各种各样了。这里提供一个简单的处理，按日期保存成文件，然后定时分析新增内容，通过websocket推送到页面报警。这对于像磁盘错误等信息比较有用。因为等nagios之类的监控反应出来，故障可能就已经到你措手不及的地步了。</p>
<p>这里介绍一下Juggernaut项目，作者当初还在上学的时候就开始搞这个项目并最终因为这个项目找到的工作。不过几个月前他宣布不再维护了，因为他觉得html5已经普及，大家直接写websocket就够了。额，在口年的中国，我觉得Juggernaut还是很有意义的。项目地址：<a href="https://github.com/maccman/juggernaut">https://github.com/maccman/juggernaut</a>。</p>
<p>举例中有ruby、js和python的样例，不过既然是用Redis传消息，那么改成perl的代码跟python的比差距也就很小了。</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl</span>
<span class="k">use</span> <span class="n">AnyEvent</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Long</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Redis</span><span class="p">;</span>
<span class="k">use</span> <span class="n">JSON</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw/ strftime /</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="mf">5.010</span><span class="p">;</span>
<span class="c1"># 后台运行</span>
<span class="k">use</span> <span class="nn">App::</span><span class="n">Daemon</span> <span class="sx">qw( daemonize )</span><span class="p">;</span>
<span class="nv">$</span><span class="nn">App::Daemon::</span><span class="nv">as_user</span>    <span class="o">=</span> <span class="s">&quot;root&quot;</span><span class="p">;</span>
<span class="n">daemonize</span><span class="p">();</span>
<span class="c1"># 设定调试和间隔</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">,</span> <span class="nv">$interval</span><span class="p">,</span> <span class="nv">$help</span><span class="p">);</span>                                                                                                                                                        
<span class="n">GetOptions</span><span class="p">(</span>                                                                                                                                                                           
    <span class="s">&quot;debug|d&quot;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$debug</span><span class="p">,</span>                                                                                                                                                             
    <span class="s">&quot;interval|i=i&quot;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$interval</span><span class="p">,</span>                                                                                                                                                     
    <span class="s">&quot;help|h&quot;</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$help</span><span class="p">,</span>                                                                                                                                                               
<span class="p">);</span>                                                                                                                                                                                    
<span class="k">if</span><span class="p">(</span> <span class="nv">$help</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">say</span> <span class="s">&quot;Usage: $0 [start|stop|-X] -d -i num&quot;</span><span class="p">;</span>
    <span class="n">say</span> <span class="s">&quot;       -X means run frontend;&quot;</span><span class="p">;</span>
    <span class="n">say</span> <span class="s">&quot;       -d means debug for timer and submit;&quot;</span><span class="p">;</span>
    <span class="n">say</span> <span class="s">&quot;       -i means define a special interval seconds for regexp and submit, default set 300s.&quot;</span><span class="p">;</span>
<span class="p">};</span>
<span class="nv">$interval</span> <span class="o">=</span> <span class="mi">300</span> <span class="k">unless</span> <span class="nv">$interval</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@str</span> <span class="o">=</span> <span class="p">();</span>
<span class="c1"># syslog的pri，定义见http://www.ietf.org/rfc/rfc3164.txt。因为本例只收集kernel信息，即Facility = 0,所以PRI = 0 * 8 + Severity。这里为了页面好看直接写成bootstrap里button的class了。</span>
<span class="k">my</span> <span class="nv">@pri</span> <span class="o">=</span> <span class="sx">qw(</span>
<span class="sx">    btn-inverse</span>
<span class="sx">    btn-danger</span>
<span class="sx">    btn-warning</span>
<span class="sx">    btn-success</span>
<span class="sx">    btn-info</span>
<span class="sx">    btn-primary</span>
<span class="sx">    btn</span>
<span class="sx">    disabled</span>
<span class="sx">)</span><span class="p">;</span>
<span class="c1"># syslog格式&lt;IP&gt; &lt;TIME&gt; &lt;PRI&gt; kernel: &lt;MSG&gt;</span>
<span class="c1"># 注意最后msg里的\S.+，因为当内存出错等情况时，msg里开头会以空格表示附属关系</span>
<span class="k">my</span> <span class="nv">$re</span> <span class="o">=</span> <span class="sx">qr/((?:\d{1,3}\.){3}\d{1,3}) \[(\w+ \d+ \d{2}:\d{2}:\d{2})\] &lt;(\d+)&gt; kernel: (\S.+)/</span><span class="p">;</span>
<span class="c1"># 目前是直接收集成时间格式命名了，所以每天crond里要restart脚本，如果是日志名不变，crond切割的，那么脚本可以一直跑</span>
<span class="nb">open</span><span class="p">(</span><span class="k">my</span> <span class="nv">$r</span><span class="p">,</span> <span class="s">&quot;-|&quot;</span><span class="p">,</span> <span class="s">&quot;tail&quot;</span><span class="p">,</span> <span class="s">&quot;-F&quot;</span><span class="p">,</span> <span class="s">&#39;/data1/syslog/kern.&#39;</span> <span class="o">.</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y%m%d&quot;</span><span class="p">,</span> <span class="nb">localtime</span><span class="p">)</span> <span class="o">.</span> <span class="s">&#39;.log&#39;</span> <span class="p">)</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;can&#39;t fork: $!&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$io</span> <span class="o">=</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">(</span>
    <span class="n">fh</span> <span class="o">=&gt;</span> <span class="nv">$r</span><span class="p">,</span>
    <span class="n">poll</span> <span class="o">=&gt;</span> <span class="s">&quot;r&quot;</span><span class="p">,</span>
    <span class="n">cb</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">$input</span> <span class="o">=</span> <span class="nb">scalar</span> <span class="sr">&lt;$r&gt;</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">if</span> <span class="nv">$input</span> <span class="o">=~</span><span class="sr"> /repeat|suppress|window/</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@str</span><span class="p">,</span> <span class="nv">$input</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">);</span>
<span class="k">my</span> <span class="nv">$w</span> <span class="o">=</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">(</span>
    <span class="n">after</span> <span class="o">=&gt;</span> <span class="nv">$interval</span><span class="p">,</span>
    <span class="n">interval</span> <span class="o">=&gt;</span> <span class="nv">$interval</span><span class="p">,</span>
    <span class="n">cb</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="n">say</span> <span class="s">&quot;######## &quot;</span><span class="p">,</span><span class="nb">time</span> <span class="k">if</span> <span class="nv">$debug</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nv">@str</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">next</span> <span class="k">unless</span> <span class="nv">$_</span> <span class="o">=~</span> <span class="nv">$re</span><span class="p">;</span>
            <span class="k">my</span> <span class="p">(</span> <span class="nv">$ip</span><span class="p">,</span> <span class="nv">$time</span><span class="p">,</span> <span class="nv">$level</span><span class="p">,</span> <span class="nv">$msg</span> <span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="nv">$1</span><span class="p">,</span> <span class="nv">$2</span><span class="p">,</span> <span class="nv">$3</span><span class="p">,</span> <span class="nv">$4</span> <span class="p">);</span>
            <span class="k">next</span> <span class="k">if</span> <span class="nb">exists</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$ip</span><span class="p">};</span>
            <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$ip</span><span class="p">}</span> <span class="o">=</span> <span class="n">classify</span><span class="p">(</span><span class="nv">$msg</span><span class="p">);</span>
            <span class="n">submit</span><span class="p">(</span> <span class="nv">$time</span><span class="p">,</span> <span class="nv">$ip</span><span class="p">,</span> <span class="nv">$pri</span><span class="p">[</span><span class="nv">$level</span><span class="p">],</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$ip</span><span class="p">},</span> <span class="nv">$msg</span> <span class="p">);</span>
        <span class="p">};</span>
        <span class="nv">@str</span> <span class="o">=</span> <span class="p">();</span>
    <span class="p">},</span>
<span class="p">);</span>
<span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">condvar</span><span class="o">-&gt;</span><span class="nb">recv</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">submit</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">@msg</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="n">say</span> <span class="nv">@msg</span> <span class="k">if</span> <span class="nv">$debug</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$redis</span> <span class="o">=</span> <span class="n">Redis</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">server</span> <span class="o">=&gt;</span> <span class="s">&#39;198.168.0.2:6379&#39;</span> <span class="p">);</span>
    <span class="nv">$redis</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="s">&quot;juggernaut&quot;</span><span class="p">,</span> <span class="n">to_json</span><span class="p">({</span>
        <span class="n">channels</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s">&#39;channel1&#39;</span><span class="p">],</span>
        <span class="n">data</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@msg</span><span class="p">,</span>
    <span class="p">}));</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">classify</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$msg</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$msg</span> <span class="o">=~</span><span class="sr"> /TCP|UDP|SYN|socket/</span> <span class="p">)</span> <span class="p">{</span>
        <span class="s">&#39;network&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$msg</span> <span class="o">=~</span><span class="sr"> /segfault|swap|mem|allocation/</span> <span class="p">)</span> <span class="p">{</span>
        <span class="s">&#39;memory&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$msg</span> <span class="o">=~</span><span class="sr"> /IPMI|EXT|cciss|scsi|mpt|usb|DRAC|sd\w/</span> <span class="p">)</span> <span class="p">{</span>
        <span class="s">&#39;disk&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$msg</span> <span class="o">=~</span><span class="sr"> /CPU|IRQ/</span> <span class="p">)</span> <span class="p">{</span>
        <span class="s">&#39;cpu&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="s">&#39;unknown&#39;</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>然后写html页面来接收。</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;charset&quot;</span> <span class="na">content=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>syslog-push-webUI<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://192.168.0.2:8080/application.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/javascripts/jquery-1.7.2.min.js &quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&#39;syslog&#39;</span> <span class="na">style=</span><span class="s">&quot;overflow-y: scroll; border: #999&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;unstyled&quot;</span> <span class="na">id=</span><span class="s">&#39;msg&#39;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;&lt;button</span> <span class="na">class=</span><span class="s">&quot;btn&quot;</span> <span class="na">id=</span><span class="s">&quot;notify-permission-button&quot;</span><span class="nt">&gt;</span>开启桌面通知<span class="nt">&lt;/button&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">msg</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#msg li:gt(40)&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">msg</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">msg</span> <span class="o">=</span> <span class="s1">&#39;&lt;blockquote&gt;&#39;</span><span class="p">;</span>
          <span class="nx">msg</span> <span class="o">+=</span> <span class="s1">&#39;&lt;button type = &quot;button&quot; class=&quot;btn-mini &#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/button&gt;: &#39;</span><span class="p">;</span>
          <span class="nx">msg</span> <span class="o">+=</span> <span class="s1">&#39;&lt;code&gt;&#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/code&gt;&#39;</span><span class="p">;</span>
          <span class="nx">msg</span> <span class="o">+=</span> <span class="s1">&#39;&lt;small&gt;&lt;strong&gt;&#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/strong&gt; &#39;</span><span class="p">;</span>
          <span class="nx">msg</span> <span class="o">+=</span> <span class="s1">&#39;&lt;cite&gt;&#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/cite&gt;&lt;/small&gt;&#39;</span><span class="p">;</span>
          <span class="nx">msg</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/blockquote&gt;&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#msg:first-child&#39;</span><span class="p">).</span><span class="nx">prepend</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&#39;</span> <span class="o">+</span> <span class="nx">msg</span> <span class="o">+</span> <span class="s1">&#39;&lt;/li&gt;&#39;</span><span class="p">);</span>
      <span class="p">};</span>
      <span class="kd">var</span> <span class="nx">jug</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Juggernaut</span><span class="p">({</span>
        <span class="nx">secure</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;https:&#39;</span> <span class="o">==</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">),</span>
        <span class="nx">host</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
        <span class="nx">port</span><span class="o">:</span> <span class="mi">8080</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">port</span>
      <span class="p">});</span>
      <span class="nx">jug</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;connect&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&quot;&lt;code&gt;Connected&lt;/code&gt;&quot;</span><span class="p">)</span> <span class="p">});</span>
      <span class="nx">jug</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;disconnect&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&quot;&lt;code&gt;Disconnected&lt;/code&gt;&quot;</span><span class="p">)</span> <span class="p">});</span>
      <span class="nx">jug</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;reconnect&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&quot;&lt;code&gt;Reconnecting&lt;/code&gt;&quot;</span><span class="p">)</span> <span class="p">});</span>
      <span class="nx">jug</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s2">&quot;channel1&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
        <span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;btn&#39;</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">desk_notify</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">};</span>
      <span class="p">});</span>
      <span class="kd">var</span> <span class="nx">desk_notify</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">webkitNotifications</span><span class="p">){</span>
          <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">webkitNotifications</span><span class="p">.</span><span class="nx">checkPermission</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">RequestPermission</span><span class="p">(</span><span class="nx">desk_notify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">notification</span> <span class="o">=</span> <span class="nx">webkitNotifications</span><span class="p">.</span><span class="nx">createNotification</span><span class="p">(</span>
              <span class="s1">&#39;http://a.xnimg.cn/imgpro/app/mobile/renren_phone_icon2.png&#39;</span><span class="p">,</span>
              <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
              <span class="nx">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="p">);</span>
            <span class="nx">notification</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="kd">function</span> <span class="nx">RequestPermission</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">webkitNotifications</span><span class="p">.</span><span class="nx">requestPermission</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#notify-permission-button&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#notify-permission-button&#39;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
        <span class="nx">desk_notify</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;syslog realtime push&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;开启&#39;</span><span class="p">]);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>这里除了juggernaut的代码以外，还加上了chrome独有的webkitnotification功能，这样使用chrome的话，可以打开桌面通知，监控效果更佳～</p>
<p>注意：chrome桌面通知的权限授予，不能通过页面代码自动触发，必须显式的用button.click来触发。</p>
<p><strong>2013 年 2 月 17 日更新：</strong></p>
<p>我的 Ubuntu 12.10 更新到 firefox 18.0.2 版本后，以上代码也可以出现桌面通知了。不过奇怪的是：第一至今没有看到哪里有这个更新说明；第二我确实没有安装相关的extension，事实上我一共就安装了 firebug/xmarks/adblocks 三个扩展。</p>
      <a href="/2012/10/17/juggernaut-for-syslog-check" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/10/02/gather-take-in-perl5" title="Perl5里的gather/take" rel="bookmark">Perl5里的gather/take</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-10-02 00:00:00 +0800">02 Oct 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>九月末的YAPC::Asia上，Larry Wall展示了一下怎么把一个perl5上很标准的排序脚本改造成perl6脚本。主要是条件语句不再用()了，子函数传参方式，对象化操作等等。唯独有个命令是之前未见过的：gather/take。用这个可以减少临时变量的使用。</p>
<p>找了一下，类似命令在perl5中有多个模块对应：<a href="http://search.cpan.org/~moritz/Perl6-GatherTake-0.0.3/lib/Perl6/GatherTake.pm">Perl6::GatherTake</a>、<a href="http://search.cpan.org/~gaal/Perl6-Take-0.04/lib/Perl6/Take.pm">Perl6::Take</a>、<a href="http://search.cpan.org/~dconway/Perl6-Gather-0.42/lib/Perl6/Gather.pm">Perl6::Gather</a>、<a href="http://search.cpan.org/~flora/List-Gather-0.06/lib/List/Gather.pm">List::Gather</a>和<a href="http://search.cpan.org/~frew/Syntax-Keyword-Gather-1.002000/lib/Syntax/Keyword/Gather.pm">Syntax::Keyword::Gather</a>。</p>
<p>具体的说明，可以看<a href="http://search.cpan.org/~dconway/Perl6-Gather-0.42/lib/Perl6/Gather.pm">Perl6::Gather</a>的POD说明，比较详细。其他的都是简单给个例子就是了。</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Perl6::</span><span class="n">Gather</span><span class="p">;</span>
<span class="k">print</span> <span class="n">gather</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">@data</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">take</span> <span class="k">if</span> <span class="nv">$_</span> <span class="nv">%</span> <span class="nv">2</span><span class="p">;</span>
        <span class="n">take</span> <span class="n">to_num</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="k">if</span> <span class="sr">/(?:one|three|five|nine)\z/</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">take</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span> <span class="k">unless</span> <span class="n">gathered</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>相当于：</p>
<div class="highlight"><pre><code class="perl"><span class="k">my</span> <span class="nv">@arrays</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">@data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">push</span> <span class="nv">@arrays</span><span class="p">,</span> <span class="nv">$_</span> <span class="k">if</span> <span class="nv">$_</span> <span class="nv">%</span> <span class="nv">2</span><span class="p">;</span>
    <span class="nb">push</span> <span class="nv">@arrays</span><span class="p">,</span> <span class="n">to_num</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="k">if</span> <span class="sr">/(?:one|three|five|nine)\z/</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">@arrays</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span> <span class="k">unless</span> <span class="nv">@arrays</span><span class="p">;</span>
<span class="k">print</span> <span class="nv">@arrays</span><span class="p">;</span>
</code></pre></div>
<p>省略的就是这个push用的临时@arrays变量。同样也可以是标量，用~gather就可以省略.=了，比gather前面多一个波浪号~。</p>
      <a href="/2012/10/02/gather-take-in-perl5" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/09/26/jsonp-for-new-version-amcharts" title="用javascript操作新版本amcharts" rel="bookmark">用javascript操作新版本amcharts</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-26 00:00:00 +0800">26 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>新版本的amcharts用js和html5改写。不再简单的用settings.xml而是写成js的object了。好在例子依然详细。下面贴一段从数据库里取值并绘制成多栏图式的代码：</p>
<div class="highlight"><pre><code class="javascript"><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">meta</span> <span class="nx">http</span><span class="o">-</span><span class="nx">equiv</span><span class="o">=</span><span class="s2">&quot;Content-Type&quot;</span> <span class="nx">content</span><span class="o">=</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;</span><span class="nx">amStock</span> <span class="nx">Example</span><span class="o">&lt;</span><span class="err">/title&gt;</span>
        <span class="o">&lt;</span><span class="nx">link</span> <span class="nx">rel</span><span class="o">=</span><span class="s2">&quot;stylesheet&quot;</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;../amcharts/style.css&quot;</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/css&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;../javascripts/jquery-1.7.2.min.js&quot;</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
        <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;../amcharts/amstock.js&quot;</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
        <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;</span>
            <span class="kd">var</span> <span class="nx">chart</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">dataProvider</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
                    <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
                    <span class="nx">dataType</span><span class="o">:</span><span class="s2">&quot;jsonp&quot;</span><span class="p">,</span>
                    <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;http://api.domain.com/database/table/find&quot;</span><span class="p">,</span>
                    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;body&quot;</span><span class="o">:</span><span class="s1">&#39;{&quot;sort&quot;:[[&quot;date&quot;,-1]], &quot;limit&quot;:10000}&#39;</span><span class="p">},</span>
                    <span class="nx">jsonp</span><span class="o">:</span><span class="s1">&#39;jsonpCallback&#39;</span><span class="p">,</span>
                    <span class="nx">jsonpCallback</span><span class="o">:</span><span class="s1">&#39;jsonCallbackFunction&#39;</span><span class="p">,</span>
                    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
                    <span class="p">},</span>
                    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span>
                        <span class="nx">alert</span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">);</span>
                        <span class="nx">alert</span><span class="p">(</span><span class="nx">textStatus</span><span class="p">);</span>
                        <span class="nx">alert</span><span class="p">(</span><span class="nx">errorThrown</span><span class="p">);</span>
                    <span class="p">},</span>
                <span class="p">});</span>
            <span class="p">});</span>
            <span class="kd">function</span> <span class="nx">jsonCallbackFunction</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">parseJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
                <span class="nx">createStockChart</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="kd">function</span> <span class="nx">createStockChart</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmStockChart</span><span class="p">();</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">pathToImages</span> <span class="o">=</span> <span class="s2">&quot;../amcharts/images/&quot;</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">categoryAxesSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">CategoryAxesSettings</span><span class="p">();</span>
                <span class="c1">//定义显示的最小时间段，前提是X轴是Date对象</span>
                <span class="nx">categoryAxesSettings</span><span class="p">.</span><span class="nx">minPeriod</span> <span class="o">=</span> <span class="s2">&quot;hh&quot;</span><span class="p">;</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">categoryAxesSettings</span> <span class="o">=</span> <span class="nx">categoryAxesSettings</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">dataSet1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">DataSet</span><span class="p">();</span>
                <span class="c1">//注意这里的field要和json里的key一致</span>
                <span class="nx">dataSet1</span><span class="p">.</span><span class="nx">fieldMappings</span> <span class="o">=</span> <span class="p">[{</span>
                    <span class="nx">fromField</span><span class="o">:</span> <span class="s2">&quot;Total&quot;</span><span class="p">,</span>
                    <span class="nx">toField</span><span class="o">:</span> <span class="s2">&quot;Total&quot;</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="nx">fromField</span><span class="o">:</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span>
                    <span class="nx">toField</span><span class="o">:</span> <span class="s2">&quot;Error&quot;</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="nx">fromField</span><span class="o">:</span> <span class="s2">&quot;ErrorRate&quot;</span><span class="p">,</span>
                    <span class="nx">toField</span><span class="o">:</span> <span class="s2">&quot;ErrorRate&quot;</span><span class="p">,</span>
                <span class="p">}];</span>
                <span class="nx">dataSet1</span><span class="p">.</span><span class="nx">dataProvider</span> <span class="o">=</span> <span class="nx">dataProvider</span><span class="p">;</span>
                <span class="nx">dataSet1</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">=</span> <span class="s2">&quot;date&quot;</span><span class="p">;</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">dataSets</span> <span class="o">=</span> <span class="p">[</span><span class="nx">dataSet1</span><span class="p">];</span>
                <span class="nx">stockPanel1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockPanel</span><span class="p">();</span>
                <span class="c1">//第一栏占全图的百分比</span>
                <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">percentHeight</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">valueAxis1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>
                <span class="c1">//Y轴数值位置，amstock中无法设定Y轴偏移量</span>
                <span class="nx">valueAxis1</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">;</span>
                <span class="nx">valueAxis1</span><span class="p">.</span><span class="nx">axisColor</span> <span class="o">=</span> <span class="s2">&quot;#999999&quot;</span><span class="p">;</span>
                <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis1</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">graph1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockGraph</span><span class="p">();</span>
                <span class="nx">graph1</span><span class="p">.</span><span class="nx">valueField</span> <span class="o">=</span> <span class="s2">&quot;Total&quot;</span><span class="p">;</span>
                <span class="nx">graph1</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;总计&quot;</span><span class="p">;</span>
                <span class="c1">//平滑曲线</span>
                <span class="nx">graph1</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;smoothedLine&quot;</span><span class="p">;</span>
                <span class="nx">graph1</span><span class="p">.</span><span class="nx">lineColor</span> <span class="o">=</span> <span class="s2">&quot;#999999&quot;</span><span class="p">;</span>
                <span class="c1">//曲线下方区域的透明度</span>
                <span class="nx">graph1</span><span class="p">.</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>
                <span class="nx">graph1</span><span class="p">.</span><span class="nx">useDataSetColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addStockGraph</span><span class="p">(</span><span class="nx">graph1</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">stockLegend1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockLegend</span><span class="p">();</span>
                <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">stockLegend</span> <span class="o">=</span> <span class="nx">stockLegend1</span><span class="p">;</span>
                <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">drawingIconsEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">valueAxis2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>
                <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">axisColor</span> <span class="o">=</span> <span class="s2">&quot;#FCD202&quot;</span><span class="p">;</span>
                <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">gridAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">axisThickness</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
                <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis2</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">graph2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockGraph</span><span class="p">();</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">valueAxis</span> <span class="o">=</span> <span class="nx">valueAxis2</span><span class="p">;</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;smoothedLine&quot;</span><span class="p">;</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;错误&quot;</span><span class="p">;</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">valueField</span> <span class="o">=</span> <span class="s2">&quot;Error&quot;</span><span class="p">;</span>
                <span class="c1">//绘点的形状</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">bullet</span> <span class="o">=</span> <span class="s2">&quot;square&quot;</span><span class="p">;</span>
                <span class="c1">//图上超过多少点就不显示形状了</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">hideBulletsCount</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">lineColor</span> <span class="o">=</span> <span class="s2">&quot;#FCD202&quot;</span><span class="p">;</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">lineThickness</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
                <span class="nx">graph2</span><span class="p">.</span><span class="nx">useDataSetColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addStockGraph</span><span class="p">(</span><span class="nx">graph2</span><span class="p">);</span>
                <span class="nx">stockPanel2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockPanel</span><span class="p">();</span>
                <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">percentHeight</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
                <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">marginTop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
                <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">showCategoryAxis</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="nx">valueAxis5</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>
                <span class="nx">valueAxis5</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
                <span class="nx">valueAxis5</span><span class="p">.</span><span class="nx">gridAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="nx">valueAxis5</span><span class="p">.</span><span class="nx">axisThickness</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
                <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis5</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">graph5</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockGraph</span><span class="p">();</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">valueAxis</span> <span class="o">=</span> <span class="nx">valueAxis5</span><span class="p">;</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">valueField</span> <span class="o">=</span> <span class="s2">&quot;ErrorRate&quot;</span><span class="p">;</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;错误比率&quot;</span><span class="p">;</span>
                <span class="c1">//漂浮显示的文字，可用graph.valueField的[[value]]和graph.descriptionField的[[description]]</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">balloonText</span> <span class="o">=</span> <span class="s2">&quot;[[value]]%&quot;</span><span class="p">;</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;column&quot;</span><span class="p">;</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">cornerRadiusTop</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">lineColor</span> <span class="o">=</span> <span class="s2">&quot;#FCD202&quot;</span><span class="p">;</span>
                <span class="nx">graph5</span><span class="p">.</span><span class="nx">useDataSetColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">addStockGraph</span><span class="p">(</span><span class="nx">graph5</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">stockLegend2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockLegend</span><span class="p">();</span>
                <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">stockLegend</span> <span class="o">=</span> <span class="nx">stockLegend2</span><span class="p">;</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">panels</span> <span class="o">=</span> <span class="p">[</span><span class="nx">stockPanel1</span><span class="p">,</span> <span class="nx">stockPanel2</span><span class="p">];</span>
                <span class="kd">var</span> <span class="nx">sbsettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartScrollbarSettings</span><span class="p">();</span>
                <span class="c1">//根据graph1显示拖动条栏</span>
                <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="nx">graph1</span><span class="p">;</span>
                <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">graphType</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span><span class="p">;</span>
                <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">chartScrollbarSettings</span> <span class="o">=</span> <span class="nx">sbsettings</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">cursorSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartCursorSettings</span><span class="p">();</span>
                <span class="c1">//光标移动时跟随显示漂浮气球</span>
                <span class="nx">cursorSettings</span><span class="p">.</span><span class="nx">valueBalloonsEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">chartCursorSettings</span> <span class="o">=</span> <span class="nx">cursorSettings</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">periodSelector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">PeriodSelector</span><span class="p">();</span>
                <span class="nx">periodSelector</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;bottom&quot;</span><span class="p">;</span>
                <span class="nx">periodSelector</span><span class="p">.</span><span class="nx">periods</span> <span class="o">=</span> <span class="p">[{</span>
                    <span class="nx">period</span><span class="o">:</span> <span class="s2">&quot;DD&quot;</span><span class="p">,</span>
                    <span class="nx">selected</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                    <span class="nx">count</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;1 day&quot;</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="nx">period</span><span class="o">:</span> <span class="s2">&quot;DD&quot;</span><span class="p">,</span>
                    <span class="nx">count</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
                    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;1 week&quot;</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="nx">period</span><span class="o">:</span> <span class="s2">&quot;MM&quot;</span><span class="p">,</span>
                    <span class="nx">count</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;1 month&quot;</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="nx">period</span><span class="o">:</span> <span class="s2">&quot;YYYY&quot;</span><span class="p">,</span>
                    <span class="nx">count</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;1 year&quot;</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="nx">period</span><span class="o">:</span> <span class="s2">&quot;YTD&quot;</span><span class="p">,</span>
                    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;YTD&quot;</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="nx">period</span><span class="o">:</span> <span class="s2">&quot;MAX&quot;</span><span class="p">,</span>
                    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;MAX&quot;</span>
                <span class="p">}];</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">periodSelector</span> <span class="o">=</span> <span class="nx">periodSelector</span><span class="p">;</span>
                <span class="nx">chart</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;chartdiv&quot;</span><span class="p">);</span>
            <span class="p">};</span>
            <span class="kd">function</span> <span class="nx">parseDate</span><span class="p">(</span><span class="nx">dateString</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">dateArray</span> <span class="o">=</span> <span class="nx">dateString</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">dateArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">dateArray</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">dateArray</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">dateArray</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
                <span class="k">return</span> <span class="nx">date</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kd">function</span> <span class="nx">parseJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
                <span class="nx">dataProvider</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">reverse</span><span class="p">();</span>
                <span class="c1">//其余列原样保存，时间列必须把字符串转换成Date对象</span>
                <span class="k">for</span><span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dataProvider</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">dataProvider</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">date</span> <span class="o">=</span> <span class="nx">parseDate</span><span class="p">(</span><span class="nx">dataProvider</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">date</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">};</span>
        <span class="o">&lt;</span><span class="err">/script&gt;</span>
    <span class="o">&lt;</span><span class="err">/head&gt;</span>
    <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;chartdiv&quot;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&quot;width: 100%; height: 700px;&quot;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;</span>
    <span class="o">&lt;</span><span class="err">/body&gt;</span>
<span class="o">&lt;</span><span class="err">/html&gt;</span>
</code></pre></div>
      <a href="/2012/09/26/jsonp-for-new-version-amcharts" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/09/21/json-event-for-logstash" title="【Logstash系列】数据格式之json-event" rel="bookmark">【Logstash系列】数据格式之json-event</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-21 00:00:00 +0800">21 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前的各种示例中，都没有提到logstash的输入输出格式。看起来就好像logstash比Message::Passing少了decoder/encoder一样。其实logstash也有类似的设定的，这就是format。有三种选择：plain/json/json_event。默认情况下是plain。也就是我们之前的通用做法，传文本给logstash，由logstash转换成json。</p>
<p>logstash社区根据某些应用场景，有相关的cookbook。关于访问日志，有<a href="http://cookbook.logstash.net/recipes/apache-json-logs/">http://cookbook.logstash.net/recipes/apache-json-logs/</a>。这是一个不错的思路！我们可以照葫芦画瓢给nginx也定义一下：</p>
<div class="highlight"><pre><code class="nginx">     <span class="k">logformat</span> <span class="s">json</span> <span class="s">&#39;</span><span class="p">{</span><span class="kn">&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#39;</span>
                    <span class="s">&#39;&quot;@source&quot;:&quot;</span><span class="nv">$server_addr&quot;,&#39;</span>
                    <span class="s">&#39;&quot;@fields&quot;:</span><span class="p">{</span><span class="kn">&#39;</span>
                    <span class="s">&#39;&quot;client&quot;:&quot;</span><span class="nv">$remote_addr&quot;,&#39;</span>
                    <span class="s">&#39;&quot;size&quot;:</span><span class="nv">$body_bytes_sent,&#39;</span>
                    <span class="s">&#39;&quot;responsetime&quot;:</span><span class="nv">$request_time,&#39;</span>
                    <span class="s">&#39;&quot;upstreamtime&quot;:</span><span class="nv">$upstream_response_time,&#39;</span>
                    <span class="s">&#39;&quot;oh&quot;:&quot;</span><span class="nv">$upstream_addr&quot;,&#39;</span>
                    <span class="s">&#39;&quot;domain&quot;:&quot;</span><span class="nv">$host&quot;,&#39;</span>
                    <span class="s">&#39;&quot;url&quot;:&quot;</span><span class="nv">$uri&quot;,&#39;</span>
                    <span class="s">&#39;&quot;status&quot;:&quot;</span><span class="nv">$status&quot;}}&#39;</span><span class="p">;</span>
     <span class="kn">access_log</span> <span class="s">/data/nginx/logs/access.json</span> <span class="s">json</span><span class="p">;</span>
</code></pre></div>
<p>这里需要注意的地方是：因为最后需要插入ES的某些field是有double/float类型。所以麻烦来了：一些端口监控工具的请求，状态码为400的，因为直接断开，所以并没有链接上upstream的服务器，其$upstream_response_time变量不存在，记录在日志里是-，这对于数值型是非法的定义。直接把带有400的日志通过file格式输入给logstash的时候，因为这个非法定义会报错，并把这行日志给丢弃掉。那么我们就无法统计400请求的数据了。</p>
<p>这里需要变通一下，我们知道其实所谓的Input::File就等效于tail -F ${path}${filename}(当然其实不是，模块的实际做法是在~/.sincedb里记录上次读取的位置，然后每${stat_interval}秒检查一次内容更新，每${discover_interval}秒检查一次文件描述符变更。也就是说默认其实是每秒读一次，一次几百上千行，这样效率更高)。所以我们可以自己运行tail命令，然后sed修正upstream_response_time后通过管道传递给logstash的Input::STDIN，效果是一样一样的。
新的logstash/agent.conf如下：</p>
<div class="highlight"><pre><code class="ruby"><span class="n">input</span> <span class="p">{</span>
    <span class="n">stdin</span> <span class="p">{</span>
        <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;nginx&quot;</span>
        <span class="nb">format</span> <span class="o">=&gt;</span> <span class="s2">&quot;json_event&quot;</span>
    <span class="p">}</span>
<span class="p">}</span> 
<span class="n">output</span> <span class="p">{</span>
    <span class="n">amqp</span> <span class="p">{</span>
        <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;nginx&quot;</span>
        <span class="n">host</span> <span class="o">=&gt;</span> <span class="s2">&quot;10.10.10.10&quot;</span>
        <span class="n">key</span>  <span class="o">=&gt;</span> <span class="s2">&quot;cdn&quot;</span>
        <span class="nb">name</span> <span class="o">=&gt;</span> <span class="s2">&quot;logstash&quot;</span>
        <span class="n">exchange_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;direct&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>运行命令如下：</p>
<div class="highlight"><pre><code class="bash">    <span class="c">#!/bin/sh</span>
      tail -F /data/nginx/logs/access.json <span class="se">\</span>
    | sed <span class="s1">&#39;s/upstreamtime&quot;:-/upstreamtime&quot;:0/&#39;</span> <span class="se">\</span>
    | /usr/local/logstash/bin/logstash -f /usr/local/logstash/etc/agent.conf &amp;
</code></pre></div>
<p>这样可以直接省略掉昂贵的Grok操作，同时节约原本的_all/_message/_source_host等等格式的空间。</p>
      <a href="/2012/09/21/json-event-for-logstash" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/09/16/regexp-log-demo-for-nginx" title="【Message::Passing系列】Regexp::Log模板匹配变量" rel="bookmark">【Message::Passing系列】Regexp::Log模板匹配变量</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-16 00:00:00 +0800">16 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上面调用的Regexp::Log::Nginx是base Regexp::Log的实例，CPAN上已经提供了好些server的log regex，见<a href="http://search.cpan.org/search?query=Regexp%3A%3Alog&amp;mode=all">http://search.cpan.org/search?query=Regexp%3A%3Alog&amp;mode=all</a>。</p>
<div class="highlight"><pre><code class="perl">    <span class="c1">#!/usr/bin/perl</span>
    <span class="nb">package</span> <span class="nn">Regexp::Log::</span><span class="n">Nginx</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">base</span> <span class="sx">qw( Regexp::Log )</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">vars</span> <span class="sx">qw( $VERSION %DEFAULT %FORMAT %REGEXP )</span><span class="p">;</span>
    <span class="nv">%DEFAULT</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">format</span>  <span class="o">=&gt;</span> <span class="s">&#39;%date %status %remotehost %domain %request %originhost %responsetime %upstreamtime %bytes %referer %useragent %xforwarderfor&#39;</span><span class="p">,</span>
            <span class="n">capture</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s">&#39;ts&#39;</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">,</span> <span class="s">&#39;remotehost&#39;</span><span class="p">,</span> <span class="s">&#39;url&#39;</span><span class="p">,</span> <span class="s">&#39;oh&#39;</span><span class="p">,</span> <span class="s">&#39;responsetime&#39;</span><span class="p">,</span> <span class="s">&#39;upstreamtime&#39;</span><span class="p">,</span> <span class="s">&#39;bytes&#39;</span> <span class="p">],</span>
    <span class="p">);</span>
    <span class="nv">%FORMAT</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;:default&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;%date %status %remotehost %domain %request %originhost %responsetime %upstreamtime %bytes %referer %useragent %xforwarderfor&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="nv">%REGEXP</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;%date&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=date)\[(?#=ts)\d{2}\/\w{3}\/\d{4}(?::\d{2}){3}(?#!ts) [-+]\d{4}\](?#!date)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%status&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=status)\d+(?#!status)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%remotehost&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=remotehost)\S+(?#!remotehost)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%domain&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=domain).*?(?#!domain)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%request&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=request)-|(?#=method)\w+(?#!method) (?#=url).*?(?#!url) (?#=version)HTTP/\d\.\d(?#!version)(?#!request)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%originhost&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=originhost)-|(?#=oh).*?(?#!oh):\d+(?#!originhost)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%responsetime&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=responsetime)-|.*?(?#!responsetime)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%upstreamtime&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=upstreamtime).*?(?#!upstreamtime)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%bytes&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=bytes)\d+(?#!bytes)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%referer&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=referer)\&quot;(?#=ref).*?(?#!ref)\&quot;(?#!referer)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%useragent&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=useragent)\&quot;(?#=ua).*?(?#!ua)\&quot;(?#!useragent)&#39;</span><span class="p">,</span>
            <span class="s">&#39;%xforwarderfor&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;(?#=xforwarderfor)\&quot;(?#=xff).*?(?#!xff)\&quot;(?#!xforwarderfor)&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="mi">1</span><span class="p">;</span>
</code></pre></div>
      <a href="/2012/09/16/regexp-log-demo-for-nginx" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/09/16/message-passing-filter-demo" title="【Message::Passing系列】过滤器实例" rel="bookmark">【Message::Passing系列】过滤器实例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-16 00:00:00 +0800">16 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p><a href="http://github.com/suretec">Message::Passing</a>是Suretec公司为自己的VoIP业务开发的logstash山寨版。这几个月更新还是比较快的。比之前我刚关注它时改变很大。比如Message::Passing::Output::ElasticSearch已经出来了，还有专门的Message::Passing::Filter::ToLogstash，连命令行方式Message::Passing::Role::Script都采用了MooX::Options构建，相当的OO了。</p>
<p>不过可能是运用环境的区别吧，作者一直在filter方面没有什么动静，可怜巴巴的null/all/key/tologstash这么几个，比起input和output的列表差太远了。而且像logstash里的jls-grok这么最有力的工具没有山寨。</p>
<p>今天有空，稍微写了个例子，可以比较方便的定义类似grok_pattern的方式完成对accesslog的json序列化。不过配置方式比Grok还是麻烦不少，以后真用的话，再考虑config的办法吧，这里主要是为了展示Message::Passing::Filter::XXX的编写：</p>
<div class="highlight"><pre><code class="perl">    <span class="c1">#!/usr/bin/perl</span>
    <span class="nb">package</span> <span class="nn">Message::Passing::Filter::</span><span class="n">GrokLike</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Moo</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">MooX::Types::MooseLike::</span><span class="n">Base</span> <span class="sx">qw/ ArrayRef Str /</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">List::</span><span class="n">MoreUtils</span> <span class="sx">qw/ uniq /</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">DateTime</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Regexp::Log::</span><span class="n">Nginx</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">namespace::</span><span class="n">clean</span> <span class="o">-</span><span class="n">except</span> <span class="o">=&gt;</span> <span class="s">&#39;meta&#39;</span><span class="p">;</span>
    <span class="n">with</span> <span class="s">&#39;Message::Passing::Role::Filter&#39;</span><span class="p">;</span>
    <span class="n">has</span> <span class="nb">format</span> <span class="o">=&gt;</span> <span class="p">(</span>
        <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span>
        <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="s">&#39;%date %status %remotehost %domain %request %originhost %responsetime %upstreamtime %bytes %referer %useragent %xforwarderfor&#39;</span> <span class="p">},</span>
    <span class="p">);</span>
    <span class="n">has</span> <span class="n">capture</span> <span class="o">=&gt;</span> <span class="p">(</span>
        <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span>
        <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">ArrayRef</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="p">[</span> <span class="s">&#39;ts&#39;</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">,</span> <span class="s">&#39;remotehost&#39;</span><span class="p">,</span> <span class="s">&#39;url&#39;</span><span class="p">,</span> <span class="s">&#39;oh&#39;</span><span class="p">,</span> <span class="s">&#39;responsetime&#39;</span><span class="p">,</span> <span class="s">&#39;upstreamtime&#39;</span><span class="p">,</span> <span class="s">&#39;bytes&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="p">);</span>
    <span class="n">has</span> <span class="n">_grok</span> <span class="o">=&gt;</span> <span class="p">(</span>
        <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span>
        <span class="n">lazy</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">builder</span> <span class="o">=&gt;</span> <span class="s">&#39;_build_grok&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">sub </span><span class="nf">_build_grok</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$rln</span> <span class="o">=</span> <span class="nn">Regexp::Log::</span><span class="n">Nginx</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
            <span class="nb">format</span>  <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">format</span><span class="p">,</span>
            <span class="n">capture</span> <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="k">return</span> <span class="nv">$rln</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">sub </span><span class="nf">filter</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$message</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">@fields</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">_grok</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$re</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">_grok</span><span class="o">-&gt;</span><span class="n">regexp</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">%data</span><span class="p">;</span>
        <span class="nv">@data</span><span class="p">{</span><span class="nv">@fields</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;@message&#39;</span><span class="p">}</span> <span class="o">=~</span> <span class="sr">m/$re/</span><span class="p">;</span>
        <span class="nv">$message</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;@fields&#39;</span><span class="p">}</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nv">%data</span><span class="p">,</span>
            <span class="n">responsetime</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">{</span><span class="s">&#39;responsetime&#39;</span><span class="p">}</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">upstreamtime</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">{</span><span class="s">&#39;upstreamtime&#39;</span><span class="p">}</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">bytes</span>        <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">{</span><span class="s">&#39;bytes&#39;</span><span class="p">}</span>        <span class="o">+</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="nv">$message</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">true</span><span class="p">;</span>
</code></pre></div>
<hr />
<p><strong>2012 年 12 月 30 日附注：</strong></p>
<p>前两天已经把这个模块正规化后上传到 CPAN 上了。把捕获定义成 <code>.ini</code> 文件，同时还加入了类似 logstash 里的 mutate filter 的功能。模块叫 <code>Message::Passing::Filter::Regexp</code>。同时上传了一个 <code>Message::Passing::Output::PocketIO</code> 模块，可以打开一个网页时时接收output。</p>
      <a href="/2012/09/16/message-passing-filter-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/09/16/message-passing-agent" title="【Message::Passing系列】客户端收集脚本" rel="bookmark">【Message::Passing系列】客户端收集脚本</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-16 00:00:00 +0800">16 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>最后编写一段日志收集的agent：</p>
<div class="highlight"><pre><code class="perl">    <span class="c1">#!/usr/bin/perl</span>
    <span class="nb">package</span> <span class="n">NginxLogCollector</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Moo</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">MooX::</span><span class="n">Options</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Message::Passing::</span><span class="n">DSL</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">MooX::Types::MooseLike::</span><span class="n">Base</span> <span class="sx">qw/ Str /</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">namespace::</span><span class="n">clean</span> <span class="o">-</span><span class="n">except</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw( meta _options_data _options_config )</span><span class="p">];</span>
    <span class="n">with</span> <span class="s">&#39;Message::Passing::Role::Script&#39;</span><span class="p">;</span>
    <span class="n">option</span> <span class="n">filename</span> <span class="o">=&gt;</span> <span class="p">(</span>
        <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span>
        <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="s">&#39;/data/nginx/logs/access.log&#39;</span> <span class="p">},</span>
    <span class="p">);</span>
    <span class="n">option</span> <span class="n">rabbitmq</span> <span class="o">=&gt;</span> <span class="p">(</span>
        <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span>
        <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="s">&#39;10.3.18.199&#39;</span> <span class="p">},</span>
    <span class="p">);</span>
    <span class="k">sub </span><span class="nf">build_chain</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
        <span class="n">message_chain</span> <span class="p">{</span>
            <span class="n">output</span> <span class="n">rabbitmq</span> <span class="o">=&gt;</span> <span class="p">(</span>
                <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;AMQP&#39;</span><span class="p">,</span>
                <span class="n">exchange_name</span> <span class="o">=&gt;</span> <span class="s">&#39;logcollect&#39;</span><span class="p">,</span>
    <span class="c1"># 目前测试结果，发现Input::AMQP无法接收到非topic的exchange</span>
    <span class="c1"># CPAN上有关RabbitMQ的模块都是这个哥们写的，POD简略到没有一样，表示无语下</span>
    <span class="c1">#            exchange_type =&gt; &#39;direct&#39;,</span>
                <span class="n">hostname</span> <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">rabbitmq</span><span class="p">,</span>
                <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;guest&#39;</span><span class="p">,</span>
                <span class="n">password</span> <span class="o">=&gt;</span> <span class="s">&#39;guest&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">output</span> <span class="n">debug</span> <span class="o">=&gt;</span> <span class="p">(</span>
                <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;STDOUT&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">encoder</span><span class="p">(</span><span class="s">&quot;encoder&quot;</span><span class="p">,</span>
                <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;JSON&#39;</span><span class="p">,</span>
                <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;rabbitmq&#39;</span><span class="p">,</span>
                <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">filter</span> <span class="n">grok</span> <span class="o">=&gt;</span> <span class="p">(</span>
                <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;GrokLike&#39;</span><span class="p">,</span>
                <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;encoder&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">filter</span> <span class="n">logstash</span> <span class="o">=&gt;</span> <span class="p">(</span>
                <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;ToLogstash&#39;</span><span class="p">,</span>
                <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;grok&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">decoder</span><span class="p">(</span><span class="s">&quot;decoder&quot;</span><span class="p">,</span>
                <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;JSON&#39;</span><span class="p">,</span>
                <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;logstash&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">input</span> <span class="n">nginxlog</span> <span class="o">=&gt;</span> <span class="p">(</span>
                <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;FileTail&#39;</span><span class="p">,</span>
                <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;decoder&#39;</span><span class="p">,</span>
                <span class="n">filename</span> <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span>
           <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">start</span> <span class="k">unless</span> <span class="nb">caller</span><span class="p">;</span>
    <span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>目前就做到这步，之后从rabbitmq里往elasticsearch写的还没搞。从上面的chain可以很清除的看到和logstash一样的管道思想，input-&gt;decoder-&gt;filter-&gt;encoder-&gt;output。巧的是两种写法中，decode/encode那个写法跟puppet的DSL定义特别的像。哈哈～</p>
<p>继续贴汇总入库的agent代码：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl</span>
<span class="k">use</span> <span class="n">Moo</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">MooX::</span><span class="n">Options</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Message::Passing::</span><span class="n">DSL</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">MooX::Types::MooseLike::</span><span class="n">Base</span> <span class="sx">qw/ Str /</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">namespace::</span><span class="n">clean</span> <span class="o">-</span><span class="n">except</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw( meta _options_data _options_config )</span><span class="p">];</span>
<span class="n">with</span> <span class="s">&#39;Message::Passing::Role::Script&#39;</span><span class="p">;</span>
<span class="n">option</span> <span class="n">elasticsearch_servers</span> <span class="o">=&gt;</span> <span class="p">(</span>
    <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span>
    <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span><span class="p">,</span>
    <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="s">&#39;10.3.18.199:9200&#39;</span> <span class="p">},</span>
<span class="p">);</span>
<span class="n">option</span> <span class="n">rabbitmq</span> <span class="o">=&gt;</span> <span class="p">(</span>
    <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span>
    <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span><span class="p">,</span>
    <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="s">&#39;10.3.18.199&#39;</span> <span class="p">},</span>
<span class="p">);</span>
<span class="k">sub </span><span class="nf">build_chain</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="n">message_chain</span> <span class="p">{</span>
        <span class="n">output</span> <span class="n">elasticsearch</span> <span class="o">=&gt;</span> <span class="p">(</span>
            <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;ElasticSearch&#39;</span><span class="p">,</span>
            <span class="n">elasticsearch_servers</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="n">elasticsearch_servers</span><span class="p">],</span>
        <span class="p">);</span>
        <span class="n">decoder</span> <span class="n">decoder</span> <span class="o">=&gt;</span> <span class="p">(</span>
            <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;JSON&#39;</span><span class="p">,</span>
            <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;elasticsearch&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">input</span> <span class="n">rabbitmq</span> <span class="o">=&gt;</span> <span class="p">(</span>
            <span class="n">class</span> <span class="o">=&gt;</span> <span class="s">&#39;AMQP&#39;</span><span class="p">,</span>
            <span class="n">exchange_name</span> <span class="o">=&gt;</span> <span class="s">&#39;logcollect&#39;</span><span class="p">,</span>
            <span class="n">queue_name</span> <span class="o">=&gt;</span> <span class="s">&#39;logcollect&#39;</span><span class="p">,</span>
            <span class="n">hostname</span> <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">rabbitmq</span><span class="p">,</span>
            <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;guest&#39;</span><span class="p">,</span>
            <span class="n">password</span> <span class="o">=&gt;</span> <span class="s">&#39;guest&#39;</span><span class="p">,</span>
            <span class="n">output_to</span> <span class="o">=&gt;</span> <span class="s">&#39;decoder&#39;</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="p">};</span>
<span class="p">}</span>
<span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">start</span> <span class="k">unless</span> <span class="nb">caller</span><span class="p">;</span>
<span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>总的来说，原有模块相互之间都有些不太协调，用的时候还是要自己改改。比如这里，原版的Output::ElasticSearch是吧之前传递过来的整个message放进@fields里的，这跟Filter::ToLogstash的message结构是完全冲突的。所以需要修改Output::ElasticSearch里的bulk_index()的data=&gt;$data,就可以了，不要多改动。</p>
<p>整个代码变动，参加个人github:<a href="https://github.com/chenryn/Message-Passing.git">https://github.com/chenryn/Message-Passing.git</a></p>
      <a href="/2012/09/16/message-passing-agent" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/09/16/elasticsearch-bulk-index-speed-testing" title="【Message::Passing系列】ElasticSearch的bulk_index速度测试" rel="bookmark">【Message::Passing系列】ElasticSearch的bulk_index速度测试</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-16 00:00:00 +0800">16 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>连续尝试了logstash的elasticsearch/elasticsearch_http/elasticsearch_river三个putput模块，发现其index/bulk/river三种插入方式的实际运行效果速度居然没有差异。而使用perl脚本测试，单例下index不到300msg/sec，bulk接近2500msg/sec，几乎翻了10倍。</p>
<p>测试脚本如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="c1">#!/usr/bin/perl -w</span>
    <span class="k">use</span> <span class="n">ElasticSearch</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">JSON</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Time::</span><span class="n">HiRes</span> <span class="sx">qw/time/</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Data::</span><span class="n">Dumper</span><span class="p">;</span>
    <span class="c1">#curl -XGET &#39;http://localhost:9200/logstash-2012.09.14/nginx/_mapping&#39;</span>
    <span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="s">&#39;{</span>
<span class="s">        &quot;@timestamp&quot; : &quot;2012-09-04T13:38:59.496888Z&quot;,</span>
<span class="s">        &quot;@tags&quot; : [], </span>
<span class="s">        &quot;@fields&quot; : { </span>
<span class="s">           &quot;reqtime&quot; : [ </span>
<span class="s">              0.016</span>
<span class="s">           ],  </span>
<span class="s">           &quot;req&quot; : [ </span>
<span class="s">              &quot;/fmn056/20120812/1645/tiny_r3N9_236f000036ad118d.jpg&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;version&quot; : [ </span>
<span class="s">              &quot;1.1&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;useragent&quot; : [ </span>
<span class="s">              &quot;\&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\&quot;&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;port&quot; : [ </span>
<span class="s">              &quot;80&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;size&quot; : [ </span>
<span class="s">              2360</span>
<span class="s">           ],  </span>
<span class="s">           &quot;client&quot; : [ </span>
<span class="s">              &quot;210.56.223.176&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;upstream&quot; : [ </span>
<span class="s">              &quot;10.9.18.50&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;method&quot; : [ </span>
<span class="s">              &quot;GET&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;referer&quot; : [ </span>
<span class="s">              &quot;photo.renren.com&quot;,</span>
<span class="s">              &quot;/photo/420723228/photo-6408408309?psource=3&amp;fromVIP=false&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;ZONE&quot; : [ </span>
<span class="s">              &quot;+0800&quot;</span>
<span class="s">           ],  </span>
<span class="s">           &quot;code&quot; : [ </span>
<span class="s">              200 </span>
<span class="s">           ],  </span>
<span class="s">           &quot;upstime&quot; : [ </span>
<span class="s">              0.016</span>
<span class="s">           ]   </span>
<span class="s">        },  </span>
<span class="s">        &quot;@source_path&quot; : &quot;//data/nginx/logs/access.log&quot;,</span>
<span class="s">        &quot;@source&quot; : &quot;file://DBLYD5-32.opi.com//data/nginx/logs/access.log&quot;,</span>
<span class="s">        &quot;@message&quot; : &quot;[04/Sep/2012:21:38:59 +0800] 200 210.56.223.176 fmn.rrimg.com GET /fmn056/20120812/1645/tiny_r3N9_236f000036ad118d.jpg HTTP/1.1 10.9.18.50:80 0.016 0.016 2360 \&quot;http://photo.renren.com/photo/420723228/photo-6408408309?psource=3&amp;fromVIP=false\&quot; \&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\&quot; \&quot;-\&quot;&quot;,</span>
<span class="s">        &quot;@source_host&quot; : &quot;DBLYD5-32.opi.com&quot;,</span>
<span class="s">        &quot;@type&quot; : &quot;nginx&quot;</span>
<span class="s">    }&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$hash</span> <span class="o">=</span> <span class="n">from_json</span><span class="p">(</span><span class="nv">$line</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$elsearch</span> <span class="o">=</span> <span class="n">ElasticSearch</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="n">servers</span>      <span class="o">=&gt;</span> <span class="s">&#39;10.4.16.68:9200&#39;</span><span class="p">,</span>
        <span class="n">transport</span>    <span class="o">=&gt;</span> <span class="s">&#39;httplite&#39;</span><span class="p">,</span>
        <span class="n">max_requests</span> <span class="o">=&gt;</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$begin</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">..</span> <span class="mi">1000</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">@data</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@data</span><span class="p">,</span> <span class="p">{</span> <span class="nb">index</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">data</span> <span class="o">=&gt;</span> <span class="nv">$hash</span> <span class="p">}</span> <span class="p">}</span> <span class="k">for</span> <span class="mi">1</span> <span class="o">..</span> <span class="mi">20</span><span class="p">;</span>
        <span class="nv">$elsearch</span><span class="o">-&gt;</span><span class="n">bulk</span><span class="p">(</span>
            <span class="nb">index</span> <span class="o">=&gt;</span> <span class="s">&#39;logstash-test&#39;</span><span class="p">,</span>
            <span class="n">type</span>  <span class="o">=&gt;</span> <span class="s">&#39;nginx&#39;</span><span class="p">,</span>
            <span class="n">actions</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@data</span>
        <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">print</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">/</span> <span class="p">(</span><span class="nb">time</span> <span class="o">-</span> <span class="nv">$begin</span><span class="p">);</span>
</code></pre></div>
<p>注意到这里bulk的数组是20个元素。实验证明超过20个会报出HTTP::Lite的错误(附带提示:ElasticSearch::Transport::*的HTTPLite啊AEHTTP啊的模块都是要另外安装的)。而且在使用Logstash::Outputs::ElasticSearchHTTP时，flush_size的default值100也是无法使用的，也是改到20后才行。</p>
<p>ps: 不知道为什么一起发github显示不了，只好拆开了，第一篇，关于ES的index速度测试。</p>
      <a href="/2012/09/16/elasticsearch-bulk-index-speed-testing" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/09/06/intro-rex" title="(R)?ex介绍" rel="bookmark">(R)?ex介绍</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-09-06 00:00:00 +0800">06 Sep 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>按说这文章好像轮不到我写。几个线上运用着的哥们都不出手，我勉强记录一些<a href="http://rexify.org/">官网</a>上没写example但实际应该蛮常用的功能吧：</p>
<ul>
  <li>IP列表</li>
</ul>
<p>Rex的示例中，都突出了自己可以方便的对group做集合运算的特点。嗯，这个在早先使用SSH::Batch的时候就很钦佩。但是面对可能某个应用每个节点就一两台设备又有很多应用的情况，在Rexfile里写就很麻烦了。而且难免有其他操作的时候需要用单独的列表。</p>
<p>其实Rex有Rex::Group::Lookup::File模块专门解决这个问题：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Rex::Group::Lookup::</span><span class="n">File</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$group_path</span> <span class="o">=</span> <span class="s">&quot;/etc/puppet/iplist&quot;</span><span class="p">;</span>
<span class="nb">grep</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$group_file</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$group_name</span> <span class="o">=</span> <span class="nv">$1</span> <span class="k">if</span> <span class="nv">$group_file</span> <span class="o">=~</span> <span class="n">m</span><span class="c1">#$group_path/(.+)\.list#;</span>
    <span class="n">group</span> <span class="s">&quot;$group_name&quot;</span> <span class="o">=&gt;</span> <span class="n">lookup_file</span><span class="p">(</span><span class="s">&quot;$group_file&quot;</span><span class="p">);</span>
<span class="p">}</span> <span class="nb">glob</span><span class="p">(</span><span class="s">&quot;$group_path/*&quot;</span><span class="p">);</span>
</code></pre></div>
<p>比如上面的例子，原先是在puppet上做集群管理的，已经有了现成的一个目录iplist专门存放各个应用的设备ip列表文件。那么在Rexfile开头加上这么两三行代码，就自动把整个应用设备归类到group里了。然后运行rex -Tv就看到Server Groups栏下一串串列表了。</p>
<ul>
  <li>错误输出</li>
</ul>
<p>Rex的command示例中，都是如下形式：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">say</span> <span class="n">run</span> <span class="s">&#39;uptime&#39;</span><span class="p">;</span>
</code></pre></div>
<p>但是大家会发现一个很常见的事情，就是命令行上敲错某个字母了，rex是没有错误提示输出的——当然rex本来的主要目的是做任务管理，理论上你得先保证task写正确。
当然，其实rex也可以返回错误提示的。Rex::Interface::Exec::SSH中对返回结果是有判断的。</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Rex::Helper::</span><span class="n">SSH2</span><span class="p">;</span>
<span class="o">...</span><span class="p">;</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$err</span><span class="p">)</span> <span class="o">=</span> <span class="n">net_ssh2_exec</span><span class="p">(</span><span class="nv">$ssh</span><span class="p">,</span> <span class="s">&quot;LC_ALL=C $path &quot;</span> <span class="o">.</span> <span class="nv">$cmd</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="nb">wantarray</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$err</span><span class="p">);</span> <span class="p">}</span>
<span class="k">return</span> <span class="nv">$out</span><span class="p">;</span>
</code></pre></div>
<p>对应到run命令的Rex::Commands::Run::run()里则是：</p>
<div class="highlight"><pre><code class="perl"><span class="k">sub </span><span class="nf">run</span> <span class="p">{</span>
   <span class="k">my</span> <span class="p">(</span><span class="nv">$cmd</span><span class="p">,</span> <span class="nv">$code</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
   <span class="k">my</span> <span class="nv">$path</span> <span class="o">=</span> <span class="nb">join</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="nn">Rex::</span><span class="n">Config</span><span class="o">-&gt;</span><span class="n">get_path</span><span class="p">());</span>
   <span class="k">my</span> <span class="nv">$exec</span> <span class="o">=</span> <span class="nn">Rex::Interface::</span><span class="n">Exec</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">;</span>
   <span class="k">my</span> <span class="p">(</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$err</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$exec</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">,</span> <span class="nv">$path</span><span class="p">);</span>
   <span class="nb">chomp</span> <span class="nv">$out</span> <span class="k">if</span> <span class="nv">$out</span><span class="p">;</span>
   <span class="nb">chomp</span> <span class="nv">$err</span> <span class="k">if</span> <span class="nv">$err</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span><span class="nv">$code</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">&amp;</span><span class="nv">$code</span><span class="p">(</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$err</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">if</span><span class="p">(</span><span class="nb">wantarray</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">,</span> <span class="nv">$out</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nv">$out</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>ok，看到了吧。run命令除了接收cmd外，还可以接收code的。而且也只有code方式可以处理错误输出。这里和exec不同，exec在列表上下文中返回标准输出和错误输出，但run在列表上下文中是把标准输出以行分割成列表元素。</p>
<p>所以要在run下看错误输出的话，应该这么写：</p>
<div class="highlight"><pre><code class="perl"><span class="n">task</span> <span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="n">group</span> <span class="o">=&gt;</span> <span class="s">&#39;nginx&#39;</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">run</span> <span class="s">&quot;pa aux|grep ngin[x]&quot;</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$err</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">print</span> <span class="nv">$err</span> <span class="p">?</span> <span class="nv">$err</span> <span class="p">:</span> <span class="nv">$out</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<ul>
  <li>Kerberos支持</li>
</ul>
<p>这是个人问题，估计碰到的不会多，姑且记录在此。查阅POD，包括在perl mongers和maillist上询问过了。Net::SSH2用的是libssh2库，这个库确实没办法支持gssapi-keyex/gssapi-micpassword的auth。半年前我在github上问Rex作者，表示有计划提供除Net::SSH2之外的支持，不过时间未定。结果看到他的做法是上个月推出了一个和puppet极类似的http方式的Rex::Endpoint::HTTP，我晕。</p>
<p>浏览了一遍，其实替换Net::SSH2模块并不费劲。于是我花几个小时给rex加上了krb5认证参数，在rex -k或者Rexfile里set -krb5的时候，改用Net::OpenSSH模块来完成。主要一个是connect，因为Net::SSH2是connect和auth分开的；一个是exec，因为Net::SSH2里另建channel的，Net::OpenSSH里直接capture即可；一个是disconnect，同理Net::OpenSSH是没这步直接退出的。至于SFTP，两者都实现了标准的sftp接口，代码甚至一行都不用改就能用(Makefile.PL里还是要加Net::SFTP::Foreign的)。代码见<a href="http://github.com/chenryn/rex">我的fork</a>。</p>
<ul>
  <li>集群高性能管理</li>
</ul>
<p>rex中有批量操作的参数，看代码应该是用ForkManager。但中心单机就是单机，所以rex也是在上个月推出了Rex::Gearman模块，通过gearmand把worker作成分布式的工作模式，这样简单有效的完成高性能扩展。gearmand也是我最爱的万能组件了～～</p>
<ul>
  <li>命令行集群管理</li>
</ul>
<p>rex的命令行有个怪逻辑，在-e的时候只认-H，-G只读rexfile里的task。但估计很多人都希望得到的是一次定义iplist，然后之后执行任意命令，即-G &lsquo;groupname&rsquo; -e &ldquo;say run &lsquo;commands&rsquo;&ldquo;的方式。稍微挪动一下代码段的位置，把elsif(-f $::rexfile){&hellip;}改成if(){}并移动到if($opts{&lsquo;e&rsquo;}){&hellip;}前面去就好了。本更改已提交个人fork。</p>
      <a href="/2012/09/06/intro-rex" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/08/26/translate-using-elasticsearch-for-logs" title="【翻译】用ElasticSearch存储日志" rel="bookmark">【翻译】用ElasticSearch存储日志</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-08-26 00:00:00 +0800">26 Aug 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <h1 id="section">介绍</h1>
<p>如果你使用elasticsearch来存储你的日志，本文给你提供一些做法和建议。</p>
<p>如果你想从多台主机向elasticsearch汇集日志，你有以下多种选择：</p>
<ul>
  <li><a href="http://graylog2.org/">Graylog2</a> 安装在一台中心机上，然后它负责往elasticsearch插入日志，而且你可以使用它那个漂亮的搜索界面~</li>
  <li><a href="http://logstash.net/">Logstash</a> 他有很多特性，包括你能输入什么日志，如何变换过滤，最好输出到哪里。其中就有输出到elasticsearch，包括直接输出和通过<a href="http://www.elasticsearch.org/guide/reference/river/rabbitmq.html">RabbitMQ的river</a>方式两种。</li>
  <li><a href="https://cwiki.apache.org/FLUME/">Apache Flume</a> 这个也可以从海量数据源中获取日志，用&rdquo;decorators&rdquo;修改日志，也有各种各样的&rdquo;sinks&rdquo;来存储你的输出。和我们相关的是<a href="https://github.com/Aconex/elasticflume">elasticflume sink</a>。</li>
  <li>omelasticsearch Rsyslog的输出模块。你可以在你的应用服务器上通过rsyslog直接输出到elasticsearch，也可以用rsyslog传输到中心服务器上来插入日志。或者，两者结合都行。具体如何设置参见<a href="http://wiki.rsyslog.com/index.php/HOWTO:_rsyslog_%2B_elasticsearch">rsyslog Wiki</a>。</li>
  <li>定制方案。比如，专门写一个脚本从天南海北的某个服务器传输你的日志到elasticsearch。</li>
</ul>
<p>根据你设定的不同，最佳配置也变化不定。不过总有那么几个有用的指南可以推荐一下：</p>
<h2 id="section-1">内存和打开的文件数</h2>
<p>如果你的elasticsearch运行在专用服务器上，经验值是分配一半内存给elasticsearch。另一半用于系统缓存，这东西也很重要的。</p>
<p>你可以通过修改ES_HEAP_SIZE环境变量来改变这个设定。在启动elasticsearch之前把这个变量改到你的预期值。另一个选择上球该elasticsearch的ES_JAVA_OPTS变量，这个变量时在启动脚本(elasticsearch.in.sh或elasticsearch.bat)里传递的。你必须找到-Xms和-Xmx参数，他们是分配给进程的最小和最大内存。建议设置成相同大小。嗯，ES_HEAP_SIZE其实就是干的这个作用。</p>
<p>你必须确认文件描述符限制对你的elasticsearch足够大，建议值是32000到64000之间。关于这个限制的设置，另有<a href="http://www.elasticsearch.org/tutorials/2011/04/06/too-many-open-files.html">教程</a>可以参见。</p>
<h2 id="section-2">目录数</h2>
<p>一个可选的做法是把所有日志存在一个索引里，然后用<a href="http://www.elasticsearch.org/guide/reference/mapping/ttl-field.html">ttl field</a>来确保就日志被删除掉了。不过当你日志量够大的时候，这可能就是一个问题了，因为用TTL会增加开销，优化这个巨大且唯一的索引需要太长的时间，而且这些操作都是资源密集型的。</p>
<p>建议的办法是基于时间做目录。比如，目录名可以是YYYY-MM-DD的时间格式。时间间隔完全取决于你打算保留多久日志。如果你要保留一周，那一天一个目录就很不错。如果你要保留一年，那一个月一个目录可能更好点。目录不要太多，因为全文搜索的时候开销相应的也会变大。</p>
<p>如果你选择了根据时间存储你的目录，你也可以缩小你的搜索范围到相关的目录上。比如，如果你的大多数搜索都是关于最近的日志的，那么你可以在自己的界面上提供一个&rdquo;快速搜索&rdquo;的选项只检索最近的目录。</p>
<h2 id="section-3">轮转和优化</h2>
<p>移除旧日志在有基于时间的目录后变得异常简单：</p>
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>curl -XDELETE <span class="s1">&#39;http://localhost:9200/old-index-name/&#39;</span>
</code></pre></div>
<p>这个操作的速度非常快，和删除大小差不多的少量文件速度接近。你可以放进crontab里半夜来做。</p>
<p><a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-optimize.html">Optimizing indices</a>是在非高峰时间可以做的一件很不错的事情。因为它可以提高你的搜索速度。尤其是在你是基于时间做目录的情况下，更建议去做了。因为除了当前的目录外，其他都不会再改，你只需要对这些旧目录优化一次就一劳永逸了。</p>
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>curl -XPOST <span class="s1">&#39;http://localhost:9200/old-index-name/_optimize&#39;</span>
</code></pre></div>
<h2 id="section-4">分片和复制</h2>
<p>通过elasticsearch.yml或者使用REST API，你可以给每个目录配置自己的设定。具体细节参见<a href="http://www.elasticsearch.org/guide/reference/setup/configuration.html">链接</a>。</p>
<p>有趣的是分片和复制的数量。默认情况下，每个目录都被分割成5个分片。如果集群中有一个以上节点存在，每个分片会有一个复制。也就是说每个目录有一共10个分片。当往集群里添加新节点的时候，分片会自动均衡。所以如果你有一个默认目录和11台服务器在集群里的时候，其中一台会不存储任何数据。</p>
<p>每个分片都是一个Lucene索引，所以分片越小，elasticsearch能放进分片新数据越少。如果你把目录分割成更多的分片，插入速度更快。请注意如果你用的是基于时间的目录，你只在当前目录里插入日志，其他旧目录是不会被改变的。</p>
<p>太多的分片带来一定的困难——在空间使用率和搜索时间方面。所以你要找到一个平衡点，你的插入量、搜索频率和使用的硬件条件。</p>
<p>另一方面，复制帮助你的集群在部分节点宕机的时候依然可以运行。复制越多，必须在线运行的节点数就可以越小。复制在搜索的时候也有用——更多的复制带来更快的搜索，同时却增加创建索引的时间。因为对猪分片的修改，需要传递到更多的复制。</p>
<h2 id="sourceall">映射_source和_all</h2>
<p><a href="http://www.elasticsearch.org/guide/reference/mapping/">Mappings</a>定义了你的文档如何被索引和存储。你可以，比如说，定义每个字段的类型——比如你的syslog里，消息肯定是字符串，严重性可以是整数。怎么定义映射参见<a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-put-mapping.html">链接</a>。</p>
<p>映射有着合理的默认值，字段的类型会在新目录的第一条文档插入的时候被自动的检测出来。不过你或许会想自己来调控这点。比如，可能新目录的第一条记录的message字段里只有一个数字，于是被检测为长整型。当接下来99%的日志里肯定都是字符串型的，这样Elasticsearch就没法索引他们，只会记录一个错误日志说字段类型不对。这时候就需要显式的手动映射&rdquo;message&rdquo; : {&ldquo;type&rdquo; : &ldquo;string&rdquo;}。如何注册一个特殊的映射详见<a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-put-mapping.html">链接</a>。</p>
<p>当你使用基于时间的目录名时，在配置文件里创建索引模板可能更适合一点。详见<a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-templates.html">链接</a>。除去你的映射，你海可以定义其他目录属性，比如分片数等等。</p>
<p>在映射中，你可以选择压缩文档的_source。这实际上就是整行日志——所以开启压缩可以减小索引大小，而且依赖你的设定，提高性能。经验值是当你被内存大小和磁盘速度限制的时候，压缩源文件可以明显提高速度，相反的，如果受限的是CPU计算能力就不行了。更多关于source字段的细节详见<a href="http://www.elasticsearch.org/guide/reference/mapping/source-field.html">链接</a>。</p>
<p>默认情况下，除了给你所有的字段分别创建索引，elasticsearch还会把他们一起放进一个叫_all的新字段里做索引。好处是你可以在_all里搜索那些你不在乎在哪个字段找到的东西。另一面是在创建索引和增大索引大小的时候会使用额外更多的CPU。所以如果你不用这个特性的话，关掉它。即使你用，最好也考虑一下定义清楚限定哪些字段包含进_all里。详见<a href="http://www.elasticsearch.org/guide/reference/mapping/all-field.html">链接</a>。</p>
<h2 id="section-5">刷新间隔</h2>
<p>在文档被索引后，Elasticsearch某种意义上是近乎实时的。在你搜索查找文档之前，索引必须被刷新。默认情况下，目录是每秒钟自动异步刷新的。</p>
<p>刷新是一个非常昂贵的操作，所以如果你稍微增大一些这个值，你会看到非常明显提高的插入速率。具体增大多少取决于你的用户可以接受到什么程度。</p>
<p>你可以在你的<a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-templates.html">index template</a>里保存期望的刷新间隔值。或者保存在elasticsearch.yml配置文件里，或者通过(REST API)[http://www.elasticsearch.org/guide/reference/api/admin-indices-update-settings.html]升级索引设定。</p>
<p>另一个处理办法是禁用掉自动刷新，办法是设为-1。然后用<a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-refresh.html">REST API</a>手动的刷新。当你要一口气插入海量日志的时候非常有效。不过通常情况下，你一般会采用的就是两个办法：在每次bulk插入后刷新或者在每次搜索前刷新。这都会推迟他们自己本身的操作响应。</p>
<h2 id="thrift">Thrift</h2>
<p>通常时，REST接口是通过HTTP协议的，不过你可以用更快的Thrift替代它。你需要安装<a href="https://github.com/elasticsearch/elasticsearch-transport-thrift">transport-thrift plugin</a>同时保证客户端支持这点。比如，如果你用的是<a href="https://github.com/aparo/pyes">pyes Python client</a>，只需要把连接端口从默认支持HTTP的9200改到默认支持Thrift的9500就好了。</p>
<h2 id="section-6">异步复制</h2>
<p>通常，一个索引操作会在所有分片(包括复制的)都完成对文档的索引后才返回。你可以通过<a href="http://www.elasticsearch.org/guide/reference/api/index_.html">index API</a>设置复制为异步的来让复制操作在后台运行。你可以直接使用这个API，也可以使用现成的客户端(比如pyes或者rsyslog的omelasticsearch)，都会支持这个。</p>
<h2 id="section-7">用过滤器替代请求</h2>
<p>通常，当你搜索日志的时候，你感兴趣的是通过时间序列做排序而不是评分。这种使用场景下评分是很无关紧要的功能。所以用过滤器来查找日志比用请求更适宜。因为过滤器里不会执行评分而且可以被自动缓存。两者的更多细节参见<a href="http://www.elasticsearch.org/guide/reference/query-dsl/">链接</a>。</p>
<h2 id="section-8">批量索引</h2>
<p>建议使用<a href="http://www.elasticsearch.org/guide/reference/api/bulk.html">bulk API</a>来创建索引它比你一次给一条日志创建一次索引快多了。</p>
<p>主要要考虑两个事情：</p>
<ul>
  <li>最佳的批量大小。它取决于很多你的设定。如果要说起始值的话，可以参考一下pyes里的默认值，即400。</li>
  <li>给批量操作设定时器。如果你添加日志到缓冲，然后等待它的大小触发限制以启动批量插入，千万确定还要有一个超时限制作为大小限制的补充。否则，如果你的日志量不大的话，你可能看到从日志发布到出现在elasticsearch里有一个巨大的延时。</li>
</ul>
      <a href="/2012/08/26/translate-using-elasticsearch-for-logs" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/08/23/systemtap-probe-nginx-http-header-parse-line" title="用systemtap定位nginx1.2在header解析时的报错" rel="bookmark">用systemtap定位nginx1.2在header解析时的报错</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-08-23 00:00:00 +0800">23 Aug 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一个url请求，在经过代理层访问应用层后，会报502错误。检查发现应用层是Nginx0.7.64+Resin3的结构，代理层是Nginx1.2。直接访问Nginx0.7.64是没问题的，访问Nginx1.2就会返回&rdquo;upstream sent invalid header while reading response header from upstream&rdquo;。</p>
<p>首先简单的通过编译&ndash;with-debug的nginx然后配置error_log debug;可以看到，nginx是在处理完Expires头后失败的。但是无法具体显示下一个头是在哪个地方。</p>
<p>所以进nginx/src/http/modules/ngx_http_proxy_module.c里，找到ngx_http_proxy_process_header函数，其中是根据ngx_http_parse_header_line函数的结果做判断的。所以出去看nginx/src/http/ngx_http_parse.c里ngx_http_parse_header_line函数，结果发现，从nginx1.0.14开始，新增加了关于空的判断：</p>
<div class="highlight"><pre><code class="c"><span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="n">NGX_HTTP_PARSE_INVALID_HEADER</span><span class="p">;</span>
                <span class="p">}</span>
</code></pre></div>
<p>变更记录：<a href="http://trac.nginx.org/nginx/browser/nginx/tags/release-1.0.14/src/http">http://trac.nginx.org/nginx/browser/nginx/tags/release-1.0.14/src/http</a></p>
<p>说明如下：</p>
<pre><code>*) Headers with null character are now rejected.
    Headers with NUL character aren't allowed by HTTP standard and may cause
    various security problems. They are now unconditionally rejected.
</code></pre>
<p>但是这个NULL出现在哪里呢？这里就要用systemtap来查了～</p>
<p>安装不说了，直接yum或者apt-get都有。</p>
<p>介绍的话，有余锋大神的一系列slide。然后有官网的文档。另外发现了这个翻译beginner的<a href="http://blog.csdn.net/kafeiflynn/article/details/6429976">中文文档</a>。</p>
<p>最后在本例里的简单使用了：</p>
<p>首先要自己启动/usr/local/nginx/sbin/nginx程序；</p>
<p>然后运行systemtap命令：</p>
<div class="highlight"><pre><code class="bash">stap -e <span class="s1">&#39;probe process(&quot;/usr/local/nginx/sbin/nginx&quot;).statement(&quot;ngx_http_parse_header_line@src/http/ngx_http_parse.c:855&quot;){printf(&quot;%s\n&quot;,$$locals$$);}&#39;</span>
</code></pre></div>
<p>最后发起出错的请求。查看stap的输出。类似下面这样：</p>
<pre><code>c='u' ch='U' p="ser-Agent: curl/7.15.5 (x86_64-redhat-linux-gnu) libcurl/7.15.5 OpenSSL/0.9.8b zlib/1.2.3 libidn/0.6.5^M
Host: www.connect.renren.com^M
Pragma: no-cache^M
Accept: */*^M
Proxy-Connection: Keep-Alive^M
^M
e" hash=117 i=117 state=1 lowcase=""
</code></pre>
<p>说明：</p>
<ul>
  <li>probe设探针    </li>
  <li>process运行命令    </li>
  <li>function指定函数    </li>
  <li>statement指定代码位置    </li>
  <li>$$vars变量    </li>
  <li>$$locals内部变量    </li>
  <li>$$parms参数变量    </li>
</ul>
<p>上面三个变量后面加$显示具体内容或者成员</p>
<p>可以先printf(&ldquo;%s\n&rdquo;,$$locals)看到显示的是p的内存地址，每次++。然后$$locals$看具体内容。</p>
<p>最终观察到，在header中某行处理到第N个字节的时候，不再输出，即在该字节处碰到了NULL。</p>
      <a href="/2012/08/23/systemtap-probe-nginx-http-header-parse-line" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/08/20/coro-async-pool-demo" title="Coro::Semaphore和async_pool示例" rel="bookmark">Coro::Semaphore和async_pool示例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-08-20 00:00:00 +0800">20 Aug 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#testing-ref" title="testing" rel="category tag">testing</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前有一个<a href="http://chenlinux.com/2012/07/19/anyevent-fork-http-load-runner-demo/">AnyEvent和Fork写的http压测工具</a>，评论里有大神教导说用Coro控制并发更有效更方便。于是改写了下面的版本。从被压测的nginx server上，可以看到ESTABLISHED的数量确实大大增加，“”并发”两个字算是做到了。</p>
<p>先上普通的Coro::Semaphore控制并发的代码：</p>
<div class="highlight"><pre><code class="perl"><span class="c1"># 之前的fork和count部分完全一致，不重复帖了。</span>
<span class="k">sub </span><span class="nf">coro_get</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$count</span><span class="p">,</span> <span class="nv">$urls</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@coros</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$semaphore</span><span class="o">=</span> <span class="nn">Coro::</span><span class="n">Semaphore</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$ua</span>  <span class="o">=</span> <span class="nn">FurlX::</span><span class="n">Coro</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="mi">1</span> <span class="o">..</span> <span class="nv">$count</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$urls</span><span class="o">-&gt;</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="nv">$#</span><span class="p">{</span><span class="nv">$urls</span><span class="p">}</span><span class="o">+</span><span class="mi">1</span><span class="p">))];</span>
        <span class="nb">push</span> <span class="nv">@coros</span><span class="p">,</span> <span class="n">async</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$guard</span> <span class="o">=</span> <span class="nv">$semaphore</span><span class="o">-&gt;</span><span class="n">guard</span><span class="p">;</span>
            <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$ua</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
            <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;code&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$res</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="nv">$_</span><span class="o">-&gt;</span><span class="nb">join</span> <span class="k">for</span> <span class="nv">@coros</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>然后贴的是用async_pool的代码，从perldoc来看据说是比async还快一倍。</p>
<div class="highlight"><pre><code class="perl"><span class="k">sub </span><span class="nf">coro_pool_get</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$count</span><span class="p">,</span> <span class="nv">$urls</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$limit</span> <span class="o">=</span> <span class="nn">Coro::</span><span class="n">Semaphore</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">POOL_SIZE</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$sem</span> <span class="o">=</span> <span class="nn">Coro::</span><span class="n">Semaphore</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$ua</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">FurlX::</span><span class="n">Coro</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span> <span class="mi">1</span> <span class="o">..</span> <span class="nv">$count</span> <span class="p">){</span>
        <span class="k">my</span> <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$urls</span><span class="o">-&gt;</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="nv">$#</span><span class="p">{</span><span class="nv">$urls</span><span class="p">}</span><span class="o">+</span><span class="mi">1</span><span class="p">))];</span>
        <span class="nv">$limit</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">;</span>
        <span class="n">async_pool</span> <span class="p">{</span> <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$ua</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;$url&quot;</span><span class="p">);</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;code&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$res</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">}</span><span class="o">++</span><span class="p">;</span> <span class="nv">$sem</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">;</span> <span class="nv">$limit</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">;</span> <span class="p">};</span> 
    <span class="p">};</span>
    <span class="nv">$sem</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>在两个函数中，只要修改$semaphore或者$limit的构造参数，就可以获得并发ESTABLISHED的效果。同样是4核nginx，基本在设置init var为100的情况下，最后整个脚本带来的是3000+的ESTABLISHED，然后可能出现少量的非200响应。</p>
      <a href="/2012/08/20/coro-async-pool-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/07/30/plack-middleware-demo" title="一个Plack::Middleware的实例" rel="bookmark">一个Plack::Middleware的实例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-30 00:00:00 +0800">30 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>做一个文件上传的网页，想稍微华丽一点，显示进度条出来。在Apache和Catalyst下都有现成的模块，不过Dancer上还没有。看了一下代码，Dancer::Request里没有像Catalyst那样暴露prepare_body_chunk方法。所以需要在plack上利用psgi.input来做。尽量重用现有代码，所以progress.css和progress.js都直接从Catalyst/Plugin/UploadProgress/example/Upload/root/static/里复制。</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">Plack::Middleware::</span><span class="n">UploadProgress</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">CHI</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Carp</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">HTTP::</span><span class="n">Body</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Plack::</span><span class="n">Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Plack::</span><span class="n">TempBuffer</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(Plack::Middleware)</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">call</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$self</span><span class="p">,</span> <span class="nv">$env</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$rm</span> <span class="o">=</span> <span class="nv">$env</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">REQUEST_METHOD</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$ct</span> <span class="o">=</span> <span class="nv">$env</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">CONTENT_TYPE</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$cl</span> <span class="o">=</span> <span class="nv">$env</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">CONTENT_LENGTH</span><span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$rm</span> <span class="o">=~</span> <span class="n">m</span><span class="c1">#^post$#i and (</span>
         <span class="nv">$ct</span> <span class="o">=~</span> <span class="n">m</span><span class="c1">#^application/x-www-form-urlencoded#i or</span>
         <span class="nv">$ct</span> <span class="o">=~</span> <span class="n">m</span><span class="c1">#^multipart/form-data#i )</span>
     <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$cache</span> <span class="o">=</span> <span class="n">CHI</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">driver</span> <span class="o">=&gt;</span> <span class="s">&#39;Memory&#39;</span><span class="p">,</span> <span class="n">global</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">);</span>
        <span class="k">my</span> <span class="nv">$req</span> <span class="o">=</span> <span class="nn">Plack::</span><span class="n">Request</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$env</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$req</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;progress_id&#39;</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$body</span> <span class="o">=</span> <span class="nn">HTTP::</span><span class="n">Body</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$ct</span><span class="p">,</span> <span class="nv">$cl</span><span class="p">);</span>
        <span class="nv">$env</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;plack.request.http.body&#39;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$body</span><span class="p">;</span>
        <span class="nv">$body</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$input</span> <span class="o">=</span> <span class="nv">$env</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;psgi.input&#39;</span><span class="p">};</span>
        <span class="k">my</span> <span class="nv">$buffer</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$env</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;psgix.input.buffered&#39;</span><span class="p">})</span> <span class="p">{</span>
            <span class="nv">$input</span><span class="o">-&gt;</span><span class="nb">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$buffer</span> <span class="o">=</span> <span class="nn">Plack::</span><span class="n">TempBuffer</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$cl</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">my</span> <span class="nv">$spin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">$cl</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$input</span><span class="o">-&gt;</span><span class="nb">read</span><span class="p">(</span><span class="k">my</span> <span class="nv">$chunk</span><span class="p">,</span> <span class="nv">$cl</span> <span class="o">&lt;</span> <span class="mi">8192</span> <span class="p">?</span> <span class="nv">$cl</span> <span class="p">:</span> <span class="mi">8192</span><span class="p">);</span>
            <span class="k">my</span> <span class="nv">$read</span> <span class="o">=</span> <span class="nb">length</span> <span class="nv">$chunk</span><span class="p">;</span>
            <span class="nv">$cl</span> <span class="o">-=</span> <span class="nv">$read</span><span class="p">;</span>
            <span class="nv">$body</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="nv">$chunk</span><span class="p">);</span>
            <span class="nv">$buffer</span><span class="o">-&gt;</span><span class="k">print</span><span class="p">(</span><span class="nv">$chunk</span><span class="p">)</span> <span class="k">if</span> <span class="nv">$buffer</span><span class="p">;</span>
            <span class="k">my</span> <span class="nv">$progress</span> <span class="o">=</span> <span class="nv">$cache</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;upload_progress_&#39;</span> <span class="o">.</span> <span class="nv">$id</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">defined</span> <span class="nv">$progress</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nv">$progress</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">size</span>     <span class="o">=&gt;</span> <span class="nv">$body</span><span class="o">-&gt;</span><span class="n">content_length</span><span class="p">,</span>
                    <span class="n">received</span> <span class="o">=&gt;</span> <span class="nb">length</span> <span class="nv">$chunk</span><span class="p">,</span>
                <span class="p">};</span>
                <span class="nv">$cache</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span> <span class="s">&#39;upload_progress_&#39;</span> <span class="o">.</span> <span class="nv">$id</span><span class="p">,</span> <span class="nv">$progress</span> <span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$progress</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">received</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$read</span><span class="p">;</span>
                <span class="nv">$cache</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span> <span class="s">&#39;upload_progress_&#39;</span> <span class="o">.</span> <span class="nv">$id</span><span class="p">,</span> <span class="nv">$progress</span> <span class="p">);</span>
            <span class="p">};</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$read</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$spin</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">)</span> <span class="p">{</span>
                <span class="nn">Carp::</span><span class="n">croak</span> <span class="s">&quot;Bad Content-Length: maybe client disconnect? ($cl bytes remaining)&quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$buffer</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">env</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;psgix.input.buffered&#39;</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">env</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;psgi.input&#39;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$buffer</span><span class="o">-&gt;</span><span class="n">rewind</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$input</span><span class="o">-&gt;</span><span class="nb">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">app</span><span class="o">-&gt;</span><span class="p">(</span><span class="nv">$env</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$res</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>上面的代码，progress部分基本摘抄自Catalyst::Plugin::UploadProgress模块，chunk部分基本摘抄自Plack::Middleware::CSRFBlock模块，当然它也基本摘抄自Plack::Request模块~~
上面写的不全，没有关于GET /progress?progress_id=*的json输出处理。不过这部分也可以在DancerApp.pm里直接写get &lsquo;/progress&rsquo; =&gt; sub {};，最后申明，这代码刚写完，没测……CHI或许应该用memcached而不是memory~</p>
<p>在DancerApp/bin/app.pl里这么配置：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">Dancer</span><span class="p">;</span>
<span class="k">use</span> <span class="n">DancerApp</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Plack::</span><span class="n">Builder</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$app</span> <span class="o">=</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$env</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$req</span> <span class="o">=</span> <span class="nn">Dancer::</span><span class="n">Request</span><span class="o">-</span><span class="k">new</span><span class="p">(</span> <span class="n">env</span> <span class="o">=&gt;</span> <span class="nv">$env</span> <span class="p">);</span>
<span class="p">};</span>
<span class="n">builder</span> <span class="p">{</span>
    <span class="n">enable</span> <span class="s">&quot;Plack::Middleware::UploadProgress&quot;</span><span class="p">;</span>
    <span class="nv">$app</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">dance</span><span class="p">;</span>
</code></pre></div>
      <a href="/2012/07/30/plack-middleware-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/07/30/dancer-plugin-demo" title="一个Dancer::Plugin的实例" rel="bookmark">一个Dancer::Plugin的实例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-30 00:00:00 +0800">30 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>公司内部工具统一使用passport认证登录，于是写这么一个小plugin，用来给dancer做的网站使用统一认证。
passport的原理很简单，将原先的页面url带入session转到passport的login，然后由passport通过user/password或者kerberos确认是否正确，并返回一个ticket参数，然后拿这个ticket再到passport的verify上校验一次username，正确的话写入session即可。代码如下：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">Dancer::Plugin::Auth::</span><span class="n">Passport</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Dancer::</span><span class="n">Plugin</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Furl</span><span class="p">;</span> 
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">our</span> <span class="nv">$VERSION</span> <span class="o">=</span> <span class="s">&#39;0.01&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$settings</span> <span class="o">=</span> <span class="n">plugin_setting</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$PASSPORT_HOST</span> <span class="o">=</span> <span class="nv">$settings</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">passport_host</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;passport.company.com&#39;</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">_auth_passport</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">session</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$req_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">scheme</span> <span class="o">.</span><span class="s">&#39;://&#39;</span><span class="o">.</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">(</span><span class="s">&#39;Host&#39;</span><span class="p">)</span> <span class="o">.</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">uri</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">defined</span><span class="p">(</span><span class="k">my</span> <span class="nv">$ticket</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;ticket&#39;</span><span class="p">})</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$passport_url</span> <span class="o">=</span> <span class="s">&quot;https://${PASSPORT_HOST}/verify.php?t=${ticket}&quot;</span><span class="p">;</span>
            <span class="k">my</span> <span class="nv">$furl</span> <span class="o">=</span> <span class="n">Furl</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">timeout</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s">&#39;Referer&#39;</span> <span class="o">=&gt;</span> <span class="s">&quot;$req_url&quot;</span><span class="p">]</span> <span class="p">);</span>
            <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$furl</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="nv">$passport_url</span><span class="p">);</span>
            <span class="n">redirect</span> <span class="s">&quot;https://${PASSPORT_HOST}/login.php?forward=${req_url}&quot;</span> <span class="k">unless</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="n">is_success</span><span class="p">;</span>
            <span class="n">session</span> <span class="n">username</span> <span class="o">=&gt;</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">;</span>
            <span class="n">redirect</span> <span class="n">session</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;original_url&#39;</span><span class="p">};</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">session</span> <span class="n">original_url</span> <span class="o">=&gt;</span> <span class="nv">$</span><span class="p">{</span><span class="n">req_url</span><span class="p">};</span>
            <span class="n">redirect</span> <span class="s">&quot;https://${PASSPORT_HOST}/login.php?forward=${req_url}&quot;</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="n">register</span> <span class="s">&#39;auth_passport&#39;</span> <span class="o">=&gt;</span> <span class="o">\&amp;</span><span class="n">_auth_passport</span><span class="p">;</span>
<span class="n">register_plugin</span><span class="p">;</span>
<span class="n">true</span><span class="p">;</span>
<span class="cp">__END__</span>
</code></pre></div>
<p>使用方法如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="n">DancerApp</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Dancer::Plugin::Auth::</span><span class="n">Passport</span><span class="p">;</span>
    <span class="n">hook</span> <span class="s">&#39;before&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="n">auth_passport</span> <span class="p">};</span>
    <span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="k">return</span> <span class="s">&#39;Hello Passport&#39;</span> <span class="p">};</span>
    <span class="n">true</span><span class="p">;</span>
</code></pre></div>
<p>完毕。</p>
      <a href="/2012/07/30/dancer-plugin-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/07/19/anyevent-fork-http-load-runner-demo" title="用AnyEvent和ForkManager写一个http协议的压测工具" rel="bookmark">用AnyEvent和ForkManager写一个http协议的压测工具</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-19 00:00:00 +0800">19 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#testing-ref" title="testing" rel="category tag">testing</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>话不多说，先上第一版的代码：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Time::</span><span class="n">HiRes</span> <span class="sx">qw/time/</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">HTTP</span><span class="p">;</span>
<span class="k">use</span> <span class="n">AnyEvent</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Coro</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%code</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$count</span> <span class="o">=</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="k">my</span> <span class="nv">$url</span> <span class="o">=</span> <span class="s">&quot;https://10.10.10.10/&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$begin</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@coro</span> <span class="o">=</span> <span class="nb">map</span> <span class="p">{</span>
    <span class="n">async</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$cv</span> <span class="o">=</span> <span class="nn">AnyEvent::</span><span class="n">condvar</span><span class="p">;</span>
        <span class="nv">$cv</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$header_time</span><span class="p">;</span>
        <span class="n">http_request</span> <span class="n">GET</span> <span class="o">=&gt;</span> <span class="s">&quot;$url&quot;</span><span class="p">,</span>
            <span class="k">sub </span><span class="p">{</span>
                <span class="k">my</span> <span class="p">(</span><span class="nb">undef</span><span class="p">,</span> <span class="nv">$hdr</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
                <span class="nv">$code</span><span class="p">{</span><span class="nv">$hdr</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;Status&#39;</span><span class="p">}}</span><span class="o">++</span><span class="p">;</span>
                <span class="nv">$cv</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">;</span>
        <span class="nv">$cv</span><span class="o">-&gt;</span><span class="nb">recv</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="p">(</span><span class="mi">1</span> <span class="o">..</span> <span class="nv">$count</span><span class="p">);</span>
<span class="nv">$_</span><span class="o">-&gt;</span><span class="nb">join</span> <span class="k">for</span> <span class="nv">@coro</span><span class="p">;</span>
<span class="k">print</span> <span class="nv">$cpus</span><span class="o">*</span><span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="nb">time</span><span class="o">-</span><span class="nv">$begin</span><span class="p">);</span>
</code></pre></div>
<p>上面这段脚本，作用是在每个进程中运行事件驱动的协程，以达到尽可能大的并发请求。</p>
<p>初步的测试，在单核Coro的情况下可以每秒发送1000+的https请求。</p>
<p>注意：如果使用的是AnyEvent::HTTP::LWP::UserAgent模块，虽然POD里写它用的其实就是AnyEvent::HTTP的代码套LWP的API格式，但实际只能用到30%的CPU，单核情况下的qps也就不到350的样子。</p>
<p>注意：本例测试的是HTTPS，AnyEvent::HTTP在TLS模式(即https请求)下，无法开启persistent连接。如果是普通http请求，开启persistent参数的qps应该会更高！</p>
<p>然后上第二版的代码，改用了EV循环，性能比Coro协程提高了大概5%的样子。使用了fork多进程，并且绑定到不同的CPU核上。</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">autodie</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Parallel::</span><span class="n">ForkManager</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Time::</span><span class="n">HiRes</span> <span class="sx">qw/time/</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Sys::</span><span class="n">CpuAffinity</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">HTTP</span><span class="p">;</span>
<span class="k">use</span> <span class="n">AE</span><span class="p">;</span>
<span class="k">use</span> <span class="n">EV</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$cpus</span> <span class="o">=</span> <span class="nn">Sys::CpuAffinity::</span><span class="n">getNumCpus</span><span class="p">();</span>
<span class="k">my</span> <span class="nv">$pm</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Parallel::</span><span class="n">ForkManager</span><span class="p">(</span><span class="nv">$cpus</span><span class="p">,</span> <span class="s">&quot;/tmp/&quot;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">@urls</span> <span class="o">=</span> <span class="sx">qw(https://10.11.19.35/ https://10.11.21.121/)</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$res</span><span class="p">;</span>
<span class="nv">$pm</span><span class="o">-&gt;</span><span class="n">run_on_finish</span><span class="p">(</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;code&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$_</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;code&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$_</span><span class="p">}</span> <span class="k">for</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;code&#39;</span><span class="p">}};</span>
    <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;size&#39;</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;size&#39;</span><span class="p">};</span>
    <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">};</span>
<span class="p">});</span>
<span class="k">my</span> <span class="nv">$begin</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$cpu</span> <span class="p">(</span><span class="mi">1</span> <span class="o">..</span> <span class="nv">$cpus</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="nv">$pm</span><span class="o">-&gt;</span><span class="n">start</span> <span class="ow">and</span> <span class="k">next</span><span class="p">;</span>
    <span class="nn">Sys::CpuAffinity::</span><span class="n">setAffinity</span><span class="p">(</span><span class="vg">$$</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="nv">$cpu</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
    <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="n">ae_get</span><span class="p">(</span><span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">\</span><span class="nv">@urls</span><span class="p">);</span>
    <span class="nv">$pm</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
<span class="p">}</span>
<span class="nv">$pm</span><span class="o">-&gt;</span><span class="n">wait_all_children</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$use</span> <span class="o">=</span> <span class="nb">time</span> <span class="o">-</span> <span class="nv">$begin</span><span class="p">;</span>
<span class="nb">printf</span> <span class="s">&quot;%d fetches, %d max processes, in %.03f seconds\n&quot;</span><span class="p">,</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nv">$cpus</span><span class="p">,</span> <span class="nv">$cpus</span><span class="p">,</span> <span class="nv">$use</span><span class="p">;</span>
<span class="nb">printf</span> <span class="s">&quot;%.03f fetches/sec, %.03f bytes/sec\n&quot;</span><span class="p">,</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nv">$cpus</span> <span class="sr">/ $use, $res-&gt;{&#39;size&#39;} /</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">};</span>
<span class="nb">printf</span> <span class="s">&quot;HTTP response codes:\n&quot;</span><span class="p">;</span>
<span class="nb">printf</span> <span class="s">&quot;       %d - %d\n&quot;</span><span class="p">,</span> <span class="nv">$_</span><span class="p">,</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;code&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$_</span><span class="p">}</span> <span class="k">for</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;code&#39;</span><span class="p">}};</span>
<span class="k">sub </span><span class="nf">ae_get</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$count</span><span class="p">,</span> <span class="nv">$urls</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$tmptime</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$cv</span> <span class="o">=</span> <span class="nn">AE::</span><span class="n">cv</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="mi">1</span> <span class="o">..</span> <span class="nv">$count</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$hdr_time</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$urls</span><span class="o">-&gt;</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="nv">$#</span><span class="p">{</span><span class="nv">$urls</span><span class="p">}</span><span class="o">+</span><span class="mi">1</span><span class="p">))];</span>
        <span class="nv">$cv</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">;</span>
        <span class="n">http_request</span>
            <span class="n">GET</span>       <span class="o">=&gt;</span> <span class="s">&quot;$url&quot;</span><span class="p">,</span> 
            <span class="n">on_header</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
                <span class="nv">$hdr_time</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="k">sub </span><span class="p">{</span>
                <span class="k">my</span> <span class="p">(</span><span class="nb">undef</span><span class="p">,</span> <span class="nv">$hdr</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
                <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;code&#39;</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$hdr</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;Status&#39;</span><span class="p">}}</span><span class="o">++</span><span class="p">;</span>
                <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;size&#39;</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$hdr</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;content-length&#39;</span><span class="p">};</span>
                <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">}</span> <span class="o">+=</span> <span class="p">(</span> <span class="nb">time</span> <span class="o">-</span> <span class="nv">$hdr_time</span> <span class="p">);</span>
                <span class="nv">$cv</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">;</span>
    <span class="p">}</span> 
    <span class="nv">$cv</span><span class="o">-&gt;</span><span class="nb">recv</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>增加了简单的统计功能，包括每秒请求数、平均下载速度，状态码汇总等。因为不好计算header的长度，所以只计算body部分的下载速度。
增加了url列表功能，每次请求会随机的抽取其中的一个url。</p>
      <a href="/2012/07/19/anyevent-fork-http-load-runner-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/07/07/intro-ipc-locker" title="IPC::Locker模块介绍" rel="bookmark">IPC::Locker模块介绍</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-07 00:00:00 +0800">07 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>当你需要给一个集群的某项服务做简单的排他性管理的时候，强力推荐Veripool公司的一系列模块：IPC::Locker、Schedule::Load。</p>
<p>今天先说IPC::Locker模块。部署很简单，直接在集群所有节点上运行cpanm IPC::Locker即可。该模块依赖几个都是perl的核心模块比如IO::Socket::INET、IO::Poll和POSIX。所以理论上你也可以把代码打个包分发。</p>
<p>随包分发的还有几个现成的脚本程序lockerd、lockersh、pidstat、pidstatd和pidwatch。</p>
<p>后面三个关注的remote设备上的pid是否存在等，但是相信一般情况下，我们不会自己来通过pid管理集群，所以在使用上只要理解lockerd和lockersh其实也是用pidstatd来解决pid问题的就够了。</p>
<p>其实代码很简单，看看就明白，无非就是lockerd用的IPC::Locker::Server是启动了一个IO::Socket::INET做tcp server，主要维护几个东西，一个是@{$self-&gt;{lock}}列表，一个是@{$self-&gt;{host}}列表，一个是$self-&gt;{locked}的Bool值。</p>
<p>而lockersh用的IPC::Locker则是连接上lockerd的端口，检查$self-&gt;{locked}状态，如果没locked就发送LOCK请求，然后fork一个进行exec你定义的shell命令，执行完成后，unlock发送UNLOCK请求给lockerd。</p>
<p>做个简单实验：</p>
<ol>
  <li>在serverA上运行lockerd &amp;     </li>
  <li>在serverB上运行lockersh &ndash;dhost serverA &ndash;lock test_task &lsquo;while true;do echo &ldquo;OK&rdquo;;done&rsquo;</li>
  <li>在serverC上运行lockersh &ndash;dhost serverA &ndash;lock test_task &lsquo;while true;do echo &ldquo;OK&rdquo;;done&rsquo;</li>
  <li>在serverD上运行lockersh &ndash;dhost serverA &ndash;lock other_task &lsquo;while true;do echo &ldquo;OK&rdquo;;done&rsquo;</li>
</ol>
<p>观察一下，结果是在serverB和serverD上同时在执行echo &ldquo;OK&rdquo;。而serverC被lock住了。继续：</p>
<ol>
  <li>在serverB的session上按下Ctrl+C终止程序，然后再次运行上述命令</li>
  <li>在serverC的session上按下Ctrl+C终止程序</li>
</ol>
<p>观察一下，结果是停止B时C的即开始，停止C的后B的继续。这些都不影响serverD的运行。</p>
<ol>
  <li>终止serverD的程序，改为运行lockersh &ndash;dhost serverA &ndash;lock test_task &lsquo;while true;do echo &ldquo;OK&rdquo;;done&rsquo;</li>
</ol>
<p>观察一下，发现B、C、D是按照lockersh的执行次序解锁的。因为hostlist是一个列表，在server上是用for循环的。</p>
<p>注意：必须要先运行lockerd并且保证不中途退出。经过测试，如果lockerd中途退出再重新运行的话，因为locklist是保存在内存里会丢失的。结果就会出现之前的lockersh还在执行(他已经获得了lock，在unlock之前不会再和server通信的)，之后再启动的新lockersh会在新lockerd上又获得一次lock的情况……</p>
<p>后一个Schedule::Load则可以根据集群设备的loadavg，top等，决定在哪台设备上运行job。还没测试。之后再记录。</p>
<p>补充：贴一个脚本，仿照lockersh改写的squid集群重启及报警控制：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="n">FindBin</span><span class="p">;</span>
<span class="k">use</span> <span class="n">lib</span> <span class="s">&quot;$FindBin::Bin/../lib&quot;</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">autodie</span><span class="p">;</span>
<span class="k">use</span> <span class="n">vars</span> <span class="sx">qw ($Debug);</span>
<span class="sx">use </span><span class="n">Furl</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">IO::</span><span class="n">File</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Long</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">IPC::</span><span class="n">Locker</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">IPC::</span><span class="n">PidStat</span><span class="p">;</span>
<span class="c1">#======================================================================</span>
<span class="k">my</span> <span class="nv">$pscount</span> <span class="o">=</span> <span class="sb">`ps aux|grep -v grep|grep $0|wc -l`</span><span class="p">;</span>
<span class="k">print</span> <span class="s">&quot;Already run, waiting for lock now&quot;</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">unless</span> <span class="nv">$pscount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
<span class="c1">#======================================================================</span>
<span class="k">my</span> <span class="nv">%server_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">lock</span><span class="o">=&gt;[]</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$cluserv</span><span class="p">;</span>
<span class="nv">$Debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nn">Getopt::Long::</span><span class="n">config</span> <span class="p">(</span><span class="s">&quot;require_order&quot;</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">GetOptions</span> <span class="p">(</span>
                  <span class="s">&quot;dhost=s&quot;</span>     <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span><span class="nb">shift</span><span class="p">;</span> <span class="nv">$server_params</span><span class="p">{</span><span class="n">host</span><span class="p">}</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;},</span>
                  <span class="s">&quot;cluster=s&quot;</span>   <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span><span class="nb">shift</span><span class="p">;</span> <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$server_params</span><span class="p">{</span><span class="n">lock</span><span class="p">}},</span> <span class="nb">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span><span class="nb">shift</span><span class="p">);},</span>
                  <span class="s">&quot;port=i&quot;</span>      <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span><span class="nb">shift</span><span class="p">;</span> <span class="nv">$server_params</span><span class="p">{</span><span class="n">port</span><span class="p">}</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;},</span>
                  <span class="s">&quot;timeout=i&quot;</span>   <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span><span class="nb">shift</span><span class="p">;</span> <span class="nv">$server_params</span><span class="p">{</span><span class="n">timeout</span><span class="p">}</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;},</span>
                  <span class="s">&quot;verbose!&quot;</span>    <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span><span class="nb">shift</span><span class="p">;</span> <span class="nv">$server_params</span><span class="p">{</span><span class="n">verbose</span><span class="p">}</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;},</span>
                  <span class="s">&quot;debug&quot;</span>       <span class="o">=&gt;</span> <span class="o">\&amp;</span><span class="n">debug</span><span class="p">,</span>
                  <span class="s">&quot;service=s&quot;</span>   <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$cluserv</span><span class="p">,</span>
                  <span class="p">))</span> <span class="p">{</span>
    <span class="nb">die</span> <span class="s">&quot;%Error: Bad usage, see lockersh --help\n&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$#</span><span class="p">{</span><span class="nv">$server_params</span><span class="p">{</span><span class="n">lock</span><span class="p">}}</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;%Error: --cluster not specified; see lockersh --help\n&quot;</span><span class="p">;</span>
<span class="c1"># Fork once to start parent process</span>
<span class="k">my</span> <span class="nv">$foreground_pid</span> <span class="o">=</span> <span class="vg">$$</span><span class="p">;</span>  <span class="c1"># Unlike most forks, the job goes in the parent</span>
<span class="c1"># Do this while we still have STDERR.</span>
<span class="k">my</span> <span class="nv">$lock</span>  <span class="o">=</span> <span class="k">new</span> <span class="nn">IPC::</span><span class="n">Locker</span> <span class="p">(</span><span class="n">verbose</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">timeout</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">autounlock</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">destroy_unlock</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span>
                             <span class="nv">%server_params</span><span class="p">,</span>
                             <span class="p">);</span>
<span class="nv">$lock</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;%Error: Did not connect to lockerd,&quot;</span><span class="p">;</span>
<span class="nv">$lock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="nb">fork</span><span class="p">())</span> <span class="p">{</span>  <span class="c1"># Parent process, foreground job</span>
    <span class="k">print</span> <span class="s">&quot;\tForeground: $cluserv\n&quot;</span> <span class="k">if</span> <span class="nv">$Debug</span><span class="p">;</span>
    <span class="c1"># The child forks again quickly.  Sometimes, SIG_CHLD leaks to us and</span>
    <span class="c1"># wrecks the exec&#39;d command, so wait for it now.</span>
    <span class="k">my</span> <span class="nv">$rv</span> <span class="o">=</span> <span class="nb">waitpid</span><span class="p">(</span><span class="nv">$pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$rv</span> <span class="o">!=</span> <span class="nv">$pid</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">die</span> <span class="s">&quot;%Error: waitpid() returned $rv: $!&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="vg">$?</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">die</span> <span class="s">&quot;%Error: Child process died with status $?,&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">print</span> <span class="s">&quot;Exec in $$\n&quot;</span> <span class="k">if</span> <span class="nv">$Debug</span><span class="p">;</span>
    <span class="o">&amp;</span><span class="n">service</span><span class="p">(</span><span class="nv">$cluserv</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">#else, rest is for child process.</span>
<span class="c1"># Disassociate from controlling terminal</span>
<span class="nn">POSIX::</span><span class="n">setsid</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;%Error: Can&#39;t start a new session: $!&quot;</span><span class="p">;</span>
<span class="c1"># Change working directory</span>
<span class="nb">chdir</span> <span class="s">&quot;/&quot;</span><span class="p">;</span>
<span class="nb">open</span><span class="p">(</span><span class="bp">STDIN</span><span class="p">,</span>  <span class="s">&quot;+&gt;/dev/null&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;%Error: Can&#39;t re-open STDIN: $!&quot;</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$Debug</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">open</span><span class="p">(</span><span class="bp">STDOUT</span><span class="p">,</span> <span class="s">&quot;+&gt;&amp;STDIN&quot;</span><span class="p">);</span>
    <span class="nb">open</span><span class="p">(</span><span class="bp">STDERR</span><span class="p">,</span> <span class="s">&quot;+&gt;&amp;STDIN&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1"># Prevent possibility of acquiring a controlling terminal</span>
<span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">fork</span><span class="p">();</span>
<span class="c1"># Wait for child to complete.  We can&#39;t waitpid, as we&#39;re not the parent</span>
<span class="k">while</span> <span class="p">(</span><span class="nn">IPC::PidStat::</span><span class="n">local_pid_exists</span><span class="p">(</span><span class="nv">$foreground_pid</span><span class="p">))</span> <span class="p">{</span> <span class="nb">sleep</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
<span class="k">print</span> <span class="s">&quot;Parent $foreground_pid completed\n&quot;</span> <span class="k">if</span> <span class="nv">$Debug</span><span class="p">;</span>
<span class="c1"># Unlock</span>
<span class="nv">$lock</span><span class="o">-&gt;</span><span class="n">unlock</span><span class="p">;</span> <span class="nv">$lock</span><span class="o">=</span><span class="nb">undef</span><span class="p">;</span>
<span class="k">print</span> <span class="s">&quot;Child exiting\n&quot;</span> <span class="k">if</span> <span class="nv">$Debug</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">debug</span> <span class="p">{</span>
    <span class="nv">$Debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nv">$</span><span class="nn">IPC::Locker::</span><span class="nv">Debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">service</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$cluserv</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="nb">die</span> <span class="s">&quot;Only support squid now!&quot;</span> <span class="k">unless</span> <span class="nv">$cluserv</span> <span class="ow">eq</span> <span class="s">&quot;squid&quot;</span><span class="p">;</span>
    <span class="nb">die</span> <span class="s">&quot;Reload failed. Check squid.conf!&quot;</span> <span class="k">if</span> <span class="nb">eval</span> <span class="s">&quot;${cluserv}_reload&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$hit_rate</span> <span class="o">=</span> <span class="nb">eval</span> <span class="s">&quot;${cluserv}_check&quot;</span><span class="p">;</span>
        <span class="n">notify</span> <span class="s">&quot;HIT Ratio: ${hit_rate}% now.\n&quot;</span><span class="p">;</span>
        <span class="nb">exit</span> <span class="k">if</span> <span class="nv">$hit_rate</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">;</span>
        <span class="nb">sleep</span> <span class="mi">300</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">squid_check</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$hit_rate</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;Run squid_check&quot;</span> <span class="k">if</span> <span class="nv">$Debug</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$squid_port</span> <span class="o">=</span> <span class="sb">`awk &#39;/^http_port/{print $2}&#39; /etc/squid/squid.conf`</span><span class="p">;</span>
    <span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span> <span class="s">&quot;squidclient -p ${squid_port} mgr:info |&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;$fh&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">next</span> <span class="k">unless</span> <span class="sr">/^\s+Request Hit Ratios:\s+5min:\s*(-?\d+\.\d)%,/</span><span class="p">;</span>
        <span class="k">print</span> <span class="s">&quot;regex $1&quot;</span> <span class="k">if</span> <span class="nv">$Debug</span><span class="p">;</span>
        <span class="nv">$hit_rate</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
        <span class="k">last</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">close</span> <span class="nv">$fh</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$hit_rate</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">squid_reload</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&quot;Reload squid daemon. Do not reload within 10 mins of squid start&quot;</span> <span class="k">if</span> <span class="nv">$Debug</span><span class="p">;</span>
    <span class="nb">system</span><span class="p">(</span><span class="s">&quot;squid&quot;</span><span class="p">,</span> <span class="s">&quot;-k&quot;</span><span class="p">,</span> <span class="s">&quot;reconfigure&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="vg">$?</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">notify</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$furl</span> <span class="o">=</span> <span class="n">Furl</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="n">agent</span> <span class="o">=&gt;</span> <span class="s">&quot;Clustrol/0.1&quot;</span><span class="p">);</span>
    <span class="nv">$furl</span><span class="o">-&gt;</span><span class="n">post</span><span class="p">(</span><span class="s">&quot;http://monitor.domain.com/eml/&quot;</span><span class="p">,</span>
        <span class="p">[</span> <span class="n">data</span> <span class="o">=&gt;</span> <span class="s">&quot;$_&quot;</span> <span class="p">],</span>
    <span class="p">);</span>
<span class="p">}</span>
<span class="cp">__END__</span>
</code></pre></div>
      <a href="/2012/07/07/intro-ipc-locker" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/07/02/anyevent-httpd-demo" title="AnyEvent::HTTPD和AnyEvent::HTTP使用实例" rel="bookmark">AnyEvent::HTTPD和AnyEvent::HTTP使用实例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-07-02 00:00:00 +0800">02 Jul 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>很简单的一个实例，就是开一个端口接受url请求，然后向squid提交这个url的刷新。</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">HTTPD</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">HTTP</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$httpd</span> <span class="o">=</span> <span class="nn">AnyEvent::</span><span class="n">HTTPD</span><span class="o">-&gt;</span><span class="k">new</span> <span class="p">(</span><span class="n">port</span> <span class="o">=&gt;</span> <span class="mi">9090</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="p">;</span>
<span class="nv">$httpd</span><span class="o">-&gt;</span><span class="n">reg_cb</span> <span class="p">(</span>
    <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$httpd</span><span class="p">,</span> <span class="nv">$req</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$urlpath</span> <span class="o">=</span> <span class="nv">$req</span><span class="o">-&gt;</span><span class="n">url</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">;</span>
        <span class="n">http_request</span> <span class="n">PURGE</span> <span class="o">=&gt;</span> <span class="s">&quot;http://${ip}${urlpath}&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=&gt;</span> <span class="p">{</span> <span class="s">&quot;host&quot;</span><span class="o">=&gt;</span><span class="s">&quot;host.domain.com&quot;</span><span class="p">},</span> <span class="k">sub </span><span class="p">{</span>
            <span class="k">my</span> <span class="p">(</span><span class="nv">$body</span><span class="p">,</span> <span class="nv">$hdr</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
            <span class="nv">$req</span><span class="o">-&gt;</span><span class="n">respond</span><span class="p">([</span><span class="s">&quot;$hdr-&gt;{&#39;Status&#39;}&quot;</span><span class="p">,</span><span class="s">&quot;$hdr-&gt;{&#39;Reason&#39;}&quot;</span><span class="p">,{</span><span class="s">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;text/html&#39;</span><span class="p">}]);</span>
        <span class="p">};</span>
    <span class="p">},</span>
<span class="p">);</span>
<span class="nv">$httpd</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">;</span>
</code></pre></div>
<p>注意安装AnyEvent::HTTPD的时候，test需要Test::POD，但是Makefile.PL上没写，所以要先行安装。</p>
      <a href="/2012/07/02/anyevent-httpd-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/29/coro-intro" title="【翻译】Coro::Intro文档" rel="bookmark">【翻译】Coro::Intro文档</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-29 00:00:00 +0800">29 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>
<ul>
	<li><a href="#coro简介">Coro简介</a></li>
	<li><a href="#什么是coro_">什么是Coro？</a></li>
	<li><a href="#协作线程">协作线程</a></li>
	<ul>
		<li><a href="#信号量和其他锁">信号量和其他锁</a></li>
		<li><a href="#频道">频道</a></li>
		<li><a href="#什么是我的_什么是我们的_">什么是我的，什么是我们的？</a></li>
		<li><a href="#调试">调试</a></li>
	</ul>
	<li><a href="#真实世界里的事件循环">真实世界里的事件循环</a></li>
	<ul>
		<li><a href="#真实世界里的文件操作">真实世界里的文件操作</a></li>
		<li><a href="#翻转控制____唤醒函数">翻转控制 —— 唤醒函数</a></li>
	</ul>
	<li><a href="#其他模块">其他模块</a></li>
	<li><a href="#作者">作者</a></li>
</ul>
<hr name="index" />
</div>
<!-- INDEX END -->
<p>
</p>
<h1><a name="coro简介">Coro简介</a></h1>
<p>这个教程准备给你介绍Coro模块家族的最主要的几个特性。</p>
<p>本文首先介绍一些基础概念，然后简单的概述一下Coro家族的情况。</p>
<p>
</p>
<hr />
<h1><a name="什么是coro_">什么是Coro？</a></h1>
<p>Coro最早是作为一个协程的简单实现的模块开始的。它允许你捕获当前的运行点并且跳到另一个点去，又随时可以再跳回来。作为一种非局部的跳转，和C语言里的<code>setjmp</code>/<code>longjmp</code>没什么不同。这就是<a href="/Coro/State.html">the Coro::State manpage</a>模块。</p>
<p>这有一个很天然的应用场合，就是在协作线程中内置一个调度器和结果集，这也是当前Coro最主要的应用场景。很多文档和论文把这些“协作线程(cooperative threads)”叫做“协程(coroutines)”或者更简单的就写成Coros。</p>
<p>一个线程非常像一个精简的Perl解释器或者说进程：跟完整版的Perl解释器不同的地方就是线程并没有自己的局部变量或者代码的名字空间——这些都是共享的。这就意味着当一个线程修改了某个变量(包括通过引用修改任何值)时，其他线程如果使用同样的变量或者值时会立刻发现这个改变。</p>
<p>协作的意思，就是这些线程在涉及到CPU使用的时候必须相互配合——只有一个线程可以真正拥有CPU，如果有别的线程要用，当前运行的这个就要让出。后来的线程可以显式的调用函数来完成这个工作，也可以隐式的等待资源释放(比如信号量或者IO请求的完成)。这种线程模型在脚本语言(比如python或者ruby)中非常流行，而且我们这个实现比其他语言里的线程要高效的多。</p>
<p>Perl本身在这方面用词非常模糊——线程“thread”或者“ithread”实际上在别的地方又被叫做进程“process”：这个所谓的Perl线程实际上是在用于windows上的UNIX进程仿真代码。这就是为什么我们说他是进程而不是真的线程的原因。最大的区别就是，在进程和ithread线程之间，变量不是共享的。</p>
<p>
</p>
<hr />
<h1><a name="协作线程">协作线程</a></h1>
<p>Coro模块带给大家协作线程。首先你要<code>use</code>它：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Coro</span><span class="p">;</span>
</code></pre></div>
<p>然后要创建线程，你可以使用Coro模块自动导出的<code>async</code>函数：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span><span class="k">print</span> <span class="s">&quot;hello\n&quot;</span><span class="p">;};</span>
</code></pre></div>
<p>async期望的第一个参数是一个代码块(间接的对象符号)。你也可以传递更多的变量，他们会在执行的时候作为<code>@_</code>数组传递到代码块里面。不过因为是闭包的原因，你可能只需要引用当前可见的任何词法变量都行。</p>
<p>上面那行就已经创建了一个线程，但是如果你保存这行代码到文件里运行，你会发现自己看不到任何输出。</p>
<p>原因就是：虽然你已经创建了线程，这个线程也已经准备好了执行(<code>async</code>会加入到一个所谓的<em>ready queue</em>里)，它却没有得到CPU时间来实际运行代码，因为main函数——实际也是一个一样的线程——一直霸占着CPU直到整个程序运行到结束。所以Coror的线程是协作的，main也要协作起来，要让出CPU来。</p>
<p>要显式的让出CPU，使用<code>cede</code>函数(在其他线程实现里经常被叫做<code>yield</code>)：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Coro</span><span class="p">;</span>
    <span class="n">async</span> <span class="p">{</span>
       <span class="k">print</span> <span class="s">&quot;hello\n&quot;</span><span class="p">;</span>
   <span class="p">};</span>
    <span class="n">cede</span><span class="p">;</span>
</code></pre></div>
<p>运行上面的代码会打印出<code>hello</code>单词然后退出。</p>
<p>看起来不是很有趣，那让我们搞点稍微有趣的程序：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Coro</span><span class="p">;</span>
    <span class="n">async</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s">&quot;async 1\n&quot;</span><span class="p">;</span>
        <span class="n">cede</span><span class="p">;</span>
        <span class="k">print</span> <span class="s">&quot;async 2\n&quot;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">print</span> <span class="s">&quot;main 1\n&quot;</span><span class="p">;</span>
    <span class="n">cede</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;main 2\n&quot;</span><span class="p">;</span>
    <span class="n">cede</span><span class="p">;</span>
</code></pre></div>
<p>运行这个程序会打印出如下结果：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">main</span> <span class="mi">1</span>
    <span class="n">async</span> <span class="mi">1</span>
    <span class="n">main</span> <span class="mi">2</span>
    <span class="n">async</span> <span class="mi">2</span>
</code></pre></div>
<p>这个例子很好的说明了它的非局部的跳跃能力：main先打印了第一回，然后释放CPU给其他线程。嗯，确实有其他线程，于是运行并打印“async 1”，然后这个线程也释放掉CPU。这时候只剩下一个线程就是main了，main于是接着运行。</p>
<p>让我们注意这个例子的更多细节部分：<code>async</code>创建一个新线程。所有的新线程开始都处于暂停状态。要运行的话这些线程就需要被放进ready队列，这是<code>async</code>做的第二件事。每次一个线程让出CPU的时候，Coro就会运行一个所谓的调度器<em>scheduler</em>，调度器选择ready队列中的下一个线程，把它从队列里挪出来运行。</p>
<p><code>cede</code>也做两件事情：第一它把一个运行中的线程放进ready队列里；然后它跳转到调度器。这实际上就是让出CPU。不过最终确保了线程被再次运行。</p>
<p>事实上，<code>cede</code>可以这样实现：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">sub </span><span class="nf">my_cede</span> <span class="p">{</span>
        <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">current</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">;</span>
        <span class="n">schedule</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>这里<code>$Coro::current</code>永远都是包含了当前正在运行的线程，而<code>Coro::schedule</code>则是调度器的调用方法。</p>
<p>那如果不把当前线程放进ready队列里就先调用<code>schedule</code>的效果会怎样呢？很简单，调度器就自动找ready队列里下一个队列。而当前队列因为没放进ready队列里，就会一直沉睡直到有别的因素唤醒它。</p>
<p>下面这个例子，把当前线程记录在一个变量里，创建新线程，这样main线程就沉睡过去了。</p>
<p>然后新创建的线程使用rand来决定是否唤醒main线程，用的是之前变量的<code>ready</code>方法。</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Coro</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$wakeme</span> <span class="o">=</span> <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">current</span><span class="p">;</span>
    <span class="n">async</span> <span class="p">{</span>
        <span class="nv">$wakeme</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="k">if</span> <span class="mf">0.5</span> <span class="o">&gt;</span> <span class="nb">rand</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">schedule</span><span class="p">;</span>
</code></pre></div>
<p>现在，你运行这个程序，可能会发生两种情况：<code>async</code>线程唤醒了main，程序正常退出；或者没有唤醒main，得到的是如下提示：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">FATAL:</span> <span class="n">deadlock</span> <span class="n">detected</span><span class="o">.</span>
          <span class="n">PID</span> <span class="n">SC</span>  <span class="n">RSS</span> <span class="n">USES</span> <span class="n">Description</span>              <span class="n">Where</span>
     <span class="mi">31976480</span> <span class="o">-</span><span class="n">C</span>  <span class="mi">19</span><span class="n">k</span>    <span class="mi">0</span> <span class="p">[</span><span class="nn">main::</span><span class="p">]</span>                 <span class="p">[</span><span class="n">program:9</span><span class="p">]</span>
     <span class="mi">32223768</span> <span class="n">UC</span>  <span class="mi">12</span><span class="n">k</span>    <span class="mi">1</span>                          <span class="p">[</span><span class="n">Coro</span><span class="o">.</span><span class="n">pm:691</span><span class="p">]</span>
     <span class="mi">32225088</span> <span class="o">--</span> <span class="mi">2068</span>    <span class="mi">1</span> <span class="p">[</span><span class="n">coro</span> <span class="n">manager</span><span class="p">]</span>           <span class="p">[</span><span class="n">Coro</span><span class="o">.</span><span class="n">pm:691</span><span class="p">]</span>
     <span class="mi">32225184</span> <span class="n">N</span><span class="o">-</span>  <span class="mi">216</span>    <span class="mi">0</span> <span class="p">[</span><span class="n">unblock_sub</span> <span class="n">scheduler</span><span class="p">]</span>  <span class="o">-</span>
</code></pre></div>
<p>为什么会这样？嗯，当<code>async</code>线程执行到代码块的最后的时候，他就终止了(通过调用<code>Coro::terminate</code>)，然后重新调用调度器。而之前<code>async</code>线程并没有唤醒main线程，ready队列里没有任何线程可用，程序无法继续了。所以当这里明明有线程<em>可以</em>运行(main)却没有<em>ready</em>，Coro最终得到了一个<em>死锁</em>信号——通常这时候你会看到一个所有线程的列表来帮你追踪问题。</p>
<p>然而现在有个非常重要的场景，<em>就是</em>事实上可能确实没有线程是ready的，但在一个事件驱动的程序里，程序依然可以前进。在这种程序里，某些线程肯尼个在等待一个外部事件，比如超时，比如通过socket到达的数据流。</p>
<p>这种场景下，死锁就不是很有用了。这下有个模块叫<a href="/Coro/AnyEvent.html">the Coro::AnyEvent manpage</a>用来集成线程到事件循环里。它配置Coro使得在这种情况下coro并不返回一个错误信息然后<code>die</code>掉，而是继续运行一个事件循环以期待收到哪个事件可以唤醒某些线程。</p>
<p>
</p>
<h2><a name="信号量和其他锁">信号量和其他锁</a></h2>
<p>仅仅依靠<code>ready</code>、<code>cede</code>和<code>schedule</code>来同步线程是非常困难的。尤其是如果同时有很多线程是ready状态的时候。Coro支持一些原语来帮助你更简单的同步线程。第一个就是<a href="/Coro/Semaphore.html">the Coro::Semaphore manpage</a>模块，它实现了信号量计数(二进制的信号量则是<a href="/Coro/Signal.html">the Coro::Signal manpage</a>模块，同样的还有<a href="/Coro/SemaphoreSet.html">the Coro::SemaphoreSet manpage</a>和<a href="/Coro/RWLock.html">the Coro::RWLock manpage</a>模块)。</p>
<p>信号量计数，某种意义上就是存储一个资源的计数。你可以通过调用<code>-&gt;down</code>方法来删除、分配、预留一个资源，这个方法会减去一个计数；同样调用<code>-&gt;add</code>方法可以添加或释放一个资源，这又增加一个计数。如果计数器值为<code>0</code>，<code>-&gt;down</code>方法就没法再减——也就是说被锁住了——线程就必须等待到计数器重新可用为止。</p>
<p>下面是例子：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Coro</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$sem</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Coro::</span><span class="n">Semaphore</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">#初始化的信号是锁住的</span>
    <span class="n">async</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s">&quot;unlocking semaphore\n&quot;</span><span class="p">;</span>
        <span class="nv">$sem</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">print</span> <span class="s">&quot;trying to lock semaphore\n&quot;</span><span class="p">;</span>
    <span class="nv">$sem</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;we got it!\n&quot;</span><span class="p">;</span>
</code></pre></div>
<p>这个程序创建一个<em>锁住</em>的信号(计数器为<code>0</code>)并且尝试锁住他(通过<code>down</code>方法减计数)。因为信号量已经耗尽，main线程会被阻塞住直到信号量恢复可用。</p>
<p>这样CPU就被转给了其他可读的线程，这里是用<code>async</code>创建的那个解锁信号量的线程(并且随即就终止了自己)。</p>
<p>既然信号量恢复了，main也就锁住他然后继续执行打印“we got it!”。</p>
<p>信号量计数最常用的地方是锁资源，或者说在使用和访问某个资源时排他。比如，假设有一个很耗内存的函数。你不想让多个线程同时调用这个函数，你可以这样写：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Coro::</span><span class="n">Semaphore</span><span class="p">;</span> <span class="c1">#初始化未锁，默认是1</span>
    <span class="k">sub </span><span class="nf">costly_function</span> <span class="p">{</span>
        <span class="nv">$lock</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">;</span> <span class="c1">#引入锁</span>
        <span class="c1">#进行其他操作</span>
        <span class="nv">$lock</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">;</span> <span class="c1">#解锁</span>
    <span class="p">}</span>
</code></pre></div>
<p>不管有多少线程调用<code>costly_function</code>，只有一个可以运行他的代码块，其他的都在<code>down</code>调用时阻塞。如果你想限定的并发执行是5个，那就创建信号量的时候指定初始值为<code>5</code>.</p>
<p>为什么提到“操作块”？再次强调，Coro的线程是协作的：<code>costly_function</code>不释放CPU，所有的线程都不会运行。如果函数一直不释放，就显得锁有点多余了，不过在和外面的世界打交道的时候，这种情况太罕见了。</p>
<p>现在想想如果代码在<code>down</code>后，<code>up</code>前就<code>die</code>掉了。这导致信号量保持在一个锁的状态，这应该不会是你想要的——所以如果可能失败的地方，都把调用用<code>eval {}</code>包起来。</p>
<p>所以通常你希望在不管是正常还是异常的时候都释放锁的话，这里有个guard方法可能比较有用：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Coro::</span><span class="n">Semaphore</span><span class="p">;</span> <span class="c1">#初始化时未锁定</span>
    <span class="k">sub </span><span class="nf">costly_function</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$guard</span> <span class="o">=</span> <span class="nv">$lock</span><span class="o">-&gt;</span><span class="n">guard</span><span class="p">;</span> <span class="c1"># 获取监视</span>
        <span class="o">...</span> <span class="c1"># 开始做需要阻塞的动作</span>
    <span class="p">}</span>
</code></pre></div>
<p>这个<code>guard</code>方法<code>down</code>掉信号量并返回一个所谓的guard对象。看起来这个对象除了有个引用外啥都不干，不过当所有的引用都完成，比如<code>costly_function</code>返回或抛出异常，它会自动的调用<code>up</code>恢复信号量，绝对不会忘掉滴。哪怕线程收到别的线程发来的<code>cancel</code>命令。</p>
<p>信号量和锁的介绍到此结束。除了<a href="/Coro/Semaphore.html">the Coro::Semaphore manpage</a>和<a href="/Coro/Signal.html">the Coro::Signal manpage</a>，还有读写锁的<a href="/Coro/RWLock.html">the Coro::RWLock manpage</a>和信号集<a href="/Coro/SemaphoreSet.html">the Coro::SemaphoreSet manpage</a>。他们都有自己的文档可查。</p>
<p>
</p>
<h2><a name="频道">频道</a></h2>
<p>信号量很不错，但通常你可能希望通过交换数据来进行通信。当然，你可以继续用锁、数组来通信，不过这里还有更有用的线程间通信抽象模块:<a href="/Coro/Channel.html">the Coro::Channel manpage</a>。频道是UNIX管道的Coro等价实现(也非常接近AmigaOS的消息端口)——你可以从一段放进去东西，然后从另一头读取出来。</p>
<p>下面是一个简单的例子，创建一个线程然后发送数字给它。然后这个线程计算这个数字的平方，通过另一个频道返回给main线程。</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Coro</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$calculate</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Coro::</span><span class="n">Channel</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$result</span>    <span class="o">=</span> <span class="k">new</span> <span class="nn">Coro::</span><span class="n">Channel</span><span class="p">;</span>
    <span class="n">async</span> <span class="p">{</span>
      <span class="c1"># 无限循环</span>
        <span class="k">while</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$num</span> <span class="o">=</span> <span class="nv">$calculate</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">;</span> <span class="c1">#获取数字</span>
            <span class="nv">$num</span> <span class="o">**=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">#计算平方</span>
            <span class="nv">$result</span><span class="o">-&gt;</span><span class="n">put</span> <span class="p">(</span><span class="nv">$num</span><span class="p">);</span> <span class="c1">#推进结果队列</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="k">for</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">77</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$calculate</span><span class="o">-&gt;</span><span class="n">put</span> <span class="p">(</span><span class="nv">$_</span><span class="p">);</span>
        <span class="k">print</span> <span class="s">&quot;$_ ** 2 = &quot;</span><span class="p">,</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">,</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>得到结果是：</p>
<div class="highlight"><pre><code class="perl">    <span class="mi">1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="mi">2</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="mi">5</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">25</span>
    <span class="mi">10</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="mi">77</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">5929</span>
</code></pre></div>
<p>这里面<code>get</code>和<code>put</code>方法都会阻塞当前线程：<code>get</code>首先检查是否<em>有</em>数据可用，没有就阻塞到数据到达为止。<code>put</code>同样，在频道到“最大容量”的时候阻塞。你不可能存储超过这个特定值的项目，这个值可以再创建频道的时候设置。</p>
<p>在上面的例子中，<code>put</code>不会阻塞，因为频道的默认容量是很高的。所以for循环首先put数据到频道里，然后开始试图<code>get</code>结果。这时候因为async线程还没有put东西出来(第一次迭代的时候他还没运行)，result频道是空的，所以main线程在这里阻塞住了。</p>
<p>这时候唯一一个可运行的线程就是算平方的这个，于是它会被唤醒，<code>get</code>数据，然后计算平方，put到result频道，就此唤醒main线程，然后他继续运行，唤醒其他线程进入ready队列，就这样。</p>
<p>只有当async线程是从calculate频道<code>get</code>下一个数字的时候，他才会阻塞住(因为现在这个频道里没数据)然后main线程开始继续运行。依次类推。</p>
<p>这说明了Coro的一个总体原则：一个线程<em>只</em>在万不得已的时候才会阻塞。不管是Coro模块本身还是他的任一子模块，都是如此。因为他们在等待某些事件的发生。</p>
<p>不过小心了：当多个线程往<code>$calculate</code>放数据然后从<code>$result</code>里读出来的时候，他们可分不清楚谁是谁的。解决办法是用信号量，或者不单单发送数字，也发送自己专属的result频道。</p>
<p>
</p>
<h2><a name="什么是我的_什么是我们的_">什么是我的，什么是我们的？</a></h2>
<p>到底什么构成了线程？显然它包含有一个当前的执行点。不那么显然的，它还得有局部变量。是的，每个线程都要自己的一组局部变量。</p>
<p>想知道为什么这点是必须的么，看看下面这个例子吧：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Coro</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">printit</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$string</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="n">cede</span><span class="p">;</span>
        <span class="k">print</span> <span class="nv">$string</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">async</span> <span class="p">{</span> <span class="n">printit</span> <span class="s">&quot;Hello, &quot;</span> <span class="p">};</span>
    <span class="n">async</span> <span class="p">{</span> <span class="n">printit</span> <span class="s">&quot;World!\n&quot;</span> <span class="p">};</span>
    <span class="n">cede</span><span class="p">;</span> <span class="n">cede</span><span class="p">;</span>
</code></pre></div>
<p>上面的代码最终打印的是<code>Hello, World!\n</code>。如果<code>printit</code>没有自己每个线程独立的<code>$string</code>变量，那打印的结果应该是<code>World!\nWorld!\n</code>。这绝对不是你想要的，而且会给线程的使用造成极大的麻烦。</p>
<p>为了让事情变的更顺利些，有不少东西都是线程独立的：</p>
<dl>
<dt><strong><a name="________和正则表达式的捕获变量________1__2等等" class="item">$_，@_，$@和正则表达式的捕获变量，$&amp;，%+，$1，$2等等</a></strong></dt>
<dd>
<p><code>$_</code>用于局部变量，每个线程都是独立的(<code>$1</code>，<code>$2</code>之类的也一样)；</p>
<p><code>@_</code>包括了参数，类似词法变量，也必须是线程独立的；</p>
<p><code>$@</code>不那么必须，但是独立的话会很好用。</p>
</dd>
<dt><strong><a name="__和默认的输出文件句柄" class="item">$/和默认的输出文件句柄</a></strong></dt>
<dd>
<p>线程在做IO的时候经常是阻塞的，而<code>$/</code>就是在读取每行的时候起作用，如果它是个共享变量，事情会很不方便。
默认输出文件句柄(参见<code>select</code>)的情况比较复杂：有时候全局的好，有时候线程独立的好。不过看起来后面这种情况更多一些，所以还是线程独立的了。</p>
</dd>
<dt><strong><a name="_sig___die___和_sig___warn___" class="item">$SIG{__DIE__}和$SIG{__WARN__}</a></strong></dt>
<dd>
<p>如果这两不是线程独立的话，下面这种常见的构造就没法协程切换了。</p>
<div class="highlight"><pre><code class="perl">        <span class="nb">eval</span> <span class="p">{</span>
            <span class="nb">local</span> <span class="nv">$SIG</span><span class="p">{</span><span class="bp">__DIE__</span><span class="p">}</span> <span class="o">=</span> <span class="k">sub </span><span class="p">{</span> <span class="o">...</span> <span class="p">};</span>
            <span class="o">...</span>
        <span class="p">};</span>
</code></pre></div>
<p>既然异常处理是线程独立的，那么这些变量自然也需要如此了。</p>
</dd>
<dt><strong><a name="一些其他的深奥的玩意儿" class="item">一些其他的深奥的玩意儿</a></strong></dt>
<dd>
<p>比如说<code>$^H</code>变量就是线程独立的。很多类似这样额外的线程独立的东西不会直接被Perl访问，你通常不会注意到这些。</p>
</dd>
</dl>
<p>其他的东西都是线程间共享的。比如全局变量<code>$a</code>和<code>$b</code>。当你使用sort的时候，这两个变量变成特殊变量，然后如果你在排序的时候切换线程，或许结果会让你大吃一惊的。</p>
<p>另外一些<code>$!</code>，errno，<code>$.</code>，输入行号，<code>$,</code>，<code>$\</code>，<code>$"</code>和很多很多其他的特殊变量都是共享的。</p>
<p>虽然有些时候把他们局部化也不错，但一是他们用的不广泛，二是局部化的工作蛮困难的。</p>
<p>总之，如果未来发现哪个共享变量给Coro造成问题了，我们就可能把它改成线程独立的。</p>
<p>
</p>
<h2><a name="调试">调试</a></h2>
<p>有时候查出每个线程在做什么或者哪个线程出现在什么地方是蛮有用的。<a href="/Coro/Debug.html">the Coro::Debug manpage</a>模块就有这么一个方法，让你打印出一个和ps命令结果很像的列表——你可以在Coro检测到死锁前就查看。</p>
<p>使用方法如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="nn">Coro::</span><span class="n">Debug</span><span class="p">;</span>
    <span class="nn">Coro::Debug::</span><span class="n">command</span> <span class="s">&quot;ps&quot;</span><span class="p">;</span>
</code></pre></div>
<p>还记得上面求平方的例子吧？在<code>$calculate-&gt;get</code>后面运行ps方法，然后就会输出类似这样的结果：</p>
<pre>
        PID SC  RSS USES Description              Where
    8917312 -C  22k    0 [main::]                 [introscript:20]
    8964448 N-  152    0 [coro manager]           -
    8964520 N-  152    0 [unblock_sub scheduler]  -
    8591752 UC  152    1                          [introscript:12]
   11546944 N-  152    0 [EV idle process]        -
</pre>
<p>有趣的是后台运行的线程比我们想象中的要多。除掉这些额外的线程，main线程的pid是<code>8917312</code>，而<code>async</code>启动的线程的pid是<code>8591752.</code></p>
<p>后者也是唯一一个没有描述的线程，因为我们没有设置这个。设置方法就是<code>$Coro::current-&gt;{desc}</code>；</p>
<div class="highlight"><pre><code class="perl">    <span class="n">async</span> <span class="p">{</span>
        <span class="nv">$</span><span class="nn">Coro::</span><span class="nv">current</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">desc</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;cruncher&quot;</span><span class="p">;</span>
        <span class="o">...</span>
    <span class="p">};</span>
</code></pre></div>
<p>在调试程序或者使用<a href="/Coro/Debug.html">the Coro::Debug manpage</a>的交互式shell的时候这个可能比较有用。</p>
<p>
</p>
<hr />
<h1><a name="真实世界里的事件循环">真实世界里的事件循环</a></h1>
<p>Coro强烈希望运行在一个事件驱动的程序里。事实上真实情况的Coro程序都是结合事件驱动技术或者多线程技术的。利用Coro也很方便就在这两个世界里做到很好的效果。</p>
<p>Coro可以通过<em>AnyEvent</em>模块(查看<a href="/Coro/AnyEvent.html">the Coro::AnyEvent manpage</a>的更多细节)自动集成到任何事件循环里，也可以接受<em>EV</em>和<em>Event</em>模块的特殊方法。</p>
<p>下面是一个简单的finger客户端，可以使用任何<em>AnyEvent</em>的事件循环：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Coro</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Coro::</span><span class="n">Socket</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">finger</span> <span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$host</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$fh</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Coro::</span><span class="n">Socket</span> <span class="n">PeerHost</span> <span class="o">=&gt;</span> <span class="nv">$host</span><span class="p">,</span> <span class="n">PeerPort</span> <span class="o">=&gt;</span> <span class="s">&quot;finger&quot;</span>
            <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;$user\@$host: $!&quot;</span><span class="p">;</span>
        <span class="k">print</span> <span class="nv">$fh</span> <span class="s">&quot;$user\n&quot;</span><span class="p">;</span>
        <span class="k">print</span> <span class="s">&quot;$user\@$host: $_&quot;</span> <span class="k">while</span> <span class="o">&amp;</span><span class="ow">lt</span><span class="p">;</span><span class="nv">$fh</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="k">print</span> <span class="s">&quot;$user\@$host: done\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">#验证几个账号</span>
    <span class="k">for</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">async</span> <span class="p">{</span> <span class="n">finger</span> <span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="s">&quot;cornell.edu&quot;</span> <span class="p">}),</span>
        <span class="p">(</span><span class="n">async</span> <span class="p">{</span> <span class="n">finger</span> <span class="s">&quot;sebbo&quot;</span><span class="p">,</span> <span class="s">&quot;world.std.com&quot;</span> <span class="p">}),</span>
        <span class="p">(</span><span class="n">async</span> <span class="p">{</span> <span class="n">finger</span> <span class="s">&quot;trouble&quot;</span><span class="p">,</span> <span class="s">&quot;noc.dfn.de&quot;</span> <span class="p">}),</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$_</span><span class="o">-&gt;</span><span class="nb">join</span><span class="p">;</span> <span class="c1">#等待结果</span>
    <span class="p">}</span>
</code></pre></div>
<p>这里又有些新东西。首先是<a href="/Coro/Socket.html">the Coro::Socket manpage</a>。这个模块的工作方式和<a href="/IO/Socket/INET.html">the IO::Socket::INET manpage</a>一样，除了它是协程的。也就是说，<a href="/IO/Socket/INET.html">the IO::Socket::INET manpage</a>在等待网络的时候会阻塞整个进程——就是说说所有线程都被阻塞了，这显然是不可取的。</p>
<p>另一方面，<a href="/Coro/Socket.html">the Coro::Socket manpage</a>却知道在等待网络的时候让出CPU给其他线程。这使得并发执行变得可能了。</p>
<p>另一个新东西是<code>join</code>方法：在这个例子里我们想要的就是启动三个<code>async</code>线程然后完成工作后退出。这可以用信号量计数，但是直接同步等待他们<code>terminate</code>更简单一些，这正是<code>join</code>方法做的。</p>
<p>无所谓三个<code>async</code>是不是按照他们<code>join</code>的顺序结束的——当线程还在运行的时候，join单纯就是等待。如果线程终止，他就获取返回值。</p>
<p>如果你之前有事件驱动编程的经验，你会发现上面的程序不太遵循常规的模式，也就是开始一些工作，然后运行事件驱动比如<code>EV::loop</code>。</p>
<p>事实上，重要程序都遵从这个模式，使用Coro也一样，所以和EV一起时Coro程序看起来是这样的：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">EV</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">Coro</span><span class="p">;</span>
    <span class="c1">#开始协程或者事件句柄</span>
    <span class="nn">EV::</span><span class="n">loop</span><span class="p">;</span> <span class="c1">#然后循环</span>
</code></pre></div>
<p>还有，为了调试，经常写成这样：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">EV</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Coro::</span><span class="n">Debug</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$shell</span> <span class="o">=</span> <span class="n">new_unix_server</span> <span class="nn">Coro::</span><span class="n">Debug</span> <span class="s">&quot;/tmp/myshell&quot;</span><span class="p">;</span>
    <span class="nn">EV::</span><span class="n">loop</span><span class="p">;</span> <span class="c1">#循环</span>
</code></pre></div>
<p>这个程序在运行的同时会在UNIX套接字<em class="file">/tmp/myshell</em>上创建一个交互式shell。你可以用<em class="file">socat</em>程序访问它：</p>
<pre>
    # socat readline /tmp/myshell
    coro debug session. use help for more info
    &gt; ps
            PID SC  RSS USES Description              Where
      136672312 RC  19k 177k [main::]                 [myprog:28]
      136710424 -- 1268   48 [coro manager]           [Coro.pm:349]
    &gt; help
    ps [w|v]                show the list of all coroutines (wide, verbose)
    bt &lt;pid&gt;                show a full backtrace of coroutine &lt;pid&gt;
    eval &lt;pid&gt; &lt;perl&gt;       evaluate &lt;perl&gt; expression in context of &lt;pid&gt;
    trace &lt;pid&gt;             enable tracing for this coroutine
    untrace &lt;pid&gt;           disable tracing for this coroutine
    kill &lt;pid&gt; &lt;reason&gt;     throws the given &lt;reason&gt; string in &lt;pid&gt;
    cancel &lt;pid&gt;            cancels this coroutine
    ready &lt;pid&gt;             force &lt;pid&gt; into the ready queue
    &lt;anything else&gt;         evaluate as perl and print results
    &lt;anything else&gt; &amp;       same as above, but evaluate asynchronously
                            you can use (find_coro &lt;pid&gt;) in perl expressions
                            to find the coro with the given pid, e.g.
                            (find_coro 9768720)-&gt;ready
    loglevel &lt;int&gt;          enable logging for messages of level &lt;int&gt; and lower
    exit                    end this session</pre>
<p>好吧，微软用户可以使用<code>new_tcp_server</code>构造器。</p>
<p>
</p>
<h2><a name="真实世界里的文件操作">真实世界里的文件操作</a></h2>
<p>磁盘IO一般比网络IO快很多，但可能占用很长时间，这期间CPU本可以做其他的事情，现在却只能做一样。</p>
<p>幸运的是，CPAN上的<a href="/IO/AIO.html">the IO::AIO manpage</a>模块允许你把这些IO调用移到后台，而在前台做更有用的工作。这是基于事件/回调的，不过Coro很好的包装了它，叫做<a href="/Coro/AIO.html">the Coro::AIO manpage</a>模块，你可以在线程里很自然的使用它的函数：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">Fcntl</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Coro::</span><span class="n">AIO</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$fh</span> <span class="o">=</span> <span class="n">aio_open</span> <span class="s">&quot;$filename~&quot;</span><span class="p">,</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0600</span>
        <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;$filename~: $!&quot;</span><span class="p">;</span>
    <span class="n">aio_write</span> <span class="nv">$fh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">$data</span><span class="p">),</span> <span class="nv">$data</span><span class="p">,</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">aio_fsync</span> <span class="nv">$fh</span><span class="p">;</span>
    <span class="n">aio_close</span> <span class="nv">$fh</span><span class="p">;</span>
    <span class="n">aio_rename</span> <span class="s">&quot;$filename~&quot;</span><span class="p">,</span> <span class="s">&quot;$filename&quot;</span><span class="p">;</span>
</code></pre></div>
<p>上面创建一个新文件，写入数据，同步到磁盘，然后自动的改成新的副本。</p>
<p>
</p>
<h2><a name="翻转控制____唤醒函数">翻转控制 —— 唤醒函数</a></h2>
<p>最后我说说翻转控制。这个控制指谁通知谁，谁在程序的控制内。在这个程序中，main程序就在控制中，并且传递这个控制给他调用的所有函数：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">LWP</span><span class="p">;</span>
    <span class="c1">#转移控制给get</span>
    <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="n">get</span> <span class="s">&quot;http://example.org/&quot;</span><span class="p">;</span>
    <span class="c1">#控制权返回给我们了</span>
    <span class="k">print</span> <span class="nv">$res</span><span class="p">;</span>
</code></pre></div>
<p>当你切换到事件驱动程序的时候，不再是“我调用它”，“他调用我”这样——而是标题所说的翻转控制：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">HTTP</span><span class="p">;</span>
    <span class="c1">#不用交出控制权太久，http_get立刻返回了</span>
    <span class="n">http_get</span> <span class="s">&quot;http://example.org/&quot;</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">print</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">};</span>
    <span class="c1">#我们继续拥有控制权并且可以做其他事情了</span>
</code></pre></div>
<p>基于事件的编程很好，不过有时间它只是更简单的码字罢了，因为不用回调可以写得很像线性的样式。Coro也提供了一些特殊的函数来减少敲键盘的功夫：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">HTTP</span><span class="p">;</span>
    <span class="c1">#不用交出控制权太久，http_get立刻返回了</span>
    <span class="n">http_get</span> <span class="s">&quot;http://example.org/&quot;</span><span class="p">,</span> <span class="nn">Coro::</span><span class="n">rouse_cb</span><span class="p">;</span>
    <span class="c1">#我们继续拥有控制权并且可以做其他事情了</span>
    <span class="c1">#相当于等待</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="o">=</span> <span class="nn">Coro::</span><span class="n">rouse_wait</span><span class="p">;</span>
</code></pre></div>
<p><code>Coro::rouse_cb</code>创建并返回一个特殊的回调。你可以把它传递给任意希望有回调的函数。</p>
<p><code>Coro::rouse_wait</code>等待(阻塞当前线程)最近创建的回调被调用，然后返回传给它的所有数据。</p>
<p>这两个函数允许你<em>机械的</em>翻转控制，由绝大多数基于事件的库使用的"基于回调"的样式变成"阻塞式"的样子，绝对如你所愿。</p>
<p>范例很简单，原先这样写：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">some_func</span> <span class="o">...</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">@res</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="o">...</span>
    <span class="p">};</span>
</code></pre></div>
<p>现在这样写：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">some_func</span> <span class="o">...</span><span class="p">,</span> <span class="nn">Coro::</span><span class="n">rouse_cb</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@res</span> <span class="o">=</span> <span class="nn">Coro::</span><span class="n">rouse_wait</span><span class="p">;</span>
    <span class="o">...</span>
</code></pre></div>
<p>基于回调的接口很丰富，而这个唤醒函数允许你用一种更方便的方式来使用它们。</p>
<p>
</p>
<hr />
<h1><a name="其他模块">其他模块</a></h1>
<p>这篇介绍里只是提到了很少的几个方法和模块。Coro有很多其他的函数(参见<em>Coro</em>的文档)和模块(在<em>Coro</em>文档的<code>SEE ALSO</code>区域)。</p>
<p>值得注意的有<a href="/Coro/LWP.html">the Coro::LWP manpage</a> (并发LWP请求，不过单纯论HTTP的话，<a href="/AnyEvent/HTTP.html">the AnyEvent::HTTP manpage</a>是更好的替代选择)，<a href="/Coro/BDB.html">the Coro::BDB manpage</a>，当你需要异步数据库的时候可用，<a href="/Coro/Handle.html">the Coro::Handle manpage</a>，当你需要在协程中使用文件句柄(通常访问<code>STDIN</code>和<code>STDOUT</code>)和<a href="/Coro/EV.html">the Coro::EV manpage</a>，优化的<em>EV</em>接口(<a href="/Coro/AnyEvent.html">the Coro::AnyEvent manpage</a>自动使用这个)。</p>
<p>有很多Coro相关的模块(参见i<a href="http://search.cpan.org/search?query=Coro&amp;mode=module">http://search.cpan.org/search</a>)可能对解决你的问题有帮助。而且因为Coro和AnyEvent结合的很好，你也很容易就可以适应现有的AnyEvent模块(参见<a href="http://search.cpan.org/search?query=AnyEvent&amp;mode=module">http://search.cpan.org/search</a>)。</p>
<p>
</p>
<hr />
<h1><a name="作者">作者</a></h1>
<pre>
    Marc Lehmann &lt;schmorp@schmorp.de&gt;
    <a href="http://home.schmorp.de/">http://home.schmorp.de/</a>
</pre>
      <a href="/2012/06/29/coro-intro" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/14/intro-stf" title="STF介绍" rel="bookmark">STF介绍</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-14 00:00:00 +0800">14 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>STF项目，全称&rdquo;<a href="http://en.wikipedia.org/wiki/Professional_wrestling_holds#STF">Stepover Toehold Facelock</a>&ldquo;，原因是项目发起人喜欢这个动作，我勒个去……当然作者也给它找了个靠谱一点的解释，叫STorage Farm。</p>
<p>目前主要是日本三大门户之一<a href="http://blog.livedoor.com/">livedoor</a>和<a href="http://tou.ch/">loctouch</a>在使用。livedoor称其图片集群规模在70TB，400,000,000个对象(1,300,000,000个复制份)，高峰流量带宽400Mbps。按照这个数据计算，大概图片的平均大小是50KB的样子。</p>
<p>perl系原先已经有一个非常著名的分布式文件系统，叫MogileFS，作者说STF与MogileFS的不同时说到：</p>
<ol>
  <li>
    <p>STF整个是基于HTTP的，而且是PSGI的。这里我理解MogileFS内部是HTTP的，但是fs对外的api是非http的。而且因为时间较早的原因，mogile内部的http服务器是Danga的socket基础的perlbal，现在perl世界都转向使用psgi了。</p>
  </li>
  <li>
    <p>代码简单。MogileFS有28000行代码，STF只有6000行。我觉得这里因为mogile全套除了metadata用了mysql之外，全都是perl实现。而STF中采用了Q4M、mysql、memcached、nginx/apache等多种外部组件，加上psgi本身也很省代码。</p>
  </li>
</ol>
<p>关于实际工作流程，作者坦言和MogileFS基本一样。</p>
<ol>
  <li>
    <p>dispatcher，类似mogile里的tracker，主要配置内容就是数据库连接。前端还有个proxy，要点是处理X-Reproxy-URL这个HTTP的header。STF中使用apache+mod_reproxy或者nginx，mogile中使用perlbal。</p>
  </li>
  <li>
    <p>job queue，STF中使用Q4M或者theSchwartz，mogile中使用gearmand。用来通知worker进行replica等。</p>
  </li>
  <li>
    <p>MySQL，存储除了文件实际内容以外的所有数据，这里STF和mogile一致。</p>
  </li>
  <li>
    <p>memcached，为了提高性能，给mysql做缓存的。这里mogile没有，不过很容易在调优时改造加入。</p>
  </li>
  <li>
    <p>admin interface，mogile是cli端的，STF是psgi的web端。</p>
  </li>
  <li>
    <p>worker，做数据的replica，delete等，从Q4M里取任务。这个STF和mogile类似。</p>
  </li>
  <li>
    <p>Storage，支持CRUD即GET/PUT/DELETE的HTTP服务器即可。mogile里是mogstored，STF里是storage.psgi。同样都要在admin interface里添加管理。</p>
  </li>
</ol>
<p>然后介绍一些概念：</p>
<ol>
  <li>
    <p>object，一个url对象，因为STF和mogile一样设计目的是小图片，所以一般来说不会有超过大小的分多块的文件(原文a piece of data)，mogile里cli专门针对大于64M的文件要指定&ndash;largefile一样。</p>
  </li>
  <li>
    <p>bucket，一个逻辑上的group。object必须存在于bucket里。这里stf和mogile有些类似又别扭的地方。mogile中，逻辑顺序是这样的：domain-&gt;class-&gt;keyvalue；stf中，逻辑顺序是这样的：bucket-&gt;object。所以一个完整的GET请求会看到object的url是两层目录的样子。</p>
  </li>
  <li>
    <p>entity，也就是replica的份数。</p>
  </li>
</ol>
<p>然后是CRUD的协议：</p>
<ol>
  <li>
    <p>创建bucket：PUT /bucket HTTP/1.0即可，成功创建返回状态码201，已存在返回204，url格式不对返回400，其他返回500。因为apache的mod_reproxy模块不支持chunk，所以使用HTTP/1.0协议，不清楚nginx的话，是否可以用HTTP/1.1，不过我记得有文章说在处理小图片的时候，其实HTTP/1.0比HTTP/1.1更好，因为浏览器可以开更多并发连接。</p>
  </li>
  <li>
    <p>删除bucket：DELETE /bucket HTTP/1.0\r\n\X-STF-Recursive-Delete: 1\r\n\r\n即可。这个多余出来的header可以指定删除bucket里所有的文件，否则会只清楚bucket保留文件，但是还不清楚这种情况下能否访问到这些孤儿文件呢？</p>
  </li>
  <li>
    <p>创建object：PUT /bucket/path/to/my.png HTTP/1.0&hellip;即可。有两个附加的header，一个叫X-STF-Replication-Count，一个叫X-STF-Consistency。前者在保存好第一份之后返回响应，然后通过Q4M让worker开始replica完指定的其他份数；后者则等到指定的份数都完成后才返回响应。</p>
  </li>
  <li>
    <p>获取object：GET /bucket/path/to/my.png HTTP/1.0即可。这里可以使用If-Modified-Since，也可以只使用HEAD请求。如果bucket不存在，响应状态码是500。</p>
  </li>
  <li>
    <p>修改object：POST /bucket/path/to/my.png HTTP/1.0即可。不清楚为什么会提供modify功能。一般分布式系统都是搞追加而已。还需要测试的一个是如果直接POST新object会如何？</p>
  </li>
  <li>
    <p>重命名object： MOVE /bucket/path/to/my.png HTTP/1.0\r\nX-STF-Move-Destination: /newbucket/newpath/to/my.png即可。又是一个古怪的需求。另外不清楚这两个是真修改了呢，还是在mysql里修改标记了而已。</p>
  </li>
</ol>
      <a href="/2012/06/14/intro-stf" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/13/use-redis-and-grok-pattern-for-logstash" title="【Logstash系列】使用Redis并自定义Grok匹配" rel="bookmark">【Logstash系列】使用Redis并自定义Grok匹配</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-13 00:00:00 +0800">13 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前提到，用RabbitMQ作为消息队列。但是这个东西实在太过高精尖，不懂erlang不会调优的情况下，很容易挂掉——基本上我这里试验结果跑不了半小时日志传输就断了。所以改用简单易行的redis来干这个活。</p>
<p>之前的lib里，有inputs/redis.rb和outputs/redis.rb两个库，不过output有依赖，所以要先gem安装redis库，可以修改Gemfile，取消掉相关行的注释，搜redis即可。</p>
<p>然后修改agent.conf：</p>
<div class="highlight"><pre><code class="ruby"><span class="n">input</span> <span class="p">{</span>
  <span class="n">file</span> <span class="p">{</span>
    <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;nginx&quot;</span>
    <span class="n">path</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;/var/log/nginx/access.log&quot;</span> <span class="o">]</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">output</span> <span class="p">{</span>
  <span class="n">redis</span> <span class="p">{</span>
    <span class="n">host</span> <span class="o">=&gt;</span> <span class="s2">&quot;MyHome-1.domain.com&quot;</span>
    <span class="n">data_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;channel&quot;</span>
    <span class="n">key</span> <span class="o">=&gt;</span> <span class="s2">&quot;nginx&quot;</span>
    <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;nginx&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>启动方式还是一样。</p>
<p>接着修改server.conf:</p>
<div class="highlight"><pre><code class="ruby"><span class="n">input</span> <span class="p">{</span>
  <span class="n">redis</span> <span class="p">{</span>
    <span class="n">host</span> <span class="o">=&gt;</span> <span class="s2">&quot;MyHome-1.domain.com&quot;</span>
    <span class="n">data_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;channel&quot;</span>
    <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;nginx&quot;</span>
    <span class="n">key</span> <span class="o">=&gt;</span> <span class="s2">&quot;nginx&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">filter</span> <span class="p">{</span>
  <span class="n">grok</span> <span class="p">{</span>
    <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;nginx&quot;</span>
    <span class="n">pattern</span> <span class="o">=&gt;</span> <span class="s2">&quot;%{NGINXACCESS}&quot;</span>
    <span class="n">patterns_dir</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;/usr/local/logstash/etc/patterns&quot;</span><span class="o">]</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">output</span> <span class="p">{</span>
  <span class="n">elasticsearch</span> <span class="p">{</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>然后创建Grok的patterns目录，主要就是github上clone下来的那个咯~在目录下新建一个叫nginx的文件，内容如下：</p>
<div class="highlight"><pre><code class="ruby"><span class="no">NGINXURI</span> <span class="sx">%{URIPATH}</span><span class="p">(</span><span class="sc">?:</span><span class="sx">%{URIPARAM}</span><span class="p">)</span><span class="o">*</span>
<span class="no">NGINXACCESS</span> <span class="p">\</span><span class="o">[</span><span class="sx">%{HTTPDATE}</span><span class="p">\</span><span class="o">]</span> <span class="sx">%{NUMBER:code}</span> <span class="sx">%{IP:client}</span> <span class="sx">%{HOSTNAME}</span> <span class="sx">%{WORD:method}</span> <span class="sx">%{NGINXURI:req}</span> <span class="sx">%{URIPROTO}</span><span class="o">/</span><span class="sx">%{NUMBER:version}</span> <span class="sx">%{IP:upstream}</span><span class="p">(</span><span class="ss">:%</span><span class="p">{</span><span class="ss">POSINT</span><span class="p">:</span><span class="n">port</span><span class="p">})?</span> <span class="sx">%{NUMBER:upstime}</span> <span class="sx">%{NUMBER:reqtime}</span> <span class="sx">%{NUMBER:size}</span> <span class="s2">&quot;(%{URIPROTO}://%{HOST:referer}%{NGINXURI:referer}|-)&quot;</span> <span class="sx">%{QS:useragent}</span> <span class="s2">&quot;(%{IP:x_forwarder_for}|-)&quot;</span>
</code></pre></div>
<p>Grok正则的编写，可以参考<a href="https://github.com/logstash/logstash/wiki/Testing-your-Grok-patterns-%28--logstash-1.1.0-and-above-%29">wiki</a>进行测试。</p>
<p>也可以不写配置文件，直接用&ndash;grok-patterns-path参数启动即可。</p>
<p>ps: 考察了一下statsd，发现它也要另存一份数据，放弃掉。转研究Kibana界面和Elasticsearch的分布式。</p>
      <a href="/2012/06/13/use-redis-and-grok-pattern-for-logstash" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/10/install-mogilefs" title="MogileFS安装" rel="bookmark">MogileFS安装</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-10 00:00:00 +0800">10 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>纯属凑数的更新，写写安装过程而已。没有调优，没有测评，嗯……</p>
<ul>
  <li>storage Node</li>
</ul>
<div class="highlight"><pre><code class="bash">cpanm MogileFS::Utils MogileFS::Client
<span class="c"># 因为MogileFS::Server的test里会测试mysql、sqlite、pgsql的支持，用不着，直接强制安装就好了</span>
cpanm --force MogileFS::Server
mkdir /etc/mogilefs
cat &gt; /etc/mogilefs/mogstored.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">maxconns = 10000</span>
<span class="s">httplisten = 0.0.0.0:7500</span>
<span class="s">mgmtlisten = 0.0.0.0:7501</span>
<span class="s">docroot=/data/mogstore</span>
<span class="s">EOF</span>
<span class="c"># 不在同一分区的磁盘采用软连接方式建立伪DEV设备</span>
mkdir /data/mogstore/dev170
mkdir /data1/mogstore
ln -s /data1/mogstore /data/mogstore/dev171
</code></pre></div>
<ul>
  <li>Tracker</li>
</ul>
<div class="highlight"><pre><code class="bash">yum install -y mysql-server mysql-devel
cpanm DBI DBD::mysql MogileFS::Utils MogileFS::Client
cpanm --force MogileFS::Server
</code></pre></div>
<div class="highlight"><pre><code class="sql"><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">MogileFS</span> <span class="k">DEFAULT</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8_bin</span><span class="p">;</span>
<span class="k">grant</span> <span class="k">all</span> <span class="k">on</span> <span class="n">MogileFS</span><span class="p">.</span><span class="o">*</span> <span class="k">to</span> <span class="s1">&#39;mogile&#39;</span><span class="o">@</span><span class="s1">&#39;%&#39;</span> <span class="n">identified</span> <span class="k">by</span> <span class="s1">&#39;mogile&#39;</span><span class="p">;</span>
<span class="k">UPDATE</span> <span class="n">mysql</span><span class="p">.</span><span class="k">user</span> <span class="k">SET</span> <span class="n">Password</span><span class="o">=</span><span class="n">PASSWORD</span><span class="p">(</span><span class="s1">&#39;newpass&#39;</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">User</span><span class="o">=</span><span class="s1">&#39;mogile&#39;</span><span class="p">;</span>
<span class="n">FLUSH</span> <span class="k">PRIVILEGES</span><span class="p">;</span>
</code></pre></div>
<div class="highlight"><pre><code class="bash"><span class="c"># 初始化mysql数据库表</span>
mogdbsetup --dbhost<span class="o">=</span>tracker.mogile.com --dbname<span class="o">=</span>MogileFS --dbuser<span class="o">=</span>mogile --dbpass<span class="o">=</span>newpass
mkdir /etc/mogilefs
cat &gt; /etc/mogilefs/mogilefsd.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">db_dsn = DBI:mysql:MogileFS:host=tracker.mogile.com</span>
<span class="s">db_user = mogile</span>
<span class="s">db_pass = mogile</span>
<span class="s">listen = 0.0.0.0:7001</span>
<span class="s">conf_port = 7001</span>
<span class="s">query_jobs = 10</span>
<span class="s">delete_jobs = 1</span>
<span class="s">replicate_jobs = 5</span>
<span class="s">reaper_jobs = 1</span>
<span class="s">EOF</span>
<span class="c"># mogilefsd不能用root启动</span>
useradd mogile
su - mogile -c <span class="s1">&#39;mogilefsd -c /etc/mogilefs/mogilefsd.conf --daemon&#39;</span>
<span class="c"># 添加storage node和相关伪DEV设备信息</span>
mogadm host add mognode17 --ip<span class="o">=</span>10.0.0.17 --port<span class="o">=</span>7500 --status<span class="o">=</span>alive
mogadm device add mognode17 170
mogadm device add mognode17 171
<span class="c"># 添加域和类。文件的key在同一域内是唯一的。同一类可以指定自己的复制份数</span>
mogadm domain add fmn
mogadm class add fmn large --mindevcount<span class="o">=</span>3
mogadm class add fmn small --mindevcount<span class="o">=</span>3
<span class="c"># 检查状态，类似的有mogadm check命令</span>
mogstats --db_dsn<span class="o">=</span><span class="s2">&quot;DBI:mysql:MogileFS:host=tracker.mogile.com&quot;</span> --db_user<span class="o">=</span><span class="s2">&quot;mogile&quot;</span> --db_pass<span class="o">=</span><span class="s2">&quot;mogile&quot;</span> --verbose --stats<span class="o">=</span><span class="s2">&quot;all&quot;</span>
<span class="c"># 插入一个文件做测试</span>
mogtool --debug --trackers<span class="o">=</span>127.0.0.1:7001 --domain<span class="o">=</span>fmn --class<span class="o">=</span>large inject index.html <span class="s2">&quot;index.html&quot;</span>
</code></pre></div>
<ul>
  <li>Fuse</li>
</ul>
<p>这步没搞出来，因为search.cpan.org上的Fuse是0.14版本，cpanm安装居然说无法下载的是0.15版。而MogileFS::Client::Fuse里use的是0.11版……
而且直接下载的Fuse0.14版源码编译还一直通不过make test。。。</p>
<p>最后在github上找到两个资源：
<a href="https://github.com/dpavlin/perl-fuse">Fuse-0.15</a>  <br />
<a href="https://github.com/frett/MogileFS-Fuse">Mogile-Fuse-0.03</a>    </p>
<p>先解决依赖：</p>
<div class="highlight"><pre><code class="bash">yum install -y fuse fuse-devel fuse-libs
cpanm FUSE::Client FUSE::Server Lchown Filesys::Statvfs Unix::Mknod
</code></pre></div>
<p>然后perl Makefile.PL &amp;&amp; make &amp;&amp; make test &amp;&amp; make install即可。
挂载命令是：
mount-mogilefs &ndash;daemon &ndash;tracker 10.0.0.16:7001 /mnt/mogilefs
不过目前为止我挂载上去依然无法使用，输入输出有问题……</p>
      <a href="/2012/06/10/install-mogilefs" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/08/intro-trafficserver-ssd-branch-in-taobao" title="淘宝TrafficServer的SSD分支测试与介绍" rel="bookmark">淘宝TrafficServer的SSD分支测试与介绍</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-08 00:00:00 +0800">08 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>同事介绍说淘宝有关于trafficserver的一个分支支持SSD的。下来试试。<a href="http://gitorious.org/trafficserver/taobao/commits/tbtrunk_ssd">下载地址</a></p>
<p>官方的ats安装过程很简单，这个分支稍微麻烦一些，因为有些包变成强制依赖了，包括：expat/openssl/pcre等。根据提示安装好再重新编译即可。</p>
<p>表面看几乎没什么差别，就是多了一个storage_ssd.config配置文件。</p>
<p>基础配置项说明网上都有，无外乎就是records.config里的监听，remap.config里的域名，storage.config里的目录。下面说几个比较怪异或者难受的地方：</p>
<ol>
  <li>
    <p>trafficserver极其依赖DNS解析。我在parents.config中定义了多个parents的IP:port后，打开records.config里的debug信息，包括http.*、dns.*、cdn.*和url.*，结果发现ats针对每个url，会在获取完parents后依然去请求dns解析——注意这是在records.config里已经配置了no_dns_just_forward_to_parent为1之后，这种与字面意思严重不一样的结果让我很诧异……</p>
  </li>
  <li>
    <p>由于上面说的parent配置不可行，所以在remap.config中只能使用单个ip的方式回源。这里配置说明一般都说前后域名必须不一样，但是我在debug中没有发现这个逻辑，事实上ats不管这个事情，所谓不能一样，大概是怕本机dns解析回到自己变成loop吧。</p>
  </li>
  <li>
    <p>默认关于内存，是每1GB的磁盘启用1MB的内存。所以如果不指定的话，基本上磁盘的IO会很高很高！而最恶心的地方来了：配置里所有的数值都是以Byte为单位的，尼玛写4GB内存写的跟裹脚布一样长啊！</p>
  </li>
</ol>
<p>然后说测试。在性能方面，ats还是不错的。基本上我在单机走lo口，用http_load做压测，都是http_load先到瓶颈——因为http_load只用单核CPU。使用-p 1000的参数测试（因为最大只让开到1020），同机上的squid2.6.23、trafficserver和trafficserver-ssd三种，rps分别在6000，19000和14000的样子。first-bytes msec在10，4，1的样子，cpu在150％，25％，25％的样子。</p>
<p>以上是只用了4个域名每个域名1个url的小样本测试。实际运行起来应该不会这么高。</p>
<p>另：在需要dns解析的时候，14000的rps降到只有300＋，深表无语。</p>
<hr />
<p>线上流量运行测试后的补充：</p>
<ul>
  <li>不要使用文件存储，直接把裸设备交给ats管理！</li>
  <li>预估好要缓存的文件的平均大小，默认是8000。ats和squid不一样的是这个值会影响ats的文件组织结构。每次修改都会重建缓存。</li>
</ul>
      <a href="/2012/06/08/intro-trafficserver-ssd-branch-in-taobao" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/08/create-python-module-for-ganglia" title="用ganglia监控trafficserver" rel="bookmark">用ganglia监控trafficserver</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-08 00:00:00 +0800">08 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>trafficserver提供了几种很不错的性能监控方式。首先是一个模仿cisco的shell工具./bin/traffic_shell——这个工具可以set变量，也可以show变量，另一个是类似squidclient的./bin/traffic_line工具——这个工具同样可以set和show变量，不过这里变量更接近源代码函数名的样子，相当于调用API了。此外还有Perl和Web的其他方式……</p>
<p>注：有些变量是可以动态修改的，有些比如内存大小之类的必须重启才生效。</p>
<p>用shell工具最方便，因为你单写个show，会提示你所有可以show的参数。一般性能方面就是http-stats/http-trans-stats/proxy-stats/cache-stats这几个。淘宝ssd分支在这里增加了一个SSD吞吐量和RAM缓存命中率的显示。不过一开始，你会发现RAM Cache HITs一直是0.00%！！询问作者后才知道，为了尽量提高性能，默认配置下RAM命中后不统计数据直接pass了……需要在records.config里配置CONFIG proxy.config.http.record_tcp_mem_hit = 1 才行——这配置records.config.default里还没有，呵呵～～</p>
<p>长期监控来说，用shell工具就不方便了，就要改用line工具，不过这里line读取的API，官方文档里是不全的，有一个简单的办法，就是进src/mgmt/cli/ShowCmd.cc里去把Cli_RecordGetInt里的字符串全grep出来，然后慢慢挑拣吧～～</p>
<p>下面是一个python的脚本，用来在ganglia里监控几个我个人认为比较重要的trafficserver性能参数的。</p>
<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="n">ts_line</span> <span class="o">=</span> <span class="s">&#39;/usr/local/trafficserver-ssd/bin/traffic_line&#39;</span>
<span class="k">def</span> <span class="nf">metric_read</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> -r </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ts_line</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;ratio|percent&quot;</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">descriptors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;Cache Bytes used&#39;</span><span class="p">,</span>
        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;proxy.process.cache.bytes_used&#39;</span><span class="p">,</span>
        <span class="s">&#39;call_back&#39;</span><span class="p">:</span> <span class="n">metric_read</span><span class="p">,</span>
        <span class="s">&#39;time_max&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
        <span class="s">&#39;value_type&#39;</span><span class="p">:</span><span class="s">&#39;float&#39;</span><span class="p">,</span>
        <span class="s">&#39;units&#39;</span><span class="p">:</span><span class="s">&#39;Bytes&#39;</span><span class="p">,</span>
        <span class="s">&#39;slope&#39;</span><span class="p">:</span><span class="s">&#39;both&#39;</span><span class="p">,</span>
        <span class="s">&#39;format&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;groups&#39;</span><span class="p">:</span><span class="s">&#39;trafficserver&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;Cache size&#39;</span><span class="p">,</span>
        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;proxy.process.cache.bytes_total&#39;</span><span class="p">,</span>
        <span class="s">&#39;call_back&#39;</span><span class="p">:</span> <span class="n">metric_read</span><span class="p">,</span>
        <span class="s">&#39;time_max&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
        <span class="s">&#39;value_type&#39;</span><span class="p">:</span><span class="s">&#39;float&#39;</span><span class="p">,</span>
        <span class="s">&#39;units&#39;</span><span class="p">:</span><span class="s">&#39;Bytes&#39;</span><span class="p">,</span>
        <span class="s">&#39;slope&#39;</span><span class="p">:</span><span class="s">&#39;both&#39;</span><span class="p">,</span>
        <span class="s">&#39;format&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;groups&#39;</span><span class="p">:</span><span class="s">&#39;trafficserver&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;Transactions per second&#39;</span><span class="p">,</span>
        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;proxy.node.user_agent_xacts_per_second&#39;</span><span class="p">,</span>
        <span class="s">&#39;call_back&#39;</span><span class="p">:</span> <span class="n">metric_read</span><span class="p">,</span>
        <span class="s">&#39;time_max&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
        <span class="s">&#39;value_type&#39;</span><span class="p">:</span><span class="s">&#39;float&#39;</span><span class="p">,</span>
        <span class="s">&#39;units&#39;</span><span class="p">:</span><span class="s">&#39;requests/sec&#39;</span><span class="p">,</span>
        <span class="s">&#39;slope&#39;</span><span class="p">:</span><span class="s">&#39;both&#39;</span><span class="p">,</span>
        <span class="s">&#39;format&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;groups&#39;</span><span class="p">:</span><span class="s">&#39;trafficserver&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;Document hit rate&#39;</span><span class="p">,</span>
        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;proxy.node.cache_hit_ratio_avg_10s&#39;</span><span class="p">,</span>
        <span class="s">&#39;call_back&#39;</span><span class="p">:</span> <span class="n">metric_read</span><span class="p">,</span>
        <span class="s">&#39;time_max&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
        <span class="s">&#39;value_type&#39;</span><span class="p">:</span><span class="s">&#39;float&#39;</span><span class="p">,</span>
        <span class="s">&#39;units&#39;</span><span class="p">:</span><span class="s">&#39;%&#39;</span><span class="p">,</span>
        <span class="s">&#39;slope&#39;</span><span class="p">:</span><span class="s">&#39;both&#39;</span><span class="p">,</span>
        <span class="s">&#39;format&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;groups&#39;</span><span class="p">:</span><span class="s">&#39;trafficserver&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;Bandwidth savings&#39;</span><span class="p">,</span>
        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;proxy.node.bandwidth_hit_ratio_avg_10s&#39;</span><span class="p">,</span>
        <span class="s">&#39;call_back&#39;</span><span class="p">:</span> <span class="n">metric_read</span><span class="p">,</span>
        <span class="s">&#39;time_max&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
        <span class="s">&#39;value_type&#39;</span><span class="p">:</span><span class="s">&#39;float&#39;</span><span class="p">,</span>
        <span class="s">&#39;units&#39;</span><span class="p">:</span><span class="s">&#39;%&#39;</span><span class="p">,</span>
        <span class="s">&#39;slope&#39;</span><span class="p">:</span><span class="s">&#39;both&#39;</span><span class="p">,</span>
        <span class="s">&#39;format&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;groups&#39;</span><span class="p">:</span><span class="s">&#39;trafficserver&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;Cache percent free&#39;</span><span class="p">,</span>
        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;proxy.node.cache.percent_free&#39;</span><span class="p">,</span>
        <span class="s">&#39;call_back&#39;</span><span class="p">:</span> <span class="n">metric_read</span><span class="p">,</span>
        <span class="s">&#39;time_max&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
        <span class="s">&#39;value_type&#39;</span><span class="p">:</span><span class="s">&#39;float&#39;</span><span class="p">,</span>
        <span class="s">&#39;units&#39;</span><span class="p">:</span><span class="s">&#39;%&#39;</span><span class="p">,</span>
        <span class="s">&#39;slope&#39;</span><span class="p">:</span><span class="s">&#39;both&#39;</span><span class="p">,</span>
        <span class="s">&#39;format&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;groups&#39;</span><span class="p">:</span><span class="s">&#39;trafficserver&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;Total document bytes from client&#39;</span><span class="p">,</span>
        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;proxy.process.http.user_agent_response_document_total_size&#39;</span><span class="p">,</span>
        <span class="s">&#39;call_back&#39;</span><span class="p">:</span> <span class="n">metric_read</span><span class="p">,</span>
        <span class="s">&#39;time_max&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
        <span class="s">&#39;value_type&#39;</span><span class="p">:</span><span class="s">&#39;float&#39;</span><span class="p">,</span>
        <span class="s">&#39;units&#39;</span><span class="p">:</span><span class="s">&#39;Bytes&#39;</span><span class="p">,</span>
        <span class="s">&#39;slope&#39;</span><span class="p">:</span><span class="s">&#39;both&#39;</span><span class="p">,</span>
        <span class="s">&#39;format&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;groups&#39;</span><span class="p">:</span><span class="s">&#39;trafficserver&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;Total SSD Serve Bytes&#39;</span><span class="p">,</span>
        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;proxy.process.http.ssd_serve_total_size&#39;</span><span class="p">,</span>
        <span class="s">&#39;call_back&#39;</span><span class="p">:</span> <span class="n">metric_read</span><span class="p">,</span>
        <span class="s">&#39;time_max&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
        <span class="s">&#39;value_type&#39;</span><span class="p">:</span><span class="s">&#39;float&#39;</span><span class="p">,</span>
        <span class="s">&#39;units&#39;</span><span class="p">:</span><span class="s">&#39;Bytes&#39;</span><span class="p">,</span>
        <span class="s">&#39;slope&#39;</span><span class="p">:</span><span class="s">&#39;both&#39;</span><span class="p">,</span>
        <span class="s">&#39;format&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;groups&#39;</span><span class="p">:</span><span class="s">&#39;trafficserver&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;RAM Cache Hits&#39;</span><span class="p">,</span>
        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;proxy.node.cache_hit_mem_ratio&#39;</span><span class="p">,</span>
        <span class="s">&#39;call_back&#39;</span><span class="p">:</span> <span class="n">metric_read</span><span class="p">,</span>
        <span class="s">&#39;time_max&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
        <span class="s">&#39;value_type&#39;</span><span class="p">:</span><span class="s">&#39;float&#39;</span><span class="p">,</span>
        <span class="s">&#39;units&#39;</span><span class="p">:</span><span class="s">&#39;%&#39;</span><span class="p">,</span>
        <span class="s">&#39;slope&#39;</span><span class="p">:</span><span class="s">&#39;both&#39;</span><span class="p">,</span>
        <span class="s">&#39;format&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;groups&#39;</span><span class="p">:</span><span class="s">&#39;trafficserver&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;HTTP Transaction Fresh Speeds&#39;</span><span class="p">,</span>
        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;proxy.node.http.transaction_msec_avg_10s.hit_fresh&#39;</span><span class="p">,</span>
        <span class="s">&#39;call_back&#39;</span><span class="p">:</span> <span class="n">metric_read</span><span class="p">,</span>
        <span class="s">&#39;time_max&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
        <span class="s">&#39;value_type&#39;</span><span class="p">:</span><span class="s">&#39;float&#39;</span><span class="p">,</span>
        <span class="s">&#39;units&#39;</span><span class="p">:</span><span class="s">&#39;ms&#39;</span><span class="p">,</span>
        <span class="s">&#39;slope&#39;</span><span class="p">:</span><span class="s">&#39;both&#39;</span><span class="p">,</span>
        <span class="s">&#39;format&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;groups&#39;</span><span class="p">:</span><span class="s">&#39;trafficserver&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;HTTP Transaction Now Cached Speeds&#39;</span><span class="p">,</span>
        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;proxy.node.http.transaction_msec_avg_10s.miss_cold&#39;</span><span class="p">,</span>
        <span class="s">&#39;call_back&#39;</span><span class="p">:</span> <span class="n">metric_read</span><span class="p">,</span>
        <span class="s">&#39;time_max&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
        <span class="s">&#39;value_type&#39;</span><span class="p">:</span><span class="s">&#39;float&#39;</span><span class="p">,</span>
        <span class="s">&#39;units&#39;</span><span class="p">:</span><span class="s">&#39;ms&#39;</span><span class="p">,</span>
        <span class="s">&#39;slope&#39;</span><span class="p">:</span><span class="s">&#39;both&#39;</span><span class="p">,</span>
        <span class="s">&#39;format&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="si">%f</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;groups&#39;</span><span class="p">:</span><span class="s">&#39;trafficserver&#39;</span>
    <span class="p">},</span>
<span class="p">]</span>
<span class="k">def</span> <span class="nf">metric_init</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">descriptors</span>
<span class="k">def</span> <span class="nf">metric_cleanup</span><span class="p">():</span>
    <span class="k">pass</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">metric_init</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;call_back&#39;</span><span class="p">](</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">11</span>
</code></pre></div>
<p>个人之前从来没写过python，这个脚本完全照葫芦画瓢，万幸确实可以运行……</p>
<p>不过不太明白的就是，如果把def metric_read定义在descriptors数组后面，运行会报错。很奇怪python为什么会这样？</p>
      <a href="/2012/06/08/create-python-module-for-ganglia" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/01/dist-logstash-and-elasticsearch" title="【Logstash系列】用rabbitmq和elasticsearch搭建分布式日志收集存储系统" rel="bookmark">【Logstash系列】用rabbitmq和elasticsearch搭建分布式日志收集存储系统</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-01 00:00:00 +0800">01 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上上篇讲到怎样用MRI的ruby在客户端收集日志。今天主要注意服务器端，考虑grok、elastic、web这几个功能在JRuby上才好。所以服务器端可以再开一个JRuby的进程。</p>
<ul>
  <li>首先安装RabbitMQ的过程</li>
</ul>
<p>最简单的办法，采用epel的yum，或者apt安装。其次简单的办法，从rabbitmq上下载bin的tar.gz。 <br />
这里需要注意一下，rabbitmq-server启动的时候，默认node启动在rabbit@${hostname}上。而且这个hostname不是fqdn的，是第一个主机名。比方说你的hostname是MyHome-1.mydomain.com.，那node就是rabbit@MyHome-1。这个时候很容易报Connect MyHome-1 timeout。所以/etc/hosts一定要写好。  <br />
rabbitmq-server起来之后，可以用rabbitmyctl来具体的创建user啊，vhost啊之类的东西，作为测试，我们就直接使用默认的guest用户和/了。</p>
<ul>
  <li>然后安装elasticsearch的过程</li>
</ul>
<p>这一步在logstash的docs里讲的很清楚了，就是下载tar.gz，解压然后java运行起来即可：    </p>
<div class="highlight"><pre><code class="bash"><span class="nv">ES_PACKAGE</span><span class="o">=</span>elasticsearch-0.18.7.zip
<span class="nv">ES_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">ES_PACKAGE</span><span class="p">%%.zip</span><span class="k">}</span>
<span class="nv">SITE</span><span class="o">=</span>https://github.com/downloads/elasticsearch/elasticsearch
<span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&quot;$ES_DIR&quot;</span> <span class="o">]</span> ; <span class="k">then</span>
<span class="k">  </span>wget --no-check-certificate <span class="nv">$SITE</span>/<span class="nv">$ES_PACKAGE</span>
  unzip <span class="nv">$ES_PACKAGE</span>
<span class="k">fi</span>
</code></pre></div>
<ul>
  <li>部署一个logstash的采集节点</li>
</ul>
<p>和上篇所述一样，传输一个删减版的Gemfile到采集节点。然后使用bundle安装这些模块：    </p>
<div class="highlight"><pre><code class="bash">mkdir -p /usr/local/logstash/etc /usr/local/logstash/bin /usr/local/logstash/lib
scp <span class="k">${</span><span class="nv">logstashmaster</span><span class="k">}</span>:/usr/local/logstash/Gemfile /usr/local/logstash/
scp -rf <span class="k">${</span><span class="nv">logstashmaster</span><span class="k">}</span>:/usr/local/logstash/lib/* /usr/local/logstash/lib/
scp <span class="k">${</span><span class="nv">logstashmaster</span><span class="k">}</span>:/usr/local/logstash/bin/logstash /usr/local/logstash/bin/
gem install bundler
<span class="nb">cd</span> /usr/local/logstash/
bundle install
</code></pre></div>
<p>然后编写一个使用rabbitmq的配置文件：</p>
<div class="highlight"><pre><code class="ruby"><span class="n">input</span> <span class="p">{</span>
  <span class="n">file</span> <span class="p">{</span>
    <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;syslog&quot;</span>
    <span class="n">path</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;/var/log/syslog.log&quot;</span><span class="p">,</span> <span class="s2">&quot;/var/log/messages&quot;</span> <span class="o">]</span>
  <span class="p">}</span> 
<span class="p">}</span>
<span class="n">output</span> <span class="p">{</span>
  <span class="n">amqp</span> <span class="p">{</span>
    <span class="n">host</span> <span class="o">=&gt;</span> <span class="s2">&quot;MyHome-1&quot;</span>
    <span class="n">exchange_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;fanout&quot;</span>
    <span class="nb">name</span> <span class="o">=&gt;</span> <span class="s2">&quot;rawlogs&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>OK，用ruby /usr/local/logstash/bin/logstash agent -f /usr/local/logstash/etc/agent.conf启动即可。</p>
<ul>
  <li>部署一个logstash的汇聚节点</li>
</ul>
<p>这一步因为用到的模块大多是JRuby的，所以可以直接使用jar包的方式简单搞定。
编写一个使用rabbitmq和elasticsearch的配置文件：</p>
<div class="highlight"><pre><code class="ruby"><span class="n">input</span> <span class="p">{</span>
  <span class="n">amqp</span> <span class="p">{</span>
    <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;syslog&quot;</span>
    <span class="n">host</span> <span class="o">=&gt;</span> <span class="s2">&quot;MyHome-1&quot;</span>
    <span class="n">exchange</span> <span class="o">=&gt;</span> <span class="s2">&quot;rawlogs&quot;</span>
    <span class="nb">name</span> <span class="o">=&gt;</span> <span class="s2">&quot;rawlogs_consumer&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">filter</span> <span class="p">{</span>
  <span class="n">grok</span> <span class="p">{</span>
    <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;syslog&quot;</span>
    <span class="n">pattern</span> <span class="o">=&gt;</span> <span class="s2">&quot;%{SYSLOG}&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">output</span> <span class="p">{</span>
  <span class="n">elasticsearch</span> <span class="p">{</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>这里比较讨厌的还是rabbitmq的部分。假如前面的步骤rabbitmq-server压根启动失败了，这里amqp不会返回报错说连接失败或者连接node超时什么的，而是说你试图连接一个私有的被锁定的队列……</p>
<ul>
  <li>部署一个logstash的展示节点</li>
</ul>
<p>这个节点就没必要再单开一台了，就用上面的jar包再启动一个web即可：java -jar logstash-1.1.0-monolithic.jar agent -f server.conf &ndash; web &ndash;backend &lsquo;elasticsearch:///?local&rsquo;</p>
<ul>
  <li>测试</li>
</ul>
<p>现在可以打开浏览器访问web查看了。很简单的页面，顶上一个搜索栏，中间一个按时间轴显示的柱状图，下面是具体的日志记录。点具体的某条日志，会有浮框显示该条记录的详细信息(host/date/event/message等)</p>
<p>下一步研究grok正则匹配的编写，然后stated实时绘图，lucene查询语法。</p>
      <a href="/2012/06/01/dist-logstash-and-elasticsearch" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2012/06/01/create-slides-by-using-spork-and-tt2" title="用Spork和Template::Toolkit生成slides胶片展示" rel="bookmark">用Spork和Template::Toolkit生成slides胶片展示</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2012-06-01 00:00:00 +0800">01 Jun 2012</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在不少技术集会上，大家都不再采用ppt而是使用pdf，甚至浏览器，编辑器来显示内容。利用js和css完成slide效果已经越来越花哨。另一个用vim的流派也让人很是惊叹~  <br />
那不会css的童鞋怎么办呢？这里有个笨办法。用Spork工具生成html页——反正slide一般内容不多，html代码重复一点也不浪费啥事儿~用template技术刚刚好。
Spork是一个在Sporx基础上构成的工具，可以直接cpan安装，不过默认情况下没有plugin。所以比较好的办法是上git找个带plugin的代码clone。这样页面样式好看点。  <br />
比方我用的这个就是Spork作者用的：<a href="https://github.com/ingydotnet/spork-pm">Spork-pm</a></p>
<p>新建一个slide的工程相当简单：</p>
<div class="highlight"><pre><code class="bash">git clone https://github.com/ingydotnet/spork-pm.git
<span class="nb">cd </span>spork-pm
perl Makefile.PL
make <span class="o">&amp;&amp;</span> make install
<span class="c"># 必须新建，非空目录时命令无效</span>
mkdir /tmp/slides
<span class="nb">cd</span> /tmp/slides
Spork -new
Spork -make
Spork -start
</code></pre></div>
<p>在slide里每张都加载,css和js都是重复的。make的过程就是使用template展开的问题。start就是打开浏览器的命令行的alias。这里其实可以优化一下改成外链css/js(默认是因为有些控制bgcolor啊之类的spork语法可以在单页里用，所以就没外链)~  <br />
注意template里的模板html里charset都是写的UTF-8编码，而在win上，编辑器默认是GB2312的，需要更改过来。</p>
<p>具体语法，&mdash;-表示一页；==表示大标题；<em>表示小条目，</em>越多条目等级越低；+表示稍后显示(其实就是在本页基础上再开新页)。  <br />
然后还有一些config定义，用来显示head，foot和start页内容的。    </p>
<p>最后，上一个最近我的slide，关于DNS协议和应用的内容，浏览地址见：
<a href="http://chenlinux.com/dns-slides/slides/start.html">DNS协议与应用</a></p>
<p>比较无语的是js控制翻页这块。我的笔记本键盘只能捕获中间正常键位信号，上下左右、home、end、pgon、pgdn这些统统不行。无奈只好改用输入法一样的逗号,句号.翻页了……</p>
      <a href="/2012/06/01/create-slides-by-using-spork-and-tt2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page2">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page active">
      <a href="#">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li>
      <a href="/page4">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.icylife.net/blog/" title="">心路</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://dbahacker.com/" title="TB 杨德华">DBA Hacker</a></li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.laird-sa.com/" title="">Laird-SA</a></li>
              <li><a href="http://www.linuxsee.com/" title="">LinuxSEE</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://www.puppeter.cn/" title="">piol</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.sanote.org/" title="">sa note</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://blog.ops.tudou.com/wp/" title="">土豆运营团队</a></li>
              <li><a href="http://www.91tuanfang.com/" title="安居客运维">家欣的天空</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://www.opboy.com" title="">运维小子</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://l09.me/" title="风声">风声</a></li>
              <li><a href="http://moyan.tk/" title="莫言">莫言</a></li>
              <li><a href="http://mooser.me/" title="牛氓">牛氓</a></li>
              <li><a href="http://http://www.yinwang.org/" title="当然我在扯淡">当然我在扯淡</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://muxueqz.laou.me" title="muxueqz">聊逍遥兮容与</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://paperplane.ruhoh.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
          </ul>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
