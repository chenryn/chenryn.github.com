<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/03/03/loadbalance-in-nginx-using-consistent_hash-error_page" title="nginx负载均衡（consistent_hash、error_page）进阶" rel="bookmark">nginx负载均衡（consistent_hash、error_page）进阶</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-03-03 00:00:00 +0800">03 Mar 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>话接上篇，采用consistent方式进行url_hash负载均衡。</p>
<p>重新编译nginx过程如下：</p>
<div class="highlight"><pre><code class="bash">wget http://download.github.com/replay-ngx_http_consistent_hash-77b6940.tar.gz
tar zxvf replay-ngx_http_consistent_hash-77b6940.tar.gz
<span class="nb">cd </span>nginx-0.7.65
./configure --prefix<span class="o">=</span>/home/nginx   --with-pcre<span class="o">=</span>/tmp/pcre-8.01 --with-http_stub_status_module --with-http_ssl_module --without-http_rewrite_module --add-module<span class="o">=</span>/tmp/nginx_upstream_hash-0.3 --add-module<span class="o">=</span>/tmp/replay-ngx_http_consistent_hash-77b6940
make <span class="o">&amp;&amp;</span> make install
</code></pre></div>
<p>完成。配置文件修改如下：</p>
<div class="highlight"><pre><code class="nginx"><span class="k">upstream</span> <span class="s">images6.static.com</span> <span class="p">{</span>
    <span class="kn">server</span> <span class="n">11.11.11.12</span><span class="p">:</span><span class="mi">80</span><span class="p">;</span>
    <span class="kn">server</span> <span class="n">11.11.11.13</span><span class="p">:</span><span class="mi">80</span><span class="p">;</span>
    <span class="kn">consistent_hash</span> <span class="nv">$request_uri</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>访问测试正常。</p>
<p>error_page配置备份如下：</p>
<div class="highlight"><pre><code class="nginx"><span class="k">upstream</span> <span class="s">backup</span> <span class="p">{</span>
    <span class="kn">server</span> <span class="n">11.11.11.14</span><span class="p">:</span><span class="mi">80</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">error_page</span> <span class="mi">404</span> <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span> <span class="p">=</span><span class="mi">200</span> <span class="s">@fetch</span><span class="p">;</span>
<span class="k">location</span> <span class="s">@fetch</span> <span class="p">{</span>
    <span class="kn">proxy_pass       </span> <span class="s">http://backup</span><span class="p">;</span>
    <span class="kn">proxy_set_header  </span> <span class="s">Host            </span> <span class="nv">$host</span><span class="p">;</span>
    <span class="kn">proxy_set_header  </span> <span class="s">X-Real-IP       </span> <span class="nv">$remote_addr</span><span class="p">;</span>
    <span class="kn">proxy_set_header  </span> <span class="s">X-Forwarded-For </span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>注意：=200里的等号，左边有空格，右边没空格。</p>
      <a href="/2010/03/03/loadbalance-in-nginx-using-consistent_hash-error_page" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/03/03/an-alarm-shell-using-sendemail" title="服务器监控报警小脚本（shell+sendEmail）" rel="bookmark">服务器监控报警小脚本（shell+sendEmail）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-03-03 00:00:00 +0800">03 Mar 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>这种email报警脚本遍地都是，很多用的sendmail、postfix，感觉有些大材小用了；也有些用perl的NET::SMTP和Authen::SASL模块发信的，不过我perl用的不好，老发出些莫名其妙的邮件来（比如if(a&gt;1){print(a);}，最后邮件里的显示的是0.99……）；最后采用sendEmail这个成型的perl程序发信报警，而实时监控部分回归shell，终于完成。</p>
<div class="highlight"><pre><code class="bash">wget &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://caspian.dotconf.net/menu/Software/SendEmail/sendEmail-v1.56.tar.gz&quot;</span>&gt;http://caspian.dotconf.net/menu/Software/SendEmail/sendEmail-v1.56.tar.gz&lt;/a&gt;
tar zxvf sendEmail-v1.56.tar.gz
cp sendEmail-v1.56/sendEmail /shell/check/
cat &gt;&gt; check.sh <span class="s">&lt;&lt;EOF</span>
<span class="s">#!/bin/bash</span>
<span class="s">checkmail() {</span>
<span class="s">    /usr/bin/perl ./sendEmail -f userid@mail.com -t oneuserid@mail.com –cc twouserid@mail.com threeuserid@mail.com -u &quot;$subject&quot; -m &quot;$data&quot; -s smtp.mail.com -xu userid -xp password</span>
<span class="s">    sleep 300</span>
<span class="s">}</span>
<span class="s">while true;do</span>
<span class="s">    loadavg=`awk &#39;{print $2}&#39; /proc/loadavg`</span>
<span class="s">    diskuse=`df |awk &#39;/cache/{print $5}&#39;`</span>
<span class="s">    servrun=`netstat -pln|awk -F/ &#39;/:80/{print $NF}&#39;`</span>
<span class="s">    </span>
<span class="s">    ip=`ifconfig|awk &#39;/cast/{print $2}&#39;|awk -F: &#39;{if(NR==1){a=$2}else if(NR==2){b=$2}}END{print b&quot;-&quot;a}&#39;`</span>
<span class="s">    data=`echo -e &quot;ip:$ip\nloadavg/5min:$loadavg\tcacheuse%:$diskuse\tservice:$servrun&quot;`</span>
<span class="s">    diskper=`echo $diskuse|sed &#39;s/%//&#39;`</span>
<span class="s">    </span>
<span class="s">    num=`ps aux|grep check.sh|grep -v grep|wc -l`</span>
<span class="s">    </span>
<span class="s">    if [[ $num &gt; 2 ]];then</span>
<span class="s">        break 2</span>
<span class="s">    fi</span>
<span class="s">    </span>
<span class="s">    if [[ $loadavg &gt; 1.00 ]] &amp;amp;&amp;amp; [[ $diskper &gt; 90 ]];then</span>
<span class="s">        subject=&quot;warning-$ip-loadavg-disk&quot;</span>
<span class="s">        checkmail</span>
<span class="s">    else if [[ $loadavg &gt; 1.00 ]];then</span>
<span class="s">        subject=&quot;warning-$ip-loadavg&quot;</span>
<span class="s">        checkmail</span>
<span class="s">    else if [[ $diskper &gt; 90 ]];then</span>
<span class="s">        subject=&quot;warning-$ip-disk&quot;</span>
<span class="s">        checkmail</span>
<span class="s">    fi</span>
<span class="s">    sleep 60</span>
<span class="s">done</span>
<span class="s">EOF</span>
</code></pre></div>
<p>完成，执行sh check.sh &amp;&gt; /dev/null即可。报警邮件如下：</p>
<p>标题：warning-192.168.0.100-10.10.10.10-disk
ip:192.168.0.100-10.10.10.10
loadavg/5min:0.38 cacheuse%:94% service:nginx</p>
      <a href="/2010/03/03/an-alarm-shell-using-sendemail" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/03/02/loadbalance-in-nginx-using-url_hash" title="nginx负载均衡（url_hash）配置" rel="bookmark">nginx负载均衡（url_hash）配置</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-03-02 00:00:00 +0800">02 Mar 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>nginx是著名的非专职全七层负载均衡器，在用惯了四层LVS后，终于碰上了麻烦：LVS后端的4台RS磁盘都较小（20G），跑不到一天就塞满了东西；而根据预估，实际上一天时间该节点也就只有20G的文件增长。很显然，因为lvs转发的轮询算法，导致RS重复缓存了相同的文件。</p>
<p>针对这个情况，可以有两个办法（我只想到两个，欢迎大家补充）：</p>
<ol>
  <li>架构拆分，把不同的几个域名分别指向不同的server，这个在DNS上就能完成，不过就丧失了lvs的冗余；也可以用nginx的upstream+server配置，分别指向不通的RS，不过不同域名文件数量如果相差比较大的话，RS的负载就不均衡了……</li>
  <li>url_hash，采用HAproxy的loadbalance uri或者nginx的upstream_hash模块，都可以做到针对url进行哈希算法式的负载均衡转发。</li>
</ol>
<p>那么，就开始试试nginx的url_hash负载均衡吧：</p>
<ol>
  <li>安装部署：</li>
</ol>
<div class="highlight"><pre><code class="bash">wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.01.tar.gz
tar zxvf pcre-8.01.tar.gz
wget http://wiki.nginx.org/images/7/78/Nginx_upstream_hash-0.3.tar.gz
tar zxvf Nginx_upstream_hash-0.3.tar.gz
wget http://sysoev.ru/nginx/nginx-0.7.65.tar.gz
tar zxvf nginx-0.7.65.tar.gz
</code></pre></div>
<p>vi nginx-0.7.65/src/http/ngx_http_upstream.h</p>
<div class="highlight"><pre><code class="c"><span class="k">struct</span> <span class="n">ngx_http_upstream_srv_conf_s</span> <span class="p">{</span>
<span class="kt">ngx_http_upstream_peer_t</span><span class="err">        </span> <span class="n">peer</span><span class="p">;</span>
<span class="kt">void</span><span class="err">                          </span> <span class="o">**</span><span class="n">srv_conf</span><span class="p">;</span>
<span class="kt">ngx_array_t</span><span class="err">                    </span> <span class="o">*</span><span class="n">servers</span><span class="p">;</span><span class="err"> </span> <span class="cm">/* ngx_http_upstream_server_t */</span>
<span class="o">+</span><span class="kt">ngx_array_t</span><span class="err">                    </span> <span class="o">*</span><span class="n">values</span><span class="p">;</span>
<span class="o">+</span><span class="kt">ngx_array_t</span><span class="err">                    </span> <span class="o">*</span><span class="n">lengths</span><span class="p">;</span>
<span class="o">+</span><span class="kt">ngx_uint_t</span><span class="err">                      </span> <span class="n">retries</span><span class="p">;</span>
<span class="kt">ngx_uint_t</span><span class="err">                      </span> <span class="n">flags</span><span class="p">;</span>
<span class="kt">ngx_str_t</span><span class="err">                       </span> <span class="n">host</span><span class="p">;</span>
<span class="n">u_char</span><span class="err">                         </span> <span class="o">*</span><span class="n">file_name</span><span class="p">;</span>
<span class="kt">ngx_uint_t</span><span class="err">                      </span> <span class="n">line</span><span class="p">;</span>
<span class="kt">in_port_t</span><span class="err">                       </span> <span class="n">port</span><span class="p">;</span>
<span class="kt">in_port_t</span><span class="err">                       </span> <span class="n">default_port</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>为了安全，可以修改一下nginx的version信息：vi nginx-0.7.65/src/core/nginx.h</p>
<div class="highlight"><pre><code class="c"><span class="cp">#define NGINX_VERSION      &quot;2.6.STABLE21&quot;</span>
<span class="cp">#define NGINX_VER          &quot;squid/&quot; NGINX_VERSION</span>
</code></pre></div>
<p>vi nginx-0.7.65/src/http/ngx_http_header_filter_module.c</p>
<div class="highlight"><pre><code class="c"><span class="k">static</span> <span class="kt">char</span> <span class="n">ngx_http_server_string</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Server: squid/2.6.STABLE21&quot;</span> <span class="n">CRLF</span><span class="p">;</span>
</code></pre></div>
<p>vi nginx-0.7.65/src/http/ngx_http_special_response.c</p>
<div class="highlight"><pre><code class="c"><span class="k">static</span> <span class="n">u_char</span> <span class="n">ngx_http_error_tail</span><span class="p">[]</span> <span class="o">=</span>
<span class="s">&quot;&lt;hr&gt;&lt;center&gt;squid/2.6.STABLE21&lt;/center&gt;&quot;</span> <span class="n">CRLF</span>
<span class="s">&quot;&lt;/body&gt;&quot;</span> <span class="n">CRLF</span>
<span class="s">&quot;&lt;/html&gt;&quot;</span> <span class="n">CRLF</span>
</code></pre></div>
<div class="highlight"><pre><code class="bash"><span class="nb">cd </span>pcre-8.01
./configure --prefix<span class="o">=</span>/usr
make <span class="o">&amp;&amp;</span> make install
<span class="nb">cd </span>nginx-0.7.65
./configure --prefix<span class="o">=</span>/home/nginx  --with-pcre --with-http_stub_status_module --with-http_ssl_module --without-http_rewrite_module --add-module<span class="o">=</span>/tmp/nginx_upstream_hash-0.3
</code></pre></div>
<p>vi auto/cc/gcc</p>
<div class="highlight"><pre><code class="c"><span class="cp"># debug</span>
<span class="cp">#CFLAGS=&quot;$CFLAGS -g&quot;</span>
</code></pre></div>
<div class="highlight"><pre><code class="bash">make <span class="o">&amp;&amp;</span> make install
</code></pre></div>
<p>这样就安装完成了。</p>
<p>2、配置文件</p>
<div class="highlight"><pre><code class="nginx"><span class="k">upstream</span> <span class="s">images6.static.com</span> <span class="p">{</span>
    <span class="kn">server</span> <span class="n">11.11.11.11</span><span class="p">:</span><span class="mi">80</span><span class="p">;</span>
    <span class="kn">server</span> <span class="n">11.11.21.12</span><span class="p">:</span><span class="mi">80</span><span class="p">;</span>
    <span class="kn">server</span> <span class="n">11.11.21.13</span><span class="p">:</span><span class="mi">80</span><span class="p">;</span>
    <span class="kn">server</span> <span class="n">11.11.21.14</span><span class="p">:</span><span class="mi">80</span><span class="p">;</span>
    <span class="kn">hash   </span> <span class="nv">$request_uri</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen      </span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name </span> <span class="s">images6.static.com</span><span class="p">;</span>
    <span class="kn">access_log </span> <span class="s">/dev/null </span> <span class="s">main</span><span class="p">;</span>
    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">proxy_pass       </span>  <span class="s">http://images6.static.com</span><span class="p">;</span>
        <span class="kn">proxy_set_header  </span> <span class="s">Host            </span> <span class="nv">$host</span><span class="p">;</span>
        <span class="kn">proxy_set_header  </span> <span class="s">X-Real-IP       </span> <span class="nv">$remote_addr</span><span class="p">;</span>
        <span class="kn">proxy_set_header  </span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>以上配置的问题：</p>
<ol>
  <li>RS中不能设置nginx本机的其他端口，我本来设定的server 11.11.11.10:3128，希望能把nginx本机也开上squid，省出一台机器来。结果在确认配置了DNS的情况下，返回状态码全是503……</li>
  <li>RS一旦有宕机的，nginx不会重算hash，导致部分url返回错误信息；而启用hash_again标签的话，其他RS就都乱了。</li>
  <li>RS中默认logformat中将显示nginx的IP。</li>
</ol>
<p>解决办法：
1. 不知道
2. 不采用hash_again标签而采用error_page重定向到专门的备份服务器保障访问
3. 修改RS的logformat，把%&gt;a改成%{X-Real_IP}&gt;h即可。</p>
<p>最后的根本性问题：</p>
<p>对nginx下的RS集群进行增减操作，是否会对hash表产生影响？nginx_upstream_hash目录中的CHANGES有如下三条：</p>
<pre><code>Changes with upstream_hash 0.3                                   06 Aug 2008
*) Bugfix: infinite loop when retrying after a 404 and the "not_found" flag of *_next_upstream was set.
*) Change: no more "hash_method" directive. Hash method is always CRC-32.
*) Change: failover strategy is compatible with PECL Memcache.
</code></pre>
<p>nginx的wiki上，关于hash_again的doc这么写到：</p>
<pre><code>Number of times to rehash the value and choose a different server if the backend connection fails. Increase this number to provide high availability.
</code></pre>
<p>关于PECL Memcache，请参考下列链接：</p>
<p><a title="http://www.surfchen.org/archives/348" href="http://www.surfchen.org/archives/348">http://www.surfchen.org/archives/348</a>
<a href="http://tech.idv2.com/2008/07/24/memcached-004/">http://tech.idv2.com/2008/07/24/memcached-004/</a></p>
<p>尤其是第二个链接，其中关于rehash的解释，很好的解释了为什么大家都不推荐使用hash_again标签。
由此可知，upstream_hash模块，使用的是余数计算standard+CRC32方式，10+2的存活率是17%，3+1的存活率是23%！
而存活率最高的是consistent+CRC32方式，存活率是n/(n+m)*100%，10+2是83%，3+1是75%。</p>
<p>nginx的wiki中，还有另一个3rd模块upstream_consistent_hash，下回可以试试；
网上还有针对upstream_hash模块的补丁<a href="http://www.sanotes.net/wp-content/uploads/2009/06/nginx_upstream_hash.pdf">http://www.sanotes.net/wp-content/uploads/2009/06/nginx_upstream_hash.pdf</a>，好模块就是有人研究呀~~</p>
      <a href="/2010/03/02/loadbalance-in-nginx-using-url_hash" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/02/25/php-problem-of-wordpress-install" title="wordpress部署时碰到的php小问题~" rel="bookmark">wordpress部署时碰到的php小问题~</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-02-25 00:00:00 +0800">25 Feb 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>看到windows live writer也支持wordpress，感觉这个博客系统确实流行，决定自己也试一把~install时，出了点问题，选择好sqlname和user、passwd信息后，另存为wp-config.php，next生成管理账户和密码的页面，居然顶上出现了“Warning: Cannot modify header information - headers already sent by &hellip;”，无视之，记下随机密码，下一步login——彻底废了，整个页面都是这个warning提示~~</p>
<p>百度了一下这个问题，原因真是多种多样，php不支持UTF8的BOM、php的output_buffering没打开、php中setcookie的使用限制等等，不过我这是从wp自己的页面文本框里复制出来的东东，应该问题不大才对。结果回去一看，原来是最最简单的问题：<?php...?>后面，多了一个空行！！</p>
<p>ctrl+a后ctrl+c复制文本，一般都会多出来一个\r\n，insert进vi的时候自然也就多了一个空行，不巧的是，在include或者require的php里，如果首尾有空行的话，程序就很有可能出问题…………</p>
<p>del掉这个空行，退出刷新页面，OK！</p>
      <a href="/2010/02/25/php-problem-of-wordpress-install" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/02/25/memcached-install" title="memcached部署" rel="bookmark">memcached部署</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-02-25 00:00:00 +0800">25 Feb 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
<div class="highlight"><pre><code class="bash">wget http://www.monkey.org/~provos/libevent-1.4.13-stable.tar.gz
wget http://memcached.googlecode.com/files/memcached-1.4.4.tar.gz
wget http://pecl.php.net/get/memcache-2.2.5.tgz
tar zxvf libevent-1.4.13-stable.tar.gz
tar zxvf memcached-1.4.4.tar.gz
<span class="nb">cd </span>libevent-1.4.13-stable
./configure --prefix<span class="o">=</span>/usr
make
make install
ln -s /usr/lib/libevent-1.4.so.2 /usr/lib64/libevent-1.4.so.2
<span class="nb">cd </span>memcached-1.4.4
./configure --prefix<span class="o">=</span>/home/memcached --enable-64bit
make
make install
/home/memcached/bin/memcached -d -m 1024 -p 11211 -u root
</code></pre></div>
<p>参数说明：
    -d 启动为守护进程
    -m <num> 分配给Memcached使用的内存数量，单位是MB，默认为64MB
    -u <username> 运行Memcached的用户，仅当作为root运行时
    -l <ip_addr> 监听的服务器IP地址，默认为环境变量INDRR_ANY的值
    -p <num> 设置Memcached监听的端口，最好是1024以上的端口
    -c <num> 设置最大并发连接数，默认为1024
    -P <file> 设置保存Memcached的pid文件，与-d选择同时使用</file></num></num></ip_addr></username></num></p>
<div class="highlight"><pre><code class="bash"><span class="nb">cd </span>memcache-2.2.5
/home/php/bin/phpize
./configure --prefix<span class="o">=</span>/home/phpmemcache --with-php-config<span class="o">=</span>/home/php/bin/php-config
make
make install
sed –i ‘s:./:/home/php/lib/php/extensions/no-debug-zts-20060613/:g’ /home/php/lib/php.ini
sed –i ‘/zip.dll/aextension<span class="o">=</span>memcache.so’ /home/php/lib/php.ini
cat &gt;&gt; /cache/data/test.php <span class="s">&lt;&lt;EOF</span>
<span class="s">&lt;?php</span>
<span class="s">$memcache = new Memcache;</span>
<span class="s">/*$memcache-&gt;connect(&#39;localhost&#39;, 11211) or die (&quot;Could not connect&quot;);</span>
<span class="s">/*addServer方式更能体现分布式的优势，也完成故障转移，就是转移的时候HIT要重新开始*/</span>
<span class="s">$memcache-&gt;addServer(&#39;127.0.0.1&#39;, 11211);</span>
<span class="s">$memcache-&gt;addServer(&#39;192.168.0.2&#39;, 11212);</span>
<span class="s">$version = $memcache-&gt;getVersion();</span>
<span class="s">echo &quot;Server&#39;s version: &quot;.$version.&quot;&lt;br/&gt;n&quot;;</span>
<span class="s">$tmp_object = new stdClass;</span>
<span class="s">$tmp_object-&gt;str_attr = &#39;test&#39;;</span>
<span class="s">$tmp_object-&gt;int_attr = 123;</span>
<span class="s">$memcache-&gt;set(&#39;key&#39;, $tmp_object, false, 10) or die (&quot;Failed to save data at the server&quot;);</span>
<span class="s">echo &quot;Store data in the cache (data will expire in 10 seconds)&lt;br/&gt;n&quot;;</span>
<span class="s">$get_result = $memcache-&gt;get(&#39;key&#39;);</span>
<span class="s">echo &quot;Data from the cache:&lt;br/&gt;n&quot;;</span>
<span class="s">var_dump($get_result);</span>
<span class="s">?&gt;</span>
<span class="s">EOF</span>
</code></pre></div>
<div class="highlight"><pre><code class="bash">curl &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://localhost/test.php&quot;</span>&gt;http://localhost/test.ph&lt;/a&gt;
Server<span class="err">&#39;</span>s version: 1.4.4&lt;br/&gt;
Store data in the cache <span class="o">(</span>data will expire in 10 seconds<span class="o">)</span>&lt;br/&gt;
Data from the cache:&lt;br/&gt;
object<span class="o">(</span>stdClass<span class="o">)</span><span class="c">#3 (2) {</span>
<span class="o">[</span><span class="s2">&quot;str_attr&quot;</span><span class="o">]=</span>&gt;
string<span class="o">(</span>4<span class="o">)</span> <span class="s2">&quot;test&quot;</span>
<span class="o">[</span><span class="s2">&quot;int_attr&quot;</span><span class="o">]=</span>&gt;
int<span class="o">(</span>123<span class="o">)</span>
<span class="o">}</span>
<span class="c"># telnet localhost 11211</span>
</code></pre></div>
<pre><code>Trying 127.0.0.1...
Connected to localhost.localdomain (127.0.0.1).
Escape character is '^]'.
stats
STAT pid 3015
STAT uptime 3185                                 memcached运行的秒数
STAT time 1267090234
STAT version 1.4.4
STAT pointer_size 64
STAT rusage_user 0.000000
STAT rusage_system 0.000000
STAT curr_connections 10
STAT total_connections 18
STAT connection_structures 11
STAT cmd_get 3                                   查询缓存的次数
STAT cmd_set 5                                   设置key=&gt;value的次数
STAT cmd_flush 0
STAT get_hits 3                                    缓存命中的次数
STAT get_misses 0
STAT delete_misses 0
STAT delete_hits 0
STAT incr_misses 0
STAT incr_hits 0
STAT decr_misses 0
STAT decr_hits 0
STAT cas_misses 0
STAT cas_hits 0
STAT cas_badval 0
STAT auth_cmds 0
STAT auth_errors 0
STAT bytes_read 2697
STAT bytes_written 1150
STAT limit_maxbytes 1073741824
STAT accepting_conns 1
STAT listen_disabled_num 0
STAT threads 4
STAT conn_yields 0
STAT bytes 1255
STAT curr_items 2
STAT total_items 5
STAT evictions 0
END
</code></pre>
<p>完成~~~以上仅为试验，如果只是一个小web单机环境的话，只需要php+eaccelerator（或者apc/xcache等）就足够了。用php+memcached+mysql-proxy+mysql是大型网站架构的事情~~</p>
      <a href="/2010/02/25/memcached-install" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/02/24/cacti-install" title="cacti安装记录" rel="bookmark">cacti安装记录</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-02-24 00:00:00 +0800">24 Feb 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>cacti运行在lamp环境下，采用net-snmp获得监控数据，由rrdtool绘图。所以cacti的安装，主要就是apache、mysql、php、rrdtool、net-snmp这几个的安装。其中apache2是我们服务器上早就有的，可以利用；而原有的php5因为不支持mysql，所以要重新编译。</p>
<ol>
  <li>mysql安装：</li>
</ol>
<div class="highlight"><pre><code class="bash">wget http://mysql.cs.pu.edu.tw/Downloads/MySQL-5.1/mysql-5.1.44.tar.gz
tar zxvf mysql-5.1.44.tar.gz
<span class="nb">cd </span>mysql-5.1.44
groupadd mysql
useradd mysql -g mysql
./configure --prefix<span class="o">=</span>/home/mysql --with-unix-socket-path<span class="o">=</span>/tmp/mysql.sock --localstatedir<span class="o">=</span>/cache/mysql --enable-assembler --with-mysqld-ldflags<span class="o">=</span>-all-static --with-client-ldflags<span class="o">=</span>-all-static --with-extra-charsets<span class="o">=</span>gbk,gb2312,utf8 --enable-thread-safe-client --with-big-tables --enable-local-infile --with-ssl --with-mysqld-user<span class="o">=</span>mysql
make
make install
<span class="nb">cd </span>support-files/
cp my-medium.cnf /etc/my.cnf
cp mysql.server /etc/rc.d/init.d/mysqld
<span class="nb">cd</span> ../scripts/
./mysql_install_db --user<span class="o">=</span>mysql
mkdir –p /cache/mysql
chown -R mysql.mysql /cache/mysql/
chgrp -R mysql /home/mysql/
chmod 700 /etc/rc.d/init.d/mysqld
ln -s /etc/rc.d/init.d/mysqld /etc/rc.d/rc3.d/S97mysqld
chmod 777 /tmp/
/home/mysql/bin/mysqld_safe --user<span class="o">=</span>mysql &amp;amp;
ln –s /home/mysql/bin/* /usr/bin/
sed -i /^myisam/aset-variable<span class="o">=</span><span class="nv">wait_timeout</span><span class="o">=</span>200 /etc/my.cnf
sed -i /^myisam/aset-variable<span class="o">=</span><span class="nv">max_user_connections</span><span class="o">=</span>500 /etc/my.cnf
sed -i /^myisam/aset-variable<span class="o">=</span><span class="nv">max_connections</span><span class="o">=</span>1000 /etc/my.cnf
/etc/init.d/mysqld restart
</code></pre></div>
<ol>
  <li>php安装</li>
</ol>
<div class="highlight"><pre><code class="bash">wget http://cn.php.net/distributions/php-5.2.12.tar.gz
tar zxvf php-5.2.12.tar.gz
<span class="nb">cd </span>php-5.2.12
./configure --prefix<span class="o">=</span>/home/php --with-apxs2<span class="o">=</span>/home/apache2/bin/apxs --with-mysql<span class="o">=</span>/home/mysql --enable-sockets --with-zlib-dir<span class="o">=</span>/usr/include --with-gd --with-snmp --enable-ucd-snmp-hack --with-ttf --enable-mbstring --enable-xml --with-mysql-sock<span class="o">=</span>/tmp/mysql.sock
<span class="c"># (注：apache版本不同，--with-apxs2可能要写成--with-apxs)</span>
make
make install
cp php.ini-dist /home/php/lib/php.ini
ln -s /home/php/bin/* /usr/local/bin/
</code></pre></div>
<p>3、apache检测</p>
<div class="highlight"><pre><code class="bash"><span class="c"># grep php /home/apache2/conf/httpd.conf</span>
DirectoryIndex index.php index.html index.htm
AddType application/x-httpd-php .php
LoadModule php5_module        modules/libphp5.so
<span class="c"># /home/apache2/bin/apachectl configtest</span>
Syntax OK
<span class="c"># cat &gt;&gt; /cache/data/index.php &lt;&lt;EOF</span>
&lt;?php
phpinfo<span class="o">()</span>;
?&gt;
EOF
<span class="c"># curl http://localhost | grep module_mysql</span>
&lt;h2&gt;&lt;a <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;module_mysql&quot;</span>&gt;mysql&lt;/a&gt;&lt;/h2&gt;
</code></pre></div>
<p>4、rrdtool安装
麻烦东西来了，网上很多cacti部署教程，都在rrdtool上大费周章，因为这个东东依赖的库文件很多，而且自己本身的版本不同，库文件的种类和版本要求也不一样。首先，尽可能的把这些东西都安装吧：</p>
<pre><code>rpm -qa|grep lm_sensors
rpm -qa|grep beecrypt
rpm -qa|grep libpng
rpm -qa|grep elfutils
rpm -qa|grep sensors
rpm -qa|grep pixman
rpm -qa|grep freetype
rpm -qa|grep fontconfig
rpm -qa|grep net-snmp
rpm -qa|grep libart_lgpl
rpm -qa|grep zlib
rpm -qa|grep glib
rpm -qa|grep libxml2
rpm -qa|grep intltool
rpm -qa|grep cairo
rpm -qa|grep pango
</code></pre>
<h1 id="find--name-pangocairopccairopangocairopango">find / –name pangocairo.pc，如果没有，就要把cairo和pango重装了，务必先cairo后pango。</h1>
<p>如果以上齐全，可以去http://oss.oetiker.ch/rrdtool/pub/libs下载rrdtool的源码编译，然后按照make的warning信息慢慢调整库文件的相应版本号去了……</p>
<p>如果不要求自己成为编译达人，只求搞定的，那么按照如下办法，轻松搞定吧：</p>
<div class="highlight"><pre><code class="bash"><span class="c"># cat &gt; /etc/yum.repos.d/ct5_64.repo &lt;&lt;EOF</span>
<span class="o">[</span>base<span class="o">]</span>
<span class="nv">name</span><span class="o">=</span>CentOS-5.4 - Base
<span class="nv">baseurl</span><span class="o">=</span>http://mirrors.163.com/centos/5.4/os/x86_64/
<span class="nv">gpgcheck</span><span class="o">=</span>1
<span class="nv">gpgkey</span><span class="o">=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-5
EOF
<span class="c"># yum install ruby xorg-x11-fonts-Type1</span>
<span class="c"># cat &gt; /etc/yum.repos.d/ct5_64.repo &lt;&lt;EOF</span>
<span class="o">[</span>base<span class="o">]</span>
<span class="nv">name</span><span class="o">=</span>CentOS-5.4 – Base
<span class="nv">baseurl</span><span class="o">=</span>http://apt.sw.be/redhat/el<span class="nv">$releasever</span>/en/<span class="nv">$basearch</span>/dag
<span class="nv">gpgcheck</span><span class="o">=</span>1
<span class="nv">gpgkey</span><span class="o">=</span>http://dag.wieers.com/rpm/packages/RPM-GPG-KEY.dag.txt
<span class="nv">enabled</span><span class="o">=</span>1
EOF
<span class="c"># rpm --import &lt;a href=&quot;http://dag.wieers.com/rpm/packages/RPM-GPG-KEY.dag.txt&quot;&gt;http://dag.wieers.com/rpm/packages/RPM-GPG-KEY.dag.txt&lt;/a&gt;</span>
<span class="c"># yum install rrdtool</span>
</code></pre></div>
<p>（还嫌不够简单？那还有更简单的：
wget http://dag.wieers.com/rpm/packages/rpmforge-release/rpmforge-release-0.3.6-1.el5.rf.x86<em>64.rpm;rpm -Uvh rpmforge-release-0.3.6-1.el5.rf.x86</em>64.rpm;yum install rrdtool rrdtool-php即可）</p>
<p>5、cacti安装</p>
<div class="highlight"><pre><code class="bash"><span class="c"># wget http://www.cacti.net/downloads/cacti-0.8.7e.tar.gz</span>
<span class="c"># tar zxvf cacti-0.8.7e.tar.gz –C /cache/data/</span>
<span class="c"># mv /cache/data/cacti-0.8.7e /cache/data/cacti</span>
<span class="c"># cd /cache/data/cacti</span>
<span class="c"># mysql -uroot –p</span>
mysql&gt; create database cacti;
mysql&gt; grant all privileges on cacti.* to &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;mailto:cacti@&amp;quot;localhost&quot;</span>&gt;cacti@<span class="s2">&quot;localhost&lt;/a&gt;&quot;</span> identified by <span class="s1">&#39;123456&#39;</span>;
mysql&gt; flush privileges;
<span class="c"># /home/mysql/bin/mysql -ucacti -p cacti &lt; cacti.sql</span>
<span class="c"># useradd cacti -d /cache/data/cacti -s /bin/false</span>
<span class="c"># chown -R cacti rra</span>
<span class="c"># chown -R cacti log</span>
<span class="c"># sed –i &#39;s/username = &quot;cactiuser/username = &quot;cacti/&#39; include/config.php</span>
<span class="c"># sed –i &#39;s/password = &quot;cactiuser/password = &quot;123456/&#39; include/config.php</span>
<span class="c"># echo &#39;*/5 * * * * /home/php/bin/php /cache/data/cacti/poller.php &amp;amp;&gt; /dev/null&#39; &gt;&gt;/var/spool/cron/root</span>
</code></pre></div>
<p>6、web页面发布
在httpd.conf中发布</p>
<div class="highlight"><pre><code class="apache"><span class="nt">&lt;Directory</span> <span class="s">/cache/data</span><span class="nt">&gt;</span>
    <span class="nb">Options</span> Indexes FollowSymLinks
    <span class="nb">AllowOverride</span> <span class="k">None</span>
    <span class="nb">Order</span> Allow,Deny
    <span class="nb">Allow</span> from <span class="k">all</span>
<span class="nt">&lt;/Directory&gt;</span>
</code></pre></div>
<p>大功告成，接下来都是鼠标的事了，在browser中登陆http://yourdomian/cacti，按实际情况修改php/mysql/net-snmp的which和version信息，一路next即可，最后，cacti的初始用户名密码都是admin。</p>
      <a href="/2010/02/24/cacti-install" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/02/23/extend-shell-variables" title="shell变量扩展" rel="bookmark">shell变量扩展</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-02-23 00:00:00 +0800">23 Feb 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>第一种扩展形式，按长度截取：${PARAMETER:OFFSET:LENGTH}；例：</p>
<p>i=http://www.baidu.com/a/b.html;j=${i:1:10};echo $j
ttp://www.</p>
<p>第二种扩展形式，按模式截取：${PARAMETER#WORD}、${PARAMETER##WORD}、${PARAMETER%WORD}、${PARAMETER%%WORD}；例：</p>
<p>i=http://www.baidu.com/a/b.html;b=${i%/<em>};a=${i%%/</em>};c=${i#<em>/};d=${i##</em>/};echo $b;echo $c;echo $d;echo $a
http://www.baidu.com/a
/www.baidu.com/a/b.html
b.html
http:</p>
<p>第三种扩展形式，按模式替换：${PARAMETER/PATTERN/STRING};${PARAMETER//PATTERN/STRING}，例：</p>
<p>i=http://www.baidu.com/a/b.html;x=${i/baidu/google};y=${i//?a/xyz};echo $x;echo $y
http://www.google.com/a/b.html
http://www.xyzidu.comxyz/b.html</p>
<p>第四种扩展形式，指定默认值：${PARAMETER:-WORD}、${PARAMETER:+WORD}、${PARAMETER:?WORD}、${PARAMETER:=WORD}，例：</p>
<p>unset x;y=&rdquo;abc def&rdquo;; echo &ldquo;/${x:-&lsquo;XYZ&rsquo;}/${y:-&lsquo;XYZ&rsquo;}/$x/$y/&rdquo;
/&rsquo;XYZ&rsquo;/abc def//abc def/</p>
<p>unset x;y=&rdquo;abc def&rdquo;; echo &ldquo;/${x:=&rsquo;XYZ&rsquo;}/${y:=&rsquo;XYZ&rsquo;}/$x/$y/&rdquo;
/&rsquo;XYZ&rsquo;/abc def/&rsquo;XYZ&rsquo;/abc def/</p>
<p>( unset x;y=&rdquo;abc def&rdquo;; echo &ldquo;/${x:?&rsquo;XYZ&rsquo;}/${y:?&rsquo;XYZ&rsquo;}/$x/$y/&rdquo; )  &gt;so.txt 2&gt;se.txt
cat so.txt
cat se.txt
-bash: x: XYZ</p>
<p>unset x;y=&rdquo;abc def&rdquo;; echo &ldquo;/${x:+&rsquo;XYZ&rsquo;}/${y:+&rsquo;XYZ&rsquo;}/$x/$y/&rdquo;
//&rsquo;XYZ&rsquo;//abc def/</p>
<p>说明：-返回默认值，但不更改变量本身；=返回默认值同时更改变量为默认值；?返回默认值到标准错误；+与-相反。</p>
      <a href="/2010/02/23/extend-shell-variables" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/02/22/esi-cache" title="ESI 语言介绍" rel="bookmark">ESI 语言介绍</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-02-22 00:00:00 +0800">22 Feb 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>今天看到一个叫做 ESI 的东东，以此为线索，一路链接下去，颇为有趣，摘抄些新闻/博客段落来，算作长眼了：</p>
<p>首先是《CSDN09大会见闻》，其中提到康神的讲演《网站的那些事儿》，介绍了大规模网站架构上的种种工具和技术“比如做数据切分的 Mysql Proxy，分布式缓存的 MemoryCached，Web 服务器缓存的 Squid，页面优化的 Y!Slow，页面切分方面的 js 拼接和 iframe 拼接（呵呵，怪不得搜狐的页面都是 js 加载，对搜索引擎很不友好），前端服务器 Lighttpd, Squid3, ESI 等。也提到了架构设计中扩展性，可用性和一致性三者的关系，优化时应让让一致性延迟。提到目前网站系统一般都是三层结构 DB 层，逻辑层和前端层，而可扩展度方面DB &lt; 逻辑 &lt; 前端，原因就是有状态的最难扩展，无状态的最容易扩展，所以主张优化时尽量减少DB中存储的状态，将逻辑前移，最后总结优化的大方向就是：逻辑前移，善用缓存（无处不在的缓存）和数据冗余（方便查询）。”</p>
<p>从中得到几个信息——</p>
<ol>
  <li>搜狐的架构康神插手了；</li>
  <li>squid对ESI的支持限于3.0版本以上（这点很重要，因为其他任何地方都没写明）；</li>
  <li>缓存无处不在~~</li>
</ol>
<p>然后是ESI的概念原理。</p>
<p><strong>“ESI（Edge Side Include）通过使用简单的标记语言来对那些可以加速和不能加速的网页中的内容片断进行描述，每个网页都被划分成不同的小部分分别赋予不同的缓存控制策略，使Cache服务器可以根据这些策略在将完整的网页发送给用户之前将不同的小部分动态地组合在一起。通过这种控制，可以有效地减少从服务器抓取整个页面的次数，而只用从原服务器中提取少量的不能缓存的片断，因此可以有效降低原服务器的负载，同时提高用户访问的响应时间”</strong></p>
<p>从中得到几个信息——</p>
<ol>
  <li>ESI不是一门新语言，而只是嵌入在html里的一种标记，首先要求对网页进行模板式的规划，然后由支持ESI的cache服务器根据“HTTP请求标题或用户的cookie信息”自行组装返回给browser；</li>
  <li>我想到lighttpd和nginx的流媒体支持，也是根据cookie信息，获取拖拽的指定帧定位。不过没找到这两个对esi的cache处理文章，毕竟他们的主业还是webserver……</li>
</ol>
<p>然后是计算机世界网中关于ESI的介绍。内容较长，不贴了，要点如下：</p>
<ol>
  <li>ESI最多支持三级递归，可以在包含文档中再嵌套进一步ESI标记；</li>
  <li>ESI支持基于布尔比较或者环境变量的条件处理；</li>
  <li>ESI支持cgi环境变量，比如cookie；</li>
  <li>ESI支持开发者定制失败动作（这不就是我梦寐以求的东东？呵呵，夸张鸟~）</li>
  <li>ESI提供内容无效规范进行内容管理（cache的purge不再头疼？）；</li>
  <li>ESI是基于XML语言的，现有一个java的定制标签库JESI帮助生成jsp代码，这个东东我想是ESI标准被诸多寡头接受的重要原因，不然去哪找来一大批专门写ESI的设计员呢；</li>
  <li>ESI的主要开发和推动者，是CDN老大akaimai和DB老大oracle！！再次验证康神的话，Optimization=Cache+Data。</li>
</ol>
<p>最后，说一下squid3如何支持ESI。</p>
<p>./configure参数如下：</p>
<pre><code>--enable-esi           
Enable ESI for accelerators. Requires libexpat.
Enabling ESI will cause squid to follow the Edge
Acceleration Specification (www.esi.org). This
causes squid to IGNORE client Cache-Control headers.
DO NOT use this in a squid configured as a web
proxy, ONLY use it in a squid configured for
webserver acceleration.
</code></pre>
<p>squid.conf参数如下：</p>
<div class="highlight"><pre><code class="squid"><span class="w">    </span>httpd_accel_surrogate_id<span class="w"> </span>unset-id<span class="w"></span>
<span class="w">    </span>http_accel_surrogate_remote<span class="w"> </span><span class="no">on</span><span class="w"></span>
<span class="w">    </span>esi_parser<span class="w"> </span>custom<span class="w"></span>
</code></pre></div>
<p>写到最后郁闷了一下，这个东东，为了cache而发明出来了，却是得写在web上的。那我这篇博文，该归哪个类别呢？——或者这也验证了工作中的一点郁闷吧，cache的问题，经常出在web上，我们做CDN的，能怎么办呢？</p>
<p>ESI网站:</p>
<p><a href="http://www.akamai.com/html/support/esi.html">http://www.akamai.com/html/support/esi.html</a>
<a href="http://www.w3.org/TR/esi-lang">http://www.w3.org/TR/esi-lang</a></p>
<p><strong>2010年8月1日：</strong></p>
<h1 id="esi">ESI指令集</h1>
<h3 id="include-">include 标签</h3>
<p>首先尝试 include 页面 <code>1.html</code>，如果不存在就显示 <code>2.html</code>，如果还不存在，就忽略这条 esi</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;esi:include</span> <span class="na">src=</span><span class="s">&quot;http://example.com/1.html&quot;</span> <span class="na">alt=</span><span class="s">&quot;http://bak.example.com/2.html&quot;</span> <span class="na">onerror=</span><span class="s">&quot;continue&quot;</span><span class="nt">/&gt;</span>
</code></pre></div>
<h3 id="case-when-">case when 标签</h3>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;esi:choose&gt;</span> 
    <span class="nt">&lt;esi:when</span> <span class="na">test=</span><span class="s">&quot;$(HTTP_COOKIE{group})==&#39;Advanced&#39;&quot;</span><span class="nt">&gt;</span> 
        <span class="nt">&lt;esi:include</span> <span class="na">src=</span><span class="s">&quot;http://www.example.com/advanced.html&quot;</span><span class="nt">/&gt;</span> 
    <span class="nt">&lt;/esi:when&gt;</span> 
    <span class="nt">&lt;esi:when</span> <span class="na">test=</span><span class="s">&quot;$(HTTP_COOKIE{group})==&#39;Basic User&#39;&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;esi:include</span> <span class="na">src=</span><span class="s">&quot;http://www.example.com/basic.html&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/esi:when&gt;</span> 
    <span class="nt">&lt;esi:otherwise&gt;</span> 
        <span class="nt">&lt;esi:include</span> <span class="na">src=</span><span class="s">&quot;http://www.example.com/new_user.html&quot;</span><span class="nt">/&gt;</span> 
    <span class="nt">&lt;/esi:otherwise&gt;</span>
<span class="nt">&lt;/esi:choose&gt;</span>
</code></pre></div>
<h3 id="try-catch-">try catch 标签</h3>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;esi:try&gt;</span> 
    <span class="nt">&lt;esi:attempt&gt;</span>
        <span class="nt">&lt;esi:comment</span> <span class="na">text=</span><span class="s">&quot;Include an ad&quot;</span><span class="nt">/&gt;</span> 
        <span class="nt">&lt;esi:include</span> <span class="na">src=</span><span class="s">&quot;http://www.example.com/ad1.html&quot;</span><span class="nt">/&gt;</span> 
    <span class="nt">&lt;/esi:attempt&gt;</span>
    <span class="nt">&lt;esi:except&gt;</span> 
        <span class="nt">&lt;esi:comment</span> <span class="na">text=</span><span class="s">&quot;Just write some HTML instead&quot;</span><span class="nt">/&gt;</span> 
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">www.akamai.com</span><span class="nt">&gt;</span>www.example.com<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/esi:except&gt;</span> 
<span class="nt">&lt;/esi:try&gt;</span>
</code></pre></div>
<h3 id="remove-">remove 标签</h3>
<p>如果服务器可执行 ESI，就只执行 include；如果不可，只好识别标准的HTML</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;esi:include</span> <span class="na">src=</span><span class="s">&quot;http://www.example.com/ad.html&quot;</span><span class="nt">/&gt;</span> 
<span class="nt">&lt;esi:remove&gt;</span> 
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://www.example.com&quot;</span><span class="nt">&gt;</span>www.example.com<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/esi:remove&gt;</span>
</code></pre></div>
<h3 id="esi-1">esi变量</h3>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;esi:vars&gt;</span>
  <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;http://www.example.com/$(HTTP_COOKIE{type})/hello.gif&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/esi:vars&gt;</span>
</code></pre></div>
<p>变量都是从request-header中获得的，squid只支持标准的esi协议，即只识别下列header。</p>
<div class="highlight"><pre><code class="c"><span class="err">    </span><span class="n">addVariable</span> <span class="p">(</span><span class="s">&quot;HTTP_ACCEPT_LANGUAGE&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">new</span> <span class="n">ESIVariableLanguage</span><span class="p">);</span> 
<span class="err">    </span><span class="n">addVariable</span> <span class="p">(</span><span class="s">&quot;HTTP_COOKIE&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">new</span> <span class="n">ESIVariableCookie</span><span class="p">);</span> 
<span class="err">    </span><span class="n">addVariable</span> <span class="p">(</span><span class="s">&quot;HTTP_HOST&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">new</span> <span class="n">ESIVariableHost</span><span class="p">);</span> 
<span class="err">    </span><span class="n">addVariable</span> <span class="p">(</span><span class="s">&quot;HTTP_REFERER&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">new</span> <span class="n">ESIVariableReferer</span><span class="p">);</span> 
<span class="err">    </span><span class="n">addVariable</span> <span class="p">(</span><span class="s">&quot;HTTP_USER_AGENT&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">new</span> <span class="n">ESIVariableUserAgent</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">));</span> 
<span class="err">    </span><span class="n">addVariable</span> <span class="p">(</span><span class="s">&quot;QUERY_STRING&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">new</span> <span class="n">ESIVariableQuery</span><span class="p">(</span><span class="n">uri</span><span class="p">));</span> 
</code></pre></div>
<h3 id="section">逻辑表达式</h3>
<p><code>==</code>,<code>!=</code>,<code>&lt;</code>,<code>&gt;</code>,<code>&lt;=</code>,<code>&gt;=</code>,<code>!</code>,<code>&amp;</code>,<code>|</code>都只能用于表达式之间的关系，本身不具有真义，所以类似shell的(1 &amp; 2)是不成立的。</p>
<p>ESI必须由web端在response-header中声明Surrogate-Control: content=&rdquo;ESI/1.0&rdquo;。启用ESI后，Set-Cookie、Cache-Control、Last-Modified无效。</p>
      <a href="/2010/02/22/esi-cache" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/02/09/qhttpd" title="qhttpd" rel="bookmark">qhttpd</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-02-09 00:00:00 +0800">09 Feb 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#web-ref" title="web" rel="category tag">web</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>今天偷菜极不顺利，QQ空间老坏，看着那个Qhttpd的502提示页面就郁闷，决定自己也安一个看看。
<a href="http://www.qdecoder.org/qhttpd/download.qsp">http://www.qdecoder.org/qhttpd/download.qsp</a>
话说网上人都说QQ的视频服务器用的是qhttpd，Qzone用的是自己的qzhttpd呀。为啥农场的错误是qhttpd呢？
以上，过完年在说。呵呵
过年回来鸟~~去韩国下载了qhttpd来看，默认安装配置什么的，真的超级简单——功能也超级简单（连logformat都没有）。如果想要玩出花样来，好吧，从源代码开始，慢慢写C去吧~~~</p>
      <a href="/2010/02/09/qhttpd" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/02/09/intro-vary" title="cache驻留时间（七、Vary）" rel="bookmark">cache驻留时间（七、Vary）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-02-09 00:00:00 +0800">09 Feb 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前的系列文章，只涉及squid本身，今天突然想到，其实这个网站加速，除了squid缓存这种缩短传输距离的办法以外，还有另一个办法——压缩内容以缩短传输时间。
而糟糕的问题是，squid对压缩内容的缓存，限制多多。因为squid默认是以HTTP/1.0进行内容传输的，对HTTP/1.1协议兼容性不怎么滴~~一个不小心，browser就会接受到squid交给它的无法理解的内容，并忠实的把这个错乱信息显示给网民……然后你就等着客户投诉电话吧~~
这个具体的限制就是：squid只支持静态压缩，不支持动态压缩。反应到header上，就是rep_header里必须指明Content-length是多少多少，不能采用Transfer-Encoding: chunked这样的动态块格式；rep_header里必须指明Vary是Accept-Encoding，而不能是其他的User-Agent等等。</p>
<p>HTTP/1.1标准中，是建议所有的网页都加上vary头的。可见这个东东的重要性。</p>
<p>我不知道是不是有其他的缓存服务器能够支持vary值为user-agent，不过却在网上看到这么一句话：“如果依照除请求头以外的其他条件决定是否使用压缩(例如：HTTP版本)，你必须设置Vary头的值为&rdquo;*&ldquo;来完全阻止代理服务器的缓存”——我正好在今天看到一个客户的网站所有内容都加上了Vary: *，于是全部回源。。。</p>
<p>接下来，当源站把Content-Length和Accept-Encoding都设定好了，squid就万事大吉了么？嗯，理论上是的，不过最好还是检查一下配置文件，万一你前任或者同事在里头写了句“cache_vary off”，上面那些可就全做了无用功了……</p>
<p>检查完成，但看看分析结果，怎么缓存命中率还是不算高，访问速度还是不算快？（呃，你想要多高多快？）那，我这还有一招——隆重推出windtear的文章《[squid patch] 解决 Accept-Encoding不一致造成的多份缓存问题》，因为IE和FF在发出这个header的时候，其实内容是不一样的：</p>
<pre><code>IE : Accept-Encoding: gzip, deflate
FF : Accept-Encoding: gzip,deflate
</code></pre>
<p>注意到了么？IE的内容里多了一个空格！
感谢windtear这些已经深入squid源代码的大神们，把src/http.c相关部分修改如下，编译完成即可：</p>
<div class="highlight"><pre><code class="c"><span class="n">strListAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vstr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
<span class="n">hdr</span> <span class="o">=</span> <span class="n">httpHeaderGetByName</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">strBuf</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span><span class="err">    </span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;accept-encoding&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">rfc1738_escape_part</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="n">stringAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vstr</span><span class="p">,</span> <span class="s">&quot;=&quot;&quot;, 2);</span>
    <span class="n">stringAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vstr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
    <span class="n">stringAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vstr</span><span class="p">,</span> <span class="s">&quot;&quot;&quot;, 1);</span>
<span class="o">+</span><span class="err">    </span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="o">+</span> <span class="k">if</span><span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s">&quot;gzip&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">strstr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s">&quot;deflate&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>     <span class="n">stringAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vstr</span><span class="p">,</span> <span class="s">&quot;=&quot;</span><span class="n">gzip</span><span class="p">,</span><span class="o">%</span><span class="mi">20</span><span class="n">deflate</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>
<span class="o">+</span> <span class="p">}</span>
<span class="o">+</span><span class="err">    </span> <span class="p">}</span>
<span class="p">}</span>
<span class="o">+</span> <span class="n">safe_free</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="n">stringClean</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">safe_free</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">vary_hdr</span><span class="p">);</span>
</code></pre></div>
      <a href="/2010/02/09/intro-vary" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/02/06/squid-running-analysis" title="squid运行分析" rel="bookmark">squid运行分析</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-02-06 00:00:00 +0800">06 Feb 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上回编译加载tcmalloc后，效果各有不同，所以还得细分具体运行情况，以便之后继续优化。
之前的架构是1个lvs下挂6台leaf+1台parent。现在已经给7台squid都加载tcmalloc了。leaf运行上佳，CPU占用率甚至降到了2%，loadavg也不过0.2。但parent的CPU占用率虽然降低，loadavg却依然在1以上——这对于单核服务器来说，可不是什么好事。分析日志，或者用squidclient分析cache情况，leaf如下：
cat access.log |awk &lsquo;{if(/NONE/){a[NONE]++}}END{print a[NONE]/NR}&rsquo;
0.981347
squidclient -p 80 mgr:info
    Cache information for squid:
    Request Hit Ratios: 5min: 97.8%, 60min: 98.3%
    Byte Hit Ratios: 5min: 97.8%, 60min: 98.2%
    Request Memory Hit Ratios: 5min: 85.8%, 60min: 86.8%
    Request Disk Hit Ratios: 5min: 9.8%, 60min: 9.1%
    Storage Swap size: 19891740 KB
    Storage Mem size: 1048572 KB
    Mean Object Size: 9.67 KB
可以看到缓存文件的平均大小不足10KB，绝大多数的请求都在内存中处理掉了。所以在加载了优化内存反应速度的tcmalloc后，效果那么明显。
parent如下：
$ cat access.log |awk &lsquo;{if(/NONE/){a[NONE]++}}END{print a[NONE]/NR}&rsquo;
0.179209
$ squidclient -p 80 mgr:info
    Cache information for squid:
    Request Hit Ratios: 5min: 31.1%, 60min: 32.3%
    Byte Hit Ratios: 5min: 38.4%, 60min: 36.9%
    Request Memory Hit Ratios: 5min: 7.8%, 60min: 12.2%
    Request Disk Hit Ratios: 5min: 32.7%, 60min: 37.9%
    Storage Swap size: 40300232 KB
    Storage Mem size: 524284 KB
    Mean Object Size: 11.68 KB
只有30%的缓存命中，而且基本还都是从磁盘读取的（awk结果排除了REFRESH_HIT，所以更低）。难怪上次优化没什么效用了……
为了保证服务，先给这组服务器加上了round-robin的双parent。新parent的硬件情况和老的一样。而squid配置上，则采用了aufs方式，不再使用diskd方式。运行到现在30个小时，分析如下：
$ cat /cache/logs/access.log |awk &lsquo;{if(/NONE/){a[NONE]++}}END{print a[NONE]/NR}&rsquo;
0.238754
$ squidclient -p 80 mgr:info
    Cache information for squid:
    Request Hit Ratios: 5min: 22.7%, 60min: 22.8%
    Byte Hit Ratios: 5min: 22.9%, 60min: 20.1%
    Request Memory Hit Ratios: 5min: 22.2%, 60min: 24.3%
    Request Disk Hit Ratios: 5min: 64.4%, 60min: 65.0%
    Storage Swap size: 4640308 KB
    Storage Mem size: 1048588 KB
    Mean Object Size: 9.08 KB</p>
<p>看起来差不多的样子。
因为确认mem没怎么用上，下一步看disk的I/O。
采用diskd的parent如下：</p>
<pre><code>[root@tinysquid2 ~]# iostat -x /dev/xvdb2 5 5
Linux 2.6.18-128.el5xen (tinysquid2)
02/06/2010
avg-cpu: %user   %nice %system %iowait %steal   %idle
0.00 0.00 0.00 10.00 0.00   90.00
Device: rrqm/s wrqm/s r/s w/s rsec/s   wsec/s avgrq-sz avgqu-sz await  svctm  %util
xvdb2
0.00 5.00  8.60 46.60 81.60 412.80 8.96 0.32 5.80 1.75   9.68
</code></pre>
<p>采用aufs的parent如下：</p>
<pre><code>[root@tinysquid3 ~]# iostat -x /dev/xvdb2 5 5
Linux 2.6.18-128.el5xen (tinysquid3)
02/06/2010
avg-cpu: %user   %nice %system %iowait %steal   %idle
0.20 0.00 0.40 1.60 0.20   97.60
Device: rrqm/s wrqm/s r/s w/s rsec/s   wsec/s avgrq-sz avgqu-sz await  svctm  %util
xvdb2
0.00 8.58  3.19 6.19 25.55 118.16 15.32 0.02 2.47 1.70   1.60
</code></pre>
<p>以上结果的解释如下：</p>
<p>rrqm/s: 每秒进行 merge 的读操作数目。即 delta(rmerge)/s  <br />
wrqm/s: 每秒进行 merge 的写操作数目。即 delta(wmerge)/s  <br />
r/s: 每秒完成的读 I/O 设备次数。即 delta(rio)/s  <br />
w/s: 每秒完成的写 I/O 设备次数。即 delta(wio)/s  <br />
rsec/s: 每秒读扇区数。即 delta(rsect)/s  <br />
wsec/s: 每秒写扇区数。即 delta(wsect)/s  <br />
rkB/s: 每秒读K字节数。是 rsect/s 的一半，因为每扇区大小为512字节。(需要计算)  <br />
wkB/s: 每秒写K字节数。是 wsect/s 的一半。(需要计算)  <br />
avgrq-sz: 平均每次设备I/O操作的数据大小(扇区)。delta(rsect+wsect)/delta(rio+wio)  <br />
avgqu-sz: 平均I/O队列长度。即 delta(aveq)/s/1000(因为aveq的单位为毫秒)。  <br />
await: 平均每次设备I/O操作的等待时间 (毫秒)。即delta(ruse+wuse)/delta(rio+wio)  <br />
svctm: 平均每次设备I/O操作的服务时间 (毫秒)。即 delta(use)/delta(rio+wio)  <br />
%util: 一秒中有百分之多少的时间用于 I/O 操作，或者说一秒中有多少时间 I/O 队列是非空的。即 delta(use)/s/1000(因为use的单位为毫秒)    </p>
<p>从上面的运行情况看，都是w操作为主，但diskd比aufs每秒w的次数要大，而每次w的服务时间也大——大的同时波动性也不太稳定——由此导致rw时的等待时间也延长——进一步的结果就是I/O非空时间变少——最后的结果就是disk的I/O压力变大！
因为现在已经双parent，loadavg降低，所以不好看出之前的高loadavg问题关键。不过至少从现在的运行来看，aufs比diskd要好。</p>
<p>————————————————————————————————————————
3月25日补充：</p>
<p>aufs虽然是异步io，但某些文件默认的写操作并不如此。需要在编译时修改src/fs/aufs/store_asyncufs.h中的#define ASYNC_WRIT值为1。
对于aufs，可以使用squidclient mgr:squidaio_counts查看，其中queue一项，据说不应该超过线程数量的5倍。而线程数量跟cache_dir数量的关系如下：</p>
<p>cache_dirs Threads
1               16
2               26
3               32
4               36
5               40
6               44</p>
      <a href="/2010/02/06/squid-running-analysis" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/02/06/conntrack-of-netfilter" title="netfilter的conntrack优化" rel="bookmark">netfilter的conntrack优化</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-02-06 00:00:00 +0800">06 Feb 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p><a href="http://www.wallfire.org/misc/netfilter_conntrack_perf.txt">参考原文</a>
<a href="http://www.linuxmine.com/5791.html">中文版</a>
说是zz，好歹也是自己看完以后的zz，所以组织语言次序都是自己来：
首先解释两个概念性的名词</p>
<p>conntrack最大数量.叫做conntrack_max
存储这些conntrack的hash表的大小,叫做hashsize
hash表存在于固定的的不可swap的内存中.
conntrack_mark决定占用多少这些不可swap的内存
hashsize=conntrack_max/8=ramsize(in bytes)/131072/(x/32)
x表示使用的指针类型是(32位还是64的)</p>
<p>读取conntrack_max值
cat /proc/sys/net/ipv4/ip_conntrack_max</p>
<p>读取hashsize值
cat /proc/sys/net/ipv4/netfilter/ip_conntrack_buckets</p>
<p>ip_conntrack buffer使用情况
grep conn /proc/slabinfo</p>
<p>文章提出的sysctl参数修改：</p>
<div class="highlight"><pre><code class="bash"><span class="c">#允许TCP/UDP打开的本地端口范围</span>
<span class="nb">echo</span> <span class="s2">&quot;1024 65000&quot;</span> &gt; /proc/sys/net/ipv4/ip_local_port_range
<span class="c">#内存脏数据回收参数，2.6内核中没有……</span>
<span class="nb">echo</span> <span class="s2">&quot;100 1200 128 512 15 5000 500 1884 2&quot;</span>&gt;/proc/sys/vm/bdflush
<span class="c">#禁止ICMP ECHO响应</span>
<span class="nb">echo</span> <span class="s2">&quot;1&quot;</span> &gt; /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts
<span class="c">#记录伪装广播帧响应日志</span>
<span class="nb">echo</span> <span class="s2">&quot;1&quot;</span> &gt; /proc/sys/net/ipv4/icmp_ignore_bogus_error_responses
<span class="c">#允许转发</span>
<span class="nb">echo</span> <span class="s2">&quot;1&quot;</span> &gt; /proc/sys/net/ipv4/ip_forward
<span class="c">#可用的共享内存总量(bytes)</span>
<span class="nb">echo</span> <span class="s2">&quot;268435456&quot;</span> &gt;/proc/sys/kernel/shmall
<span class="c">#内核允许的最大共享内存段大小(bytes)</span>
<span class="nb">echo</span> <span class="s2">&quot;536870912&quot;</span> &gt;/proc/sys/kernel/shmmax
<span class="c">#链接跟踪库允许的最大值</span>
<span class="nb">echo</span> <span class="s2">&quot;1048576&quot;</span> &gt; /proc/sys/net/ipv4/netfilter/ip_conntrack_max
<span class="c">#TCP链接established状态的超时时间，同理，还有wait/close/last_ack等的超时时间设定</span>
<span class="nb">echo</span> <span class="s2">&quot;600&quot;</span> &gt; /proc/sys/net/ipv4/netfilter/ip_conntrack_tcp_timeout_established
<span class="c">#决定检查一次相邻层记录的有效性的周期</span>
<span class="nb">echo</span> <span class="s2">&quot;240&quot;</span> &gt; /proc/sys/net/ipv4/neigh/default/gc_stale_time
<span class="c">#存在于ARP高速缓存中的最少层数，如果少于这个数，垃圾收集器将不会运行</span>
<span class="nb">echo</span> <span class="s2">&quot;1024&quot;</span> &gt; /proc/sys/net/ipv4/neigh/default/gc_thresh1
<span class="c">#保存在 ARP 高速缓存中的最多的记录软限制。垃圾收集器在开始收集前，允许记录数超过这个数字 5 秒</span>
<span class="nb">echo</span> <span class="s2">&quot;2048&quot;</span> &gt; /proc/sys/net/ipv4/neigh/default/gc_thresh2
<span class="c">#保存在 ARP 高速缓存中的最多记录的硬限制，一旦高速缓存中的数目高于此，垃圾收集器将马上运行</span>
<span class="nb">echo</span> <span class="s2">&quot;4096&quot;</span> &gt; /proc/sys/net/ipv4/neigh/default/gc_thresh3
<span class="c">#路由缓存最大值</span>
<span class="nb">echo</span> <span class="s2">&quot;52428800&quot;</span> &gt; /proc/sys/net/ipv4/route/max_size
<span class="c">#允许中继网络中的arp包</span>
<span class="nb">echo</span> <span class="s2">&quot;1&quot;</span> &gt; /proc/sys/net/ipv4/conf/all/proxy_arp
<span class="c">#TCP/IP会话的滑动窗口大小可变</span>
<span class="nb">echo</span> <span class="s2">&quot;1&quot;</span> &gt; /proc/sys/net/ipv4/tcp_window_scaling
</code></pre></div>
<p>最直接看到的两个调整，就是ip_conntrack_max和ip_conntrack_tcp_timeout_established了。
而gc_*四个参数，是修改内核维护ARP表的参数，当arp -an|wc -l大于300的话，就需要修改这些参数，不然会出现“neighbour table overflow”或者“kernel: printk: 24 messages suppressed”这样的syslog，导致服务器ssh、ping无响应！</p>
      <a href="/2010/02/06/conntrack-of-netfilter" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/02/04/performance-optimization-test-of-tcmalloc-loaded-by-squid-3" title="squid加载tcmalloc性能优化测试(编译)" rel="bookmark">squid加载tcmalloc性能优化测试(编译)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-02-04 00:00:00 +0800">04 Feb 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>话接上文，同一组LVS下，昨天采用重编译方式部署了另一台squid服务器。同样跑上一天，再次对比一番。今天流量比上回稍微少些，未加载的服务器cacti监控截图如下：
<img src="/images/uploads/62d80b5eh73140310b076690.jpg" alt="" title="cpu" width="573" height="259" class="alignnone size-full wp-image-2565" />
CPU占用率
=====================
<img src="/images/uploads/62d80b5eh73140316c9a2690.jpg" alt="" title="loadavg" width="569" height="254" class="alignnone size-full wp-image-2567" />
负载</p>
<hr />
<p>同时，重编译过后的squid服务器监控截图如下：
<img src="/images/uploads/62d80b5eh7314031cd5b3690.jpg" alt="" title="cpu-new" width="572" height="261" class="alignnone size-full wp-image-2568" />
CPU占用率（那个尖峰是我运行了一下lsof确认是否加载，lsof这个命令真是大杀器，少用……）
=====================
<img src="/images/uploads/62d80b5eh731403230ce5690.jpg" alt="" title="loadavg-new" width="570" height="258" class="alignnone size-full wp-image-2569" />
负载</p>
<p>这么一对比，效果马上就出来了。难怪官方建议要用编译加载的方式呢~~~</p>
      <a href="/2010/02/04/performance-optimization-test-of-tcmalloc-loaded-by-squid-3" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/02/01/performance-optimization-test-of-tcmalloc-loaded-by-squid-2" title="squid加载tcmalloc性能优化测试(动态)" rel="bookmark">squid加载tcmalloc性能优化测试(动态)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-02-01 00:00:00 +0800">01 Feb 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>昨天下午在一台squid上加载了tcmalloc。运行到现在，整整一天时间。现取LVS下与其完全相同配置的另一台未加载tcmalloc的squid服务器进行比较。
环境说明：
CPUinfo：Intel(R) Xeon(R) CPU  E5405  @ 2.00GHz
MEM：4G
SQUID：Version 2.6.STABLE21
当单台流量20M，TCP连接数6w时，未加载tcmalloc的服务器CPU占用率和负载情况如下图：
<img src="/images/uploads/62d80b5eh730dca4ebd76690.jpg" alt="" title="cpu%" width="572" height="263" class="alignnone size-full wp-image-2559" />
CPU占用率
<img src="/images/uploads/62d80b5eh730dca57d6ee690.jpg" alt="" title="loadavg" width="575" height="257" class="alignnone size-full wp-image-2561" />
负载</p>
<hr />
<p>而同时，加载了tcmalloc的服务器CPU占用率和负载情况如下图：
<img src="/images/uploads/62d80b5eh730dca5f8985690.jpg" alt="" title="cpu%-new" width="577" height="263" class="alignnone size-full wp-image-2562" />
CPU占用率
<img src="/images/uploads/62d80b5eh730dca671bb7690.jpg" alt="" title="loadavg-new" width="579" height="259" class="alignnone size-full wp-image-2563" />
负载（上一个尖峰就是我加载tcmalloc的时候）</p>
<p>从图中来看，加载tcmalloc，确实对squid处理高并发小图片请求有一定的性能优化帮助，但其本身对系统资源又有一定的耗用，导致负载反而略微提高（CPU占用率中sys也变高了）。而在并发量不大的时候，加载tcmalloc占用的CPU资源在图中也有显现。</p>
<p>或许这就是官方不建议采用动态加载方式的原因？下一步试验，采用重编译方式测试。</p>
      <a href="/2010/02/01/performance-optimization-test-of-tcmalloc-loaded-by-squid-2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/31/third-party-tools-about-squid" title="squid几个第三方工具" rel="bookmark">squid几个第三方工具</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-31 00:00:00 +0800">31 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p><a href="http://gadmintools.flippedweb.com/index.php?option=com_content&amp;task=view&amp;id=47&amp;Itemid=37#Download">GADMIN-SQUID</a> 在linux环境下运行，经本人下载src后看，只能用于本机squid管理，不支持批量……</p>
<p><a href="http://www.zerozone.it/Software/Linux/SquidTL/">SQUIDTL</a> 针对IP、domain进行访问时长控制，C语言编写，需配合MySQL，好复杂的架构……</p>
<p><a href="http://sourceforge.net/projects/squidmodel/">SQUIDMODEL</a> java平台，俺还没搞定，未知其所以然</p>
<p><a href="http://cachevideos.com">CACHEVIDEO</a> 专门针对yotube等网站的视频文件缓存开发的rewrite_program，python编写。可惜是要花钱滴~~</p>
      <a href="/2010/01/31/third-party-tools-about-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/31/performance-optimization-test-of-tcmalloc-loaded-by-squid-1" title="squid加载tcmalloc性能优化测试(原理)" rel="bookmark">squid加载tcmalloc性能优化测试(原理)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-31 00:00:00 +0800">31 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>TCMalloc（Thread-Caching Malloc）是google开发的开源工具──“<a href="http://code.google.com/p/google-perftools/" title="google-perftools">google-perftools</a>”中的成员。其作者宣称tcmalloc相对于glibc2.3 malloc(aka-ptmalloc2)在内存的分配上效率和速度有6倍的性能提高，tcmalloc的常用场景是用于加速MySQL，不过据Wikipedia的hacker（Domas Mituzas）说，tcmalloc不仅仅对MySQL起作用，对squid也同样起作用（网上也有很多人在nginx上启用tcmalloc了），不过目前squid并没有official way来使用tcmalloc。
TCMalloc的实现原理和测试报告请见一篇文章：《<a href="http://shiningray.cn/tcmalloc-thread-caching-malloc.html">TCMalloc：线程缓存的Malloc</a>》
那么让我们赶紧给squid加载上tcmalloc，提高cache服务器在高并发情况下的性能，降低系统负载吧。
因为服务器是64位OS，所以要先安装libunwind库。libunwind库为基于64位CPU和操作系统的程序提供了基本的堆栈辗转开解功能，其中包括用于输出堆栈跟踪的API、用于以编程方式辗转开解堆栈的API以及支持C++异常处理机制的API。（又cp一句话，^=^）</p>
<div class="highlight"><pre><code class="bash">wget http://download.savannah.gnu.org/releases/libunwind/libunwind-0.99.tar.gz
tar zxvf libunwind-0.99.tar.gz
<span class="nb">cd </span>libunwind-0.99/
<span class="nv">CFLAGS</span><span class="o">=</span>-fPIC ./configure
make <span class="nv">CFLAGS</span><span class="o">=</span>-fPIC
make <span class="nv">CFLAGS</span><span class="o">=</span>-fPIC install
</code></pre></div>
<p>普通的./configure&amp;&amp;make&amp;&amp;make install可不行哟~
然后开始安装tcmalloc:</p>
<div class="highlight"><pre><code class="bash">wget http://google-perftools.googlecode.com/files/google-perftools-1.8.1.tar.gz
tar zxvf google-perftools-1.8.1.tar.gz
<span class="nb">cd </span>google-perftools-1.8.1/
./configure --disable-cpu-profiler --disable-heap-profiler --disable-heap-checker --enable-minimal --disable-dependency-tracking
make <span class="o">&amp;&amp;</span> make install
</code></pre></div>
<p>然后配置动态链接库，因为是之前是默认安装，这里自然就是/usr/local/lib了。</p>
<div class="highlight"><pre><code class="bash"><span class="nb">echo</span> <span class="s2">&quot;/usr/local/lib&quot;</span> &gt; /etc/ld.so.conf.d/usr_local_lib.conf
/sbin/ldconfig
</code></pre></div>
<p>然后给squid加载tcmalloc。官方推荐是重新编译：
先./configure，然后vi src/Makefile，修改如下：</p>
<div class="highlight"><pre><code class="c"><span class="p">....</span>
<span class="n">squid_LDADD</span> <span class="o">=</span>
<span class="o">-</span><span class="n">L</span><span class="p">..</span><span class="o">/</span><span class="n">lib</span> \
<span class="o">-</span><span class="n">ltcmalloc_minimal</span> \
\
<span class="n">repl</span><span class="o">/</span><span class="n">libheap</span><span class="p">.</span><span class="n">a</span> <span class="n">repl</span><span class="o">/</span><span class="n">liblru</span><span class="p">.</span><span class="n">a</span> \
<span class="p">....</span>
<span class="p">....</span>
<span class="n">data_DATA</span> <span class="o">=</span>
<span class="n">mib</span><span class="p">.</span><span class="n">txt</span>
<span class="n">LDADD</span>
<span class="o">=</span> <span class="o">-</span><span class="n">L</span><span class="p">..</span><span class="o">/</span><span class="n">lib</span> <span class="o">-</span><span class="n">lmiscutil</span> <span class="o">-</span><span class="n">lpthread</span> <span class="o">-</span><span class="n">lm</span> <span class="o">-</span><span class="n">lbsd</span> <span class="o">-</span><span class="n">lnsl</span> <span class="o">-</span><span class="n">ltcmalloc_minimal</span>
<span class="n">EXTRA_DIST</span> <span class="o">=</span>
<span class="p">....</span>
</code></pre></div>
<p>保存，make&amp;&amp;make install，OK！
如果不愿意重新编译，那么动态加载吧。在/home/squid/sbin/squid -s之前执行export
LD_PRELOAD=/usr/local/lib/libtcmalloc_minimal.so就可以了。
最后运行lsof -n | grep tcmalloc看看，如果有
squid 3811   root mem REG 202,1 1364560 446102 /usr/local/lib/libtcmalloc.so.0.0.0
squid 3813  squid mem REG 202,1 1364560 446102 /usr/local/lib/libtcmalloc.so.0.0.0
这样的输出，加载成功。效果如何，跑上几天再说咯~
另：
据网上说，如果squid的configure参数中，有&ndash;with-large-files的话，是没法加载tcmalloc的。</p>
      <a href="/2010/01/31/performance-optimization-test-of-tcmalloc-loaded-by-squid-1" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/31/intro-header_replace" title="header_replace试验" rel="bookmark">header_replace试验</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-31 00:00:00 +0800">31 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在linuxtone论坛上，偶见一贴，说采用如下配置，browser就可以正常遵守originserver的过期设置，而且充分利用browser本身的缓存设置，对server来说就可以达到减少304请求的效果，从而提升机器性能，节省带宽云云……</p>
<p>header_access Age deny all
header_replace Age 1</p>
<p>这样reqly_header就显示成：Cache-Control: max-age=1。
（让我很郁闷的一点是squid.conf.default里提供的header_access配置条目不全……）</p>
<p>从之前的cache驻留时间系列里知道，在HTTP的header里，max-age的优先级别高于Expires[Cache-Control&gt;Expires&gt;refresh_pattern&gt;Etag&gt;Last-Modified]。如果这里把max-age改了，那哪里还有地方去控制过期呢？</p>
<p>我想，帖子里估计是写错了，试验一下，果然，其实修改后的header应该是：Age: 1。</p>
<p>这种情况，应该是为了防止Cache-Control: max-age=0的定义导致304的出现（网上看到过一个试验结果，squid最多最多能接受的刷新极限是64秒，我汗，这都有人测试~~）</p>
<p>既然Age永远到不了max-age的限定，自然max-age定义失效了；</p>
<p>接下来试验，refresh_pattern里的max和LM-fator算法是否起作用。结果让我很无语——
配置如右：refresh_pattern .gif$ 2 5% 5 ignore-reload</p>
<p>Date: Sun, 31 Jan 2010 10:32:45 GMT
Last-Modified: Mon, 17 Nov 2008 06:53:22 GMT</p>
<p>LM-fator过期时间应该是(10:32-6:53)*5%=11分钟。max为5分钟。
直到18:50:41还是HIT，Age=1，过期设定失效！</p>
<p>于是我取消http_replace和refresh配置生效后，18:53:15再wget，结果依然HIT，Age=155！</p>
<p>可见，之前LM-fator算法中的说法不完整，squid并不是单按照Date和Last-Modified时间就强制过期，它还得根据Age去判定——这点帖子倒是说对了，完全交给源站控制——问题在于，源站的运维如果真能策划好了这个，又何必让CDN在前端折腾这个age呢？鸡肋呀~~</p>
<hr />
<p>UPDATE：
今天有几个客户切去快网，我在测试时发现，Age就是都被改成了1。除了源站的定义以外，或者快网自认为其提供的刷新API功能很好很强大？？</p>
      <a href="/2010/01/31/intro-header_replace" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/31/anti-hotlinking-by-external_acl" title="防盗链二进阶（squid外部ACL）" rel="bookmark">防盗链二进阶（squid外部ACL）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-31 00:00:00 +0800">31 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>服务器防盗链设置，从最简单的referer判断，到进阶的key+time生成md5值，应该说是比较可靠了，而还有一种防盗链方式，基于IP/COOKIE的，这个我没找到太多有用信息，似乎IIS有个相关插件？
只看到一篇squid的相关文章，简单的举了个防盗链的例子，未必有效（因为把cookie做明文处理，相比md5加密实在是防君子不防小人）。倒是从中学习一下external_acl_type用法，对squid进阶一番罢~~
首先按惯例，上权威：《squid中文权威指南》6.1.3章节和12.5章节。
用法如下：
external_acl_type name [options] FORMAT.. /path/to/helper
[helper arguments..]
options包括：ttl、negtive_ttl、children、concurrency、cache和grace；
FORMAT包括：%LOGIN,%EXT_USER,%IDENT,%SRC,%SRCPORT,%DST,%PROTO,%PORT,%METHOD,%MYADDR,%MYPORT,%PATH,%USER_CERT,%USER_CERTCHAIN,%USER_CERT_xx,%USER_CA_xx,%{Header},%{Hdr:member},%{Hdr:;member},%ACL,%DATA。
外部程序输出结果必须是OK或者ERR，不过可以再带上一些keyword，比如user/passwd，ERR的messages，access.log里记录的%ea等等。
cookie防盗链举例squid/libexec/check_cookie.pl如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="c1"># 这个脚本仅仅是验证了Cache这个cookie的存在，没有严格的校验其值。</span>
<span class="c1"># disable output buffering</span>
<span class="vg">$|</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="k">while</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nb">chop</span><span class="p">;</span>
    <span class="nv">$cookie</span><span class="o">=</span><span class="nv">$_</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="nv">$cookie</span> <span class="o">=~</span><span class="sr"> /$COOKIE/i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s">&quot;OK\n&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s">&quot;ERR\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>squid.conf配置如下：</p>
<div class="highlight"><pre><code class="squid">external_acl_type<span class="w"> </span>download<span class="w"> </span><span class="no">children</span>=15<span class="w"> </span>%{Cookie}<span class="w"> </span>squid/libexec/check_cookie.pl<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>dl<span class="w"> </span>external<span class="w"> </span>download<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>filetype<span class="w"> </span><span class="k">url_regex</span><span class="w"> </span>-i<span class="w"> </span>.wmv<span class="w"> </span>.wma<span class="w"> </span>.asf<span class="w"> </span>.asx<span class="w"> </span>.avi<span class="w"> </span>.mp3<span class="w"> </span>.smi<span class="w"> </span>.rm<span class="w"> </span>.ram<span class="w"> </span>.rmvb<span class="w"> </span>.swf<span class="w"> </span>.mpg<span class="w"> </span>.mpeg<span class="w"> </span>.mov<span class="w"> </span>.zip<span class="w"> </span>.mid<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">deny</span><span class="w"> </span>filetype<span class="w"> </span>!dl<span class="w"></span>
</code></pre></div>
<p>回过头来，想到之前的squid_session一文中，也是用的这个外部ACL~~</p>
      <a href="/2010/01/31/anti-hotlinking-by-external_acl" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/30/solution-of-linuxqq-die-on-ubuntu-9-10" title="ubuntu 9.10下linuxqq经常挂掉的解决方案" rel="bookmark">ubuntu 9.10下linuxqq经常挂掉的解决方案</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-30 00:00:00 +0800">30 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>ubuntu 9.10下linuxqq（官方的QQ，八百年不更新的那个了）</p>
<p>sudo vim /usr/bin/qq
增加</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/sh</span>
<span class="nb">export </span><span class="nv">GDK_NATIVE_WINDOWS</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">cd</span> /usr/share/tencent/qq/
./qq
</code></pre></div>
<p>经试验正确无误。。。linuxqq不再挂。。。五四陈科学院小道报道</p>
<p>原创文章如转载，请注明：转载自五四陈科学院[<a href="http://www.54chen.com]/">http://www.54chen.com]</a>
本文链接: 
<a href="http://www.54chen.com/uncategorized/ubuntu-910-hangs-under-linuxqq-regular-solution.html">http://www.54chen.com/uncategorized/ubuntu-910-hangs-under-linuxqq-regular-solution.html</a></p>
      <a href="/2010/01/30/solution-of-linuxqq-die-on-ubuntu-9-10" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/30/limit-speed-in-nginx-lighttpd" title="限速进阶" rel="bookmark">限速进阶</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-30 00:00:00 +0800">30 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>继续横向比较，之前有squid的限速配置，现在说nginx限速，nginx关于限速的模块有三个：HTTPLimitZoneModule、HTTPCoreModule和HTTPLimitReqModule，详见官方wiki，就不再贴链接了，能不能上天知道，真是地上芙蓉姐，天上绿坝娘呀……</p>
<h1 id="limitzone">limit_zone配置</h1>
<div class="highlight"><pre><code class="nginx"><span class="k">http</span> <span class="p">{</span>
    <span class="kn">limit_zone</span> <span class="no">on</span><span class="s">e</span> <span class="nv">$binary_remote_addr</span> <span class="mi">10m</span><span class="p">;</span> <span class="c1">#每个clientIP定义一个10m大的session容器，根据32bytes/session，可以处理320000个session；</span>
    <span class="kn">server</span> <span class="p">{</span>
        <span class="kn">location</span> <span class="s">/download/</span> <span class="p">{</span>
            <span class="kn">limit_conn</span> <span class="no">on</span><span class="s">e</span> <span class="mi">1</span><span class="p">;</span><span class="c1">#限制一个IP并发连接数为1；</span>
            <span class="kn">limit_rate</span> <span class="mi">300k</span><span class="p">;</span><span class="c1">#限制每个连接数速率为300k；</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>目前网上的情况来看，zone方式的限速用的比较多，或许是较早的版本就支持这个模块吧。</p>
<h1 id="limitreq">limit_req配置</h1>
<div class="highlight"><pre><code class="nginx"><span class="k">http</span> <span class="p">{</span>
    <span class="kn">limit_req_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=one:10m</span> <span class="s">rate=1r/s</span><span class="p">;</span><span class="c1">#限制速率</span>
    <span class="kn">server</span> <span class="p">{</span>
        <span class="kn">location</span> <span class="s">/search/</span> <span class="p">{</span>
            <span class="kn">limit_req</span> <span class="s">zone=one </span> <span class="s">burst=5</span><span class="p">;</span><span class="c1">#限制并发处理数</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>这个模块是nginx0.7.22以后加上的，目前网上基本没什么实际说明，单就这个定义方式来看，感觉和之前的方式也没什么区别，a*b=c，一个定义a和b，一个定义b和c……
或许只能去wiki死磕英文才能搞清楚一点点吧~~</p>
<p>然后是lighttpd的限速：</p>
<p>lighttpd限速也是有两个方式，server.kbytes-per-second（对域名路径限制）和connection.kbytes-per-second（对单一连接限制），问题在于没有对并发连接数的限制（也就是上面我写的算式里的b）。而且是kbytes不是kbits，根据网友的说法，当期望限制在60Mb的时候，配置成：server.kbytes-per-second = 1800就差不多了……</p>
<h1 id="section">限速配置</h1>
<div class="highlight"><pre><code class="lighttpd"><span class="k">connection.kbytes-per-second</span> <span class="o">=</span> <span class="m">30</span> <span class="c1">#单个连接不能超过30KB/s</span>
<span class="nb">$HTTP</span><span class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;download.linuxfly.org&quot;</span> <span class="p">{</span>
    <span class="k">server.name</span> <span class="o">=</span> <span class="s2">&quot;download.linuxfly.org&quot;</span>
    <span class="k">server.document-root</span> <span class="o">=</span> <span class="s2">&quot;/var/www/html/iso&quot;</span>
    <span class="k">accesslog.filename</span> <span class="o">=</span> <span class="s2">&quot;/var/log/lighttpd/iso-access.log&quot;</span>
    <span class="nb">$HTTP</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=~</span> <span class="s2">&quot;^/download/&quot;</span> <span class="p">{</span>
        <span class="k">dir-listing.activate</span> <span class="o">=</span> <span class="s2">&quot;enable&quot;</span>
        <span class="k">server.kbytes-per-second</span> <span class="o">=</span> <span class="m">100</span> <span class="c1">#/download路径下可用的最大是100KB/s</span>
    <span class="p">}</span>
    <span class="k">server.kbytes-per-second</span> <span class="o">=</span> <span class="m">200</span> <span class="c1">#除/download路径外，该域可用的最大带宽是200KB/s</span>
<span class="p">}</span>
</code></pre></div>
<p>最后，不要忘记lighttpd的单线程程序，还要受限于linux系统的单线程打开文件数限制。</p>
<p>lighttpd官方，还提供一个plugin方式，见http://redmine.lighttpd.net/projects/lighttpd/wiki/Docs:TrafficShaping。
这个需要在php代码中定制header来配合lighttpd。总的来说，lighttpd限速功能是不咋的……</p>
<div class="highlight"><pre><code class="bash"><span class="c">#打补丁</span>
wget http://redmine.lighttpd.net/attachments/697/mod_speed.c
mv mod_speed.c lighttpd_1.5/src/
cat &gt;&gt;Makefile.am
<span class="s">&lt;&lt;EOF</span>
<span class="s">lib_LTLIBRARIES += mod_speed.la</span>
<span class="s">mod_speed_la_SOURCES = mod_speed.c</span>
<span class="s">mod_speed_la_LDFLAGS = -module -export-dynamic -avoid-version -no-undefined</span>
<span class="s">mod_speed_la_LIBADD = $(common_libadd)</span>
<span class="s">EOF</span>
</code></pre></div>
<h1 id="plugin">plugin配置参数</h1>
<div class="highlight"><pre><code class="lighttpd"><span class="k">speed.just-copy-header</span> <span class="o">=</span> <span class="s2">&quot;enable&quot;</span>
<span class="k">speed.use-request</span> <span class="o">=</span> <span class="s2">&quot;enable&quot;</span>
</code></pre></div>
<p>//php定制header代码//</p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="nx">header</span><span class="p">(</span><span class="s2">&quot;X-LIGHTTPD-KBytes-per-second: 50&quot;</span><span class="p">);</span>
<span class="nx">header</span><span class="p">(</span><span class="s2">&quot;X-Sendfile: /path/to/file&quot;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
      <a href="/2010/01/30/limit-speed-in-nginx-lighttpd" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/30/anti-hotlinking-in-nginx-lighttpd-squid" title="防盗链进阶（nginx、lighttpd和squid类比）" rel="bookmark">防盗链进阶（nginx、lighttpd和squid类比）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-30 00:00:00 +0800">30 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在折腾squid的rewrite.pl时，参考的是公司原有的一个防盗链脚本。如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#! /usr/bin/env perl</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Digest::</span><span class="n">MD5</span> <span class="sx">qw(md5_hex)</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(difftime mktime)</span><span class="p">;</span>
<span class="vg">$|</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$errUrl</span> <span class="o">=</span> <span class="s">&quot;http://www.test.com/no_such_url.html&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$secret</span> <span class="o">=</span> <span class="s">&quot;123456&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$expired</span> <span class="o">=</span> <span class="mi">7200</span><span class="p">;</span>
<span class="k">while</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="nv">$client</span><span class="p">,</span> <span class="nv">$ident</span><span class="p">,</span> <span class="nv">$method</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;$errUrln&quot;</span> <span class="ow">and</span> <span class="k">next</span> <span class="k">unless</span> <span class="p">(</span><span class="nv">$uri</span> <span class="o">=~</span> <span class="n">m</span><span class="c1">#^(http://w*.?test.com)/(d{4})(d{2})(d{2})(d{2})(d{2})/(w{32})(/.+.mp3)$#i);</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$domain</span><span class="p">,</span> <span class="nv">$year</span><span class="p">,</span> <span class="nv">$mon</span><span class="p">,</span> <span class="nv">$mday</span><span class="p">,</span> <span class="nv">$hour</span><span class="p">,</span> <span class="nv">$min</span><span class="p">,</span> <span class="nv">$md5</span><span class="p">,</span> <span class="nv">$path</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$1</span><span class="p">,</span> <span class="nv">$2</span><span class="p">,</span> <span class="nv">$3</span><span class="p">,</span> <span class="nv">$4</span><span class="p">,</span> <span class="nv">$5</span><span class="p">,</span> <span class="nv">$6</span><span class="p">,</span> <span class="nv">$7</span><span class="p">,</span> <span class="nv">$8</span><span class="p">);</span>
    <span class="k">print</span> <span class="s">&quot;$errUrl\n&quot;</span> <span class="ow">and</span> <span class="k">next</span> <span class="k">if</span> <span class="nv">$year</span> <span class="o">&lt;</span> <span class="mi">1990</span> <span class="ow">or</span> <span class="nv">$mon</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nv">$mon</span> <span class="o">&gt;</span> <span class="mi">12</span> <span class="ow">or</span> <span class="nv">$mday</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nv">$mday</span> <span class="o">&gt;</span> <span class="mi">31</span> <span class="ow">or</span> <span class="nv">$hour</span> <span class="o">&gt;</span> <span class="mi">23</span> <span class="ow">or</span> <span class="nv">$min</span> <span class="o">&gt;</span> <span class="mi">59</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;$errUrl\n&quot;</span> <span class="ow">and</span> <span class="k">next</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">difftime</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="nb">time</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="n">mktime</span><span class="p">(</span><span class="mo">00</span><span class="p">,</span> <span class="nv">$min</span><span class="p">,</span> <span class="nv">$hour</span><span class="p">,</span> <span class="nv">$mday</span><span class="p">,</span> <span class="nv">$mon</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$year</span> <span class="o">-</span> <span class="mi">1900</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="nv">$expired</span><span class="p">;</span>
    <span class="nv">$path</span> <span class="o">=~</span> <span class="n">s</span><span class="c1">#%(..)#pack(&quot;c&quot;, hex($1))#eg;</span>
    <span class="k">print</span> <span class="s">&quot;$errUrl\n&quot;</span> <span class="ow">and</span> <span class="k">next</span> <span class="k">if</span> <span class="nv">$md5</span> <span class="ow">ne</span> <span class="n">md5_hex</span><span class="p">(</span><span class="nv">$secret</span> <span class="o">.</span> <span class="nv">$year</span> <span class="o">.</span> <span class="nv">$mon</span> <span class="o">.</span> <span class="nv">$mday</span> <span class="o">.</span> <span class="nv">$hour</span> <span class="o">.</span> <span class="nv">$min</span> <span class="o">.</span> <span class="nv">$path</span><span class="p">);</span>
    <span class="k">print</span> <span class="nv">$domain</span> <span class="o">.</span> <span class="nv">$path</span><span class="p">,</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>今天在网上看到lighttpd相似的配置。lighttpd自带mod_secdownload模块实现这种防盗链方法。具体配置及php代码如下例（详见http://trac.lighttpd.net/trac/wiki/Docs%3AModSecDownload）：</p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?</span>
<span class="nv">$secret</span> <span class="o">=</span> <span class="s2">&quot;verysecret&quot;</span><span class="p">;</span><span class="err"> </span> <span class="c1">//加密字符串，必须跟lighttpd.conf里边保持一致</span>
<span class="nv">$uri_prefix</span> <span class="o">=</span> <span class="s2">&quot;/dl/&quot;</span><span class="p">;</span><span class="err">   </span> <span class="c1">//虚拟的路径，必须跟lighttpd.conf里边保持一致</span>
<span class="c1"># filename</span>
<span class="nv">$f</span> <span class="o">=</span> <span class="s2">&quot;/secret-file.txt&quot;</span><span class="p">;</span><span class="err"> </span> <span class="c1">//实际文件名，必须要加&quot;/&quot;斜杠</span>
<span class="c1"># current timestamp</span>
<span class="nv">$t</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<span class="nv">$t_hex</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;%08x&quot;</span><span class="p">,</span> <span class="nv">$t</span><span class="p">);</span>
<span class="nv">$m</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$secret</span><span class="o">.</span><span class="nv">$f</span><span class="o">.</span><span class="nv">$t_hex</span><span class="p">);</span>
<span class="c1"># generate link</span>
<span class="nb">printf</span><span class="p">(</span><span class="s1">&#39;%s&#39;</span><span class="p">,</span> <span class="nv">$uri_prefix</span><span class="p">,</span> <span class="nv">$m</span><span class="p">,</span> <span class="nv">$t_hex</span><span class="p">,</span> <span class="nv">$f</span><span class="p">,</span> <span class="nv">$f</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>lighttpd配置文件:  <br />
server.modules = ( &hellip;, &ldquo;mod_secdownload&rdquo;, &hellip; )
secdownload.secret          = &ldquo;verysecret&rdquo;
secdownload.document-root   = &ldquo;/home/www/servers/download-area/&rdquo;
secdownload.uri-prefix      = &ldquo;/dl/&rdquo;
secdownload.timeout         = 10</p>
<p>nginx也有类似功能，不过不是自带，secure_link_module模块，打补丁需要重编译：</p>
<p>wget http://www.sbear.cn/wp-content/uploads/2009/09/nginx-secure-link-ttl.patch
cd nginx-0.7.62
patch -p1 &lt; ../nginx-secure-link-ttl.patch
./configure &ndash;with-http_secure_link_module
……
具体配置及php例子如下（详见http://wiki.nginx.org/NginxHttpSecureLinkModule）：</p>
<div class="highlight"><pre><code class="nginx"><span class="k">location</span> <span class="s">/down/</span> <span class="p">{</span>
    <span class="kn">secure_link_secret</span> <span class="s">&quot;sbear.cn&quot;</span><span class="p">;</span><span class="kn"> </span> <span class="s">//密钥</span>
    <span class="s">secure_link_ttl</span> <span class="no">on</span><span class="p">;</span>
    <span class="kn">root</span> <span class="s">/data/test/down</span><span class="p">;</span>
    <span class="kn">if</span> <span class="s">(</span><span class="nv">$secure_link</span> <span class="p">=</span> <span class="s">&quot;&quot;)</span> <span class="p">{</span>
        <span class="kn">return</span> <span class="mi">403</span><span class="p">;</span>
<span class="p">}</span>
    <span class="kn">rewrite</span> <span class="s">^</span> <span class="s">/</span><span class="nv">$secure_link</span> <span class="s">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="nb">define</span><span class="p">(</span><span class="nx">URL_TIMEOUT</span><span class="p">,</span> <span class="mi">3600</span><span class="p">);</span> <span class="c1">//这里设置过期时间单位是秒</span>
<span class="nv">$prefix</span> <span class="o">=</span> <span class="s2">&quot;&lt;a href=&quot;</span><span class="nx">http</span><span class="o">://</span><span class="nx">www</span><span class="o">.</span><span class="nx">sbear</span><span class="o">.</span><span class="nx">cn</span><span class="o">/</span><span class="nx">down</span><span class="o">&amp;</span><span class="nx">quot</span><span class="p">;;</span><span class="s2">&quot;&gt;http://www.sbear.cn/down&quot;</span><span class="p">;</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
<span class="nv">$protected_resource</span> <span class="o">=</span> <span class="s2">&quot;test.exe&quot;</span><span class="p">;</span>
<span class="nv">$secret</span> <span class="o">=</span> <span class="s2">&quot;sbear.cn&quot;</span><span class="p">;</span><span class="err"> </span> <span class="c1">//密钥</span>
<span class="nv">$time</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="nb">time</span><span class="p">()</span> <span class="o">+</span> <span class="nx">URL_TIMEOUT</span><span class="p">);</span>
<span class="nv">$timeout</span> <span class="o">=</span> <span class="nb">bin2hex</span><span class="p">(</span><span class="nv">$time</span><span class="p">);</span>
<span class="nv">$hashmac</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span> <span class="nv">$protected_resource</span> <span class="o">.</span> <span class="nv">$time</span> <span class="o">.</span> <span class="nv">$secret</span> <span class="p">);</span>
<span class="nv">$url</span> <span class="o">=</span> <span class="nv">$prefix</span> <span class="o">.</span> <span class="s2">&quot;/&quot;</span> <span class="o">.</span> <span class="nv">$hashmac</span> <span class="o">.</span> <span class="nv">$timeout</span> <span class="o">.</span> <span class="s2">&quot;/&quot;</span> <span class="o">.</span> <span class="nv">$protected_resource</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;down&quot;</span><span class="p">;</span>
<span class="k">echo</span> <span class="nb">time</span><span class="p">();</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>那不打补丁，有什么防盗链的办法么？当然有。nginx和lighttpd都支持最简单的referer判断。</p>
<p>nginx有ngx_http_referer_module模块，和apache、squid一样可以rewrite，配置如下：</p>
<div class="highlight"><pre><code class="nginx"><span class="k">location</span> <span class="p">~</span><span class="sr">*</span> <span class="s">.(gif|jpg|png)</span>$ <span class="p">{</span>
<span class="kn">valid_referers</span> <span class="s">none</span> <span class="s">blocked</span> <span class="s">www.test.com</span> <span class="s">baidu.com</span><span class="p">;</span>
    <span class="kn">if</span> <span class="s">(</span><span class="nv">$invalid_referer</span><span class="s">)</span> <span class="p">{</span>
        <span class="kn">rewrite</span> <span class="s">^/</span> <span class="s">http://www.test.com/error.html</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>lighttpd配置如下：</p>
<p>$HTTP[&ldquo;referer&rdquo;] !~ &ldquo;^(http://.<em>.(test.com|baidu.cn))&rdquo;
{
    $HTTP[&ldquo;url&rdquo;] =~ &ldquo;.(jpg|jpeg|png|gif|rar|zip|mp3|swf|flv|wmv|rm|avi)$&rdquo; {
        url.redirect = (&ldquo;.</em>&ldquo;    =&gt; http://www.test.com/&rdquo;)
    }
}
不过还是那句话，这个功能破解起来确实太容易，呵呵~</p>
<p>除了上面说的NginxHttpSecureLinkModule，还有另一个模块ngx_http_accesskey_module，其工作原理是根据client的IP，加上配置定义的key，生成32位MD5值，然后进行匹配。详见http://wiki.codemongers.com/NginxHttpAccessKeyModule，不过我这居然打不开……只好详见网友博客了：
wget <a href="http://wiki.nginx.org/File:Nginx-accesskey-2.0.3.tar.gz">http://wiki.nginx.org/File:Nginx-accesskey-2.0.3.tar.gz</a>
tar zxvf Nginx-accesskey-2.0.3.tar.gz
sed -i &lsquo;s/$HTTP_ACCESSKEY_MODULE/ngx_http_accesskey_module/g nginx-accesskey/config
./configure &ndash;add-module=/path/to/nginx-accesskey
#配置文件
location /download {
    accesskey on;
    accesskey_hashmethod md5;
    accesskey_arg “key”;
    accesskey_signature “mypass$remote_addr”;
}
//php测试页面，$output_add_key正常，$output_org_url返回403//
<?
$ipkey= md5("mypass".$_SERVER['REMOTE_ADDR']);
$output_add_key="<a href="http://www.example.cn/download/G3200507120520LM.rar?key=">http://www.example.cn/download/G3200507120520LM.rar?key="</a>.$ipkey.">download_add_key<br
/>";
$output_org_url="<a href=<a href="http://www.example.cn/download/G3200507120520LM.rar">http://www.example.cn/download/G3200507120520LM.rar</a>>download_org_path<br
/>";
echo $output_add_key;
echo $output_org_url;
?>
而另一个博客这么说：
wget http://www.ieesee.net:8080/~uingei/nginx-accesskey-2.0.3.diff.bz2
cd nginx-0.7.14
bzcat ../nginx-accesskey-2.0.3.diff.bz2 | patch -p1
./configure &ndash;with-http_accesskey_module &hellip;
根据我的观察，这个应该是最初的办法。另，该博客说sec_link是nginx0.7.18后加的官方模块。</p>
      <a href="/2010/01/30/anti-hotlinking-in-nginx-lighttpd-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/29/intro-cronolog-logrotate" title="日志管理" rel="bookmark">日志管理</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-29 00:00:00 +0800">29 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>第一个，最常见的cronolog，因为他配对apache，apache太常见，所以cronolog也就常见了~~稳定版本1.6.2，似乎不支持2G以上的日志，因为那时候linux内核也不支持。。。现在有beta版可以，另据网友分析，其实只要修改1.6.2源代码中的openfile函数成openfile64就行了……
使用方法：</p>
<pre><code>CustomLog "|/usr/local/sbin/cronolog /var/log/httpd/www/access%Y%m%d.log" combined
</code></pre>
<p>其实就是利用管道，传递给cronolog记录日志。
对于不支持在配置文件里利用管道的，也有别的变通办法，比如命名管道。像nginx日志就能这么做：</p>
<p>mkfifo /path/to/nginx/logs/access_log_pipe
/path/to/cronolog /path/to/log/access_%Y%m%d.log /path/to/nginx/logs/access_log_pipe &amp;</p>
<p>然后编辑nginx.conf，修改如下：</p>
<p>access_log /path/to/nginx/logs/access_log_pipe combined</p>
<p>最后要注意的是，必须在启动nginx之前，先启动cronolog。</p>
<p>第二个，系统自带的logrotate，一般系统本身的syslog、crond、yum等，都是用它。对于不必要保存所有的日志，采用这个回滚程式正当其时。/etc/logrotate.conf默认配置不算太复杂，还能使用include，不过其全部参数真是不少，如下表：</p>
<pre><code>参数			功能
compress			通过gzip 压缩转储以后的日志
nocompress			不需要压缩时，用这个参数
copytruncate		用于还在打开中的日志文件，把当前日志备份并截断
nocopytruncate		备份日志文件但是不截断
create			mode owner group 转储文件，使用指定的文件模式创建新的日志文件
nocreate			不建立新的日志文件
delaycompress		和 compress 一起使用时，转储的日志文件到下一次转储时才压缩
nodelaycompress		覆盖 delaycompress 选项，转储同时压缩。
errors			address 专储时的错误信息发送到指定的Email 地址
ifempty			即使是空文件也转储，这个是 logrotate 的缺省选项。
notifempty			如果是空文件的话，不转储
mail			address 把转储的日志文件发送到指定的E-mail 地址
nomail			转储时不发送日志文件
olddir			directory 转储后的日志文件放入指定的目录，必须和当前日志文件在同一个文件系统
noolddir			转储后的日志文件和当前日志文件放在同一个目录下
prerotate/endscript		在转储以前需要执行的命令可以放入这个对，这两个关键字必须单独成行
postrotate/endscript	在转储以后需要执行的命令可以放入这个对，这两个关键字必须单独成行
daily			指定转储周期为每天
weekly			指定转储周期为每周
monthly			指定转储周期为每月
rotate			count 指定日志文件删除之前转储的次数，0 指没有备份，5 指保留5 个备份
tabootext			[+] list 让logrotate 不转储指定扩展名的文件，缺省的扩展名是：.rpm-orig,
.rpmsave,			v, 和 ~
size			size 当日志文件到达指定的大小时才转储，Size可以指定bytes(缺省)以及KB(sizek)或者MB (sizem).
</code></pre>
<p>第三个，newsyslog，这个东西感觉是logrotate的兄弟版，因为其配置文件写法都是采用｛｝的方式，而且命名也这么针锋相对的。习惯了用logrotate的，对于不能回滚而要求分割保留的，可以试试这个。</p>
<p>logrotate的写法举例：</p>
<p>/path/to/wtmp{
    daily
    minsize 5M
    create 0644 root utmp
    rotate 1
}
newsyslog的写法举例：</p>
<pre><code>set squid_logpath = /usr/local/squid/var/logs
set squid_log = /usr/local/squid/var/logs/access.log
set date_squid_log = /usr/local/squid/var/logs/access%Y%M%D.log
SQUID{
    restart: run
    /usr/local/squid/sbin/squid -k rotate
    log:  SQUID
    squid_log squid squid 644
    archive:
    SQUID date_squid_log 0
}
</code></pre>
<p>第四个，也是万能的一个，嗯，就是自己写脚本，定时gzip……</p>
      <a href="/2010/01/29/intro-cronolog-logrotate" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/28/transparent-by-ports" title="端口转发" rel="bookmark">端口转发</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-28 00:00:00 +0800">28 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>常见的linux端口转发，是iptables方式，方法如下：</p>
<div class="highlight"><pre><code class="bash"><span class="c">#modprobe iptable_nat</span>
<span class="c">#modprobe ip_conntrack</span>
<span class="c">#service iptables stop</span>
<span class="c">#echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span>
<span class="c">#iptables -t nat -I PREROUTING -p tcp --dport 443 -j DNAT --to 1.2.3.4</span>
<span class="c">#iptables -t nat -I POSTROUTING -p tcp --dport 8081 -j MASQUERADE</span>
<span class="c">#service iptables save</span>
<span class="c">#service iptables start</span>
</code></pre></div>
<p>其次网上有不少推荐rinetd，方法如下：</p>
<div class="highlight"><pre><code class="bash"><span class="c">#wget http://www.boutell.com/rinetd/http/rinetd.tar.gz</span>
<span class="c">#tar zxvf rinetd.tar.gz</span>
<span class="c">#cd rinted</span>
<span class="c">#./configure &amp;&amp; make &amp;&amp; make install</span>
<span class="c"># cat /etc/rinetd.conf</span>
0.0.0.0 443 www.test.com 443 allow *.*.*.*
logfile /var/log/rinetd.log
</code></pre></div>
<p>看起来比iptables有个优势，可以采用域名解析，可惜做不到根据域名的不同，把相同端口的请求转向不同IP，其实也就跟直接写IP没多少区别了。
第三还有ssh的端口转发，其实是把原TCP端口的数据转由ssh通道传输。方法如下：
本地转发：ssh -g -L <local port="">:<remote host="">:
远程转发：ssh -g -R <local port="">:<remote host="">:
不过客户未必（或许说基本不可能）给外人开放ssh吧~~
第四，socket网络编程实现。我在网上发现了相关的perl脚本。
例一代码如下：</remote></local></remote></local></p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!C:Perlbinperl.exe</span>
<span class="c1">#端口重定向(fork、IO::Select）</span>
<span class="c1">#By shanleiguang@gmail.com, 2005/10</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">IO::</span><span class="n">Socket</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">IO::</span><span class="n">Select</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Std</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(:sys_wait_h strftime)</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">FOREVER</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">BUFSIZE</span> <span class="o">=&gt;</span> <span class="mi">4096</span><span class="p">;</span>
<span class="c1">#父进程下处理僵死子进程</span>
<span class="k">sub </span><span class="nf">zombie_reaper</span> <span class="p">{</span>
<span class="k">while</span><span class="p">(</span><span class="nb">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">WNOHANG</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
<span class="nv">$SIG</span><span class="p">{</span><span class="n">CHLD</span><span class="p">}</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zombie_reaper</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$SIG</span><span class="p">{</span><span class="n">CHLD</span><span class="p">}</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zombie_reaper</span><span class="p">;</span>
<span class="c1">#处理参数</span>
<span class="k">my</span> <span class="nv">%opts</span><span class="p">;</span>
<span class="n">getopts</span><span class="p">(</span><span class="s">&#39;h:l:t:p:&#39;</span><span class="p">,</span> <span class="nv">%opts</span><span class="p">);</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;h&#39;</span><span class="p">}));</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;t&#39;</span><span class="p">})</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;p&#39;</span><span class="p">}));</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;t&#39;</span><span class="p">}</span> <span class="o">!~</span> <span class="sr">m/^d+.d+.d+.d+$/</span><span class="p">);</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;l&#39;</span><span class="p">}</span> <span class="o">!~</span> <span class="sr">m/^d+$/</span><span class="p">);</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;p&#39;</span><span class="p">}</span> <span class="o">!~</span> <span class="sr">m/^d+$/</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$listen_port</span> <span class="o">=</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;l&#39;</span><span class="p">}))</span> <span class="p">?</span> <span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;l&#39;</span><span class="p">}</span> <span class="p">:</span> <span class="mi">8080</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$target_ip</span><span class="err">  </span> <span class="o">=</span> <span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;t&#39;</span><span class="p">};</span>
<span class="k">my</span> <span class="nv">$target_port</span> <span class="o">=</span> <span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;p&#39;</span><span class="p">};</span>
<span class="c1">#在本地创建监听Socket</span>
<span class="k">my</span> <span class="nv">$socket_listen</span><span class="err"> </span> <span class="o">=</span> <span class="nn">IO::Socket::</span><span class="n">INET</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
<span class="n">LocalPort</span> <span class="o">=&gt;</span> <span class="nv">$listen_port</span><span class="p">,</span>
<span class="n">Proto</span>     <span class="o">=&gt;</span> <span class="s">&#39;tcp&#39;</span><span class="p">,</span>
<span class="n">Listen</span><span class="err">   </span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span>
<span class="n">Reuse</span>     <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">);</span>
<span class="k">print</span> <span class="n">timestamp</span><span class="p">(),</span> <span class="s">&quot;, listening on port $listen_port ...n&quot;</span><span class="p">;</span>
<span class="c1">#新建两个用于Socket IO监视的IO::Select对象</span>
<span class="k">my</span> <span class="nv">$readers</span> <span class="o">=</span> <span class="nn">IO::</span><span class="n">Select</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
<span class="k">my</span> <span class="nv">$writers</span> <span class="o">=</span> <span class="nn">IO::</span><span class="n">Select</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
<span class="nv">$readers</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="nv">$socket_listen</span><span class="p">);</span>
<span class="c1">#父进程仅监视Listening Socket的accept事件</span>
<span class="k">while</span><span class="p">(</span><span class="n">FOREVER</span><span class="p">)</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">@readers</span> <span class="o">=</span> <span class="nv">$readers</span><span class="o">-&gt;</span><span class="n">can_read</span><span class="p">;</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$reader</span> <span class="p">(</span><span class="nv">@readers</span><span class="p">)</span> <span class="p">{</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$reader</span> <span class="ow">eq</span> <span class="nv">$socket_listen</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">#创建子进程处理后续的转发，父进程继续监视Listening Socket</span>
<span class="nb">fork</span> <span class="ow">and</span> <span class="k">next</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$socket_client</span> <span class="o">=</span> <span class="nv">$socket_listen</span><span class="o">-&gt;</span><span class="nb">accept</span><span class="p">();</span>
<span class="c1">#在子进程中，不再需要对Listening Socket进行操作</span>
<span class="nv">$readers</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="nv">$socket_listen</span><span class="p">);</span>
<span class="nv">$socket_listen</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">();</span>
<span class="c1">#子进程</span>
<span class="n">as_server</span><span class="p">(</span><span class="nv">$socket_client</span><span class="p">);</span>
<span class="nb">exit</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="c1">#子进程</span>
<span class="k">sub </span><span class="nf">as_server</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">$socket_client</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$client_port</span> <span class="o">=</span> <span class="nv">$socket_client</span><span class="o">-&gt;</span><span class="n">peerport</span><span class="p">();</span>
<span class="k">my</span> <span class="nv">$client_ip</span><span class="err">  </span> <span class="o">=</span> <span class="nv">$socket_client</span><span class="o">-&gt;</span><span class="n">peerhost</span><span class="p">();</span>
<span class="c1">#创建到目标地址:端口的Socket连接</span>
<span class="k">my</span> <span class="nv">$socket_forward</span> <span class="o">=</span> <span class="nn">IO::Socket::</span><span class="n">INET</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
<span class="n">PeerAddr</span> <span class="o">=&gt;</span> <span class="nv">$target_ip</span><span class="p">,</span>
<span class="n">PeerPort</span> <span class="o">=&gt;</span> <span class="nv">$target_port</span>
<span class="p">);</span>
<span class="k">print</span> <span class="n">timestamp</span><span class="p">(),</span> <span class="s">&quot;, $client_ip:$client_port$target_ip:$target_port.n&quot;</span><span class="p">;</span>
<span class="c1">#监视socket_client、socket_forward的IO情况</span>
<span class="nv">$readers</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="nv">$socket_client</span><span class="p">);</span>
<span class="nv">$readers</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="nv">$socket_forward</span><span class="p">);</span>
<span class="nv">$writers</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="nv">$socket_client</span><span class="p">);</span>
<span class="nv">$writers</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="nv">$socket_forward</span><span class="p">);</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$rbuffer_forward</span><span class="p">,</span> <span class="nv">$rbuffer_client</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
<span class="k">while</span><span class="p">(</span><span class="n">FOREVER</span><span class="p">)</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">@readers</span> <span class="o">=</span> <span class="nv">$readers</span><span class="o">-&gt;</span><span class="n">can_read</span><span class="p">;</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$reader</span> <span class="p">(</span><span class="nv">@readers</span><span class="p">)</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">$rbuffer</span><span class="p">;</span>
<span class="c1">#当socket_client可读时，将读取的内容追加到rbuffer_client后</span>
<span class="c1">#假如读取失败，则退出子进程</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$reader</span> <span class="ow">eq</span> <span class="nv">$socket_client</span><span class="p">)</span> <span class="p">{</span>
<span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">recv</span><span class="p">(</span><span class="nv">$reader</span><span class="p">,</span> <span class="nv">$rbuffer</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="nv">$rbuffer_client</span><span class="o">.=</span> <span class="nv">$rbuffer</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">#当socket_forward可读时，将读取的内容追加到rbuffer_forward后</span>
<span class="c1">#假如读取失败，则退出子进程</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$reader</span> <span class="ow">eq</span> <span class="nv">$socket_forward</span><span class="p">)</span> <span class="p">{</span>
<span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">recv</span><span class="p">(</span><span class="nv">$reader</span><span class="p">,</span> <span class="nv">$rbuffer</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="nv">$rbuffer_forward</span> <span class="o">.=</span> <span class="nv">$rbuffer</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="k">my</span> <span class="nv">@writers</span> <span class="o">=</span> <span class="nv">$writers</span><span class="o">-&gt;</span><span class="n">can_write</span><span class="p">;</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$writer</span> <span class="p">(</span><span class="nv">@writers</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">#当socket_client可写，且rbuffer_forward不为空时，将rbuffer_forward</span>
<span class="c1">#内容写入socket_client，假如写失败，则退出子进程</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$writer</span> <span class="ow">eq</span> <span class="nv">$socket_client</span><span class="p">)</span> <span class="p">{</span>
<span class="k">next</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nv">$rbuffer_forward</span><span class="p">);</span>
<span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">send</span><span class="p">(</span><span class="nv">$writer</span><span class="p">,</span> <span class="nv">$rbuffer_forward</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="nv">$rbuffer_forward</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">#当socket_forward可写，且rbuffer_client不为空时，将rbuffer_client</span>
<span class="c1">#内容写入socket_forward，假如写失败，则退出子进程</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$writer</span> <span class="ow">eq</span> <span class="nv">$socket_forward</span><span class="p">)</span> <span class="p">{</span>
<span class="k">next</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nv">$rbuffer_client</span><span class="p">);</span>
<span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">send</span><span class="p">(</span><span class="nv">$writer</span><span class="p">,</span> <span class="nv">$rbuffer_client</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="nv">$rbuffer_client</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">timestamp</span> <span class="p">{</span>
<span class="k">return</span> <span class="n">strftime</span> <span class="s">&quot;[%y/%m/%d,%H:%M:%S]&quot;</span><span class="p">,</span> <span class="nb">localtime</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">print_help</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">$filename</span> <span class="o">=</span> <span class="p">(</span><span class="nb">split</span> <span class="o">/\/</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
<span class="k">print</span> <span class="s">&lt;&lt;HELP</span>
<span class="s">&gt;&gt;&gt;</span>
<span class="s">$filename [-h,-l:]</span>
<span class="s"> -h  print help</span>
<span class="s"> -l  listening local port, default 8080</span>
<span class="s"> -t  target ipaddr</span>
<span class="s"> -p  target port</span>
<span class="s">By shanleiguang@gmail.com, 2005/10</span>
<span class="s">HELP</span>
<span class="p">}</span>
</code></pre></div>
<p>例二代码如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!C:Perlbinperl.exe</span>
<span class="c1">#端口重定向（POE）</span>
<span class="c1">#By shanleiguang@gmail.com, 2005/10</span>
<span class="c1">#POE结构：</span>
<span class="c1">#</span>
<span class="c1">#Driver-&gt;Filter-&gt;Wheel-&gt;Components</span>
<span class="c1">#</span>
<span class="o">|</span><span class="n">______</span><span class="o">|</span><span class="n">______</span><span class="o">|</span><span class="n">________</span><span class="o">|</span>
<span class="c1">#</span>
<span class="o">|</span>
<span class="c1">#          Session</span>
<span class="c1">#</span>
<span class="o">|</span>
<span class="c1"># Kernel</span>
<span class="c1">#</span>
<span class="c1">#Driver：    底层文件操作的抽象，在编程时不会直接用到</span>
<span class="c1">#Filter：    底层、中层协议操作的抽象，通常不会直接用到</span>
<span class="c1">#Wheel：     高层协议操作的抽象，经常要用到</span>
<span class="c1">#Components：POE提供的一些拿来就能用的组件</span>
<span class="c1">#Session：   会话抽象，会话中需要创建高层协议抽象</span>
<span class="c1">#Kernel：    POE管理会话的内核</span>
<span class="c1">#</span>
<span class="c1">#POE对象的数据结构：</span>
<span class="c1">#</span>
<span class="c1">#$_[HEAP]：是会话唯一的数据存储区；</span>
<span class="c1">#$_[SESSION]：是指向会话自身的引用；</span>
<span class="c1">#$_[KERNEL]：是指向会话管理内核的引用；</span>
<span class="c1">#@_[ARG0..ARG9]：用于传递给各事件处理函数的参数；</span>
<span class="c1">#</span>
<span class="c1">#还是实例最直观：</span>
<span class="c1">#在父会话中创建一个监听用的Socket，当有客户端连接，即有accept_sucess事件发生时，</span>
<span class="c1">#则创建一个子会话处理后续事件，并将accept获得的客户端Socket传递给子会话；子会话</span>
<span class="c1">#创建到目标的Socket，连接过程中，如果客户端Socket中有input事件，则将客户端的input</span>
<span class="c1">#内容缓存在一个队列中，当连接成功后，发送给到目标的那个Socket中，见下图：</span>
<span class="c1">#</span>
<span class="c1">#          +-------------------------------+</span>
<span class="c1">#         /|      Socket_listen            |</span>
<span class="c1">#        / +-------------------------------+</span>
<span class="c1">#Client|Socket_client Socket_server|Target</span>
<span class="c1">#          +-------------------------------+</span>
<span class="c1">#                    Forwarder</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Socket</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Std</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(strftime)</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POE</span> <span class="sx">qw(</span>
<span class="sx">Wheel::SocketFactory</span>
<span class="sx">Wheel::ReadWrite</span>
<span class="sx">Filter::Stream</span>
<span class="sx">)</span><span class="p">;</span>
<span class="c1">#Get Options</span>
<span class="k">my</span> <span class="nv">%opts</span><span class="p">;</span>
<span class="n">getopts</span><span class="p">(</span><span class="s">&#39;hl:t:p:&#39;</span><span class="p">,</span> <span class="nv">%opts</span><span class="p">);</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;h&#39;</span><span class="p">}));</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;t&#39;</span><span class="p">})</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;p&#39;</span><span class="p">}));</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;t&#39;</span><span class="p">}</span> <span class="o">!~</span> <span class="sr">m/^d+.d+.d+.d+$/</span><span class="p">);</span>
<span class="n">print_hekp</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;p&#39;</span><span class="p">}</span> <span class="o">!~</span> <span class="sr">m/^d+$/</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$listen_port</span> <span class="o">=</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;l&#39;</span><span class="p">}))</span> <span class="p">?</span> <span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;l&#39;</span><span class="p">}</span> <span class="p">:</span> <span class="mi">8080</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$target_addr</span> <span class="o">=</span> <span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;t&#39;</span><span class="p">};</span>
<span class="k">my</span> <span class="nv">$target_port</span> <span class="o">=</span> <span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;p&#39;</span><span class="p">};</span>
<span class="c1">###Create Parent - &#39;Listen Session&#39;###</span>
<span class="c1">###创建父会话用于监听客户端的连接</span>
<span class="c1">###会话创建的最后将进入_start状态，执行_start的handler</span>
<span class="c1">###accept_success即在_start的handler中创建监听Socket的Wheel中</span>
<span class="c1">###的SuccessEvent事件，它的handler是forwarder_create函数</span>
<span class="c1">###$_[ARG0]是wheel::SocketFatory的SuccessEvent传递的参数</span>
<span class="nn">POE::</span><span class="n">Session</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span>
  <span class="n">inline_states</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">_start</span> <span class="o">=&gt;</span> <span class="o">&amp;</span><span class="n">forwarder_server_start</span><span class="p">,</span>
    <span class="n">_stop</span><span class="err"> </span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="k">print</span> <span class="n">timestamp</span><span class="p">(),</span> <span class="s">&quot;, forwarder server stopped.&quot;</span><span class="p">;</span> <span class="p">},</span>
    <span class="n">accept_success</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="o">&amp;</span><span class="n">forwarder_create</span><span class="p">(</span><span class="nv">$_</span><span class="p">[</span><span class="n">ARG0</span><span class="p">]);</span> <span class="p">},</span>
    <span class="n">accept_failure</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="nb">delete</span> <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">server_wheel</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">},</span>
<span class="p">);</span>
<span class="nv">$poe_kernel</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
<span class="nb">exit</span><span class="p">;</span>
<span class="c1">###Event handlers for Parent Session###</span>
<span class="c1">###父会话中的事件处理函数</span>
<span class="k">sub </span><span class="nf">forwarder_server_start</span> <span class="p">{</span>
<span class="k">print</span> <span class="n">timestamp</span><span class="p">(),</span> <span class="s">&quot;, listening on port $listen_port and &quot;</span><span class="p">;</span>
<span class="k">print</span> <span class="s">&quot;forward to $target_addr:$target_port\n&quot;</span><span class="p">;</span>
<span class="c1">#在父会话的存储区创建一个监听Socket类型的Wheel</span>
<span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">server_wheel</span><span class="p">}</span> <span class="o">=</span> <span class="nn">POE::Wheel::</span><span class="n">SocketFactory</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
  <span class="n">BindPort</span>       <span class="o">=&gt;</span> <span class="nv">$listen_port</span><span class="p">,</span>
  <span class="n">SocketProtocol</span> <span class="o">=&gt;</span> <span class="s">&#39;tcp&#39;</span><span class="p">,</span>
  <span class="n">ListenQueue</span><span class="err">   </span> <span class="o">=&gt;</span> <span class="n">SOMAXCONN</span><span class="p">,</span>
  <span class="n">Reuse</span><span class="err">         </span> <span class="o">=&gt;</span> <span class="s">&#39;on&#39;</span><span class="p">,</span>
<span class="c1">#ARG0 of SuccessEvent</span>
  <span class="n">SuccessEvent</span>   <span class="o">=&gt;</span> <span class="s">&#39;accept_success&#39;</span><span class="p">,</span>
  <span class="n">FailureEvent</span>   <span class="o">=&gt;</span> <span class="s">&#39;accept_failure&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="p">}</span>
<span class="c1">###Create Child - &#39;Forward Session&#39;###</span>
<span class="c1">###创建子会话</span>
<span class="k">sub </span><span class="nf">forwarder_create</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">$socket</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
<span class="nn">POE::</span><span class="n">Session</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span>
<span class="n">inline_states</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="n">_start</span> <span class="o">=&gt;</span> <span class="o">&amp;</span><span class="n">forwarder_start</span><span class="p">,</span>
<span class="n">_stop</span><span class="err"> </span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
<span class="k">print</span> <span class="s">&#39; &#39;</span> <span class="n">x</span> <span class="mi">4</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">(),</span> <span class="s">&#39;, sessionId:&#39;</span><span class="p">;</span>
<span class="k">print</span> <span class="nv">$_</span><span class="p">[</span><span class="n">SESSION</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ID</span><span class="p">,</span> <span class="s">&quot;, forwarder stop\n&quot;</span><span class="p">;</span>
<span class="p">},</span>
<span class="n">client_input</span> <span class="o">=&gt;</span> <span class="o">&amp;</span><span class="n">client_input</span><span class="p">,</span>
<span class="n">client_error</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
<span class="nb">delete</span> <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_client</span><span class="p">};</span>
<span class="nb">delete</span> <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_server</span><span class="p">};</span>
<span class="p">},</span>
<span class="n">server_connect</span> <span class="o">=&gt;</span> <span class="o">&amp;</span><span class="n">server_connect</span><span class="p">,</span>
<span class="n">server_input</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
<span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_client</span><span class="p">}</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="nv">$_</span><span class="p">[</span><span class="n">ARG0</span><span class="p">])</span> <span class="k">if</span><span class="p">(</span><span class="nb">exists</span> <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_client</span><span class="p">});</span>
<span class="p">},</span>
<span class="n">server_error</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
<span class="nb">delete</span> <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_client</span><span class="p">};</span>
<span class="nb">delete</span> <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_server</span><span class="p">};</span>
<span class="p">},</span>
<span class="p">},</span>
<span class="c1">#Parameters to &#39;_start&#39; Event</span>
<span class="n">args</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$socket</span><span class="p">],</span>
<span class="p">);</span>
<span class="p">}</span>
<span class="c1">##Event Handlers of Child Session##</span>
<span class="k">sub </span><span class="nf">forwarder_start</span> <span class="p">{</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$heap</span><span class="p">,</span> <span class="nv">$socket</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">,</span> <span class="n">ARG0</span><span class="p">];</span>
<span class="k">print</span> <span class="s">&#39; &#39;</span> <span class="n">x</span> <span class="mi">4</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">(),</span> <span class="s">&#39;, sessionId:&#39;</span><span class="p">;</span>
<span class="k">print</span> <span class="nv">$_</span><span class="p">[</span><span class="n">SESSION</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ID</span><span class="p">,</span> <span class="s">&quot;, forwarder startn&quot;</span><span class="p">;</span>
<span class="c1">#Buffer client&#39;s input while connecting to the target</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">}</span> <span class="o">=</span> <span class="s">&#39;connecting&#39;</span><span class="p">;</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">queue</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span><span class="p">;</span>
<span class="c1">#ClientForwarder server</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_client</span><span class="p">}</span> <span class="o">=</span> <span class="nn">POE::Wheel::</span><span class="n">ReadWrite</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
<span class="n">Handle</span> <span class="o">=&gt;</span> <span class="nv">$socket</span><span class="p">,</span>
<span class="n">Driver</span> <span class="o">=&gt;</span> <span class="nn">POE::Driver::</span><span class="n">SysRW</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(),</span>
<span class="n">Filter</span> <span class="o">=&gt;</span> <span class="nn">POE::Filter::</span><span class="n">Stream</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(),</span>
<span class="n">InputEvent</span> <span class="o">=&gt;</span> <span class="s">&#39;client_input&#39;</span><span class="p">,</span>
<span class="n">ErrorEvent</span> <span class="o">=&gt;</span> <span class="s">&#39;client_error&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="c1">#Forwarder servertarget</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_server</span><span class="p">}</span> <span class="o">=</span> <span class="nn">POE::Wheel::</span><span class="n">SocketFactory</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
<span class="n">RemoteAddress</span> <span class="o">=&gt;</span> <span class="nv">$target_addr</span><span class="p">,</span>
<span class="n">RemotePort</span><span class="err">   </span> <span class="o">=&gt;</span> <span class="nv">$target_port</span><span class="p">,</span>
<span class="n">SuccessEvent</span><span class="err"> </span> <span class="o">=&gt;</span> <span class="s">&#39;server_connect&#39;</span><span class="p">,</span>
<span class="n">FailureEvent</span><span class="err"> </span> <span class="o">=&gt;</span> <span class="s">&#39;server_error&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">server_connect</span> <span class="p">{</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$kernel</span><span class="p">,</span> <span class="nv">$session</span><span class="p">,</span> <span class="nv">$heap</span><span class="p">,</span> <span class="nv">$socket</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">[</span><span class="n">KERNEL</span><span class="p">,</span> <span class="n">SESSION</span><span class="p">,</span> <span class="n">HEAP</span><span class="p">,</span> <span class="n">ARG0</span><span class="p">];</span>
<span class="c1">#Replace</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_server</span><span class="p">}</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_server</span><span class="p">}</span>
<span class="o">=</span> <span class="nn">POE::Wheel::</span><span class="n">ReadWrite</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
<span class="n">Handle</span>     <span class="o">=&gt;</span> <span class="nv">$socket</span><span class="p">,</span>
<span class="n">Driver</span>     <span class="o">=&gt;</span> <span class="nn">POE::Driver::</span><span class="n">SysRW</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">,</span>
<span class="n">Filter</span>     <span class="o">=&gt;</span> <span class="nn">POE::Filter::</span><span class="n">Stream</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">,</span>
<span class="n">InputEvent</span> <span class="o">=&gt;</span> <span class="s">&#39;server_input&#39;</span><span class="p">,</span>
<span class="n">ErrorEvent</span> <span class="o">=&gt;</span> <span class="s">&#39;server_error&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">}</span> <span class="o">=</span> <span class="s">&#39;connected&#39;</span><span class="p">;</span>
<span class="nv">$kernel</span><span class="o">-&gt;</span><span class="n">call</span><span class="p">(</span><span class="nv">$session</span><span class="p">,</span> <span class="s">&#39;client_input&#39;</span><span class="p">,</span> <span class="nv">$_</span><span class="p">)</span> <span class="k">foreach</span><span class="p">(</span><span class="nv">@</span><span class="p">{</span><span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">queue</span><span class="p">}});</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">queue</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">client_input</span> <span class="p">{</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$heap</span><span class="p">,</span> <span class="nv">$input</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">,</span> <span class="n">ARG0</span><span class="p">];</span>
<span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">queue</span><span class="p">}},</span> <span class="nv">$input</span> <span class="ow">and</span> <span class="k">return</span> <span class="k">if</span><span class="p">(</span><span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">}</span> <span class="ow">eq</span> <span class="s">&#39;connecting&#39;</span><span class="p">);</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_server</span><span class="p">}</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="nv">$input</span><span class="p">)</span> <span class="k">if</span><span class="p">(</span><span class="nb">exists</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_server</span><span class="p">});</span>
<span class="p">}</span>
<span class="c1">#Common subroutines</span>
<span class="k">sub </span><span class="nf">timestamp</span> <span class="p">{</span>
<span class="k">return</span> <span class="n">strftime</span> <span class="s">&quot;[%H:%M:%S]&quot;</span><span class="p">,</span> <span class="nb">localtime</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">print_help</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">$filename</span> <span class="o">=</span> <span class="p">(</span><span class="nb">split</span> <span class="o">/\/</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
<span class="k">print</span> <span class="s">&lt;&lt;HELP</span>
<span class="s">&gt;&gt;&gt;</span>
<span class="s">$filename [-h,-l:]</span>
<span class="s">-h  print help</span>
<span class="s">-l  listen port</span>
<span class="s">-t  target ipaddress</span>
<span class="s">-p  target port</span>
<span class="s">A simple TCP forwarder server, 2005/10</span>
<span class="s">By shanleiguang@gmail.com</span>
<span class="s">HELP</span>
<span class="p">}</span>
</code></pre></div>
<p>使用方法：
# perl tcpForwarder.pl -l 8080 -t
xxx.xxx.xxx.xxx -p 80
[xx:xx:xx:], listening on local port 8080 and forward to
xxx.xxx.xxx.xxx:80&hellip;
&hellip;</p>
      <a href="/2010/01/28/transparent-by-ports" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/27/test-location-in-squid" title="squid页面跳转试验" rel="bookmark">squid页面跳转试验</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-27 00:00:00 +0800">27 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>某客户页面跳转试验记录</p>
<h2 id="section">一、客户需求</h2>
<p>某客户加速域名下某路径http://www.test.com/zhlc/不想让网民直接访问，希望当有直接访问该路径的请求时，都跳转到search.test.com域名下相应的路径去。</p>
<h2 id="section-1">二、解决思路</h2>
<p>a) 客户源站增添rewrite配置进行处理，将该类请求url改写成所期望的url；
b) Squid端对请求进行处理，将该类请求url改写成所期望的url。
根据售前沟通结果，这个处理步骤交由squid完成。</p>
<h2 id="squidrequest">三、Squid对request的处理流程（略，见前博文）</h2>
<h2 id="section-2">四、两种跳转方法的介绍与比较</h2>
<p>针对跳转需求，提供两个两种方法：
a) Squid支持调用外部程序脚本改写url，即redirect_program（2.6以上版本为url_rewrite_program）。所有的url请求，在squid处理流程的第三步，都会检查rewrite_program，然后将改写后的结果推入流程继续进行（为了提高运行速度，降低服务器负载，可以采用url_rewrite_access控制请求和redirector_bypass在繁忙时进行透传）。
根据《squid中文权威指南》11章的介绍，squid传递给redirect_proram的流格式为：
URL IP/FQDN IDENT METHOD
Rewrite处理时，也就是对这四个字段进行处理，一般地说，也就处理第一个字段——$url。
《squid中文权威指南》中提供了标准的perl脚本，演示了处理办法。我们测试脚本时，只需要创建一个文本文件写出url，对文件执行脚本即可。某客户测试过程如下示，为说明方便，也使用了其他shell命令做比较：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@tinysquid1 etc<span class="o">]</span><span class="c"># cat testurl.lst</span>
http://www.test.com/zhlc/
http://www.test.com/zhlc/images/1.jpg
http://www.test.com/zhlc/index.html
http://www.test.com/zhlc/index.aspx?oid<span class="o">=</span>1
http://www.test.com/zhlc/index.aspx?oid<span class="o">=</span>1&amp;pid<span class="o">=</span>2
<span class="o">[</span>root@tinysquid1 etc<span class="o">]</span><span class="c"># cat testurl.lst |sed s/www/search/</span>
http://search.test.com/zhlc/
http://search.test.com/zhlc/images/1.jpg
http://search.test.com/zhlc/index.html
http://search.test.com/zhlc/index.aspx?oid<span class="o">=</span>1
http://search.test.com/zhlc/index.aspx?oid<span class="o">=</span>1&amp;pid<span class="o">=</span>2
<span class="o">[</span>root@tinysquid1 etc<span class="o">]</span><span class="c"># cat redirector.awk</span>
<span class="c">#!/bin/awk -f</span>
<span class="o">{</span>
    split<span class="o">(</span><span class="nv">$1</span>,myarray,<span class="s2">&quot;.test.com/&quot;</span><span class="o">)</span>
<span class="o">}</span>
<span class="o">{</span>
    myarray<span class="o">[</span>1<span class="o">]=</span>http://search<span class="s2">&quot;;</span>
<span class="s2">    print myarray[1]&quot;</span>.test.com/<span class="s2">&quot;myarray[2]&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="s2">}</span>
<span class="s2">[root@tinysquid1 etc]# ./redirector.awk testurl.lst</span>
<span class="s2">http://search.test.com/zhlc/</span>
<span class="s2">http://search.test.com/zhlc/images/1.jpg</span>
<span class="s2">http://search.test.com/zhlc/index.html</span>
<span class="s2">http://search.test.com/zhlc/index.aspx?oid=1</span>
<span class="s2">http://search.test.com/zhlc/index.aspx?oid=1&amp;pid=2</span>
<span class="s2">[root@tinysquid1 etc]# cat redirector.pl</span>
<span class="s2">#!/usr/bin/perl -wl</span>
<span class="s2">use strict;</span>
<span class="s2">$|=1;</span>
<span class="s2">while () {</span>
<span class="s2">        my ($url,$client,$ident,$method) = ();</span>
<span class="s2">        ($url, $client, $ident, $method) = split;</span>
<span class="s2">    if ($url =~ m#^http://www.test.com/zhlc/#) {</span>
<span class="s2">        $url=~ s/www/search/;</span>
<span class="s2">        print &quot;</span><span class="nv">$url</span><span class="se">\n</span><span class="s2">&quot;;</span>
<span class="s2">    } else {</span>
<span class="s2">        print &quot;</span><span class="nv">$urln</span><span class="err">&quot;</span>;
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">[</span>root@tinysquid1 etc<span class="o">]</span><span class="c"># ./redirector.pl testurl.lst</span>
http://search.test.com/zhlc/
http://search.test.com/zhlc/images/1.jpg
http://search.test.com/zhlc/index.html
http://search.test.com/zhlc/index.aspx?oid<span class="o">=</span>1
http://search.test.com/zhlc/index.aspx?oid<span class="o">=</span>1&amp;pid<span class="o">=</span>2
</code></pre></div>
<p>不过虽然awk也是流处理，但作为squid的外挂program测试却没法真起作用。所以只能用perl（网上看到也有用php和python的）。</p>
<p>采用rewrite方法后，squid日志记录如下：</p>
<pre><code>1264603532.881   1147 59.151.*.* TCP_MISS/200 86230 GET http://www.test.com/zhlc/images/header.jpg - DIRECT/1.2.3.173 image/jpeg "http://www.test.com/zhlc/" "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; QQPinyinSetup 620; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30)"
</code></pre>
<p>虽然http_status显示的200，不过www.test.com的源站IP为1.2.3.172，search.test.com的源站IP为1.2.3.173，可见squid已经将请求转发给search.test.com了。</p>
<p>由上面的流程可知，squid是先检查acl，然后rewrite，再检查HIT/MISS，所以当设定了search.test.com/.<em>的 cache_deny 后，所有www.test.com/zhlc/.</em>的重复访问也都是MISS。</p>
<p>b) 第二种方法，不属于专门的跳转重定向，算是个妙用吧：</p>
<p>Squid为了美观方便，提供了一些错误信息的定制功能。之前的源站错误跳转，就是修改了ERROR_DIRECTORY里html的meta标签做的。除此以外，针对error_diretory里的ACCESS_DENIED页面，还有专门的另一个configure参数进行定制——deny_info。其用法如下：</p>
<div class="highlight"><pre><code class="squid"><span class="k">acl</span><span class="w"> </span>test<span class="w"> </span><span class="k">url_regex</span><span class="w"> </span>-i<span class="w"> </span>^http://www.test.com/zhlc/.*<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">deny</span><span class="w"> </span>test<span class="w"></span>
<span class="k">deny_info</span><span class="w"> </span>http://search.test.com/zhlc/<span class="w"> </span>test<span class="w"></span>
</code></pre></div>
<p>如果需要显示的信息已经编辑在error_diretory里了，那就可以直接写文件名而不用写url。Squid.conf.default中举例是 <code>deny_info ERR_CUSTOM_ACCESS_DENIED bad_guys</code>。</p>
<p>这个deny_info，常用的地方是防盗链。在deny盗链的同时，加上一个源站的logo图片url，正好让盗链网站替自己做宣传~~</p>
<p>采用deny_info方法后，squid日志记录如下：</p>
<pre><code>1264661272.822 2 59.151.*.* TCP_DENIED/302 320 GET http://www.test.com/zhlc/ - NONE/- text/html "-" "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; QQPinyinSetup 620; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30)"
1264661273.753 854 59.151.*.* TCP_MISS/200 9166 GET http://search.test.com/zhlc/ - DIRECT/1.2.3.173 text/html "-" "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; QQPinyinSetup 620; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30)"
</code></pre>
<p>显示的是TCP_DENIED/302。</p>
<p>c) 两个方法比较</p>
<p>最表面可见的不同，就是当IE访问http://www.test.com/zhlc/时，第一种方法地址栏依然显示（httpwatch也一样）http://www.test.com/zhlc/，而第二种方法也显示为http://search.test.com/zhlc/了。</p>
<p>根据之前论述可知，第一种访问时，clinet提出第一个http://www.test.com/zhlc/请求，squid在流程第三步改写url，从search源站取回html代码，查询到相关资源（即http://www.test.com/zhlc/.*），然后重复请求过程，逐一改写，从search源站取回所有文件；</p>
<p>第二种访问时，client提出第一个http://www.test.com/zhlc/请求，squid在流程第二步检查出相匹配的acl规则，返回deny信息给client，即请IE浏览器显示http://search.test.com/zhlc/，然后client重新开始一次链接建立过程，经dns解析等步骤，连上search.test.com的，取回http://search.test.com/zhlc/.*。</p>
<h2 id="section-3">五、客户页面分析</h2>
<p>在日志分析过程中，还发现一个问题，当squid首先从search.test.com源站取回html代码后，为什么调用的相关页面资源url请求也都是www.test.com的呢？看http://www.test.com/zhlc/页面代码，发现如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/zhlc/style/reset.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/zhlc/style/main.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/zhlc/Scripts/AC_RunActiveContent.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;&lt;img</span> <span class="na">src=</span><span class="s">&quot;/zhlc/images/logo.jpg&quot;</span> <span class="na">width=</span><span class="s">&quot;154&quot;</span> <span class="na">height=</span><span class="s">&quot;80&quot;</span> <span class="na">border=</span><span class="s">&quot;0&quot;</span><span class="nt">/&gt;&lt;/a&gt;</span>
……
</code></pre></div>
<p>其页面代码都使用了相对路径，所以才导致了从search端取回的代码依然调用www的url的现象。</p>
<h2 id="section-4">六、总结</h2>
<p>某客户页面跳转试验至此，因为squid处理流程和客户源站代码等多方面原因，只能采用统一跳转至http://search.test.com/zhlc/单一页面的方法，确保客户在IE地址栏里看到有跳转的效果……</p>
<p>最后，总结试验中的两种办法，其改写过程，可以归纳成rewrite是squid-origin过程的，deny_info是squid-client过程的。</p>
      <a href="/2010/01/27/test-location-in-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/24/shell-script-for-train-setting" title="CUshell版惊见中国特色脚本" rel="bookmark">CUshell版惊见中国特色脚本</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-24 00:00:00 +0800">24 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>58同城：</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
<span class="c">#该脚本仅用于58同城网站刷票</span>
<span class="c">#到达目的地</span>
<span class="nv">DES</span><span class="o">=</span><span class="s2">&quot;(天水|兰州|西安)&quot;</span>
<span class="c">#刷票url</span>
<span class="nv">URL</span><span class="o">=</span>http://bj.58.com/huochepiao/a1/
<span class="nv">OLDMD5</span><span class="o">=</span><span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | sed <span class="s1">&#39;$d&#39;</span> | md5sum | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
<span class="k">while </span><span class="nb">true</span>; <span class="k">do</span>
<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$OLDMD5&quot;</span> <span class="o">==</span> <span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | sed <span class="s1">&#39;$d&#39;</span> | md5sum | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span> <span class="o">]</span>;<span class="k">then</span>
<span class="k">        </span>sleep 300
    <span class="k">else</span>
<span class="k">        </span><span class="nv">MESSAGE</span><span class="o">=</span><span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | sed <span class="s1">&#39;$d&#39;</span> | head -n1<span class="sb">`</span>
        <span class="nv">SEND</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$MESSAGE</span> | awk -F<span class="s2">&quot;&gt;&quot;</span> <span class="s1">&#39;{print $3}&#39;</span> | sed -e <span class="s1">&#39;s/&lt;.*//&#39;</span><span class="sb">`</span>
        <span class="nv">DATE</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$SEND</span> | awk -F<span class="s2">&quot;:&quot;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>
        <span class="c">#判断DATE变量，使其匹配你需要出发的日期</span>
        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;2010-02-08&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;2010-02-09&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;2010-02-10&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;2010-02-11&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;2010-02-12&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;2010-01-28&quot;</span> <span class="o">]</span>;<span class="k">then</span>
            <span class="c">#输入需要发送信息的命令,飞信或mail等.....,发送的内容为$SEND变量</span>
            /usr/bin/curl -d <span class="nv">cdkey</span><span class="o">=</span>xxxx-xxx-xxxx-xxxxx -d <span class="nv">password</span><span class="o">=</span>xxxxxx -d <span class="nv">addserial</span><span class="o">=</span>xxx -d <span class="nv">phone</span><span class="o">=</span>13000000000 -d <span class="nv">message</span><span class="o">=</span><span class="s2">&quot;$SEND:58.com&quot;</span> http://sdkhttp.eucp.b2m.cn/sdkproxy/asynsendsms.action
        <span class="k">fi</span>
<span class="k">        </span><span class="nv">OLDMD5</span><span class="o">=</span><span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | sed <span class="s1">&#39;$d&#39;</span> | md5sum | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
        sleep 300
    <span class="k">fi</span>
<span class="k">done</span>
</code></pre></div>
<p>赶集网：</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
<span class="c">#该脚本仅用于赶集网刷票</span>
<span class="c">#到达目的地</span>
<span class="nv">DES</span><span class="o">=</span><span class="s2">&quot;(天水|兰州|西安)&quot;</span>
<span class="c">#刷票url</span>
<span class="nv">URL</span><span class="o">=</span>http://bj.ganji.com/piao/sell/
<span class="nv">OLDMD5</span><span class="o">=</span><span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | md5sum | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
<span class="k">while </span><span class="nb">true</span>; <span class="k">do</span>
<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$OLDMD5&quot;</span> <span class="o">==</span> <span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | md5sum | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span> <span class="o">]</span>;<span class="k">then</span>
<span class="k">        </span>sleep 300
    <span class="k">else</span>
<span class="k">        </span><span class="nv">MESSAGE</span><span class="o">=</span><span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | head -n1<span class="sb">`</span>
        <span class="nv">SEND</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$MESSAGE</span> | awk -F<span class="s2">&quot;&gt;&quot;</span> <span class="s1">&#39;{print $3}&#39;</span> | sed -e <span class="s1">&#39;s/&lt;.*//&#39;</span><span class="sb">`</span>
        <span class="nv">DATE</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$SEND</span> | awk -F<span class="s2">&quot;:&quot;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>
        <span class="c">#判断DATE变量，使其匹配你需要出发的日期</span>
        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;02-08&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;02-09&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;02-10&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;02-11&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;02-12&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;01-28&quot;</span> <span class="o">]</span>;<span class="k">then</span>
        <span class="c">#输入需要发送信息的命令,飞信或mail等.....,发送的内容为$SEND变量</span>
        /usr/bin/curl -d <span class="nv">cdkey</span><span class="o">=</span>xxxx-xxx-xxxx-xxxxx -d <span class="nv">password</span><span class="o">=</span>xxxxxx -d <span class="nv">addserial</span><span class="o">=</span>xxx -d <span class="nv">phone</span><span class="o">=</span>13000000000 -d <span class="nv">message</span><span class="o">=</span><span class="s2">&quot;$SEND:ganji.com&quot;</span> &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://sdkhttp.eucp.b2m.cn/sdkproxy/asynsendsms.action&quot;</span>&gt;http://sdkhttp.eucp.b2m.cn/sdkproxy/asynsendsms.action&lt;/a&gt;
        <span class="k">fi</span>
<span class="k">        </span><span class="nv">OLDMD5</span><span class="o">=</span><span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | md5sum | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
        sleep 300
    <span class="k">fi</span>
<span class="k">done</span>
</code></pre></div>
      <a href="/2010/01/24/shell-script-for-train-setting" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page12">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page active">
      <a href="#">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li>
      <a href="/page14">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.icylife.net/blog/" title="">心路</a></li>
              <li><a href="http://dbahacker.com/" title="TB 杨德华">DBA Hacker</a></li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.laird-sa.com/" title="">Laird-SA</a></li>
              <li><a href="http://www.linuxsee.com/" title="">LinuxSEE</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://www.puppeter.cn/" title="">piol</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.sanote.org/" title="">sa note</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://blog.ops.tudou.com/wp/" title="">土豆运营团队</a></li>
              <li><a href="http://www.91tuanfang.com/" title="安居客运维">家欣的天空</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://www.opboy.com" title="">运维小子</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://l09.me/" title="风声">风声</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://mooser.me/" title="牛氓">牛氓</a></li>
              <li><a href="http://http://www.yinwang.org/" title="当然我在扯淡">当然我在扯淡</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://muxueqz.laou.me" title="muxueqz">聊逍遥兮容与</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://paperplane.ruhoh.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.sectop.org/" title="">kindle</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
          </ul>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
