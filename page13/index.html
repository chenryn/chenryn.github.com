<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/02/04/performance-optimization-test-of-tcmalloc-loaded-by-squid-3" title="squid加载tcmalloc性能优化测试(编译)" rel="bookmark">squid加载tcmalloc性能优化测试(编译)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-02-04 00:00:00 +0800">04 Feb 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>话接上文，同一组LVS下，昨天采用重编译方式部署了另一台squid服务器。同样跑上一天，再次对比一番。今天流量比上回稍微少些，未加载的服务器cacti监控截图如下：
<img src="/images/uploads/62d80b5eh73140310b076690.jpg" alt="" title="cpu" width="573" height="259" class="alignnone size-full wp-image-2565" />
CPU占用率
=====================
<img src="/images/uploads/62d80b5eh73140316c9a2690.jpg" alt="" title="loadavg" width="569" height="254" class="alignnone size-full wp-image-2567" />
负载</p>
<hr />
<p>同时，重编译过后的squid服务器监控截图如下：
<img src="/images/uploads/62d80b5eh7314031cd5b3690.jpg" alt="" title="cpu-new" width="572" height="261" class="alignnone size-full wp-image-2568" />
CPU占用率（那个尖峰是我运行了一下lsof确认是否加载，lsof这个命令真是大杀器，少用……）
=====================
<img src="/images/uploads/62d80b5eh731403230ce5690.jpg" alt="" title="loadavg-new" width="570" height="258" class="alignnone size-full wp-image-2569" />
负载</p>
<p>这么一对比，效果马上就出来了。难怪官方建议要用编译加载的方式呢~~~</p>
      <a href="/2010/02/04/performance-optimization-test-of-tcmalloc-loaded-by-squid-3" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/02/01/performance-optimization-test-of-tcmalloc-loaded-by-squid-2" title="squid加载tcmalloc性能优化测试(动态)" rel="bookmark">squid加载tcmalloc性能优化测试(动态)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-02-01 00:00:00 +0800">01 Feb 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>昨天下午在一台squid上加载了tcmalloc。运行到现在，整整一天时间。现取LVS下与其完全相同配置的另一台未加载tcmalloc的squid服务器进行比较。
环境说明：
CPUinfo：Intel(R) Xeon(R) CPU  E5405  @ 2.00GHz
MEM：4G
SQUID：Version 2.6.STABLE21
当单台流量20M，TCP连接数6w时，未加载tcmalloc的服务器CPU占用率和负载情况如下图：
<img src="/images/uploads/62d80b5eh730dca4ebd76690.jpg" alt="" title="cpu%" width="572" height="263" class="alignnone size-full wp-image-2559" />
CPU占用率
<img src="/images/uploads/62d80b5eh730dca57d6ee690.jpg" alt="" title="loadavg" width="575" height="257" class="alignnone size-full wp-image-2561" />
负载</p>
<hr />
<p>而同时，加载了tcmalloc的服务器CPU占用率和负载情况如下图：
<img src="/images/uploads/62d80b5eh730dca5f8985690.jpg" alt="" title="cpu%-new" width="577" height="263" class="alignnone size-full wp-image-2562" />
CPU占用率
<img src="/images/uploads/62d80b5eh730dca671bb7690.jpg" alt="" title="loadavg-new" width="579" height="259" class="alignnone size-full wp-image-2563" />
负载（上一个尖峰就是我加载tcmalloc的时候）</p>
<p>从图中来看，加载tcmalloc，确实对squid处理高并发小图片请求有一定的性能优化帮助，但其本身对系统资源又有一定的耗用，导致负载反而略微提高（CPU占用率中sys也变高了）。而在并发量不大的时候，加载tcmalloc占用的CPU资源在图中也有显现。</p>
<p>或许这就是官方不建议采用动态加载方式的原因？下一步试验，采用重编译方式测试。</p>
      <a href="/2010/02/01/performance-optimization-test-of-tcmalloc-loaded-by-squid-2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/31/third-party-tools-about-squid" title="squid几个第三方工具" rel="bookmark">squid几个第三方工具</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-31 00:00:00 +0800">31 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p><a href="http://gadmintools.flippedweb.com/index.php?option=com_content&amp;task=view&amp;id=47&amp;Itemid=37#Download">GADMIN-SQUID</a> 在linux环境下运行，经本人下载src后看，只能用于本机squid管理，不支持批量……</p>
<p><a href="http://www.zerozone.it/Software/Linux/SquidTL/">SQUIDTL</a> 针对IP、domain进行访问时长控制，C语言编写，需配合MySQL，好复杂的架构……</p>
<p><a href="http://sourceforge.net/projects/squidmodel/">SQUIDMODEL</a> java平台，俺还没搞定，未知其所以然</p>
<p><a href="http://cachevideos.com">CACHEVIDEO</a> 专门针对yotube等网站的视频文件缓存开发的rewrite_program，python编写。可惜是要花钱滴~~</p>
      <a href="/2010/01/31/third-party-tools-about-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/31/performance-optimization-test-of-tcmalloc-loaded-by-squid-1" title="squid加载tcmalloc性能优化测试(原理)" rel="bookmark">squid加载tcmalloc性能优化测试(原理)</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-31 00:00:00 +0800">31 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>TCMalloc（Thread-Caching Malloc）是google开发的开源工具──“<a href="http://code.google.com/p/google-perftools/" title="google-perftools">google-perftools</a>”中的成员。其作者宣称tcmalloc相对于glibc2.3 malloc(aka-ptmalloc2)在内存的分配上效率和速度有6倍的性能提高，tcmalloc的常用场景是用于加速MySQL，不过据Wikipedia的hacker（Domas Mituzas）说，tcmalloc不仅仅对MySQL起作用，对squid也同样起作用（网上也有很多人在nginx上启用tcmalloc了），不过目前squid并没有official way来使用tcmalloc。
TCMalloc的实现原理和测试报告请见一篇文章：《<a href="http://shiningray.cn/tcmalloc-thread-caching-malloc.html">TCMalloc：线程缓存的Malloc</a>》
那么让我们赶紧给squid加载上tcmalloc，提高cache服务器在高并发情况下的性能，降低系统负载吧。
因为服务器是64位OS，所以要先安装libunwind库。libunwind库为基于64位CPU和操作系统的程序提供了基本的堆栈辗转开解功能，其中包括用于输出堆栈跟踪的API、用于以编程方式辗转开解堆栈的API以及支持C++异常处理机制的API。（又cp一句话，^=^）</p>
<div class="highlight"><pre><code class="bash">wget http://download.savannah.gnu.org/releases/libunwind/libunwind-0.99.tar.gz
tar zxvf libunwind-0.99.tar.gz
<span class="nb">cd </span>libunwind-0.99/
<span class="nv">CFLAGS</span><span class="o">=</span>-fPIC ./configure
make <span class="nv">CFLAGS</span><span class="o">=</span>-fPIC
make <span class="nv">CFLAGS</span><span class="o">=</span>-fPIC install
</code></pre></div>
<p>普通的./configure&amp;&amp;make&amp;&amp;make install可不行哟~
然后开始安装tcmalloc:</p>
<div class="highlight"><pre><code class="bash">wget http://google-perftools.googlecode.com/files/google-perftools-1.8.1.tar.gz
tar zxvf google-perftools-1.8.1.tar.gz
<span class="nb">cd </span>google-perftools-1.8.1/
./configure --disable-cpu-profiler --disable-heap-profiler --disable-heap-checker --enable-minimal --disable-dependency-tracking
make <span class="o">&amp;&amp;</span> make install
</code></pre></div>
<p>然后配置动态链接库，因为是之前是默认安装，这里自然就是/usr/local/lib了。</p>
<div class="highlight"><pre><code class="bash"><span class="nb">echo</span> <span class="s2">&quot;/usr/local/lib&quot;</span> &gt; /etc/ld.so.conf.d/usr_local_lib.conf
/sbin/ldconfig
</code></pre></div>
<p>然后给squid加载tcmalloc。官方推荐是重新编译：
先./configure，然后vi src/Makefile，修改如下：</p>
<div class="highlight"><pre><code class="c"><span class="p">....</span>
<span class="n">squid_LDADD</span> <span class="o">=</span>
<span class="o">-</span><span class="n">L</span><span class="p">..</span><span class="o">/</span><span class="n">lib</span> \
<span class="o">-</span><span class="n">ltcmalloc_minimal</span> \
\
<span class="n">repl</span><span class="o">/</span><span class="n">libheap</span><span class="p">.</span><span class="n">a</span> <span class="n">repl</span><span class="o">/</span><span class="n">liblru</span><span class="p">.</span><span class="n">a</span> \
<span class="p">....</span>
<span class="p">....</span>
<span class="n">data_DATA</span> <span class="o">=</span>
<span class="n">mib</span><span class="p">.</span><span class="n">txt</span>
<span class="n">LDADD</span>
<span class="o">=</span> <span class="o">-</span><span class="n">L</span><span class="p">..</span><span class="o">/</span><span class="n">lib</span> <span class="o">-</span><span class="n">lmiscutil</span> <span class="o">-</span><span class="n">lpthread</span> <span class="o">-</span><span class="n">lm</span> <span class="o">-</span><span class="n">lbsd</span> <span class="o">-</span><span class="n">lnsl</span> <span class="o">-</span><span class="n">ltcmalloc_minimal</span>
<span class="n">EXTRA_DIST</span> <span class="o">=</span>
<span class="p">....</span>
</code></pre></div>
<p>保存，make&amp;&amp;make install，OK！
如果不愿意重新编译，那么动态加载吧。在/home/squid/sbin/squid -s之前执行export
LD_PRELOAD=/usr/local/lib/libtcmalloc_minimal.so就可以了。
最后运行lsof -n | grep tcmalloc看看，如果有
squid 3811   root mem REG 202,1 1364560 446102 /usr/local/lib/libtcmalloc.so.0.0.0
squid 3813  squid mem REG 202,1 1364560 446102 /usr/local/lib/libtcmalloc.so.0.0.0
这样的输出，加载成功。效果如何，跑上几天再说咯~
另：
据网上说，如果squid的configure参数中，有&ndash;with-large-files的话，是没法加载tcmalloc的。</p>
      <a href="/2010/01/31/performance-optimization-test-of-tcmalloc-loaded-by-squid-1" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/31/intro-header_replace" title="header_replace试验" rel="bookmark">header_replace试验</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-31 00:00:00 +0800">31 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在linuxtone论坛上，偶见一贴，说采用如下配置，browser就可以正常遵守originserver的过期设置，而且充分利用browser本身的缓存设置，对server来说就可以达到减少304请求的效果，从而提升机器性能，节省带宽云云……</p>
<p>header_access Age deny all
header_replace Age 1</p>
<p>这样reqly_header就显示成：Cache-Control: max-age=1。
（让我很郁闷的一点是squid.conf.default里提供的header_access配置条目不全……）</p>
<p>从之前的cache驻留时间系列里知道，在HTTP的header里，max-age的优先级别高于Expires[Cache-Control&gt;Expires&gt;refresh_pattern&gt;Etag&gt;Last-Modified]。如果这里把max-age改了，那哪里还有地方去控制过期呢？</p>
<p>我想，帖子里估计是写错了，试验一下，果然，其实修改后的header应该是：Age: 1。</p>
<p>这种情况，应该是为了防止Cache-Control: max-age=0的定义导致304的出现（网上看到过一个试验结果，squid最多最多能接受的刷新极限是64秒，我汗，这都有人测试~~）</p>
<p>既然Age永远到不了max-age的限定，自然max-age定义失效了；</p>
<p>接下来试验，refresh_pattern里的max和LM-fator算法是否起作用。结果让我很无语——
配置如右：refresh_pattern .gif$ 2 5% 5 ignore-reload</p>
<p>Date: Sun, 31 Jan 2010 10:32:45 GMT
Last-Modified: Mon, 17 Nov 2008 06:53:22 GMT</p>
<p>LM-fator过期时间应该是(10:32-6:53)*5%=11分钟。max为5分钟。
直到18:50:41还是HIT，Age=1，过期设定失效！</p>
<p>于是我取消http_replace和refresh配置生效后，18:53:15再wget，结果依然HIT，Age=155！</p>
<p>可见，之前LM-fator算法中的说法不完整，squid并不是单按照Date和Last-Modified时间就强制过期，它还得根据Age去判定——这点帖子倒是说对了，完全交给源站控制——问题在于，源站的运维如果真能策划好了这个，又何必让CDN在前端折腾这个age呢？鸡肋呀~~</p>
<hr />
<p>UPDATE：
今天有几个客户切去快网，我在测试时发现，Age就是都被改成了1。除了源站的定义以外，或者快网自认为其提供的刷新API功能很好很强大？？</p>
      <a href="/2010/01/31/intro-header_replace" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/31/anti-hotlinking-by-external_acl" title="防盗链二进阶（squid外部ACL）" rel="bookmark">防盗链二进阶（squid外部ACL）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-31 00:00:00 +0800">31 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>服务器防盗链设置，从最简单的referer判断，到进阶的key+time生成md5值，应该说是比较可靠了，而还有一种防盗链方式，基于IP/COOKIE的，这个我没找到太多有用信息，似乎IIS有个相关插件？
只看到一篇squid的相关文章，简单的举了个防盗链的例子，未必有效（因为把cookie做明文处理，相比md5加密实在是防君子不防小人）。倒是从中学习一下external_acl_type用法，对squid进阶一番罢~~
首先按惯例，上权威：《squid中文权威指南》6.1.3章节和12.5章节。
用法如下：
external_acl_type name [options] FORMAT.. /path/to/helper
[helper arguments..]
options包括：ttl、negtive_ttl、children、concurrency、cache和grace；
FORMAT包括：%LOGIN,%EXT_USER,%IDENT,%SRC,%SRCPORT,%DST,%PROTO,%PORT,%METHOD,%MYADDR,%MYPORT,%PATH,%USER_CERT,%USER_CERTCHAIN,%USER_CERT_xx,%USER_CA_xx,%{Header},%{Hdr:member},%{Hdr:;member},%ACL,%DATA。
外部程序输出结果必须是OK或者ERR，不过可以再带上一些keyword，比如user/passwd，ERR的messages，access.log里记录的%ea等等。
cookie防盗链举例squid/libexec/check_cookie.pl如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="c1"># 这个脚本仅仅是验证了Cache这个cookie的存在，没有严格的校验其值。</span>
<span class="c1"># disable output buffering</span>
<span class="vg">$|</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="k">while</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nb">chop</span><span class="p">;</span>
    <span class="nv">$cookie</span><span class="o">=</span><span class="nv">$_</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="nv">$cookie</span> <span class="o">=~</span><span class="sr"> /$COOKIE/i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s">&quot;OK\n&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s">&quot;ERR\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>squid.conf配置如下：</p>
<div class="highlight"><pre><code class="squid">external_acl_type<span class="w"> </span>download<span class="w"> </span><span class="no">children</span>=15<span class="w"> </span>%{Cookie}<span class="w"> </span>squid/libexec/check_cookie.pl<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>dl<span class="w"> </span>external<span class="w"> </span>download<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>filetype<span class="w"> </span><span class="k">url_regex</span><span class="w"> </span>-i<span class="w"> </span>.wmv<span class="w"> </span>.wma<span class="w"> </span>.asf<span class="w"> </span>.asx<span class="w"> </span>.avi<span class="w"> </span>.mp3<span class="w"> </span>.smi<span class="w"> </span>.rm<span class="w"> </span>.ram<span class="w"> </span>.rmvb<span class="w"> </span>.swf<span class="w"> </span>.mpg<span class="w"> </span>.mpeg<span class="w"> </span>.mov<span class="w"> </span>.zip<span class="w"> </span>.mid<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">deny</span><span class="w"> </span>filetype<span class="w"> </span>!dl<span class="w"></span>
</code></pre></div>
<p>回过头来，想到之前的squid_session一文中，也是用的这个外部ACL~~</p>
      <a href="/2010/01/31/anti-hotlinking-by-external_acl" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/30/solution-of-linuxqq-die-on-ubuntu-9-10" title="ubuntu 9.10下linuxqq经常挂掉的解决方案" rel="bookmark">ubuntu 9.10下linuxqq经常挂掉的解决方案</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-30 00:00:00 +0800">30 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>ubuntu 9.10下linuxqq（官方的QQ，八百年不更新的那个了）</p>
<p>sudo vim /usr/bin/qq
增加</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/sh</span>
<span class="nb">export </span><span class="nv">GDK_NATIVE_WINDOWS</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">cd</span> /usr/share/tencent/qq/
./qq
</code></pre></div>
<p>经试验正确无误。。。linuxqq不再挂。。。五四陈科学院小道报道</p>
<p>原创文章如转载，请注明：转载自五四陈科学院[<a href="http://www.54chen.com]/">http://www.54chen.com]</a>
本文链接: 
<a href="http://www.54chen.com/uncategorized/ubuntu-910-hangs-under-linuxqq-regular-solution.html">http://www.54chen.com/uncategorized/ubuntu-910-hangs-under-linuxqq-regular-solution.html</a></p>
      <a href="/2010/01/30/solution-of-linuxqq-die-on-ubuntu-9-10" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/30/limit-speed-in-nginx-lighttpd" title="限速进阶" rel="bookmark">限速进阶</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-30 00:00:00 +0800">30 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>继续横向比较，之前有squid的限速配置，现在说nginx限速，nginx关于限速的模块有三个：HTTPLimitZoneModule、HTTPCoreModule和HTTPLimitReqModule，详见官方wiki，就不再贴链接了，能不能上天知道，真是地上芙蓉姐，天上绿坝娘呀……</p>
<h1 id="limitzone">limit_zone配置</h1>
<div class="highlight"><pre><code class="nginx"><span class="k">http</span> <span class="p">{</span>
    <span class="kn">limit_zone</span> <span class="no">on</span><span class="s">e</span> <span class="nv">$binary_remote_addr</span> <span class="mi">10m</span><span class="p">;</span> <span class="c1">#每个clientIP定义一个10m大的session容器，根据32bytes/session，可以处理320000个session；</span>
    <span class="kn">server</span> <span class="p">{</span>
        <span class="kn">location</span> <span class="s">/download/</span> <span class="p">{</span>
            <span class="kn">limit_conn</span> <span class="no">on</span><span class="s">e</span> <span class="mi">1</span><span class="p">;</span><span class="c1">#限制一个IP并发连接数为1；</span>
            <span class="kn">limit_rate</span> <span class="mi">300k</span><span class="p">;</span><span class="c1">#限制每个连接数速率为300k；</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>目前网上的情况来看，zone方式的限速用的比较多，或许是较早的版本就支持这个模块吧。</p>
<h1 id="limitreq">limit_req配置</h1>
<div class="highlight"><pre><code class="nginx"><span class="k">http</span> <span class="p">{</span>
    <span class="kn">limit_req_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=one:10m</span> <span class="s">rate=1r/s</span><span class="p">;</span><span class="c1">#限制速率</span>
    <span class="kn">server</span> <span class="p">{</span>
        <span class="kn">location</span> <span class="s">/search/</span> <span class="p">{</span>
            <span class="kn">limit_req</span> <span class="s">zone=one </span> <span class="s">burst=5</span><span class="p">;</span><span class="c1">#限制并发处理数</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>这个模块是nginx0.7.22以后加上的，目前网上基本没什么实际说明，单就这个定义方式来看，感觉和之前的方式也没什么区别，a*b=c，一个定义a和b，一个定义b和c……
或许只能去wiki死磕英文才能搞清楚一点点吧~~</p>
<p>然后是lighttpd的限速：</p>
<p>lighttpd限速也是有两个方式，server.kbytes-per-second（对域名路径限制）和connection.kbytes-per-second（对单一连接限制），问题在于没有对并发连接数的限制（也就是上面我写的算式里的b）。而且是kbytes不是kbits，根据网友的说法，当期望限制在60Mb的时候，配置成：server.kbytes-per-second = 1800就差不多了……</p>
<h1 id="section">限速配置</h1>
<div class="highlight"><pre><code class="lighttpd"><span class="k">connection.kbytes-per-second</span> <span class="o">=</span> <span class="m">30</span> <span class="c1">#单个连接不能超过30KB/s</span>
<span class="nb">$HTTP</span><span class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;download.linuxfly.org&quot;</span> <span class="p">{</span>
    <span class="k">server.name</span> <span class="o">=</span> <span class="s2">&quot;download.linuxfly.org&quot;</span>
    <span class="k">server.document-root</span> <span class="o">=</span> <span class="s2">&quot;/var/www/html/iso&quot;</span>
    <span class="k">accesslog.filename</span> <span class="o">=</span> <span class="s2">&quot;/var/log/lighttpd/iso-access.log&quot;</span>
    <span class="nb">$HTTP</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=~</span> <span class="s2">&quot;^/download/&quot;</span> <span class="p">{</span>
        <span class="k">dir-listing.activate</span> <span class="o">=</span> <span class="s2">&quot;enable&quot;</span>
        <span class="k">server.kbytes-per-second</span> <span class="o">=</span> <span class="m">100</span> <span class="c1">#/download路径下可用的最大是100KB/s</span>
    <span class="p">}</span>
    <span class="k">server.kbytes-per-second</span> <span class="o">=</span> <span class="m">200</span> <span class="c1">#除/download路径外，该域可用的最大带宽是200KB/s</span>
<span class="p">}</span>
</code></pre></div>
<p>最后，不要忘记lighttpd的单线程程序，还要受限于linux系统的单线程打开文件数限制。</p>
<p>lighttpd官方，还提供一个plugin方式，见http://redmine.lighttpd.net/projects/lighttpd/wiki/Docs:TrafficShaping。
这个需要在php代码中定制header来配合lighttpd。总的来说，lighttpd限速功能是不咋的……</p>
<div class="highlight"><pre><code class="bash"><span class="c">#打补丁</span>
wget http://redmine.lighttpd.net/attachments/697/mod_speed.c
mv mod_speed.c lighttpd_1.5/src/
cat &gt;&gt;Makefile.am
<span class="s">&lt;&lt;EOF</span>
<span class="s">lib_LTLIBRARIES += mod_speed.la</span>
<span class="s">mod_speed_la_SOURCES = mod_speed.c</span>
<span class="s">mod_speed_la_LDFLAGS = -module -export-dynamic -avoid-version -no-undefined</span>
<span class="s">mod_speed_la_LIBADD = $(common_libadd)</span>
<span class="s">EOF</span>
</code></pre></div>
<h1 id="plugin">plugin配置参数</h1>
<div class="highlight"><pre><code class="lighttpd"><span class="k">speed.just-copy-header</span> <span class="o">=</span> <span class="s2">&quot;enable&quot;</span>
<span class="k">speed.use-request</span> <span class="o">=</span> <span class="s2">&quot;enable&quot;</span>
</code></pre></div>
<p>//php定制header代码//</p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="nx">header</span><span class="p">(</span><span class="s2">&quot;X-LIGHTTPD-KBytes-per-second: 50&quot;</span><span class="p">);</span>
<span class="nx">header</span><span class="p">(</span><span class="s2">&quot;X-Sendfile: /path/to/file&quot;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
      <a href="/2010/01/30/limit-speed-in-nginx-lighttpd" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/30/anti-hotlinking-in-nginx-lighttpd-squid" title="防盗链进阶（nginx、lighttpd和squid类比）" rel="bookmark">防盗链进阶（nginx、lighttpd和squid类比）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-30 00:00:00 +0800">30 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在折腾squid的rewrite.pl时，参考的是公司原有的一个防盗链脚本。如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#! /usr/bin/env perl</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Digest::</span><span class="n">MD5</span> <span class="sx">qw(md5_hex)</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(difftime mktime)</span><span class="p">;</span>
<span class="vg">$|</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$errUrl</span> <span class="o">=</span> <span class="s">&quot;http://www.test.com/no_such_url.html&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$secret</span> <span class="o">=</span> <span class="s">&quot;123456&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$expired</span> <span class="o">=</span> <span class="mi">7200</span><span class="p">;</span>
<span class="k">while</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="nv">$client</span><span class="p">,</span> <span class="nv">$ident</span><span class="p">,</span> <span class="nv">$method</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;$errUrln&quot;</span> <span class="ow">and</span> <span class="k">next</span> <span class="k">unless</span> <span class="p">(</span><span class="nv">$uri</span> <span class="o">=~</span> <span class="n">m</span><span class="c1">#^(http://w*.?test.com)/(d{4})(d{2})(d{2})(d{2})(d{2})/(w{32})(/.+.mp3)$#i);</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$domain</span><span class="p">,</span> <span class="nv">$year</span><span class="p">,</span> <span class="nv">$mon</span><span class="p">,</span> <span class="nv">$mday</span><span class="p">,</span> <span class="nv">$hour</span><span class="p">,</span> <span class="nv">$min</span><span class="p">,</span> <span class="nv">$md5</span><span class="p">,</span> <span class="nv">$path</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$1</span><span class="p">,</span> <span class="nv">$2</span><span class="p">,</span> <span class="nv">$3</span><span class="p">,</span> <span class="nv">$4</span><span class="p">,</span> <span class="nv">$5</span><span class="p">,</span> <span class="nv">$6</span><span class="p">,</span> <span class="nv">$7</span><span class="p">,</span> <span class="nv">$8</span><span class="p">);</span>
    <span class="k">print</span> <span class="s">&quot;$errUrl\n&quot;</span> <span class="ow">and</span> <span class="k">next</span> <span class="k">if</span> <span class="nv">$year</span> <span class="o">&lt;</span> <span class="mi">1990</span> <span class="ow">or</span> <span class="nv">$mon</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nv">$mon</span> <span class="o">&gt;</span> <span class="mi">12</span> <span class="ow">or</span> <span class="nv">$mday</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nv">$mday</span> <span class="o">&gt;</span> <span class="mi">31</span> <span class="ow">or</span> <span class="nv">$hour</span> <span class="o">&gt;</span> <span class="mi">23</span> <span class="ow">or</span> <span class="nv">$min</span> <span class="o">&gt;</span> <span class="mi">59</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;$errUrl\n&quot;</span> <span class="ow">and</span> <span class="k">next</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">difftime</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="nb">time</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="n">mktime</span><span class="p">(</span><span class="mo">00</span><span class="p">,</span> <span class="nv">$min</span><span class="p">,</span> <span class="nv">$hour</span><span class="p">,</span> <span class="nv">$mday</span><span class="p">,</span> <span class="nv">$mon</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$year</span> <span class="o">-</span> <span class="mi">1900</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="nv">$expired</span><span class="p">;</span>
    <span class="nv">$path</span> <span class="o">=~</span> <span class="n">s</span><span class="c1">#%(..)#pack(&quot;c&quot;, hex($1))#eg;</span>
    <span class="k">print</span> <span class="s">&quot;$errUrl\n&quot;</span> <span class="ow">and</span> <span class="k">next</span> <span class="k">if</span> <span class="nv">$md5</span> <span class="ow">ne</span> <span class="n">md5_hex</span><span class="p">(</span><span class="nv">$secret</span> <span class="o">.</span> <span class="nv">$year</span> <span class="o">.</span> <span class="nv">$mon</span> <span class="o">.</span> <span class="nv">$mday</span> <span class="o">.</span> <span class="nv">$hour</span> <span class="o">.</span> <span class="nv">$min</span> <span class="o">.</span> <span class="nv">$path</span><span class="p">);</span>
    <span class="k">print</span> <span class="nv">$domain</span> <span class="o">.</span> <span class="nv">$path</span><span class="p">,</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>今天在网上看到lighttpd相似的配置。lighttpd自带mod_secdownload模块实现这种防盗链方法。具体配置及php代码如下例（详见http://trac.lighttpd.net/trac/wiki/Docs%3AModSecDownload）：</p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?</span>
<span class="nv">$secret</span> <span class="o">=</span> <span class="s2">&quot;verysecret&quot;</span><span class="p">;</span><span class="err"> </span> <span class="c1">//加密字符串，必须跟lighttpd.conf里边保持一致</span>
<span class="nv">$uri_prefix</span> <span class="o">=</span> <span class="s2">&quot;/dl/&quot;</span><span class="p">;</span><span class="err">   </span> <span class="c1">//虚拟的路径，必须跟lighttpd.conf里边保持一致</span>
<span class="c1"># filename</span>
<span class="nv">$f</span> <span class="o">=</span> <span class="s2">&quot;/secret-file.txt&quot;</span><span class="p">;</span><span class="err"> </span> <span class="c1">//实际文件名，必须要加&quot;/&quot;斜杠</span>
<span class="c1"># current timestamp</span>
<span class="nv">$t</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<span class="nv">$t_hex</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;%08x&quot;</span><span class="p">,</span> <span class="nv">$t</span><span class="p">);</span>
<span class="nv">$m</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$secret</span><span class="o">.</span><span class="nv">$f</span><span class="o">.</span><span class="nv">$t_hex</span><span class="p">);</span>
<span class="c1"># generate link</span>
<span class="nb">printf</span><span class="p">(</span><span class="s1">&#39;%s&#39;</span><span class="p">,</span> <span class="nv">$uri_prefix</span><span class="p">,</span> <span class="nv">$m</span><span class="p">,</span> <span class="nv">$t_hex</span><span class="p">,</span> <span class="nv">$f</span><span class="p">,</span> <span class="nv">$f</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>lighttpd配置文件:  <br />
server.modules = ( &hellip;, &ldquo;mod_secdownload&rdquo;, &hellip; )
secdownload.secret          = &ldquo;verysecret&rdquo;
secdownload.document-root   = &ldquo;/home/www/servers/download-area/&rdquo;
secdownload.uri-prefix      = &ldquo;/dl/&rdquo;
secdownload.timeout         = 10</p>
<p>nginx也有类似功能，不过不是自带，secure_link_module模块，打补丁需要重编译：</p>
<p>wget http://www.sbear.cn/wp-content/uploads/2009/09/nginx-secure-link-ttl.patch
cd nginx-0.7.62
patch -p1 &lt; ../nginx-secure-link-ttl.patch
./configure &ndash;with-http_secure_link_module
……
具体配置及php例子如下（详见http://wiki.nginx.org/NginxHttpSecureLinkModule）：</p>
<div class="highlight"><pre><code class="nginx"><span class="k">location</span> <span class="s">/down/</span> <span class="p">{</span>
    <span class="kn">secure_link_secret</span> <span class="s">&quot;sbear.cn&quot;</span><span class="p">;</span><span class="kn"> </span> <span class="s">//密钥</span>
    <span class="s">secure_link_ttl</span> <span class="no">on</span><span class="p">;</span>
    <span class="kn">root</span> <span class="s">/data/test/down</span><span class="p">;</span>
    <span class="kn">if</span> <span class="s">(</span><span class="nv">$secure_link</span> <span class="p">=</span> <span class="s">&quot;&quot;)</span> <span class="p">{</span>
        <span class="kn">return</span> <span class="mi">403</span><span class="p">;</span>
<span class="p">}</span>
    <span class="kn">rewrite</span> <span class="s">^</span> <span class="s">/</span><span class="nv">$secure_link</span> <span class="s">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="nb">define</span><span class="p">(</span><span class="nx">URL_TIMEOUT</span><span class="p">,</span> <span class="mi">3600</span><span class="p">);</span> <span class="c1">//这里设置过期时间单位是秒</span>
<span class="nv">$prefix</span> <span class="o">=</span> <span class="s2">&quot;&lt;a href=&quot;</span><span class="nx">http</span><span class="o">://</span><span class="nx">www</span><span class="o">.</span><span class="nx">sbear</span><span class="o">.</span><span class="nx">cn</span><span class="o">/</span><span class="nx">down</span><span class="o">&amp;</span><span class="nx">quot</span><span class="p">;;</span><span class="s2">&quot;&gt;http://www.sbear.cn/down&quot;</span><span class="p">;</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
<span class="nv">$protected_resource</span> <span class="o">=</span> <span class="s2">&quot;test.exe&quot;</span><span class="p">;</span>
<span class="nv">$secret</span> <span class="o">=</span> <span class="s2">&quot;sbear.cn&quot;</span><span class="p">;</span><span class="err"> </span> <span class="c1">//密钥</span>
<span class="nv">$time</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="nb">time</span><span class="p">()</span> <span class="o">+</span> <span class="nx">URL_TIMEOUT</span><span class="p">);</span>
<span class="nv">$timeout</span> <span class="o">=</span> <span class="nb">bin2hex</span><span class="p">(</span><span class="nv">$time</span><span class="p">);</span>
<span class="nv">$hashmac</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span> <span class="nv">$protected_resource</span> <span class="o">.</span> <span class="nv">$time</span> <span class="o">.</span> <span class="nv">$secret</span> <span class="p">);</span>
<span class="nv">$url</span> <span class="o">=</span> <span class="nv">$prefix</span> <span class="o">.</span> <span class="s2">&quot;/&quot;</span> <span class="o">.</span> <span class="nv">$hashmac</span> <span class="o">.</span> <span class="nv">$timeout</span> <span class="o">.</span> <span class="s2">&quot;/&quot;</span> <span class="o">.</span> <span class="nv">$protected_resource</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;down&quot;</span><span class="p">;</span>
<span class="k">echo</span> <span class="nb">time</span><span class="p">();</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>那不打补丁，有什么防盗链的办法么？当然有。nginx和lighttpd都支持最简单的referer判断。</p>
<p>nginx有ngx_http_referer_module模块，和apache、squid一样可以rewrite，配置如下：</p>
<div class="highlight"><pre><code class="nginx"><span class="k">location</span> <span class="p">~</span><span class="sr">*</span> <span class="s">.(gif|jpg|png)</span>$ <span class="p">{</span>
<span class="kn">valid_referers</span> <span class="s">none</span> <span class="s">blocked</span> <span class="s">www.test.com</span> <span class="s">baidu.com</span><span class="p">;</span>
    <span class="kn">if</span> <span class="s">(</span><span class="nv">$invalid_referer</span><span class="s">)</span> <span class="p">{</span>
        <span class="kn">rewrite</span> <span class="s">^/</span> <span class="s">http://www.test.com/error.html</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>lighttpd配置如下：</p>
<p>$HTTP[&ldquo;referer&rdquo;] !~ &ldquo;^(http://.<em>.(test.com|baidu.cn))&rdquo;
{
    $HTTP[&ldquo;url&rdquo;] =~ &ldquo;.(jpg|jpeg|png|gif|rar|zip|mp3|swf|flv|wmv|rm|avi)$&rdquo; {
        url.redirect = (&ldquo;.</em>&ldquo;    =&gt; http://www.test.com/&rdquo;)
    }
}
不过还是那句话，这个功能破解起来确实太容易，呵呵~</p>
<p>除了上面说的NginxHttpSecureLinkModule，还有另一个模块ngx_http_accesskey_module，其工作原理是根据client的IP，加上配置定义的key，生成32位MD5值，然后进行匹配。详见http://wiki.codemongers.com/NginxHttpAccessKeyModule，不过我这居然打不开……只好详见网友博客了：
wget <a href="http://wiki.nginx.org/File:Nginx-accesskey-2.0.3.tar.gz">http://wiki.nginx.org/File:Nginx-accesskey-2.0.3.tar.gz</a>
tar zxvf Nginx-accesskey-2.0.3.tar.gz
sed -i &lsquo;s/$HTTP_ACCESSKEY_MODULE/ngx_http_accesskey_module/g nginx-accesskey/config
./configure &ndash;add-module=/path/to/nginx-accesskey
#配置文件
location /download {
    accesskey on;
    accesskey_hashmethod md5;
    accesskey_arg “key”;
    accesskey_signature “mypass$remote_addr”;
}
//php测试页面，$output_add_key正常，$output_org_url返回403//
<?
$ipkey= md5("mypass".$_SERVER['REMOTE_ADDR']);
$output_add_key="<a href="http://www.example.cn/download/G3200507120520LM.rar?key=">http://www.example.cn/download/G3200507120520LM.rar?key="</a>.$ipkey.">download_add_key<br
/>";
$output_org_url="<a href=<a href="http://www.example.cn/download/G3200507120520LM.rar">http://www.example.cn/download/G3200507120520LM.rar</a>>download_org_path<br
/>";
echo $output_add_key;
echo $output_org_url;
?>
而另一个博客这么说：
wget http://www.ieesee.net:8080/~uingei/nginx-accesskey-2.0.3.diff.bz2
cd nginx-0.7.14
bzcat ../nginx-accesskey-2.0.3.diff.bz2 | patch -p1
./configure &ndash;with-http_accesskey_module &hellip;
根据我的观察，这个应该是最初的办法。另，该博客说sec_link是nginx0.7.18后加的官方模块。</p>
      <a href="/2010/01/30/anti-hotlinking-in-nginx-lighttpd-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/29/intro-cronolog-logrotate" title="日志管理" rel="bookmark">日志管理</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-29 00:00:00 +0800">29 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>第一个，最常见的cronolog，因为他配对apache，apache太常见，所以cronolog也就常见了~~稳定版本1.6.2，似乎不支持2G以上的日志，因为那时候linux内核也不支持。。。现在有beta版可以，另据网友分析，其实只要修改1.6.2源代码中的openfile函数成openfile64就行了……
使用方法：</p>
<pre><code>CustomLog "|/usr/local/sbin/cronolog /var/log/httpd/www/access%Y%m%d.log" combined
</code></pre>
<p>其实就是利用管道，传递给cronolog记录日志。
对于不支持在配置文件里利用管道的，也有别的变通办法，比如命名管道。像nginx日志就能这么做：</p>
<p>mkfifo /path/to/nginx/logs/access_log_pipe
/path/to/cronolog /path/to/log/access_%Y%m%d.log /path/to/nginx/logs/access_log_pipe &amp;</p>
<p>然后编辑nginx.conf，修改如下：</p>
<p>access_log /path/to/nginx/logs/access_log_pipe combined</p>
<p>最后要注意的是，必须在启动nginx之前，先启动cronolog。</p>
<p>第二个，系统自带的logrotate，一般系统本身的syslog、crond、yum等，都是用它。对于不必要保存所有的日志，采用这个回滚程式正当其时。/etc/logrotate.conf默认配置不算太复杂，还能使用include，不过其全部参数真是不少，如下表：</p>
<pre><code>参数			功能
compress			通过gzip 压缩转储以后的日志
nocompress			不需要压缩时，用这个参数
copytruncate		用于还在打开中的日志文件，把当前日志备份并截断
nocopytruncate		备份日志文件但是不截断
create			mode owner group 转储文件，使用指定的文件模式创建新的日志文件
nocreate			不建立新的日志文件
delaycompress		和 compress 一起使用时，转储的日志文件到下一次转储时才压缩
nodelaycompress		覆盖 delaycompress 选项，转储同时压缩。
errors			address 专储时的错误信息发送到指定的Email 地址
ifempty			即使是空文件也转储，这个是 logrotate 的缺省选项。
notifempty			如果是空文件的话，不转储
mail			address 把转储的日志文件发送到指定的E-mail 地址
nomail			转储时不发送日志文件
olddir			directory 转储后的日志文件放入指定的目录，必须和当前日志文件在同一个文件系统
noolddir			转储后的日志文件和当前日志文件放在同一个目录下
prerotate/endscript		在转储以前需要执行的命令可以放入这个对，这两个关键字必须单独成行
postrotate/endscript	在转储以后需要执行的命令可以放入这个对，这两个关键字必须单独成行
daily			指定转储周期为每天
weekly			指定转储周期为每周
monthly			指定转储周期为每月
rotate			count 指定日志文件删除之前转储的次数，0 指没有备份，5 指保留5 个备份
tabootext			[+] list 让logrotate 不转储指定扩展名的文件，缺省的扩展名是：.rpm-orig,
.rpmsave,			v, 和 ~
size			size 当日志文件到达指定的大小时才转储，Size可以指定bytes(缺省)以及KB(sizek)或者MB (sizem).
</code></pre>
<p>第三个，newsyslog，这个东西感觉是logrotate的兄弟版，因为其配置文件写法都是采用｛｝的方式，而且命名也这么针锋相对的。习惯了用logrotate的，对于不能回滚而要求分割保留的，可以试试这个。</p>
<p>logrotate的写法举例：</p>
<p>/path/to/wtmp{
    daily
    minsize 5M
    create 0644 root utmp
    rotate 1
}
newsyslog的写法举例：</p>
<pre><code>set squid_logpath = /usr/local/squid/var/logs
set squid_log = /usr/local/squid/var/logs/access.log
set date_squid_log = /usr/local/squid/var/logs/access%Y%M%D.log
SQUID{
    restart: run
    /usr/local/squid/sbin/squid -k rotate
    log:  SQUID
    squid_log squid squid 644
    archive:
    SQUID date_squid_log 0
}
</code></pre>
<p>第四个，也是万能的一个，嗯，就是自己写脚本，定时gzip……</p>
      <a href="/2010/01/29/intro-cronolog-logrotate" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/28/transparent-by-ports" title="端口转发" rel="bookmark">端口转发</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-28 00:00:00 +0800">28 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>常见的linux端口转发，是iptables方式，方法如下：</p>
<div class="highlight"><pre><code class="bash"><span class="c">#modprobe iptable_nat</span>
<span class="c">#modprobe ip_conntrack</span>
<span class="c">#service iptables stop</span>
<span class="c">#echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span>
<span class="c">#iptables -t nat -I PREROUTING -p tcp --dport 443 -j DNAT --to 1.2.3.4</span>
<span class="c">#iptables -t nat -I POSTROUTING -p tcp --dport 8081 -j MASQUERADE</span>
<span class="c">#service iptables save</span>
<span class="c">#service iptables start</span>
</code></pre></div>
<p>其次网上有不少推荐rinetd，方法如下：</p>
<div class="highlight"><pre><code class="bash"><span class="c">#wget http://www.boutell.com/rinetd/http/rinetd.tar.gz</span>
<span class="c">#tar zxvf rinetd.tar.gz</span>
<span class="c">#cd rinted</span>
<span class="c">#./configure &amp;&amp; make &amp;&amp; make install</span>
<span class="c"># cat /etc/rinetd.conf</span>
0.0.0.0 443 www.test.com 443 allow *.*.*.*
logfile /var/log/rinetd.log
</code></pre></div>
<p>看起来比iptables有个优势，可以采用域名解析，可惜做不到根据域名的不同，把相同端口的请求转向不同IP，其实也就跟直接写IP没多少区别了。
第三还有ssh的端口转发，其实是把原TCP端口的数据转由ssh通道传输。方法如下：
本地转发：ssh -g -L <local port="">:<remote host="">:
远程转发：ssh -g -R <local port="">:<remote host="">:
不过客户未必（或许说基本不可能）给外人开放ssh吧~~
第四，socket网络编程实现。我在网上发现了相关的perl脚本。
例一代码如下：</remote></local></remote></local></p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!C:Perlbinperl.exe</span>
<span class="c1">#端口重定向(fork、IO::Select）</span>
<span class="c1">#By shanleiguang@gmail.com, 2005/10</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">IO::</span><span class="n">Socket</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">IO::</span><span class="n">Select</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Std</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(:sys_wait_h strftime)</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">FOREVER</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">BUFSIZE</span> <span class="o">=&gt;</span> <span class="mi">4096</span><span class="p">;</span>
<span class="c1">#父进程下处理僵死子进程</span>
<span class="k">sub </span><span class="nf">zombie_reaper</span> <span class="p">{</span>
<span class="k">while</span><span class="p">(</span><span class="nb">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">WNOHANG</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
<span class="nv">$SIG</span><span class="p">{</span><span class="n">CHLD</span><span class="p">}</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zombie_reaper</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$SIG</span><span class="p">{</span><span class="n">CHLD</span><span class="p">}</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zombie_reaper</span><span class="p">;</span>
<span class="c1">#处理参数</span>
<span class="k">my</span> <span class="nv">%opts</span><span class="p">;</span>
<span class="n">getopts</span><span class="p">(</span><span class="s">&#39;h:l:t:p:&#39;</span><span class="p">,</span> <span class="nv">%opts</span><span class="p">);</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;h&#39;</span><span class="p">}));</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;t&#39;</span><span class="p">})</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;p&#39;</span><span class="p">}));</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;t&#39;</span><span class="p">}</span> <span class="o">!~</span> <span class="sr">m/^d+.d+.d+.d+$/</span><span class="p">);</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;l&#39;</span><span class="p">}</span> <span class="o">!~</span> <span class="sr">m/^d+$/</span><span class="p">);</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;p&#39;</span><span class="p">}</span> <span class="o">!~</span> <span class="sr">m/^d+$/</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$listen_port</span> <span class="o">=</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;l&#39;</span><span class="p">}))</span> <span class="p">?</span> <span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;l&#39;</span><span class="p">}</span> <span class="p">:</span> <span class="mi">8080</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$target_ip</span><span class="err">  </span> <span class="o">=</span> <span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;t&#39;</span><span class="p">};</span>
<span class="k">my</span> <span class="nv">$target_port</span> <span class="o">=</span> <span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;p&#39;</span><span class="p">};</span>
<span class="c1">#在本地创建监听Socket</span>
<span class="k">my</span> <span class="nv">$socket_listen</span><span class="err"> </span> <span class="o">=</span> <span class="nn">IO::Socket::</span><span class="n">INET</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
<span class="n">LocalPort</span> <span class="o">=&gt;</span> <span class="nv">$listen_port</span><span class="p">,</span>
<span class="n">Proto</span>     <span class="o">=&gt;</span> <span class="s">&#39;tcp&#39;</span><span class="p">,</span>
<span class="n">Listen</span><span class="err">   </span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span>
<span class="n">Reuse</span>     <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">);</span>
<span class="k">print</span> <span class="n">timestamp</span><span class="p">(),</span> <span class="s">&quot;, listening on port $listen_port ...n&quot;</span><span class="p">;</span>
<span class="c1">#新建两个用于Socket IO监视的IO::Select对象</span>
<span class="k">my</span> <span class="nv">$readers</span> <span class="o">=</span> <span class="nn">IO::</span><span class="n">Select</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
<span class="k">my</span> <span class="nv">$writers</span> <span class="o">=</span> <span class="nn">IO::</span><span class="n">Select</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
<span class="nv">$readers</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="nv">$socket_listen</span><span class="p">);</span>
<span class="c1">#父进程仅监视Listening Socket的accept事件</span>
<span class="k">while</span><span class="p">(</span><span class="n">FOREVER</span><span class="p">)</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">@readers</span> <span class="o">=</span> <span class="nv">$readers</span><span class="o">-&gt;</span><span class="n">can_read</span><span class="p">;</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$reader</span> <span class="p">(</span><span class="nv">@readers</span><span class="p">)</span> <span class="p">{</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$reader</span> <span class="ow">eq</span> <span class="nv">$socket_listen</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">#创建子进程处理后续的转发，父进程继续监视Listening Socket</span>
<span class="nb">fork</span> <span class="ow">and</span> <span class="k">next</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$socket_client</span> <span class="o">=</span> <span class="nv">$socket_listen</span><span class="o">-&gt;</span><span class="nb">accept</span><span class="p">();</span>
<span class="c1">#在子进程中，不再需要对Listening Socket进行操作</span>
<span class="nv">$readers</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="nv">$socket_listen</span><span class="p">);</span>
<span class="nv">$socket_listen</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">();</span>
<span class="c1">#子进程</span>
<span class="n">as_server</span><span class="p">(</span><span class="nv">$socket_client</span><span class="p">);</span>
<span class="nb">exit</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="c1">#子进程</span>
<span class="k">sub </span><span class="nf">as_server</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">$socket_client</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$client_port</span> <span class="o">=</span> <span class="nv">$socket_client</span><span class="o">-&gt;</span><span class="n">peerport</span><span class="p">();</span>
<span class="k">my</span> <span class="nv">$client_ip</span><span class="err">  </span> <span class="o">=</span> <span class="nv">$socket_client</span><span class="o">-&gt;</span><span class="n">peerhost</span><span class="p">();</span>
<span class="c1">#创建到目标地址:端口的Socket连接</span>
<span class="k">my</span> <span class="nv">$socket_forward</span> <span class="o">=</span> <span class="nn">IO::Socket::</span><span class="n">INET</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
<span class="n">PeerAddr</span> <span class="o">=&gt;</span> <span class="nv">$target_ip</span><span class="p">,</span>
<span class="n">PeerPort</span> <span class="o">=&gt;</span> <span class="nv">$target_port</span>
<span class="p">);</span>
<span class="k">print</span> <span class="n">timestamp</span><span class="p">(),</span> <span class="s">&quot;, $client_ip:$client_port$target_ip:$target_port.n&quot;</span><span class="p">;</span>
<span class="c1">#监视socket_client、socket_forward的IO情况</span>
<span class="nv">$readers</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="nv">$socket_client</span><span class="p">);</span>
<span class="nv">$readers</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="nv">$socket_forward</span><span class="p">);</span>
<span class="nv">$writers</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="nv">$socket_client</span><span class="p">);</span>
<span class="nv">$writers</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="nv">$socket_forward</span><span class="p">);</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$rbuffer_forward</span><span class="p">,</span> <span class="nv">$rbuffer_client</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
<span class="k">while</span><span class="p">(</span><span class="n">FOREVER</span><span class="p">)</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">@readers</span> <span class="o">=</span> <span class="nv">$readers</span><span class="o">-&gt;</span><span class="n">can_read</span><span class="p">;</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$reader</span> <span class="p">(</span><span class="nv">@readers</span><span class="p">)</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">$rbuffer</span><span class="p">;</span>
<span class="c1">#当socket_client可读时，将读取的内容追加到rbuffer_client后</span>
<span class="c1">#假如读取失败，则退出子进程</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$reader</span> <span class="ow">eq</span> <span class="nv">$socket_client</span><span class="p">)</span> <span class="p">{</span>
<span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">recv</span><span class="p">(</span><span class="nv">$reader</span><span class="p">,</span> <span class="nv">$rbuffer</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="nv">$rbuffer_client</span><span class="o">.=</span> <span class="nv">$rbuffer</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">#当socket_forward可读时，将读取的内容追加到rbuffer_forward后</span>
<span class="c1">#假如读取失败，则退出子进程</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$reader</span> <span class="ow">eq</span> <span class="nv">$socket_forward</span><span class="p">)</span> <span class="p">{</span>
<span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">recv</span><span class="p">(</span><span class="nv">$reader</span><span class="p">,</span> <span class="nv">$rbuffer</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="nv">$rbuffer_forward</span> <span class="o">.=</span> <span class="nv">$rbuffer</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="k">my</span> <span class="nv">@writers</span> <span class="o">=</span> <span class="nv">$writers</span><span class="o">-&gt;</span><span class="n">can_write</span><span class="p">;</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$writer</span> <span class="p">(</span><span class="nv">@writers</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">#当socket_client可写，且rbuffer_forward不为空时，将rbuffer_forward</span>
<span class="c1">#内容写入socket_client，假如写失败，则退出子进程</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$writer</span> <span class="ow">eq</span> <span class="nv">$socket_client</span><span class="p">)</span> <span class="p">{</span>
<span class="k">next</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nv">$rbuffer_forward</span><span class="p">);</span>
<span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">send</span><span class="p">(</span><span class="nv">$writer</span><span class="p">,</span> <span class="nv">$rbuffer_forward</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="nv">$rbuffer_forward</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">#当socket_forward可写，且rbuffer_client不为空时，将rbuffer_client</span>
<span class="c1">#内容写入socket_forward，假如写失败，则退出子进程</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$writer</span> <span class="ow">eq</span> <span class="nv">$socket_forward</span><span class="p">)</span> <span class="p">{</span>
<span class="k">next</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nv">$rbuffer_client</span><span class="p">);</span>
<span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">send</span><span class="p">(</span><span class="nv">$writer</span><span class="p">,</span> <span class="nv">$rbuffer_client</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="nv">$rbuffer_client</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">timestamp</span> <span class="p">{</span>
<span class="k">return</span> <span class="n">strftime</span> <span class="s">&quot;[%y/%m/%d,%H:%M:%S]&quot;</span><span class="p">,</span> <span class="nb">localtime</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">print_help</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">$filename</span> <span class="o">=</span> <span class="p">(</span><span class="nb">split</span> <span class="o">/\/</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
<span class="k">print</span> <span class="s">&lt;&lt;HELP</span>
<span class="s">&gt;&gt;&gt;</span>
<span class="s">$filename [-h,-l:]</span>
<span class="s"> -h  print help</span>
<span class="s"> -l  listening local port, default 8080</span>
<span class="s"> -t  target ipaddr</span>
<span class="s"> -p  target port</span>
<span class="s">By shanleiguang@gmail.com, 2005/10</span>
<span class="s">HELP</span>
<span class="p">}</span>
</code></pre></div>
<p>例二代码如下：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!C:Perlbinperl.exe</span>
<span class="c1">#端口重定向（POE）</span>
<span class="c1">#By shanleiguang@gmail.com, 2005/10</span>
<span class="c1">#POE结构：</span>
<span class="c1">#</span>
<span class="c1">#Driver-&gt;Filter-&gt;Wheel-&gt;Components</span>
<span class="c1">#</span>
<span class="o">|</span><span class="n">______</span><span class="o">|</span><span class="n">______</span><span class="o">|</span><span class="n">________</span><span class="o">|</span>
<span class="c1">#</span>
<span class="o">|</span>
<span class="c1">#          Session</span>
<span class="c1">#</span>
<span class="o">|</span>
<span class="c1"># Kernel</span>
<span class="c1">#</span>
<span class="c1">#Driver：    底层文件操作的抽象，在编程时不会直接用到</span>
<span class="c1">#Filter：    底层、中层协议操作的抽象，通常不会直接用到</span>
<span class="c1">#Wheel：     高层协议操作的抽象，经常要用到</span>
<span class="c1">#Components：POE提供的一些拿来就能用的组件</span>
<span class="c1">#Session：   会话抽象，会话中需要创建高层协议抽象</span>
<span class="c1">#Kernel：    POE管理会话的内核</span>
<span class="c1">#</span>
<span class="c1">#POE对象的数据结构：</span>
<span class="c1">#</span>
<span class="c1">#$_[HEAP]：是会话唯一的数据存储区；</span>
<span class="c1">#$_[SESSION]：是指向会话自身的引用；</span>
<span class="c1">#$_[KERNEL]：是指向会话管理内核的引用；</span>
<span class="c1">#@_[ARG0..ARG9]：用于传递给各事件处理函数的参数；</span>
<span class="c1">#</span>
<span class="c1">#还是实例最直观：</span>
<span class="c1">#在父会话中创建一个监听用的Socket，当有客户端连接，即有accept_sucess事件发生时，</span>
<span class="c1">#则创建一个子会话处理后续事件，并将accept获得的客户端Socket传递给子会话；子会话</span>
<span class="c1">#创建到目标的Socket，连接过程中，如果客户端Socket中有input事件，则将客户端的input</span>
<span class="c1">#内容缓存在一个队列中，当连接成功后，发送给到目标的那个Socket中，见下图：</span>
<span class="c1">#</span>
<span class="c1">#          +-------------------------------+</span>
<span class="c1">#         /|      Socket_listen            |</span>
<span class="c1">#        / +-------------------------------+</span>
<span class="c1">#Client|Socket_client Socket_server|Target</span>
<span class="c1">#          +-------------------------------+</span>
<span class="c1">#                    Forwarder</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Socket</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Std</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(strftime)</span><span class="p">;</span>
<span class="k">use</span> <span class="n">POE</span> <span class="sx">qw(</span>
<span class="sx">Wheel::SocketFactory</span>
<span class="sx">Wheel::ReadWrite</span>
<span class="sx">Filter::Stream</span>
<span class="sx">)</span><span class="p">;</span>
<span class="c1">#Get Options</span>
<span class="k">my</span> <span class="nv">%opts</span><span class="p">;</span>
<span class="n">getopts</span><span class="p">(</span><span class="s">&#39;hl:t:p:&#39;</span><span class="p">,</span> <span class="nv">%opts</span><span class="p">);</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;h&#39;</span><span class="p">}));</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;t&#39;</span><span class="p">})</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;p&#39;</span><span class="p">}));</span>
<span class="n">print_help</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;t&#39;</span><span class="p">}</span> <span class="o">!~</span> <span class="sr">m/^d+.d+.d+.d+$/</span><span class="p">);</span>
<span class="n">print_hekp</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">exit</span> <span class="k">if</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;p&#39;</span><span class="p">}</span> <span class="o">!~</span> <span class="sr">m/^d+$/</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$listen_port</span> <span class="o">=</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;l&#39;</span><span class="p">}))</span> <span class="p">?</span> <span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;l&#39;</span><span class="p">}</span> <span class="p">:</span> <span class="mi">8080</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$target_addr</span> <span class="o">=</span> <span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;t&#39;</span><span class="p">};</span>
<span class="k">my</span> <span class="nv">$target_port</span> <span class="o">=</span> <span class="nv">$opts</span><span class="p">{</span><span class="s">&#39;p&#39;</span><span class="p">};</span>
<span class="c1">###Create Parent - &#39;Listen Session&#39;###</span>
<span class="c1">###创建父会话用于监听客户端的连接</span>
<span class="c1">###会话创建的最后将进入_start状态，执行_start的handler</span>
<span class="c1">###accept_success即在_start的handler中创建监听Socket的Wheel中</span>
<span class="c1">###的SuccessEvent事件，它的handler是forwarder_create函数</span>
<span class="c1">###$_[ARG0]是wheel::SocketFatory的SuccessEvent传递的参数</span>
<span class="nn">POE::</span><span class="n">Session</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span>
  <span class="n">inline_states</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">_start</span> <span class="o">=&gt;</span> <span class="o">&amp;</span><span class="n">forwarder_server_start</span><span class="p">,</span>
    <span class="n">_stop</span><span class="err"> </span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="k">print</span> <span class="n">timestamp</span><span class="p">(),</span> <span class="s">&quot;, forwarder server stopped.&quot;</span><span class="p">;</span> <span class="p">},</span>
    <span class="n">accept_success</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="o">&amp;</span><span class="n">forwarder_create</span><span class="p">(</span><span class="nv">$_</span><span class="p">[</span><span class="n">ARG0</span><span class="p">]);</span> <span class="p">},</span>
    <span class="n">accept_failure</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="nb">delete</span> <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">server_wheel</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">},</span>
<span class="p">);</span>
<span class="nv">$poe_kernel</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
<span class="nb">exit</span><span class="p">;</span>
<span class="c1">###Event handlers for Parent Session###</span>
<span class="c1">###父会话中的事件处理函数</span>
<span class="k">sub </span><span class="nf">forwarder_server_start</span> <span class="p">{</span>
<span class="k">print</span> <span class="n">timestamp</span><span class="p">(),</span> <span class="s">&quot;, listening on port $listen_port and &quot;</span><span class="p">;</span>
<span class="k">print</span> <span class="s">&quot;forward to $target_addr:$target_port\n&quot;</span><span class="p">;</span>
<span class="c1">#在父会话的存储区创建一个监听Socket类型的Wheel</span>
<span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">server_wheel</span><span class="p">}</span> <span class="o">=</span> <span class="nn">POE::Wheel::</span><span class="n">SocketFactory</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
  <span class="n">BindPort</span>       <span class="o">=&gt;</span> <span class="nv">$listen_port</span><span class="p">,</span>
  <span class="n">SocketProtocol</span> <span class="o">=&gt;</span> <span class="s">&#39;tcp&#39;</span><span class="p">,</span>
  <span class="n">ListenQueue</span><span class="err">   </span> <span class="o">=&gt;</span> <span class="n">SOMAXCONN</span><span class="p">,</span>
  <span class="n">Reuse</span><span class="err">         </span> <span class="o">=&gt;</span> <span class="s">&#39;on&#39;</span><span class="p">,</span>
<span class="c1">#ARG0 of SuccessEvent</span>
  <span class="n">SuccessEvent</span>   <span class="o">=&gt;</span> <span class="s">&#39;accept_success&#39;</span><span class="p">,</span>
  <span class="n">FailureEvent</span>   <span class="o">=&gt;</span> <span class="s">&#39;accept_failure&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="p">}</span>
<span class="c1">###Create Child - &#39;Forward Session&#39;###</span>
<span class="c1">###创建子会话</span>
<span class="k">sub </span><span class="nf">forwarder_create</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">$socket</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
<span class="nn">POE::</span><span class="n">Session</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span>
<span class="n">inline_states</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="n">_start</span> <span class="o">=&gt;</span> <span class="o">&amp;</span><span class="n">forwarder_start</span><span class="p">,</span>
<span class="n">_stop</span><span class="err"> </span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
<span class="k">print</span> <span class="s">&#39; &#39;</span> <span class="n">x</span> <span class="mi">4</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">(),</span> <span class="s">&#39;, sessionId:&#39;</span><span class="p">;</span>
<span class="k">print</span> <span class="nv">$_</span><span class="p">[</span><span class="n">SESSION</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ID</span><span class="p">,</span> <span class="s">&quot;, forwarder stop\n&quot;</span><span class="p">;</span>
<span class="p">},</span>
<span class="n">client_input</span> <span class="o">=&gt;</span> <span class="o">&amp;</span><span class="n">client_input</span><span class="p">,</span>
<span class="n">client_error</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
<span class="nb">delete</span> <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_client</span><span class="p">};</span>
<span class="nb">delete</span> <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_server</span><span class="p">};</span>
<span class="p">},</span>
<span class="n">server_connect</span> <span class="o">=&gt;</span> <span class="o">&amp;</span><span class="n">server_connect</span><span class="p">,</span>
<span class="n">server_input</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
<span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_client</span><span class="p">}</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="nv">$_</span><span class="p">[</span><span class="n">ARG0</span><span class="p">])</span> <span class="k">if</span><span class="p">(</span><span class="nb">exists</span> <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_client</span><span class="p">});</span>
<span class="p">},</span>
<span class="n">server_error</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
<span class="nb">delete</span> <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_client</span><span class="p">};</span>
<span class="nb">delete</span> <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_server</span><span class="p">};</span>
<span class="p">},</span>
<span class="p">},</span>
<span class="c1">#Parameters to &#39;_start&#39; Event</span>
<span class="n">args</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$socket</span><span class="p">],</span>
<span class="p">);</span>
<span class="p">}</span>
<span class="c1">##Event Handlers of Child Session##</span>
<span class="k">sub </span><span class="nf">forwarder_start</span> <span class="p">{</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$heap</span><span class="p">,</span> <span class="nv">$socket</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">,</span> <span class="n">ARG0</span><span class="p">];</span>
<span class="k">print</span> <span class="s">&#39; &#39;</span> <span class="n">x</span> <span class="mi">4</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">(),</span> <span class="s">&#39;, sessionId:&#39;</span><span class="p">;</span>
<span class="k">print</span> <span class="nv">$_</span><span class="p">[</span><span class="n">SESSION</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ID</span><span class="p">,</span> <span class="s">&quot;, forwarder startn&quot;</span><span class="p">;</span>
<span class="c1">#Buffer client&#39;s input while connecting to the target</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">}</span> <span class="o">=</span> <span class="s">&#39;connecting&#39;</span><span class="p">;</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">queue</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span><span class="p">;</span>
<span class="c1">#ClientForwarder server</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_client</span><span class="p">}</span> <span class="o">=</span> <span class="nn">POE::Wheel::</span><span class="n">ReadWrite</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
<span class="n">Handle</span> <span class="o">=&gt;</span> <span class="nv">$socket</span><span class="p">,</span>
<span class="n">Driver</span> <span class="o">=&gt;</span> <span class="nn">POE::Driver::</span><span class="n">SysRW</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(),</span>
<span class="n">Filter</span> <span class="o">=&gt;</span> <span class="nn">POE::Filter::</span><span class="n">Stream</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(),</span>
<span class="n">InputEvent</span> <span class="o">=&gt;</span> <span class="s">&#39;client_input&#39;</span><span class="p">,</span>
<span class="n">ErrorEvent</span> <span class="o">=&gt;</span> <span class="s">&#39;client_error&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="c1">#Forwarder servertarget</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_server</span><span class="p">}</span> <span class="o">=</span> <span class="nn">POE::Wheel::</span><span class="n">SocketFactory</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
<span class="n">RemoteAddress</span> <span class="o">=&gt;</span> <span class="nv">$target_addr</span><span class="p">,</span>
<span class="n">RemotePort</span><span class="err">   </span> <span class="o">=&gt;</span> <span class="nv">$target_port</span><span class="p">,</span>
<span class="n">SuccessEvent</span><span class="err"> </span> <span class="o">=&gt;</span> <span class="s">&#39;server_connect&#39;</span><span class="p">,</span>
<span class="n">FailureEvent</span><span class="err"> </span> <span class="o">=&gt;</span> <span class="s">&#39;server_error&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">server_connect</span> <span class="p">{</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$kernel</span><span class="p">,</span> <span class="nv">$session</span><span class="p">,</span> <span class="nv">$heap</span><span class="p">,</span> <span class="nv">$socket</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">[</span><span class="n">KERNEL</span><span class="p">,</span> <span class="n">SESSION</span><span class="p">,</span> <span class="n">HEAP</span><span class="p">,</span> <span class="n">ARG0</span><span class="p">];</span>
<span class="c1">#Replace</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_server</span><span class="p">}</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_server</span><span class="p">}</span>
<span class="o">=</span> <span class="nn">POE::Wheel::</span><span class="n">ReadWrite</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
<span class="n">Handle</span>     <span class="o">=&gt;</span> <span class="nv">$socket</span><span class="p">,</span>
<span class="n">Driver</span>     <span class="o">=&gt;</span> <span class="nn">POE::Driver::</span><span class="n">SysRW</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">,</span>
<span class="n">Filter</span>     <span class="o">=&gt;</span> <span class="nn">POE::Filter::</span><span class="n">Stream</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">,</span>
<span class="n">InputEvent</span> <span class="o">=&gt;</span> <span class="s">&#39;server_input&#39;</span><span class="p">,</span>
<span class="n">ErrorEvent</span> <span class="o">=&gt;</span> <span class="s">&#39;server_error&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">}</span> <span class="o">=</span> <span class="s">&#39;connected&#39;</span><span class="p">;</span>
<span class="nv">$kernel</span><span class="o">-&gt;</span><span class="n">call</span><span class="p">(</span><span class="nv">$session</span><span class="p">,</span> <span class="s">&#39;client_input&#39;</span><span class="p">,</span> <span class="nv">$_</span><span class="p">)</span> <span class="k">foreach</span><span class="p">(</span><span class="nv">@</span><span class="p">{</span><span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">queue</span><span class="p">}});</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">queue</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">client_input</span> <span class="p">{</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$heap</span><span class="p">,</span> <span class="nv">$input</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">,</span> <span class="n">ARG0</span><span class="p">];</span>
<span class="nb">push</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">queue</span><span class="p">}},</span> <span class="nv">$input</span> <span class="ow">and</span> <span class="k">return</span> <span class="k">if</span><span class="p">(</span><span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">state</span><span class="p">}</span> <span class="ow">eq</span> <span class="s">&#39;connecting&#39;</span><span class="p">);</span>
<span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_server</span><span class="p">}</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="nv">$input</span><span class="p">)</span> <span class="k">if</span><span class="p">(</span><span class="nb">exists</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">wheel_server</span><span class="p">});</span>
<span class="p">}</span>
<span class="c1">#Common subroutines</span>
<span class="k">sub </span><span class="nf">timestamp</span> <span class="p">{</span>
<span class="k">return</span> <span class="n">strftime</span> <span class="s">&quot;[%H:%M:%S]&quot;</span><span class="p">,</span> <span class="nb">localtime</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">print_help</span> <span class="p">{</span>
<span class="k">my</span> <span class="nv">$filename</span> <span class="o">=</span> <span class="p">(</span><span class="nb">split</span> <span class="o">/\/</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
<span class="k">print</span> <span class="s">&lt;&lt;HELP</span>
<span class="s">&gt;&gt;&gt;</span>
<span class="s">$filename [-h,-l:]</span>
<span class="s">-h  print help</span>
<span class="s">-l  listen port</span>
<span class="s">-t  target ipaddress</span>
<span class="s">-p  target port</span>
<span class="s">A simple TCP forwarder server, 2005/10</span>
<span class="s">By shanleiguang@gmail.com</span>
<span class="s">HELP</span>
<span class="p">}</span>
</code></pre></div>
<p>使用方法：
# perl tcpForwarder.pl -l 8080 -t
xxx.xxx.xxx.xxx -p 80
[xx:xx:xx:], listening on local port 8080 and forward to
xxx.xxx.xxx.xxx:80&hellip;
&hellip;</p>
      <a href="/2010/01/28/transparent-by-ports" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/27/test-location-in-squid" title="squid页面跳转试验" rel="bookmark">squid页面跳转试验</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-27 00:00:00 +0800">27 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>某客户页面跳转试验记录</p>
<h2 id="section">一、客户需求</h2>
<p>某客户加速域名下某路径http://www.test.com/zhlc/不想让网民直接访问，希望当有直接访问该路径的请求时，都跳转到search.test.com域名下相应的路径去。</p>
<h2 id="section-1">二、解决思路</h2>
<p>a) 客户源站增添rewrite配置进行处理，将该类请求url改写成所期望的url；
b) Squid端对请求进行处理，将该类请求url改写成所期望的url。
根据售前沟通结果，这个处理步骤交由squid完成。</p>
<h2 id="squidrequest">三、Squid对request的处理流程（略，见前博文）</h2>
<h2 id="section-2">四、两种跳转方法的介绍与比较</h2>
<p>针对跳转需求，提供两个两种方法：
a) Squid支持调用外部程序脚本改写url，即redirect_program（2.6以上版本为url_rewrite_program）。所有的url请求，在squid处理流程的第三步，都会检查rewrite_program，然后将改写后的结果推入流程继续进行（为了提高运行速度，降低服务器负载，可以采用url_rewrite_access控制请求和redirector_bypass在繁忙时进行透传）。
根据《squid中文权威指南》11章的介绍，squid传递给redirect_proram的流格式为：
URL IP/FQDN IDENT METHOD
Rewrite处理时，也就是对这四个字段进行处理，一般地说，也就处理第一个字段——$url。
《squid中文权威指南》中提供了标准的perl脚本，演示了处理办法。我们测试脚本时，只需要创建一个文本文件写出url，对文件执行脚本即可。某客户测试过程如下示，为说明方便，也使用了其他shell命令做比较：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@tinysquid1 etc<span class="o">]</span><span class="c"># cat testurl.lst</span>
http://www.test.com/zhlc/
http://www.test.com/zhlc/images/1.jpg
http://www.test.com/zhlc/index.html
http://www.test.com/zhlc/index.aspx?oid<span class="o">=</span>1
http://www.test.com/zhlc/index.aspx?oid<span class="o">=</span>1&amp;pid<span class="o">=</span>2
<span class="o">[</span>root@tinysquid1 etc<span class="o">]</span><span class="c"># cat testurl.lst |sed s/www/search/</span>
http://search.test.com/zhlc/
http://search.test.com/zhlc/images/1.jpg
http://search.test.com/zhlc/index.html
http://search.test.com/zhlc/index.aspx?oid<span class="o">=</span>1
http://search.test.com/zhlc/index.aspx?oid<span class="o">=</span>1&amp;pid<span class="o">=</span>2
<span class="o">[</span>root@tinysquid1 etc<span class="o">]</span><span class="c"># cat redirector.awk</span>
<span class="c">#!/bin/awk -f</span>
<span class="o">{</span>
    split<span class="o">(</span><span class="nv">$1</span>,myarray,<span class="s2">&quot;.test.com/&quot;</span><span class="o">)</span>
<span class="o">}</span>
<span class="o">{</span>
    myarray<span class="o">[</span>1<span class="o">]=</span>http://search<span class="s2">&quot;;</span>
<span class="s2">    print myarray[1]&quot;</span>.test.com/<span class="s2">&quot;myarray[2]&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="s2">}</span>
<span class="s2">[root@tinysquid1 etc]# ./redirector.awk testurl.lst</span>
<span class="s2">http://search.test.com/zhlc/</span>
<span class="s2">http://search.test.com/zhlc/images/1.jpg</span>
<span class="s2">http://search.test.com/zhlc/index.html</span>
<span class="s2">http://search.test.com/zhlc/index.aspx?oid=1</span>
<span class="s2">http://search.test.com/zhlc/index.aspx?oid=1&amp;pid=2</span>
<span class="s2">[root@tinysquid1 etc]# cat redirector.pl</span>
<span class="s2">#!/usr/bin/perl -wl</span>
<span class="s2">use strict;</span>
<span class="s2">$|=1;</span>
<span class="s2">while () {</span>
<span class="s2">        my ($url,$client,$ident,$method) = ();</span>
<span class="s2">        ($url, $client, $ident, $method) = split;</span>
<span class="s2">    if ($url =~ m#^http://www.test.com/zhlc/#) {</span>
<span class="s2">        $url=~ s/www/search/;</span>
<span class="s2">        print &quot;</span><span class="nv">$url</span><span class="se">\n</span><span class="s2">&quot;;</span>
<span class="s2">    } else {</span>
<span class="s2">        print &quot;</span><span class="nv">$urln</span><span class="err">&quot;</span>;
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">[</span>root@tinysquid1 etc<span class="o">]</span><span class="c"># ./redirector.pl testurl.lst</span>
http://search.test.com/zhlc/
http://search.test.com/zhlc/images/1.jpg
http://search.test.com/zhlc/index.html
http://search.test.com/zhlc/index.aspx?oid<span class="o">=</span>1
http://search.test.com/zhlc/index.aspx?oid<span class="o">=</span>1&amp;pid<span class="o">=</span>2
</code></pre></div>
<p>不过虽然awk也是流处理，但作为squid的外挂program测试却没法真起作用。所以只能用perl（网上看到也有用php和python的）。</p>
<p>采用rewrite方法后，squid日志记录如下：</p>
<pre><code>1264603532.881   1147 59.151.*.* TCP_MISS/200 86230 GET http://www.test.com/zhlc/images/header.jpg - DIRECT/1.2.3.173 image/jpeg "http://www.test.com/zhlc/" "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; QQPinyinSetup 620; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30)"
</code></pre>
<p>虽然http_status显示的200，不过www.test.com的源站IP为1.2.3.172，search.test.com的源站IP为1.2.3.173，可见squid已经将请求转发给search.test.com了。</p>
<p>由上面的流程可知，squid是先检查acl，然后rewrite，再检查HIT/MISS，所以当设定了search.test.com/.<em>的 cache_deny 后，所有www.test.com/zhlc/.</em>的重复访问也都是MISS。</p>
<p>b) 第二种方法，不属于专门的跳转重定向，算是个妙用吧：</p>
<p>Squid为了美观方便，提供了一些错误信息的定制功能。之前的源站错误跳转，就是修改了ERROR_DIRECTORY里html的meta标签做的。除此以外，针对error_diretory里的ACCESS_DENIED页面，还有专门的另一个configure参数进行定制——deny_info。其用法如下：</p>
<div class="highlight"><pre><code class="squid"><span class="k">acl</span><span class="w"> </span>test<span class="w"> </span><span class="k">url_regex</span><span class="w"> </span>-i<span class="w"> </span>^http://www.test.com/zhlc/.*<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">deny</span><span class="w"> </span>test<span class="w"></span>
<span class="k">deny_info</span><span class="w"> </span>http://search.test.com/zhlc/<span class="w"> </span>test<span class="w"></span>
</code></pre></div>
<p>如果需要显示的信息已经编辑在error_diretory里了，那就可以直接写文件名而不用写url。Squid.conf.default中举例是 <code>deny_info ERR_CUSTOM_ACCESS_DENIED bad_guys</code>。</p>
<p>这个deny_info，常用的地方是防盗链。在deny盗链的同时，加上一个源站的logo图片url，正好让盗链网站替自己做宣传~~</p>
<p>采用deny_info方法后，squid日志记录如下：</p>
<pre><code>1264661272.822 2 59.151.*.* TCP_DENIED/302 320 GET http://www.test.com/zhlc/ - NONE/- text/html "-" "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; QQPinyinSetup 620; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30)"
1264661273.753 854 59.151.*.* TCP_MISS/200 9166 GET http://search.test.com/zhlc/ - DIRECT/1.2.3.173 text/html "-" "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; QQPinyinSetup 620; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30)"
</code></pre>
<p>显示的是TCP_DENIED/302。</p>
<p>c) 两个方法比较</p>
<p>最表面可见的不同，就是当IE访问http://www.test.com/zhlc/时，第一种方法地址栏依然显示（httpwatch也一样）http://www.test.com/zhlc/，而第二种方法也显示为http://search.test.com/zhlc/了。</p>
<p>根据之前论述可知，第一种访问时，clinet提出第一个http://www.test.com/zhlc/请求，squid在流程第三步改写url，从search源站取回html代码，查询到相关资源（即http://www.test.com/zhlc/.*），然后重复请求过程，逐一改写，从search源站取回所有文件；</p>
<p>第二种访问时，client提出第一个http://www.test.com/zhlc/请求，squid在流程第二步检查出相匹配的acl规则，返回deny信息给client，即请IE浏览器显示http://search.test.com/zhlc/，然后client重新开始一次链接建立过程，经dns解析等步骤，连上search.test.com的，取回http://search.test.com/zhlc/.*。</p>
<h2 id="section-3">五、客户页面分析</h2>
<p>在日志分析过程中，还发现一个问题，当squid首先从search.test.com源站取回html代码后，为什么调用的相关页面资源url请求也都是www.test.com的呢？看http://www.test.com/zhlc/页面代码，发现如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/zhlc/style/reset.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/zhlc/style/main.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/zhlc/Scripts/AC_RunActiveContent.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;&lt;img</span> <span class="na">src=</span><span class="s">&quot;/zhlc/images/logo.jpg&quot;</span> <span class="na">width=</span><span class="s">&quot;154&quot;</span> <span class="na">height=</span><span class="s">&quot;80&quot;</span> <span class="na">border=</span><span class="s">&quot;0&quot;</span><span class="nt">/&gt;&lt;/a&gt;</span>
……
</code></pre></div>
<p>其页面代码都使用了相对路径，所以才导致了从search端取回的代码依然调用www的url的现象。</p>
<h2 id="section-4">六、总结</h2>
<p>某客户页面跳转试验至此，因为squid处理流程和客户源站代码等多方面原因，只能采用统一跳转至http://search.test.com/zhlc/单一页面的方法，确保客户在IE地址栏里看到有跳转的效果……</p>
<p>最后，总结试验中的两种办法，其改写过程，可以归纳成rewrite是squid-origin过程的，deny_info是squid-client过程的。</p>
      <a href="/2010/01/27/test-location-in-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/24/shell-script-for-train-setting" title="CUshell版惊见中国特色脚本" rel="bookmark">CUshell版惊见中国特色脚本</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-24 00:00:00 +0800">24 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>58同城：</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
<span class="c">#该脚本仅用于58同城网站刷票</span>
<span class="c">#到达目的地</span>
<span class="nv">DES</span><span class="o">=</span><span class="s2">&quot;(天水|兰州|西安)&quot;</span>
<span class="c">#刷票url</span>
<span class="nv">URL</span><span class="o">=</span>http://bj.58.com/huochepiao/a1/
<span class="nv">OLDMD5</span><span class="o">=</span><span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | sed <span class="s1">&#39;$d&#39;</span> | md5sum | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
<span class="k">while </span><span class="nb">true</span>; <span class="k">do</span>
<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$OLDMD5&quot;</span> <span class="o">==</span> <span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | sed <span class="s1">&#39;$d&#39;</span> | md5sum | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span> <span class="o">]</span>;<span class="k">then</span>
<span class="k">        </span>sleep 300
    <span class="k">else</span>
<span class="k">        </span><span class="nv">MESSAGE</span><span class="o">=</span><span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | sed <span class="s1">&#39;$d&#39;</span> | head -n1<span class="sb">`</span>
        <span class="nv">SEND</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$MESSAGE</span> | awk -F<span class="s2">&quot;&gt;&quot;</span> <span class="s1">&#39;{print $3}&#39;</span> | sed -e <span class="s1">&#39;s/&lt;.*//&#39;</span><span class="sb">`</span>
        <span class="nv">DATE</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$SEND</span> | awk -F<span class="s2">&quot;:&quot;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>
        <span class="c">#判断DATE变量，使其匹配你需要出发的日期</span>
        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;2010-02-08&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;2010-02-09&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;2010-02-10&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;2010-02-11&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;2010-02-12&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;2010-01-28&quot;</span> <span class="o">]</span>;<span class="k">then</span>
            <span class="c">#输入需要发送信息的命令,飞信或mail等.....,发送的内容为$SEND变量</span>
            /usr/bin/curl -d <span class="nv">cdkey</span><span class="o">=</span>xxxx-xxx-xxxx-xxxxx -d <span class="nv">password</span><span class="o">=</span>xxxxxx -d <span class="nv">addserial</span><span class="o">=</span>xxx -d <span class="nv">phone</span><span class="o">=</span>13000000000 -d <span class="nv">message</span><span class="o">=</span><span class="s2">&quot;$SEND:58.com&quot;</span> http://sdkhttp.eucp.b2m.cn/sdkproxy/asynsendsms.action
        <span class="k">fi</span>
<span class="k">        </span><span class="nv">OLDMD5</span><span class="o">=</span><span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | sed <span class="s1">&#39;$d&#39;</span> | md5sum | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
        sleep 300
    <span class="k">fi</span>
<span class="k">done</span>
</code></pre></div>
<p>赶集网：</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
<span class="c">#该脚本仅用于赶集网刷票</span>
<span class="c">#到达目的地</span>
<span class="nv">DES</span><span class="o">=</span><span class="s2">&quot;(天水|兰州|西安)&quot;</span>
<span class="c">#刷票url</span>
<span class="nv">URL</span><span class="o">=</span>http://bj.ganji.com/piao/sell/
<span class="nv">OLDMD5</span><span class="o">=</span><span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | md5sum | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
<span class="k">while </span><span class="nb">true</span>; <span class="k">do</span>
<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$OLDMD5&quot;</span> <span class="o">==</span> <span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | md5sum | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span> <span class="o">]</span>;<span class="k">then</span>
<span class="k">        </span>sleep 300
    <span class="k">else</span>
<span class="k">        </span><span class="nv">MESSAGE</span><span class="o">=</span><span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | head -n1<span class="sb">`</span>
        <span class="nv">SEND</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$MESSAGE</span> | awk -F<span class="s2">&quot;&gt;&quot;</span> <span class="s1">&#39;{print $3}&#39;</span> | sed -e <span class="s1">&#39;s/&lt;.*//&#39;</span><span class="sb">`</span>
        <span class="nv">DATE</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$SEND</span> | awk -F<span class="s2">&quot;:&quot;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>
        <span class="c">#判断DATE变量，使其匹配你需要出发的日期</span>
        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;02-08&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;02-09&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;02-10&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;02-11&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;02-12&quot;</span> -o <span class="s2">&quot;$DATE&quot;</span> <span class="o">==</span> <span class="s2">&quot;01-28&quot;</span> <span class="o">]</span>;<span class="k">then</span>
        <span class="c">#输入需要发送信息的命令,飞信或mail等.....,发送的内容为$SEND变量</span>
        /usr/bin/curl -d <span class="nv">cdkey</span><span class="o">=</span>xxxx-xxx-xxxx-xxxxx -d <span class="nv">password</span><span class="o">=</span>xxxxxx -d <span class="nv">addserial</span><span class="o">=</span>xxx -d <span class="nv">phone</span><span class="o">=</span>13000000000 -d <span class="nv">message</span><span class="o">=</span><span class="s2">&quot;$SEND:ganji.com&quot;</span> &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://sdkhttp.eucp.b2m.cn/sdkproxy/asynsendsms.action&quot;</span>&gt;http://sdkhttp.eucp.b2m.cn/sdkproxy/asynsendsms.action&lt;/a&gt;
        <span class="k">fi</span>
<span class="k">        </span><span class="nv">OLDMD5</span><span class="o">=</span><span class="sb">`</span>curl <span class="nv">$URL</span> | egrep <span class="s2">&quot;$DES&quot;</span> | md5sum | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
        sleep 300
    <span class="k">fi</span>
<span class="k">done</span>
</code></pre></div>
      <a href="/2010/01/24/shell-script-for-train-setting" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/23/automate-configure-squid-in-website" title="squid自动配置web化" rel="bookmark">squid自动配置web化</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-23 00:00:00 +0800">23 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>[root@test data]# cat index.htm</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>饶琛琳专用21V-CDN流程系统<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;style </span><span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
<span class="nc">.style1</span> <span class="p">{</span>
<span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;center&gt;</span>
<span class="nt">&lt;h1&gt;</span>Designed for support@21vianet.com in RT table.<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;hr&gt;</span>
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="err"> </span> <span class="na">action=</span><span class="s">&quot;/cgi-bin/rt.cgi&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="nt">&lt;td</span> <span class="na">colspan=</span><span class="s">&quot;2&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">&quot;config&quot;</span> <span class="na">style=</span><span class="s">&quot;width: 700px; height: 200px&quot;</span> <span class="na">rows=</span><span class="s">&quot;1&quot;</span> <span class="na">cols=</span><span class="s">&quot;20&quot;</span> <span class="na">onmouseover=</span><span class="s">&quot;focus()&quot;</span> <span class="na">onfocus=</span><span class="s">&quot;if(value==&#39;在此填入squid配置，或者者测试url，注意分行哟&#39;) {value=&#39;&#39;}&quot;</span> <span class="na">onmouseout=</span><span class="s">&quot;blur()&quot;</span> <span class="na">onblur=</span><span class="s">&quot;if (value==&#39;&#39;) {value=&#39;在此填入squid配置，或者测试url，注意分行哟&#39;}&quot;</span><span class="nt">&gt;</span>在此填入squid配置，或者测试url，注意分行哟<span class="nt">&lt;/textarea&gt;&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="nt">&lt;td&gt;</span>
<span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">&quot;iplist&quot;</span> <span class="na">style=</span><span class="s">&quot;width: 200px; height: 250px&quot;</span> <span class="na">rows=</span><span class="s">&quot;1&quot;</span> <span class="na">cols=</span><span class="s">&quot;20&quot;</span> <span class="na">onmouseover=</span><span class="s">&quot;focus()&quot;</span> <span class="na">onfocus=</span><span class="s">&quot;if(value==&#39;在此填入服务器组IP，注意绵阳、广州、汕头网通没VPN哈&#39;) {value=&#39;&#39;}&quot;</span> <span class="na">onmouseout=</span><span class="s">&quot;blur()&quot;</span> <span class="na">onblur=</span><span class="s">&quot;if (value==&#39;&#39;) {value=&#39;在此填入服务器组IP，注意绵阳、广州、汕头网通没VPN哈&#39;}&quot;</span><span class="nt">&gt;</span>在此入服务器组IP，注意绵阳、广州、汕头网通没VPN哈<span class="nt">&lt;/textarea&gt;&lt;/td&gt;</span>
<span class="nt">&lt;td&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;custom&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">style=</span><span class="s">&quot;width: 246px&quot;</span> <span class="na">value=</span><span class="s">&quot;在此填入客户简称&quot;</span> <span class="na">onfocus=</span><span class="s">&quot;if(value==&#39;在此填入客户简称&#39;) {value=&#39;&#39;}&quot;</span> <span class="na">onblur=</span><span class="s">&quot;if (value==&#39;&#39;) {value=&#39;在此填入客户简称&#39;}&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;action&quot;</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">value=</span><span class="s">&quot;add&quot;</span> <span class="nt">/&gt;</span>添加该客户加速配置<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;action&quot;</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">value=</span><span class="s">&quot;del&quot;</span> <span class="nt">/&gt;</span>删除该客户加速配置<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;action&quot;</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">value=</span><span class="s">&quot;change&quot;</span> <span class="nt">/&gt;</span>更新该客户加速配置<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;action&quot;</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">value=</span><span class="s">&quot;conf&quot;</span> <span class="nt">/&gt;</span>检查配置统一性<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;action&quot;</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">value=</span><span class="s">&quot;wget&quot;</span> <span class="nt">/&gt;</span>wget方式检查（https等特殊情况推荐）<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;action&quot;</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">value=</span><span class="s">&quot;curl&quot;</span> <span class="na">checked=</span><span class="s">&quot;checked&quot;</span> <span class="nt">/&gt;</span>curl方式检查（防盗链、过期时间推荐）<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;submit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">/&gt;&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/center&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;ShowAD&quot;</span> <span class="na">style=</span><span class="s">&quot;position:absolute;z-index:100;font-size:12px&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;width:135;height:18px;font-size:14px;font-weight:bold;text-align:left;cursor:hand;&quot;</span> <span class="na">onClick=</span><span class="s">&quot;closead();&quot;</span><span class="nt">&gt;&lt;font</span> <span class="na">color=</span><span class="s">&quot;ff0000&quot;</span><span class="nt">&gt;</span>升级特性<span class="nt">&lt;/font&gt;</span>
v0.1.0:配置文件存入中心，调用脚本conf.sh运行；<span class="nt">&lt;br&gt;</span>
v0.1.1:新增wget测试功能，采用hosts绑定方式；<span class="nt">&lt;br&gt;</span>
v0.2.0:新增curl测试、配置文件校对功能，采用指定代理参数，避免修改hosts权限问题；<span class="nt">&lt;br&gt;</span>
v0.3.0:更新配置分发功能，直接逐句插入；<span class="nt">&lt;br&gt;</span>
v0.3.1:加强wget和curl测试定制功能，支持HTTPS、防盗链、过期时间检查；<span class="nt">&lt;br&gt;</span>
v0.3.2:支持url批量测试；<span class="nt">&lt;br&gt;</span>
v0.3.3:加强输入IP自动识别；<span class="nt">&lt;br&gt;</span>
更多精彩，敬请期待~~<span class="nt">&lt;br&gt;</span>
<span class="nt">&lt;script </span><span class="na">language=</span><span class="s">&quot;javascript&quot;</span><span class="nt">&gt;</span>
<span class="kd">var</span> <span class="nx">bodyfrm</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">document</span><span class="p">.</span><span class="nx">compatMode</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="o">==</span><span class="s2">&quot;css1compat&quot;</span> <span class="p">)</span> <span class="o">?</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span> <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">adst</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;ShowAD&quot;</span><span class="p">).</span><span class="nx">style</span><span class="p">;</span>
<span class="nx">adst</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">bodyfrm</span><span class="p">.</span><span class="nx">clientHeight</span> <span class="o">-</span><span class="mi">300</span><span class="o">-</span><span class="mi">22</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
<span class="nx">adst</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">bodyfrm</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">-</span><span class="mi">200</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">moveR</span><span class="p">()</span> <span class="p">{</span>
<span class="nx">adst</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">bodyfrm</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">+</span> <span class="nx">bodyfrm</span><span class="p">.</span><span class="nx">clientHeight</span> <span class="o">-</span> <span class="mi">300</span><span class="o">-</span><span class="mi">22</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
<span class="nx">adst</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">bodyfrm</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">+</span> <span class="nx">bodyfrm</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">-</span> <span class="mi">200</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">setInterval</span><span class="p">(</span><span class="s2">&quot;moveR();&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
<span class="kd">function</span> <span class="nx">closead</span><span class="p">()</span>
<span class="p">{</span>
<span class="nx">adst</span><span class="p">.</span><span class="nx">display</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>[root@BeiJingBGP-Dns-02 cgi-bin]# cat rt.cgi</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
<span class="k">function </span>filter<span class="o">(){</span>
sed <span class="s1">&#39;{</span>
<span class="s1">s/%23/#/g;</span>
<span class="s1">s/%0D%0A/n/g;</span>
<span class="s1">s/%5E/^/g;</span>
<span class="s1">s/%3A/:/g;</span>
<span class="s1">s/%2F///g;</span>
<span class="s1">s/%28/\(/g;</span>
<span class="s1">s/%7C/\|/g;</span>
<span class="s1">s/%29/\)/g;</span>
<span class="s1">s/%24/$/g;</span>
<span class="s1">s/%25/%/g;</span>
<span class="s1">s/%3F/?/g;</span>
<span class="s1">s/%3D/=/g;</span>
<span class="s1">s/%5C/\/g;</span>
<span class="s1">}&#39;</span> <span class="nv">$1</span>
<span class="o">}</span>
<span class="k">function </span>regulate<span class="o">(){</span>
sed <span class="s2">&quot;{</span>
<span class="s2">1i#$custom</span>
<span class="s2">$a#$custom+end</span>
<span class="s2">$!N; /^(.*)n1$/!P;D</span>
<span class="s2">}&quot;</span> <span class="nv">$1</span>
<span class="o">}</span>
<span class="k">function </span>uniform<span class="o">(){</span>
awk -F<span class="s2">&quot;[+| ]&quot;</span> <span class="s1">&#39;{</span>
<span class="s1">for(i=1;i&lt;=NF;i++){</span>
<span class="s1">if($i~/[0-9]+.[0-9]+.[0-9]+.[0-9]+/){</span>
<span class="s1">print $i</span>
<span class="s1">}</span>
<span class="s1">}</span>
<span class="s1">}&#39;</span>
<span class="o">}</span>
<span class="nb">echo</span> <span class="s2">&quot;Content-type:text/html&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;html&gt;&quot;</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$REQUEST_METHOD&quot;</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span> <span class="o">]</span> ; <span class="k">then</span>
<span class="nv">QUERY_STRING</span><span class="o">=</span><span class="sb">`</span>cat -<span class="sb">`</span>
<span class="k">fi</span>
<span class="c">#echo &quot;&lt;center&gt;$QUERY_STRING&lt;/center&gt;&quot;</span>
<span class="nv">action</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$QUERY_STRING</span>|awk -F<span class="s2">&quot;[=|&amp;amp;]&quot;</span> <span class="s1">&#39;{print $8}&#39;</span><span class="sb">`</span>
<span class="nv">custom</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$QUERY_STRING</span>|awk -F<span class="s2">&quot;[=|&amp;amp;]&quot;</span> <span class="s1">&#39;{print $6}&#39;</span><span class="sb">`</span>
<span class="nv">iplist</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$QUERY_STRING</span>|awk -F<span class="s2">&quot;[=|&amp;amp;]&quot;</span> <span class="s1">&#39;{print $4}&#39;</span>|filter|uniform<span class="sb">`</span>
<span class="k">case</span> <span class="nv">$action</span> in
add<span class="o">)</span>
<span class="nv">ref_conf</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$QUERY_STRING</span>|awk -F<span class="s2">&quot;[=|&amp;amp;]&quot;</span> <span class="s1">&#39;{print $2}&#39;</span>|filter|regulate|sed <span class="s1">&#39;1!G;h;$!d&#39;</span><span class="sb">`</span>
<span class="c">#echo &quot;$ref_conf&quot;</span>
<span class="k">for </span>ip in <span class="nv">$iplist</span>;<span class="k">do</span>
ping -c 3 <span class="nv">$ip</span>|awk -F, <span class="s1">&#39;/loss/{print $3}&#39;</span>
<span class="k">for </span>ref in <span class="nv">$ref_conf</span>;<span class="k">do</span>
<span class="nb">echo</span> <span class="s2">&quot;$ref&lt;br&gt;&quot;</span>
/usr/local/bin/sshpass -p 123456 ssh -oUserKnownHostsFile<span class="o">=</span>/dev/null -oStrictHostKeyChecking<span class="o">=</span>no &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;mailto:root@$ip&quot;</span>&gt;root@<span class="nv">$ip</span>&lt;/a&gt; sed -i <span class="s2">&quot;/config/a\`echo $ref|sed &#39;s/+/\ /g&#39;`&quot;</span> /home/squid/etc/squid.conf &amp;amp;&amp;amp; /home/squid/sbin/squid -k reconfigure
<span class="k">done</span>
<span class="k">done</span>
;;
wget<span class="o">)</span>
<span class="nv">test_url</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$QUERY_STRING</span>|awk -F<span class="s2">&quot;[=|&amp;amp;]&quot;</span> <span class="s1">&#39;{print $2}&#39;</span>|filter<span class="sb">`</span>
<span class="k">for </span>ip in <span class="nv">$iplist</span>;<span class="k">do</span>
<span class="k">for </span>url in <span class="nv">$test_url</span>;<span class="k">do</span>
<span class="nv">domain</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$url</span>|awk -F/ <span class="s1">&#39;{print $3}&#39;</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">&quot;$ip $domain&quot;</span> &gt; /etc/hosts
wget -S -O /dev/null <span class="s2">&quot;$url&quot;</span> -o wget.log --no-check-certificate -t 1
cat wget.log|awk <span class="s1">&#39;BEGIN{ORS=&quot;&lt;br&gt;&quot;}1&#39;</span>
<span class="k">done</span>
<span class="k">done</span>
;;
curl<span class="o">)</span>
<span class="nv">test_url</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$QUERY_STRING</span>|awk -F<span class="s2">&quot;[=|&amp;amp;]&quot;</span> <span class="s1">&#39;{print $2}&#39;</span>|filter<span class="sb">`</span>
<span class="k">for </span>url in <span class="nv">$test_url</span>;<span class="k">do</span>
<span class="nb">echo</span> <span class="s2">&quot;##################################&lt;br&gt;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;###$url&lt;br&gt;&quot;</span>
<span class="k">for </span>ip in <span class="nv">$iplist</span>;<span class="k">do</span>
<span class="nv">domain</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$url</span>|awk -F/ <span class="s1">&#39;{print $3}&#39;</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">&quot;##############&lt;br&gt;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;$ip&lt;br&gt;&quot;</span>
curl -I -x <span class="nv">$ip</span>:80 -A <span class="s2">&quot;support/RT (21V-CDN)&quot;</span> -e <span class="s2">&quot;&lt;a href=&quot;</span>http://<span class="nv">$domain</span>/<span class="s2">&quot;&gt;http://$domain&lt;/a&gt;&quot;</span> <span class="s2">&quot;$url&quot;</span>|awk <span class="s1">&#39;BEGIN{ORS=&quot;&lt;br&gt;&quot;}/HTTP/1|Cache|Age/&#39;</span>
sleep 1;
<span class="k">done</span>
<span class="k">done</span>
;;
*<span class="o">)</span>
<span class="nb">echo</span> <span class="s1">&#39;&lt;head&gt;&lt;META HTTP-EQUIV=&quot;refresh&quot; Content=&quot;0;URL=http://1.2.3.4/index.htm&quot;&gt;&lt;/head&gt;&#39;</span>
;;
<span class="k">esac</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;/html&gt;&quot;</span>
</code></pre></div>
      <a href="/2010/01/23/automate-configure-squid-in-website" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/19/sysctl-about-tcp" title="系统优化——TCP参数" rel="bookmark">系统优化——TCP参数</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-19 00:00:00 +0800">19 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>tcp_syn_retries ：INTEGER
默认值是5
对于一个新建连接，内核要发送多少个 SYN 连接请求才决定放弃。不应该大于255，默认值是5，对应于180秒左右时间。(对于大负载而物理通信良好的网络而言,这个值偏高,可修改为2.这个值仅仅是针对对外的连接,对进来的连接,是由tcp_retries1决定的)</p>
<p>tcp_synack_retries ：INTEGER
默认值是5
对于远端的连接请求SYN，内核会发送SYN ＋ ACK数据报，以确认收到上一个 SYN连接请求包。这是所谓的三次握手(threeway handshake)机制的第二个步骤。这里决定内核在放弃连接之前所送出的 SYN+ACK数目。不应该大于255，默认值是5 ，对应于180秒左右时间。(可以根据上面的 tcp_syn_retries来决定这个值)</p>
<p>tcp_keepalive_time ：INTEGER
默认值是7200(2小时)
当keepalive打开的情况下，TCP发送keepalive消息的频率。(由于目前网络攻击等因素,造成了利用这个进行的攻击很频繁,曾经也有cu的朋友提到过,说如果2边建立了连接,然后不发送任何数据或者rst/fin消息,那么持续的时间是不是就是2小时,空连接攻击?tcp_keepalive_time就是预防此情形的.我个人在做nat服务的时候的修改值为 1800 秒)</p>
<p>tcp_keepalive_probes： INTEGER
默认值是9
TCP发送keepalive探测以确定该连接已经断开的次数。(注意:保持连接仅在SO_KEEPALIVE套接字选项被打开是才发送.次数默认不需要修改,当然根据情形也可以适当地缩短此值.设置为5比较合适)</p>
<p>tcp_keepalive_intvl ：INTEGER
默认值为75
探测消息发送的频率，乘以tcp_keepalive_probes就得到对于从开始探测以来没有响应的连接杀除的时间。默认值为75秒，也就是没有活动的连接将在大约11分钟以后将被丢弃。(对于普通应用来说,这个值有一些偏大,可以根据需要改小.特别是web类服务器需要改小该值,15是个比较合适的值)</p>
<p>tcp_retries1 ：INTEGER
默认值是3
放弃回应一个TCP连接请求前﹐需要进行多少次重试。RFC 规定最低的数值是3 ﹐这也是默认值﹐根据RTO的值大约在3秒 - 8分钟之间。(注意:这个值同时还决定进入的syn连接)
tcp_retries2 ：INTEGER
默认值为15
在丢弃激活(已建立通讯状况)的TCP连接之前﹐需要进行多少次重试。默认值为15
，根据RTO的值来决定，相当于13-30分钟(RFC1122规定，必须大于100秒).(这个值根据目前的网络设置,可以适当地改小,我的网络内修改为了5)
tcp_orphan_retries ：INTEGER
默认值是7
在近端丢弃TCP连接之前﹐要进行多少次重试。默认值是7
个﹐相当于 50秒 - 16分钟﹐视 RTO 而定。如果您的系统是负载很大的web服务器﹐那么也许需要降低该值﹐这类 sockets
可能会耗费大量的资源。另外参的考 tcp_max_orphans 。(事实上做NAT的时候,降低该值也是好处显著的,我本人的网络环境中降低该值为3)
tcp_fin_timeout ：INTEGER
默认值是 60
对于本端断开的socket连接，TCP保持在FIN-WAIT-2状态的时间。对方可能会断开连接或一直不结束连接或不可预料的进程死亡。默认值为
60 秒。过去在2.2版本的内核中是 180
秒。您可以设置该值﹐但需要注意﹐如果您的机器为负载很重的web服务器﹐您可能要冒内存被大量无效数据报填满的风险﹐FIN-WAIT-2
sockets 的危险性低于 FIN-WAIT-1 ﹐因为它们最多只吃 1.5K 的内存﹐但是它们存在时间更长。另外参考
tcp_max_orphans 。(事实上做NAT的时候,降低该值也是好处显著的,我本人的网络环境中降低该值为30)
tcp_max_tw_buckets ：INTEGER
默认值是180000
系统在同时所处理的最大 timewait sockets
数目。如果超过此数的话﹐time-wait socket 会被立即砍除并且显示警告信息。之所以要设定这个限制﹐纯粹为了抵御那些简单的
DoS
攻击﹐千万不要人为的降低这个限制﹐不过﹐如果网络条件需要比默认值更多﹐则可以提高它(或许还要增加内存)。(事实上做NAT的时候最好可以适当地增加该值)
tcp_tw_recycle ：BOOLEAN
默认值是0
打开快速
TIME-WAIT sockets 回收。除非得到技术专家的建议或要求﹐请不要随意修改这个值。(做NAT的时候，建议打开它)
tcp_tw_reuse ：BOOLEAN
默认值是0
该文件表示是否允许重新应用处于TIME-WAIT状态的socket用于新的TCP连接(这个对快速重启动某些服务,而启动后提示端口已经被使用的情形非常有帮助)
tcp_max_orphans ：INTEGER
缺省值是8192
系统所能处理不属于任何进程的TCP
sockets最大数量。假如超过这个数量﹐那么不属于任何进程的连接会被立即reset，并同时显示警告信息。之所以要设定这个限制﹐纯粹为了抵御那些简单的
DoS 攻击﹐千万不要依赖这个或是人为的降低这个限制(这个值Redhat
AS版本中设置为 32768
,但是很多防火墙修改的时候,建议该值修改为
2000 )
tcp_abort_on_overflow ：BOOLEAN
缺省值是0
当守护进程太忙而不能接受新的连接，就象对方发送reset消息，默认值是false。这意味着当溢出的原因是因为一个偶然的猝发，那么连接将恢复状态。只有在你确信守护进程真的不能完成连接请求时才打开该选项，该选项会影响客户的使用。(对待已经满载的sendmail,apache这类服务的时候,这个可以很快让客户端终止连接,可以给予服务程序处理已有连接的缓冲机会,所以很多防火墙上推荐打开它)
tcp_syncookies ：BOOLEAN
默认值是 0
只有在内核编译时选择了CONFIG_SYNCOOKIES时才会发生作用。当出现syn等候队列出现溢出时象对方发送syncookies。目的是为了防止syn
flood攻击。
注意：该选项千万不能用于那些没有收到攻击的高负载服务器，如果在日志中出现synflood消息，但是调查发现没有收到synflood攻击，而是合法用户的连接负载过高的原因，你应该调整其它参数来提高服务器性能。参考:
tcp_max_syn_backlog
tcp_synack_retries
tcp_abort_on_overflow
syncookie严重的违背TCP协议，不允许使用TCP扩展，可能对某些服务导致严重的性能影响(如SMTP转发)。(注意,该实现与BSD上面使用的tcp
proxy一样,是违反了RFC中关于tcp连接的三次握手实现的,但是对于防御syn-flood的确很有用.)
tcp_stdurg ：BOOLEAN
默认值为0
使用 TCP urg pointer 字段中的主机请求解释功能。大部份的主机都使用老旧的 BSD解释，因此如果您在 Linux
打开它﹐或会导致不能和它们正确沟通。
tcp_max_syn_backlog ：INTEGER
对于那些依然还未获得客户端确认的连接请求﹐需要保存在队列中最大数目。对于超过 128Mb 内存的系统﹐默认值是
1024 ﹐低于 128Mb 的则为 128 。如果服务器经常出现过载﹐可以尝试增加这个数字。警告﹗假如您将此值设为大于
1024 ﹐最好修改
include/net/tcp.h 里面的
TCP_SYNQ_HSIZE ﹐以保持
TCP_SYNQ_HSIZE*16
﹐并且编进核心之内。(SYN
Flood攻击利用TCP协议散布握手的缺陷，伪造虚假源IP地址发送大量TCP-SYN半打开连接到目标系统，最终导致目标系统Socket队列资源耗尽而无法接受新的连接。为了应付这种攻击，现代Unix系统中普遍采用多连接队列处理的方式来缓冲(而不是解决)这种攻击，是用一个基本队列处理正常的完全连接应用(Connect()和Accept()
)，是用另一个队列单独存放半打开连接。这种双队列处理方式和其他一些系统内核措施(例如Syn-Cookies/Caches)联合应用时，能够比较有效的缓解小规模的SYN
Flood攻击(事实证明
)
tcp_window_scaling ：INTEGER
缺省值为1
该文件表示设置tcp/ip会话的滑动窗口大小是否可变。参数值为布尔值，为1时表示可变，为0时表示不可变。tcp/ip通常使用的窗口最大可达到65535字节，对于高速网络，该值可能太小，这时候如果启用了该功能，可以使tcp/ip滑动窗口大小增大数个数量级，从而提高数据传输的能力(RFC1323)。（对普通地百M网络而言，关闭会降低开销，所以如果不是高速网络，可以考虑设置为0 ）</p>
<p>tcp_timestamps ：BOOLEAN
缺省值为1
Timestamps用在其它一些东西中﹐可以防范那些伪造的 sequence 号码。一条1G的宽带线路或许会重遇到带out-of-line数值的旧sequence 号码(假如它是由于上次产生的)。Timestamp 会让它知道这是个&rsquo;旧封包&rsquo;。(该文件表示是否启用以一种比超时重发更精确的方法（RFC1323）来启用对 RTT 的计算；为了实现更好的性能应该启用这个选项。)</p>
<p>tcp_sack ：BOOLEAN
缺省值为1
使用 Selective ACK﹐它可以用来查找特定的遗失的数据报&mdash;因此有助于快速恢复状态。该文件表示是否启用有选择的应答（Selective Acknowledgment），这可以通过有选择地应答乱序接收到的报文来提高性能（这样可以让发送者只发送丢失的报文段）。(对于广域网通信来说这个选项应该启用，但是这会增加对CPU 的占用。)</p>
<p>tcp_fack ：BOOLEAN
缺省值为1
打开FACK拥塞避免和快速重传功能。(注意，当tcp_sack 设置为0 的时候，这个值即使设置为1 也无效)</p>
<p>tcp_dsack ：BOOLEAN
缺省值为1
允许TCP发送&rdquo;两个完全相同&rdquo;的SACK。</p>
<p>tcp_ecn ：BOOLEAN
缺省值为0
打开TCP的直接拥塞通告功能。</p>
<p>tcp_reordering ：INTEGER
默认值是3
TCP流中重排序的数据报最大数量 。 (一般有看到推荐把这个数值略微调整大一些,比如5 )</p>
<p>tcp_retrans_collapse ：BOOLEAN
缺省值为1
对于某些有bug的打印机提供针对其bug的兼容性。(一般不需要这个支持,可以关闭它)</p>
<p>tcp_wmem (3个INTEGER 变量)： min, default, max
    min ：为TCP socket预留用于发送 缓冲 的内存最小值。每个tcp socket都可以在建议以后都可以使用它。默认值为4096(4K) 。
default ：为TCP socket预留用于发送缓冲的内存数量，默认情况下该值会影响其它协议使用的net.core.wmem_default值，一般要低于net.core.wmem_default 的值。默认值为16384(16K) 。
    max : 用于TCP socket发送缓冲的内存最大值。该值不会影响net.core.wmem_max，&rdquo;静态&rdquo;选择参数SO_SNDBUF则不受该值影响。默认值为131072(128K) 。（对于服务器而言，增加这个参数的值对于发送数据很有帮助,在我的网络环境中,修改为了51200 131072 204800）</p>
<p>tcp_rmem (3个INTEGER 变量)： min , default , max</p>
<pre><code>min ：为TCP socket预留用于接收缓冲 的内存数量，即使在内存出现紧张情况下tcp socket都至少会有这么多数量的内存用于接收缓冲，默认值为8K 。
default ：为TCP socket预留用于接收缓冲的内存数量，默认情况下该值影响其它协议使用的net.core.wmem_default值。该值决定了在tcp_adv_win_scale、tcp_app_win 和tcp_app_win=0默认值情况下，TCP窗口大小为65535。默认值为87380
max ：用于TCP socket接收缓冲的内存最大值。该值不会影响net.core.wmem_max，"静态"选择参数 SO_SNDBUF则不受该值影响。默认值为 128K 。默认值为87380*2 bytes。（可以看出，.max的设置最好是default的两倍,对于NAT来说主要该增加它,我的网络里为51200 131072 204800）
</code></pre>
<p>tcp_mem (3个INTEGER 变量)：low , pressure , high
    low ：当TCP使用了低于该值的内存页面数 时，TCP不会考虑释放内存。(理想情况下，这个值应与指定给 tcp_wmem 的第 2 个值相匹配 - 这第 2 个值表明，最大页面大小乘以最大并发请求数除以页大小 (131072 * 300 / 4096 )。 )
    pressure ：当TCP使用了超过该值的内存页面数量时，TCP试图稳定其内存使用，进入pressure模式，当内存消耗低于low值时则退出pressure状态。(理想情况下这个值应该是TCP 可以使用的总缓冲区大小的最大值 (204800 * 300 / 4096 )。 )
    high ：允许所有tcp sockets用于排队缓冲数据报的页面量。(如果超过这个值，TCP 连接将被拒绝，这就是为什么不要令其过于保守 (512000 * 300 / 4096 ) 的原因了。</p>
<p>在这种情况下，提供的价值很大，它能处理很多连接，是所预期的 2.5 倍；或者使现有连接能够传输 2.5 倍的数据。我的网络里为192000 300000 732000)一般情况下这些值是在系统启动时根据系统内存数量计算得到的。</p>
<p>tcp_app_win : INTEGER
默认值是31
保留max(window/2^tcp_app_win, mss)数量的窗口由于应用缓冲。当为0时表示不需要缓冲。</p>
<p>tcp_adv_win_scale : INTEGER
默认值为2
计算缓冲开销bytes/2^tcp_adv_win_scale(如果tcp_adv_win_scale &gt; 0)或者bytes-bytes/2^(-tcp_adv_win_scale)(如果tcp_adv_win_scale &lt;= 0）。</p>
<p>tcp_rfc1337 :BOOLEAN
缺省值为0
这个开关可以启动对于在RFC1337中描述的&rdquo;tcp的time-wait暗杀危机&rdquo;问题的修复。启用后，内核将丢弃那些发往time-wait状态TCP套接字的RST包.</p>
<p>tcp_low_latency: BOOLEAN
缺省值为0
允许 TCP/IP 栈适应在高吞吐量情况下低延时的情况；这个选项一般情形是的禁用。(但在构建Beowulf集群的时候,打开它很有帮助)</p>
<p>tcp_westwood :BOOLEAN
缺省值为0
启用发送者端的拥塞控制算法，它可以维护对吞吐量的评估，并试图对带宽的整体利用情况进行优化；对于 WAN通信来说应该启用这个选项。</p>
<p>tcp_bic :BOOLEAN
缺省值为0
为快速长距离网络启用 Binary Increase Congestion；这样可以更好地利用以 GB 速度进行操作的链接；对于WAN 通信应该启用这个选项。</p>
      <a href="/2010/01/19/sysctl-about-tcp" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/13/refresh-cache-of-interrogation-url" title="squid刷新缓存" rel="bookmark">squid刷新缓存</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-13 00:00:00 +0800">13 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>这篇博文的起因是最近犯的一个低级错误。某客户要求立刻刷新掉一批url。格式是http://a.b.com/index.jsp?pid=123456&amp;id=654321这样的。
我也没多想，上去就执行“squidclient -p 80  -m purge
http://a.b.com/index.jsp?pid=123456&amp;id=654321”。结果硬是刷不掉……明明访问源站已经没有这个url了。我wget居然还能MISS/200~~~
直到同事提醒。才赫然发现其实我一直在purge和wget的，不是http://a.b.com/index.jsp?pid=123456&amp;id=654321，而是http://a.b.com/index.jsp?pid=123456。linux把url里的&amp;当作后台运行的命令执行了……而access.log中为了安全又没记录?后的具体参数，于是傻傻的跟客户客服扯皮了N久……
“squidclient -p 80  -m purge &lsquo;http://a.b.com/index.jsp?pid=123456&amp;amp;id=654321&rsquo;”这么一刷立刻就好了~~
由此告诫自己，以后一定要严谨行事，引号最好还是要养成习惯都给带上~~</p>
<p>以下具体总结摘录squid缓存刷新的几种办法，随便感谢百度，悼念谷歌：</p>
<p>第一种——当squid的refresh_pattern未使用任何options，即squid缓存遵循http协议精神时有效。原理是模拟no-cache头的request（即ctrl+F5刷新）：
【nnd，一帖就错误，单独放一个帖子，大家看下一贴吧】</p>
<p>第二种，采用PURGE方式刷新，request的header如下：</p>
<p>PURGE http://www.lrrr.org/junk HTTP/1.0
Accept: <em>/</em></p>
<p>脚本类似第一种方法，修改其中的HEAD为PURGE即可：</p>
<p>$head = &ldquo;PURGE $url_component[&lsquo;path&rsquo;] HTTP/1.1\r\n&rdquo;;</p>
<p>按照《squid中文权威指南》的说法，当squid收到purge指令的时候，也是采用head和get的方式去处理请求，然后找到cache的文件进行删除的。</p>
<p>第三种，采用多播HTCP包。这是 MediaWiki 目前正在使用的方法，当wiki 更新时用于更新全球的 Squid缓存服务器，实现原理为：发送 PURGE 请求到特定的多播组，所有Squid服务器通过订阅该多播组信息完成删除操作，这种实现方式非常高效，避免了 Squid 服务器处理响应和建立 TCP连接的开销。参考资料： Multicast HTCP purging。</p>
<p>第五种，小工具：<a href="http://www.wa.apana.org.au/~dean/squidpurge/">http://www.wa.apana.org.au/~dean/squidpurge/</a>
wget http://www.wa.apana.org.au/~dean/sources/purge-20040201-src.tar.gz
tar zxvf purge-20040201-src.tar.gz
cd purge
make
./purge -help
    ### Use at your own risk! No guarantees whatsoever. You were warned. ###
    $Id: purge.cc,v 1.17 2000/09/21 10:59:53 cached Exp $
    Usage: purge [-a] [-c cf] [-d l] [-(f|F) fn | -(e|E) re] [-ph[:p]]
    [-P #] [-s] [-v] [-C dir [-H]] [-n]
    -a display a little rotating thingy to indicate that I am alive
    (tty only).
    -c c squid.conf location, default
    &ldquo;/usr/local/squid/etc/squid.conf&rdquo;.
    -C dir base directory for content extraction (copy-out mode).
    -d l debug level, an or of different debug options.
    -e re single regular expression_r_r per -e instance (use
    quotes!).
    -E re single case sensitive regular expression_r_r like -e.
    -f fn name of textfile containing one regular
    expression_r_r per line.
    -F fn name of textfile like -f containing case sensitive REs.
    -H prepend HTTP reply header to destination files in copy-out
    mode.
    -n do not fork() when using more than one cache_dir.
    -p h:p cache runs on host h and optional port p, default is
    localhost:3128.
    -P # if 0, just print matches; otherwise or the following purge
    modes:
    0x01 really send PURGE to the cache.
    0x02 remove all caches files reported as 404 (not found).
    0x04 remove all weird (inaccessible or too small) cache
    files.
    0 and 1 are recommended - slow rebuild your cache with other modes.
    -s show all options after option parsing, but before really
    starting.
    -v show more information about the file, e.g. MD5, timestamps and
    flags.</p>
<p>使用示例：</p>
<ol>
  <li>清除URL中包含jackbillow.com的所有缓存
 ./purge -p 127.0.0.1:80 -P 1 -se &lsquo;jackbillow.com&rsquo;</li>
  <li>清除 URL 以“.mp3”结尾的缓存文件，例如：http://www.dzend.com/abc/test.mp3
 ./purge -p 127.0.0.1:80 -P 1 -se &lsquo;.mp3$&rsquo;</li>
</ol>
<p>第五种，张宴的脚本clear_squid_cache.sh。（老小注：还是这个熟悉，呵呵）</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/sh</span>
<span class="nv">squidcache_path</span><span class="o">=</span><span class="s2">&quot;/data1/squid/var/cache&quot;</span>
<span class="nv">squidclient_path</span><span class="o">=</span><span class="s2">&quot;/usr/local/squid/bin/squidclient&quot;</span>
grep -a -r <span class="nv">$1</span> <span class="nv">$squidcache_path</span>/* | strings | grep <span class="s2">&quot;http:&quot;</span> | awk -F<span class="s1">&#39;http:&#39;</span> <span class="s1">&#39;{print &quot;http:&quot;$2;}&#39;</span> &gt;cache_list.txt
<span class="k">for </span>url in <span class="sb">`</span>cat cache_list.txt<span class="sb">`</span>; <span class="k">do</span>
    <span class="nv">$squidclient_path</span> -m PURGE -p 80 <span class="nv">$url</span>
<span class="k">done</span>
</code></pre></div>
<p>据说：经测试，在DELL 2950上清除26000个缓存文件用时2分钟左右。平均每秒可清除缓存文件177个。
看到了吧，网上流传的这个脚本里，$url也没有用&rdquo;&ldquo;引起来，所以用这个sh刷新的时候，也失败了……</p>
      <a href="/2010/01/13/refresh-cache-of-interrogation-url" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/13/refresh-cache-by-php" title="刷新squid缓存的php脚本" rel="bookmark">刷新squid缓存的php脚本</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-13 00:00:00 +0800">13 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">interface</span> <span class="nx">Flush_Cache</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">flush</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">Flush_Cache_HTTP_Header_Impl</span> <span class="k">implements</span> <span class="nx">Flush_Cache</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">flush</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$url</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$url_component</span> <span class="o">=</span> <span class="nb">parse_url</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
        <span class="k">global</span> <span class="nv">$g_squid_servers</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$g_squid_servers</span> <span class="k">as</span> <span class="nv">$server</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nv">$squid_params</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span> <span class="p">,</span> <span class="nv">$server</span><span class="p">);</span>
            <span class="nv">$fsocket</span> <span class="o">=</span> <span class="nb">fsockopen</span><span class="p">(</span><span class="nv">$squid_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$squid_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nv">$errono</span><span class="p">,</span> <span class="nv">$errstr</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="k">FALSE</span> <span class="o">!=</span> <span class="nv">$fsocket</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nv">$head</span> <span class="o">=</span> <span class="s2">&quot;HEAD </span><span class="si">{</span><span class="nv">$url_component</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> HTTP/1.1rn&quot;</span><span class="p">;</span>
                <span class="nv">$head</span> <span class="o">.=</span> <span class="s2">&quot;Accept: */*rn&quot;</span><span class="p">;</span>
                <span class="nv">$head</span> <span class="o">.=</span> <span class="s2">&quot;Host: </span><span class="si">{</span><span class="nv">$url_component</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">rn&quot;</span><span class="p">;</span>
                <span class="nv">$head</span> <span class="o">.=</span> <span class="s2">&quot;Cache-Control: no-cachern&quot;</span><span class="p">;</span>
                <span class="nv">$head</span> <span class="o">.=</span> <span class="s2">&quot;rn&quot;</span><span class="p">;</span>
                <span class="k">echo</span> <span class="nv">$head</span><span class="p">;</span>
                <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fsocket</span> <span class="p">,</span> <span class="nv">$head</span><span class="p">);</span>
                <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$fsocket</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="nv">$line</span> <span class="o">=</span> <span class="nb">fread</span><span class="p">(</span><span class="nv">$fsocket</span> <span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
                    <span class="k">echo</span> <span class="nv">$line</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fsocket</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nv">$g_squid_servers</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;192.168.2.88:80&#39;</span><span class="p">);</span>
<span class="nv">$flush_cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Flush_Cache_HTTP_Header_Impl</span><span class="p">();</span>
<span class="nv">$flush_cache</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">(</span><span class="s1">&#39;http://ent.cdqss.com/index.html&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
      <a href="/2010/01/13/refresh-cache-by-php" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/10/zz-intro-acls-in-squid" title="Squid的ACL分类" rel="bookmark">Squid的ACL分类</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-10 00:00:00 +0800">10 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在找http_status的acl用法时，看到这么一句“This clause supports both fast and slow acl types”。acl还分快慢呢~~赶紧去wiki看：<a href="http://wiki.squid-cache.org/SquidFaq/SquidAcl#Fast_and_Slow_ACLs">http://wiki.squid-cache.org/SquidFaq/SquidAcl#Fast_and_Slow_ACLs</a></p>
<pre><code>Some ACL types require information which may not
be already available to Squid. Checking them requires suspending
work on the current request, querying some external source, and
resuming work when the needed information becomes available. This
is for example the case for DNS, authenticators or external
authorization scripts. ACLs can thus be divided in
FAST ACLs, which do not require going to external
sources to be fulfilled, and SLOW ACLs, which do.
Fast ACLs include (as of squid 3.1.0.7):
all (built-in)
src
dstdomain
dstdom_regex
myip
arp
src_as
peername
time
url_regex
urlpath_regex
port
myport
myportname
proto
method
http_status {R}
browser
referer_regex
snmp_community
maxconn
max_user_ip
req_mime_type
req_header
rep_mime_type {R}
user_cert
ca_cert
Slow ACLs include:
dst
dst_as
srcdomain
srcdom_regex
ident
ident_regex
proxy_auth
proxy_auth_regex
external
ext_user
ext_user_regex
This list may be incomplete or out-of-date. See
your squid.conf.documented file for details. ACL types
marked with {R} are reply ACLs, see the dedicated FAQ
chapter.
Squid caches the results of ACL lookups whenever
possible, thus slow ACLs will not always need to go to the external
data-source.
Knowing the behaviour of an ACL type is relevant
because not all ACL matching directives support all kinds of ACLs.
Some check-points will not suspend the request:
they allow (or deny) immediately. If a SLOW acl has to be checked,
and the results of the check are not cached, the corresponding ACL
result will be as if it didn't match. In other words, such ACL
types are in general not reliable in all access check clauses.
</code></pre>
      <a href="/2010/01/10/zz-intro-acls-in-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/09/keep-sessions-between-client-cache-origin" title="client-cache-origin之间的session问题" rel="bookmark">client-cache-origin之间的session问题</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-09 00:00:00 +0800">09 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>昨天，突然接到某客户的邮件，表示他们质疑我们cache对其多originserver的轮询不均等，以至于影响到网站的访问。
听起来不是什么难题，把服务器上的DNSCache进程中止掉，不就能平均轮询了么？可是操作完成后，客户依然不认可……于是开始细细探讨具体的错误问题所在。
原来实际情况是这样：点击其网站的回复、收藏等动态页面时，时常会弹出错误页面。对这个错误页面，客户的解释是“session状态CDN加速未保留”。
由此解释，我觉得cache上的问题恰恰相反，正是因为均等轮询了导致的。而客户其他一些单源的域名服务正常，也证明了这点。
上cache服务器查看配置，使用的默认keep-alive设置，也就是对client和origin都开启了keep-alive，默认时间为2min。但实际上并没有起作用。在测试中，可以看到这样的日志：</p>
<pre><code>[rao@localhost ~]$ tail access.log|awk '{print $4,$6,$7,$9,$10}'
TCP_IMS_HIT/304 GET http://a.b.com/wentiyongpin/11106917.html NONE/- "http://a.b.com/wentiyongpin/"
TCP_MISS/200 GET http://a.b.com/RelatedUserInfo.aspx?nickname=shunfataiqiu DIRECT/1.2.3.4 "http://a.b.com/wentiyongpin/11106917.html"
TCP_MISS/200 GET http://a.b.com/postcomment/Reply.aspx?info_id=11106917 DIRECT/1.2.3.5 "http://a.b.com/wentiyongpin/11106917.html"
TCP_MISS/302 POST http://a.b.com/postcomment/Reply.aspx?info_id=11106917 DIRECT/1.2.3.4 "http://a.b.com/postcomment/Reply.aspx?info_id=11106917"
TCP_MISS/404 GET http://a.b.com/nf3.aspx?aspxerrorpath=/postcomment/Reply.aspx DIRECT/1.2.3.4 "http://a.b.com/postcomment/Reply.aspx?info_id=11106917"
</code></pre>
<p>由日志可见，在进入post页面（此时方式还是GET）时，session的origin从1.2.3.4轮询到了1.2.3.5，而填完了回复内容，点击提交（此时方式改成POST）时，origin又轮询回了1.2.3.4——而此时1.2.3.4上并没有相应ID的session存在——于是页面被302重定向去了错误提示页面，也就是下面的404。</p>
<p>这种情况，主要来说，还是客户网站本身的架构问题。简单点，只用一个origin；复杂点，在多台webserver与后台数据库之间建共享连接池。保证session调用正常。</p>
<p>但在客户修改origin之前，cache本身能不能作出一定的改变呢？能。放弃使用dns查询，而采用squid本身的peer功能，就能搞定它，配置如下：</p>
<div class="highlight"><pre><code class="squid"><span class="c">#Parent</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>ParentDomain<span class="w"> </span><span class="k">dstdomain</span><span class="w"> </span>a.b.com<span class="w"></span>
<span class="k">cache_peer</span><span class="w"> </span><span class="mf">1.2.3.4</span><span class="w"> </span><span class="no">parent</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="no">no-query</span><span class="w"> </span>no-netdb-exchange<span class="w"> </span>originserver<span class="w"> </span>sourcehash<span class="w"></span>
<span class="k">cache_peer</span><span class="w"> </span><span class="mf">1.2.3.5</span><span class="w"> </span><span class="no">parent</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="no">no-query</span><span class="w"> </span>no-netdb-exchange<span class="w"> </span>originserver<span class="w"> </span>sourcehash<span class="w"></span>
<span class="k">cache_peer_access</span><span class="w"> </span><span class="mf">1.2.3.4</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>ParentDomain<span class="w"></span>
<span class="k">cache_peer_access</span><span class="w"> </span><span class="mf">1.2.3.5</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>ParentDomain<span class="w"></span>
<span class="k">always_direct</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>!ParentDomain<span class="w"></span>
<span class="c">#Parent end</span><span class="w"></span>
</code></pre></div>
<p>用的sourcehash参数，相同的clientIP，使用相同的originIP，多好的loadbalance呀，更巧的是这个option，正好是squid2.6.STABLE21能用的，连2.7都没有，哈哈~~reconfigure后的正常日志如下：</p>
<pre><code>[rao@localhost ~]$ tail access.log|awk '{print $4,$6,$7,$9,$10}'
TCP_IMS_HIT/304 GET http://a.b.com/wentiyongpin/11106917.html NONE/- "http://a.b.com/wentiyongpin/"
TCP_MISS/200 GET http://a.b.com/postcomment/Reply.aspx?info_id=11106917 SOURCEHASH_PARENT/1.2.3.4 "http://a.b.com/wentiyongpin/11106917.html"
TCP_MISS/200 GET http://a.b.com/RelatedUserInfo.aspx?nickname=shunfataiqiu SOURCEHASH_PARENT/1.2.3.4 "http://a.b.com/wentiyongpin/11106917.html"
TCP_MISS/200 POST http://a.b.com/postcomment/Reply.aspx?info_id=11106917 SOURCEHASH_PARENT/1.2.3.4 "http://a.b.com/postcomment/Reply.aspx?info_id=11106917"
TCP_MISS/200 GET http://a.b.com/ SOURCEHASH_PARENT/1.2.3.4 "-"
TCP_MISS/200 GET http://a.b.com/zufang/ SOURCEHASH_PARENT/1.2.3.4 "http://a.b.com/"
TCP_MISS/200 GET http://a.b.com/ad.ashx?ad=ad&amp;url=http://a.b.com/zufang/&amp;alias=zufang&amp;childalias=zufang SOURCEHASH_PARENT/1.2.3.4 "http://a.b.com/zufang/"
</code></pre>
<p>整个访问中，回源IP一直都是1.2.3.4，而且POST不再是302转404，而是200了~~</p>
      <a href="/2010/01/09/keep-sessions-between-client-cache-origin" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/09/intro-http_status" title="squid3新acl类型http_status试用（源站故障转向研究）" rel="bookmark">squid3新acl类型http_status试用（源站故障转向研究）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-09 00:00:00 +0800">09 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>今天试着自己编译安装了squid3.1，然后开始移植2.6的配置文件。在squid.conf.document（2.6里的squid.conf.default）里看了很久，发现不少新东西。跟转向有关的，便发现一个：</p>
<p>acl aclname http_status 200 301 500- 400-403
&hellip;
# status code in reply</p>
<p>这个acl配合http_access和deny_info，也是个转向的办法。（相反的，大家举例时一般用来deny的正是302跳转）</p>
<p>acl err http_status 500-
http_access deny err
deny_info http://err.tiaozhuan.com err</p>
<p>不过问题依旧：这个依然没法把不同的域名分开——deny_info只针对自己上头那个http_access deny的aclname，可要是写上同样aclname的astdomain或者url_regex，整个访问就都废了……
然后想到url_rewrite_access，如果用acl http_status配合url_rewrite_access，能不能做到避免所有请求回源确认呢？
按照之前记录的squid处理流程，squid应该是在和client建立连接后的第二步就检查acl。但3.1中添加的这个http_status，总不可能在命中的第四步或者回源的第六步之前，就能完成访问控制呀？
看来squid的内部机制，已经有了较大变化。
明天做个实验，看看实际到底如何吧~</p>
<hr />
<p>经过试验，第一个想法不可行。因为deny_info的status是TCP_DENY/302，这和acl是冲突的，导致无法工作。从此也能看出，http_status的acl确实是在比较晚的流程中才起作用的。分别使用http_status和url_regex做deny的日志如下：
    1263112949.310 27099 12.34.56.78 TCP_MISS/502 1878 GET http://a.b.com/duanzu/ - DIRECT/1.2.3.4 text/html &ldquo;http://a.b.com/&rdquo; &ldquo;Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; QQPinyinSetup 620; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30)&rdquo;
    1263113026.271 0 12.34.56.78 TCP_DENIED/302 331 GET http://a.b.com/duanzu/ - NONE/- text/html &ldquo;http://a.b.com/&rdquo; &ldquo;Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; QQPinyinSetup 620; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30)&rdquo;</p>
<p>acl err http_status 500-
url_rewrite_access deny !err</p>
<p>不起作用，所有的请求都不经过rewrite直接输出了……
郁闷，这个新acl的用法还得慢慢找资料~~</p>
      <a href="/2010/01/09/intro-http_status" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/05/principle-and-solution-of-the-vm-date-problem" title="虚拟机时间问题的机制原理及解决办法" rel="bookmark">虚拟机时间问题的机制原理及解决办法</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-05 00:00:00 +0800">05 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cloud-ref" title="cloud" rel="category tag">cloud</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>对于CDN来说，时间是个非常重要的概念，squid的缓存刷新控制，全都是以服务器时间为基准。在我博客的前不知道几篇的某文中，就提到过因为时间的原因引起的刷新事故。而最新的一次，是公司在日志流量统计时，因为相差太大导致截取失败——这可都是钱呢。
实际工作中，大多会搭建一个NTP服务器，给应用服务器提供时间同步服务。但虚拟机在这方面有个问题。虚拟机的时间是读取的宿主机的硬件时钟，随便你date
-s 1234怎么改，下一次date查看，都会恢复成原样。
这样看起来是个好事，因为这样可以省略掉大批机器的NTP服务器同步时间的压力。但糟糕的事情在后头：一大批重要客户的虚拟机，在运行上半年以上时间后，date都比真实时间超前了（偶然我也看到过一次滞后的）。或许是几分钟，或许是几小时！！
这一度让我很无奈，因为即使我重启虚拟机，这个诡异的date也依然倔强的按照它自己的时钟前进。看起来办法只有一个：把虚拟平台整个的重启——好在这种试验的结果是有效的，不然真不知道怎么办了。
从这个无奈的办法中，也应该可以推测出一个结论，虚拟机的时钟，应该是另有文件存储在虚拟平台的某个临时文件里。所以关闭虚拟机，该文件还存在并继续计时；重启动虚拟平台，该文件才会重计。至于这个文件叫什么，存放在哪里，一时半会我就找不到了，或许这个问题不算什么特别大的问题，至少我在linuxsir.org的《xen初学指南》中，没有找到关于时钟的配置说明。
不过再小的问题也顶不住人的研究。于是我找到了另一篇很对口的文章：《虚拟机中GUEST OS时钟(TIMEKEEP)问题的探讨》。
文章告诉我们：虚拟机的时钟，与真实机的时钟区别，其一在于其处理不是抢占中断而是延迟处理；其二在于其中断模拟软件可能因资源占用问题被推迟。
这两点区别，导致的结果却是一个，就是一旦服务器负载变高，时钟中断就被排到后头去了……
文章也提出了解决办法，一个是编程，让系统补上中断的时间，这个俺就不说了；一个是修改内核，让系统不断修正date；
进一步问题：不管哪个办法，第一，加重了虚拟机负载；第二，这又依赖与系统去更新date的进程的精准度，而这个进程的中断时钟如果有偏差的话，……
再进一步方法……有兴趣的还是自己点文章看吧。
看起来这个问题就要永远终结在此了。
不过变通的主意及时的出现了——既然虚拟机跟虚拟平台之间的异步时钟同步没法解决，我们就干脆不要虚拟机跟虚拟平台同步了。这样虽然对NTP的压力大了，但毕竟保证了CDN的正常。而且从上头的原理可以知道，能够导致date偏差到这个程度的原因，大概也是因为虚拟机的负载压力太大。事实上，我们为了保证冗余，也是尽量避免这种压力出现的。那么date偏差的服务器，其实也就是少数了。
顺着这个思路一查，原来办法其实很简单——修改虚拟机的independent_wallclock值即可：
echo 1 &gt; /proc/sys/xen/independent_wallclock
或sysctl xen.independent_wallclock=1
启用虚拟机独立系统时间；
/etc/init.d/ntpd stop
ntpdate 192.168.0.1
就能完成NTP时间同步了；
再date看看，时间果然就更正了~~
/proc下的文件都是进程使用中的文件，如果要让虚拟机开机自动读取配置，把这个修改写进/etc/sysctl.conf才行哦：
echo &ldquo;xen.independent_wallclock = 1&rdquo;&nbsp;&raquo; /etc/sysctl.conf
就这么简单~~~</p>
      <a href="/2010/01/05/principle-and-solution-of-the-vm-date-problem" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/01/limit-speed-in-squid" title="squid限速" rel="bookmark">squid限速</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-01 00:00:00 +0800">01 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>squid有个delay_pool，可以做限速，虽然效果不太准~（嗯，就像限制并发连接数的maxconn一样）
首先搬个老虎皮做大旗——《Squid: The Definitive Guide》的相关段落：</p>
<p>The buckets don&rsquo;t actually store bandwidth (e.g., 100 Kbit/s), but  <br />
rather some amount of traffic (e.g., 384 KB). Squid adds some  <br />
amount of traffic to the buckets each second. Cache clients take  <br />
some amount of traffic out when they receive data from an upstream  <br />
source (origin server or neighbor).  <br />
The size of a bucket determines how much burst bandwidth is  <br />
available to a client. If a bucket starts out full, a client can  <br />
take as much traffic as it needs until the bucket becomes empty.  <br />
The client then receives traffic allotments at the fill rate.  <br />
The mapping between Squid clients and actual buckets is a bit  <br />
complicated. Squid uses three different constructs to do it: access  <br />
rules, delay pool classes, and types of buckets. First, Squid  <br />
checks a client request against the delay_access list. If the  <br />
request is a match, it points to a particular delay pool. Each  <br />
delay pool has a class: 1, 2, or 3. The classes determine which  <br />
types of buckets are in use. Squid has three types of buckets:  <br />
aggregate, individual, and network:  <br />
A class 1 pool has a single aggregate bucket.  <br />
A class 2 pool has an aggregate bucket and 256 individual  <br />
buckets.  <br />
A class 3 pool has an aggregate bucket, 256 network buckets, and  <br />
65,536 individual buckets.  <br />
As you can probably guess, the individual and network buckets  <br />
correspond to IP address octets. In a class 2 pool, the individual  <br />
bucket is determined by the last octet of the client&rsquo;s IPv4  <br />
address. In a class 3 pool, the network bucket is determined by the  <br />
third octet, and the individual bucket by the third and fourth  <br />
octets.  <br />
For the class 2 and 3 delay pools, you can disable buckets you  <br />
don&rsquo;t want to use. For example, you can define a class 2 pool with  <br />
only individual buckets by disabling the aggregate bucket.  <br />
When a request goes through a pool with more than one bucket type,  <br />
it takes bandwidth from all buckets. For example, consider a class  <br />
3 pool with aggregate, network, and individual buckets. If the  <br />
individual bucket has 20 KB, the network bucket 30 KB, but the  <br />
aggregate bucket only 2 KB, the client receives only a 2-KB  <br />
allotment. Even though some buckets have plenty of traffic, the  <br />
client is limited by the bucket with the smallest amount.  <br />
C.2 Configuring Squid  <br />
Before you can use delay pools, you must enable the feature when  <br />
compiling. Use the —enable-delay-pools option when running  <br />
./configure. You can then use the following directives to set up  <br />
the delay pools.  <br />
C.2.1 delay_pools  <br />
The delay_pools directive tells Squid how many pools you want to  <br />
define. It should go before any other delay pool-configuration  <br />
directives in squid.conf. For example, if you want to have five  <br />
delay pools:  <br />
delay_pools 5  <br />
The next two directives actually define each pool&rsquo;s class and other  <br />
characteristics.  <br />
C.2.2 delay_class  <br />
You must use this directive to define the class for each pool. For  <br />
example, if the first pool is class 3:  <br />
delay_class 1 3  <br />
Similarly, if the fourth pool is class 2:  <br />
delay_class 4 2  <br />
In theory, you should have one delay_class line for each pool.  <br />
However, if you skip or omit a particular pool, Squid doesn&rsquo;t  <br />
complain.  <br />
C.2.3 delay_parameters  <br />
Finally, this is where you define the interesting delay pool  <br />
parameters. For each pool, you must tell Squid the fill rate and  <br />
maximum size for each type of bucket. The syntax is:  <br />
delay_parameters N rate/size [rate/size [rate/size]]  <br />
The rate value is given in bytes per second, and size in total  <br />
bytes. If you think of rate in terms of bits per second, you must  <br />
remember to divide by 8.  <br />
Note that if you divide the size by the rate, you&rsquo;ll know how long  <br />
it takes (number of seconds) the bucket to go from empty to full  <br />
when there are no clients using it.  <br />
A class 1 pool has just one bucket and might look like this:  <br />
delay_class 2 1  <br />
delay_parameters 2 2000/8000  <br />
For a class 2 pool, the first bucket is the aggregate, and the  <br />
second is the group of individual buckets. For example:  <br />
delay_class 4 2  <br />
delay_parameters 4 7000/15000 3000/4000  <br />
Similarly, for a class 3 pool, the aggregate bucket is first, the  <br />
network buckets are second, and the individual buckets are  <br />
third:  <br />
delay_class 1 3  <br />
delay_parameters 1 7000/15000 3000/4000 1000/2000  <br />
C.2.4 delay_initial_bucket_level  <br />
This directive sets the initial level for all buckets when Squid  <br />
first starts or is reconfigured. It also applies to individual and  <br />
network  <br />
buckets, which aren&rsquo;t created until first referenced. The value is  <br />
a percentage. For example:  <br />
delay_initial_bucket_level 75%  <br />
In this case, each newly created bucket is initially filled to 75%  <br />
of its maximum size.  <br />
C.2.5 delay_access  <br />
This list of access rules determines which requests go through  <br />
which delay pools. Requests that are allowed go through the delay  <br />
pools, while those that are denied aren&rsquo;t delayed at all. If you  <br />
don&rsquo;t have any delay_access rules, Squid doesn&rsquo;t delay any  <br />
requests.  <br />
The syntax for delay_access is similar to the other access rule  <br />
lists (see Section 6.2), except that you must put a pool number  <br />
before the allow or deny keyword. For example:  <br />
delay_access 1 allow TheseUsers  <br />
delay_access 2 allow OtherUsers  <br />
Internally, Squid stores a separate access rule list for each delay  <br />
pool. If a request is allowed by a pool&rsquo;s rules, Squid uses that  <br />
pool and stops searching. If a request is denied, however, Squid  <br />
continues examining the rules for remaining pools. In other words,  <br />
a deny rule causes Squid to stop searching the rules for a single  <br />
pool but not for all pools.  <br />
C.2.6 cache_peer no-delay Option  <br />
The cache_peer directive has a no-delay option. If set, it makes  <br />
Squid bypass the delay pools for any requests sent to that  <br />
neighbor.    </p>
<p>然后说老实话：我也看不太懂……
只好贴一些百度出来的结果：
    class类型1为单个IP地址流量  <br />
    class类型2为C类网段中的每个IP地址流量  <br />
    class类型3为B类网段中的每个C类网段中的每个IP地址流量  <br />
具体的说：
    类型1只有一个总带宽流量实际也就是这个IP地址的流量  <br />
    delay_parameters 1 64000/64000  <br />
    类型2有两个带宽流量参数，第一个为整个C类型网段流量，第二个为每个IP流量  <br />
    delay_parameters 1 -1/-1 64000/64000  <br />
    类型3有三个带宽流量参数,第一个为整个B类网总流量，第二个为每个B类网段中的C类网段总流量,第三个为了B类网段中每个C类网段中的每个IP流量  <br />
    delay_parameters 1 -1/-1 -1/-1 64000/64000  <br />
但似乎我还没百度到谁用class为2或者3的。一般大家都只用1……
举个例子：
两个域名，分别限制网民下载速度为50kb/s和100kb/s。配置如下：</p>
<div class="highlight"><pre><code class="squid"><span class="c">#定义域名</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>LIMIT_A<span class="w"> </span><span class="k">dstdomain</span><span class="w"> </span>a.test.com<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>LIMIT_B<span class="w"> </span><span class="k">dstdomain</span><span class="w"> </span>b.test.com<span class="w"></span>
<span class="c">#定义受限IP段</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>LIMIT_IP<span class="w"> </span><span class="k">src</span><span class="w"> </span><span class="mf">192.168.1.0/24</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span><span class="no">ALL</span><span class="w"> </span><span class="k">src</span><span class="w"> </span><span class="m">0</span>/0<span class="w"></span>
<span class="c">#开启两个连接延迟池</span><span class="w"></span>
<span class="k">delay_pools</span><span class="w"> </span><span class="m">2</span><span class="w"></span>
<span class="c">#定义两个延迟池，class类型均为1</span><span class="w"></span>
<span class="k">delay_class</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="k">delay_class</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="c">#分配域名到不同的延迟池</span><span class="w"></span>
<span class="k">delay_access</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>LIMIT_A<span class="w"></span>
<span class="k">delay_access</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>LIMIT_B<span class="w"></span>
<span class="c">#受限网段延迟池</span><span class="w"></span>
<span class="k">delay_access</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>LIMIT_IP<span class="w"></span>
<span class="c">#定义下载速率，速率定位为restore(bytes/sec)/max(bytes)，，restore是表示以bytes/sec的速度下載object到bucket裡，而max則表示buckets的bytes值</span><span class="w"></span>
<span class="k">delay_parameters</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">50000</span>/50000<span class="w"></span>
<span class="k">delay_parameters</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">100000</span>/100000<span class="w"></span>
<span class="c">#squid启动时初始化的池的带宽百分比</span><span class="w"></span>
<span class="k">delay_initial_bucket_level</span><span class="w"> </span><span class="m">100</span><span class="w"></span>
</code></pre></div>
<p>据网友的测试，当限速配置为20000/20000即20000/1024=19.53kb/s的时候，实际的下载速度大概在11-15kb/s之间。</p>
      <a href="/2010/01/01/limit-speed-in-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/12/31/process-of-request-to-squid" title="squid请求处理流程（源站故障转向研究）" rel="bookmark">squid请求处理流程（源站故障转向研究）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-31 00:00:00 +0800">31 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>今天继续想别的办法，第一，当然还是修改源代码，这个C++可惜俺不懂，只是大略的通过百大哥谷大婶知道了squid的请求处理流程：</p>
<ol>
  <li>客户端和squid建立连接（client-side模块、clientBeginRequest()函数）；</li>
  <li>检查ACL访问控制；</li>
  <li>检查重定向；</li>
  <li>检查缓存命中（GetMoreData()函数），写入StoreEntry（client-side模块）；
4.1. 命中（client-side模块）；
4.2. 未命中（rotoDispatch()函数启动peer算法，算法检查never|always_direct）；</li>
  <li>收到ICP响应，选择中止，转发请求（protoStart()函数）；</li>
  <li>打开到源站或peer的连接（HTTP模块），发起请求（NetworkCommunication模块），建立连接并处理异常（comm.c程序）；</li>
  <li>建立写缓存（HTTP模块），将请求写入socket；</li>
  <li>建立相应的socket读缓存，接受处理HTTP响应（即，如果已有socket，可以跳过6、7步）；</li>
  <li>响应被接受，squid接收到header信息，并在被读取时把data追加进StoreEntry，同时通知client-side模块，这个过程的速度取决于delay_pools；</li>
  <li>client-side模块从StoreEntry取数据，并写入客户端socket；</li>
  <li>客户端读取完成，数据根据情况（refresh、cache）存入磁盘；</li>
  <li>回源取完数据，标记StoreEntry为“完成”（client-side模块），socket关闭或保留到持久连接池；</li>
  <li>数据写入客户端socket完成，从StoreEntry注释掉client-side模块，同样，关闭或等待客户端连接请求。</li>
</ol>
<p>原先的想法就是在第3步，而缓存在第4步，所以不行。也就是说，必须在第4步以后操作，才能不影响CDN的命中率。很显然，我注意到一个词，第6步中“建立链接并处理异常”的comm.c程序；其次，第9步“响应被接受”，也就是说，可能建立链接但没响应，这里就应该是socket的存活过期时间来决定。<br /></p>
<p>思路到此为止，往下就是编程开发能力的事儿了，哭ing~~</p>
<p>第二个办法，还在squid本身上做文章。我注意到，处理流程的4.2步上，squid是同时检查源站和cache_peer的。那么，在源站故障的时候，cache_peer可以设成其他服务器顶上。这样的情况，不单解决一个url跳转，还能做一个源站备份。配置如下：</p>
<div class="highlight"><pre><code class="squid">nonhierarchical_direct<span class="w"> </span><span class="no">off</span><span class="w"></span>
<span class="k">prefer_direct</span><span class="w"> </span><span class="no">on</span><span class="w"></span>
<span class="k">cache_peer</span><span class="w"> </span><span class="mf">192.168.1.1</span><span class="w"> </span><span class="no">parent</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="no">no-query</span><span class="w"> </span>originserver<span class="w"> </span>name=S1<span class="w"></span>
<span class="k">cache_peer</span><span class="w"> </span><span class="mf">192.168.1.2</span><span class="w"> </span><span class="no">parent</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="no">no-query</span><span class="w"> </span>name=S2<span class="w"></span>
<span class="k">cache_peer</span><span class="w"> </span><span class="mf">192.168.1.3</span><span class="w"> </span><span class="no">parent</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="no">no-query</span><span class="w"> </span>name=S3<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>myservice<span class="w"> </span><span class="k">dstdomain</span><span class="w"> </span>.site.com<span class="w"></span>
<span class="k">cache_peer_access</span><span class="w"> </span>S1<span class="w"> </span><span class="no">allow</span><span class="w"> </span>myservice<span class="w"></span>
<span class="k">cache_peer_access</span><span class="w"> </span>S2<span class="w"> </span><span class="no">allow</span><span class="w"> </span>myservice<span class="w"></span>
<span class="k">cache_peer_access</span><span class="w"> </span>S3<span class="w"> </span><span class="no">allow</span><span class="w"> </span>myservice<span class="w"></span>
</code></pre></div>
<p>第一句的意思，就是当originserver挂了，不可层叠的请求（即hierarchy_stoplist定义的）就“可能”发往其他peer。</p>
<p>第二句的意思，就是所有优先originserver，只有挂了以后才去peer，这个配置针对的可cache的请求。</p>
<p>不过两句加起来，还有那些不再hierarchy_stoplist定义又不cache的（没实验，不知道这个可cache是指squid配置还是包括origin的header设置），可就没办法了，也不全面。</p>
      <a href="/2009/12/31/process-of-request-to-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/12/30/system-function-in-awk" title="awk中让人郁闷的system()函数" rel="bookmark">awk中让人郁闷的system()函数</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-30 00:00:00 +0800">30 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>发现一个特尴尬的事实。我辛辛苦苦去百度资料，想用rewrite实现针对不同域名源站故障后的自动跳转功能，但整个思路里遗漏了一个严重的问题。</p>
<p>按我的思路，针对请求的url进行一次curl，然后根据http_code去改写url或者原样输出——这也就意味着，每一个请求，squid都回源去取一次header。那么对于源站来说，前面squid的缓存率，就是0%！完全没有效果。</p>
<p>得重新想过办法……难道去看squid源代码？汗</p>
<p>本着有头有尾善始善终的原则，决定还是把原先那个鸡肋想法写完。根据squid权威指南11章的说法，传递给重定向器的流格式为：URL IP/FQDN IDENT METHOD，其中FQDN和ident经常是空。METHOD，一般是GET和POST，squid只能缓存GET的数据，但不能无视POST方式，因为有时候POST数据header太大的话，squid可能拒绝转发这些内容，这就不好玩了。</p>
<p>在明确这个格式以后（主要是草草收尾的想法影响下），我便觉得其实完全不用perl或者php来搞，简单的awk就足够了——当然，shell不行，因为shell不能从事这种流状的行处理。</p>
<p>以下是本着我想法写的awk脚本：</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/awk -f</span>
<span class="o">{</span>
  <span class="k">if</span><span class="o">(</span>system<span class="o">(</span><span class="s2">&quot;curl -o /dev/null -s -w %{http_code}&quot;</span> <span class="nv">$1</span><span class="o">)</span>~/^<span class="o">[</span>2|3<span class="o">]</span>/<span class="o">){</span>
    print <span class="s2">&quot;:$1&quot;</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    print <span class="s2">&quot;:http://www.baidu.com/&quot;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>但是再度让我郁闷的事情接连发生。</p>
<p>第一，不管我在{}中进行什么操作，程序都把system()的结果print出来了；</p>
<table>
  <tbody>
    <tr>
      <td>第二，即使system()的结果是200，print出来的也是else{}的&rdquo;http://www.baidu.com&rdquo;；而如果我直接试验if(200~/^[2</td>
      <td>3]/){}else{}，结果就很正常！</td>
    </tr>
  </tbody>
</table>
<p>试验过程如下：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>rao@localhost ~<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;http://www.google.com&quot;</span>|awk <span class="s1">&#39;{if(200~/^[2|3]/){ print &quot;:&quot;$1 } else{ print &quot;:http://www.baidu.com/&quot;}}&#39;</span>
:http://www.google.com
<span class="o">[</span>rao@localhost ~<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;http://www.google.com&quot;</span>|awk <span class="s1">&#39;{if(system(&quot;curl -o /dev/null -s -w %{http_code} &quot;$1)~/^[2|3]/){print &quot;:&quot;$1 } else{ print &quot;:http://www.baidu.com/&quot;}}&#39;</span>
200:http://www.baidu.com/
</code></pre></div>
<table>
  <tbody>
    <tr>
      <td>思前想后，在百度大婶的帮助下，终于搞明白一个问题：system()的结果是直接返回给shell显示了，然后再由awk继续执行后面的程序，这种情况下，if()里留下的其实是system()的执行状态【即0或1】&rdquo;0&rdquo;~/^[2</td>
      <td>3]/，当然就一直执行else了。</td>
    </tr>
  </tbody>
</table>
<p>糟糕的问题是awk的getline，无法直接把system()的执行结果导入awk的变量…除非我先system里&gt;一个文件，然后getline&lt;这个文件。MyGod！</p>
<table>
  <tbody>
    <tr>
      <td>而如果采用while(&ldquo;curl&rdquo;</td>
      <td>getline var)的执行方式，如何传递shell变量进去又成了问题……唉</td>
    </tr>
  </tbody>
</table>
      <a href="/2009/12/30/system-function-in-awk" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/12/30/squid-gzip" title="squid3 的 gzip 支持" rel="bookmark">squid3 的 gzip 支持</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-30 00:00:00 +0800">30 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>标题很简单，内容很复杂，而且我也用不上。姑且存档吧：
原标题《VIGOS eCAP GZIP Adapter for SQUID Proxy Cache》
第一句话就让我很绝望，本插件只适用于squid3.1及以上版本——squid有比3.1更高的版本么——前文提到的有session控制的squid2.7我都还没看呢~哭</p>
<p>办法：</p>
<div class="highlight"><pre><code class="bash">wget http://www.measurement-factory.com/tmp/ecap/libecap-0.0.2.tar.gz
wget http://www.vigos.com/products/eCAP/vigos-ecap-gzip-adapter-1.1.0.tar.gz
wget http://www.squid-cache.org/Versions/v3/3.1/squid-3.1.0.9.tar.gz
tar xvfz squid-3.1.0.9.tar.gz
tar xvfz libecap-0.0.2.tar.gz
tar xvfz vigos-ecap-gzip-adapter-1.1.0.tar.gz
<span class="nb">cd </span>libecap-0.0.2/
./configure
make
make install
<span class="nb">cd</span> ../vigos-ecap-gzip-adapter-1.1.0/
./configure
make
make install
<span class="nb">cd</span> ../squid-3.1.0.9/
./configure --enable-ecap
make
make install
cat &gt;&gt; etc/squid.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">ecap_enable on</span>
<span class="s">ecap_service gzip_service respmod_precache 0</span>
<span class="s">ecap://www.vigos.com/ecap_gzip</span>
<span class="s">loadable_modules /usr/local/lib/ecap_adapter_gzip.so</span>
<span class="s">acl GZIP_HTTP_STATUS http_status 200</span>
<span class="s">adaptation_access gzip_service allow GZIP_HTTP_STATUS</span>
<span class="s">EOF</span>
</code></pre></div>
<p>以上，3.1毕竟还是测试版，这个留待以后吧~~</p>
<p>另，据《squid中文权威指南》作者潘勇华的blog说，这个“基于squid3.1的eCAP接口的流量压缩适配器”，对被自己压缩过的内容，简单的把Etag删除。</p>
      <a href="/2009/12/30/squid-gzip" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page12">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page active">
      <a href="#">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li>
      <a href="/page14">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.icylife.net/blog/" title="">心路</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://dbahacker.com/" title="TB 杨德华">DBA Hacker</a></li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.laird-sa.com/" title="">Laird-SA</a></li>
              <li><a href="http://www.linuxsee.com/" title="">LinuxSEE</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://www.puppeter.cn/" title="">piol</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.sanote.org/" title="">sa note</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://blog.ops.tudou.com/wp/" title="">土豆运营团队</a></li>
              <li><a href="http://www.91tuanfang.com/" title="安居客运维">家欣的天空</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://www.opboy.com" title="">运维小子</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://l09.me/" title="风声">风声</a></li>
              <li><a href="http://moyan.tk/" title="莫言">莫言</a></li>
              <li><a href="http://mooser.me/" title="牛氓">牛氓</a></li>
              <li><a href="http://http://www.yinwang.org/" title="当然我在扯淡">当然我在扯淡</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://muxueqz.laou.me" title="muxueqz">聊逍遥兮容与</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://paperplane.ruhoh.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://blog.sectop.org/" title=""></a></li>
          </ul>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
