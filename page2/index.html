<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/10/26/selinux-affect-to-apache-documentroot" title="selinux 对 webserver 文件发布的影响" rel="bookmark">selinux 对 webserver 文件发布的影响</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-10-26 00:00:00 +0800">26 Oct 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>SELinux 在国内是一个很少有人用的东西，一般来说，服务器上手第一件事情就是把 SELinux 关掉，以至于有问题的时候排查思路里都压根没检查 SELinux 这步。</p>
<p>昨天在个人电脑的 Fedora 上搭建一个 webserver 发布几个文件，本来想着简单任务越快越好，几行命令完成：</p>
<div class="highlight"><pre><code class="bash">sudo yum install httpd
sudo mv ~/src /var/www/html/
sudo service httpd start
</code></pre></div>
<p>结果居然一直返回 <code>403 Denied</code>！</p>
<p>看 httpd 的 error.log ，一直报这么一行错误：</p>
<pre><code>[core:error] [pid 3806] (13)Permission denied: [client 127.0.0.1:59180] AH00035: access to /src/master.zip denied (filesystem path '/var/www/html/src') because search permissions are missing on a component of the path
</code></pre>
<p>很奇怪吧，于是我先去确认了 httpd.conf 里关于 <code>&lt;Directory "/var/www/html"&gt;</code> 的配置(因为 Fedora19 的 httpd 版本是 2.4.6，我以为新版本有变化了)，然后去确认了 <code>/var/www/html/src</code> 的权限是不是 755，其他用户可读的。都没问题！</p>
<p>最后还是在 apache 的 httpd 官方文档上找到了关于这个错误码的详细解释，原来还有一种可能性，就是 SELinux 的安全控制！这个可以通过下面这个命令看到：</p>
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>ls -lZ /var/www /var/www/html
/var/www:
drwxr-xr-x. root   root   system_u:object_r:httpd_sys_script_exec_t:s0 cgi-bin
drwxr-xr-x. apache apache system_u:object_r:httpd_sys_content_t:s0 html
/var/www/html:
drwxr-xr-x. chenlin.rao chenlin.rao unconfined_u:object_r:user_home_t:s0 src
</code></pre></div>
<p>看到没有，这里这些文件的 SELinux 类型是不一样的，默认的 <code>/var/www/html</code> 是 <code>httpd_sys_content_t</code>，<code>/var/www/cgi-bin</code> 是 <code>httpd_sys_script_exec_t</code>，而从我家目录移过去的 <code>/var/www/html/src</code> 是 <code>user_home_t</code>！</p>
<p>解决办法也很简单，把这个类型也改过来就好了：</p>
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>chcon -R -t httpd_sys_content_t /var/www/html/src
</code></pre></div>
<p>这是第一次接触 SELinux 的安全管理，真的是好细致！</p>
      <a href="/2013/10/26/selinux-affect-to-apache-documentroot" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/10/25/intro-plenv" title="用 plenv 代替 perlbrew 管理 Perl5" rel="bookmark">用 plenv 代替 perlbrew 管理 Perl5</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-10-25 00:00:00 +0800">25 Oct 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>我们都知道有 virtualenv 啊，rvm 啊之类的工具来管理 python，ruby的多版本问题，后来台湾的朋友也引入到了 Perl 世界，这就是 perlbrew。</p>
<p>不过 perlbrew 在使用的时候，有个非常让我不理解的地方，就是切换 Perl 版本后，整个终端的环境变量都被清空了。后来发现了一个新项目，叫 plenv，没错，一眼就可以看出来这是 rlenv 工具的 Perl 版。</p>
<p>和 perlbrew 不一样，目前版本的 plenv 已经是一个纯粹的 shell 工具。说起来原先一直是 shell 工具的 rvm，这周却在募捐准备改用 Ruby 重写了(据说是因为已经 2 万行的 bash 代码，作者快控制不住了)。</p>
<p>用法非常简单：</p>
<div class="highlight"><pre><code class="bash">git clone git://github.com/tokuhirom/plenv.git ~/.plenv
<span class="nb">echo</span> <span class="s1">&#39;export PATH=&quot;$HOME/.plenv/bin:$PATH&quot;&#39;</span> &gt;&gt; ~/.bash_profile
<span class="nb">echo</span> <span class="s1">&#39;eval &quot;$(plenv init -)&quot;&#39;</span> &gt;&gt; ~/.bash_profile
<span class="nb">exec</span> <span class="nv">$SHELL</span> -l <span class="c"># 这步相当于退出重登录终端</span>
git clone git://github.com/tokuhirom/Perl-Build.git ~/.plenv/plugins/perl-build/
plenv install 5.18.0
plenv rehash <span class="c"># 每次在 $HOME/.plenv/bin 下安装了新的命令后都要执行一次这个</span>
plenv install-cpanm
plenv rehash
plenv shell 5.18.0 <span class="c"># 还有 global 和 local 两者可设</span>
</code></pre></div>
<p>目前我已经用 plenv 管理自己电脑上的 Perl5 了，你们呢？</p>
      <a href="/2013/10/25/intro-plenv" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/10/16/perl-overload" title="Perl 的 overload 妙用" rel="bookmark">Perl 的 overload 妙用</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-10-16 00:00:00 +0800">16 Oct 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在使用 Mojolicious 的时候，通常我们会发现一个很有趣的现象。</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">ojo</span><span class="p">;</span>
<span class="n">say</span> <span class="n">g</span><span class="p">(</span><span class="s">&#39;http://www.baidu.com&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dom</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="s">&#39;script&#39;</span><span class="p">);</span>
<span class="n">say</span> <span class="n">g</span><span class="p">(</span><span class="s">&#39;http://www.baidu.com&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dom</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="s">&#39;script&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">;</span>
</code></pre></div>
<p>这里可以看到，在用 <code>at()</code> 方法之后得到的结果，如果从上一行解读，似乎应该是一个字符串；但是从下一行解读，又还是一个对象，可以继续调用 <code>-&gt;text</code> 属性。</p>
<p>Perl 本身不是一个纯对象式的语言，字符串本身是没有对象属性的。而直接打印对象的话，应该输出的是类似 <code>Mojo::DOM-&gt;HASH(0x1234567)</code> 的效果。那这个效果是怎么实现的呢？</p>
<p>翻了 Mojo 的代码之后，发现原来 Mojo 里是把字符串、数组等都实现成了对象，分别是 <code>Mojo::ByteStream</code> 和 <code>Mojo::Collection</code> 两个类。然后再实现中，运用了 <code>overload</code> 来实现这个效果。代码很简单，<code>Mojo::ByteStream</code> 里是这样的：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">overload</span> <span class="s">&#39;&quot;&quot;&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="nb">shift</span><span class="o">-&gt;</span><span class="n">to_string</span> <span class="p">},</span> <span class="n">fallback</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">to_string</span> <span class="p">{</span> <span class="nv">$</span><span class="p">{</span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span> <span class="p">}</span>
</code></pre></div>
<p>此外， <code>Mojo::DOM</code>，<code>Mojo::URL</code>，<code>Mojo::JSON</code> 等十多个类中都用了这个方法。</p>
<p>看起来似乎还不是很明了，再贴两段 <a href="http://perldoc.perl.org/overload.html">overload 的 POD</a> 就清楚了：</p>
<pre><code>It also defines an anonymous subroutine to implement stringification: this is called whenever an object blessed into the package Number is used in a string context...
For example, the subroutine for '""' (stringify) may be used where the overloaded object is passed as an argument to print,...
</code></pre>
<p>这下清楚了吧。一旦在某个类里 <code>overload</code> 了双引号，那么这个类的对象在标量环境下调用的时候就会先调用这个函数。最典型的例子就是用在 <code>print</code> 的时候。</p>
<p>下面我们可以自己也试试：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="n">Test</span> <span class="mf">0.01</span> <span class="p">{</span>
    <span class="k">use</span> <span class="n">overload</span> <span class="s">&#39;&quot;&quot;&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="nb">join</span> <span class="s">&quot; overloaded.\n&quot;</span><span class="p">,</span> <span class="nv">@</span><span class="p">{</span><span class="o">+</span><span class="nb">shift</span><span class="p">}</span> <span class="p">};</span>
    <span class="k">sub </span><span class="nf">new</span> <span class="p">{</span> <span class="nb">bless</span> <span class="p">[</span><span class="nv">@_</span><span class="p">[</span><span class="mi">1</span> <span class="o">..</span> <span class="nv">$#_</span><span class="p">]],</span> <span class="nb">shift</span> <span class="p">};</span>
<span class="p">}</span>
<span class="k">my</span> <span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Test</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">print</span> <span class="nv">$obj</span><span class="p">;</span>
</code></pre></div>
<p>输出结果：</p>
<pre><code>1 overloaded.
3 overloaded.
2
</code></pre>
      <a href="/2013/10/16/perl-overload" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/10/09/using-elasticsearch-and-logstash-to-serve-billions-of-searchable-events-for-customers" title="【翻译】用 elasticsearch 和 logstash 为数十亿次客户搜索提供服务" rel="bookmark">【翻译】用 elasticsearch 和 logstash 为数十亿次客户搜索提供服务</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-10-09 00:00:00 +0800">09 Oct 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>原文地址：<a href="http://www.elasticsearch.org/blog/using-elasticsearch-and-logstash-to-serve-billions-of-searchable-events-for-customers/">http://www.elasticsearch.org/blog/using-elasticsearch-and-logstash-to-serve-billions-of-searchable-events-for-customers/</a></p>
<hr />
<p><em>今天非常高兴的欢迎我们的第一个外来博主，Rackspace软件开发工程师，目前为Mailgun工作的 <a href="https://twitter.com/ralphm">Ralph Meijer</a>。我们在 <a href="http://monitorama.eu/">Monitorama EU</a> 会面后，Ralph 提出可以给我们写一篇 Mailgun 里如何使用 Elasticsearch 的文章。他本人也早就活跃在 Elasticsearch 社区，经常参加我们在荷兰的聚会了。</em></p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/09/mailgun_150-300x85.png" alt="" /></p>
<p><a href="http://www.mailgun.com/">Mailgun</a> 收发大量电子邮件，我们跟踪和存储每封邮件发生的每个事件。每个月会新增数十亿事件，我们都要展示给我们的客户，方便他们很容易的分析数据，也就是全文搜索。下文是我们利用Elasticsearch和Logstash技术完成这个需求的技术细节（很高兴刚写完这篇文章就听说《<a href="http://elasticsearch.com/blog/welcome-jordan-logstash/">Logstash加入Elasticsearch</a>》了）。</p>
<h1 id="section">事件</h1>
<p>在 Mailgun 里，event可能是如下几种：进来一条信息，可能被接收可能被拒绝；出去一条信息，可能被投递可能被拒绝(垃圾信息或者反弹)；信息是直接打开还是通过链接点击打开；收件人要求退订。所有这些事件，都有一些元信息可以帮助我们客户找出他们的信息什么时候，为什么，发生了什么。这个元信息包括：信息的发送者，收件人地址，信息id，SMTP错误码，链接URL，geo地理位置等等。</p>
<p>每个事件都是由一个时间戳和一系列字段构成的。一个典型的事件就是一个关联数组，或者叫字典、哈希表。</p>
<h1 id="section-1">事件访问设计</h1>
<p>假设我们已经有了各种事件，现在需要一个办法来给客户使用。在Mailgun的控制面板里，有一个日志标签，可以以时间倒序展示事件日志，并且还可以通过域名和级别来过滤日志，示例如下：</p>
<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/mailgun_log_sample.png" alt="" /></p>
<p>在这个示例里，这个事件的级别是&rdquo;warn&rdquo;，因为SMTP错误码说明这是一个临时性问题，我们稍后会重试投递。这里有两个字段，一个时间戳，一个还没格式化的非结构化文本信息。为了醒目，这里我们会根据级别的不同给事件上不同的底色。</p>
<p>在这个网页之后，我还有一个接收日志的API，一个设置触发报警的hook页面。后面的报警完全是结构化了的带有很多元数据字段的JSON文档。比如，SMTP错误码有自己的字段，收件人地址和邮件标题等也都有。</p>
<p>不幸的是，原有的日志API非常有限。他只能返回邮件投递时间和控制面板里展示的非结构化的文本内容。没办法获取或者搜索多个字段(像报警页面里那样)，更不要说全文搜索了。简单说，就是控制面板缺乏全文搜索。</p>
<h1 id="elasticsearch">用elasticsearch存储和响应请求</h1>
<p>要给控制面板提供API和访问，我们需要一个新的后端来弥补前面提到的短板，包括下面几个新需求：</p>
<ul>
  <li>允许大多数属性的过滤。</li>
  <li>允许全文搜索。</li>
  <li>支持存储至少30天数据，可以有限度的轮滚。</li>
  <li>添加节点即可轻松扩展。</li>
  <li>节点失效无影响。</li>
</ul>
<p>而Elasticsearch，是一个可以“准”实时入库、实时请求的搜索引擎。它基于Apache Lucene，由存储索引的节点组成一个分布式高可用的集群。单个节点离线，集群会自动把索引(的分片)均衡到剩余节点上。你可以配置具体每个索引有多少分片，以及这些分片该有多少副本。如果一个主分片离线，就从副本中选一个出来提升为主分片。</p>
<p>Elasticsearch 是面向文档的，某种层度上可以说也是无模式的。这意味着你可以传递任意JSON文档然后就可以索引成字段。对我们的事件来说完全符合要求。</p>
<p>Elasticsearch 同样还有一个非常强大的请求/过滤接口，可以对特定字段搜索，也可以做全文搜索。</p>
<h1 id="elasticsearch-1">事件存入elasticsearch</h1>
<p>有很多工具或者服务可以用来记录事件。我们最终选择了 <a href="http://logstash.net/">Logstash</a>，一个搜集、分析、管理和传输日志的工具。</p>
<p>在内部，通过webhooks推送来的event同时在我们系统的其他部分也有使用，目前我们是用Redis来完成这个功能。Logstash有一个Redis输入插件来从Redis列表里接收日志事件。通过几个小过滤器后，事件通过一个输出插件输出。最常用的输出插件就是 Elasticsearch 插件。</p>
<p>利用 Elasticsearch 丰富的 API 最好的办法就是使用 Kibana，这个工具的口号是“让海量日志有意义”。目前最新的 <a href="http://three.kibana.org/">Kibana 3</a> 是一个纯粹的 JavaScript 客户端版，随后也会成为 Logstash 的默认界面。和之前的版本不同的是，它不在依赖于一个类Logstash模式，而是可以用于任意Elasticsearch索引。</p>
<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/kibana%20events%202.png" alt="" /></p>
<h1 id="section-2">认证</h1>
<p>到这步，我们已经解决了事件集中的问题，也有了丰富的API来深入解析日志。但是我们不想把所有日志都公开给每个人，所以我们需要一个认证，目前Elasticsearch 和 Kibana 都没提供认证功能，所以寄希望于 Elasticsearch API 是不可能的了。</p>
<p>我们选择了构建双层代理。一层代理用来做认证和流量限速，一层用来转义我们的事件 API 成 Elasticsearch 请求。前面这层代理我们已经以 Apache 2.0 开原协议发布在Github上，叫 <a href="https://github.com/mailgun/vulcan">vulcan</a> 。我们还把我们原来的那套日志 API 也转移到了 Elasticsearch 系统上。</p>
<h1 id="section-3">索引设计</h1>
<p>有很多种方法来确定你如何组织自己的索引，基于文档的数目(每个时间段内)，以及查询模式。</p>
<p>Logstash 默认每天创建一个新索引，包括当天收到的全部时间。你可以通过配置修改这个时间，或者采用其他属性来区分索引，比如每个用户一个，或者用事件类型等等。</p>
<p>我们这里每秒有1500个时间，而且我们希望每个账户的轮转时间段都是可配置的。可选项有：</p>
<ul>
  <li>一个大索引。</li>
  <li>每天一个索引。</li>
  <li>每个用户账户一个索引。</li>
</ul>
<p>当然，如果需要的话，这些都可以在未来进一步切分，比如根据事件类型。</p>
<p>管理轮滚的一个办法是在 Elasticsearch 中给每个文档设定 <a href="http://www.elasticsearch.org/guide/reference/mapping/ttl-field/">TTLs</a> 。到了时间  Elasticsearch 就会批量删除过期文档。这种做法使得定制每个账户的轮转时间变得很简单，但是也带来了更多的 IO 操作。</p>
<p>另一个轻量级的办法是直接删除整个索引。这也是 Logstash 默认以天创建索引的原因。过了这天你直接通过 crontab 任务删除索引即可。</p>
<p>不过后面这个办法就没法定制轮转了。我们有很多用户账户，给每个用户每天保持一个索引是不切实际的。当然，给所有用户每天存一个索引又意味着我们要把所有数据都存磁盘上。如果一个账户是保持两天数据的轮转，那么在缓存中的数据就是有限的。在查询多天的垃圾邮件时，处理性能也就受限了。所以，我们需要保留更多的日志以供Kibana访问。</p>
<h1 id="section-4">映射</h1>
<p>为了定义文档(中的字段)如何压缩、索引和存储在索引里，Elasticsearch 有一个叫做 <a href="http://www.elasticsearch.org/guide/reference/mapping/">mapping</a> 的概念。所以为每个字段它都定义了类型，定义了如何分析和标记字段的值以便索引和查询，定义了值是否需要存储，以及其他各种设置。默认的情况，mapping是动态的，也就是说 Elasticsearch 会从它获得的第一个值来尝试猜测字段的类型，然后正式应用这个设置到索引。</p>
<p>如果你的数据来源单一，这样就很好了。但实际可能来源很复杂，或者日志类型根本就不一样，比如我们这，同一个名字的字段的数据类型可能都不一样。 Elasticsearch 会拒绝索引一个类型不匹配的文档，所以我们需要自定义 mapping 。</p>
<p>通过我们的 <a href="http://documentation.mailgun.com/api-events.html">Events API</a> ，我给日志事件的类型定义了一个映射。不是所有的事件都有所有这些字段，不过相同名字的字段肯定是一致的。</p>
<h1 id="section-5">分析器</h1>
<p>默认情况下，字段的 mapping 中就带有 标准分析器。简单的说，就是字符串会被转成小写，然后分割成一个一个单词。然后这些标记化的单词再写入银锁，并指向具体的字段。</p>
<p>有些情况，你可能想要些别的东西来完成不同的效果。比如说账户 ID，电子邮件地址或者网页链接 URL之类的，默认标记器会以斜线分割，而不考虑把整个域名作为一个单独的标记。当你通过 facet 统计域名字段的时候，你得到的会是域名中一段一段标签的细分结果。</p>
<p>要解决这个问题，可以设置索引属性，给对应字段设置成 <code>not_analyzed</code>。这样在插入索引的时候，这个字段不再经过映射或者标记器。比如对 <code>domain.name</code> 字段应用这个设置后，每个域名都会完整的作为同一个标签统计 facet 了。</p>
<p>如果你还想在这个字段内通过部分内容查找，你可以使用 <a href="http://www.elasticsearch.org/guide/reference/mapping/multi-field-type/">multi-field type</a>。这个类型可以映射相同的值到不同的核心类型或者属性，然后在不同名称下使用。我们对 IP 地址就使用了这个技术。默认的字段(比如叫<code>sending-ip</code>)的类型就是 ip，而另一个非默认字段(比如叫 <code>sending-ip.untouched</code>)则配置成 <code>not_analyzed</code> 而且类型为字符串。这样，默认字段可以做 IP 地址专有的范围查询，而 <code>.untouched</code> 字段则可以做 facet 查询。</p>
<p>除此以外，绝大多数字段我们都没用分析器和标记器。不过我们正在考虑未来可以结合上面的多字段类型技巧，应用 <a href="http://www.elasticsearch.org/guide/reference/index-modules/analysis/pattern-capture-tokenfilter/">pattern capture tokenfilter</a> 到某些字段(比如电子邮件地址)上。</p>
<h1 id="section-6">监控</h1>
<p>要知道你的集群怎么样，你就必须要监控它。 Elasticsearch 有非常棒的 API 来获取 <a href="http://www.elasticsearch.org/guide/reference/api/admin-cluster-state/">cluster state</a> 和 <a href="http://www.elasticsearch.org/guide/reference/api/admin-cluster-nodes-stats/">node statistics</a>。我们可以用 <a href="http://graphite.wikidot.com/">Graphite</a> 来存储这些指标并且做出综合表盘，下面就是其中一个面板：</p>
<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/graphite%20monitoring.png" alt="" /></p>
<p>为了收集这些数据并且传输到 Graphite，我创建了 <a href="http://github.com/mochi/vor">Vör</a>，已经在 <a href="http://www.mochimedia.com/">Mochi Media</a> 下用 MIT/X11 协议开源了。另外一个保证 Redis 列表大小的收集器也在开发中。</p>
<p>除此以外，我们还统计很多东西，比如邮件的收发、点击数，API调用和耗时等等，这些是通过 <a href="https://github.com/etsy/statsd">StatsD</a> 收集的，同样也添加到我们的 Graphite 表盘。</p>
<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/graphite%20events.png" alt="" /></p>
<p>这绝对是好办法来观察发生了什么。Graphite 有一系列函数可以用来在绘图前作处理，也可以直接返回JSON文档。比如，我们可以很容易的创建一个图片展示 API 请求的数量与服务器负载或者索引速度的联系。</p>
<h1 id="section-7">当前状况</h1>
<p>我们的一些数据：</p>
<ul>
  <li>每天大概4kw 到 6kw 个日志事件。</li>
  <li>30天轮转一次日志。</li>
  <li>30个索引。 </li>
  <li>每个索引5个分片。 </li>
  <li>每个分片一个1副本。 </li>
  <li>每个索引占 2 * 50 到 80 GB空间(因为有副本所以乘2)。</li>
</ul>
<p>为此，我们启动了一共 9 台 Rackspace 云主机，具体配置是这样的：</p>
<ul>
  <li>6x 30GB RAM, 8 vCPUs, 1TB disk: Elasticsearch 数据节点。</li>
  <li>2x 8GB RAM, 4 vCPUs: Elasticsearch 代理节点， Logstash， Graphite 和 StatsD。</li>
  <li>2x 4GB RAM, 2 core: Elasticsearch 代理节点， Vulcan 和 API 服务器</li>
</ul>
<p>大多数主机最终会迁移到专属的平台上，同时保留有扩展新云主机的能力。</p>
<p>Elasticsearch 数据节点都配置了 16GB 内存给 JVM heap。其余都是标准配置。此外还设置了 fieldcache 最大大小为 heap 的 40%，以保证集群不会在 facet 和 sort 内容很多的字段时挂掉。我们同时也增加了一点 <a href="http://www.elasticsearch.org/guide/reference/api/admin-cluster-update-settings/">cluster wide settings</a> 来加速数据恢复和重均衡。另外，相对于我们存储的文档数量来说，<code>indices.recovery.max_bytes_per_sec</code> 的默认设置实在太低了。</p>
<h1 id="section-8">总结</h1>
<p>我们非常高兴用 Elasticsearch 来保存我们的事件，也得到了试用新 API 和新控制面板中新日志页面的客户们非常积极的反馈。任意字段的可搜索对日志挖掘绝对是一种显著的改善，而 Elasticsearch 正提供了这种高效无痛的改进。当然，Logstash，Elasticsearch 和 Kibana 这整条工具链也非常适合内部应用日志处理。</p>
<p>如果你想了解更多详情或者对我们的 API 有什么疑问，尽管留言。也可以在 Mailgun 博客上<a href="http://blog.mailgun.com/post/new-events-api-detailed-email-tracking-and-search/">阅读更多关于事件 API 的细节</a>。</p>
<p>开心处理日志，开心发送邮件！</p>
      <a href="/2013/10/09/using-elasticsearch-and-logstash-to-serve-billions-of-searchable-events-for-customers" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/09/14/elasticsearch-for-rexify-website" title="用 ElasticSearch 支持 Rexify 网站的搜索功能" rel="bookmark">用 ElasticSearch 支持 Rexify 网站的搜索功能</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-09-14 00:00:00 +0800">14 Sep 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>最近给 Rexify 官网做<a href="http://rex.perl-china.com">中文化</a>工作，除了文字翻译之外，还要负责把服务正常跑起来。网站本身就是一个 <code>Mojolicious</code> 写的小东西，用 <code>morbo html/website.pl</code> 命令直接运行就可以监听在 3000 端口，然后通过 nginx 代理发布即可。</p>
<p>不过官网上还有一个高级功能需要另外支持，那就是搜索。</p>
<p>Rexify 官网的搜索功能是通过 ElasticSearch 提供的。这里需要注意一点，官方提供的 <code>create_index.pl</code> 中，并不是直接把文件内容本身存入 ES 索引的(之前介绍过的 <code>devopsweekly_index.pl</code> 脚本就是这样做的)，而是编码成 Base64 之后再以附件形式存储。</p>
<p>一开始我没注意到这点，结果搜索结果里一直只有标题和链接，没有高亮内容。后来发现是存的 base64 编码后又很疑惑 Rexify 官网是如何把 base64 再解码回来到网页上显示的。幸亏后来想到去 ElasticSearch 官网搜索一下 base64 关键词，然后发现了专门的<a href="https://github.com/elasticsearch/elasticsearch-mapper-attachments">介绍页面</a>。原来是有一个<a href="https://github.com/elasticsearch/elasticsearch-mapper-attachments">插件</a>实现的附件解析，调用了 Apache Tika 库，也就意味着支持 HTML/XML/Office/ODF/PDF/Epub/RTF/TXT/ZIP/MP3/JPG/FLV/Mbox/JAR 等等各种格式的文件。</p>
<p>所以，安装这个插件，然后重建索引，就可以正常提供搜索功能了：</p>
<pre><code>/usr/share/elasticsearch/bin/plugin -install elasticsearch/elasticsearch-mapper-attachments/1.9.0
rexify-website/create_index.pl localhost 9200 html/templates
</code></pre>
<p>脚本本身超级简单，欢迎大家自行阅读。</p>
      <a href="/2013/09/14/elasticsearch-for-rexify-website" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/09/10/different-format-character-of-pack-between-python-and-perl" title="Perl 和 Python 的 pack 函数格式字符的区别" rel="bookmark">Perl 和 Python 的 pack 函数格式字符的区别</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-09-10 00:00:00 +0800">10 Sep 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>MooseFS 是运用很广泛的一个分布式文件系统，其自带有一个 python 写的 CGI 页面，可以查看集群状态。不过对于运维来说，这就不太方便纳入 nagios 等其他现有的监控体系中。好在既然它的 CGI 是 python 写的，那么自己照样临摹出一个监控脚本也不是太复杂。</p>
<p>其实整个数据是由 master 的 9421 端口进行 TCP 交互获取的，不过比较麻烦的是并不是普通文本流。CGI 中采用了 pack/unpack 函数来处理 TCP 包。根据数据的前 8 字节确定数据总长度和 MooseFS 的版本，然后依照不同版本的 pack 方式来 unpack 剩余内容。</p>
<p>笔者熟悉 Perl，所以就准备将这个处理流程改用 Perl 完成。结果发现原来 pack/unpack 在 Perl 和 Python 中，写法是不一样的。以 MooseFS 的 info 信息读取代码为例，Python 版如下：</p>
<div class="highlight"><pre><code class="python"><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">masterhost</span><span class="p">,</span> <span class="n">masterport</span><span class="p">))</span>
<span class="n">mysend</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&gt;LL&quot;</span><span class="p">,</span> <span class="mi">510</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">myrecv</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">cmd</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;&gt;LL&quot;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
<span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="mi">511</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">76</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">myrecv</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">memusage</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">avail</span><span class="p">,</span> <span class="n">trspace</span><span class="p">,</span> <span class="n">trfiles</span><span class="p">,</span> <span class="n">respace</span><span class="p">,</span> <span class="n">refiles</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">allcopies</span><span class="p">,</span> <span class="n">tdcopies</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;&gt;HBBQQQQLQLLLLLLL&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">ver</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">v3</span><span class="p">)])</span>
</code></pre></div>
<p>而 Perl 版最终写完是这样的：</p>
<div class="highlight"><pre><code class="perl"><span class="k">my</span> <span class="nv">$s</span> <span class="o">=</span> <span class="nn">IO::Socket::</span><span class="n">INET</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
    <span class="n">PeerAddr</span> <span class="o">=&gt;</span> <span class="nv">$host</span><span class="p">,</span>
    <span class="n">PeerPort</span> <span class="o">=&gt;</span> <span class="nv">$port</span><span class="p">,</span>
    <span class="n">Proto</span>    <span class="o">=&gt;</span> <span class="s">&#39;tcp&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
<span class="k">print</span> <span class="nv">$s</span> <span class="nb">pack</span><span class="p">(</span><span class="s">&#39;(LL)&gt;&#39;</span><span class="p">,</span> <span class="mi">510</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nb">sysread</span> <span class="nv">$s</span><span class="p">,</span> <span class="nv">$header</span><span class="p">,</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$cmd</span><span class="p">,</span> <span class="nv">$length</span><span class="p">)</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s">&#39;(LL)&gt;&#39;</span><span class="p">,</span> <span class="nv">$header</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span> <span class="nv">$cmd</span> <span class="o">==</span> <span class="mi">511</span> <span class="ow">and</span> <span class="nv">$length</span> <span class="o">==</span> <span class="mi">76</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nb">sysread</span> <span class="nv">$s</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$length</span><span class="p">;</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$v1</span><span class="p">,</span> <span class="nv">$v2</span><span class="p">,</span> <span class="nv">$v3</span><span class="p">,</span> <span class="nv">$memusage</span><span class="p">,</span> <span class="nv">$total</span><span class="p">,</span> <span class="nv">$avail</span><span class="p">,</span> <span class="nv">$trspace</span><span class="p">,</span> <span class="nv">$trfiles</span><span class="p">,</span> <span class="nv">$respace</span><span class="p">,</span> <span class="nv">$refiles</span><span class="p">,</span> <span class="nv">$nodes</span><span class="p">,</span> <span class="nv">$dirs</span><span class="p">,</span> <span class="nv">$files</span><span class="p">,</span> <span class="nv">$chunks</span><span class="p">,</span> <span class="nv">$allcopies</span><span class="p">,</span> <span class="nv">$tdcopies</span><span class="p">)</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s">&#39;(SCCQQQQLQLLLLLLL)&gt;&#39;</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$ver</span> <span class="o">=</span> <span class="s">&quot;$v1.$v2.$v3&quot;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>不同处主要有两点：</p>
<ol>
  <li>关于 <code>big-endian</code> 定义的 <code>&gt;</code> 符号位置不同，Python 里写在起首一次性全部生效；Perl 里需要每个格式符单独定义，或者采用括号合起来总定义；</li>
  <li>Python 里的 <code>H</code> 格式符表示 <code>unsigned short</code>，在 Perl 里应该是 <code>S</code>；Python 里的 <code>B</code> 格式符表示 <code>unsigned char</code>，在 Perl 里应该是 <code>C</code>。</li>
</ol>
<p>翻看了一下，在 PHP 和 Ruby 中，格式符定义和 Perl 是一样的，不清楚为什么 Python 这么特殊==!</p>
<p>各语言关于 <code>pack</code> 格式符的文档链接如下：</p>
<ol>
  <li><a href="http://www.w3school.com.cn/php/func_misc_pack.asp">http://www.w3school.com.cn/php/func_misc_pack.asp</a></li>
  <li><a href="http://www.kuqin.com/rubycndocument/man/pack_template_string.html">http://www.kuqin.com/rubycndocument/man/pack_template_string.html</a></li>
  <li><a href="http://docs.python.org/2/library/struct.html">http://docs.python.org/2/library/struct.html</a></li>
  <li><a href="http://perldoc.perl.org/functions/pack.html">http://perldoc.perl.org/functions/pack.html</a></li>
</ol>
      <a href="/2013/09/10/different-format-character-of-pack-between-python-and-perl" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/08/27/using-docker-on-rhel6-the-hard-way" title="编译最新 3.10 内核在 RHEL6 上支持 Docker" rel="bookmark">编译最新 3.10 内核在 RHEL6 上支持 Docker</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-08-27 00:00:00 +0800">27 Aug 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cloud-ref" title="cloud" rel="category tag">cloud</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前在 Fedora19 上试图自己通过编译 3.10 内核的方式来完成 aufs 的支持，但是一直有问题，哪怕同样的步骤，github 上其他人都可以，只能怀疑是我个人电脑问题了。不过后来通过 SPEC 方式完成了最终测试，感谢 sciurus 童鞋的<a href="https://github.com/sciurus/docker-rhel-rpm">项目</a>。</p>
<p>部署过程如下：</p>
<div class="highlight"><pre><code class="bash"><span class="c"># 安装这个包以便使用 mock 命令在 chroot 环境下打包</span>
yum install -y fedora-packager
<span class="c"># 下载我的而不是原作者的，因为里面 aufs 和 lxc 的下载链接都已经更新了，原来的404了</span>
git clone https://github.com/chenryn/docker-rhel-rpm.git
spectool -g -C docker docker/docker.spec 
mock -r epel-6-x86_64 --buildsrpm --spec docker/docker.spec --sources docker --resultdir output
mock -r epel-6-x86_64 --rebuild --resultdir output output/docker-0.6.0-1.el6.src.rpm 
spectool -g -C lxc lxc/lxc.spec
mock -r epel-6-x86_64 --buildsrpm --spec lxc/lxc.spec --sources lxc --resultdir output
mock -r epel-6-x86_64 --rebuild --resultdir output output/lxc-0.8.0-3.el6.src.rpm
spectool -g -C kernel-ml-aufs kernel-ml-aufs/kernel-ml-aufs-3.10.spec
mock -r epel-6-x86_64 --buildsrpm --spec kernel-ml-aufs/kernel-ml-aufs-3.10.spec --sources kernel-ml-aufs --resultdir output
mock -r epel-6-x86_64 --rebuild --resultdir output output/kernel-ml-aufs-3.10.5-1.el6.src.rpm
<span class="nb">cd </span>output
yum localinstall --nogpgcheck kernel-ml-aufs-3.10.5-1.el6.x86_64.rpm lxc-0.8.0-3.el6.x86_64.rpm lxc-libs-0.8.0-3.el6.x86_64.rpm docker-0.6.0-1.el6.x86_64.rpm
<span class="nb">echo</span> <span class="s1">&#39;none                    /sys/fs/cgroup          cgroup  defaults        0 0&#39;</span> &gt; /etc/fstab
reboot
</code></pre></div>
<p>kernel 文件来自 RHEL，不过我试了下，在我的Fedora19上也正常可用。3.10.5 和 3.2 相比，第一 3.10 将会是未来一段时间内 kernel 的主线支持；第二 docker 官方说在 3.8 之前有点小 bug 可能会被触发。</p>
      <a href="/2013/08/27/using-docker-on-rhel6-the-hard-way" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/08/26/running-perldancer-on-docker" title="在 Docker 上运行 PerlDancer 示例" rel="bookmark">在 Docker 上运行 PerlDancer 示例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-08-26 00:00:00 +0800">26 Aug 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cloud-ref" title="cloud" rel="category tag">cloud</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>搭建好了 docker 环境后，就可以来试试用 docker 跑一个应用实例来看看了。和 Vagrant 比较类似，docker 也是用一个配置文件来规划其基础镜像内的部署，不过值得注意的是，在 <code>Dockerfile</code> 里的每一个指令成功执行后，docker 默认都会 commit 一次，这样就节省了一些空间和时间。</p>
<p>构建失败的镜像，在 <code>docker images</code> 命令输出中显示为 <code>&lt;none&gt;</code> 可以根据具体的 commit id，调用 <code>docker rmi &lt;id&gt;</code> 命令清除。</p>
<p>一个比较简单的 <code>Dockerfile</code> 示例是这样的：</p>
<div class="highlight"><pre><code class="ruby"><span class="no">FROM</span> <span class="ss">centos</span><span class="p">:</span><span class="mi">6</span><span class="o">.</span><span class="mi">4</span>
<span class="no">RUN</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">make</span> <span class="n">gcc</span> <span class="n">wget</span> <span class="n">perl</span> <span class="n">perl</span><span class="o">-</span><span class="n">devel</span> <span class="n">perl</span><span class="o">-</span><span class="no">Time</span><span class="o">-</span><span class="no">HiRes</span> <span class="n">perl</span><span class="o">-</span><span class="no">CGI</span> <span class="n">perl</span><span class="o">-</span><span class="n">libwww</span><span class="o">-</span><span class="n">perl</span> <span class="n">perl</span><span class="o">-</span><span class="no">Module</span><span class="o">-</span><span class="no">Build</span> <span class="n">perl</span><span class="o">-</span><span class="no">Test</span><span class="o">-</span><span class="no">Simple</span> <span class="n">perl</span><span class="o">-</span><span class="no">Test</span><span class="o">-</span><span class="no">Deep</span> <span class="n">perl</span><span class="o">-</span><span class="no">YAML</span>
<span class="no">RUN</span> <span class="n">wget</span> <span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="n">cpanmin</span><span class="o">.</span><span class="n">us</span>
<span class="no">RUN</span> <span class="n">perl</span> <span class="n">cpanm</span> <span class="no">Dancer</span>
<span class="no">ADD</span> <span class="sr">/var/</span><span class="n">www</span><span class="o">/</span><span class="n">dancerapp</span> <span class="n">app</span>
<span class="no">EXPOSE</span> <span class="mi">3000</span>
<span class="no">CMD</span> <span class="n">perl</span> <span class="n">app</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">pl</span>
</code></pre></div>
<p>然后运行如下命令构建镜像：</p>
<pre><code>docker build -t chenryn/perldancer
</code></pre>
<p>如果构建都成功的话，那就是正式运行了：</p>
<pre><code>docker run -p 8080:3000 -d chenryn/perldancer
</code></pre>
<p>运行起来以后，可以通过 <code>docker ps</code> 命令看到本机上运行着的容器状态信息。同样，也可以通过映射的 8080 端口访问到页面了。</p>
<p>正在测试通过 <code>plenv</code> 来使用高版本的 perl，目前比较郁闷的是因为 <code>plenv</code> 是通过 <code>~/.profile</code> 来在每次登陆的时候自动切换到指定版本的，而 <code>docker</code> 里的 <code>RUN</code> 调用 <code>/bin/sh -c</code> 不会调用到这些文件，所以一直还是使用系统自带版本。而在 <code>RUN</code> 指令里每行都写一个 <code>source $HOME/.profile</code> 也很难看的。</p>
      <a href="/2013/08/26/running-perldancer-on-docker" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/08/24/using-docker-on-centos6" title="快速在 CentOS6 上运行 docker" rel="bookmark">快速在 CentOS6 上运行 docker</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-08-24 00:00:00 +0800">24 Aug 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cloud-ref" title="cloud" rel="category tag">cloud</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>docker 是由著名 PAAS 公司 dotcloud 开源的 linux 容器项目，在此之前，只有 cloudfoundry 下属的 warden 半死不活的慢慢前进着。</p>
<p>不管是 docker 还是 warden，其原理大多是通过 LXC( 即 CGroup 和 namespace 的结合)以及 AUFS 的结合，完成比较彻底的容器虚拟化。这里有个问题：AUFS 不是 linux 官版内核支持的文件系统。所以到现在，各种 PAAS 都是运行在 Ubuntu 系统上，因为只有这个系列的发行版默认打了 AUFS 的补丁。这也严重影响了 PAAS 开源社区的扩容：</p>
<ol>
  <li>RedHat 发行版系列才是企业用户最多的 linux 发行版；</li>
  <li>Debian 社区已经宣布在未来会放弃默认打 AUFS 补丁的做法。</li>
</ol>
<p>docker 目前已经在积极准备将代码 port 到 BtrFS 上以备未来，不过在此之前，我们还是可以通过自己打补丁的方式，在 RedHat 系列上尝试 docker 的。目前社区已经有很多尝试：</p>
<ol>
  <li><a href="http://neh.al/?p=1">Installing Docker on Fedora 18</a></li>
  <li><a href="http://blog.rage.net/2013/08/04/installing-docker-on-centos-6/">Installing Docker on Centos 6</a></li>
  <li><a href="https://github.com/sciurus/docker-rhel-rpm">files needed to build RPMs for the dependencies of docker</a></li>
  <li><a href="https://github.com/failshell/chef-docker">chef-docker</a></li>
  <li><a href="http://nareshv.blogspot.in/2013/08/installing-dockerio-on-centos-64-64-bit.html">Installing Dockerio on Centos6.4-64bit</a></li>
</ol>
<p>其中，包括有三种内核，源代码编译支持3.8的，spec编译支持3.10的，以及已经打包完成的3.2的。</p>
<p>我已经尝试过在 Fedora19 上通过源代码编译，似乎内核从3.8到3.10有些变化，编译失败了。(但是尝试过编译3.8的确实没问题)</p>
<p>下面通过最简单的已经打包完成的3.2内核来快速部署 docker 到 CentOS6 上，以便尝鲜：</p>
<div class="highlight"><pre><code class="bash">rpm -e kernel-firmware
rpm -i http://get.docker.io/kernels/kernel-3.2.40_grsec_dotcloud-4.x86_64.rpm
/sbin/dracut --add-drivers dm-mod --add-drivers linear <span class="s2">&quot;&quot;</span> 3.2.40-grsec-dotcloud
grub-install /dev/sda1
<span class="nb">echo</span> <span class="s2">&quot;blacklist evbug&quot;</span> &gt;&gt; /etc/modprobe.d/blacklist.conf
<span class="nb">echo</span> <span class="s2">&quot;kernel.grsecurity.chroot_caps = 0&quot;</span> &gt;&gt; /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">&quot;sysctl kernel.grsecurity.chroot_caps=1&quot;</span> &gt;&gt; /etc/rc.local
<span class="nb">echo</span> <span class="s2">&quot;net.ipv4.ip_forward = 1&quot;</span> &gt;&gt; /etc/sysctl.conf
mkdir /cgroup
<span class="nb">echo</span> <span class="s2">&quot;none /cgroup cgroup defaults 0 0&quot;</span> &gt;&gt; /etc/fstab
cat &gt;&gt; /boot/grub/grub.conf<span class="s">&lt;&lt;EOF</span>
<span class="s">title CentOS (3.2.40_grsec_dotcloud-4.x86_64)</span>
<span class="s">	root (hd0,0)</span>
<span class="s">	kernel /boot/vmlinuz-3.2.40-grsec-dotcloud ro root=LABEL=/ rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM selinux=0</span>
<span class="s">	initrd /boot/initramfs-3.2.40-grsec-dotcloud.img</span>
<span class="s">EOF</span>
reboot
</code></pre></div>
<p>内核的更新就是这些，记住这个包不支持 selinux，所以启动项里要加上 <code>selinux=0</code>。</p>
<p>然后重启登录重启并选择了新内核的主机，继续安装一些依赖工具：</p>
<div class="highlight"><pre><code class="bash">wget <span class="s2">&quot;ftp://ftp.pbone.net/mirror/ftp5.gwdg.de/pub/opensuse/repositories/home%3A/awk2007%3A/fixes/Fedora_17/src/aufs-util-9999-14.1.src.rpm&quot;</span>
sudo yum install glibc-static
rpmbuild --rebuild aufs-util-9999-14.1.src.rpm
rpm -U /root/rpmbuild/RPMS/x86_64/aufs-util-9999-14.1.x86_64.rpm
wget ftp://ftp.univie.ac.at/systems/linux/dag/redhat/el6/en/x86_64/dag/RPMS/lxc-0.8.0-1.el6.rf.x86_64.rpm
wget http://apt.sw.be/redhat/el6/en/x86_64/dag/RPMS/lxc-libs-0.8.0-1.el6.rf.x86_64.rpm
rpm -U lxc-0.8.0-1.el6.rf.x86_64.rpm lxc-libs-0.8.0-1.el6.rf.x86_64.rpm
</code></pre></div>
<p>然后下载 docker 的二进制文件运行，用源代码的话比较麻烦，docker 是用 golang 写的……</p>
<div class="highlight"><pre><code class="bash">wget http://get.docker.io/builds/Linux/x86_64/docker-latest.tgz
tar xzf docker-latest.tgz
<span class="nb">cd </span>docker-latest
</code></pre></div>
<p>启动 docker 进程，输出如下：</p>
<pre><code>[root@localhost docker-latest]# ./docker -d &amp;
2013/08/24 18:24:18 WARNING: You are running linux kernel version 3.2.40-grsec-dotcloud, which might be unstable running docker. Please upgrade your kernel to 3.8.0.
2013/08/24 18:24:18 Listening for HTTP on /var/run/docker.sock (unix)
</code></pre>
<p>然后就可以通过 docker 命令运行了，示例及输出如下所示：</p>
<pre><code>[root@localhost docker-latest]# ./docker run -i -t busybox /bin/sh
2013/08/24 18:24:30 POST /v1.4/containers/create
2013/08/24 18:24:30 POST /v1.4/images/create?fromImage=busybox&amp;tag=
Pulling repository busybox
Pulling image e9aa60c60128cad1 (latest) from busybox
Pulling e9aa60c60128cad1 metadata
Pulling e9aa60c60128cad1 fs layer
Downloading 2.284 MB/2.284 MB (100%)
2013/08/24 18:28:37 POST /v1.4/containers/create
2013/08/24 18:28:37 POST /v1.4/containers/cdf0feaf24a9/start
2013/08/24 18:28:37 POST /v1.4/containers/cdf0feaf24a9/resize?h=27&amp;w=121
2013/08/24 18:28:37 POST /v1.4/containers/cdf0feaf24a9/attach?logs=1&amp;stderr=1&amp;stdin=1&amp;stdout=1&amp;stream=1
BusyBox v1.19.3 (Ubuntu 1:1.19.3-7ubuntu1.1) built-in shell (ash)
Enter 'help' for a list of built-in commands.
/ # 
/ # ls
bin    dev    etc    lib    lib64  proc   sbin   sys    tmp    usr
/ # cd /root
/bin/sh: cd: can't cd to /root
</code></pre>
<p>可以看到，现在登录进来是不能切换目录到 root 家目录的。</p>
<p>docker 已经运行起来了，更多实例，就可以看着 docker.io 上的<a href="http://docs.docker.io/en/latest/examples/">文档</a>慢慢进行了</p>
      <a href="/2013/08/24/using-docker-on-centos6" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/08/14/my-perl-workshop-experience" title="BeiJing Perl Workshop 2013 参会总结" rel="bookmark">BeiJing Perl Workshop 2013 参会总结</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-08-14 00:00:00 +0800">14 Aug 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上周六在万通会议中心参加了 BeiJing Perl Workshop 2013 ，并做了 40 分钟长的关于 ElasticSearch 的演讲。上届 2011 作为一个看客，两年后作为一个积极参与和演讲者，真的有必要记录一下。</p>
<p>一天中最让大家惊奇和感兴趣的无疑是胡松涛带来的 3D 打印机以及每人都有的 Perl 小挂件 —— 没错，就是用 3D 打印出来的小东西。</p>
<p><img src="/images/uploads/3d_perlchina.jpg" alt="large" /></p>
<p><img src="/images/uploads/3d_perl.jpg" alt="small" /></p>
<p>最遗憾的是来自alibaba的两位演讲者因为公司问题临时退出。</p>
<p>DeNA 的演讲者是一位由程序员转职的产品经理，明显演讲的技巧水平是要高过我们这些纯码农的，节奏控制完全值得学习。
不知道对于其他 perler 来说，测试是否会主动去做，但是我是蛮习惯使用 <code>Dancer::Test</code> 的，包括其他项目用 <code>Test::More</code>，我觉得都是蛮好的习惯。所以对董余康在演讲中比较重点的提到测试的便捷我是比较有爱的，但是从 QQ 群上的反应来看，大家更期待的功能和开发便捷上的介绍？
总的来说，演讲题目偏于 PerlDancer 的 hello world，我个人本身对 Dancer 有一定了解，所以内容上没太注意。如果以后发现大家对 <code>Dancer</code> 有进一步的兴趣，我考虑可以在 YY 频道上介绍一下用 <code>Dancer::Plugin</code> 实现一个自己喜欢的keyword？</p>
<p>扶凯的 <code>Mojolicious</code> 演讲应该就比较符合大众的期待。我是不太喜欢单独定义 route 的方式，不管是 RoR 还是 mojo，除此以外，mojo 另一个不错的就是 <code>TagHelper</code> 了。我觉得将 <code>Dancer</code> 和 <code>Mojolicious::Lite</code> 相比是不厚道的，<code>Dancer</code> 也可以多文件使用，<code>dancer -a web_app</code> 命令就生成了完整的项目层次。
关于 mojo 的演讲，牛氓同学说没有关于 <code>Mojo</code> 的 OO 实现的内容，我也觉得比较遗憾，不过这个内容是否适合在面对上百听众的时候分享，也是一个问题？</p>
<p>李瑞彬演讲中提到的 <code>cpanspec</code> 和 <code>yum search perl(LWP::Simple)</code> 两个小技巧很不错～</p>
<p>刘刊和大家不同，采用了直接 code 解读和 shell 演示的办法介绍了他的 <code>pantheon</code> 里面的一些思想和简单用法。其实我去年就见过这个的使用，不过似乎到现在依然没有完整的文档？作为一个在雅虎超大环境下经过实践的自动化运维平台项目，如果配上完善的文档，应该可以成为一个可以对 Perl 普及有很不错推动力的好项目。<strong>真心希望刘刊和 <code>pantheon</code> 的其他使用者可以花点时间，整理一份快速入手的 cookbook，迁移代码到github，独立域名发布，完成从内部项目到社区项目的转身～</strong>
目前只能通过 CPAN 安装，安装很方便，但是没人演示教导，真的不知道怎么用……</p>
<p>也来说说我自己的演讲。这个话题其实比较尴尬，前三分之一介绍 <code>ElasticSearch</code>，中间还有一部分是 <code>logstash</code>，都是 Perl 无关的内容。演讲完后其实发现很多人依然不清楚到底是可以用来干吗……或许我直接只讲 <code>Message::Passing</code> ，每个插件如何用，效果应该更好一些吧？唯一高兴的，是演讲刚好控制到了40分钟内讲完。</p>
<p>许大师提到一个大计划，要把 <code>AnyEvent</code> 和 <code>nginx</code> 无缝结合。这个好是好，能不能出来是另一回事……</p>
<p>闪电演讲依然火爆，不过我有事情先走了，不知道后来还有几位超时被敲锣的～～
对了，第一个闪电提到的 <code>$obj-&gt;can($func_name)-&gt;()</code> 这个用法很帅，记录一下。</p>
<p>原本在 CU 上答应网友在闪电上分享一下 <code>autobox</code> 的用法，也没法做了，有点违约的小羞愧。以后也争取在 YY 频道上说说。</p>
<p>作为演讲者，还另外免费领了一本《HBase管理指南》，实在其他几本 Perl 的都已经有了——而且大多数演讲者都是～～</p>
<p>BJPW 之后第二天就开始 YAPC::EU，国外大神基本都在欧洲讨论 Future Perl，北京的朋友们自娱自乐也还是比较成功了～</p>
<p>最后吐槽一个，全天没有 Perl6 的演讲，结果文化衫上是 Perl6 的蝴蝶。。。其实如果能让广州那个 <code>MoarVM</code> 的开发者叫来讲讲也挺好的。</p>
<p><img src="/images/uploads/T-shirt.jpg" alt="大会T恤衫" /></p>
<p>附另外两位同仁的大会感受博文：</p>
<ol>
  <li><a href="http://www.weibo.com/alickzhao">@赵涛Alick</a> 的 《<a href="http://wp-awesome.rhcloud.com/2013/08/18/perl-china-2013-notes/">Perl China 2013 活动后记</a>》</li>
  <li>Aka.Why 的 《<a href="http://blog.aka-cool.net/blog/2013/08/12/learn-from-beijing-perl-workshop-2013/">参加Beijing Perl Workshop 2013后感</a>》</li>
</ol>
      <a href="/2013/08/14/my-perl-workshop-experience" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/07/22/intro-selenium-remote-driver" title="Selenium 测试框架介绍" rel="bookmark">Selenium 测试框架介绍</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-07-22 00:00:00 +0800">22 Jul 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Selenium 是一个自动化网站测试框架，包括 IDE、WebDriver 和 Grid 三个套件。其官网地址见：<a href="http://docs.seleniumhq.org/projects/">http://docs.seleniumhq.org/projects/</a>。其中 Grid 用以跨主机的集群测试，今天就不讲了。而 WebDriver 则是用以控制 Selenium Server(Server 上可以接受并启动的浏览器包括Firefox、IE、Chrome、Safari、Android、IPhone、PhantomJS 等等)进行具体测试动作的客户端，其早期版本叫做 Remote Control。</p>
<p>最有特色和帮助的，是 IDE 部分，这是一个 Firefox 的 xpi 插件。通过下载安装，就可以启用，然后就是最简单不过的浏览器操作录制，结束动作后就可以自动导出各种支持的语言版本的 WebDriver 程序。</p>
<p>注意在安装好 xpi 后，在 IDE 上并不能同步看到生成的程序内容，并不是说没有录制，而是默认不显示 <code>options/format</code> 的内容。在 <code>options/options</code> 里把 <code>active developer tools</code> 选项激活就可以了。</p>
<p>Selenium 是一个 java 项目，官方支持的客户端程序包括 Java、C#、Ruby 和 Python2。社区支持的包括 Perl、PHP 和 Haskell 等等。</p>
<p>注意 Selenium 的 WebDriver 和 Remote Control 两个版本之间 API 已经完全不一样，所以在 IDE 录制的时候，format 已经要选 WebDriver API 的才能用——除非你还找得到老版本的 Selenium Server，反正我是没找到。</p>
<p>不巧的是目前官网上的插件列表中，只有官方支持的四个更新了 WebDriver 的 IDE 支持。所以直接从官网上安装的 Perl plugin 其实是没用的。不过不要紧，我很容易就找到了支持 WebDriver 的 Perl 模块，并且还使用 Perl 模块完成了对 Selenium Server 的管理。</p>
<p>这里要用到两个 CPAN 模块：<a href="https://metacpan.org/module/Selenium::Server">Selenium::Server</a> 和 <a href="https://metacpan.org/module/Selenium::Remote::Driver">Selenium::Remote::Driver</a>。</p>
<p>由于 Firefox addons 网站上的 <a href="https://addons.mozilla.org/zh-CN/firefox/addon/selenium-ide-perl-formatter/?src=search">Selenium IDE: Perl Formatter</a> 还是老版本的，即 <a href="https://metacpan.org/module/Test::WWW::Selenium">Test::WWW::Selenium</a> 配套的，所以我们需要自行安装新版本插件。</p>
<p>新版本插件也就是一段 javascript 代码，在 <a href="https://metacpan.org/module/Selenium::Remote::Driver">Selenium::Remote::Driver</a> 代码库目录中已经存在，即 <a href="https://github.com/aivaturi/Selenium-Remote-Driver/blob/master/ide-plugin.js">https://github.com/aivaturi/Selenium-Remote-Driver/blob/master/ide-plugin.js</a>。</p>
<p>按照 js 文件开头注释中的介绍，在 Selenium IDE 的 <code>options/options</code> 菜单的 <code>Formats</code> 选项卡上点击 <code>Add</code> 按钮，给新的 format 取名为 <code>Perl-WebDriver</code>，然后把整个 js 文件内容贴进文本框内保存即可。</p>
<p>现在，录制操作只需选择使用 <code>Perl-WebDriver</code> 格式，就可以生成 Perl 测试脚本使用了。</p>
<p>下一个问题，就是 Selenium Server 的运行。IDE 生成的脚本只负责连接 server 并发送命令。server 的 状况在 IDE 中是在 <code>options/formats</code> 中定义的变量，即 Selenium RC host 、Selenium RC port 和 environment。默认是 <code>localhost</code>、<code>4444</code> 和 <code>firefox</code>。在生成脚本的时候会自动替换。</p>
<p>也就是说，我们需要自己部署程序，再运行一个脚本，启用 java 程序，来运行 Selenium Server。</p>
<p>这里就可以用上 <a href="https://metacpan.org/module/Selenium::Server">Selenium::Server</a> 了。程序的下载、启用、参数配置和停止，都有该模块完成。</p>
<p>最后一步，我们可以把 <a href="https://metacpan.org/module/Selenium::Server">Selenium::Server</a> 的相关代码，也贴进 IDE 的 <code>options/formats</code> 的 <code>Header</code> 和 <code>Footer</code> 模板里。这样不用每次自己粘贴了——自己粘贴代码还不如直接自己启用一个固定监听 4444 端口的 java 程序得了。</p>
<p>IDE 截图如下：</p>
<p><img src="/images/uploads/selenium-ide.png" alt="selenium-ide" /></p>
<p>生成脚本如下所示：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Selenium::</span><span class="n">Server</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Selenium::Remote::</span><span class="n">Driver</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Test::</span><span class="n">More</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$server</span> <span class="o">=</span> <span class="nn">Selenium::</span><span class="n">Server</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
    <span class="nv">$server</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$driver</span> <span class="o">=</span> <span class="nn">Selenium::Remote::</span><span class="n">Driver</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="n">remote_server_addr</span> <span class="o">=&gt;</span> <span class="nv">$server</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
        <span class="n">port</span>               <span class="o">=&gt;</span> <span class="nv">$server</span><span class="o">-&gt;</span><span class="n">port</span>
    <span class="p">);</span>
    <span class="nv">$driver</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://10.2.21.100:8081/?results=88ceefac3c0c588d14f579d0c47f74fc&quot;</span><span class="p">);</span>
    <span class="nv">$driver</span><span class="o">-&gt;</span><span class="n">find_element</span><span class="p">(</span><span class="s">&quot;DNS可用性测试&quot;</span><span class="p">,</span> <span class="s">&quot;link&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">click</span><span class="p">;</span>
    <span class="n">like</span><span class="p">(</span><span class="sx">qr/^[\s\S]*各地测试可用性[\s\S]*$/</span><span class="p">,</span><span class="nv">$driver</span><span class="o">-&gt;</span><span class="n">find_element</span><span class="p">(</span><span class="s">&quot;BODY&quot;</span><span class="p">,</span> <span class="s">&quot;css&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">get_text</span><span class="p">);</span>
    <span class="nv">$driver</span><span class="o">-&gt;</span><span class="n">quit</span><span class="p">();</span>
    <span class="n">done_testing</span><span class="p">();</span>
    <span class="nv">$server</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span>
</code></pre></div>
<p>脚本中这个 <code>click</code> 操作显然是直接根据动作录制的，那么 <code>find_element()-&gt;get_text</code> 是怎么来的呢？其实 Selenium IDE 已经修改了浏览器内鼠标右键菜单的选项。在选中的任意网页元素上单击鼠标右键，菜单中就有 <code>Show All Available Commands</code> 子菜单，只需要选择就可以了。方便吧！</p>
<p>生成的脚本直接运行，就可以完成测试了。</p>
<p>和 <code>Selenium</code> 类似的，还有 <a href="https://metacpan.org/module/WWW::WebKit">WWW::WebKit</a> 模块，它是调用 <a href="https://metacpan.org/module/Gtk3::WebKit">Gtk3::WebKit</a> 作为后端浏览器支持，不过经过我个人电脑测试，要安装好 <a href="https://metacpan.org/module/Gtk3::WebKit">Gtk3::WebKit</a> 本身就是一件很复杂的事情。加上有时候我们也需要比较不同浏览器的效果是不是有所不同。所以，还是用 Selenium 吧。</p>
<p>注：在最近一期 PerlWeekly 对 Perl 社区创业公司 Lokku/Nestoria 的<a href="http://blogs.perl.org/user/ovid/2013/07/perl-startups-lokkunestoria.html">访谈</a>中，Lokku 公司 CTO，Alex Balhatchet 也提到准备使用 Selenium 改造公司的自动化测试。</p>
<p>补：刚发现 Selenium 的 PHP 客户端，是 Facebook 写的。</p>
<p><strong>2013 年 07 月 25 日补</strong></p>
<p><code>Selenium</code> 的另一个功能是自己插入 <code>javascript</code> 到页面里执行。比如我们可以利用 HTML5 的 <code>WebTiming</code> 特性测试页面的下载时间：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$webtiming</span> <span class="o">=</span> <span class="sx">q{</span>
<span class="sx">        var performance = window.performance</span>
<span class="sx">                       || window.webkitPerformance</span>
<span class="sx">                       || window.mozPerformance</span>
<span class="sx">                       || window.msPerformance</span>
<span class="sx">                       || {};</span>
<span class="sx">        var timings     = performance.timing || {};</span>
<span class="sx">        return timings;</span>
<span class="sx">    }</span><span class="p">;</span>
    <span class="nv">$driver</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://stackoverflow.com/&quot;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$driver</span><span class="o">-&gt;</span><span class="n">execute_script</span><span class="p">(</span><span class="nv">$webtiming</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%$res</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nb">printf</span> <span class="s">&quot;%s %s\n&quot;</span><span class="p">,</span> <span class="nv">$_</span><span class="p">,</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$_</span><span class="p">}</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
    <span class="p">};</span>
</code></pre></div>
<p><code>WebTiming</code> 详细列出了每个阶段的时间。如果 js 写的好，可以写具体某个点触发，就更好了。</p>
<p><strong>2013 年 07 月 26 日补</strong></p>
<p><code>Selenium::Remote::Driver</code> 只发送操作命令到远端服务器，不具有操作本地浏览器功能。所以无法像 Ruby 的 <code>Selenium::WebDriver</code> 那样控制本地浏览器，甚至包括插入 <code>.xpi</code> 插件到自定义的 profile 里完成更复杂的功能：比如用 <code>Firebug</code>。有一个 Ruby 模块叫 <a href="https://github.com/jfirebaugh/capybara-firebug">capybara-firebug</a>，就是利用这个办法扩展了 <code>capybara</code> 测试框架。</p>
      <a href="/2013/07/22/intro-selenium-remote-driver" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/07/11/howto-filter-count-in-logstash" title="【Logstash 系列】根据事件统计值报警" rel="bookmark">【Logstash 系列】根据事件统计值报警</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-07-11 00:00:00 +0800">11 Jul 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前已经用很多博文说过了 logstash 如何配合 elasticsearch 以及 kibana 来做日子分析和实时搜索。其实 logstash 上百个插件还有很多其他的玩法，绝不是局限在日志搜索统计方面的。今天就展示另一个做法。根据日志中的异常值出现频率报警。</p>
<p>在 logstash 的官网上，针对这个问题采用的办法是讲异常值计数 output 到 <code>statsd</code> 中，然后可以用通过观测 <code>graphite</code> 图形变化来判断异常。(或者配合 nagios 的 <code>check_graphite</code> 插件？) 官网说明见：<a href="http://logstash.net/docs/1.1.13/tutorials/metrics-from-logs">http://logstash.net/docs/1.1.13/tutorials/metrics-from-logs</a></p>
<p>如果不想一直盯着页面看的话，可以利用另外几个插件来实现类似的做法，比如我要监控访问日志，如果其中 504 状态码每分钟超过 100 次，就报警出来。logstash 配置如下：</p>
<div class="highlight"><pre><code class="ruby">    <span class="n">input</span> <span class="p">{</span>
        <span class="n">stdin</span> <span class="p">{</span>
            <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;apache&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">filter</span> <span class="p">{</span>
        <span class="n">grok</span> <span class="p">{</span>
            <span class="n">pattern</span> <span class="o">=&gt;</span> <span class="s2">&quot;\[%{HTTPDATE:ts}\] %{NUMBER:status} %{IPORHOST:remotehost} %{URIHOST} %{WORD} %{URIPATHPARAM:url} HTTP/%{NUMBER} %{URIHOST:oh} %{NUMBER:responsetime:float} %{NUMBER:upstreamtime:float} (?:%{NUMBER:bytes:float}|-)&quot;</span>
            <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;apache&quot;</span>
        <span class="p">}</span>
        <span class="n">metrics</span> <span class="p">{</span>
            <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;apache&quot;</span>
            <span class="n">meter</span> <span class="o">=&gt;</span> <span class="s2">&quot;error.%{status}&quot;</span>
            <span class="n">add_tag</span> <span class="o">=&gt;</span> <span class="s2">&quot;metric&quot;</span>
            <span class="n">ignore_older_than</span> <span class="o">=&gt;</span> <span class="mi">10</span>
        <span class="p">}</span>
        <span class="n">ruby</span> <span class="p">{</span>
            <span class="n">tags</span> <span class="o">=&gt;</span> <span class="s2">&quot;metric&quot;</span>
            <span class="n">code</span> <span class="o">=&gt;</span> <span class="s2">&quot;event.cancel if event[&#39;@fields&#39;][&#39;error.504.rate_1m&#39;] &lt; 100&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">output</span> <span class="p">{</span>
        <span class="nb">exec</span> <span class="p">{</span>
            <span class="n">tags</span> <span class="o">=&gt;</span> <span class="s2">&quot;metric&quot;</span>
            <span class="n">command</span> <span class="o">=&gt;</span> <span class="s2">&quot;sendsms.pl -m &#39;%{error\.504\.rate_1m}&#39;&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
<p>其中关键在两个 filter。 metrics 插件可以每5秒(前天刚更新了源码，这个值可以自己指定了)更新一次统计值，支持 <code>meter</code> 和 <code>timer</code> 两种，<code>timer</code> 除了 <code>count</code> 和 <code>rate_1|5|15m</code> 外，还可以统计 <code>min|max|stddev|mean</code> 和 <code>p1|5|10|90|95|99</code> 等详细数据。</p>
<p>ruby 插件则是直接 <code>eval</code> 写在 <code>code</code> 配置里的代码。</p>
<p>需要注意的是： <code>output</code> 里使用的时候，需要用 <code>\</code> 转义 <code>.</code>。否则配置解析后会认为变量不存在。这是目前官网文档上写的有问题的地方。我已經跟作者提过，或许过些天会修改。</p>
<p>值得一提的是：metrics 插件的输出是一个全新的 event，而不会去改变原先 grok 生成的 event。</p>
      <a href="/2013/07/11/howto-filter-count-in-logstash" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/06/28/howto-get-peer-ipaddr-in-http-get" title="获取 Perl 程序中 GET 请求发向的具体 IP" rel="bookmark">获取 Perl 程序中 GET 请求发向的具体 IP</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-06-28 00:00:00 +0800">28 Jun 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在运维工作中我们经常需要检测用户访问是否正常，一般来说，直接通过 DNS 客户端获取 A 记录就可以满足需要。不过如果我们可以获得具体连接的 IP 地址，那么就可以缩小问题的判断范围，因为 DNS 的 A 记录通常是有多个的。</p>
<p>AE::HTTP 模块可以返回 sock 给用户进行具体操作，我们可以通过 sock 接口很简单的获得对端的 IP 地址：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">Web::Checker::Util::</span><span class="n">HTTP</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Moo</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">MooX::Types::MooseLike::</span><span class="n">Base</span> <span class="sx">qw/Str Num/</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">HTTP</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">Socket</span><span class="p">;</span>
<span class="k">use</span> <span class="n">AnyEvent</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Time::</span><span class="n">HiRes</span> <span class="sx">qw/time/</span><span class="p">;</span>
<span class="n">has</span> <span class="n">peer</span>    <span class="o">=&gt;</span> <span class="p">(</span> <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;rw&#39;</span><span class="p">,</span> <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span> <span class="p">);</span>
<span class="n">has</span> <span class="n">reptime</span> <span class="o">=&gt;</span> <span class="p">(</span> <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;rw&#39;</span><span class="p">,</span> <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Num</span> <span class="p">);</span>
<span class="n">has</span> <span class="n">clength</span> <span class="o">=&gt;</span> <span class="p">(</span> <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;rw&#39;</span><span class="p">,</span> <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Num</span> <span class="p">);</span>
<span class="n">has</span> <span class="n">body</span>    <span class="o">=&gt;</span> <span class="p">(</span> <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span> <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span> <span class="p">);</span>
<span class="n">has</span> <span class="n">proxy</span>   <span class="o">=&gt;</span> <span class="p">(</span> <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span> <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span><span class="p">,</span> <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="nb">undef</span> <span class="p">}</span> <span class="p">);</span>
<span class="n">has</span> <span class="n">cv</span> <span class="o">=&gt;</span> <span class="p">(</span> <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">condvar</span> <span class="p">}</span> <span class="p">);</span>
<span class="k">sub </span><span class="nf">get</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$self</span><span class="p">,</span> <span class="nv">$url</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">cv</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$begin</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
    <span class="n">http_get</span> <span class="nv">$url</span><span class="p">,</span>
      <span class="n">proxy</span>            <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">,</span>
      <span class="c1"># 就是这里发挥了作用，默认应该是直接返回 body 字符串的</span>
      <span class="n">want_body_handle</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
      <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$hdl</span><span class="p">,</span> <span class="nv">$headers</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$port</span><span class="p">,</span> <span class="nv">$peer</span> <span class="p">)</span> <span class="o">=</span>
          <span class="nn">AnyEvent::Socket::</span><span class="n">unpack_sockaddr</span> <span class="nb">getpeername</span> <span class="nv">$hdl</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">fh</span><span class="p">};</span>
        <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">(</span> <span class="nn">AnyEvent::Socket::</span><span class="n">format_address</span> <span class="nv">$peer</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$headers</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">Status</span><span class="p">}</span> <span class="o">=~</span><span class="sr"> /^2/</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$end</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
            <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">reptime</span><span class="p">(</span> <span class="nv">$end</span> <span class="o">-</span> <span class="nv">$begin</span> <span class="p">);</span>
            <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">clength</span><span class="p">(</span> <span class="nv">$headers</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;content-length&#39;</span><span class="p">}</span> <span class="p">);</span>
            <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">cv</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">cv</span><span class="o">-&gt;</span><span class="nb">recv</span><span class="p">;</span>
<span class="p">}</span>
<span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>其实 AE::HTTP 还可以在 <code>tcp_connect</code> 的时候获取 sock，这时候就需要自己用 <code>AnyEvent::Handle</code> 写一遍 <code>AnyEvent::HTTP::tcp_connect</code> 已经写过的东西了(当然如果你本来就打算干点别的事情，那就是另外一回事情了)~~</p>
      <a href="/2013/06/28/howto-get-peer-ipaddr-in-http-get" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/06/24/who-to-calculate-days-between-two-date" title="计算两个时间点之间隔了几天" rel="bookmark">计算两个时间点之间隔了几天</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-06-24 00:00:00 +0800">24 Jun 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>两个时间点字符串，像这样：<code>2013-06-21</code>，怎么计算相距多少天呢？</p>
<p>有两种办法。</p>
<h2 id="datetime-">DateTime 模块</h2>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">DateTime</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">List::</span><span class="n">MoreUtils</span> <span class="sx">qw(zip)</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Data::</span><span class="n">Dumper</span><span class="p">;</span>
<span class="k">print</span> <span class="n">Dumper</span><span class="p">(</span>
    <span class="n">DateTime</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">zip</span> <span class="nv">@</span><span class="p">{</span> <span class="p">[</span><span class="sx">qw/year month day/</span><span class="p">]</span> <span class="p">},</span>
        <span class="nv">@</span><span class="p">{</span> <span class="p">[</span> <span class="nb">split</span> <span class="sr">/-/</span><span class="p">,</span> <span class="s">&#39;2013-06-21&#39;</span> <span class="p">]</span> <span class="p">}</span> <span class="p">)</span><span class="o">-&gt;</span><span class="n">subtract_datetime</span><span class="p">(</span>
        <span class="n">DateTime</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
            <span class="n">zip</span> <span class="nv">@</span><span class="p">{</span> <span class="p">[</span><span class="sx">qw/year month day/</span><span class="p">]</span> <span class="p">},</span>
            <span class="nv">@</span><span class="p">{</span> <span class="p">[</span> <span class="nb">split</span> <span class="sr">/-/</span><span class="p">,</span> <span class="s">&#39;2012-05-20&#39;</span> <span class="p">]</span> <span class="p">}</span>
        <span class="p">)</span>
        <span class="p">)</span><span class="o">-&gt;</span><span class="n">deltas</span>
<span class="p">);</span>
</code></pre></div>
<p>缺点是 <code>DateTime::Duration</code> 的 <code>days()</code> 只能返回进位 <code>months()</code> 之后剩余的天数。所以这里只能输出整个 <code>deltas()</code> 来看。</p>
<h2 id="timestamp-">timestamp 时间戳</h2>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(mktime)</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">trans</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">@str</span> <span class="o">=</span> <span class="nb">split</span> <span class="sr">/-/</span><span class="p">,</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="n">mktime</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$str</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="nv">$str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nv">$str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1900</span><span class="p">,</span>
    <span class="p">);</span>
<span class="p">}</span>
<span class="k">my</span> <span class="nv">$dt1</span> <span class="o">=</span> <span class="n">trans</span><span class="p">(</span><span class="s">&#39;1999-05-21&#39;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$dt2</span> <span class="o">=</span> <span class="n">trans</span><span class="p">(</span><span class="s">&#39;2013-06-26&#39;</span><span class="p">);</span>
<span class="k">print</span><span class="p">(</span> <span class="p">(</span> <span class="nv">$dt2</span> <span class="o">-</span> <span class="nv">$dt1</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="p">)</span> <span class="p">);</span>
</code></pre></div>
<p>这里就是要注意，<code>mktime</code> 里的 <code>month</code> 是以 0 开始的，<code>year</code> 是从 1900 开始的。</p>
<hr />
<p><strong>2014 年 01 月 22 日更新：</strong></p>
<p>在2013 年底的 advent calendar 和 perlmaven 上学习到了另外两个模块，这里补充一下：</p>
<h2 id="timepiece-">Time::Piece 模块</h2>
<p>这个模块是 Perl5 的corelist 模块，所以不用另外安装就能使用：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Time::</span><span class="n">Piece</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$t1</span> <span class="o">=</span> <span class="nn">Time::</span><span class="n">Piece</span><span class="o">-&gt;</span><span class="n">strptime</span><span class="p">(</span><span class="s">&#39;2013-06-26&#39;</span><span class="p">,</span> <span class="s">&#39;%Y-%m-%d&#39;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$t2</span> <span class="o">=</span> <span class="nn">Time::</span><span class="n">Piece</span><span class="o">-&gt;</span><span class="n">strptime</span><span class="p">(</span><span class="s">&#39;2012-06-21 GMT&#39;</span><span class="p">,</span> <span class="s">&#39;%Y-%m-%d %Z&#39;</span><span class="p">);</span>
<span class="k">print</span> <span class="o">+</span><span class="p">(</span><span class="nv">$t1</span> <span class="o">-</span> <span class="nv">$t2</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">days</span><span class="p">;</span>
</code></pre></div>
<p>Time::Piece 模块重载了加减号，所以直接两个时间相减后就得到了 Time::Seconds 对象，然后调用 <code>days</code> 方法返回具体天数就可以了。</p>
<p>这里有个奇怪的问题，在采用 <code>strptime</code> 方法解析创建对象的时候，<code>%Z</code> 格式似乎除了 <code>GMT</code> 之外写其他的都会爆出：</p>
<pre><code>Error parsing time at /usr/lib/perl/5.14/Time/Piece.pm line 469.
</code></pre>
<p>这个真的很诡异了。</p>
<p><strong>2014 年 01 月 23 日补充：</strong></p>
<p>去看了一下 <a href="https://github.com/rjbs/Time-Piece/blob/master/Piece.xs">Piece.xs</a> 的内容，发现虽然文档上说是学习的 <a href="http://www.opensource.apple.com/source/libc/libc-583/stdtime/strptime-fbsd.c">FreeBSD 的 strptime</a> 实现，但是差的也太多了～直接里面 <code>_strptime</code> 函数关于时区的就一个 <code>*got_GMT</code> 真假判断 ==!</p>
<p>完整的 strptime 见 <a href="https://metacpan.org/pod/POSIX::strptime">POSIX::strptime</a> 模块，或许我可以写一个扩展？</p>
<h2 id="datetimemoonpig-">DateTime::Moonpig 模块</h2>
<p>这个模块是最近出的，属于 DateTime 模块的接口封装和优化。</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">DateTime::</span><span class="n">Moonpig</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$t3</span> <span class="o">=</span> <span class="nn">DateTime::</span><span class="n">Moonpig</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="n">year</span> <span class="o">=&gt;</span> <span class="mi">2013</span><span class="p">,</span> <span class="n">month</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">,</span> <span class="n">day</span> <span class="o">=&gt;</span> <span class="mi">26</span><span class="p">,</span> <span class="n">time_zone</span> <span class="o">=&gt;</span> <span class="s">&#39;America/New_York&#39;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$t4</span> <span class="o">=</span> <span class="nn">DateTime::</span><span class="n">Moonpig</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="n">year</span> <span class="o">=&gt;</span> <span class="mi">2012</span><span class="p">,</span> <span class="n">month</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">,</span> <span class="n">day</span> <span class="o">=&gt;</span> <span class="mi">21</span><span class="p">,</span> <span class="n">time_zone</span> <span class="o">=&gt;</span> <span class="s">&#39;GMT&#39;</span><span class="p">);</span>
<span class="k">print</span> <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="nv">$t3</span> <span class="o">-</span> <span class="nv">$t4</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span> <span class="p">);</span>
</code></pre></div>
<p>从示例可以看出两点优化：</p>
<ol>
  <li>可以灵活调整 DateTime::Moonpig 对象的时区，而不用分别 <code>use DateTime;use DateTime::TimeZone</code>；</li>
  <li>直接加减返回的不再是那个不好用的 <code>DateTime::Duration</code> 对象而是秒数。</li>
</ol>
      <a href="/2013/06/24/who-to-calculate-days-between-two-date" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/06/21/remove-auto-deps-from-rpmbuild" title="如何去除 rpmbuild 自动发现的依赖关系" rel="bookmark">如何去除 rpmbuild 自动发现的依赖关系</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-06-21 00:00:00 +0800">21 Jun 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>同事在用简单的 SPEC 配置打包 nagios 套件的时候，发现最后生成的 RPM 包附加了很多依赖关系。其中 <code>perl-Net-SNMP</code> 这个包，是服务器默认安装中没有的。这也不是什么大问题。不过这个出现还是蛮奇怪的。值得研究一下。</p>
<p>后来在 <code>/usr/lib/rpm/</code> 目录下发现了一系列脚本，诸如<code>javadeps</code>/<code>perl.req</code>/<code>pythondeps</code>/<code>find-requires</code>/<code>mono-find-requires</code>等等。</p>
<p>这些脚本的作用是，用 <code>file</code> 命令判断文件，如果是二进制的，用ldd判断依赖；如果是脚本，过滤文件中对应的 <code>use</code>/<code>requires</code>/<code>import</code> 语句。这样就可以找出来源代码的内部依赖了。</p>
<p>那么怎么才能跳过这段逻辑呢？</p>
<p>最暴力的办法，这些文件都是 bash 或者 perl 脚本，直接修改。</p>
<p>但是还可以文明一点，像下面这段，添加在 SPEC 文件中：</p>
<div class="highlight"><pre><code class="bash">    %setup
    %prep
    cat <span class="s">&lt;&lt; \EOF &gt; %{name}-req</span>
<span class="s">    #!/bin/sh</span>
<span class="s">    %{__perl_requires} $* |\</span>
<span class="s">    sed -e &#39;/perl(Net::SNMP)/d&#39;</span>
<span class="s">    EOF</span>
    %define __perl_requires %<span class="o">{</span>_builddir<span class="o">}</span>/%<span class="o">{</span>name<span class="o">}</span>-%<span class="o">{</span>version<span class="o">}</span>/%<span class="o">{</span>name<span class="o">}</span>-req
    chmod 755 %<span class="o">{</span>__perl_requires<span class="o">}</span>
</code></pre></div>
<p>这里重定义了一个脚本，原先的定义在 <code>/usr/lib/rpm/macros</code> 中，是：</p>
<div class="highlight"><pre><code class="bash">    <span class="c">#%__find_provides       /usr/lib/rpm/rpmdeps --provides</span>
    <span class="c">#%__find_requires       /usr/lib/rpm/rpmdeps --requires</span>
    %__find_provides        /usr/lib/rpm/find-provides
    %__find_requires        /usr/lib/rpm/find-requires
    <span class="c">#%__perl_provides       /usr/lib/rpm/perldeps.pl --provides</span>
    <span class="c">#%__perl_requires       /usr/lib/rpm/perldeps.pl --requires</span>
    %__perl_provides        /usr/lib/rpm/perl.prov
    %__perl_requires        /usr/lib/rpm/perl.req
    %__python_provides      /usr/lib/rpm/pythondeps.sh --provides
    %__python_requires      /usr/lib/rpm/pythondeps.sh --requires
    %__mono_provides        /usr/lib/rpm/mono-find-provides %<span class="o">{</span>_builddir<span class="o">}</span>/%<span class="o">{</span>?buildsubdir<span class="o">}</span> %<span class="o">{</span>buildroot<span class="o">}</span> %<span class="o">{</span>_libdir<span class="o">}</span>
    %__mono_requires        /usr/lib/rpm/mono-find-requires %<span class="o">{</span>_builddir<span class="o">}</span>/%<span class="o">{</span>?buildsubdir<span class="o">}</span> %<span class="o">{</span>buildroot<span class="o">}</span> %<span class="o">{</span>_libdir<span class="o">}</span>
</code></pre></div>
<p>然后将加入了 <code>sed</code> 命令的新脚本定位为新的 MACROS 变量给 <code>rpmbuild</code> 后续使用。</p>
      <a href="/2013/06/21/remove-auto-deps-from-rpmbuild" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/06/20/rex-task-params-for-dynamic-server-group" title="通过 Rex 命令行参数向动态服务器组发起任务" rel="bookmark">通过 Rex 命令行参数向动态服务器组发起任务</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-06-20 00:00:00 +0800">20 Jun 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Rex 默认的服务器组定义方式有三种，直接写在 <code>Rexfile</code> 文件中；每行一个写成 IP 列表保存成文件，然后通过 <code>lookup_file</code> 读取；把组名和 IP 写成 <code>.ini</code> 格式文件，通过 <code>groups_file "$name.ini"</code> 一次性获取。</p>
<p>如果服务器信息存在数据库里，那么可以通过 <code>Rex::Commands::DB</code> 来快速读取数据库信息，构建服务器组。不过，如果我们是想从数据库中根据查询条件，动态获取服务器列表完成指定任务的话，就没法提前定义好 <code>group</code> 了。这个时候，怎么办呢？</p>
<p>我们可以利用 <code>task</code> 可以接受命令行参数这个特点，完成这个功能：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Rex::Commands::</span><span class="n">DB</span> <span class="p">{</span>
    <span class="n">dsn</span>      <span class="o">=&gt;</span> <span class="s">&quot;dbi:SQLite:dbname=/etc/puppet/webui/node.db&quot;</span><span class="p">,</span>
    <span class="n">user</span>     <span class="o">=&gt;</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
    <span class="n">password</span> <span class="o">=&gt;</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">task</span> <span class="s">&quot;sqlite&quot;</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$param</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$role</span>  <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">role</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$class</span> <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">class</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$todo</span>  <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">todo</span><span class="p">};</span>
    <span class="nb">grep</span> <span class="p">{</span> <span class="n">run_task</span> <span class="nv">$todo</span><span class="p">,</span> <span class="n">on</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ip</span><span class="p">}</span> <span class="p">}</span> <span class="n">db</span> <span class="nb">select</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="n">fields</span> <span class="o">=&gt;</span> <span class="s">&quot;ip&quot;</span><span class="p">,</span>
        <span class="n">from</span>   <span class="o">=&gt;</span> <span class="s">&quot;node_info&quot;</span><span class="p">,</span>
        <span class="n">where</span>  <span class="o">=&gt;</span> <span class="s">&quot;role like &#39;$role\%&#39; and classes like &#39;\%${class}\%&#39;&quot;</span><span class="p">,</span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="n">task</span> <span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">say</span> <span class="n">run</span> <span class="s">&quot;w&quot;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>然后这样运行命令即可：</p>
<div class="highlight"><pre><code class="bash">rex sqlite --role<span class="o">=</span>cdn --class<span class="o">=</span>nginx --todo<span class="o">=</span>hello
</code></pre></div>
      <a href="/2013/06/20/rex-task-params-for-dynamic-server-group" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/06/19/skyline-algorithms-intro" title="【Etsy 的 Kale 系统】skyline 的过滤算法" rel="bookmark">【Etsy 的 Kale 系统】skyline 的过滤算法</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-06-19 00:00:00 +0800">19 Jun 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>监控大户 Etsy 最近有公布了一个全新的监控分析系统，叫 Kale，博客地址：<a href="http://codeascraft.com/2013/06/11/introducing-kale/">http://codeascraft.com/2013/06/11/introducing-kale/</a>。</p>
<p>上一篇博客介绍了安装部署和数据导入的方法。但是对 <code>skyline</code> 组件的过滤原理没有做研究。今天花了点时间看 wiki 和源码，大概搞清楚了 <code>skyline</code> 的工作方式。很有趣，值得记录一下。</p>
<p>同样作为时间序列存储的 <code>rrdtool</code> 和 <code>graphite</code>，都偏重在预测算法，也就是说根据现有数据推测下一个数据应该是多少；而 <code>skyline</code> 则是根据现有数据统计最新数据是否异常。</p>
<p>目前，<code>skyline</code> 一共提供了 7  个异常检测算法，如果有 5 个以上认为是异常，那么 <code>skyline</code> 就认为这个序列异常了。(当然，这都是可以修改的)</p>
<p>异常检测算法实际写在了 <code>src/analyzer/algorithms.py</code> 里，包括有：</p>
<h3 id="firsthouraverage">first_hour_average</h3>
<p>这是最简单的。先求本周期内最前面的第一个小时的平均值和标准差，然后和最新的三个值的平均值(<code>tail_avg()</code>，这是后面多数算法都通用的做法)做比较。如果 <code>tail_avg</code> 和 第一小时平均值的差距大于 3 倍的标准差，那么认定为异常。</p>
<h3 id="simplestddevfrommovingaverage">simple_stddev_from_moving_average</h3>
<p>把上面算法的范围扩大化，求的是整个周期内全部数据的平均值和标准差。</p>
<h3 id="stddevfrommovingaverage">stddev_from_moving_average</h3>
<p>在上面算法的基础上，采用指数加权移动平均值。对周期内采点数量较少的情况更好一些。</p>
<h3 id="meansubtractioncumulation">mean_subtraction_cumulation</h3>
<p>做法是这样的：</p>
<ol>
  <li>排除最后一个值；</li>
  <li>求剩余序列的平均值；</li>
  <li>全序列减去上面这个平均值；</li>
  <li>求剩余序列的标准差；</li>
  <li>判断全序列最后一个值是否大于 3 倍的标准差</li>
</ol>
<p>在代码中本来还计算了一次序列的指数加权移动平均值，但是算完了却没用，感觉怪怪的。</p>
<h3 id="leastsquares">least_squares</h3>
<p>采用最小二乘法拟近时间序列，然后用实际值减去拟近值得到新序列。然后判断新序列的最后三个值的平均值是否大于 3 倍的新序列标准差。</p>
<p>所谓最小二乘法，简单说就是对一个 [x, y] 序列，会有一对常数 [m, c]，让 <code>Y = mx + c</code> 等式中的 Y 和 y 在全序列上最接近。</p>
<h3 id="histogrambins">histogram_bins</h3>
<p>将整个周期序列的数据按照直方图统计法归入 15 个直方中，然后看最后三个值的平均值属于这 15 个直方的具体哪个。如果这个直方中包含的数据小于 20 个，判断为异常。</p>
<p>从算法中可以知道，如果周期内数据量不够，很容易被判断为异常的。</p>
<h3 id="grubbs">grubbs</h3>
<p>将整个周期序列的数据按照格拉布斯法求异常值。</p>
<p>标准的格拉布斯法是这样的：</p>
<ol>
  <li>从小到大排序；</li>
  <li>求序列的平均值和标准差；</li>
  <li>计算最小值和最大值与平均值的差距，更大的那个为可疑值；</li>
  <li>可疑值减去平均值，再除以标准差，如果大于格拉布斯临界值，那么就是异常值；</li>
  <li>排除异常值，对剩余序列循环做 1-5 步骤。</li>
</ol>
<p>这里只用判断时间序列的最后是否异常，所以直接将最后三个值的平均值作为可疑值判断是否异常即可。</p>
<p><strong>2013 年 07 月 23 日更新</strong></p>
<p>新增了一个异常算法，现在有 8 个了，要通过 6 个才算真异常。</p>
<p>新增的是&rdquo;绝对中值偏差法&rdquo;</p>
<h3 id="medianabsolutedeviation">median_absolute_deviation</h3>
<p>具体实现是：序列的最后一个值，比该序列的绝对中值大 6 倍以上，即判断为异常。</p>
<p>注意这里是中值，不是平均值。</p>
<p><strong>2013 年 08 月 14 日更新</strong></p>
<p>新增一个异常算法，现在有 9 个了。</p>
<p>新增的是&rdquo;柯尔莫诺夫-斯米尔诺夫检验法&rdquo;</p>
<h3 id="kolmogorov-smirnovtest">Kolmogorov-Smirnov_test</h3>
<p>具体实现是：计算序列内最近十分钟的数值的ks测试分布，然后计算序列中最近一个小时前到十分钟前这 50 分钟的数值的ks测试分布；如果两个分布相差较大，即判断为异常。</p>
      <a href="/2013/06/19/skyline-algorithms-intro" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/06/18/etsy-kale-intro" title="【Etsy 的 Kale 系统】简介、部署和应用" rel="bookmark">【Etsy 的 Kale 系统】简介、部署和应用</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-06-18 00:00:00 +0800">18 Jun 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>监控大户 Etsy 最近有公布了一个全新的监控分析系统，叫 Kale，博客地址：<a href="http://codeascraft.com/2013/06/11/introducing-kale/">http://codeascraft.com/2013/06/11/introducing-kale/</a>。</p>
<p>目前的介绍内容比较简单。两个组件 <code>skyline</code> 和 <code>oculus</code> 之间的关系也还没搞清楚。大概上， <code>skyline</code> 是一个 python 程序，接受 <code>cPickle</code> 和 <code>MessagePack</code> 两种数据包，解压后的数据格式类似 <code>graphite</code> 接收的，然后存在 <code>Redis-server</code> 中。在 webapp 上提供一个类似 <code>rrdtool</code> 的功能，显示触发阈值线的趋势图(不触发的不会显示，自动过滤了)。</p>
<p>安装步骤：</p>
<div class="highlight"><pre><code class="bash">    pip install -r requirements.txt
    apt-get install -y numpy scipy
    pip install pandas patsy statsmodels msgpack_python
    cp src/settings.py.example src/settings.py
    mkdir /var/log/skyline
    mkdir /var/run/skyline
    mkdir /var/log/redis
    <span class="c"># 必须用最新版的 redis-server 才能正常存储</span>
    wget http://redis.googlecode.com/files/redis-2.6.13.tar.gz
    tar zxvf redis-2.6.13.tar.gz
    <span class="nb">cd </span>redis-2.6.13
    make
    ./src/redis-server ../bin/redis.conf
    <span class="nb">cd</span> ../src
    <span class="c"># 这里会启动 UDP 2024 端口接受 cpickle 包，2025 端口接受 msgpack 包</span>
    ../bin/horizon.d start
    ../bin/analyzer.d start
    <span class="c"># 这里会启动 TCP 1500 端口接受 web 访问</span>
    ../bin/webapp.d start
    <span class="c"># 测试是否正常</span>
    <span class="nb">cd</span> ../utils
    ./seed_data.py
</code></pre></div>
<p><code>oculus</code> 是一个 rack 应用，需要定时从 <code>skyline</code> 中导入数据到 <code>ElasticSearch</code> 中。同时，<code>oculus</code> 还提供了一个 <code>ElasticSearch</code> 分析器插件，可以在 ES 中完成 <code>FastDTW</code> 和 <code>Euclidian</code> 两种位移算法（用来给不同时间序列的近似度打分）。在rack 页面上，提供搜索框，你可以提交一个 metric 名称——经过测试，目前应该是采用完全匹配的方式搜索——然后展示这个 metric 的图形，以及按照 score 打分排序的近似时间序列。</p>
<ul>
  <li>欧几里德算法原理：根据两点的坐标系计算直线距离；</li>
  <li>动态时间归整原理：将时间序列进行延伸或者缩短，然后再计算。
<a href="http://www.cnblogs.com/kemaswill/archive/2013/04/18/3028610.html">http://www.cnblogs.com/kemaswill/archive/2013/04/18/3028610.html</a></li>
</ul>
<p>安装步骤：</p>
<div class="highlight"><pre><code class="bash">    <span class="c"># 只能用 0.20.5 版，0.90 版目前不支持</span>
    wget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-0.20.5.tar.gz
    tar zxvf elasticsearch-0.20.5.tar.gz
    mv elasticsearch-0.20.5 /opt/elasticsearch
    <span class="c"># 编译插件</span>
    cp -r resources/elasticsearch-oculus-plugin /opt/elasticsearch/
    <span class="nb">pushd</span> /opt/elasticsearch/elasticsearch-oculus-plugin
    rake build
    cp OculusPlugins.jar /opt/elasticsearch/lib/OculusPlugins.jar
    <span class="c"># 加载分析器和脚本</span>
    cat &gt;&gt;/opt/elasticsearch/config/elasticsearch.yml<span class="s">&lt;&lt;EOF</span>
<span class="s">    script.native:</span>
<span class="s">      oculus_euclidian.type: com.etsy.oculus.tsscorers.EuclidianScriptFactory</span>
<span class="s">      oculus_dtw.type: com.etsy.oculus.tsscorers.DTWScriptFactory</span>
<span class="s">    EOF</span>
    <span class="c"># 启动</span>
    /opt/elasticsearch/bin/elasticsearch
    <span class="nb">popd</span>
<span class="nb">    </span>bundle install
    mkdir /var/run/oculus
    mkdir /var/log/oculus
    <span class="c"># 启动 worker 进程，这是import.rb 和 ES 交流的渠道</span>
    rake resque:start_workers
    <span class="c"># 编辑 config/config.yml，注意里面ES一定要提供两台，哪怕写一个127.0.0.1一个localhost，后面 import 会验证数目</span>
    vi config/config.yml
    <span class="c"># 从 skyline 导入数据</span>
    ./scripts/import.rb
    <span class="nb">echo</span> <span class="s1">&#39;*/2 * * * * ~/oculus/scripts/import.rb &amp;&gt; /var/log/oculus/import.log&#39;</span> &gt;&gt; cron.list
    crontab -u root cron.list
    <span class="c"># 启动web</span>
    thin start
    <span class="c"># 默认用户密码都是admin，需要先点击初始化</span>
    gnome-open localhost:3000/admin
</code></pre></div>
<p><code>oculus</code> 的测试我是做出来了。如图：</p>
<p><img src="/images/uploads/oculus.png" alt="oculus" /></p>
<p>这个数据我是通过 perl 生成的随机数，所以也没什么近似队列了。展示一下脚本，这样说明我们可以通过其他脚本扩展 Kale 系统的用途。</p>
<div class="highlight"><pre><code class="perl">    <span class="c1">#!/usr/bin/env perl</span>
    <span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Data::</span><span class="n">MessagePack</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">AnyEvent::Handle::</span><span class="n">UDP</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$mp</span> <span class="o">=</span> <span class="nn">Data::</span><span class="n">MessagePack</span><span class="o">-&gt;</span><span class="k">new</span><span class="o">-&gt;</span><span class="n">utf8</span><span class="o">-&gt;</span><span class="n">prefer_integer</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$cv</span>   <span class="o">=</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">condvar</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$sock</span> <span class="o">=</span> <span class="nn">AnyEvent::Handle::</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="nb">connect</span>   <span class="o">=&gt;</span> <span class="p">[</span> <span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="s">&#39;2025&#39;</span> <span class="p">],</span>
        <span class="n">on_recv</span>   <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="p">},</span>
        <span class="n">autoflush</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="k">my</span> <span class="nv">$timer</span> <span class="o">=</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">(</span>
        <span class="n">after</span>    <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">interval</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">cb</span>       <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
            <span class="k">print</span> <span class="s">&quot;send...\n&quot;</span><span class="p">;</span>
            <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;localhost.loadavg&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nb">time</span><span class="p">(),</span> <span class="nb">rand</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">];</span>
            <span class="k">my</span> <span class="nv">$packed</span> <span class="o">=</span> <span class="nv">$mp</span><span class="o">-&gt;</span><span class="nb">pack</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
            <span class="nv">$sock</span><span class="o">-&gt;</span><span class="n">push_send</span><span class="p">(</span><span class="s">&quot;$packed&quot;</span><span class="p">);</span>
        <span class="p">},</span>
    <span class="p">);</span>
    <span class="nv">$cv</span><span class="o">-&gt;</span><span class="nb">recv</span><span class="p">;</span>
</code></pre></div>
<p>从源码中，看到还有 <code>ganglia_to_skyline.rb</code> 脚本。目前看，<code>Kale</code> 应该是想着用 <code>skyline</code> 代替 <code>graphite-web</code>，得用 <code>redis</code> 来代替 <code>graphite-whisper</code>，不过我觉得似乎意义不是很大，还不如直接把数据存入 <code>ElasticSearch</code>，形成一套类似 <code>openTSDB</code> 的，但是完全基于 ES 的高扩展分布式方案。</p>
      <a href="/2013/06/18/etsy-kale-intro" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/06/12/translate-85-operational-rules" title="【翻译】运维的85条规则" rel="bookmark">【翻译】运维的85条规则</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-06-12 00:00:00 +0800">12 Jun 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>2007 年，时任虚拟世界游戏公司 Vivaty 运维副总裁的 Jon Prall 在他的个人博客上发表过一篇<a href="http://jprall.typepad.com/blog/2010/10/85-operational-rules.html">《运维的85条规则》</a>。2010 年他跳槽到视频电话公司 Tango 之初，做了两处更新，兹翻译如下：</p>
<ol>
  <li>
    <p>容量第一，优化第二——这条规则在故障发生时生效。在宕机的时候别研究什么优化，先恢复设备。</p>
  </li>
  <li>
    <p>保留所有可以捕获的记录——以 PostgresQL 为例，包括有 WAL 文件，Slony 复制，快照技术，基于硬盘的 DB 版本(快照附带的)</p>
  </li>
  <li>
    <p>不要因为优化引入更多问题。通常我们解决问题时做出来的东西都会转变成之后运维工作的负担。请确认为运维工作开发的那些工具已经完全交付使用。这些东西经常无法正常运行结果要返回开发组重来。更重要的，这种变更请求通常会打破团队原本安排好的工作计划。</p>
  </li>
  <li>
    <p>保持简单，不要让事情变得太复杂，聪明的你一定可以做到的。</p>
  </li>
  <li>
    <p>谨慎使用缓存以保护那些难以水平扩展的资源。当然，如果你可以水平扩展它，那么给他加缓存层就不用考虑太多。一旦用上了缓存层，它的目的应该是提高最终用户的访问性能，而不是增加网站的容量。否则，你不过是给自己加上了一个新的非常不可靠的瓶颈。他们潜在的负面影响可能危及整个系统。事实上缓存层失效带来的，经常是雪崩式的级联故障。</p>
  </li>
  <li>
    <p>不要什么都自己写代码实现，也不要什么都从厂家买——要在适当的时候采用适当的工具。</p>
  </li>
  <li>
    <p>谈判——和真正有实力的厂家谈判的唯一办法就是提前做好功课，准备好一切可行项。这样一旦有必要，你可以从你的首选厂家里选择离开。不用搞虚张声势那套了。</p>
  </li>
  <li>
    <p>永远要准备好 N+1 的服务器。如果 N 等于 1，那么不管什么情况都不要动用这个 +1 的设备，专职等待 N 失效后的接管。当你使用冗余的服务器来均衡负载的时候，就只有49%或者更少的容量可管理了。通常我们会获得 N+2 的机会——一定要好好利用起来。</p>
  </li>
  <li>
    <p>数据丢失是任何一家公司都不敢冒的风险——这是一条普遍真理。丢失数据造成的损耗远远超过用于保证数据不丢失的花费。</p>
  </li>
  <li>
    <p>随时随地的并行化——这是一种很重要的思维方式。比如，如果 MogileFS 设置为位置感知的方式并且需要实时复制，那么每个 MogileFS 服务器都必须可以复制自己的数据到负载均衡器指定的另一端。只要有可能，尽量实现这种多对多的方式。</p>
  </li>
  <li>
    <p>RTFM——就在今天我还要阅读一对 RAID 卡的说明书来比较他们微妙的差异。魔鬼在于细节。像做家庭作业一样读文档吧！</p>
  </li>
  <li>
    <p>了解每一层上的瓶颈以及如何发现瓶颈。必须要知道你是在磁盘，内存，还是 CPU 上受限制了，搞清楚这个其实挺简单的。</p>
  </li>
  <li>
    <p>要有一个固定的容量管理流程——而且是主动式的，不是被动式的。要知道系统的弱点在哪里，让实际负荷曲线跑到容量曲线之上是极度危险的。</p>
  </li>
  <li>
    <p>不促成失败，也不惧怕改变。</p>
  </li>
  <li>
    <p>不要吸进你自己的废气。别以为你现在的工作结果会变成未来你如何工作的动力。</p>
  </li>
  <li>
    <p>运维人员要写的代码是运维工具，而不是应用软件。</p>
  </li>
  <li>
    <p>不要低估运维团队中项目经理、技术作者、金融分析师的价值。这些人通常比你给的工资值钱多了。</p>
  </li>
  <li>
    <p>监控所有的东西——报警只用在异动的时候，其他的都记录下来供趋势分析。</p>
  </li>
  <li>
    <p>要有一个固定的流程来查看每个地方的趋势数据。</p>
  </li>
  <li>
    <p>不要让监控太吵闹，那样很快就变得没作用了。</p>
  </li>
  <li>
    <p>确保你的监控系统简单易用到公司里每个人都能上手。监控数据指标转换成为业务指标、市场指标和销售指标等等的频率可能高的让你吃惊。</p>
  </li>
  <li>
    <p>只在可以做出相应改变的地方做总结，否则就是白白浪费时间。</p>
  </li>
  <li>
    <p>总结要公开，同时附上事件相关的数据。这样大家可以很容易的找到总结的关键点并且跳转到对应数据。</p>
  </li>
  <li>
    <p>要让技术的每一个点都有人员在负责。</p>
  </li>
  <li>
    <p>同时为这些负责人准备好备份人员。</p>
  </li>
  <li>
    <p>不断发招聘——哪怕没有名额了。</p>
  </li>
  <li>
    <p>做自己最严厉的批评者。不管自己或者自认多聪明，总有可以提高的地方。</p>
  </li>
  <li>
    <p>多往外看，拿自身的水平和尽量多的公司的职位需求做对比。</p>
  </li>
  <li>
    <p>每年参加一个技术交流大会。如果一年有好几个，那选最好的那一个去就够了。</p>
  </li>
  <li>
    <p>买你需要的而不是你想要的。绝不摘下你公司的帽子换上那个写着“对我来说什么最简单最安全”的。</p>
  </li>
  <li>
    <p>只做对业务最好的事情，哪怕这件事是让你滚蛋……</p>
  </li>
  <li>
    <p>问责制度正规化——记录承诺，事后追究没有完成者。</p>
  </li>
  <li>
    <p>不允许重复失败。听起来有些过于苛责了。不过要区分不可挽回的失误和失误的差别。</p>
  </li>
  <li>
    <p>无情——因为对手都是无情的。</p>
  </li>
  <li>
    <p>工作是你要在完成的时候亲自署名的东西。署名同时也意味着完成任务。</p>
  </li>
  <li>
    <p>保持对外的可用联络。</p>
  </li>
  <li>
    <p>创业的伙伴——告诉他们你的专长和能力范围。你会得到免费的产品回报，有时候是生活中的。</p>
  </li>
  <li>
    <p>容量是一个业务/产品问题。也就是说每个页面、上传或者登录等请求的网络消耗，都必须是可见的，以协助完成正确的业务/产品决策。</p>
  </li>
  <li>
    <p>一定要打败预算！运维团队总是预算金额最大的挥霍者。公司的收入目标经常达不到，运维团队应该有很多办法来推迟自己的花费。</p>
  </li>
  <li>
    <p>过去的经验不一定适用于现在乃至将来——多尝试没错，而且要有恰当的测试工具来做这件事。</p>
  </li>
  <li>
    <p>文档——所有事情都应该好好记录成文档。避免团队的新成员绕着圈的找遍全团队逐一了解工作内容。</p>
  </li>
  <li>
    <p>画一张超大尺寸的网络拓扑图，描绘你的数据中心。</p>
  </li>
  <li>
    <p>为你的每个产品都画一个逻辑流程图。</p>
  </li>
  <li>
    <p>维基——让大家可以很容易的发布“如何修复这个问题”的文档并且容易查找。这是技术作者发挥作用的地方，不过维基可以让哪怕非正式的文档或者增增改改的小段落也更好查看。</p>
  </li>
  <li>
    <p>确保团队的每个成员，对，是每一个，都是可以替换的。</p>
  </li>
  <li>
    <p>有些人在家里干活比在公司的时候还好，但有些人却不行。</p>
  </li>
  <li>
    <p>订单打包签订——把硬件需求打包成大订单后再去咨询最大的折扣合同，记得订单里要包括所有一切，比如备件包，租赁条件等等。</p>
  </li>
  <li>
    <p>和供应商保持长期联系，哪怕你换到下一份工作的时候也能联系上他们。</p>
  </li>
  <li>
    <p>给运维团队每个人都配上一切他们可以远程操控的东西——掌上电脑， 3G 网卡，24 寸 LCD 屏幕……你为有才华的人付出得到的回报，远超过在远程雇佣的现场工程师。记住，运维工程师都是电力狂人，他们知道并且能充分利用屏幕上每个像素。</p>
  </li>
  <li>
    <p>除非 Mac 可以运行 office 2007 和 outlook，否则团队里总需要几个 windows。这事很破坏团队的会议安排，联系人管理和邮件列表等等。</p>
  </li>
  <li>
    <p>要有一个简化的采购流程——前提是你要了解自己的预算，并且能够管理好。我们可以从财务报告中得到实际。技术驱动的报告和财务驱动的报告之间通常存在差距。一个好的运维经理可以创建一些模型，将这些差别计入销售总成本中。而理解这些的 CFO 才可以帮助推动业务决策。</p>
  </li>
  <li>
    <p>周会一定要持续举行，对上周的事件逐一总结和问责。</p>
  </li>
  <li>
    <p>创建一个独立的升级系统，来管理那些对运维产生负面影响的代码开发工程。这个想法的来源是：一个同时涉及运维和开发的问题，在运维或者开发的跟踪系统里大多被湮没无视，最后没人理睬，所以给这些问题单独创建一个跟踪系统反而更加简单清楚。</p>
  </li>
  <li>
    <p>产品开发从设计开始的每个阶段都要和运维技术相结合。这样，扩展性，监控和可靠性都融入到产品里。这样同时也可以确保运维负责的硬件采购、监控系统按时到位，运行手册即时更新，最后产品按照预计时间上线运行并且都符合运维标准。</p>
  </li>
  <li>
    <p>像一个真正的公司一样运作——萨班斯法案，WebTrust 安全审计认证，SAS 70 审计标准，Visa 组织和银行等等。如果你真的成功了，这些都是你不得不打交道的。早点开始这些准备其实很简单，不需要太多的知识。不过就是开发一个工单/任务跟踪工具，然后好好使用。把变更控制和管理放进同样的系统里，好好使用。其他信息也放进来。系统就可以帮助我们找出像“上周变更了什么”这类信息。</p>
  </li>
  <li>
    <p>给冗余留空间。一开始或许很难，但是一个没有真正的扩展性和可靠性的系统，才会真正耽误你获得成功的时间。</p>
  </li>
  <li>
    <p>买个 Oracle 标准版(或者微软 SQL Server 标准版)是值得的。如果你可以限制住自己不超过标准版的需求，那就绝对值得买，哪怕你刚刚开始创业。</p>
  </li>
  <li>
    <p>Postgres 和 MySQL 的免费不错。如果你不是特别在意事务完整性，MySQL 其实挺好的。</p>
  </li>
  <li>
    <p>容量设计应该按照每日峰值再上抛 20% 到 30% 的冗余。除非你是个 vmotion(译注：VMWare 的热迁移技术)达人。</p>
  </li>
  <li>
    <p>尽量多读一些贸易杂志。它们通常是免费的，只要你填写一些调查问卷就好了。新闻的价值是巨大的。对了，记得让他们投递到你家里，工作的时候读杂志的机会趋近于零。</p>
  </li>
  <li>
    <p>注意安全。开发人员不应该有生产线的权限，而应该去做代码复核。这是和运维之间的职责分离。然后运维中应该有人控制设置其他运维人员权限的权限。创建一个员工手册，警告大家违反安全条例会有很严重的后果。从一开始就要记住从物理的、逻辑的、功能的各个方面来保护客户的数据安全和隐私。万一有客户要和你对簿公堂，你回忆起来发现自己只是靠勇气和勤奋来保护客户数据，这感觉可不怎么好。</p>
  </li>
  <li>
    <p>控制好访问入口。首先要保证大家可以正常完成工作；其次要确保你知道他们是从哪里进来的。快去实现双因素身份验证方法吧。</p>
  </li>
  <li>
    <p>对于人们访问生产环境必经之路的堡垒机和网关，键盘记录是至关重要的。对于 Windows 可能稍微有点难度，不过有些网关可以提供自动截屏功能。</p>
  </li>
  <li>
    <p>确保有多种办法登录生产环境。不要期望公司的 VPN 在网络中断的时候还能起作用。直接把 VPN 架设在生产环境里。</p>
  </li>
  <li>
    <p>使用 LDAP 做认证，哪怕你只有 10 台机器，通过复制 passwd 和 shadow 文件的方式来管理，你也要 LDAP 认证。</p>
  </li>
  <li>
    <p>不要低估在 UNIX 环境中一台 Windows Server 2008 设备是多么有用。如果只是因为不懂 Windows，那么去学，而不是贬低它。</p>
  </li>
  <li>
    <p>不要用那些无效的无线方案浪费大家的时间。公司里所有人都在移动，沙发上，会议室里，门口，到处都要上网。千万维护好你的无线路由。</p>
  </li>
  <li>
    <p>总有些人把额外的精力和时间都投入到工作上——直接通过他们的请假单好了。而另一些人恰恰相反只把注意力放在怎么通过自己的请假单。在个人时间安排上，运维人员总是做出巨大的牺牲，他们随时准备凌晨3点爬起床快速响应排障需求。</p>
  </li>
  <li>
    <p>通过集中式的 RDBMS 管理你所有的设备资产。然后复制资产，人员，网络，合同等所有数据到异地。没错，要的是一个在线的实时可用的复制，而不是每天晚上备份到磁带。</p>
  </li>
  <li>
    <p>自动使用多进程以确认安全，包括操作系统或者产品的上线，文件的推送，日志的分析等。</p>
  </li>
  <li>
    <p>自动化操作必须和运维的 RDBMS 数据相关联。</p>
  </li>
  <li>
    <p>设备通常有三种状态——离线，服务中，预备。预备状态就是说正在通过 cfengine、rsync 或者其他你在使用的工具完成配置。服务中就是已经运行着流量了。同时还需要一个状态，这个状态下的设备可以在不提供生产服务的情况下收集或者测试数据。</p>
  </li>
  <li>
    <p>尊重日志数据。在设备下线或者重建之前，一定要先导出日志。</p>
  </li>
  <li>
    <p>如果业务飞速发展让你没有太多时间来做优化，那就尽力锁定一切——进程还能工作，就不要改变它，直到后来有了绝对必要的理由。总之，锁定默认值，等待成长到必要时再审视。</p>
  </li>
  <li>
    <p>你永远无法避免运维工程师在你基础设施最关键的地方犯点啥错——比如在哪台机器上不小心执行 <code>rm -rf /</code> 命令。</p>
  </li>
  <li>
    <p>为团队保持好玩和有趣的气氛——如果他们不再享受他们的工作，他们就会找别的事情来消遣。要让团队有主人翁意识，运维不是哪个经理的个人任务。</p>
  </li>
  <li>
    <p>提供 99.999% 可用性的真正价值在于让我们有能力保持灵活。这意味着当你需要的时候可以充分利用系统冗余。物理变更、设备迁移、代码修改和回退等等都游刃有余。这个对于公司本身价值巨大，甚至比对客户还大。</p>
  </li>
  <li>
    <p>如果你能做到 99.999%，那就给客户一个 100% 的SLA承诺。</p>
  </li>
  <li>
    <p>不要湮没软件热更新的能力。应该被湮没的是你自己回滚或者转移到旧版本代码的能力。压根就不应该“处理”这种徒劳的失败转移。当事情变得不如人意的时候，你更应该做的是找个大玩意儿来挡住你的肥屁股。CYA（译注：Cover Your Ass，就是前面说的盖屁股） = 保持敏捷 = 成功的公司。</p>
  </li>
  <li>
    <p>记住你为客户构建产品的思路里每一步的原因和目的——不管你部署给最终用户的是什么，把这些放在最先考虑，即你所有（基础设施、流程和人员）的设计都是为了提供最好的服务和产品。</p>
  </li>
  <li>
    <p>第一次就要成功。很少有机会让你回去重新开始的。重做是对公司资源的巨大浪费。</p>
  </li>
  <li>
    <p>多联系业内的合作伙伴、盟友和类似的企业，看看他们的运维是怎么做的。很可能他们碰到了跟你一样的挑战，而解决的更为巧妙。不要害怕分享自己的经验和处理过程，因为别人也会回馈的。</p>
  </li>
  <li>
    <p>招人就要招那些足以让自己担心会被挤掉目前工作的，招那些你欣赏和可以学习的榜样，招那些你愿意和他一起工作的。这感觉甚至超过你招聘一个工作考评为A的员工。</p>
  </li>
  <li>
    <p>IT 和运维是完全不同的两个概念。一个不错的运维经理应该可以管理好企业 IT，但是一个传统的 IT 工程师很难有能力处理互联网运维任务。</p>
  </li>
  <li>
    <p>当你开始一份新工作或者在每年的起始，都应该去争取预算。这不是说滚着那个滋滋响的轮子往前走(应该是指循规蹈矩照本宣科)，而是要一个基于历史数据做出的优秀的文案。如果你正在评估一份新工作，请确认你完完全全的知道预算以及预算的来源。同时，还应该有的是改善这份预算的权利。</p>
  </li>
</ol>
      <a href="/2013/06/12/translate-85-operational-rules" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/05/28/compare-dsl-of-puppet-with-rex" title="puppet和rex的常用资源写法类比" rel="bookmark">puppet和rex的常用资源写法类比</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-05-28 00:00:00 +0800">28 May 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>首先要申明，rex 和 puppet 本质上是不同的，puppet 追求的是状态，rex 追求的是操作。puppet 用户经常关心的是 agent 运行了没，而 rex 用户关心的是怎么写 Rexfile 能让中控运行 rex 时的命令参数更简洁漂亮(个人感受==!)。所以哪怕在本文中列举的这些资源写法很类似，也请读者们注意：rex 的资源关键词命名，都是带有动作性的，比如 <code>create</code>，<code>add</code>，<code>install</code>，<code>upload</code>，<code>download</code>，<code>sync</code> 等等。甚至精确的说，rex 里这些不是资源(<code>Puppet::Types::***</code>)，他们是 <code>Rex::Commands::***</code>。</p>
<p>因为 rex 基于并发 ssh 连接，所以它有一些操作是 puppet 所没有的，比如 <code>tail</code>，<code>file_append</code>，<code>fdisk</code>，<code>sysctl</code> 和 <code>iptables</code> 等等，这里暂时不列举。总的来说，本文目的是总结类似的部分，而不是不同的用法……</p>
<h1 id="cron-">Cron 资源</h1>
<h3 id="puppet-">puppet 写法</h3>
<div class="highlight"><pre><code class="ruby">    <span class="n">cron</span> <span class="p">{</span> <span class="s1">&#39;check_starttime&#39;</span><span class="p">:</span>
        <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
        <span class="n">minute</span>  <span class="o">=&gt;</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">hour</span>    <span class="o">=&gt;</span> <span class="s1">&#39;*/2&#39;</span><span class="p">,</span>
        <span class="n">user</span>    <span class="o">=&gt;</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
        <span class="n">command</span> <span class="o">=&gt;</span> <span class="s1">&#39;sh /usr/local/bin/check_start_time.sh&#39;</span><span class="p">,</span>
        <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/usr/local/bin/check_start_time.sh&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
<h3 id="rex-">rex 写法</h3>
<div class="highlight"><pre><code class="perl">    <span class="n">cron</span> <span class="n">add</span> <span class="o">=&gt;</span> <span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="n">minute</span>       <span class="o">=&gt;</span> <span class="s">&#39;5&#39;</span><span class="p">,</span>
        <span class="n">hour</span>         <span class="o">=&gt;</span> <span class="s">&#39;*&#39;</span><span class="p">,</span>
        <span class="n">day_of_month</span> <span class="o">=&gt;</span> <span class="s">&#39;*&#39;</span><span class="p">,</span>
        <span class="n">month</span>        <span class="o">=&gt;</span> <span class="s">&#39;*&#39;</span><span class="p">,</span>
        <span class="n">day_of_week</span>  <span class="o">=&gt;</span> <span class="s">&#39;*&#39;</span><span class="p">,</span>
        <span class="n">command</span>      <span class="o">=&gt;</span> <span class="s">&#39;/path/to/your/cronjob&#39;</span><span class="p">,</span>
    <span class="p">};</span>
</code></pre></div>
<h1 id="file-">File 资源</h1>
<h3 id="puppet--1">puppet 写法</h3>
<div class="highlight"><pre><code class="ruby">    <span class="n">file</span> <span class="p">{</span> <span class="s1">&#39;/etc/squid/squid.conf&#39;</span><span class="p">:</span>
        <span class="k">ensure</span>    <span class="o">=&gt;</span> <span class="n">file</span><span class="p">,</span>
        <span class="n">mode</span>      <span class="o">=&gt;</span> <span class="s1">&#39;0755&#39;</span><span class="p">,</span>
        <span class="n">content</span>   <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;squid/squid.conf.erb&#39;</span><span class="p">),</span>
        <span class="nb">require</span>   <span class="o">=&gt;</span> <span class="no">Package</span><span class="o">[</span><span class="s1">&#39;squid&#39;</span><span class="o">]</span><span class="p">,</span>
        <span class="n">subscribe</span> <span class="o">=&gt;</span> <span class="no">Service</span><span class="o">[</span><span class="s1">&#39;squid&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
<h3 id="rex--1">rex 写法</h3>
<div class="highlight"><pre><code class="perl">    <span class="n">file</span> <span class="s">&quot;/etc/squid/squid.conf&quot;</span><span class="p">,</span>
        <span class="n">content</span>   <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="s">&quot;templates/squid.tpl&quot;</span><span class="p">,</span> <span class="n">vars</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">%var</span> <span class="p">),</span>
        <span class="n">owner</span>     <span class="o">=&gt;</span> <span class="s">&quot;root&quot;</span><span class="p">,</span>
        <span class="n">group</span>     <span class="o">=&gt;</span> <span class="s">&quot;root&quot;</span><span class="p">,</span>
        <span class="n">mode</span>      <span class="o">=&gt;</span> <span class="mi">700</span><span class="p">,</span>
        <span class="n">needs</span>     <span class="o">=&gt;</span> <span class="n">SquidPkgTask</span><span class="p">,</span>
        <span class="n">on_change</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="n">service</span> <span class="n">squid</span> <span class="o">=&gt;</span> <span class="s">&#39;restart&#39;</span> <span class="p">};</span>
</code></pre></div>
<p>这里的 <code>on_change</code> 是 File 资源独有的。</p>
<p><strong>通用资源方面，rex 中在同一个 task 内，是按照书写顺序执行；在 task 之间，通过 <code>needs</code> 可以定义依赖。</strong></p>
<p>另外 rex 还有 <code>before</code>，<code>after</code>，<code>around</code> 三个关键字作用于 task 上。不过这三个是在 rex 控制端执行，不是在远端主机上执行。</p>
<p>注意这里，这个 file 看起来没有使用操作性的动词，但其实他是下面这个写法的简写而已：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">install</span> <span class="n">file</span>  <span class="o">=&gt;</span> <span class="s">&#39;templates/etc/hosts.tpl&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="n">source</span>    <span class="o">=&gt;</span> <span class="s">&quot;/etc/hosts&quot;</span><span class="p">,</span>
        <span class="n">owner</span>     <span class="o">=&gt;</span> <span class="s">&quot;root&quot;</span><span class="p">,</span>
        <span class="n">group</span>     <span class="o">=&gt;</span> <span class="s">&quot;root&quot;</span><span class="p">,</span>
        <span class="n">mode</span>      <span class="o">=&gt;</span> <span class="mi">700</span><span class="p">,</span>
        <span class="n">on_change</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="n">say</span> <span class="s">&quot;Something was changed.&quot;</span> <span class="p">},</span>
        <span class="n">template</span>  <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="n">greeting</span> <span class="o">=&gt;</span> <span class="s">&quot;hello&quot;</span><span class="p">,</span>
                        <span class="n">name</span>     <span class="o">=&gt;</span> <span class="s">&quot;Ben&quot;</span><span class="p">,</span>
                     <span class="p">},</span>
    <span class="p">};</span>
</code></pre></div>
<p>另外，还有一个通过 SFTP 接口上传的写法：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">upload</span> <span class="s">&quot;hosts&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/etc/&quot;</span><span class="p">;</span>
</code></pre></div>
<h1 id="package-">Package 资源</h1>
<h3 id="puppet--2">puppet 写法</h3>
<div class="highlight"><pre><code class="ruby">    <span class="n">package</span> <span class="p">{</span> <span class="s1">&#39;ganglia-gmond-modules-python-plugin&#39;</span><span class="p">:</span>
        <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">installed</span><span class="p">,</span>
        <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;repos&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
<h3 id="rex--2">rex 写法</h3>
<div class="highlight"><pre><code class="perl">    <span class="n">repository</span> <span class="n">add</span> <span class="o">=&gt;</span> <span class="n">myrepo</span><span class="p">,</span>
        <span class="n">url</span> <span class="o">=&gt;</span> <span class="s">&#39;http://rex.linux-files.org/CentOS/$releasever/rex/$basearch/&#39;</span><span class="p">;</span>
    <span class="n">update_package_db</span><span class="p">;</span>
    <span class="n">install</span> <span class="nb">package</span> <span class="o">=&gt;</span> <span class="s">&#39;vim&#39;</span><span class="p">;</span>
</code></pre></div>
<h1 id="class-">Class 定义</h1>
<h3 id="puppet--3">puppet 写法</h3>
<div class="highlight"><pre><code class="ruby">    <span class="k">class</span> <span class="n">squid</span> <span class="p">{</span>
        <span class="kp">include</span> <span class="ss">squid</span><span class="p">:</span><span class="ss">:install</span>
    <span class="p">}</span>
</code></pre></div>
<h3 id="rex--3">rex 写法</h3>
<p>rex 执行的 Rexfile 其实就是 perl 的模块文件，所以写法就是标准的 perl 写法。</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="n">Squid</span> <span class="p">{</span>
        <span class="nb">require</span> <span class="nn">Squid::</span><span class="n">Install</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>呼呼，新版本的 Perl 中可以用 <code>{}</code> 来包裹 package 定义的内容，看起来是不是更像一些？不过 CentOS6 的 5.10 版还不支持，所以通用起见，还是这样写吧：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="n">Squid</span><span class="p">;</span>
    <span class="nb">require</span> <span class="nn">Squid::</span><span class="n">Install</span><span class="p">;</span>
    <span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<h1 id="directory-">Directory 资源</h1>
<h3 id="puppet--4">puppet 写法</h3>
<div class="highlight"><pre><code class="ruby">    <span class="n">file</span> <span class="p">{</span> <span class="s1">&#39;murder-client&#39;</span><span class="p">:</span>
        <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="s1">&#39;directory&#39;</span><span class="p">,</span>
        <span class="n">path</span>    <span class="o">=&gt;</span> <span class="s1">&#39;/usr/local/murder&#39;</span><span class="p">,</span>
        <span class="n">recurse</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
        <span class="n">purge</span>   <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
        <span class="n">source</span>  <span class="o">=&gt;</span> <span class="s1">&#39;puppet:///modules/murder/dist&#39;</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
<h3 id="rex--4">rex 写法</h3>
<p>rex 中采用 rsync 来完成目录文件的同步：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">mkdir</span><span class="p">(</span><span class="s">&#39;/usr/local/murder&#39;</span><span class="p">);</span>
    <span class="n">sync</span> <span class="s">&#39;dist/*&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;/usr/local/murder&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="n">exclude</span>    <span class="o">=&gt;</span> <span class="s">&quot;*.sw*&quot;</span><span class="p">,</span>
        <span class="n">parameters</span> <span class="o">=&gt;</span> <span class="s">&#39;--backup --delete&#39;</span><span class="p">,</span>
    <span class="p">};</span>
</code></pre></div>
<h1 id="shell-">Shell 资源</h1>
<h3 id="puppet--5">puppet 写法</h3>
<div class="highlight"><pre><code class="ruby">    <span class="nb">exec</span> <span class="p">{</span><span class="s1">&#39;init-reload&#39;</span><span class="p">:</span>
        <span class="n">command</span>     <span class="o">=&gt;</span> <span class="s1">&#39;/sbin/initctl reload-configuration &amp;&amp; /sbin/initctl start svscan&#39;</span><span class="p">,</span>
        <span class="n">subscribe</span>   <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/etc/init/svscan.conf&#39;</span><span class="o">]</span><span class="p">,</span>
        <span class="n">refreshonly</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
<h3 id="rex--5">rex 写法</h3>
<div class="highlight"><pre><code class="perl">    <span class="n">run</span> <span class="s">&quot;cmd&quot;</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$err</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="p">};</span>
</code></pre></div>
<p>这个回调函数可以不要，那么 <code>run</code> 命令返回输出到变量。这种用法在单行命令中最常用，比如这样：</p>
<div class="highlight"><pre><code class="bash">    rex -H <span class="s1">&#39;192.168.0.[10..30]&#39;</span> -e <span class="s1">&#39;say run &quot;df -h&quot;&#39;</span>
</code></pre></div>
<h1 id="usergroup-">User/Group 资源</h1>
<h3 id="puppet--6">puppet 写法</h3>
<div class="highlight"><pre><code class="ruby">    <span class="n">group</span> <span class="p">{</span><span class="s1">&#39;puppet&#39;</span><span class="p">:</span>
        <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
        <span class="n">gid</span>    <span class="o">=&gt;</span> <span class="mi">501</span><span class="p">,</span>
        <span class="nb">system</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">user</span> <span class="p">{</span><span class="s1">&#39;puppet&#39;</span><span class="p">:</span>
        <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
        <span class="n">uid</span>    <span class="o">=&gt;</span> <span class="mi">501</span><span class="p">,</span>
        <span class="nb">system</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
        <span class="n">groups</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;puppet&#39;</span><span class="p">,</span> <span class="s1">&#39;...&#39;</span><span class="o">]</span><span class="p">,</span>
        <span class="n">expiry</span> <span class="o">=&gt;</span> <span class="s1">&#39;2013-05-30&#39;</span><span class="p">,</span>
        <span class="n">managehome</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
<h3 id="rex--6">rex 写法</h3>
<div class="highlight"><pre><code class="perl">    <span class="n">create_group</span> <span class="s">&#39;puppet&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="n">gid</span>    <span class="o">=&gt;</span> <span class="mi">501</span><span class="p">,</span>
        <span class="nb">system</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">create_user</span> <span class="s">&#39;puppet&#39;</span><span class="p">,</span>
       <span class="n">uid</span> <span class="o">=&gt;</span> <span class="mi">501</span><span class="p">,</span>
       <span class="n">home</span> <span class="o">=&gt;</span> <span class="s">&#39;/etc/puppet&#39;</span><span class="p">,</span>
       <span class="n">expire</span> <span class="o">=&gt;</span> <span class="s">&#39;2013-05-30&#39;</span><span class="p">,</span>
       <span class="n">groups</span>  <span class="o">=&gt;</span> <span class="p">[</span><span class="s">&#39;puppet&#39;</span><span class="p">,</span> <span class="s">&#39;...&#39;</span><span class="p">],</span>
       <span class="n">password</span> <span class="o">=&gt;</span> <span class="s">&#39;blahblah&#39;</span><span class="p">,</span>
       <span class="nb">system</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
       <span class="n">no_create_home</span> <span class="o">=&gt;</span> <span class="n">TRUE</span><span class="p">,</span>
       <span class="n">ssh_key</span> <span class="o">=&gt;</span> <span class="s">&quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQChUw...&quot;</span><span class="p">;</span>
</code></pre></div>
<h1 id="service-">Service 资源</h1>
<h3 id="puppet--7">puppet 写法</h3>
<div class="highlight"><pre><code class="ruby">    <span class="n">service</span> <span class="p">{</span><span class="s1">&#39;nginx&#39;</span><span class="p">:</span>
        <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
        <span class="n">enable</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
<h3 id="rex--7">rex 写法</h3>
<div class="highlight"><pre><code class="perl">    <span class="n">service</span> <span class="n">apache2</span> <span class="o">=&gt;</span> <span class="n">ensure</span> <span class="o">=&gt;</span> <span class="s">&quot;started&quot;</span><span class="p">;</span>
    <span class="n">service</span> <span class="n">apache2</span> <span class="o">=&gt;</span> <span class="s">&quot;start&quot;</span><span class="p">;</span>
</code></pre></div>
<p>再次可见，rex 认为 <code>service</code> 命令和 <code>chkconfig</code>/<code>update-rc.d</code> 命令是两件事情，所以要分开两个写法。</p>
<h1 id="mount-">Mount 资源</h1>
<h3 id="puppet--8">puppet 写法</h3>
<div class="highlight"><pre><code class="ruby">    <span class="n">mount</span> <span class="p">{</span><span class="s1">&#39;/mnt/sda6&#39;</span><span class="p">:</span>
        <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">present</span><span class="p">;</span>
        <span class="n">device</span>  <span class="o">=&gt;</span> <span class="s1">&#39;/dev/sda6&#39;</span><span class="p">,</span>
        <span class="n">fstype</span>  <span class="o">=&gt;</span> <span class="s1">&#39;ext3&#39;</span><span class="p">,</span>
        <span class="n">options</span> <span class="o">=&gt;</span> <span class="s1">&#39;noatime,async&#39;</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<h3 id="rex--8">rex 写法</h3>
<div class="highlight"><pre><code class="perl">    <span class="n">mount</span> <span class="s">&quot;/dev/sda6&quot;</span><span class="p">,</span> <span class="s">&quot;/mnt/sda6&quot;</span><span class="p">,</span>
       <span class="n">fs</span> <span class="o">=&gt;</span> <span class="s">&quot;ext3&quot;</span><span class="p">,</span>
       <span class="n">options</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw/noatime async/</span><span class="p">];</span>
</code></pre></div>
<h1 id="facts-">Facts 变量和模板</h1>
<h3 id="puppet--9">puppet 写法</h3>
<p>在 puppet 中，Facts 变量有两种用法，一个是 <code>*.pp</code> 里的写法：</p>
<div class="highlight"><pre><code class="ruby">    <span class="vg">$:</span><span class="ss">:lsbdistid</span>
</code></pre></div>
<p>另一种是在 <code>*.erb</code> 里的写法，值得注意的是变量的作用域：</p>
<div class="highlight"><pre><code class="ruby">    <span class="o">&lt;</span><span class="sx">%= scope::lookupvar(&#39;ipaddress&#39;) %&gt;</span>
<span class="sx">    &lt;%=</span> <span class="ss">scope</span><span class="p">:</span><span class="ss">:lookupvar</span><span class="p">(</span><span class="s1">&#39;nginx::name&#39;</span><span class="p">)</span> <span class="o">%&gt;</span>
</code></pre></div>
<h3 id="rex--9">rex 写法</h3>
<p>在 rex 中，远端主机的系统状态有多种获取方式，比如：</p>
<div class="highlight"><pre><code class="perl">    <span class="c1"># 全部，这些变量默认会传递给 template</span>
    <span class="k">my</span> <span class="nv">$sysinfo</span> <span class="o">=</span> <span class="nn">Rex::Helper::System::</span><span class="n">info</span><span class="p">;</span>
    <span class="c1"># 实际就是从上面info里取具体的变量</span>
    <span class="k">my</span> <span class="nv">$lsd</span> <span class="o">=</span> <span class="n">get_operating_system</span><span class="p">;</span>
    <span class="c1"># 这个慎用，会死人的</span>
    <span class="k">my</span> <span class="nv">@ns</span> <span class="o">=</span> <span class="n">netstat</span><span class="p">;</span>
</code></pre></div>
<p>也可以使用 <code>set</code> 指令，这种变量和使用 perl 标准 <code>my $name</code> 方式不同的是它可以直接在模板中读取：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">set</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="s">&#39;CDN&#39;</span><span class="p">;</span>
</code></pre></div>
<p>至于 rex 的模板，它默认没有使用 CPAN 上任何一种现成的模块，而是自己实现了一个，写法如下：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">template</span><span class="p">(</span><span class="s">&#39;your.tpl&#39;</span><span class="p">,</span> <span class="n">yourvars</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">%hash</span> <span class="p">);</span>
</code></pre></div>
<p>然后在模板中这样引用：</p>
<div class="highlight"><pre><code class="perl">    <span class="n">My</span> <span class="n">variable</span> <span class="n">is</span> <span class="o">&lt;</span><span class="nv">%</span><span class="err">=</span> <span class="err">$</span><span class="nv">::yourvars</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">key</span><span class="p">}</span> <span class="nv">%</span><span class="err">&gt;</span>
    <span class="nv">My</span> <span class="n">name</span> <span class="n">is</span> <span class="o">&lt;</span><span class="nv">%</span><span class="err">=</span> <span class="err">$</span><span class="nv">::name</span> <span class="nv">%</span><span class="err">&gt;</span>
    <span class="nv">My</span> <span class="n">lsd</span> <span class="n">is</span> <span class="o">&lt;</span><span class="nv">%</span><span class="err">=</span> <span class="err">$</span><span class="nv">::operatingsystem</span> <span class="nv">%</span><span class="err">&gt;</span>
</code></pre></div>
<p>明显有模仿 puppet 的痕迹，传递进模版的变量以 <code>$::</code> 开头，个人比较汗……</p>
<p>所以个人建议还是更换成 CPAN 上的流行模板，比如 <code>Text::Xslate</code> 或者 <code>Text::MicroTemplate</code> 等等，使用 <code>set_template_option</code> 即可。</p>
      <a href="/2013/05/28/compare-dsl-of-puppet-with-rex" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/05/27/use-rex-box-replace-vagrant" title="使用 Rex::Box 代替 Vagrant 的工作" rel="bookmark">使用 Rex::Box 代替 Vagrant 的工作</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-05-27 00:00:00 +0800">27 May 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Vagrant 是近来 devops 界内非常流行和火爆的工具，它和 puppet/chef 的结合，成为运维开发和测试，甚至预热部署的重要手段。比如在 cloudfoundry 官方放弃使用 <code>vcap_setup</code> 脚本部署后，社区大多对其 <code>BOSH</code> 不买账，转而研究使用 vagrant 部署了。</p>
<p>对于 perl 运维人员，使用 Rex 工具做集群管理的话，其实完全不用再使用 vagrant 了。因为 Rex 自带有 Box 功能。完全可以一体化工作。下面从 Rex 官网上半翻译半截取两篇文章，展示 Rex::Box 的使用。两篇原文分别是：</p>
<ol>
  <li><a href="http://box.rexify.org/guide">http://box.rexify.org/guide</a></li>
  <li><a href="http://www.rexify.org/howtos/use_boxes_with_any_box_provider.html">http://www.rexify.org/howtos/use_boxes_with_any_box_provider.html</a></li>
</ol>
<h1 id="section">环境准备</h1>
<div class="highlight"><pre><code class="bash">rexify <span class="nv">$project</span>-name --template box
<span class="nb">cd</span> <span class="nv">$project</span>-name
rex init --name<span class="o">=</span><span class="nv">$vm</span>-name --url<span class="o">=</span><span class="nv">$url</span>-to-prebuild-vm-image
</code></pre></div>
<h1 id="section-1">虚拟机定义</h1>
<p>这里有两种方式，一种是类似 Vagrantfile 定义的 Rexfile 写法：</p>
<div class="highlight"><pre><code class="perl"><span class="n">set</span> <span class="n">box</span> <span class="o">=&gt;</span> <span class="s">&quot;VBox&quot;</span><span class="p">;</span>
<span class="n">task</span> <span class="n">mytask</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
   <span class="n">box</span> <span class="p">{</span>
      <span class="k">my</span> <span class="p">(</span><span class="nv">$box</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
      <span class="nv">$box</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">(</span><span class="s">&quot;boxname&quot;</span><span class="p">);</span>
      <span class="nv">$box</span><span class="o">-&gt;</span><span class="n">url</span><span class="p">(</span><span class="s">&quot;http://box.rexify.org/box/base-image.box&quot;</span><span class="p">);</span>
      <span class="nv">$box</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">(</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="n">type</span> <span class="o">=&gt;</span> <span class="s">&quot;bridged&quot;</span>      <span class="c1"># 默认是 &quot;nat&quot;,</span>
        <span class="n">bridge</span> <span class="o">=&gt;</span> <span class="s">&quot;eth0&quot;</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="nv">$box</span><span class="o">-&gt;</span><span class="n">forward_port</span><span class="p">(</span><span class="n">ssh</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">2222</span><span class="p">,</span> <span class="mi">22</span><span class="p">]);</span>
      <span class="nv">$box</span><span class="o">-&gt;</span><span class="n">share_folder</span><span class="p">(</span><span class="n">boxhome</span> <span class="o">=&gt;</span> <span class="s">&quot;/path/to/myuser&quot;</span><span class="p">);</span>
      <span class="nv">$box</span><span class="o">-&gt;</span><span class="n">auth</span><span class="p">(</span>
        <span class="n">user</span> <span class="o">=&gt;</span> <span class="s">&quot;root&quot;</span><span class="p">,</span>
        <span class="n">password</span> <span class="o">=&gt;</span> <span class="s">&quot;box&quot;</span><span class="p">,</span>
      <span class="p">);</span>
      <span class="nv">$box</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="sx">qw/setup_frontend/</span><span class="p">);</span>
   <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>另一种是采用 YAML 配置：</p>
<div class="highlight"><pre><code class="yaml"><span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">VBox</span>
<span class="l-Scalar-Plain">vms</span><span class="p-Indicator">:</span>
   <span class="l-Scalar-Plain">fe01</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://box.rexify.org/box/ubuntu-server-12.10-amd64.ova</span>
      <span class="l-Scalar-Plain">network</span><span class="p-Indicator">:</span>
         <span class="l-Scalar-Plain">1</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bridged</span>
            <span class="l-Scalar-Plain">bridge</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">eth0</span>
      <span class="l-Scalar-Plain">setup</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">setup_frontend</span>
   <span class="l-Scalar-Plain">db01</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://box.rexify.org/box/ubuntu-server-12.10-amd64.ova</span>
      <span class="l-Scalar-Plain">network</span><span class="p-Indicator">:</span>
         <span class="l-Scalar-Plain">1</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bridged</span>
            <span class="l-Scalar-Plain">bridge</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">eth0</span>
      <span class="l-Scalar-Plain">setup</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">setup_db</span>
</code></pre></div>
<h1 id="section-2">虚拟机初始化</h1>
<p>在 Vagrant 中有一个概念叫 provision，也就是在虚拟机第一次运行时，通过 shell/puppet/chef 等进行初始化操作。Rex::Box 自然是通过 Rex 本身来进行这个任务。也就是上例中的 <code>setup</code> 定义的 task 名称。</p>
<div class="highlight"><pre><code class="perl"><span class="n">task</span> <span class="s">&#39;setup_frontend&#39;</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">install</span> <span class="n">nginx</span><span class="p">;</span>
    <span class="n">file</span> <span class="s">&#39;/etc/nginx.conf&#39;</span><span class="p">,</span>
        <span class="n">content</span>   <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="s">&#39;template/httpd.conf.tpl&#39;</span><span class="p">),</span>
        <span class="n">owner</span>     <span class="o">=&gt;</span> <span class="s">&quot;root&quot;</span><span class="p">,</span>
        <span class="n">group</span>     <span class="o">=&gt;</span> <span class="s">&quot;root&quot;</span><span class="p">,</span>
        <span class="n">on_change</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="n">service</span> <span class="n">nginx</span> <span class="o">=&gt;</span> <span class="s">&quot;restart&quot;</span><span class="p">;</span> <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>因为 rex 本身是通过 ssh 管理，所以在 setup 之前，必须定义好如何 auth，自己做的镜像不说了，通过 rexify.org 下载的默认镜像，就是默认的 root/box 了。</p>
<p>说到镜像，其实 vagrant 的 <code>.box</code> 也就是 <code>.ova</code> ，都是把 virtualbox 的 <code>.vmdk</code> 和 <code>.ovf</code> 打了个包而已。</p>
<p>当然，也可以在 task 写 shell，通过 <code>run</code> 的方式，其实 run 应该也是 Rex 最常用的 task 了。</p>
<div class="highlight"><pre><code class="perl"><span class="n">task</span> <span class="s">&#39;setup_frontend&#39;</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">run</span> <span class="s">&quot;echo Hello, world&quot;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h1 id="section-3">虚拟机使用</h1>
<p>定义完成后，就可以使用 init 配置虚拟机环境，然后 start/stop 管理虚拟机。</p>
<p>比如在使用 YAML 配置的时候，配置环境的 Rexfile 最后是这样的：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Rex::Commands::</span><span class="n">Box</span> <span class="n">init_file</span> <span class="o">=&gt;</span> <span class="s">&quot;box.yml&quot;</span><span class="p">;</span>
<span class="n">group</span> <span class="n">myboxes</span> <span class="o">=&gt;</span> <span class="nb">map</span> <span class="p">{</span> <span class="n">get_box</span><span class="p">(</span><span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">name</span><span class="p">})</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ip</span><span class="p">}</span> <span class="p">}</span> <span class="n">list_boxes</span><span class="p">;</span>
<span class="n">task</span> <span class="s">&quot;box&quot;</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
   <span class="n">boxes</span> <span class="s">&quot;init&quot;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>像要做成命令行管理也比较简单，比如启动和停止虚拟机的 task 这样写：</p>
<div class="highlight"><pre><code class="perl"><span class="n">task</span> <span class="s">&quot;stop&quot;</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$param</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="n">boxes</span> <span class="n">stop</span> <span class="o">=&gt;</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">name</span><span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>就可以在命令行直接这样启动某个虚拟机了：</p>
<div class="highlight"><pre><code class="bash">rex stop --name<span class="o">=</span>myvbox
</code></pre></div>
<p>事实上，本文最开头的默认 box 模板生成的命令，就是通过前一步生成的 Rexfile 里定义的 <code>task "init", sub {...};</code> 实现的。</p>
<p><strong>2013 年 07 月 23 日附注：</strong></p>
<p>虽然如此，但是 Vagrant 目前已经成为开源社区风头正劲的一个产品，其开放的 plugin 机制导致周边产品大量出现，已经形成了一个不错的社区氛围。还是建议大家了解 Vagrant 。目前 vagrant-plugin 列表见：<a href="https://github.com/mitchellh/vagrant/wiki/Available-Vagrant-Plugins">https://github.com/mitchellh/vagrant/wiki/Available-Vagrant-Plugins</a>。</p>
      <a href="/2013/05/27/use-rex-box-replace-vagrant" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/05/14/mojo-and-gocr-for-buildhr-telephone" title="用mojo抓取数据并gocr替换图片内容" rel="bookmark">用mojo抓取数据并gocr替换图片内容</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-05-14 00:00:00 +0800">14 May 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>现在的网站越来越狡猾，连招聘网站的信息都懂的把公司的联系方式动态图片化了。还好为了观看方便，没加什么干扰。所以写个脚本来识别还是可以的。虽然到目前为止没发现比较好的 OCR 工具——我指的是可以直接apt-get安装的，有朋友知道哪个比较好的话，欢迎告诉我~</p>
<p>尝试了一下 tesseract-ocr 和 gocr ，还是 gocr 靠谱一点点。所以 <code>apt-get install gocr</code> 安装然后运行下面这个 Perl 脚本：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">ojo</span><span class="p">;</span>
<span class="k">use</span> <span class="mf">5.010</span><span class="p">;</span>
<span class="n">g</span><span class="p">(</span><span class="s">&quot;http://search.buildhr.com/job/581968.html&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dom</span><span class="o">-&gt;</span><span class="n">charset</span><span class="p">(</span><span class="s">&quot;UTF-8&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;div .postjob .padding&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;p&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">each</span><span class="p">(</span><span class="n">sub</span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$img_element</span> <span class="o">=</span> <span class="nv">$line</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="s">&#39;img&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$img_element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$img_url</span> <span class="o">=</span> <span class="nv">$img_element</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">src</span><span class="p">};</span>
        <span class="n">g</span><span class="p">(</span><span class="nv">$img_url</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">content</span><span class="o">-&gt;</span><span class="n">asset</span><span class="o">-&gt;</span><span class="n">move_to</span><span class="p">(</span><span class="s">&quot;test.jpg&quot;</span><span class="p">);</span>
        <span class="k">my</span> <span class="nv">$seem_str</span> <span class="o">=</span> <span class="sb">`gocr test.jpg`</span><span class="p">;</span>
        <span class="nb">chomp</span><span class="p">(</span><span class="nv">$seem_str</span><span class="p">);</span>
        <span class="n">say</span> <span class="nb">join</span><span class="p">(</span><span class="nv">$seem_str</span><span class="p">,</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/ /</span><span class="p">,</span> <span class="nv">$line</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
<p>不过老是把 <code>7</code> 识别成 <code>_</code>。</p>
<p>真是越来越觉得 ojo 好用啊~</p>
      <a href="/2013/05/14/mojo-and-gocr-for-buildhr-telephone" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/04/19/something-dive-to-perl" title="Newbie::Gift 所用知识总结" rel="bookmark">Newbie::Gift 所用知识总结</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-04-19 00:00:00 +0800">19 Apr 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>通过 <a href="https://github.com/chenryn/Newbie-Gift">Newbie::Gift</a> 项目的开发过程，学习和深入了解了不少 Perl 知识，虽然这个模块估计短期内不会再继续开发和更新了，不过还是值得记录一下这段过程中的心得。</p>
<h3 id="gensym">gensym</h3>
<p>封装 <code>IPC::Open3</code> 模块时，通过 <code>smokeping</code> 代码中学到了 <code>Symbol</code> 模块的 <code>gensym</code> 指令的使用。</p>
<p>通过 <code>gensym</code> 指令可以直接返回一个临时文件句柄来使用。</p>
<h3 id="cb-">$cb-&gt;()</h3>
<p>在 SPEC 设计中，所有导出指令都采用回调的方式。在 Perl 中实现起来其实特别简单。像下面这样就好了：</p>
<div class="highlight"><pre><code class="perl"><span class="k">sub </span><span class="nf">keyword</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$str</span><span class="p">,</span> <span class="nv">$cb</span> <span class="p">)</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="n">do_some_func</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
    <span class="nv">$cb</span><span class="o">-&gt;</span><span class="p">(</span><span class="nv">$res</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="selectortoxpath">selector_to_xpath</h3>
<p>之前一直有使用 <code>Mojo::UserAgent</code> 配合 <code>Mojo::DOM</code> 完成网页抓取工作，这次自己实践，参考的是另一个 <a href="https://metacpan.org/module/Web::Query">Web::Query</a> 模块。其中最关键的两步，第一是通过 <a href="https://metacpan.org/module/HTML::Selector::XPath">selector_to_xpath</a> 指令把选择器的写法转换成 XPath 语言；第二是通过 XPath 操作网页的 <a href="https://metacpan.org/module/HTML::TreeBuilder::XPath">HTML::Tree</a>。</p>
<p>不过 <code>Mojo</code> 里对象化的很完整，返回的数组和字符串都是对象，所以可以一直反复调用方法连接起来处理，写的会很爽。用 <code>Web::Query</code> 没有这个效果。</p>
<h3 id="filestat">File::stat</h3>
<p>stat 是 perl 默认的函数，不过返回的数组在 mode 和 time 方面可读性都不好，所以封装一下，提供更加可读的 0644 这样的 mode 格式，直接用 <code>sprintf</code> 就可以做到：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">sprintf</span><span class="p">(</span> <span class="s">&quot;%04o&quot;</span><span class="p">,</span> <span class="nv">$ret</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mo">07777</span> <span class="p">);</span>
</code></pre></div>
<h3 id="datetime">DateTime</h3>
<p>Perl 的 <a href="https://metacpan.org/module/DateTime">DateTime</a> 模块太重，CPAN 上其实也有很多人提交简化版的 DT，其实就是利用 <code>localtime</code>，<code>strftime</code> 和 <code>mktime</code> 几个默认函数做出来的对象调用。</p>
<h3 id="exporter">Exporter</h3>
<p><code>import</code> 和 <code>export_to_level</code> 都是 <code>Exporter</code> 模块的方法，所有继承自 <code>Exporter</code> 的模块可以用。比如下面示例，启用该模块，就相当于启用了 <code>strict</code>，<code>warnings</code>，<code>utf8</code> 和 Perl5.10 版的新特性，同时导出了 keywords 关键字。</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">base</span> <span class="s">&#39;Exporter&#39;</span><span class="p">;</span>
    <span class="k">our</span> <span class="nv">@EXPORT</span> <span class="o">=</span> <span class="sx">qw/keywords/</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">keywords</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
    <span class="k">sub </span><span class="nf">import</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$class</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
        <span class="n">strict</span><span class="o">-&gt;</span><span class="nb">import</span><span class="p">;</span>
        <span class="n">warnings</span><span class="o">-&gt;</span><span class="nb">import</span><span class="p">;</span>
        <span class="n">utf8</span><span class="o">-&gt;</span><span class="nb">import</span><span class="p">;</span>
        <span class="n">feature</span><span class="o">-&gt;</span><span class="nb">import</span><span class="p">(</span><span class="s">&#39;:5.10&#39;</span><span class="p">);</span>
        <span class="nn">Try::</span><span class="n">Tiny</span><span class="o">-&gt;</span><span class="nb">import</span><span class="p">;</span>
        <span class="nv">$class</span><span class="o">-&gt;</span><span class="n">export_to_level</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$class</span><span class="p">,</span> <span class="nv">@EXPORT</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<h3 id="zip">zip</h3>
<p>多数组可以通过 <code>zip</code> 命令逐一对位融合到一起。这个在 <a href="https://metacpan.org/module/List::MoreUtils">List::MoreUtils</a> 中有，这次用 <code>NG::Array</code> 对象实现了一边，其原理是先记录每个数组的长度，然后以最长的那个数组为标杆，循环一遍即可。</p>
<h3 id="autobox">autobox</h3>
<p>CPAN 上 Rubyish、Perl6::<em>、Perl5i::</em> 等模块都利用了 <a href="https://metacpan.org/module/autobox">autobox</a> 实现完全的对象化。autobox 是一个库，本身不提供对象方法，而是要自己自己实现针对某个类型的对象方法后，通过 autobox 关联到 Perl 的数据类型上去。</p>
<p>比如想要实现一个 <code>"Hello World"-&gt;lc-&gt;words</code> 的语法，显然就是要针对 Perl 中的 STRING 数据类型实现 lc 和 words 两个方法。那么先实现一个自己的 string 对象：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="nn">your::</span><span class="n">string</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">lc</span>    <span class="p">{</span> <span class="nn">CORE::</span><span class="n">lc</span>           <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">}</span>
    <span class="k">sub </span><span class="nf">words</span> <span class="p">{</span> <span class="nn">CORE::</span><span class="n">split</span> <span class="sr">/\s+/</span><span class="p">,</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">}</span>
    <span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>然后开始关联：</p>
<div class="highlight"><pre><code class="perl">    <span class="nb">package</span> <span class="nn">your::</span><span class="n">autobox</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">base</span> <span class="sx">qw(autobox)</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">your::</span><span class="n">string</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">import</span> <span class="p">{</span>
        <span class="nb">shift</span><span class="o">-&gt;</span><span class="nn">SUPER::</span><span class="n">import</span><span class="p">(</span>
            <span class="n">STRING</span> <span class="o">=&gt;</span> <span class="s">&#39;your::string&#39;</span><span class="p">,</span>
            <span class="nv">@_</span>
        <span class="p">);</span>
    <span class="p">}</span>
    <span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>最后在前面提到过的 <code>Exporter</code> 的 <code>import</code> 函数里加上一行：</p>
<div class="highlight"><pre><code class="perl">    <span class="nn">your::</span><span class="n">autobox</span><span class="o">-&gt;</span><span class="nb">import</span><span class="p">;</span>
</code></pre></div>
<p>autobox 可以关联的数据类型还有很多，绝对是值得一看的模块。</p>
<h3 id="evalclassnew">eval(&lsquo;*&rsquo;.$class.&rsquo;::new&rsquo;)</h3>
<p>实现 <code>def_class</code> 关键词的过程中学习颇多，首先是符号表。实现中完成模块代码几乎全靠符号表来绑定一个个函数和变量。像这样：</p>
<div class="highlight"><pre><code class="perl">    <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="o">.</span><span class="nv">$class</span><span class="o">.</span><span class="s">&#39;::ISA&#39;</span><span class="p">);</span>
    <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="nv">$parent</span><span class="p">];</span>
    <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="o">.</span><span class="nv">$class</span><span class="o">.</span><span class="s">&#39;::new&#39;</span><span class="p">);</span>
    <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">@args</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="nb">push</span> <span class="nv">@args</span><span class="p">,</span> <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="nv">$#args</span> <span class="nv">%</span> <span class="nv">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$o</span> <span class="o">=</span> <span class="nb">bless</span> <span class="p">{</span><span class="nv">@args</span><span class="p">},</span> <span class="nb">ref</span> <span class="nv">$class</span> <span class="o">||</span> <span class="nv">$class</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">defined</span> <span class="nv">$methods</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">build</span><span class="p">}){</span>
            <span class="nv">$o</span><span class="o">-&gt;</span><span class="n">build</span><span class="p">(</span><span class="nv">@args</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$o</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>不过这个实现有个问题，就是对象只能是基于哈希的引用，不能是数组的了。</p>
<h3 id="section">对象的元数据</h3>
<p>实现 <code>def_class</code> 的时候比 spec 多新增了一个默认属性叫meta，所有用 <code>def_class</code> 实现的类，会自动记录他们(包括他们的用 <code>def_class</code> 实现的父类)的属性和方法到meta属性里。</p>
<p>为此阅读了一下 <code>Moo</code> 和 <code>Moos</code> 的代码。
<strong>原来他们都是把属性和方法也实现为类。然后再有 <code>*::Meta</code> 类来记录这些属性和方法的类。</strong></p>
<p>而 <code>Newbie::Gift</code> 计划中没打算把对象化搞得这么彻底，所以就只是存了一个 hash 到 默认 meta 属性里。</p>
<h3 id="lvalue">:lvalue</h3>
<p>对象除了方法还要有属性，<code>def_class</code> 里也有实现，同样是用符号表绑定的。</p>
<p>不过这里用到了 Perl5.10 的一个新东西，函数属性，这里绑定的不是普通变量而是函数，但是函数只会读写一个变量值，具体的说就是使用 <code>sub :lvalue {}</code> 定义。使用方法如下所示：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$val</span><span class="p">;</span>
    <span class="k">sub </span><span class="nf">canmod</span> <span class="p">:lvalue {</span>
        <span class="c1"># return $val; this doesn&#39;t work, don&#39;t say &quot;return&quot;</span>
        <span class="nv">$val</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">sub </span><span class="nf">nomod</span> <span class="p">{</span>
        <span class="nv">$val</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">canmod</span><span class="p">()</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>   <span class="c1"># assigns to $val</span>
    <span class="n">nomod</span><span class="p">()</span>  <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>   <span class="c1"># ERROR</span>
</code></pre></div>
<p>lvalue 的说明见 <code>perldoc perlsub</code> 文档。在这里还是个比较有趣的用法的，这个用法来自 <code>Newbie::Gift</code> 项目另一位参与者 <a href="https://github.com/fmpdceudy">fmpdceudy</a>。</p>
      <a href="/2013/04/19/something-dive-to-perl" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/04/16/install-foreman" title="使用 Foreman 来监控统计 puppet 的 reports 信息" rel="bookmark">使用 Foreman 来监控统计 puppet 的 reports 信息</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-04-16 00:00:00 +0800">16 Apr 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>foreman 是社区比较推荐的一款 puppet 辅助工具。可以用来实现 ENC 控制，class 编写，Facts 变量统计和 reports 分析查询等等。</p>
<p>鉴于我一直以来都是用 gem 安装 puppet，所以这里也就没法通过 yum/apt 来安装 foreman，只能源码操作了：</p>
<div class="highlight"><pre><code class="bash">    git clone https://github.com/theforeman/foreman.git -b develop
    <span class="nb">cd </span>foreman
    bundle install --without postgresql mysql mysql2 
    cp config/settings.yaml.example config/settings.yaml
    cp config/database.yml.example config/database.yml
    <span class="nv">RAILS_ENV</span><span class="o">=</span>production bundle <span class="nb">exec </span>rake db:migrate
    rake puppet:import:hosts_and_facts <span class="nv">RAILS_ENV</span><span class="o">=</span>production
    ./script/rails server -p 3333 -e production -d
</code></pre></div>
<p>然后就可以通过3333端口访问并查看刚才导入的 Facts 变量了，默认的用户名密码是 admin/changeme。</p>
<p>新版本的 foreman，必须使用 smart-proxy 才能接收 reports。所以还要继续安装：</p>
<div class="highlight"><pre><code class="bash">    git clone git://github.com/theforeman/smart-proxy.git
    <span class="nb">cd </span>smart-proxy
    sed -i <span class="s1">&#39;s/^#:puppet:.*/:puppet: true/&#39;</span> config/settings.yml
    ./bin/smart-proxy.rb
</code></pre></div>
<p>foreman 提供了一个 <a href="https://raw.github.com/theforeman/puppet-foreman/master/templates/foreman-report.rb.erb">ruby 脚本</a>，用来扩充 puppet 的 reports 功能。下载放到对应的 <code>${GEM_PATH}/gems/puppet-${version}/lib/puppet/reports/</code> 下，然后修改其中的 <code>$foreman_url</code> 变量即可。</p>
<p>我们也可以在 puppet 自带的 http.rb 基础上稍微修改得到相同效果，总的来说，就是通过 POST 方法，提交 <code>report =&gt; self.to_yaml</code> 到 <code>$foreman_url/reports/create?format=yml</code> 就可以了。</p>
<p>然后在 foreman 页面上配置 smart-proxy 地址。注意这里有个小坑：__如果你填写的是域名，那么解析出来的 ip 还要被反解验证一次。__我当初为了 puppet master 迁移方便，给 master 配置了一个单独的域名，包括 <code>puppet cert</code> 生成证书时也特意指定用这个域名，但是默认的 hostname 其实是另一个域名的。于是在此悲剧了很久。。。</p>
<p>错误的现象是：采用 <code>puppet master</code> 启动时，功能一切正常；采用 <code>rackup</code> + Nginx 代理的方式启动时，默认的 store 功能正常，而采用 foreman 接收 reports 的话，可以在 <code>rackup</code> 的访问日志中看到 POST 200 的记录，<code>foreman</code> 里却没有接到请求。</p>
<p>目前还不清楚为什么两种不同方式启动 puppet 的 master 会对 smart-proxy 造成什么区别影响，但是修改 foreman 里配置的 smart-proxy 地址为默认 hostname 而不是单独的域名后，就成功了。</p>
<p>另外一个使用上的小问题。foreman 页面上的 Reports 标签的 <code>&lt;a href=""&gt;</code> 属性默认是带搜索参数 eventful 的。也就是说优先展示的是有事件发生的日志，比如 failed，restart 等等；而不是直接以日期排序。</p>
      <a href="/2013/04/16/install-foreman" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/04/03/install-graphite" title="Graphite 安装" rel="bookmark">Graphite 安装</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-04-03 00:00:00 +0800">03 Apr 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Graphite 是近来比较流行的类 rrd tool 系统。不过官网的安装文档真的很烂，特记录一下自己的步骤。</p>
<p>由于是事后追忆，同样不保证好用……</p>
<div class="highlight"><pre><code class="bash">apt-get install python-pip libapache2-mod-wsgi subversion git
git clone https://github.com/graphite-project/graphite-web.git
git clone https://github.com/graphite-project/carbon.git
git clone https://github.com/graphite-project/whisper.git
<span class="c"># 这两个是直接通过 pip 安装的不顶用，只能另外下非标准的包安装</span>
git clone https://github.com/graphite-project/ceres.git
svn checkout http://django-tagging.googlecode.com/svn/trunk/ tagging-trunk
<span class="nb">cd </span>whisper
sudo python setup.py install
<span class="nb">cd</span> ../carbon
python setup.py install 
<span class="nb">cd</span> ../graphite-web
python check-dependencies.py
<span class="c"># 很奇怪 python 居然不自动解决依赖，check 出来一个列表还得自己来</span>
apt-get install python-memcache python-txamqp python-rrdtool python-pyparsing python-django
python setup.py install
<span class="nb">cd</span> ../ceres
python setup.py install
<span class="nb">cd</span> ../tagging-trunk
python setup.py install
groupadd graphite
ln -s /opt/graphite/examples/example-graphite-vhost.conf /etc/apache2/conf.d/graphite.conf
<span class="c"># 默认的 run/wsgi 会在 /etc/apache2/ 目录下，权限有问题</span>
sed -i <span class="s1">&#39;s!^\(WSGISocketPrefix\) \(run/wsgi\)$!\1 /var/\2$!&#39;</span> /etc/apache2/conf.d/graphite.conf
chown -R www-data:graphite /opt/graphite/storage/
service apache2 restart
<span class="nb">cd</span> /opt/graphite/webapp/graphite
cp local_settings.py.example local_settings.py
<span class="c"># 默认的 database 配置是针对 python2.4 的，需要开启针对 python2.5 以上版本的配置:</span>
<span class="c"># DATABASES = {</span>
<span class="c">#     &#39;default&#39;: {</span>
<span class="c">#         &#39;NAME&#39;: &#39;/opt/graphite/storage/graphite.db&#39;,</span>
<span class="c">#         &#39;ENGINE&#39;: &#39;django.db.backends.sqlite3&#39;,</span>
<span class="c">#         &#39;USER&#39;: &#39;&#39;,</span>
<span class="c">#         &#39;PASSWORD&#39;: &#39;&#39;,</span>
<span class="c">#         &#39;HOST&#39;: &#39;&#39;,</span>
<span class="c">#         &#39;PORT&#39;: &#39;&#39;</span>
<span class="c">#     }</span>
<span class="c"># }</span>
sed -i <span class="s1">&#39;167,176s/^#//&#39;</span> local_settings.py
python manage.py syncdb
<span class="nb">cd</span> /opt/graphite/conf
rename <span class="s1">&#39;s/.example//&#39;</span> *.example
<span class="nb">cd</span> /opt/graphite/
<span class="c"># 会监听 2003 端口</span>
./bin/carbon-cache.py start
<span class="c"># 通过 socket 发送本机的 loadavg 到 2003 端口</span>
python /opt/graphite/examples/example-client.py
</code></pre></div>
<p>效果如下：</p>
<p><img src="/images/uploads/graphite-auto-refresh.png" alt="graphite" /></p>
<p>还可以点击 plot 成下面这样，并且添加 event 以供查看：</p>
<p><img src="/images/uploads/graphite-graphlot.png" alt="graphlot" /></p>
      <a href="/2013/04/03/install-graphite" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page active">
      <a href="#">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li class="page">
      <a href="/page17">17</a>
    </li>
    <li>
      <a href="/page3">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
              <li><a href="http://showmetheco.de/" title="Viacheslav Tykhanovskyi(PocketIO/Text::Haml)">No time to wait</a></li>
              <li><a href="http://blog.dataloop.io/" title="A new SaaS monitoring tool for DevOps & Operations">Dataloop.IO</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://planeteria.org/perl6/" title="Perl6 文集">Planet Perl 6</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://junqili.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.sectop.org/" title="">kindle</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
          </ul>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
