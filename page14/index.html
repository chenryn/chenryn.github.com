<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/19/sysctl-about-tcp" title="系统优化——TCP参数" rel="bookmark">系统优化——TCP参数</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-19 00:00:00 +0800">19 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>tcp_syn_retries ：INTEGER
默认值是5
对于一个新建连接，内核要发送多少个 SYN 连接请求才决定放弃。不应该大于255，默认值是5，对应于180秒左右时间。(对于大负载而物理通信良好的网络而言,这个值偏高,可修改为2.这个值仅仅是针对对外的连接,对进来的连接,是由tcp_retries1决定的)</p>
<p>tcp_synack_retries ：INTEGER
默认值是5
对于远端的连接请求SYN，内核会发送SYN ＋ ACK数据报，以确认收到上一个 SYN连接请求包。这是所谓的三次握手(threeway handshake)机制的第二个步骤。这里决定内核在放弃连接之前所送出的 SYN+ACK数目。不应该大于255，默认值是5 ，对应于180秒左右时间。(可以根据上面的 tcp_syn_retries来决定这个值)</p>
<p>tcp_keepalive_time ：INTEGER
默认值是7200(2小时)
当keepalive打开的情况下，TCP发送keepalive消息的频率。(由于目前网络攻击等因素,造成了利用这个进行的攻击很频繁,曾经也有cu的朋友提到过,说如果2边建立了连接,然后不发送任何数据或者rst/fin消息,那么持续的时间是不是就是2小时,空连接攻击?tcp_keepalive_time就是预防此情形的.我个人在做nat服务的时候的修改值为 1800 秒)</p>
<p>tcp_keepalive_probes： INTEGER
默认值是9
TCP发送keepalive探测以确定该连接已经断开的次数。(注意:保持连接仅在SO_KEEPALIVE套接字选项被打开是才发送.次数默认不需要修改,当然根据情形也可以适当地缩短此值.设置为5比较合适)</p>
<p>tcp_keepalive_intvl ：INTEGER
默认值为75
探测消息发送的频率，乘以tcp_keepalive_probes就得到对于从开始探测以来没有响应的连接杀除的时间。默认值为75秒，也就是没有活动的连接将在大约11分钟以后将被丢弃。(对于普通应用来说,这个值有一些偏大,可以根据需要改小.特别是web类服务器需要改小该值,15是个比较合适的值)</p>
<p>tcp_retries1 ：INTEGER
默认值是3
放弃回应一个TCP连接请求前﹐需要进行多少次重试。RFC 规定最低的数值是3 ﹐这也是默认值﹐根据RTO的值大约在3秒 - 8分钟之间。(注意:这个值同时还决定进入的syn连接)
tcp_retries2 ：INTEGER
默认值为15
在丢弃激活(已建立通讯状况)的TCP连接之前﹐需要进行多少次重试。默认值为15
，根据RTO的值来决定，相当于13-30分钟(RFC1122规定，必须大于100秒).(这个值根据目前的网络设置,可以适当地改小,我的网络内修改为了5)
tcp_orphan_retries ：INTEGER
默认值是7
在近端丢弃TCP连接之前﹐要进行多少次重试。默认值是7
个﹐相当于 50秒 - 16分钟﹐视 RTO 而定。如果您的系统是负载很大的web服务器﹐那么也许需要降低该值﹐这类 sockets
可能会耗费大量的资源。另外参的考 tcp_max_orphans 。(事实上做NAT的时候,降低该值也是好处显著的,我本人的网络环境中降低该值为3)
tcp_fin_timeout ：INTEGER
默认值是 60
对于本端断开的socket连接，TCP保持在FIN-WAIT-2状态的时间。对方可能会断开连接或一直不结束连接或不可预料的进程死亡。默认值为
60 秒。过去在2.2版本的内核中是 180
秒。您可以设置该值﹐但需要注意﹐如果您的机器为负载很重的web服务器﹐您可能要冒内存被大量无效数据报填满的风险﹐FIN-WAIT-2
sockets 的危险性低于 FIN-WAIT-1 ﹐因为它们最多只吃 1.5K 的内存﹐但是它们存在时间更长。另外参考
tcp_max_orphans 。(事实上做NAT的时候,降低该值也是好处显著的,我本人的网络环境中降低该值为30)
tcp_max_tw_buckets ：INTEGER
默认值是180000
系统在同时所处理的最大 timewait sockets
数目。如果超过此数的话﹐time-wait socket 会被立即砍除并且显示警告信息。之所以要设定这个限制﹐纯粹为了抵御那些简单的
DoS
攻击﹐千万不要人为的降低这个限制﹐不过﹐如果网络条件需要比默认值更多﹐则可以提高它(或许还要增加内存)。(事实上做NAT的时候最好可以适当地增加该值)
tcp_tw_recycle ：BOOLEAN
默认值是0
打开快速
TIME-WAIT sockets 回收。除非得到技术专家的建议或要求﹐请不要随意修改这个值。(做NAT的时候，建议打开它)
tcp_tw_reuse ：BOOLEAN
默认值是0
该文件表示是否允许重新应用处于TIME-WAIT状态的socket用于新的TCP连接(这个对快速重启动某些服务,而启动后提示端口已经被使用的情形非常有帮助)
tcp_max_orphans ：INTEGER
缺省值是8192
系统所能处理不属于任何进程的TCP
sockets最大数量。假如超过这个数量﹐那么不属于任何进程的连接会被立即reset，并同时显示警告信息。之所以要设定这个限制﹐纯粹为了抵御那些简单的
DoS 攻击﹐千万不要依赖这个或是人为的降低这个限制(这个值Redhat
AS版本中设置为 32768
,但是很多防火墙修改的时候,建议该值修改为
2000 )
tcp_abort_on_overflow ：BOOLEAN
缺省值是0
当守护进程太忙而不能接受新的连接，就象对方发送reset消息，默认值是false。这意味着当溢出的原因是因为一个偶然的猝发，那么连接将恢复状态。只有在你确信守护进程真的不能完成连接请求时才打开该选项，该选项会影响客户的使用。(对待已经满载的sendmail,apache这类服务的时候,这个可以很快让客户端终止连接,可以给予服务程序处理已有连接的缓冲机会,所以很多防火墙上推荐打开它)
tcp_syncookies ：BOOLEAN
默认值是 0
只有在内核编译时选择了CONFIG_SYNCOOKIES时才会发生作用。当出现syn等候队列出现溢出时象对方发送syncookies。目的是为了防止syn
flood攻击。
注意：该选项千万不能用于那些没有收到攻击的高负载服务器，如果在日志中出现synflood消息，但是调查发现没有收到synflood攻击，而是合法用户的连接负载过高的原因，你应该调整其它参数来提高服务器性能。参考:
tcp_max_syn_backlog
tcp_synack_retries
tcp_abort_on_overflow
syncookie严重的违背TCP协议，不允许使用TCP扩展，可能对某些服务导致严重的性能影响(如SMTP转发)。(注意,该实现与BSD上面使用的tcp
proxy一样,是违反了RFC中关于tcp连接的三次握手实现的,但是对于防御syn-flood的确很有用.)
tcp_stdurg ：BOOLEAN
默认值为0
使用 TCP urg pointer 字段中的主机请求解释功能。大部份的主机都使用老旧的 BSD解释，因此如果您在 Linux
打开它﹐或会导致不能和它们正确沟通。
tcp_max_syn_backlog ：INTEGER
对于那些依然还未获得客户端确认的连接请求﹐需要保存在队列中最大数目。对于超过 128Mb 内存的系统﹐默认值是
1024 ﹐低于 128Mb 的则为 128 。如果服务器经常出现过载﹐可以尝试增加这个数字。警告﹗假如您将此值设为大于
1024 ﹐最好修改
include/net/tcp.h 里面的
TCP_SYNQ_HSIZE ﹐以保持
TCP_SYNQ_HSIZE*16
﹐并且编进核心之内。(SYN
Flood攻击利用TCP协议散布握手的缺陷，伪造虚假源IP地址发送大量TCP-SYN半打开连接到目标系统，最终导致目标系统Socket队列资源耗尽而无法接受新的连接。为了应付这种攻击，现代Unix系统中普遍采用多连接队列处理的方式来缓冲(而不是解决)这种攻击，是用一个基本队列处理正常的完全连接应用(Connect()和Accept()
)，是用另一个队列单独存放半打开连接。这种双队列处理方式和其他一些系统内核措施(例如Syn-Cookies/Caches)联合应用时，能够比较有效的缓解小规模的SYN
Flood攻击(事实证明
)
tcp_window_scaling ：INTEGER
缺省值为1
该文件表示设置tcp/ip会话的滑动窗口大小是否可变。参数值为布尔值，为1时表示可变，为0时表示不可变。tcp/ip通常使用的窗口最大可达到65535字节，对于高速网络，该值可能太小，这时候如果启用了该功能，可以使tcp/ip滑动窗口大小增大数个数量级，从而提高数据传输的能力(RFC1323)。（对普通地百M网络而言，关闭会降低开销，所以如果不是高速网络，可以考虑设置为0 ）</p>
<p>tcp_timestamps ：BOOLEAN
缺省值为1
Timestamps用在其它一些东西中﹐可以防范那些伪造的 sequence 号码。一条1G的宽带线路或许会重遇到带out-of-line数值的旧sequence 号码(假如它是由于上次产生的)。Timestamp 会让它知道这是个&rsquo;旧封包&rsquo;。(该文件表示是否启用以一种比超时重发更精确的方法（RFC1323）来启用对 RTT 的计算；为了实现更好的性能应该启用这个选项。)</p>
<p>tcp_sack ：BOOLEAN
缺省值为1
使用 Selective ACK﹐它可以用来查找特定的遗失的数据报&mdash;因此有助于快速恢复状态。该文件表示是否启用有选择的应答（Selective Acknowledgment），这可以通过有选择地应答乱序接收到的报文来提高性能（这样可以让发送者只发送丢失的报文段）。(对于广域网通信来说这个选项应该启用，但是这会增加对CPU 的占用。)</p>
<p>tcp_fack ：BOOLEAN
缺省值为1
打开FACK拥塞避免和快速重传功能。(注意，当tcp_sack 设置为0 的时候，这个值即使设置为1 也无效)</p>
<p>tcp_dsack ：BOOLEAN
缺省值为1
允许TCP发送&rdquo;两个完全相同&rdquo;的SACK。</p>
<p>tcp_ecn ：BOOLEAN
缺省值为0
打开TCP的直接拥塞通告功能。</p>
<p>tcp_reordering ：INTEGER
默认值是3
TCP流中重排序的数据报最大数量 。 (一般有看到推荐把这个数值略微调整大一些,比如5 )</p>
<p>tcp_retrans_collapse ：BOOLEAN
缺省值为1
对于某些有bug的打印机提供针对其bug的兼容性。(一般不需要这个支持,可以关闭它)</p>
<p>tcp_wmem (3个INTEGER 变量)： min, default, max
    min ：为TCP socket预留用于发送 缓冲 的内存最小值。每个tcp socket都可以在建议以后都可以使用它。默认值为4096(4K) 。
default ：为TCP socket预留用于发送缓冲的内存数量，默认情况下该值会影响其它协议使用的net.core.wmem_default值，一般要低于net.core.wmem_default 的值。默认值为16384(16K) 。
    max : 用于TCP socket发送缓冲的内存最大值。该值不会影响net.core.wmem_max，&rdquo;静态&rdquo;选择参数SO_SNDBUF则不受该值影响。默认值为131072(128K) 。（对于服务器而言，增加这个参数的值对于发送数据很有帮助,在我的网络环境中,修改为了51200 131072 204800）</p>
<p>tcp_rmem (3个INTEGER 变量)： min , default , max</p>
<pre><code>min ：为TCP socket预留用于接收缓冲 的内存数量，即使在内存出现紧张情况下tcp socket都至少会有这么多数量的内存用于接收缓冲，默认值为8K 。
default ：为TCP socket预留用于接收缓冲的内存数量，默认情况下该值影响其它协议使用的net.core.wmem_default值。该值决定了在tcp_adv_win_scale、tcp_app_win 和tcp_app_win=0默认值情况下，TCP窗口大小为65535。默认值为87380
max ：用于TCP socket接收缓冲的内存最大值。该值不会影响net.core.wmem_max，"静态"选择参数 SO_SNDBUF则不受该值影响。默认值为 128K 。默认值为87380*2 bytes。（可以看出，.max的设置最好是default的两倍,对于NAT来说主要该增加它,我的网络里为51200 131072 204800）
</code></pre>
<p>tcp_mem (3个INTEGER 变量)：low , pressure , high
    low ：当TCP使用了低于该值的内存页面数 时，TCP不会考虑释放内存。(理想情况下，这个值应与指定给 tcp_wmem 的第 2 个值相匹配 - 这第 2 个值表明，最大页面大小乘以最大并发请求数除以页大小 (131072 * 300 / 4096 )。 )
    pressure ：当TCP使用了超过该值的内存页面数量时，TCP试图稳定其内存使用，进入pressure模式，当内存消耗低于low值时则退出pressure状态。(理想情况下这个值应该是TCP 可以使用的总缓冲区大小的最大值 (204800 * 300 / 4096 )。 )
    high ：允许所有tcp sockets用于排队缓冲数据报的页面量。(如果超过这个值，TCP 连接将被拒绝，这就是为什么不要令其过于保守 (512000 * 300 / 4096 ) 的原因了。</p>
<p>在这种情况下，提供的价值很大，它能处理很多连接，是所预期的 2.5 倍；或者使现有连接能够传输 2.5 倍的数据。我的网络里为192000 300000 732000)一般情况下这些值是在系统启动时根据系统内存数量计算得到的。</p>
<p>tcp_app_win : INTEGER
默认值是31
保留max(window/2^tcp_app_win, mss)数量的窗口由于应用缓冲。当为0时表示不需要缓冲。</p>
<p>tcp_adv_win_scale : INTEGER
默认值为2
计算缓冲开销bytes/2^tcp_adv_win_scale(如果tcp_adv_win_scale &gt; 0)或者bytes-bytes/2^(-tcp_adv_win_scale)(如果tcp_adv_win_scale &lt;= 0）。</p>
<p>tcp_rfc1337 :BOOLEAN
缺省值为0
这个开关可以启动对于在RFC1337中描述的&rdquo;tcp的time-wait暗杀危机&rdquo;问题的修复。启用后，内核将丢弃那些发往time-wait状态TCP套接字的RST包.</p>
<p>tcp_low_latency: BOOLEAN
缺省值为0
允许 TCP/IP 栈适应在高吞吐量情况下低延时的情况；这个选项一般情形是的禁用。(但在构建Beowulf集群的时候,打开它很有帮助)</p>
<p>tcp_westwood :BOOLEAN
缺省值为0
启用发送者端的拥塞控制算法，它可以维护对吞吐量的评估，并试图对带宽的整体利用情况进行优化；对于 WAN通信来说应该启用这个选项。</p>
<p>tcp_bic :BOOLEAN
缺省值为0
为快速长距离网络启用 Binary Increase Congestion；这样可以更好地利用以 GB 速度进行操作的链接；对于WAN 通信应该启用这个选项。</p>
      <a href="/2010/01/19/sysctl-about-tcp" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/13/refresh-cache-of-interrogation-url" title="squid刷新缓存" rel="bookmark">squid刷新缓存</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-13 00:00:00 +0800">13 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>这篇博文的起因是最近犯的一个低级错误。某客户要求立刻刷新掉一批url。格式是http://a.b.com/index.jsp?pid=123456&amp;id=654321这样的。
我也没多想，上去就执行“squidclient -p 80  -m purge
http://a.b.com/index.jsp?pid=123456&amp;id=654321”。结果硬是刷不掉……明明访问源站已经没有这个url了。我wget居然还能MISS/200~~~
直到同事提醒。才赫然发现其实我一直在purge和wget的，不是http://a.b.com/index.jsp?pid=123456&amp;id=654321，而是http://a.b.com/index.jsp?pid=123456。linux把url里的&amp;当作后台运行的命令执行了……而access.log中为了安全又没记录?后的具体参数，于是傻傻的跟客户客服扯皮了N久……
“squidclient -p 80  -m purge &lsquo;http://a.b.com/index.jsp?pid=123456&amp;amp;id=654321&rsquo;”这么一刷立刻就好了~~
由此告诫自己，以后一定要严谨行事，引号最好还是要养成习惯都给带上~~</p>
<p>以下具体总结摘录squid缓存刷新的几种办法，随便感谢百度，悼念谷歌：</p>
<p>第一种——当squid的refresh_pattern未使用任何options，即squid缓存遵循http协议精神时有效。原理是模拟no-cache头的request（即ctrl+F5刷新）：
【nnd，一帖就错误，单独放一个帖子，大家看下一贴吧】</p>
<p>第二种，采用PURGE方式刷新，request的header如下：</p>
<p>PURGE http://www.lrrr.org/junk HTTP/1.0
Accept: <em>/</em></p>
<p>脚本类似第一种方法，修改其中的HEAD为PURGE即可：</p>
<p>$head = &ldquo;PURGE $url_component[&lsquo;path&rsquo;] HTTP/1.1\r\n&rdquo;;</p>
<p>按照《squid中文权威指南》的说法，当squid收到purge指令的时候，也是采用head和get的方式去处理请求，然后找到cache的文件进行删除的。</p>
<p>第三种，采用多播HTCP包。这是 MediaWiki 目前正在使用的方法，当wiki 更新时用于更新全球的 Squid缓存服务器，实现原理为：发送 PURGE 请求到特定的多播组，所有Squid服务器通过订阅该多播组信息完成删除操作，这种实现方式非常高效，避免了 Squid 服务器处理响应和建立 TCP连接的开销。参考资料： Multicast HTCP purging。</p>
<p>第五种，小工具：<a href="http://www.wa.apana.org.au/~dean/squidpurge/">http://www.wa.apana.org.au/~dean/squidpurge/</a>
wget http://www.wa.apana.org.au/~dean/sources/purge-20040201-src.tar.gz
tar zxvf purge-20040201-src.tar.gz
cd purge
make
./purge -help
    ### Use at your own risk! No guarantees whatsoever. You were warned. ###
    $Id: purge.cc,v 1.17 2000/09/21 10:59:53 cached Exp $
    Usage: purge [-a] [-c cf] [-d l] [-(f|F) fn | -(e|E) re] [-ph[:p]]
    [-P #] [-s] [-v] [-C dir [-H]] [-n]
    -a display a little rotating thingy to indicate that I am alive
    (tty only).
    -c c squid.conf location, default
    &ldquo;/usr/local/squid/etc/squid.conf&rdquo;.
    -C dir base directory for content extraction (copy-out mode).
    -d l debug level, an or of different debug options.
    -e re single regular expression_r_r per -e instance (use
    quotes!).
    -E re single case sensitive regular expression_r_r like -e.
    -f fn name of textfile containing one regular
    expression_r_r per line.
    -F fn name of textfile like -f containing case sensitive REs.
    -H prepend HTTP reply header to destination files in copy-out
    mode.
    -n do not fork() when using more than one cache_dir.
    -p h:p cache runs on host h and optional port p, default is
    localhost:3128.
    -P # if 0, just print matches; otherwise or the following purge
    modes:
    0x01 really send PURGE to the cache.
    0x02 remove all caches files reported as 404 (not found).
    0x04 remove all weird (inaccessible or too small) cache
    files.
    0 and 1 are recommended - slow rebuild your cache with other modes.
    -s show all options after option parsing, but before really
    starting.
    -v show more information about the file, e.g. MD5, timestamps and
    flags.</p>
<p>使用示例：</p>
<ol>
  <li>清除URL中包含jackbillow.com的所有缓存
 ./purge -p 127.0.0.1:80 -P 1 -se &lsquo;jackbillow.com&rsquo;</li>
  <li>清除 URL 以“.mp3”结尾的缓存文件，例如：http://www.dzend.com/abc/test.mp3
 ./purge -p 127.0.0.1:80 -P 1 -se &lsquo;.mp3$&rsquo;</li>
</ol>
<p>第五种，张宴的脚本clear_squid_cache.sh。（老小注：还是这个熟悉，呵呵）</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/sh</span>
<span class="nv">squidcache_path</span><span class="o">=</span><span class="s2">&quot;/data1/squid/var/cache&quot;</span>
<span class="nv">squidclient_path</span><span class="o">=</span><span class="s2">&quot;/usr/local/squid/bin/squidclient&quot;</span>
grep -a -r <span class="nv">$1</span> <span class="nv">$squidcache_path</span>/* | strings | grep <span class="s2">&quot;http:&quot;</span> | awk -F<span class="s1">&#39;http:&#39;</span> <span class="s1">&#39;{print &quot;http:&quot;$2;}&#39;</span> &gt;cache_list.txt
<span class="k">for </span>url in <span class="sb">`</span>cat cache_list.txt<span class="sb">`</span>; <span class="k">do</span>
    <span class="nv">$squidclient_path</span> -m PURGE -p 80 <span class="nv">$url</span>
<span class="k">done</span>
</code></pre></div>
<p>据说：经测试，在DELL 2950上清除26000个缓存文件用时2分钟左右。平均每秒可清除缓存文件177个。
看到了吧，网上流传的这个脚本里，$url也没有用&rdquo;&ldquo;引起来，所以用这个sh刷新的时候，也失败了……</p>
      <a href="/2010/01/13/refresh-cache-of-interrogation-url" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/13/refresh-cache-by-php" title="刷新squid缓存的php脚本" rel="bookmark">刷新squid缓存的php脚本</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-13 00:00:00 +0800">13 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">interface</span> <span class="nx">Flush_Cache</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">flush</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">Flush_Cache_HTTP_Header_Impl</span> <span class="k">implements</span> <span class="nx">Flush_Cache</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">flush</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$url</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$url_component</span> <span class="o">=</span> <span class="nb">parse_url</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
        <span class="k">global</span> <span class="nv">$g_squid_servers</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$g_squid_servers</span> <span class="k">as</span> <span class="nv">$server</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nv">$squid_params</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span> <span class="p">,</span> <span class="nv">$server</span><span class="p">);</span>
            <span class="nv">$fsocket</span> <span class="o">=</span> <span class="nb">fsockopen</span><span class="p">(</span><span class="nv">$squid_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$squid_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nv">$errono</span><span class="p">,</span> <span class="nv">$errstr</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="k">FALSE</span> <span class="o">!=</span> <span class="nv">$fsocket</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nv">$head</span> <span class="o">=</span> <span class="s2">&quot;HEAD </span><span class="si">{</span><span class="nv">$url_component</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> HTTP/1.1rn&quot;</span><span class="p">;</span>
                <span class="nv">$head</span> <span class="o">.=</span> <span class="s2">&quot;Accept: */*rn&quot;</span><span class="p">;</span>
                <span class="nv">$head</span> <span class="o">.=</span> <span class="s2">&quot;Host: </span><span class="si">{</span><span class="nv">$url_component</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">rn&quot;</span><span class="p">;</span>
                <span class="nv">$head</span> <span class="o">.=</span> <span class="s2">&quot;Cache-Control: no-cachern&quot;</span><span class="p">;</span>
                <span class="nv">$head</span> <span class="o">.=</span> <span class="s2">&quot;rn&quot;</span><span class="p">;</span>
                <span class="k">echo</span> <span class="nv">$head</span><span class="p">;</span>
                <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fsocket</span> <span class="p">,</span> <span class="nv">$head</span><span class="p">);</span>
                <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$fsocket</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="nv">$line</span> <span class="o">=</span> <span class="nb">fread</span><span class="p">(</span><span class="nv">$fsocket</span> <span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
                    <span class="k">echo</span> <span class="nv">$line</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fsocket</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nv">$g_squid_servers</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;192.168.2.88:80&#39;</span><span class="p">);</span>
<span class="nv">$flush_cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Flush_Cache_HTTP_Header_Impl</span><span class="p">();</span>
<span class="nv">$flush_cache</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">(</span><span class="s1">&#39;http://ent.cdqss.com/index.html&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
      <a href="/2010/01/13/refresh-cache-by-php" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/10/zz-intro-acls-in-squid" title="Squid的ACL分类" rel="bookmark">Squid的ACL分类</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-10 00:00:00 +0800">10 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在找http_status的acl用法时，看到这么一句“This clause supports both fast and slow acl types”。acl还分快慢呢~~赶紧去wiki看：<a href="http://wiki.squid-cache.org/SquidFaq/SquidAcl#Fast_and_Slow_ACLs">http://wiki.squid-cache.org/SquidFaq/SquidAcl#Fast_and_Slow_ACLs</a></p>
<pre><code>Some ACL types require information which may not
be already available to Squid. Checking them requires suspending
work on the current request, querying some external source, and
resuming work when the needed information becomes available. This
is for example the case for DNS, authenticators or external
authorization scripts. ACLs can thus be divided in
FAST ACLs, which do not require going to external
sources to be fulfilled, and SLOW ACLs, which do.
Fast ACLs include (as of squid 3.1.0.7):
all (built-in)
src
dstdomain
dstdom_regex
myip
arp
src_as
peername
time
url_regex
urlpath_regex
port
myport
myportname
proto
method
http_status {R}
browser
referer_regex
snmp_community
maxconn
max_user_ip
req_mime_type
req_header
rep_mime_type {R}
user_cert
ca_cert
Slow ACLs include:
dst
dst_as
srcdomain
srcdom_regex
ident
ident_regex
proxy_auth
proxy_auth_regex
external
ext_user
ext_user_regex
This list may be incomplete or out-of-date. See
your squid.conf.documented file for details. ACL types
marked with {R} are reply ACLs, see the dedicated FAQ
chapter.
Squid caches the results of ACL lookups whenever
possible, thus slow ACLs will not always need to go to the external
data-source.
Knowing the behaviour of an ACL type is relevant
because not all ACL matching directives support all kinds of ACLs.
Some check-points will not suspend the request:
they allow (or deny) immediately. If a SLOW acl has to be checked,
and the results of the check are not cached, the corresponding ACL
result will be as if it didn't match. In other words, such ACL
types are in general not reliable in all access check clauses.
</code></pre>
      <a href="/2010/01/10/zz-intro-acls-in-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/09/keep-sessions-between-client-cache-origin" title="client-cache-origin之间的session问题" rel="bookmark">client-cache-origin之间的session问题</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-09 00:00:00 +0800">09 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>昨天，突然接到某客户的邮件，表示他们质疑我们cache对其多originserver的轮询不均等，以至于影响到网站的访问。
听起来不是什么难题，把服务器上的DNSCache进程中止掉，不就能平均轮询了么？可是操作完成后，客户依然不认可……于是开始细细探讨具体的错误问题所在。
原来实际情况是这样：点击其网站的回复、收藏等动态页面时，时常会弹出错误页面。对这个错误页面，客户的解释是“session状态CDN加速未保留”。
由此解释，我觉得cache上的问题恰恰相反，正是因为均等轮询了导致的。而客户其他一些单源的域名服务正常，也证明了这点。
上cache服务器查看配置，使用的默认keep-alive设置，也就是对client和origin都开启了keep-alive，默认时间为2min。但实际上并没有起作用。在测试中，可以看到这样的日志：</p>
<pre><code>[rao@localhost ~]$ tail access.log|awk '{print $4,$6,$7,$9,$10}'
TCP_IMS_HIT/304 GET http://a.b.com/wentiyongpin/11106917.html NONE/- "http://a.b.com/wentiyongpin/"
TCP_MISS/200 GET http://a.b.com/RelatedUserInfo.aspx?nickname=shunfataiqiu DIRECT/1.2.3.4 "http://a.b.com/wentiyongpin/11106917.html"
TCP_MISS/200 GET http://a.b.com/postcomment/Reply.aspx?info_id=11106917 DIRECT/1.2.3.5 "http://a.b.com/wentiyongpin/11106917.html"
TCP_MISS/302 POST http://a.b.com/postcomment/Reply.aspx?info_id=11106917 DIRECT/1.2.3.4 "http://a.b.com/postcomment/Reply.aspx?info_id=11106917"
TCP_MISS/404 GET http://a.b.com/nf3.aspx?aspxerrorpath=/postcomment/Reply.aspx DIRECT/1.2.3.4 "http://a.b.com/postcomment/Reply.aspx?info_id=11106917"
</code></pre>
<p>由日志可见，在进入post页面（此时方式还是GET）时，session的origin从1.2.3.4轮询到了1.2.3.5，而填完了回复内容，点击提交（此时方式改成POST）时，origin又轮询回了1.2.3.4——而此时1.2.3.4上并没有相应ID的session存在——于是页面被302重定向去了错误提示页面，也就是下面的404。</p>
<p>这种情况，主要来说，还是客户网站本身的架构问题。简单点，只用一个origin；复杂点，在多台webserver与后台数据库之间建共享连接池。保证session调用正常。</p>
<p>但在客户修改origin之前，cache本身能不能作出一定的改变呢？能。放弃使用dns查询，而采用squid本身的peer功能，就能搞定它，配置如下：</p>
<div class="highlight"><pre><code class="squid"><span class="c">#Parent</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>ParentDomain<span class="w"> </span><span class="k">dstdomain</span><span class="w"> </span>a.b.com<span class="w"></span>
<span class="k">cache_peer</span><span class="w"> </span><span class="mf">1.2.3.4</span><span class="w"> </span><span class="no">parent</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="no">no-query</span><span class="w"> </span>no-netdb-exchange<span class="w"> </span>originserver<span class="w"> </span>sourcehash<span class="w"></span>
<span class="k">cache_peer</span><span class="w"> </span><span class="mf">1.2.3.5</span><span class="w"> </span><span class="no">parent</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="no">no-query</span><span class="w"> </span>no-netdb-exchange<span class="w"> </span>originserver<span class="w"> </span>sourcehash<span class="w"></span>
<span class="k">cache_peer_access</span><span class="w"> </span><span class="mf">1.2.3.4</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>ParentDomain<span class="w"></span>
<span class="k">cache_peer_access</span><span class="w"> </span><span class="mf">1.2.3.5</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>ParentDomain<span class="w"></span>
<span class="k">always_direct</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>!ParentDomain<span class="w"></span>
<span class="c">#Parent end</span><span class="w"></span>
</code></pre></div>
<p>用的sourcehash参数，相同的clientIP，使用相同的originIP，多好的loadbalance呀，更巧的是这个option，正好是squid2.6.STABLE21能用的，连2.7都没有，哈哈~~reconfigure后的正常日志如下：</p>
<pre><code>[rao@localhost ~]$ tail access.log|awk '{print $4,$6,$7,$9,$10}'
TCP_IMS_HIT/304 GET http://a.b.com/wentiyongpin/11106917.html NONE/- "http://a.b.com/wentiyongpin/"
TCP_MISS/200 GET http://a.b.com/postcomment/Reply.aspx?info_id=11106917 SOURCEHASH_PARENT/1.2.3.4 "http://a.b.com/wentiyongpin/11106917.html"
TCP_MISS/200 GET http://a.b.com/RelatedUserInfo.aspx?nickname=shunfataiqiu SOURCEHASH_PARENT/1.2.3.4 "http://a.b.com/wentiyongpin/11106917.html"
TCP_MISS/200 POST http://a.b.com/postcomment/Reply.aspx?info_id=11106917 SOURCEHASH_PARENT/1.2.3.4 "http://a.b.com/postcomment/Reply.aspx?info_id=11106917"
TCP_MISS/200 GET http://a.b.com/ SOURCEHASH_PARENT/1.2.3.4 "-"
TCP_MISS/200 GET http://a.b.com/zufang/ SOURCEHASH_PARENT/1.2.3.4 "http://a.b.com/"
TCP_MISS/200 GET http://a.b.com/ad.ashx?ad=ad&amp;url=http://a.b.com/zufang/&amp;alias=zufang&amp;childalias=zufang SOURCEHASH_PARENT/1.2.3.4 "http://a.b.com/zufang/"
</code></pre>
<p>整个访问中，回源IP一直都是1.2.3.4，而且POST不再是302转404，而是200了~~</p>
      <a href="/2010/01/09/keep-sessions-between-client-cache-origin" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/09/intro-http_status" title="squid3新acl类型http_status试用（源站故障转向研究）" rel="bookmark">squid3新acl类型http_status试用（源站故障转向研究）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-09 00:00:00 +0800">09 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>今天试着自己编译安装了squid3.1，然后开始移植2.6的配置文件。在squid.conf.document（2.6里的squid.conf.default）里看了很久，发现不少新东西。跟转向有关的，便发现一个：</p>
<p>acl aclname http_status 200 301 500- 400-403
&hellip;
# status code in reply</p>
<p>这个acl配合http_access和deny_info，也是个转向的办法。（相反的，大家举例时一般用来deny的正是302跳转）</p>
<p>acl err http_status 500-
http_access deny err
deny_info http://err.tiaozhuan.com err</p>
<p>不过问题依旧：这个依然没法把不同的域名分开——deny_info只针对自己上头那个http_access deny的aclname，可要是写上同样aclname的astdomain或者url_regex，整个访问就都废了……
然后想到url_rewrite_access，如果用acl http_status配合url_rewrite_access，能不能做到避免所有请求回源确认呢？
按照之前记录的squid处理流程，squid应该是在和client建立连接后的第二步就检查acl。但3.1中添加的这个http_status，总不可能在命中的第四步或者回源的第六步之前，就能完成访问控制呀？
看来squid的内部机制，已经有了较大变化。
明天做个实验，看看实际到底如何吧~</p>
<hr />
<p>经过试验，第一个想法不可行。因为deny_info的status是TCP_DENY/302，这和acl是冲突的，导致无法工作。从此也能看出，http_status的acl确实是在比较晚的流程中才起作用的。分别使用http_status和url_regex做deny的日志如下：
    1263112949.310 27099 12.34.56.78 TCP_MISS/502 1878 GET http://a.b.com/duanzu/ - DIRECT/1.2.3.4 text/html &ldquo;http://a.b.com/&rdquo; &ldquo;Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; QQPinyinSetup 620; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30)&rdquo;
    1263113026.271 0 12.34.56.78 TCP_DENIED/302 331 GET http://a.b.com/duanzu/ - NONE/- text/html &ldquo;http://a.b.com/&rdquo; &ldquo;Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; QQPinyinSetup 620; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30)&rdquo;</p>
<p>acl err http_status 500-
url_rewrite_access deny !err</p>
<p>不起作用，所有的请求都不经过rewrite直接输出了……
郁闷，这个新acl的用法还得慢慢找资料~~</p>
      <a href="/2010/01/09/intro-http_status" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/05/principle-and-solution-of-the-vm-date-problem" title="虚拟机时间问题的机制原理及解决办法" rel="bookmark">虚拟机时间问题的机制原理及解决办法</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-05 00:00:00 +0800">05 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cloud-ref" title="cloud" rel="category tag">cloud</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>对于CDN来说，时间是个非常重要的概念，squid的缓存刷新控制，全都是以服务器时间为基准。在我博客的前不知道几篇的某文中，就提到过因为时间的原因引起的刷新事故。而最新的一次，是公司在日志流量统计时，因为相差太大导致截取失败——这可都是钱呢。
实际工作中，大多会搭建一个NTP服务器，给应用服务器提供时间同步服务。但虚拟机在这方面有个问题。虚拟机的时间是读取的宿主机的硬件时钟，随便你date
-s 1234怎么改，下一次date查看，都会恢复成原样。
这样看起来是个好事，因为这样可以省略掉大批机器的NTP服务器同步时间的压力。但糟糕的事情在后头：一大批重要客户的虚拟机，在运行上半年以上时间后，date都比真实时间超前了（偶然我也看到过一次滞后的）。或许是几分钟，或许是几小时！！
这一度让我很无奈，因为即使我重启虚拟机，这个诡异的date也依然倔强的按照它自己的时钟前进。看起来办法只有一个：把虚拟平台整个的重启——好在这种试验的结果是有效的，不然真不知道怎么办了。
从这个无奈的办法中，也应该可以推测出一个结论，虚拟机的时钟，应该是另有文件存储在虚拟平台的某个临时文件里。所以关闭虚拟机，该文件还存在并继续计时；重启动虚拟平台，该文件才会重计。至于这个文件叫什么，存放在哪里，一时半会我就找不到了，或许这个问题不算什么特别大的问题，至少我在linuxsir.org的《xen初学指南》中，没有找到关于时钟的配置说明。
不过再小的问题也顶不住人的研究。于是我找到了另一篇很对口的文章：《虚拟机中GUEST OS时钟(TIMEKEEP)问题的探讨》。
文章告诉我们：虚拟机的时钟，与真实机的时钟区别，其一在于其处理不是抢占中断而是延迟处理；其二在于其中断模拟软件可能因资源占用问题被推迟。
这两点区别，导致的结果却是一个，就是一旦服务器负载变高，时钟中断就被排到后头去了……
文章也提出了解决办法，一个是编程，让系统补上中断的时间，这个俺就不说了；一个是修改内核，让系统不断修正date；
进一步问题：不管哪个办法，第一，加重了虚拟机负载；第二，这又依赖与系统去更新date的进程的精准度，而这个进程的中断时钟如果有偏差的话，……
再进一步方法……有兴趣的还是自己点文章看吧。
看起来这个问题就要永远终结在此了。
不过变通的主意及时的出现了——既然虚拟机跟虚拟平台之间的异步时钟同步没法解决，我们就干脆不要虚拟机跟虚拟平台同步了。这样虽然对NTP的压力大了，但毕竟保证了CDN的正常。而且从上头的原理可以知道，能够导致date偏差到这个程度的原因，大概也是因为虚拟机的负载压力太大。事实上，我们为了保证冗余，也是尽量避免这种压力出现的。那么date偏差的服务器，其实也就是少数了。
顺着这个思路一查，原来办法其实很简单——修改虚拟机的independent_wallclock值即可：
echo 1 &gt; /proc/sys/xen/independent_wallclock
或sysctl xen.independent_wallclock=1
启用虚拟机独立系统时间；
/etc/init.d/ntpd stop
ntpdate 192.168.0.1
就能完成NTP时间同步了；
再date看看，时间果然就更正了~~
/proc下的文件都是进程使用中的文件，如果要让虚拟机开机自动读取配置，把这个修改写进/etc/sysctl.conf才行哦：
echo &ldquo;xen.independent_wallclock = 1&rdquo;&nbsp;&raquo; /etc/sysctl.conf
就这么简单~~~</p>
      <a href="/2010/01/05/principle-and-solution-of-the-vm-date-problem" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2010/01/01/limit-speed-in-squid" title="squid限速" rel="bookmark">squid限速</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2010-01-01 00:00:00 +0800">01 Jan 2010</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>squid有个delay_pool，可以做限速，虽然效果不太准~（嗯，就像限制并发连接数的maxconn一样）
首先搬个老虎皮做大旗——《Squid: The Definitive Guide》的相关段落：</p>
<p>The buckets don&rsquo;t actually store bandwidth (e.g., 100 Kbit/s), but  <br />
rather some amount of traffic (e.g., 384 KB). Squid adds some  <br />
amount of traffic to the buckets each second. Cache clients take  <br />
some amount of traffic out when they receive data from an upstream  <br />
source (origin server or neighbor).  <br />
The size of a bucket determines how much burst bandwidth is  <br />
available to a client. If a bucket starts out full, a client can  <br />
take as much traffic as it needs until the bucket becomes empty.  <br />
The client then receives traffic allotments at the fill rate.  <br />
The mapping between Squid clients and actual buckets is a bit  <br />
complicated. Squid uses three different constructs to do it: access  <br />
rules, delay pool classes, and types of buckets. First, Squid  <br />
checks a client request against the delay_access list. If the  <br />
request is a match, it points to a particular delay pool. Each  <br />
delay pool has a class: 1, 2, or 3. The classes determine which  <br />
types of buckets are in use. Squid has three types of buckets:  <br />
aggregate, individual, and network:  <br />
A class 1 pool has a single aggregate bucket.  <br />
A class 2 pool has an aggregate bucket and 256 individual  <br />
buckets.  <br />
A class 3 pool has an aggregate bucket, 256 network buckets, and  <br />
65,536 individual buckets.  <br />
As you can probably guess, the individual and network buckets  <br />
correspond to IP address octets. In a class 2 pool, the individual  <br />
bucket is determined by the last octet of the client&rsquo;s IPv4  <br />
address. In a class 3 pool, the network bucket is determined by the  <br />
third octet, and the individual bucket by the third and fourth  <br />
octets.  <br />
For the class 2 and 3 delay pools, you can disable buckets you  <br />
don&rsquo;t want to use. For example, you can define a class 2 pool with  <br />
only individual buckets by disabling the aggregate bucket.  <br />
When a request goes through a pool with more than one bucket type,  <br />
it takes bandwidth from all buckets. For example, consider a class  <br />
3 pool with aggregate, network, and individual buckets. If the  <br />
individual bucket has 20 KB, the network bucket 30 KB, but the  <br />
aggregate bucket only 2 KB, the client receives only a 2-KB  <br />
allotment. Even though some buckets have plenty of traffic, the  <br />
client is limited by the bucket with the smallest amount.  <br />
C.2 Configuring Squid  <br />
Before you can use delay pools, you must enable the feature when  <br />
compiling. Use the —enable-delay-pools option when running  <br />
./configure. You can then use the following directives to set up  <br />
the delay pools.  <br />
C.2.1 delay_pools  <br />
The delay_pools directive tells Squid how many pools you want to  <br />
define. It should go before any other delay pool-configuration  <br />
directives in squid.conf. For example, if you want to have five  <br />
delay pools:  <br />
delay_pools 5  <br />
The next two directives actually define each pool&rsquo;s class and other  <br />
characteristics.  <br />
C.2.2 delay_class  <br />
You must use this directive to define the class for each pool. For  <br />
example, if the first pool is class 3:  <br />
delay_class 1 3  <br />
Similarly, if the fourth pool is class 2:  <br />
delay_class 4 2  <br />
In theory, you should have one delay_class line for each pool.  <br />
However, if you skip or omit a particular pool, Squid doesn&rsquo;t  <br />
complain.  <br />
C.2.3 delay_parameters  <br />
Finally, this is where you define the interesting delay pool  <br />
parameters. For each pool, you must tell Squid the fill rate and  <br />
maximum size for each type of bucket. The syntax is:  <br />
delay_parameters N rate/size [rate/size [rate/size]]  <br />
The rate value is given in bytes per second, and size in total  <br />
bytes. If you think of rate in terms of bits per second, you must  <br />
remember to divide by 8.  <br />
Note that if you divide the size by the rate, you&rsquo;ll know how long  <br />
it takes (number of seconds) the bucket to go from empty to full  <br />
when there are no clients using it.  <br />
A class 1 pool has just one bucket and might look like this:  <br />
delay_class 2 1  <br />
delay_parameters 2 2000/8000  <br />
For a class 2 pool, the first bucket is the aggregate, and the  <br />
second is the group of individual buckets. For example:  <br />
delay_class 4 2  <br />
delay_parameters 4 7000/15000 3000/4000  <br />
Similarly, for a class 3 pool, the aggregate bucket is first, the  <br />
network buckets are second, and the individual buckets are  <br />
third:  <br />
delay_class 1 3  <br />
delay_parameters 1 7000/15000 3000/4000 1000/2000  <br />
C.2.4 delay_initial_bucket_level  <br />
This directive sets the initial level for all buckets when Squid  <br />
first starts or is reconfigured. It also applies to individual and  <br />
network  <br />
buckets, which aren&rsquo;t created until first referenced. The value is  <br />
a percentage. For example:  <br />
delay_initial_bucket_level 75%  <br />
In this case, each newly created bucket is initially filled to 75%  <br />
of its maximum size.  <br />
C.2.5 delay_access  <br />
This list of access rules determines which requests go through  <br />
which delay pools. Requests that are allowed go through the delay  <br />
pools, while those that are denied aren&rsquo;t delayed at all. If you  <br />
don&rsquo;t have any delay_access rules, Squid doesn&rsquo;t delay any  <br />
requests.  <br />
The syntax for delay_access is similar to the other access rule  <br />
lists (see Section 6.2), except that you must put a pool number  <br />
before the allow or deny keyword. For example:  <br />
delay_access 1 allow TheseUsers  <br />
delay_access 2 allow OtherUsers  <br />
Internally, Squid stores a separate access rule list for each delay  <br />
pool. If a request is allowed by a pool&rsquo;s rules, Squid uses that  <br />
pool and stops searching. If a request is denied, however, Squid  <br />
continues examining the rules for remaining pools. In other words,  <br />
a deny rule causes Squid to stop searching the rules for a single  <br />
pool but not for all pools.  <br />
C.2.6 cache_peer no-delay Option  <br />
The cache_peer directive has a no-delay option. If set, it makes  <br />
Squid bypass the delay pools for any requests sent to that  <br />
neighbor.    </p>
<p>然后说老实话：我也看不太懂……
只好贴一些百度出来的结果：
    class类型1为单个IP地址流量  <br />
    class类型2为C类网段中的每个IP地址流量  <br />
    class类型3为B类网段中的每个C类网段中的每个IP地址流量  <br />
具体的说：
    类型1只有一个总带宽流量实际也就是这个IP地址的流量  <br />
    delay_parameters 1 64000/64000  <br />
    类型2有两个带宽流量参数，第一个为整个C类型网段流量，第二个为每个IP流量  <br />
    delay_parameters 1 -1/-1 64000/64000  <br />
    类型3有三个带宽流量参数,第一个为整个B类网总流量，第二个为每个B类网段中的C类网段总流量,第三个为了B类网段中每个C类网段中的每个IP流量  <br />
    delay_parameters 1 -1/-1 -1/-1 64000/64000  <br />
但似乎我还没百度到谁用class为2或者3的。一般大家都只用1……
举个例子：
两个域名，分别限制网民下载速度为50kb/s和100kb/s。配置如下：</p>
<div class="highlight"><pre><code class="squid"><span class="c">#定义域名</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>LIMIT_A<span class="w"> </span><span class="k">dstdomain</span><span class="w"> </span>a.test.com<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>LIMIT_B<span class="w"> </span><span class="k">dstdomain</span><span class="w"> </span>b.test.com<span class="w"></span>
<span class="c">#定义受限IP段</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>LIMIT_IP<span class="w"> </span><span class="k">src</span><span class="w"> </span><span class="mf">192.168.1.0/24</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span><span class="no">ALL</span><span class="w"> </span><span class="k">src</span><span class="w"> </span><span class="m">0</span>/0<span class="w"></span>
<span class="c">#开启两个连接延迟池</span><span class="w"></span>
<span class="k">delay_pools</span><span class="w"> </span><span class="m">2</span><span class="w"></span>
<span class="c">#定义两个延迟池，class类型均为1</span><span class="w"></span>
<span class="k">delay_class</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="k">delay_class</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="c">#分配域名到不同的延迟池</span><span class="w"></span>
<span class="k">delay_access</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>LIMIT_A<span class="w"></span>
<span class="k">delay_access</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>LIMIT_B<span class="w"></span>
<span class="c">#受限网段延迟池</span><span class="w"></span>
<span class="k">delay_access</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>LIMIT_IP<span class="w"></span>
<span class="c">#定义下载速率，速率定位为restore(bytes/sec)/max(bytes)，，restore是表示以bytes/sec的速度下載object到bucket裡，而max則表示buckets的bytes值</span><span class="w"></span>
<span class="k">delay_parameters</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">50000</span>/50000<span class="w"></span>
<span class="k">delay_parameters</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">100000</span>/100000<span class="w"></span>
<span class="c">#squid启动时初始化的池的带宽百分比</span><span class="w"></span>
<span class="k">delay_initial_bucket_level</span><span class="w"> </span><span class="m">100</span><span class="w"></span>
</code></pre></div>
<p>据网友的测试，当限速配置为20000/20000即20000/1024=19.53kb/s的时候，实际的下载速度大概在11-15kb/s之间。</p>
      <a href="/2010/01/01/limit-speed-in-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/12/31/process-of-request-to-squid" title="squid请求处理流程（源站故障转向研究）" rel="bookmark">squid请求处理流程（源站故障转向研究）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-31 00:00:00 +0800">31 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>今天继续想别的办法，第一，当然还是修改源代码，这个C++可惜俺不懂，只是大略的通过百大哥谷大婶知道了squid的请求处理流程：</p>
<ol>
  <li>客户端和squid建立连接（client-side模块、clientBeginRequest()函数）；</li>
  <li>检查ACL访问控制；</li>
  <li>检查重定向；</li>
  <li>检查缓存命中（GetMoreData()函数），写入StoreEntry（client-side模块）；
4.1. 命中（client-side模块）；
4.2. 未命中（rotoDispatch()函数启动peer算法，算法检查never|always_direct）；</li>
  <li>收到ICP响应，选择中止，转发请求（protoStart()函数）；</li>
  <li>打开到源站或peer的连接（HTTP模块），发起请求（NetworkCommunication模块），建立连接并处理异常（comm.c程序）；</li>
  <li>建立写缓存（HTTP模块），将请求写入socket；</li>
  <li>建立相应的socket读缓存，接受处理HTTP响应（即，如果已有socket，可以跳过6、7步）；</li>
  <li>响应被接受，squid接收到header信息，并在被读取时把data追加进StoreEntry，同时通知client-side模块，这个过程的速度取决于delay_pools；</li>
  <li>client-side模块从StoreEntry取数据，并写入客户端socket；</li>
  <li>客户端读取完成，数据根据情况（refresh、cache）存入磁盘；</li>
  <li>回源取完数据，标记StoreEntry为“完成”（client-side模块），socket关闭或保留到持久连接池；</li>
  <li>数据写入客户端socket完成，从StoreEntry注释掉client-side模块，同样，关闭或等待客户端连接请求。</li>
</ol>
<p>原先的想法就是在第3步，而缓存在第4步，所以不行。也就是说，必须在第4步以后操作，才能不影响CDN的命中率。很显然，我注意到一个词，第6步中“建立链接并处理异常”的comm.c程序；其次，第9步“响应被接受”，也就是说，可能建立链接但没响应，这里就应该是socket的存活过期时间来决定。<br /></p>
<p>思路到此为止，往下就是编程开发能力的事儿了，哭ing~~</p>
<p>第二个办法，还在squid本身上做文章。我注意到，处理流程的4.2步上，squid是同时检查源站和cache_peer的。那么，在源站故障的时候，cache_peer可以设成其他服务器顶上。这样的情况，不单解决一个url跳转，还能做一个源站备份。配置如下：</p>
<div class="highlight"><pre><code class="squid">nonhierarchical_direct<span class="w"> </span><span class="no">off</span><span class="w"></span>
<span class="k">prefer_direct</span><span class="w"> </span><span class="no">on</span><span class="w"></span>
<span class="k">cache_peer</span><span class="w"> </span><span class="mf">192.168.1.1</span><span class="w"> </span><span class="no">parent</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="no">no-query</span><span class="w"> </span>originserver<span class="w"> </span>name=S1<span class="w"></span>
<span class="k">cache_peer</span><span class="w"> </span><span class="mf">192.168.1.2</span><span class="w"> </span><span class="no">parent</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="no">no-query</span><span class="w"> </span>name=S2<span class="w"></span>
<span class="k">cache_peer</span><span class="w"> </span><span class="mf">192.168.1.3</span><span class="w"> </span><span class="no">parent</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="no">no-query</span><span class="w"> </span>name=S3<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>myservice<span class="w"> </span><span class="k">dstdomain</span><span class="w"> </span>.site.com<span class="w"></span>
<span class="k">cache_peer_access</span><span class="w"> </span>S1<span class="w"> </span><span class="no">allow</span><span class="w"> </span>myservice<span class="w"></span>
<span class="k">cache_peer_access</span><span class="w"> </span>S2<span class="w"> </span><span class="no">allow</span><span class="w"> </span>myservice<span class="w"></span>
<span class="k">cache_peer_access</span><span class="w"> </span>S3<span class="w"> </span><span class="no">allow</span><span class="w"> </span>myservice<span class="w"></span>
</code></pre></div>
<p>第一句的意思，就是当originserver挂了，不可层叠的请求（即hierarchy_stoplist定义的）就“可能”发往其他peer。</p>
<p>第二句的意思，就是所有优先originserver，只有挂了以后才去peer，这个配置针对的可cache的请求。</p>
<p>不过两句加起来，还有那些不再hierarchy_stoplist定义又不cache的（没实验，不知道这个可cache是指squid配置还是包括origin的header设置），可就没办法了，也不全面。</p>
      <a href="/2009/12/31/process-of-request-to-squid" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/12/30/system-function-in-awk" title="awk中让人郁闷的system()函数" rel="bookmark">awk中让人郁闷的system()函数</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-30 00:00:00 +0800">30 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>发现一个特尴尬的事实。我辛辛苦苦去百度资料，想用rewrite实现针对不同域名源站故障后的自动跳转功能，但整个思路里遗漏了一个严重的问题。</p>
<p>按我的思路，针对请求的url进行一次curl，然后根据http_code去改写url或者原样输出——这也就意味着，每一个请求，squid都回源去取一次header。那么对于源站来说，前面squid的缓存率，就是0%！完全没有效果。</p>
<p>得重新想过办法……难道去看squid源代码？汗</p>
<p>本着有头有尾善始善终的原则，决定还是把原先那个鸡肋想法写完。根据squid权威指南11章的说法，传递给重定向器的流格式为：URL IP/FQDN IDENT METHOD，其中FQDN和ident经常是空。METHOD，一般是GET和POST，squid只能缓存GET的数据，但不能无视POST方式，因为有时候POST数据header太大的话，squid可能拒绝转发这些内容，这就不好玩了。</p>
<p>在明确这个格式以后（主要是草草收尾的想法影响下），我便觉得其实完全不用perl或者php来搞，简单的awk就足够了——当然，shell不行，因为shell不能从事这种流状的行处理。</p>
<p>以下是本着我想法写的awk脚本：</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/awk -f</span>
<span class="o">{</span>
  <span class="k">if</span><span class="o">(</span>system<span class="o">(</span><span class="s2">&quot;curl -o /dev/null -s -w %{http_code}&quot;</span> <span class="nv">$1</span><span class="o">)</span>~/^<span class="o">[</span>2|3<span class="o">]</span>/<span class="o">){</span>
    print <span class="s2">&quot;:$1&quot;</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    print <span class="s2">&quot;:http://www.baidu.com/&quot;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>但是再度让我郁闷的事情接连发生。</p>
<p>第一，不管我在{}中进行什么操作，程序都把system()的结果print出来了；</p>
<table>
  <tbody>
    <tr>
      <td>第二，即使system()的结果是200，print出来的也是else{}的&rdquo;http://www.baidu.com&rdquo;；而如果我直接试验if(200~/^[2</td>
      <td>3]/){}else{}，结果就很正常！</td>
    </tr>
  </tbody>
</table>
<p>试验过程如下：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>rao@localhost ~<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;http://www.google.com&quot;</span>|awk <span class="s1">&#39;{if(200~/^[2|3]/){ print &quot;:&quot;$1 } else{ print &quot;:http://www.baidu.com/&quot;}}&#39;</span>
:http://www.google.com
<span class="o">[</span>rao@localhost ~<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;http://www.google.com&quot;</span>|awk <span class="s1">&#39;{if(system(&quot;curl -o /dev/null -s -w %{http_code} &quot;$1)~/^[2|3]/){print &quot;:&quot;$1 } else{ print &quot;:http://www.baidu.com/&quot;}}&#39;</span>
200:http://www.baidu.com/
</code></pre></div>
<table>
  <tbody>
    <tr>
      <td>思前想后，在百度大婶的帮助下，终于搞明白一个问题：system()的结果是直接返回给shell显示了，然后再由awk继续执行后面的程序，这种情况下，if()里留下的其实是system()的执行状态【即0或1】&rdquo;0&rdquo;~/^[2</td>
      <td>3]/，当然就一直执行else了。</td>
    </tr>
  </tbody>
</table>
<p>糟糕的问题是awk的getline，无法直接把system()的执行结果导入awk的变量…除非我先system里&gt;一个文件，然后getline&lt;这个文件。MyGod！</p>
<table>
  <tbody>
    <tr>
      <td>而如果采用while(&ldquo;curl&rdquo;</td>
      <td>getline var)的执行方式，如何传递shell变量进去又成了问题……唉</td>
    </tr>
  </tbody>
</table>
      <a href="/2009/12/30/system-function-in-awk" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/12/30/squid-gzip" title="squid3 的 gzip 支持" rel="bookmark">squid3 的 gzip 支持</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-30 00:00:00 +0800">30 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>标题很简单，内容很复杂，而且我也用不上。姑且存档吧：
原标题《VIGOS eCAP GZIP Adapter for SQUID Proxy Cache》
第一句话就让我很绝望，本插件只适用于squid3.1及以上版本——squid有比3.1更高的版本么——前文提到的有session控制的squid2.7我都还没看呢~哭</p>
<p>办法：</p>
<div class="highlight"><pre><code class="bash">wget http://www.measurement-factory.com/tmp/ecap/libecap-0.0.2.tar.gz
wget http://www.vigos.com/products/eCAP/vigos-ecap-gzip-adapter-1.1.0.tar.gz
wget http://www.squid-cache.org/Versions/v3/3.1/squid-3.1.0.9.tar.gz
tar xvfz squid-3.1.0.9.tar.gz
tar xvfz libecap-0.0.2.tar.gz
tar xvfz vigos-ecap-gzip-adapter-1.1.0.tar.gz
<span class="nb">cd </span>libecap-0.0.2/
./configure
make
make install
<span class="nb">cd</span> ../vigos-ecap-gzip-adapter-1.1.0/
./configure
make
make install
<span class="nb">cd</span> ../squid-3.1.0.9/
./configure --enable-ecap
make
make install
cat &gt;&gt; etc/squid.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">ecap_enable on</span>
<span class="s">ecap_service gzip_service respmod_precache 0</span>
<span class="s">ecap://www.vigos.com/ecap_gzip</span>
<span class="s">loadable_modules /usr/local/lib/ecap_adapter_gzip.so</span>
<span class="s">acl GZIP_HTTP_STATUS http_status 200</span>
<span class="s">adaptation_access gzip_service allow GZIP_HTTP_STATUS</span>
<span class="s">EOF</span>
</code></pre></div>
<p>以上，3.1毕竟还是测试版，这个留待以后吧~~</p>
<p>另，据《squid中文权威指南》作者潘勇华的blog说，这个“基于squid3.1的eCAP接口的流量压缩适配器”，对被自己压缩过的内容，简单的把Etag删除。</p>
      <a href="/2009/12/30/squid-gzip" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/12/30/a-reverse-example-of-url_rewrite_program" title="url_rewrite_program（squid游戏恶搞~）" rel="bookmark">url_rewrite_program（squid游戏恶搞~）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-30 00:00:00 +0800">30 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>标题很引人吧。其实是我在查找squid的rewrite资料时，看到的一篇文章。原作者突发奇想，准备让公司的同事们上网时，看到的所有图片全都倒过来180°。嘿嘿，小样，还不拧断你们脖子~~</p>
<p>当然这么个大计划，单靠squid还是不行的，得后台配合一下web服务器才行。</p>
<p>原理是这样的：squid每接到一个请求，首先判断后缀名是不是图片类型，如果是，下载到web服务器目录，然后调用程序颠倒图片，拷贝去另一个发布路径下。最后把新的路径返回给squid，交给浏览器去看。</p>
<p>假设下载目录是/revimg，发布目录是/revimg/out，那么apache里配置如下vhost：</p>
<div class="highlight"><pre><code class="apache"><span class="nb">ServerName</span> revimg.soulogic.com
<span class="nb">DocumentRoot</span> <span class="sx">/revimg/out</span>
</code></pre></div>
<p>好了，其他准备完成。进入squid部分：</p>
<p>squid官方并没有转向的设定，不过他允许甚至推荐了一些转向外挂（好吧，说好听些，第三方插件）。只需要很简单的在squid.conf里启用url_rewrite_program（也叫redirect_program）就可以了：</p>
<p>url_rewrite_program /etc/squid/redirect.php（常见的是pl、py，当然也可以是squirm、squidGuard等软件，其实只要是squid属主可执行文件，parse都能通过）</p>
<p>根据需要，还有相关的children、access、host配置。
下面是原作者提供的php代码。很赞，可惜还没看懂，慢慢品味：</p>
<div class="highlight"><pre><code class="php"><span class="x">#!/usr/bin/php</span>
<span class="cp">&lt;?PHP</span>
<span class="nb">chdir</span><span class="p">(</span><span class="s2">&quot;/revimg&quot;</span><span class="p">);</span>
<span class="nv">$sServer</span> <span class="o">=</span> <span class="s2">&quot;revimg.soulogic.com&quot;</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$sContent</span> <span class="o">=</span> <span class="nb">fgets</span><span class="p">(</span><span class="nx">STDIN</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nv">$sContent</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$sContent</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$sContent</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$aArg</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="nv">$sContent</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="nv">$sURL</span> <span class="o">=</span> <span class="nv">$aArg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$aArg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;GET&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">fwrite</span><span class="p">(</span><span class="nx">STDOUT</span><span class="p">,</span> <span class="nv">$sURL</span><span class="o">.</span><span class="s2">&quot;n&quot;</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$aURL</span> <span class="o">=</span> <span class="nb">parse_url</span><span class="p">(</span><span class="nv">$sURL</span><span class="p">);</span>
    <span class="nv">$aURL</span> <span class="o">+=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;scheme&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$aURL</span><span class="p">[</span><span class="s2">&quot;scheme&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;http&quot;</span>
        <span class="o">||</span> <span class="nv">$aURL</span><span class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nv">$sServer</span>
        <span class="o">||</span> <span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">&quot;/^[0-9a-z\-]+(\.[0-9a-z\-]+)+(:[0-9]{2,5})?$/i&quot;</span><span class="p">,</span> <span class="nv">$aURL</span><span class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">])</span>
        <span class="o">||</span> <span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">&quot;/\.(jpg|jpeg|png|gif)$/i&quot;</span><span class="p">,</span> <span class="nv">$aURL</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nb">fwrite</span><span class="p">(</span><span class="nx">STDOUT</span><span class="p">,</span> <span class="nv">$sURL</span><span class="o">.</span><span class="s2">&quot;n&quot;</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 检测通过，处理图片</span>
    <span class="nv">$sHash</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$sURL</span><span class="p">);</span>
    <span class="nv">$sDir</span><span class="err"> </span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$sHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$sHash</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nv">$sFile</span> <span class="o">=</span> <span class="nv">$sDir</span><span class="o">.</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$sHash</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
    <span class="nv">$sFileOut</span> <span class="o">=</span> <span class="s2">&quot;out/&quot;</span><span class="o">.</span><span class="nv">$sFile</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$sDir</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">mkdir</span><span class="p">(</span><span class="nv">$sDir</span><span class="p">,</span> <span class="mo">0777</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>
        <span class="nb">mkdir</span><span class="p">(</span><span class="s2">&quot;out/&quot;</span><span class="o">.</span><span class="nv">$sDir</span><span class="p">,</span> <span class="mo">0777</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>
        <span class="nb">chmod</span><span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="mo">0777</span><span class="p">);</span>
        <span class="nb">chmod</span><span class="p">(</span><span class="s2">&quot;out/&quot;</span><span class="o">.</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$sHash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mo">0777</span><span class="p">);</span>
        <span class="nb">chmod</span><span class="p">(</span><span class="s2">&quot;out/&quot;</span><span class="o">.</span><span class="nv">$sDir</span><span class="p">,</span> <span class="mo">0777</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$sFile</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$sCmd</span> <span class="o">=</span> <span class="s2">&quot;wget -qc &quot;</span><span class="o">.</span><span class="nb">escapeshellarg</span><span class="p">(</span><span class="nv">$sURL</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot; -O &quot;</span><span class="o">.</span><span class="nv">$sFile</span><span class="p">;</span>
        <span class="nb">exec</span><span class="p">(</span><span class="nv">$sCmd</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$sFileOut</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$sCmd</span> <span class="o">=</span> <span class="s2">&quot;convert &quot;</span><span class="o">.</span><span class="nv">$sFile</span><span class="o">.</span><span class="s2">&quot; -flip -quality 80 &quot;</span><span class="o">.</span><span class="nv">$sFileOut</span><span class="p">;</span>
        <span class="nb">exec</span><span class="p">(</span><span class="nv">$sCmd</span><span class="p">);</span>
        <span class="nb">chmod</span><span class="p">(</span><span class="nv">$sFileOut</span><span class="p">,</span> <span class="mo">0666</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$sURL</span> <span class="o">=</span> <span class="s2">&quot;&lt;a href=&quot;</span><span class="nx">http</span><span class="o">://&amp;</span><span class="nx">quot</span><span class="p">;</span><span class="o">/</span><span class="s2">&quot;&gt;http://&quot;</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;.</span><span class="nv">$sServer</span><span class="o">.</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="nv">$sFile</span><span class="p">;</span>
    <span class="nb">fwrite</span><span class="p">(</span><span class="nx">STDOUT</span><span class="p">,</span> <span class="nv">$sURL</span><span class="o">.</span><span class="s2">&quot;n&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>原作者说：squid在重定向处理是采用的标准输入输出方式，所以测试的时候只需要cat test.txt|/etc/squid/redirector.php就可以了。
这个东东还能进一步优化。因为图片在浏览器本地也有缓存的，如果之前同事们已经上过，怎么办？还得改写Expires。</p>
      <a href="/2009/12/30/a-reverse-example-of-url_rewrite_program" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/12/30/a-location-example-of-url_rewrite_program" title="url_rewrite_program（首次访问跳转）" rel="bookmark">url_rewrite_program（首次访问跳转）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-30 00:00:00 +0800">30 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上文提到，squid大多数的rewrite_program是用perl编写的。现在就转几个简洁明了的redirect.pl。虽说我至今没把perl基础教程看完。不过从中领会一下squid的rewrite流程，还是可以的：</p>
<p>例一：这是最简单的url转向，把http://www.baidu.com/转到https://www.google.com:</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="vg">$|</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="k">while</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nv">@X</span> <span class="o">=</span> <span class="nb">split</span><span class="p">;</span>
    <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$X</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$url</span> <span class="o">=~</span> <span class="n">m</span><span class="c1">#^http://www.baidu.com#) {</span>
        <span class="k">print</span> <span class="s">&quot;302:http://www.google.com\n&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$url</span> <span class="o">=~</span> <span class="n">m</span><span class="c1">#^http://gmail.com#) {</span>
        <span class="k">print</span> <span class="s">&quot;302:http://gmail.google.com\n&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s">&quot;$url\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>例二：这个的功效，是当第一次访问外网网站时，先跳转到公司主页一次，之后再访问就不再限制。</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">DB_File</span><span class="p">;</span>
<span class="k">use</span> <span class="n">vars</span> <span class="sx">qw (%cache </span><span class="nv">$uri</span> <span class="nv">$cachetime</span><span class="p">);</span>
<span class="vg">$|</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">;</span><span class="c1">#缓存超时时间</span>
<span class="k">while</span> <span class="p">(){</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$client</span><span class="p">,</span><span class="nv">$ident</span><span class="p">,</span><span class="nv">$method</span><span class="p">)</span><span class="o">=</span><span class="p">();</span>
    <span class="p">(</span><span class="nv">$uri</span><span class="p">,</span><span class="nv">$client</span><span class="p">,</span><span class="nv">$ident</span><span class="p">,</span><span class="nv">$method</span><span class="p">)</span><span class="o">=</span><span class="nb">split</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">check</span><span class="p">(</span><span class="nv">$client</span><span class="p">)){</span>
        <span class="k">next</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">save</span><span class="p">(</span><span class="nv">$client</span><span class="p">);</span>
        <span class="nv">$uri</span><span class="o">=</span><span class="s">&quot;301:http://www.xxxx.cn&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">continue</span> <span class="p">{</span>
    <span class="k">print</span> <span class="nv">$uri</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">check</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$client</span><span class="o">=</span><span class="nb">shift</span><span class="p">;</span>
    <span class="c1"># init cache time</span>
    <span class="k">my</span> <span class="nv">$time</span><span class="o">=</span><span class="nb">time</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$cachetime</span><span class="p">){</span>
        <span class="nv">$cachetime</span><span class="o">=</span><span class="nv">$time</span><span class="o">+</span><span class="nv">$timeout</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$time</span> <span class="o">&amp;</span><span class="ow">gt</span><span class="p">;</span> <span class="nv">$cachetime</span><span class="p">){</span>
        <span class="nv">%cache</span><span class="o">=</span><span class="p">();</span>
        <span class="nv">$cachetime</span><span class="o">=</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="nv">$cache</span><span class="p">{</span><span class="nv">$client</span><span class="p">};</span>
    <span class="c1"># reopen db</span>
    <span class="k">my</span> <span class="nv">%ip</span><span class="o">=</span><span class="p">();</span>
    <span class="nb">tie</span> <span class="nv">%ip</span><span class="p">,</span><span class="s">&quot;DB_File&quot;</span><span class="p">,</span><span class="s">&quot;/tmp/ip.db&quot;</span><span class="p">,</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_RDWR</span><span class="p">,</span><span class="mo">0666</span><span class="p">;</span>
    <span class="nv">%cache</span><span class="o">=</span><span class="nv">%ip</span><span class="p">;</span> <span class="c1">#hard copy?</span>
    <span class="nb">untie</span> <span class="nv">%ip</span><span class="p">;</span>
    <span class="nv">$cache</span><span class="p">{</span><span class="nv">$client</span><span class="p">}</span> <span class="p">?</span> <span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">save</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$client</span><span class="o">=</span><span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">%ip</span><span class="o">=</span><span class="p">();</span>
    <span class="nb">tie</span> <span class="nv">%ip</span><span class="p">,</span><span class="s">&quot;DB_File&quot;</span><span class="p">,</span><span class="s">&quot;/tmp/ip.db&quot;</span><span class="p">,</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_RDWR</span><span class="p">,</span><span class="mo">0666</span><span class="p">;</span>
    <span class="nv">$ip</span><span class="p">{</span><span class="nv">$client</span><span class="p">}</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="nb">untie</span> <span class="nv">%ip</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
      <a href="/2009/12/30/a-location-example-of-url_rewrite_program" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/12/30/a-location-example-of-squid_session" title="squid_session（首次访问跳转）" rel="bookmark">squid_session（首次访问跳转）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-30 00:00:00 +0800">30 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上文perl例二中提到的第一次上某网站时先跳转公司主页。在CU上看到另一种办法。即在squid2.7以上版本中，有个squid_session。操作如下：
首先是安装：
安装squid ( for 2.7 stable )
修改源代码：vi src/errorpage.c 60行处将</p>
<p>&ldquo;Generated %T by %h (%s)\n&rdquo;</p>
<p>删除，让squid错误页面不产生服务器信息。</p>
<div class="highlight"><pre><code class="bash">mkdir -p /usr/local/squid
./configure
configure options:  <span class="s1">&#39;--prefix=/usr/local/squid&#39;</span>
<span class="s1">&#39;--enable-storeio=diskd,ufs,aufs,null&#39;</span> <span class="s1">&#39;--enable-async-io=80&#39;</span>
<span class="s1">&#39;--enable-icmp&#39;</span> <span class="s1">&#39;--enable-removal-policies=heap,lru&#39;</span>
<span class="s1">&#39;--enable-useragent-log&#39;</span> <span class="s1">&#39;--enable-snmp&#39;</span> <span class="s1">&#39;--enable-referer-log&#39;</span>
<span class="s1">&#39;--enable-kill-parent-hack&#39;</span> <span class="s1">&#39;--enable-cache-digests&#39;</span>
<span class="s1">&#39;--enable-default-err-language=Simplify_Chinese&#39;</span>
<span class="s1">&#39;--enable-err-languages=Simplify_Chinese&#39;</span> <span class="s1">&#39;--enable-gnuregex&#39;</span>
<span class="s1">&#39;--enable-ipf-transparent&#39;</span> <span class="s1">&#39;--enable-pf-transparent&#39;</span>
<span class="s1">&#39;--enable-follow-x-forwarded-for&#39;</span> <span class="s1">&#39;--disable-wccp&#39;</span>
<span class="s1">&#39;--disable-delay-pools&#39;</span> <span class="s1">&#39;--disable-ident-lookups&#39;</span>
<span class="s1">&#39;--disable-arp-acl&#39;</span> <span class="s1">&#39;--with-large-files</span>
<span class="s1">make; make install; make clean</span>
<span class="s1">mkdir /usr/local/squid/helper</span>
<span class="s1">mkdir /usr/local/squid/che</span>
<span class="s1">cd hepler/external_acl/session; make</span>
<span class="s1">cp squid_session /usr/local/squid/helper</span>
<span class="s1">chmod 777 /usr/local/squid/che</span>
<span class="s1">chmod 777 /usr/local/squid/var</span>
<span class="s1">chmod 777 /usr/local/squid/var/logs</span>
<span class="s1">grep -v &#39;</span>^#<span class="s1">&#39; /etc/squid/squid.conf | sed -e &#39;</span>/^<span class="nv">$/</span>d<span class="err">&#39;</span> &gt; /etc/squid/squid.conf.orig
mv /etc/squid.conf /etc/squid.conf.system
mv /etc/squid/squid.conf.orig /etc/squid/squid.conf
</code></pre></div>
<p>然后是squid.conf的修改：</p>
<div class="highlight"><pre><code class="squid">external_acl_type<span class="w"> </span>session<span class="w"> </span><span class="no">ttl</span>=300<span class="w"> </span><span class="k">negative_ttl</span>=0<span class="w"> </span><span class="no">children</span>=1<span class="w"></span>
concurrency=200<span class="w"> </span>%SRC<span class="w"> </span>/usr/local/squid/helper/squid_session<span class="w"> </span>-t<span class="w"> </span><span class="m">900</span><span class="w"></span>
//客户端第一个网页转向<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>session<span class="w"> </span>external<span class="w"> </span>session<span class="w"></span>
<span class="k">acl</span><span class="w"> </span><span class="no">all</span><span class="w"> </span><span class="k">src</span><span class="w"> </span><span class="no">all</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>manager<span class="w"> </span><span class="k">proto</span><span class="w"> </span>cache_object<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>localhost<span class="w"> </span><span class="k">src</span><span class="w"> </span><span class="mf">127.0.0.1/32</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>to_localhost<span class="w"> </span><span class="k">dst</span><span class="w"> </span><span class="mf">127.0.0.0/8</span><span class="w"> </span><span class="mf">0.0.0.0/32</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>localnet<span class="w"> </span><span class="k">src</span><span class="w"> </span><span class="mf">10.0.0.0/8</span><span class="w"></span>
<span class="c"># RFC1918 possible internal network</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>localnet<span class="w"> </span><span class="k">src</span><span class="w"> </span><span class="mf">172.16.0.0/12</span><span class="w"></span>
<span class="c"># RFC1918 possible internal network</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>localnet<span class="w"> </span><span class="k">src</span><span class="w"> </span><span class="mf">192.168.0.0/16</span><span class="w"></span>
<span class="c"># RFC1918 possible internal network</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>SSL_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">443</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">80</span><span class="w"></span>
<span class="c"># http</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">21</span><span class="w"></span>
<span class="c"># ftp</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">443</span><span class="w"></span>
<span class="c"># https</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">70</span><span class="w"></span>
<span class="c"># gopher</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">210</span><span class="w"></span>
<span class="c"># wais</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">1025-65535</span><span class="w"></span>
<span class="c"># unregistered ports</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">280</span><span class="w"></span>
<span class="c"># http-mgmt</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">488</span><span class="w"></span>
<span class="c"># gss-http</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">591</span><span class="w"></span>
<span class="c"># filemaker</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">777</span><span class="w"></span>
<span class="c"># multiling http</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>CONNECT<span class="w"> </span><span class="k">method</span><span class="w"> </span>CONNECT<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>rangeget<span class="w"> </span>req_header<span class="w"> </span>Range<span class="w"> </span>.*<span class="w"></span>
//定义多线程下载规则<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">deny</span><span class="w"> </span>!session<span class="w"></span>
//只有第一个执行才能打开<span class="w"></span>
<span class="k">deny_info</span><span class="w"> </span>firstpage<span class="w"> </span>session<span class="w"></span>
//deny_info指定的页面<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">deny</span><span class="w"> </span>rangeget<span class="w"></span>
//不允许多线程下载<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span><span class="no">all</span><span class="w"></span>
<span class="k">icp_access</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>localnet<span class="w"></span>
<span class="k">icp_access</span><span class="w"> </span><span class="no">deny</span><span class="w"> </span><span class="no">all</span><span class="w"></span>
<span class="k">http_port</span><span class="w"> </span><span class="mf">127.0.0.1</span>:3128<span class="w"> </span>transparent<span class="w"></span>
<span class="k">http_port</span><span class="w"> </span><span class="mf">192.168.101.1</span>:3128<span class="w"> </span>transparent<span class="w"></span>
//绑定IP和端口，透明代理<span class="w"></span>
<span class="k">http_port</span><span class="w"> </span><span class="mf">192.168.188.1</span>:3128<span class="w"> </span>transparent<span class="w"></span>
<span class="k">access_log</span><span class="w"> </span>/usr/local/squid/var/logs/access.log<span class="w"> </span>squid<span class="w"></span>
//各种日志信息存放路径<span class="w"></span>
<span class="k">cache_log</span><span class="w"> </span>/usr/local/squid/var/logs/cache.log<span class="w"></span>
<span class="k">cache_store_log</span><span class="w"> </span>/usr/local/squid/var/logs/store.log<span class="w"></span>
<span class="k">pid_filename</span><span class="w"> </span>/usr/local/squid/var/squid.pid<span class="w"></span>
<span class="k">coredump_dir</span><span class="w"> </span>/usr/local/squid/var/coredump<span class="w"></span>
<span class="k">cache_mem</span><span class="w"> </span>100MB<span class="w"></span>
//使用内存 <span class="w"> </span>总内存的一半<span class="w"></span>
maximum_object_size_in_memory<span class="w"> </span>40KB<span class="w"></span>
//内存中对像大小<span class="w"></span>
<span class="k">cache_swap_low</span><span class="w"> </span><span class="m">90</span><span class="w"></span>
<span class="k">cache_swap_high</span><span class="w"> </span><span class="m">95</span><span class="w"></span>
<span class="k">cache_dir</span><span class="w"> </span>aufs<span class="w"> </span>/usr/local/squid/che<span class="w"> </span><span class="m">500</span><span class="w"> </span><span class="m">16</span><span class="w"></span>
<span class="m">256</span> <span class="w"> </span>//缓存目录<span class="w"></span>
<span class="k">hierarchy_stoplist</span><span class="w"> </span>cgi-bin<span class="w"> </span>?<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>QUERY<span class="w"> </span><span class="k">urlpath_regex</span><span class="w"> </span>cgi-bin<span class="w"> </span>?<span class="w"></span>
cache<span class="w"> </span><span class="no">deny</span><span class="w"> </span>QUERY<span class="w"></span>
<span class="k">refresh_pattern</span><span class="w"> </span>^ftp:<span class="w"> </span><span class="m">1440</span><span class="w"> </span><span class="m">20%</span><span class="w"> </span><span class="m">10080</span><span class="w"></span>
<span class="k">refresh_pattern</span><span class="w"> </span>^gopher:<span class="w"> </span><span class="m">1440</span><span class="w"> </span><span class="m">0%</span><span class="w"> </span><span class="m">1440</span><span class="w"></span>
<span class="k">refresh_pattern</span><span class="w"> </span>-i<span class="w"> </span>(/cgi-bin/|?)<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0%</span><span class="w"> </span><span class="m">0</span><span class="w"></span>
<span class="k">refresh_pattern</span><span class="w"> </span>.<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">20%</span><span class="w"> </span><span class="m">4320</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>shoutcast<span class="w"> </span>rep_header<span class="w"> </span>X-HTTP09-First-Line<span class="w"> </span>^ICY.[0-9]<span class="w"></span>
upgrade_http0.9<span class="w"> </span><span class="no">deny</span><span class="w"> </span>shoutcast<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>apache<span class="w"> </span>rep_header<span class="w"> </span>Server<span class="w"> </span>^Apache<span class="w"></span>
broken_vary_encoding<span class="w"> </span><span class="no">allow</span><span class="w"> </span>apache<span class="w"></span>
<span class="k">header_access</span><span class="w"> </span><span class="no">Via</span><span class="w"> </span><span class="no">deny</span><span class="w"> </span><span class="no">all</span><span class="w"></span>
<span class="k">header_access</span><span class="w"> </span>X-Cache<span class="w"> </span><span class="no">deny</span><span class="w"> </span><span class="no">all</span><span class="w"></span>
//隐藏服务器信息<span class="w"></span>
<span class="k">header_access</span><span class="w"> </span>X-Cache-Lookup<span class="w"> </span><span class="no">deny</span><span class="w"> </span><span class="no">all</span><span class="w"></span>
<span class="k">header_access</span><span class="w"> </span>X-Forward-For<span class="w"> </span><span class="no">deny</span><span class="w"> </span><span class="no">all</span><span class="w"></span>
<span class="no">via</span><span class="w"> </span><span class="no">off</span><span class="w"></span>
//<span class="w"> </span>隐藏服务器信息<span class="w"></span>
check_hostnames<span class="w"> </span><span class="no">on</span><span class="w"></span>
//检查主机名称<span class="w"></span>
allow_underscore<span class="w"></span>
//允许出现下划线<span class="w"></span>
<span class="k">logfile_rotate</span><span class="w"> </span><span class="m">4</span><span class="w"></span>
//rotate后保存日志数量<span class="w"></span>
<span class="k">cache_mgr</span><span class="w"> </span>rainren_openbsd@yahoo.cn<span class="w"></span>
<span class="k">visible_hostname</span><span class="w"> </span>rain<span class="w"></span>
httpd_suppress_version_string<span class="w"> </span><span class="no">on</span><span class="w"></span>
//<span class="w"> </span>隐藏服务器信息<span class="w"></span>
</code></pre></div>
<p>最后创建ERR页，即squid.conf中的/usr/local/squid/share/errors/Simplify_Chinese/firstpage，如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;refresh&quot;</span> <span class="na">content=</span><span class="s">&quot;10;url=&quot;</span><span class="na">http:</span><span class="err">//</span><span class="na">www</span><span class="err">.</span><span class="na">google</span><span class="err">.</span><span class="na">com</span><span class="err">/&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html;charset=gb2312&quot;</span> <span class="nt">/&gt;</span>
rainren
legend {
font-size:18px;
font-weight:bold;
color:black;
}
p {
font-size:16px;
color:#FF0000;
}
</code></pre></div>
<p>热诚欢迎您
怎么样？
好了，以上都是转载，还没试验过，不过有一个我知道的，就是不用修改ERR页，在deny_info里，可以直接写http://www.google.com。</p>
      <a href="/2009/12/30/a-location-example-of-squid_session" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/12/30/502-error-in-nginx" title="nginx502错误" rel="bookmark">nginx502错误</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-30 00:00:00 +0800">30 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>NGINX 502 Bad Gateway错误是FastCGI有问题，造成NGINX 502错误的可能性比较多。将网上找到的一些和502 Bad Gateway错误有关的问题和排查方法列一下，先从FastCGI配置入手：</p>
<ol>
  <li>查看FastCGI进程是否已经启动</li>
</ol>
<p>NGINX 502错误的含义是sock、端口没被监听造成的。我们先检查fastcgi是否在运行</p>
<ol>
  <li>检查系统Fastcgi进程运行情况</li>
</ol>
<p>除了第一种情况，fastcgi进程数不够用、php执行时间长、或者是php-cgi进程死掉也可能造成nginx的502错误
运行以下命令判断是否接近FastCGI进程，如果fastcgi进程数接近配置文件中设置的数值，表明worker进程数设置太少
netstat -anpo | grep &ldquo;php-cgi&rdquo; | wc -l</p>
<ol>
  <li>FastCGI执行时间过长</li>
</ol>
<p>根据实际情况调高以下参数值</p>
<p>fastcgi_connect_timeout 300;  <br />
fastcgi_send_timeout 300;  <br />
fastcgi_read_timeout 300;    </p>
<ol>
  <li>头部太大</li>
</ol>
<p>nginx和apache一样，有前端缓冲限制，可以调整缓冲参数</p>
<p>fastcgi_buffer_size 32k;
fastcgi_buffers 8 32k;</p>
<p>如果你使用的是nginx的负载均衡Proxying，调整</p>
<p>proxy_buffer_size  16k;
proxy_buffers 4 16k;</p>
<ol>
  <li>https转发配置错误</li>
</ol>
<p>正确的配置方法</p>
<div class="highlight"><pre><code class="nginx"><span class="k">server_name</span> <span class="s">www.xok.la</span><span class="p">;</span>
<span class="k">location</span> <span class="s">/myproj/repos</span> <span class="p">{</span>
    <span class="kn">set</span> <span class="nv">$fixed_destination</span> <span class="nv">$http_destination</span><span class="p">;</span>
    <span class="kn">if</span> <span class="s">(</span> <span class="nv">$http_destination</span> <span class="p">~</span><span class="sr">*</span> <span class="s">^https(.*)</span>$ <span class="s">)</span> <span class="p">{</span>
        <span class="kn">set</span> <span class="nv">$fixed_destination</span> <span class="s">http</span><span class="nv">$1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span> <span class="s">Destination</span> <span class="nv">$fixed_destination</span><span class="p">;</span>
    <span class="kn">proxy_pass</span> <span class="s">http://subversion_hosts</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
      <a href="/2009/12/30/502-error-in-nginx" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/12/27/zz-diff-cdn-between-china-and-usa" title="看上去很美——国内CDN现状与美国对比（转）" rel="bookmark">看上去很美——国内CDN现状与美国对比（转）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-27 00:00:00 +0800">27 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>遵嘱注明：本文转载自：<a href="http://www.php-oa.com">扶凯</a>
原链接:<a href="http://blog.csdn.net/fayu0903/archive/2009/03/25/4022979.aspx">http://blog.csdn.net/fayu0903/archive/2009/03/25/4022979.aspx</a></p>
<p>作者:阀域</p>
<ul>
  <li>CDN的理想与现实</li>
</ul>
<p>多年以前，当《Kingdom of Heaven》这部史诗电影发行的时候，中国的影迷使用电驴和BT来寻找种子，而那个时候，高清也才刚刚进入电影领域，我的同事不惜用自家的电脑花费一个星期的时间去下载高清的版本。而现在，中国的影迷在使用迅雷去下载《越狱》，而每一集越狱播出以后，在20小时之内，迅雷上面就可以下载到有中文字幕的完整版本，而影迷只要半个小时就可以下载完成，他们使用的是以“CDN”为基础的所谓P2SP服务。我们在这里不需要讨论盗版的问题，我们在这里想谈论的只是互联网和CDN的改变……</p>
<ul>
  <li>我们要谈论CDN么？</li>
</ul>
<p>互联网的改变让CDN变得不那么神秘与高深</p>
<p>CDN是个古老的东西，在互联网发展之初就已经出现了。一群MIT的精英份子发现如果要让任何地方的人都可以很快的打开自己的网站的话，就需要象在世界各地盖教堂一样，把自己的网页发布到离信众最近的地方去。所以，他们用一种简单的缓存镜像的办法实现了这种发布。最早的入主这个教堂网络的是Yahoo！那是在1998年。就像天做良缘，Yahoo！使用了当时世界上最大的CDN网络，当然现在他还是最大的。啊，忘了解释：CDN是内容投递网络（Content Delivery Network）的简称。我们可以在Wiki上面轻易找到这个单词的解释，但并不是所有人都能轻易理解CDN和它的意义，因为它是一个架接在互联网与传统电信运营商之间的看不见的桥梁。</p>
<p>让我们继续回顾互联网与CDN在那耀眼的一瞬之后的日子，互联网经历了泡沫的破裂，新模式的创新，但CDN却好像渐渐的被人遗忘了。我们熟悉的portal，垂直portal，鼠标加水泥，B2B，C2C，B2C，P2P,Web2.0，搜索，竞价排名，Page Ranking, RSS，Wiki，Meshup，podcasting，网络游戏，Social Network……那么多我们耳熟能详的名词，或者其实并不明白其中的真正意思，但在炫耀自己的互联网阅历的时候随口说出的几个里面，唯独没有CDN……直到短视频的出现。</p>
<p>当YouTube出现在世人面前的时候，人们为互联网的又一次革命而叫好，而与此同时，人们看到了在YouTube后面的一个强大的CDN支持，是这个CDN网络把YouTube的无数视频展现在人们面前，在这个时候，人们发现CDN是不可或缺的，CDN在经历了那么长时间的默默无闻以后，突然一夜间闻达于诸侯，就象君士坦丁大帝把天主教定为国教一样，大家突然认识到了一个不为人熟知的领域。但我们看到的是什么呢？君士坦丁介绍给罗马的天主教是耶稣创立时的教义么？我们所看到的CDN是MIT创立时的CDN么？</p>
<p>人们开始搜索CDN，研究CDN，发现CDN是那么的简单，可以用一页PPT就把原理讲的清清楚楚，而网络硬件的厂商也会这样和互联网的客户说，我们可以提供完整的CDN解决方案，你不需要做什么，买我们的硬件，它已经能够解决你所有的CDN问题。</p>
<p>从此，CDN变成了一个流行词汇，尤其是在高盛领投LimeLight（全球第二大CDN公司）1.2亿美金之后，突然之间，世界各地都出现了大大小小的CDN公司，无数的投资蜂拥而至，就像那时的罗马，人人都开始信仰天主教，也许是真的信仰，也许是为了圣餐，也许是为了研究，总之，“我们都爱CDN”。</p>
<p>也许有人问：我们谈论的是同一个CDN么，或者我们谈论的不是CDN？</p>
<p>当我们在说CDN的时候，所有的公司都是谈到两个偶像，就像谈耶稣和圣母一样，一个是Akamai（世界第一大CDN公司）,一个就是LimeLight。所以，阵营就分开来了，要么介绍自己是师从Akamai，要不就说自己是LimeLight的真传弟子，尽管大部分这么说的人几乎没有见过Akamai和LimeLight的网络和服务，但并不影响大家对自己的夸耀和标榜。而CDN是什么却越来越没有人关注，哪怕是LimeLight和Akamai的区别也被人忽略了。我们每一个谈论CDN的人谈论的是同一个概念么？</p>
<p>CDN是有专利的，这一点与天主教的圣经不同，CDN的解释是可以通过查询这些文件发现的。CDN在利用DNS的转授权来引导最终访问者找到最理想的缓存或者镜像站点，它是基于域名的一种服务。在不同的实现方式下，最终的定位到哪个缓存和镜像站点的策略有很大的不同。Akamai使用的是传统的基于地理位置的定位策略，在世界各地的ISP里面，都会有自己的节点，而通过智能DNS的判断，可以为用户找到离自己地理位置“最近”的节点。而LimeLight则用的是完全不同的策略，LimeLight有自己的骨干网，给访问者的节点并不是地理位置“最近”的节点，而是路由层面“最近”的节点，这一点有点像我们访问网站不通过域名而直接通过IP访问一样，它会寻找对于访问者的ISP最近的路由是哪里，用那里的节点服务于这个访问。LimeLight的策略已经在很大程度上改变了CDN的工作方式，所以，当LimeLight准备上市的时候，谁都会认为他们已经绕过了Akamai的专利壁垒，但不幸的是，之后他们还是遇到了诉讼的麻烦，或许因为DNS转授权是无法改变的……</p>
<p>在这样的壁垒下面，任何做CDN的公司都好像要面对宗教法庭一样，要么被烧死，要么就皈依。所以，有好事者想我们如果使用其他的方式做CDN该有多好？我们既然可以把驴弄进贵州，为什么不能把P2P融进CDN？我记得一位Akamai的高管对我说过，那不是CDN，CDN是透明的……，所以，让我们忘了P2PCDN吧……。也许还没有人搞清楚P2P和CDN的关系，那么Cloud呢？也许是个好主意。但实际上客户已经在自己发展他们认为的CDN了，其中也包括所谓的P2P CDN。</p>
<p>那么CDN真的象我们想象的那么美好么？就像天国王朝里面的圣地？</p>
<p>当年的《天国王朝》，无数的十字军涌向耶路撒冷，那里是天国，是一个可以让灵魂升华与遍地黄金的地方，但生活在圣城的人们却发现事实与理想相去甚远……，现在人们涌向CDN，是因为它是一个看起来很美的行业，但实际上如何呢？</p>
<p>自从CDN成为一个业内的大众词汇，CDN服务就像卖白菜一样了，几乎没有人关心你的CDN和别人的CDN有什么差别，只是问多少钱1M，多少钱1G，好用么？回答的也是那么的合乎情理：你可以试试，不好不要钱。</p>
<p>另一方面，CDN客户的流失率从来没有下过10%，高的公司可以达到20%-30%，测试客户更是今天测，明天走。正是因为这样，客户基本上找不到满足要求的CDN公司，从而让很多人开始质疑CDN本身有问题，甚至突然觉得CDN应该是一个夕阳产业。</p>
<p>好在中国但凡叫得出名字的CDN公司，这几年的收入都是翻翻的，虽然利润少的可怜，而且那些利润也不是从CDN业务中获得的……</p>
<p>但我们同时发现在美国的Akamai却有着不同的表现，2007年6亿美金的销售额，1亿美金的纯利润，毛利更是超过40%，2008年至少有30%的成长。难道美国是CDN的天国，而中国就是被异教践踏的土地？还是我们并没有看到CDN真正的一面？就像柏拉图所描绘的山洞，我们看到只是火光照耀的影子？</p>
<p>事实上，互联网出现以来，只有CDN是没有海外公司进入中国市场的互联网业务，而正是这样的安排或者壁垒，让中国的CDN与海外的CDN有着巨大的差别。</p>
<ul>
  <li>美国的CDN与中国CDN的对比</li>
</ul>
<p>在美国，CDN领域里面会有这样一些分类：静态内容的加速，动态内容的加速，大文件下载加速；对不同的客户类型，还会有不同的系统与之对应，比如SSL加速，Long Tail加速，Streaming加速；而对不同行业客户也会有不同的加速系统，比如媒体类客户加速，电子商务类客户加速，软件与IT行业客户的加速等等。甚至于对不同的客户规模也会有不同的系统与之对应：大流量客户的加速，中小客户的加速，甚至个人客户的加速；CDN的系统是一个庞杂而专业性非常强的领域。在这些领域与系统中，所有的功能甚至网络都是不一样的，配置的系统也是不一样的。</p>
<p>但在中国，这些系统的差别大部分是在售前的嘴里和不知所云的白皮书里面。而网络都是一个，功能都是一个，实现方式也是一个，所以就会出现如果一家CDN公司做不了一个功能，几乎所有的CDN公司都做不到，因为大家都是用最“通用的方式构建自己的通用CDN”，从而使中国CDN成为一个从电信转卖带宽的代理商。</p>
<p>我们发现了几个有趣的小例子：</p>
<p>中国的网站很注意防盗链（虽然并不注意防盗版），但是居然没有哪家CDN公司可以提供一个让客户满意的防盗链的系统，虽然各家都在说自己提供防盗链。就象我的一个做远程教育的朋友和我说的一样，“测试了能够叫得出名字的所有的CDN公司，但却没有一家CDN公司可以做好防盗链。”但在Akamai，这是一个很久就标准化的服务了。</p>
<p>中国是一个游戏和软件下载的大国，互联网上的主要流量是下载，而直到最近，国内的CDN公司才开始可以提供基于HTTP下载成功数的统计功能，而且还不是全自动的，是需要客户配合设置才可以使用。同样，在Akamai，这也是基本服务项目。</p>
<p>再有一个例子与视频有关了，短视频网站使用的Flash视频，在用户端是和文件下载没有区别的，用户会尽可能快的去下载完视频文件，而通常播放一个视频只需要300K码流就可以流畅播放，这样会有两种情况导致资源的浪费，第一、用户看视频并没有看完，但下载已经下载完了；第二、用户如果是宽带接入的话，虽然只需要300K带宽，可实际上却使用了1M。对于最终用户来说，这两点几乎不会有什么实际影响，但对视频网站来说，这意味着浪费了宝贵的带宽资源，在同等条件下支付了更多的成本。这与上面谈到的HTTP下载成功数计费是一个道理。而在美国，CDN公司是可以控制每个HTTP链接的速度，比如在开始播放的前30秒，1分钟不进行限速，而超过这个时间，就可以把速度控制在需要的范围内，以节省带宽资源。</p>
<p>至于SLA（服务等级协议），就更加的有趣，通常在中国的SLA是不会作为依据的，而评估好坏的标准是“你自己上网看看就知道了么”，这是中国现在一家发展很快的CDN公司的老总的看法。奇怪的是，使用CDN之后，没有哪家客户有能力在去进行所有地区的测试，看一下自己的网站是否比原来快。在这样的情况下，有些做论坛的客户就会发动自己在各地的版主进行测试，收集意见，然后再告诉CDN公司，你们哪里哪里不好，能否调一下？我们的CDN服务商然后说，“噢，你先给我们解释你是怎么测试的？给我一个你们测试的IP，我看看是不是不是中国的IP啊，千万不要给我你自己机器的IP，要给我LocalDNS的IP……，不知道LocalDNS？怎么连这个都不知道呢？……那是……”（其实我个人觉得还应该问问版主是不是中国人，也许这样更容易发现问题），我只能说，这是多好的客户啊……，在美国的CDN服务商会感动的掉泪的。</p>
<p>在美国，用户会每天得到一份SLA报告，会标出在什么时间段SLA没有达到标准，如果用户需要，还会给用户具体哪个区域没有达到SLA标准，而所有的这些，都只需要用户登录到BOSS的portal上面。</p>
<p>类似的例子还有很多，比如流的点播加速，长尾市场，小图片的加速等等。这些服务功能的差别也许还不是最主要的，而成本的控制与自动化的运营却是CDN公司能否盈利的关键，Akamai部署一个客户只需要10分钟，而国内部署需要客户在填写复杂的表格后，耐心的等待1天时间；Akamai管理上万台服务器只需要4个人，任何时间10%的服务器宕机都无需处理，因为系统会自动保证服务的可靠运行并自主恢复，而国内最小的CDN公司运维人员也有几十个，并且疲于应付各种“突发”事件。</p>
<p>现在，也许我们应该提一个建议，开放中国的CDN市场，让大部分中国的网站都可以看到真正的CDN服务是什么样子。</p>
<p>到这里，其实我们忽略了一个重要的问题，需求！中国的客户使用CDN很多时候是希望以此解决南北互通的问题，而美国客户没有这个问题，他们使用CDN首要考虑的是off load和降低成本。在有人发现有其他更加经济实惠的方案之后，CDN在米国的日子好像也不好过了。</p>
<ul>
  <li>CDN被逐出了圣地？</li>
</ul>
<p>BT的出现对媒体行业来说是打开了一个盒子（也许是潘多拉，也许是宝盒），盗版的发行比以往任何时候都要快，成本也更低；而同时，视频直播也达到了前所未有的低成本，我们也许还记得在P2P客户端上看欧洲杯，看NBA，看奥运，如果是换成CDN，任何公司都会无法负担。</p>
<p>在看看客户情况，伟大的Google是一个什么事情都要insource的公司，它从来不使用CDN，但它的服务遍及全球，Amazon的EC2，SaleForce的CRM系统，SecondLife的虚拟世界，他们都没有在CDN上，但他们同样出色，而且看起来更有效率，成本更低。</p>
<p>现在，已经没有人会考虑使用CDN做大规模的直播服务了，充其量是作为一个备份手段；而自从YouTube离开LimeLight以后，CDN的光环也开始慢慢退去，VC和投机者开始又一股脑的质疑这个奇怪的生意，CDN有价值么？为什么盈利这么困难呢？就像勇猛的萨拉丁赶走了十字军一样，难道CDN会被P2P和不断升级的光纤所取代？还是象经过改革的宗教一样，即使历经文艺复兴与科技的反复冲击，而今依然影响着无数的人们。</p>
<ul>
  <li>CDN的宗教革命？</li>
</ul>
<p>我们之所以把CDN比作宗教，是因为CDN到现在也有很多“流派”，LimeLight的大节点，大带宽的做法被许多IDC与运营商背景的公司所推崇，而传统的Akamai模式则是独立于运营商之外的CDN公司所首选的道路；而各种新奇理念的出现更是让CDN行业象是一个万花筒，从而也使其拥有更多的互联网气息。Amazon的CloudFront，EC2；Level 3的ITM；Prime的CDN Aggregation，CDTM；SimpleCDN的S3+等等，如此众多的演变，任何一种都是对传统CDN，甚至是对LimeLight模式的革命。感谢LimeLight与Akamai的成功，让很多优秀的工程师与天才的梦想家投入到CDN这个被Akamai一家统治多年的领域，并不断给我们与CDN客户以惊喜。但当我们把目光从美国看回中国的时候（上述所有的公司都是美国企业），我们要面对的是什么样的现实？</p>
<p>中国的CDN是CDN的佛教还是道教？还是象柏阳说得被中国这个大染缸去其精华留其糟粕的垃圾？</p>
<p>说道中国的CDN，我们可能要问：什么时候CDN开始没人关注SLA？什么时候CDN开始不提供标准的95/5计费？什么时候，全网配置的服务被悄悄替换成了“部分”节点配置？什么时候，CDN变成了一个黑匣子，客户无从了解自己的服务与问题，也无法控制自己的内容的发布与刷新（美国的CDN客户是可以直接自己设置3段TTL时间的）。这些我们无从而知，因为可能从我们开始认识中国CDN的时候就已经是这个样子了。</p>
<p>所以这些后来的中国的CDN厂商第一件要做的事情就是鼓吹自己的节点数量，而不管是否这些节点都为所有客户提供服务（客户甚至不知道有几个节点在为自己服务。PS：一般情况下，中国CDN公司为每个客户配置的节点不会超过20个）</p>
<p>所以，当海外的CDN公司在网站上介绍其服务的时候，中国客户通常很难找到他们全球有多少节点的信息，而中国CDN公司则乐此不疲的修改自己的节点地图，也不管地图画得就像一张地雷分布图。而销售人员更是信口开河的讲自己的公司有几百个节点，可笑的是，几乎所有的CDN公司都有“几百”个节点，全中国的IDC恐怕都不够这些CDN公司瓜分的了。</p>
<p>中国CDN已经把CDN本土化了，经常挂在嘴边的是外国公司不了解中国的网络，也许是吧，但到现在为止，没有一家本土CDN公司可以解决教育网的服务质量问题。而大部分的客户到CDN节点机房看到的情况是：“哦，怎么你们在使用和我们自己一样的系统？！”这是为什么呢？因为中国的CDN公司认为CDN是运营业务，就像中国移动，中国电信一样，最主要的是运营；</p>
<p>而象Akamai这样的美国CDN公司首先认为自己是技术公司，然后才是运营公司，Akamai的系统从底层到应用是自己开发的，所有的服务是自己开发的，所有的控制与监管是自己开发的，甚至在早期，连硬件都要自己开发。我记得一位VC界的著名人物这样评价在中国很出名的CDN企业：“他们没有技术”。这就是中国CDN与美国CDN公司的最大差距。那我们要问，难道十几年中国CDN的发展就白费了么？当然不是的，中国的CDN在花费了大量的时间在处理用户的客户化需求，可惜这些需求主要表现在计费领域，有的CDN公司居然有上百种计费方式。</p>
<p>而对于CDN的黑盒子问题（即用户看不到及时全面的数据），就像佛教的禅宗一样，一句“不可说”，客户也没有任何办法。而对于道教的无为则通常会用在对付客户的投诉上面。当然，这是不能责怪CDN的运营人员的，即使在CDN如火如荼的年代，能够说清楚CDN的具体情况与细节的人也还是少之又少。记得上面提到的发展很快的那家CDN公司的老总说到视频：“我们觉得视频是一个很简单的服务，根本没有难度”，但当客户测试他们视频服务，却选择了其他运营商之后，已经很少听到这种气壮山河的言论了。</p>
<p>中国的CDN虽然经历了很长的时间，但却没有真正的积累下来，而本土化，或者异化的CDN使本来就难于理解的CDN服务被断章取义的成为一个Cache和带宽的替代词汇。</p>
<p>而事实上，真正的CDN服务或者CDN的本来面目我们也许就从没有见到，就像中国的网站编程，在IE下看的好好的，但是换了浏览器就全乱了，这才发现原来没有按照W3C标准编写，而问题是很多的编程人员根本就没看过这些标准，所以也就不知道原来IE并不是严格遵照W3C解析与渲染的。</p>
<pre><code>To be, or not to be: that is the question！
</code></pre>
<p>当莎士比亚的这句名言作为出现在这里的时候，我们应该考虑的是CDN的未来，还是中国CDN的未来？</p>
<p>让我们在更高的层面来看待如今的年代，越来越多的闪光点出现在这个领域，就像在Google出现之前，没有人关注搜索一样，CDN有可能成为第二个孕育奇迹的行业。CDN伴随着互联网的成长起起落落，现在的服务已经不仅仅局限在内容的分发，越来越多的CDN公司开始提供以复杂分布式存储为核心的存储网络服务，Amazon的S3是一个典型的代表，而Prime的FileGrid则是另一个值得关注的方向。Amazon在这个领域已经耕耘多年，虽然不是一个CDN公司，但实际上的服务内容已经涵盖了CDN服务，而其基于运计算的EC2服务更是现在可以使用的唯一的“云”了。有人说云计算就是CDN的未来，这也许还很远，Bill Gate的话也许更有道理：“云存储离我们更近一些”。无论是云计算还是云存储，对于CDN公司来说，都要比其他任何行业的公司都要靠近云端，而CDN的路线图也一定会是这样的发展，从内容网络到存储网络再到计算网络，而未来的CDN也会象使用电灯一样容易。</p>
<p>对于CDN的未来憧憬，另外的方向就是CDN云，尽管只是一个概念，但确实是一个很宏伟的想法，虽然现在可以看到的服务只有Prime的CDTM，或许这是CDN云的初级阶段──一个利用众多的CDN网络构建一个更高效成本控制更好与更智能的网络，但谁能够忽视这令人兴奋的进步与想象力？</p>
<p>在中国，各家CDN公司都开始大力开发自己的产品，也从没有象现在这样重视研发。而Akamai，CDNetwork已经开始进入中国；Prime也开始在中国展开一些试探。中国的客户已经开始体验到不同的服务，有的CDN公司提出的SLA至少看起来已经是一份有价值或者是可以度量的标准文件了。虽然路还是有些漫长，但相信中国的客户将会很快体验到世界水准的CDN服务，以及天才工程师们所创造的更多令人兴奋的网络产品。</p>
<p>中国乃至世界CDN领域的大变革正发生在我们身边，也许明天你就会看到一个不同的CDN来到你的眼前。</p>
      <a href="/2009/12/27/zz-diff-cdn-between-china-and-usa" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/12/13/show-some-common-apps-compiler-options" title="查看一些常见应用的编译选项" rel="bookmark">查看一些常见应用的编译选项</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-13 00:00:00 +0800">13 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <ul>
  <li>nginx：</li>
</ul>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>rao@localhost ~<span class="o">]</span><span class="nv">$ </span>/home/nginx/sbin/nginx -V|grep conf
nginx version: 0.7.54
built by gcc 4.1.2 20080704 <span class="o">(</span>Red Hat 4.1.2-44<span class="o">)</span>
configure arguments: --prefix<span class="o">=</span>/home/nginx --with-pcre
--with-http_stub_status_module --without-http_memcached_module
--without-http_fastcgi_module
apache:
<span class="o">[</span>rao@localhost ~<span class="o">]</span><span class="nv">$ </span>cat /home/apache2/build/config.nice
<span class="c">#! /bin/sh</span>
<span class="c">#</span>
<span class="c"># Created by configure</span>
<span class="nv">CFLAGS</span><span class="o">=</span><span class="s2">&quot;-D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64&quot;</span>; <span class="nb">export</span>
CFLAGS
<span class="s2">&quot;./configure&quot;</span>
<span class="s2">&quot;--prefix=/home/apache2&quot;</span>
<span class="s2">&quot;--enable-static-support&quot;</span>
<span class="s2">&quot;--enable-rewrite&quot;</span>
<span class="s2">&quot;--with-mpm=worker&quot;</span>
<span class="s2">&quot;--enable-logio&quot;</span>
<span class="s2">&quot;--enable-so&quot;</span>
<span class="s2">&quot;--enable-mime-magic&quot;</span>
<span class="s2">&quot;--disable-cgid&quot;</span>
<span class="s2">&quot;--disable-cgi&quot;</span>
<span class="s2">&quot;--disable-userdir&quot;</span>
<span class="s2">&quot;--disable-dir&quot;</span>
<span class="s2">&quot;--disable-include&quot;</span>
<span class="s2">&quot;--disable-filter&quot;</span>
<span class="s2">&quot;--disable-env&quot;</span>
<span class="s2">&quot;--disable-setenvif&quot;</span>
<span class="s2">&quot;--disable-status&quot;</span>
<span class="s2">&quot;--disable-autoindex&quot;</span>
<span class="s2">&quot;--disable-asis&quot;</span>
<span class="s2">&quot;--disable-alias&quot;</span>
<span class="s2">&quot;--disable-actions&quot;</span>
<span class="s2">&quot;--disable-authn-file&quot;</span>
<span class="s2">&quot;--disable-authn-default&quot;</span>
<span class="s2">&quot;--disable-authz-default&quot;</span>
<span class="s2">&quot;--disable-authz-groupfile&quot;</span>
<span class="s2">&quot;--disable-authz-user&quot;</span>
<span class="s2">&quot;--disable-auth-basic&quot;</span>
<span class="s2">&quot;CFLAGS=-D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64&quot;</span>
<span class="s2">&quot;$@&quot;</span>
</code></pre></div>
<ul>
  <li>php:</li>
</ul>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>rao@localhost ~<span class="o">]</span><span class="nv">$ </span>php -i|grep configure
Configure <span class="nv">Command</span> <span class="o">=</span>&gt;  <span class="s1">&#39;./configure&#39;</span>
<span class="s1">&#39;--build=x86_64-redhat-linux-gnu&#39;</span> <span class="s1">&#39;--host=x86_64-redhat-linux-gnu&#39;</span>
<span class="s1">&#39;--target=x86_64-redhat-linux-gnu&#39;</span> <span class="s1">&#39;--program-prefix=&#39;</span>
<span class="s1">&#39;--prefix=/usr&#39;</span> <span class="s1">&#39;--exec-prefix=/usr&#39;</span> <span class="s1">&#39;--bindir=/usr/bin&#39;</span>
<span class="s1">&#39;--sbindir=/usr/sbin&#39;</span> <span class="s1">&#39;--sysconfdir=/etc&#39;</span> <span class="s1">&#39;--datadir=/usr/share&#39;</span>
<span class="s1">&#39;--includedir=/usr/include&#39;</span> <span class="s1">&#39;--libdir=/usr/lib64&#39;</span>
<span class="s1">&#39;--libexecdir=/usr/libexec&#39;</span> <span class="s1">&#39;--localstatedir=/var&#39;</span>
<span class="s1">&#39;--sharedstatedir=/usr/com&#39;</span> <span class="s1">&#39;--mandir=/usr/share/man&#39;</span>
<span class="s1">&#39;--infodir=/usr/share/info&#39;</span> <span class="s1">&#39;--cache-file=../config.cache&#39;</span>
<span class="s1">&#39;--with-libdir=lib64&#39;</span> <span class="s1">&#39;--with-config-file-path=/etc&#39;</span>
<span class="s1">&#39;--with-config-file-scan-dir=/etc/php.d&#39;</span> <span class="s1">&#39;--disable-debug&#39;</span>
<span class="s1">&#39;--with-pic&#39;</span> <span class="s1">&#39;--disable-rpath&#39;</span> <span class="s1">&#39;--without-pear&#39;</span> <span class="s1">&#39;--with-bz2&#39;</span>
<span class="s1">&#39;--with-curl&#39;</span> <span class="s1">&#39;--with-exec-dir=/usr/bin&#39;</span> <span class="s1">&#39;--with-freetype-dir=/usr&#39;</span>
<span class="s1">&#39;--with-png-dir=/usr&#39;</span> <span class="s1">&#39;--enable-gd-native-ttf&#39;</span> <span class="s1">&#39;--without-gdbm&#39;</span>
<span class="s1">&#39;--with-gettext&#39;</span> <span class="s1">&#39;--with-gmp&#39;</span> <span class="s1">&#39;--with-iconv&#39;</span> <span class="s1">&#39;--with-jpeg-dir=/usr&#39;</span>
<span class="s1">&#39;--with-openssl&#39;</span> <span class="s1">&#39;--with-png&#39;</span> <span class="s1">&#39;--with-pspell&#39;</span>
<span class="s1">&#39;--with-expat-dir=/usr&#39;</span> <span class="s1">&#39;--with-pcre-regex=/usr&#39;</span> <span class="s1">&#39;--with-zlib&#39;</span>
<span class="s1">&#39;--with-layout=GNU&#39;</span> <span class="s1">&#39;--enable-exif&#39;</span> <span class="s1">&#39;--enable-ftp&#39;</span>
<span class="s1">&#39;--enable-magic-quotes&#39;</span> <span class="s1">&#39;--enable-sockets&#39;</span> <span class="s1">&#39;--enable-sysvsem&#39;</span>
<span class="s1">&#39;--enable-sysvshm&#39;</span> <span class="s1">&#39;--enable-sysvmsg&#39;</span> <span class="s1">&#39;--enable-track-vars&#39;</span>
<span class="s1">&#39;--enable-trans-sid&#39;</span> <span class="s1">&#39;--enable-yp&#39;</span> <span class="s1">&#39;--enable-wddx&#39;</span>
<span class="s1">&#39;--with-kerberos&#39;</span> <span class="s1">&#39;--enable-ucd-snmp-hack&#39;</span>
<span class="s1">&#39;--with-unixODBC=shared,/usr&#39;</span> <span class="s1">&#39;--enable-memory-limit&#39;</span>
<span class="s1">&#39;--enable-shmop&#39;</span> <span class="s1">&#39;--enable-calendar&#39;</span> <span class="s1">&#39;--enable-dbx&#39;</span> <span class="s1">&#39;--enable-dio&#39;</span>
<span class="s1">&#39;--with-mime-magic=/usr/share/file/magic.mime&#39;</span> <span class="s1">&#39;--without-sqlite&#39;</span>
<span class="s1">&#39;--with-libxml-dir=/usr&#39;</span> <span class="s1">&#39;--with-xml&#39;</span> <span class="s1">&#39;--with-system-tzdata&#39;</span>
<span class="s1">&#39;--enable-force-cgi-redirect&#39;</span> <span class="s1">&#39;--enable-pcntl&#39;</span> <span class="s1">&#39;--with-imap=shared&#39;</span>
<span class="s1">&#39;--with-imap-ssl&#39;</span> <span class="s1">&#39;--enable-mbstring=shared&#39;</span>
<span class="s1">&#39;--enable-mbstr-enc-trans&#39;</span> <span class="s1">&#39;--enable-mbregex&#39;</span>
<span class="s1">&#39;--with-ncurses=shared&#39;</span> <span class="s1">&#39;--with-gd=shared&#39;</span> <span class="s1">&#39;--enable-bcmath=shared&#39;</span>
<span class="s1">&#39;--enable-dba=shared&#39;</span> <span class="s1">&#39;--with-db4=/usr&#39;</span> <span class="s1">&#39;--with-xmlrpc=shared&#39;</span>
<span class="s1">&#39;--with-ldap=shared&#39;</span> <span class="s1">&#39;--with-ldap-sasl&#39;</span> <span class="s1">&#39;--with-mysql=shared,/usr&#39;</span>
<span class="s1">&#39;--with-mysqli=shared,/usr/bin/mysql_config&#39;</span> <span class="s1">&#39;--enable-dom=shared&#39;</span>
<span class="s1">&#39;--with-dom-xslt=/usr&#39;</span> <span class="s1">&#39;--with-dom-exslt=/usr&#39;</span>
<span class="s1">&#39;--with-pgsql=shared&#39;</span> <span class="s1">&#39;--with-snmp=shared,/usr&#39;</span>
<span class="s1">&#39;--enable-soap=shared&#39;</span> <span class="s1">&#39;--with-xsl=shared,/usr&#39;</span>
<span class="s1">&#39;--enable-xmlreader=shared&#39;</span> <span class="s1">&#39;--enable-xmlwriter=shared&#39;</span>
<span class="s1">&#39;--enable-fastcgi&#39;</span> <span class="s1">&#39;--enable-pdo=shared&#39;</span>
<span class="s1">&#39;--with-pdo-odbc=shared,unixODBC,/usr&#39;</span>
<span class="s1">&#39;--with-pdo-mysql=shared,/usr&#39;</span> <span class="s1">&#39;--with-pdo-pgsql=shared,/usr&#39;</span>
<span class="s1">&#39;--with-pdo-sqlite=shared,/usr&#39;</span> <span class="s1">&#39;--enable-dbase=shared&#39;</span>
</code></pre></div>
<ul>
  <li>mysql:
据网上都说是cat /usr/bin/mysqlbug|grep conf，但我这的结果是压根没用……</li>
</ul>
      <a href="/2009/12/13/show-some-common-apps-compiler-options" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/12/04/magic-of-quotes" title="引号的魔力" rel="bookmark">引号的魔力</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-12-04 00:00:00 +0800">04 Dec 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@neteasesquid1 ~<span class="o">]</span><span class="c"># i=1.2.3.4;awk -v OFS=&quot;tt&quot; &#39;BEGIN{print &#39;&quot;$i&quot;&#39;,&quot;&#39;&quot;$i&quot;&#39;&quot;,&quot;&#39;$i&#39;&quot;,&quot;&quot;&#39;$i&#39;&quot;&quot;}&#39;</span>
1.20.30.4
1.2.3.4
1.2.3.4
1.20.30.4
</code></pre></div>
<p>以前用awk调用shell变量时，一般都是文字字符串，看不出什么问题来；今天突然用上ip，发现输出结果显示不正常。于是做了如上实验。
但是原因嘛，还是不知道……
继续做下一个实验：</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>rcl@ubuntu:/win/learning/myshell<span class="o">]</span><span class="nv">$ i</span><span class="o">=</span>1.2.3;echo <span class="s2">&quot;1.2.3.4&quot;</span>|awk <span class="s1">&#39;/&#39;</span><span class="s2">&quot;$i&quot;</span><span class="s1">&#39;/{print}&#39;</span>
1.2.3.4
<span class="o">[</span>rcl@ubuntu:/win/learning/myshell<span class="o">]</span><span class="nv">$ i</span><span class="o">=</span>1.2.3;echo <span class="s2">&quot;1.2.3.4&quot;</span>|awk <span class="s1">&#39;/&quot;&#39;</span><span class="nv">$i</span><span class="s1">&#39;&quot;/{print}&#39;</span>
<span class="o">[</span>rcl@ubuntu:/win/learning/myshell<span class="o">]</span><span class="nv">$ i</span><span class="o">=</span>1.2.3;echo <span class="s2">&quot;1.2.3.4&quot;</span>|awk <span class="s1">&#39;/&#39;</span><span class="s2">&quot;$i&quot;</span><span class="s1">&#39;/{print &quot;&#39;</span><span class="nv">$i</span><span class="s1">&#39;&quot;}&#39;</span>
1.2.3
<span class="o">[</span>rcl@ubuntu:/win/learning/myshell<span class="o">]</span><span class="nv">$ i</span><span class="o">=</span>1.2.3;echo <span class="s2">&quot;1.2.3.4&quot;</span>|awk <span class="s1">&#39;/&#39;</span><span class="s2">&quot;$i&quot;</span><span class="s1">&#39;/{print &#39;</span><span class="s2">&quot;$i&quot;</span><span class="s1">&#39;}&#39;</span>
1.20.3
<span class="o">[</span>rcl@ubuntu:/win/learning/myshell<span class="o">]</span><span class="nv">$ i</span><span class="o">=</span>1.2.3;echo <span class="s2">&quot;1.20.3.4&quot;</span>|awk <span class="s1">&#39;/&#39;</span><span class="s2">&quot;$i&quot;</span><span class="s1">&#39;/{print}&#39;</span>
<span class="o">[</span>rcl@ubuntu:/win/learning/myshell<span class="o">]</span><span class="nv">$ i</span><span class="o">=</span>1.2.3;echo <span class="s2">&quot;1.20.3.4&quot;</span>|awk <span class="s1">&#39;/&quot;&#39;</span><span class="nv">$i</span><span class="s1">&#39;&quot;/{print}&#39;</span>
</code></pre></div>
<p>所以最终结果，在regex里，awk引用shell变量是&rsquo;&ldquo;$i&rdquo;&lsquo;，而在&rsquo;{}&rsquo;里则要写成&rdquo;&lsquo;$i&rsquo;&ldquo;。乱呀……</p>
      <a href="/2009/12/04/magic-of-quotes" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/23/sub-commands-in-sed" title="sed子命令集" rel="bookmark">sed子命令集</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-23 00:00:00 +0800">23 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#bash-ref" title="bash" rel="category tag">bash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>1．：
用法：
：lable
在脚本中标记一行，用于实现由b或t的控制转移。Label最多可以包含7个字符</p>
<p>2．=
用法：
=[address]=
将所寻址的行编写到标准输出</p>
<p>3．a
用法：
[address]a
text
在与address匹配的每行后面追加text。如果text多于一行，必须用反斜杠将这些行前面的换行符“隐藏”起来。Text将被没有用这种方法隐藏的第一个换行符结束。Text在模式空间中是不可用的并且后续的命令不能应用于它。当编辑命令的列表用完时，这个命令的结果将被输送到标准输出，而不管在模式空间中的当前行发生了什么。</p>
<p>4．b
用法：
[address1[,address2]]b[label]
无条件地将控制转移到脚本的其他位置的：label处。也就是说，label后面的命令是应用于当前行的下一个命令。如果没有指定label,
控制将一直到达脚本的末端，因此不再有命令作用于当前行。</p>
<p>5．c
用法：
[address1[,address2]]c
text
用text替代（改变）由地址选定的行。当指定的是一个行范围时，将所有的这些行作为一个组由text的一个副本来替代。每个text行后面的换行符必须用反斜杠将其转义，但最后一行除外。实际上，模式空间的内容被删除，因此后续的命令不能应用于它（或应用于text）</p>
<p>6．d
用法：
[address1[,address2]]d
从模式空间中删除行。因此行没有传递到标准输出。一个新的输入行被读取，并用脚本的第一个命令来编辑。</p>
<p>7．D
用法：
[address1[,address2]]D
删除由命令N创建的多行模式空间中的一部分（直到嵌入的换行符），并且用脚本的第一条命令恢复编辑。如果这个命令使模式空间为空，那么将读取一个新的输入行，和执行了d命令一样。</p>
<p>8．g
用法：
[address1[,address2]]g
将保持空间（参见h或H命令）中的内容复制到模式空间中，并将当前的内容清除。
9．G
用法：
[address1[,address2]]G
将换行符后的保持空间（参见h或H命令）内容追加到模式空间。如果保持空间为空，则将换行符添加到模式空间。
10．h
用法：
[address1[,address2]]h
将模式空间的内容复制到保存空间，即一个特殊的临时缓冲区。保存空间的当前内容被清除。
11．H
[address1],address2]]H
将换行符和模式空间的内容追加到保持空间中，即使保持空间为空，这个命令也追加换行符。
12．i
用法：
[address1]i
text
将text插入到每个和address匹配的行的前面
13．l
用法：
[address1[,address2]]l
列出模式空间的内容，将不可打印的字符表示为ASCII码。长的行被折行。
14．n
用法：
[address1[,address2]]n
读取下一个输入行到模式空间。当前行被送到标准输出。新行成为当前行并递增行计数器。将控制转到n后面的命令，而不是恢复到脚本的顶部。
15．N
用法：
[address1[,address2]]N
将下一个输入行追加到模式空间的内容之后；新添加的行与模式空间的当前内容用换行符分隔（这个命令用于实现跨两行的模式匹配。利用n来匹配嵌入的换行符，则可以实现多行匹配模式）。
16．p
用法：
[address1[,address2]]p
打印所寻址的行。注意这将导致输出的重复，除非默认的输出用”#n”或”-n”命令行选项限制。常用于改变流控制（d,n,b）的命令之前并可能阻止当前行被输出。
17．P
用法：
[address1[,address2]]P
打印由命令N创建的多行模式空间的第一部分（直接嵌入的换行符）。如果没有将N应用于某一行则和p相同。
18．q
用法：
[address]q
当遇到address时退出。寻址的行首先被写到输出（如果没有限制默认输出），包括前面的a或r命令为它追加的文本。
19．r
用法：
[address]r file
读取file的内容并追加到模式空间内容的后面。必须在r和文件名file之间保留一个空格。
20．s
用法：
[address1[,address2]]s/pattern/replacement/[flags]
用replacement代替每个寻址的pattern。如果使用了模式地址，那么模式//表示最后指定的模式地址。可以指定下面的标志：</p>
<pre><code>n 替代每个寻址的行的第n个/pattern/。N是1到512之间的任意数字，并且默认值为1。
g 替代每个寻址的行的所有/pattern/，而不只是第一个
p 如果替换成功则打印这一行。如果成功进行了多个替换，将打印这个行的多个副本。
w file 如果发生一次替换则将这行写入file。最多可以打开10个不同的file。
</code></pre>
<p>replacement是一个字符串,用来替换与正则表达式匹配的内容.在replacement部分,只有下列字符有特殊含义:</p>
<p>&amp; 用正则表达式匹配的内容进行替换
n
匹配第n个子串(n是一个数字),这个子串以前在pattern中用&rdquo;(&ldquo;和&rdquo;)&rdquo;指定.
当在替换部分包含&rdquo;与&rdquo;符号(&amp;),反斜杠()和替换命令的定界符时可用转义它们.另外,它用于转义换行符并创建多行replacement字符串.</p>
<p>s/pattern/replacememt/flag
如果flag是数字,那么指定对一行上某个位置的匹配.如果没有数字标志,则替换命令只替换第一个匹配串,因此&rdquo;1&rdquo;可以被看作是默认的数字标志.</p>
<p>替换元字符是反斜杠()、与符号(&amp;)和n。</p>
<p>反斜杠一般用于转义其他的元字符，但是它在替换字符串中也用于包含换行符。
例如对于如下的行：
column1(制表符)column2(制表符)column3(制表符)column4
使用如下替换语句：
s/制表符//2
注意，在反斜杠的后面不允许有空格。这个脚本产生下面的结果：
column1(制表符)column2
column3(制表符)column4
&ldquo;与&rdquo;符号(&amp;)作为元字符表示模式匹配的范围,不是被匹配的行.例如下面的命令:
s/UNIX/s-2&amp;0/g
可以将输入行:
on the UNIX Operating System.
替换成:
on the s-2UNIXs0 Operating System.
当正则表达式匹配单词的变化时,&rdquo;与&rdquo;符号特别有用.它允许指定一个可变的替换字符串.诸如&rdquo;See Section 1.4&rdquo;或&rdquo;See Section 12.9&rdquo;的引用都应该出现在圆括号中，如&rdquo;(See Section 12.9)&rdquo;.正则表达式可以匹配数字的不同组合，所以在替换字符串中可以使用&rdquo;&amp;&rdquo;并括起所匹配的内容：
s/See Section [1-9][0-9]<em>.[1-9][0-9]</em>/(&amp;)/
这里&rdquo;与&rdquo;符号用于在替换字符串中引用整个匹配内容．
n元字符用于选择被匹配的字符串的任意独立部分，并且在替换字符串中回调它．在sed中转义的圆括号括住正则表达式的任意部分并且保存以备回调．一行最多允许保存９次．例如，当节号出现在交叉引用中时要表示为用粗体：
s/(See Section )([1-9][0-9]<em>.[1-9][0-9]</em>)/1fB2fp/
再来看另外一个例子：
$ cat test1
first:second
one:two
$ sed &lsquo;s/(.<em>):(.</em>)/2:1/ test1
second:first
two:one</p>
<p>21．t
用法：
[address1[,address2]]t[label]
测试在寻址的行范围内是否成功执行了替换，如果是，则转移到有label标志的行（参见b和:)。如果没有给出label，控制将转移到脚本的底部。</p>
<p>22．w
用法：
[address1[,address2]]w file
将模式空间的内容追加到file。这个动作是在遇到命令时发生而不是在输出模式空间内容时发生。必须在w和这个文件名之间保留一个空格。在脚本中可以打开的最大文件数是10。如果文件不存在，这个命令将创建一个文件。如果文件存在，则每次执行脚本时将改写其内容，多重写入命令直接将输出写入到同一个文件并追加到这个文件的末端。</p>
<p>23．x
用法：
[address1[,address2]]x
交换模式空间和保持空间的内容。</p>
<p>24．y
用法：
[address1[,address2]]y/abc/xyz/
按位置将字符串abc中的字符替换成字符串xyz中相应字符。</p>
      <a href="/2009/11/23/sub-commands-in-sed" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/22/a-dynamic-data-storage-solution-for-cdn-ubdp" title="一种CDN中的动态数据存储方案——UbDP" rel="bookmark">一种CDN中的动态数据存储方案——UbDP</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-22 00:00:00 +0800">22 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上回百度到这篇文章，于是上维普下载了来看，为方便阅读，贴在这里。</p>
<p>原文出处《计算机应用》2008年8月第28卷第8期：</p>
<hr />
<p><strong>一种CDN中的动态数据存储方案——UbDP
</strong>汤迪斌，王劲林，倪宏
(1．中国科学院研究生院，北京100039；2．中国科学院声学研究所国家网络新媒体工程技术研究中心，北京100080)
(<a href="mailto:tangdihin@gmail.com">tangdihin@gmail.com</a>)</p>
<p><strong>摘要：</strong>CDN对于动态Web应用的加速通常采用数据缓存或复制技术。针对论坛、博客服务提供商等为注册用户提供个人信息发布平台的网站，提出了一种基于用户的数据分割方法：将数据按所属注册用户进行分割，分布到离该用户最近的数据库系统中。将数据库UID操作分散到多个数据库系统，消除了单个数据库系统的I／O瓶颈。
<strong>关键词：</strong>内容分发网络；分布式数据库；数据缓存；动态Web应用
<strong>中图分类号：TP3l1.133.1  文献标志码：A</strong></p>
<p>0 引言
尽管网络带宽和服务器性能在不断改善，用户访问迟延过大一直是Web应用的一个重要问题。随着流媒体的出现，迟延问题变得更加严重。导致Internet上内容传送迟延过大的原因主要有两个：1)缺乏对Internet的全局管理；2)有限的网络带宽和服务器资源总是跟不上网络负载增长的脚步。解决这个性能问题的基本办法就是将内容移到离最终用户较近的边缘服务器上。内容分发网络(Content Delivery Network，CDN)正是采用了这个办法，减小了访问迟延，提高了数据传输速率。目前CDN主要应用于静态内容的缓存，如静态页面、图片、音视频文件等。对于动态内容的缓存尚处在研究当中，目前主要有边缘计算(Edge Computing)[5,6]、数据库复制(Database Replication)[7,8]、内容感知数据缓存(Content-Aware Cache，CAC)[9-11]、内容无关数据缓存(Content-Blind Cache，CBC)[12,13]四种研究方向。文献[14]的研究表明复制和缓存方法的选择很大程度上依赖于具体的应用，没有一种技术能很好地适用各种Web应用。对于论坛类网站，内容无关缓存方案性能最佳，而对于Amazon类的电子商务网站，数据库复制才是最好的选择。</p>
<p>论坛和博客服务提供商网站的主要特点是：网站内容由大量注册用户产生，每个用户只能添加、修改和删除属于自己的内容，所以对数据库的写操作(UID、Update、Insert and Delete)来源于处于不同位置的用户。本文针对这类为注册用户提供个人信息发布的网站，提出了一种内容分发网络中基于用户的数据分割方法(User-based Data Partition，UbDP)方案：将数据按所属注册用户进行分割，分布到离该用户最近的数据库系统中。
l 内容缓存和内容复制技术
动态网站的普及，驱使CDN和数据库研究组织都在寻找适用于动态内容的先进缓存技术。文献总结了目前主要的四种动态内容缓存和复制技术方案。
边缘计算就是将生成动态页面的代码如PHP代码、ASP代码分发到合适的边缘服务器(Edge Server，ES)上，数据还是保存在内容提供商的原始服务器(Origin Server，OS)上。Es根据Session(用来标识不同的用户会话)、OS上的数据等信息为每个用户生成动态页面。这类方法的优点是结构简单，不需要对原有CDN结构做出调整。缺点是每个数据库查询都需要到0S上执行，增加了迟延，且0S很可能成为性能瓶颈。
数据库复制技术为了解决边缘计算的迟延和数据库瓶颈问题，将数据库也复制到多个ES上，这样ES就能在本地生成动态页面，较大地减小了用户迟延。但是，为了维护数据的一致性，UID操作需要在所有数据库服务器上执行一遍，这会增加大量额外的网络流量和服务器处理开销。</p>
<p>相对于数据库复制技术在ES中复制整个数据库，CAC方案中ES只缓存数据库的一部分。每次查询数据库时，Es都先检查本地数据库中的数据是否足够应答此次查询请求，这个过程称为查询包含检查。如果本地数据足够，则查询请求在本地执行；否则，请求被转发到0S上，ES会缓存查询结果以备后用。这种方案的主要缺点是查询包含检查的计算复杂度太高。
为了降低查询包含检查的计算复杂度，CBC方案得到了应用：ES中根本不运行数据库软件，而只是单独缓存各个数据库查询的结果。因为并不合并各缓存的查询结果，只有当查询语句完全相同时才算缓存命中，所以查询包含检查的计算复杂度大大降低。
以上四种方案都有一个共同的缺点，即所有的UID操作都需要在OS上执行，然后通过一定的策略更新ES上的缓存。这样，在数据库更新相当频繁的应用中，0S上的数据库势必成为系统的性能瓶颈。本文提出的UbDP很好地将UID操作分散到了多个数据库系统，解决了数据库瓶颈问题。
2 基于用户的数据分割
基于用户的数据分割方案应用于传统的CDN架构之上，增加了分布式数据库系统用于存储动态数据，而不改变CDN中原服务器的功能。
<strong>2.1系统架构</strong></p>
<p><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=62d80b5e0100fpe8&amp;url=http://static12.photo.sina.com.cn/orignal/62d80b5et727ea2f919eb&amp;690"><img title="一种CDN中的动态数据存储方案——UbDP" src="http://static12.photo.sina.com.cn/bmiddle/62d80b5et727ea2f919eb&amp;690" alt="一种CDN中的动态数据存储方案——UbDP" /></a></p>
<p>图1 UbDP系统架构</p>
<p>如图1所示。将CDN中的ES按照所在位置划分为有限的多个逻辑区域Region1、Region2、…RegionN，在每个区域内布置一套数据库系统，该数据库系统可以是单台数据库服务器，也可以是由多台数据库服务器组成的Master、Slave结构。数据库中除了存储用户数据外，还维护了用户和其主数据库(Home Database，HDB)的对应关系。每个区域还有一个数据库查询代理(Query Agent，QA)，接收所有查询请求，根据查询请求类型进行不同的数据库操作。
ES接收到用户HTTP请求后，根据需要向QA发送数据库查询请求，QA从自身缓存或后台数据库取得数据返回给ES，ES生成返回页面。
全局负载均衡器(Global Server Load Balancing，GSLB)的目的是在整个网络范围内，将用户请求定向到最近的节点。因此，就近性判断是其主要功能。</p>
<p><strong>2.2数据库查询代理</strong></p>
<p><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=62d80b5e0100fpe8&amp;url=http://static2.photo.sina.com.cn/orignal/62d80b5et78f27edbd2f1&amp;690"><img title="一种CDN中的动态数据存储方案——UbDP" src="http://static2.photo.sina.com.cn/bmiddle/62d80b5et78f27edbd2f1&amp;690" alt="一种CDN中的动态数据存储方案——UbDP" /></a></p>
<p>如图2所示，数据库查询代理QA由查询接口、查询分类器、单库查询缓存和多库查询代理组成。
将数据库查询分为三类：第一类为UID操作；第二类只需要查询一个用户的数据，称为单库查询，包括获取用户信息、获取文章内容等，如：
Q1：SELECT name FROM user WHERE userId = 2
Q2：SELECT title FROM post WHERE id = 3 and userId = 2;
Q1从用户表中获取id为2的用户名；Q2从博客文章表中获取用户2的id为3的文章标题。
第三类查询需要同时获取多个用户的数据，称为多库查询，包括用户积分榜、最新博客文章、博客搜索等，如：
Q3：SELECT userId FROM user ORDER BY score DESC LIMIT 0，10
Q4：SELECT postId FROM blog_index WHERE keyword=&rdquo;旅游&rdquo;
Q3获取积分最高的10个用户id；Q4从索引表中搜索包含关键字“旅游”的所有博客文章。
查询分类器接收到非UID查询请求后，根据是否包含“userld=”查询条件判断查询所属分类(如果包含“userld=”则是单库查询，否则为多库查询)，将请求转发给单库查询缓存或多库查询代理处理。单库查询缓存采用文献[13]中所述的CBC缓存方法，没有命中缓存时的处理流程如下图3所示，先解析出该请求涉及的用户，然后向同区域内的数据库获取该用户的HDB，将查询请求发往HDB，缓存并返回查询结果。</p>
<p><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=62d80b5e0100fpe8&amp;url=http://static16.photo.sina.com.cn/orignal/62d80b5et78f27fa6784f&amp;690"><img title="一种CDN中的动态数据存储方案——UbDP" src="http://static16.photo.sina.com.cn/bmiddle/62d80b5et78f27fa6784f&amp;690" alt="一种CDN中的动态数据存储方案——UbDP" /></a></p>
<p>多库查询代理内部也有一个CBC缓存模块，没有命中缓存时，将查询请求广播到所有数据库系统，综合各数据库查询结果，缓存并返回最终查询结果。为了提高响应速度，对于搜索类不需要对结果进行排序的多库查询，只需一个数据库返回结果，多库查询代理可以立即将结果返回给ES。
<strong>2.3主数据库选择策略</strong>
HDB的选择依赖于用户所在的位置，当用户所在位置发生变化时，系统为他选择的HDB也会变化。
1)设置用户注册或第一次登录时所使用ES所在区域为该用户的主区域(Home Region，HR)，HR内的数据库为该用户的HDB；HDB将该用户的HDB更新情况广播给所有数据库；
2)HDB记录所有它负责用户UID操作的来源区域；如果发现对于某个用户，上一个时问片断内来自某区域的UID操作多于本区域，则可以判断该用户暂时或永久迁移到了新区域，设置新区域内的数据库为该用户的HDB；
3)将该用户的最新信息同步到新HDB；此过程中，为了避免冲突，需要将该用户数据写锁定，不允许用户更新：选择用户离线时更新其HDB，可以减少写锁定带来的影响；
4)将该用户HDB更新情况广播到所有数据库。根据CDN的请求路由原则，用户请求总是被转发到最合适的Es。理想情况下，从同一个位置发起的多次请求，都会被转发到离用户最近的同一个ES上，称为理想ES。考虑到网络拥塞和ES的负载情况，大多数同一个位置发起的多次请求都会被转发到理想ES同一区域内的ES上。所以只有当用户所在位置发生大范围变动时，才需要更新HDB。实际应用中用户并不会经常性地变化所在区域，所以HDB变化的可能性很小，为用户提供服务的ES通常会和HDB位于网络迟延较小的同一区域内。由于将数据库的读写操作都移到了离用户较近的边缘服务器上，用户迟延大大减小。
3 性能分析
本文用RUBBoS对UbDP和数据集中存储内容无关缓存系统的性能进行了比较。RUBBoS是一个模拟了slashdot.org的基准测试程序，它主要包含了3个数据库表，分别存储了5000000个用户、6000篇文章和200000条评论。我们使用了RUBBoS的PHP实现来进行我们的试验。我们使用RUBBoS的ClientEmulator模拟用户会话来访问网站，用户的平均思考时间为7s，且符合TPC-W标准。边缘服务器和数据库服务器都是2.8GHzCPU，1GB内存，边缘服务器中使用Apache2.2.3和PHP5.2.4，数据库软件为MySQL5.0.22。用NISTNET来模拟广域网环境，图4中实线连接带宽为90Mbps，时延为10ms，表示网络节点在同一个区域内；虚线连接带宽为50Mbps，时延为100ms，表示网络节点位于不同的区域。试验方法是测量不同负载情况下的用户迟延即用户发出请求到收到回复之间的时间差。</p>
<p><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=62d80b5e0100fpe8&amp;url=http://static8.photo.sina.com.cn/orignal/62d80b5et78f29205e7a7&amp;690"><img title="一种CDN中的动态数据存储方案——UbDP" src="http://static8.photo.sina.com.cn/bmiddle/62d80b5et78f29205e7a7&amp;690" alt="一种CDN中的动态数据存储方案——UbDP" /></a></p>
<p>图5 用户只发表评论的性能结果</p>
<p>当用户只进行发表评论操作，即用户的每个请求都会产生数据库UID操作时，测试结果如图5所示。如果认为大于5000ms的用户等待时间是不可接受的，则采用UbDP后，系统的UID容量增加了约40％。系统容量并没有随着服务器的增加而线性增加，原因是：1)没有增加边缘服务器ES的数量，系统整体性能部分受限于ES的计算能力；2)采用UbDP引入了额外的数据库查询负载，每个UID操作前需要执行一个数据库读操作，导致了负载较低时，UbDP的迟延甚至大于内容无关缓存系统。
当用户进行普通浏览时(10％的用户会发表评论，其他用户只是浏览)，测试结果如图6所示。在并发用户会话数较小(140以下)时，采用UbDP后平均用户迟延略小于内容无关缓存系统，这是由于UbDP虽然引入了一次额外的数据库查询，但增加的额外查询是在网络迟延较小的本区域数据库上执行的，且原查询也有约一半的几率在本区域数据库上执行。随着并发用户会话数的增加，UbDP由于额外的数据库查询请求，更早进入满负载状态，用户平均迟延逐渐大于内容无关缓存系统。</p>
<p><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=62d80b5e0100fpe8&amp;url=http://static5.photo.sina.com.cn/orignal/62d80b5et78f29e83c744&amp;690"><img title="一种CDN中的动态数据存储方案——UbDP" src="http://static5.photo.sina.com.cn/bmiddle/62d80b5et78f29e83c744&amp;690" alt="一种CDN中的动态数据存储方案——UbDP" /></a></p>
<p>图6 用户普通浏览的性能结果</p>
<p>为了减少额外数据库查询带来的影响，町以在所有ES上增加一个CBC缓存模块，用来缓存用户和HDB的对应关系，CBC接近90％的缓存命中率较大提高了UbDP系统的总体性能(如图6虚线所示UbDP+ES-CBC)。
4 结语
针对论坛和博客服务提供商之类为注册用户提供个人信息发布平台的网站，本文提出了一种内容分发网络中用户分割的分布式数据库系统，通过将不同用户的数据分布到不同的数据库服务器上，有效地将数据库UID操作分散到了多个数据库上，系统的可扩展性大大提高；其代价是增加了额外的读数据库操作，使得在高负载(并发用户数大于140)时，系统性能略低于内容无关缓存系统，但通过在ES上增加CBC模块可以有效减小这一影响。
对于所有数据库表都直接或间接包含某个外键的应用场合，本文所述数据分割方法都适用。</p>
<p><strong>参考文献：</strong></p>
<p>[5]RABINOVICH M,ZHEN XIAO,AGARWAL A. Computing on the edge: A platform for replicating internet applications[C]//Proceedings of the Eighth International Workshop on Web Content Caching and Distribution.Norwell,MA,USA:Kluwer Academic Publishers,2004:57-77;
[6]RABINOVICH M,ZHEN XIAO,DOUGLIS F,et al. Moving edge side includes to the real edge-the clients[C]//Proceedings of the 4th conference on USENIX Symposium on Internet Technologies and Systems.Berkeley,CA,USA:USENIX Association.2003:12;
[7]CECCHET E.C-JDBC:a middleware framework for database clustering[J].IEEE Data Engineering Bulletin,2004,27(2):19-26;
[8]PLATTNER C,ALONSO G.Ganymed:Scalable replication for transactional Web applications[C]//Proceedings of the 5th ACM/IFIP/USENIX International Conference on Middleware.New York,NY,USA:Springer-Verlag,2004:155-174;
[9]AMIRI K,PARK S,TEWARI R,et al. DBProxy:A dynamic data cache for Web applications[C]//Proceedings of 19th Internation Conference on Data Engineering.Bangalore,India:IEEE Computer Society,2003:821-831;
[10]BORNHD C,ALTINEL M,MOHAN C，et al. Adaptive database caching with DBCache[J].IEEE Data Engineering Bulletin,2004,27(2):11-18.
[11]BUCHHLZ T,HOCHSTATTER I,LINNHOFFPOPIEN C.A profit maximizing distribution strategy for context-aware services[C]//Proceedings of Second IEEE International Workshop on Mobile Commerce and Services(WMCS&rsquo;05).Los Alamitos,USA:IEEE Computer Society,2005:144-153;
[12]OLSTON C,MANJHI A,GARROD C,et al. A sealability service for dynamic Web applications[C]//Proceedings of the Conference on Innovative Data Systems Research(CIDR).Asilomar,CA,USA:ACM Press,2005:56-69;
[13]SIVASUBRAMANIAN S,PIERRE G,VAN STEEN M,et al. GlobeCBC:Content-blind result caching for dynamic Web applications[R].Amsterdam,The Netherlands:Vrije Universiteit,2006;
[14]SIVASUBRAMANIAN S,PIERRE G,VAN STEEN M,ALONSO G.Analysis of caching and replication strategies for Web applications[J].IEEE Internet Computing,2007,11(1):60-66;
[15]Rice University,INRIA.RUBBoS:Bulletin Board Benchmark[EB/OL].[2008-01-21]. <a href="http://jmb.objeetWeb.org/rnbbos.html">http://jmb.objeetWeb.org/rnbbos.html</a>;
[16]National Institute of Standards and Technology.NIST net home page[EB/OL].[2008-01-21].http://www-x.antd.nist.gov/nistnet/;</p>
      <a href="/2009/11/22/a-dynamic-data-storage-solution-for-cdn-ubdp" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/21/zz-nginx-compile-optimization-test" title="nginx编译优化压力测试（转）" rel="bookmark">nginx编译优化压力测试（转）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-21 00:00:00 +0800">21 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>默认nginx使用的GCC编译参数是-O，需要更加优化可以使用以下两个参数：</p>
<pre><code>--with-cc-opt='-O3' --with-cpu-opt=*
</code></pre>
<p>具体是什么cpu可以grep name /proc/cpuinfo查看，如果是inter xeon，就写&ndash;with-cpu-opt=pentium，如果是AMD，就写&ndash;with-cpu-opt=opteron。这样编译针对特定CPU以及增加GCC的优化。</p>
<p>针对优化后的结果，我们进行测试，结果表明使用-O2以及以上的参数，可以微量增加性能1%左右，而O2和O3基本可以认为是相同的。</p>
<div class="highlight"><pre><code class="bash">./http_load -parallel 100 -seconds 10 urls
10811 fetches, 100 max parallel, 5.23252e+06 bytes, in 10 seconds
1.默认参数 -O
1087.2 fetches/sec, 526204 bytes/sec
msecs/connect: 45.5374 mean, 63.984 max, 1.008 min
msecs/first-response: 45.7679 mean, 64.201 max, 2.216 min
1088.9 fetches/sec, 527027 bytes/sec
msecs/connect: 45.0159 mean, 65.291 max, 0.562 min
msecs/first-response: 46.1236 mean, 67.397 max, 9.169 min
1102.2 fetches/sec, 533465 bytes/sec
msecs/connect: 44.5593 mean, 67.649 max, 0.547 min
msecs/first-response: 45.499 mean, 67.849 max, 2.495 min
2.优化编译后 -O2
1081.1 fetches/sec, 523252 bytes/sec
msecs/connect: 45.7144 mean, 63.324 max, 0.823 min
msecs/first-response: 46.1008 mean, 61.814 max, 4.487 min
1110.2 fetches/sec, 537337 bytes/sec
msecs/connect: 43.4943 mean, 60.066 max, 0.715 min
msecs/first-response: 45.756 mean, 62.076 max, 3.536 min
1107 fetches/sec, 535788 bytes/sec
msecs/connect: 44.872 mean, 3036.51 max, 0.609 min
msecs/first-response: 44.8625 mean, 59.831 max, 3.178 min
3.优化编译后 -O3
1097.5 fetches/sec, 531189 bytes/sec
msecs/connect: 45.1355 mean, 3040.24 max, 0.583 min
msecs/first-response: 45.3036 mean, 68.371 max, 4.416 min
1111.6 fetches/sec, 538014 bytes/sec
msecs/connect: 44.2514 mean, 64.831 max, 0.662 min
msecs/first-response: 44.8366 mean, 69.904 max, 3.928 min
1099.4 fetches/sec, 532109 bytes/sec
msecs/connect: 44.7226 mean, 61.445 max, 0.596 min
msecs/first-response: 45.4883 mean, 287.113 max, 3.336 min
</code></pre></div>
      <a href="/2009/11/21/zz-nginx-compile-optimization-test" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/21/squidclient-usage" title="squidclient用法" rel="bookmark">squidclient用法</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-21 00:00:00 +0800">21 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>squidclient是squid自带的一个小工具，一般用的最多的，就是-m purge URL了。
其实还有别的用法（看看help吧，不过这个慢慢来~~）先说一个大全式的用法（其他的具体用法，大不了用这里rep出来好了）：squidclient -p 80 mgr:info，显示如下：</p>
<p>[root@raocl ~]# /home/squid/bin/squidclient -p 80 mgr:info
    HTTP/1.0 200 OK
    Server:
    squid/2.6.STABLE21
    squid版本
    Date: Sat, 21 Nov 2009 03:58:45 GMT
    Content-Type: text/plain
    Expires: Sat, 21 Nov 2009 03:58:45 GMT
    Last-Modified: Sat, 21 Nov 2009 03:58:45 GMT
    X-Cache: MISS from cdn.21vianet.com
    Connection: close
    Squid Object Cache: Version 2.6.STABLE21
    Start Time: Sat, 21 Nov 2009 03:48:16 GMT
    Current Time: Sat, 21 Nov 2009 03:58:45 GMT
    Connection information for squid:
    Number of clients accessing
    cache: 1
    当前链接客户端数量
    Number of HTTP requests
    received: 2
    当前链接请求数
    Number of ICP messages
    received: 0
    Number of ICP messages
    sent: 0
    Number of queued ICP
    replies: 0
    Number of HTCP messages
    received: 0
    Number of HTCP messages
    sent: 0
    Request failure ratio:
    0.00
    Average HTTP requests per minute since
    start: 0.2
    每分钟链接请求数
    Average ICP messages per minute since
    start: 0.0
    Select loop called: 118332 times, 5.309 ms
    avg
    Cache information for squid:
    Request Hit Ratios: 5min: 0.0%,
    60min:
    0.0%
    五分钟cache请求数命中率
    Byte Hit Ratios: 5min: -0.0%,
    60min:
    100.0%
    五分钟cache字节数命中率
    Request Memory Hit Ratios: 5min:
    0.0%, 60min: 0.0%
    Request Disk Hit Ratios: 5min:
    0.0%, 60min: 0.0%
    Storage Swap size: 6224
    KB                                                         cache_dir使用大小
    Storage Mem size: 104
    KB                                                            cache_mem使用大小
    Mean Object Size: 4.60 KB
    Requests given to
    unlinkd: 0
    Median Service Times (seconds)  5
    min    60
    min:
    HTTP Requests
    (All):
    0.00000  0.00000
    Cache
    Misses:
    0.00000  0.00000
    Cache
    Hits:
    0.00000  0.00000
    Near
    Hits:
    0.00000  0.00000
    Not-Modified Replies:
    0.00000  0.00000
    DNS
    Lookups:
    0.00000  0.00000
    ICP
    Queries:
    0.00000  0.00000
    Resource usage for squid:
    UP Time: 628.201 seconds
    CPU Time: 0.216 seconds
    CPU Usage: 0.03%
    CPU Usage, 5 minute
    avg: 0.00%
    CPU Usage, 60 minute
    avg: 0.04%
    Process Data Segment Size via sbrk(): 3040
    KB
    Maximum Resident Size: 0 KB
    Page faults with physical i/o: 0
    Memory usage for squid via mallinfo():
    Total space in
    arena:    3052
    KB
    Ordinary
    blocks:
    3038
    KB
    7 blks
    Small
    blocks:
    0
    KB
    0 blks
    Holding
    blocks:
    231572
    KB
    5 blks
    Free Small
    blocks:
    0 KB
    Free Ordinary
    blocks:
    13 KB
    Total in
    use:
    234610 KB 100%
    Total
    free:
    13 KB 0%
    Total
    size:
    234624 KB
    Memory accounted for:
    Total
    accounted:
    571 KB
    memPoolAlloc calls: 76381
    memPoolFree calls: 71547
    File descriptor usage for squid:
    Maximum number of file
    descriptors:
    655360
    系统文件描述符个数
    Largest file desc currently in
    use:
    44
    使用过的最大个数
    Number of file desc currently in
    use:
    41
    目前使用中的个数
    Files queued for
    open:
    0
    Available number of file descriptors:
    655319
    Reserved number of file
    descriptors:   100
    Store Disk files
    open:
    0
    IO loop
    method:
    epoll
    Internal Data Structures:
    1379
    StoreEntries                                                              cache_dir中的文件个数
    26 StoreEntries with
    MemObjects
    mem中的文件个数
    25 Hot Object Cache
    Items
    热点文件个数
    1353 on-disk objects</p>
<p>另外，还有一个squidclient -p 80 mgr:objects，号称是慎用的大杀器，能够列出缓存文件列表——问题是：我找了个新开squid的测试机一试，发现列表显示内容是这个样子的：
    KEY 29E6623108A3E8A64DBBD016AB239AEA
    STORE_OK
    NOT_IN_MEMORY SWAPOUT_DONE
    PING_NONE
    CACHABLE,DISPATCHED,VALIDATED
    LV:1258460822 LU:1258461412 LM:1258460823
    EX:1260950400
    0 locks, 0 clients, 1 refs
    Swap Dir 0, File 0X000412
上头是32位MD5值么？谁看的懂呢……</p>
      <a href="/2009/11/21/squidclient-usage" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/21/show-full-path-in-squid-access-log" title="让squid访问日志显示完整url" rel="bookmark">让squid访问日志显示完整url</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-21 00:00:00 +0800">21 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#squid-ref" title="squid" rel="category tag">squid</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>一大串的header结束了，从上篇开始回到squid.conf本身的设置上来。</p>
<p>这里说一个小东西，一般用不上，但难保哪天就用了：</p>
<p>我们在access.log里，常看到很多url只显示到?，之后的东西就都忽略掉了，这一是为了醒目，反正都不缓存，显示干嘛；二是为了保密，说不定有些网站的GET就直接把什么秘密信息都明文传输呢？</p>
<p>但有时候特殊情况要求我们调试squid，比方说之前提到过的非得缓存?，却又没有提前告知，临时想要自己找完整url，怎么办？</p>
<p>其实有办法，squid配置中有一个strip_query_terms，就是管这事儿的。默认是on，只要改成off，就可以了~~嘿嘿，干坏事的机会到来了……</p>
      <a href="/2009/11/21/show-full-path-in-squid-access-log" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/21/intro-if-modified-since" title="cache驻留时间（四、If-Modified-Since）" rel="bookmark">cache驻留时间（四、If-Modified-Since）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-21 00:00:00 +0800">21 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>话接上回If-Modified-Since，当squid开启reload_into_ims on之后，no-cache头会在在浏览器上被转化成If-Modified-Since标识返回给web服务器。从整体架构考虑，因为squid上已经破坏了http协议的规定，那么web端就必须主动承担对网页过期的识别管理工作。嗯，要是所有的网站都能从一规划开始就这么搞，俺们干CDN的可就轻松了~~~</p>
<p>下面是一段php代码，简单的实现对If-Modified-Since标签的过期管理：</p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="nv">$headers</span> <span class="o">=</span> <span class="nb">apache_request_headers</span><span class="p">();</span>
<span class="c1">//读取整个header信息</span>
<span class="nv">$client_time</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$headers</span><span class="p">[</span><span class="s1">&#39;If-Modified-Since&#39;</span><span class="p">])</span> <span class="o">?</span>
<span class="nb">strtotime</span><span class="p">(</span><span class="nv">$headers</span><span class="p">[</span><span class="s1">&#39;If-Modified-Since&#39;</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="c1">//判断header信息是否包含If-Modified-Since标签，有则转换其时间为Unix格式，否则退出这段定义</span>
<span class="nv">$now</span><span class="o">=</span><span class="nb">gmmktime</span><span class="p">();</span>
<span class="c1">//web服务器的系统时间，为处理方便转换为GMT</span>
<span class="nv">$now_list</span><span class="o">=</span><span class="nb">gmmktime</span><span class="p">()</span><span class="o">-</span><span class="mi">60</span><span class="o">*</span><span class="mi">5</span><span class="p">;</span>
<span class="c1">//五分钟前的时间</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$client_time</span><span class="o">&lt;</span><span class="nv">$now</span> <span class="k">and</span> <span class="nv">$client_time</span>
<span class="o">&gt;</span><span class="nv">$now_list</span><span class="p">){</span>
<span class="c1">//判断浏览器时间是不是在当前的五分钟内</span>
<span class="nx">header</span><span class="p">(</span><span class="err">’</span><span class="nx">Last</span><span class="o">-</span><span class="nx">Modified</span><span class="o">:</span> <span class="err">‘</span><span class="o">.</span><span class="nb">gmdate</span><span class="p">(</span><span class="err">’</span><span class="nx">D</span><span class="p">,</span> <span class="nx">d</span> <span class="nx">M</span> <span class="nx">Y</span> <span class="nx">H</span><span class="o">:</span><span class="nx">i</span><span class="o">:</span><span class="nx">s</span><span class="err">’</span><span class="p">,</span>
<span class="nv">$client_time</span><span class="p">)</span><span class="o">.</span><span class="err">’</span> <span class="nx">GMT</span><span class="err">’</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="mi">304</span><span class="p">);</span>
<span class="k">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="c1">//判断为真，则给header加上时间为浏览器时间的Last-Modified标签，告知浏览器网页未过期</span>
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="nx">header</span><span class="p">(</span><span class="err">’</span><span class="nx">Last</span><span class="o">-</span><span class="nx">Modified</span><span class="o">:</span> <span class="err">‘</span><span class="o">.</span><span class="nb">gmdate</span><span class="p">(</span><span class="err">’</span><span class="nx">D</span><span class="p">,</span> <span class="nx">d</span> <span class="nx">M</span> <span class="nx">Y</span> <span class="nx">H</span><span class="o">:</span><span class="nx">i</span><span class="o">:</span><span class="nx">s</span><span class="err">’</span><span class="p">,</span> <span class="nv">$now</span><span class="p">)</span><span class="o">.</span><span class="err">’</span> <span class="nx">GMT</span><span class="err">’</span><span class="p">,</span>
<span class="k">true</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
<span class="c1">//否则给header加上时间为服务器系统时间的Last-Modified标签，告知浏览器网页过期，重新下载</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>这做一个范例，如果用其他的标签定义来控制过期，照葫芦画瓢就行了。比如用Expires控制，就写</p>
<pre><code>header('Expires: ' . gmdate ("D, d M Y H:i:s", gmmktime() + 60*5). " GMT");
</code></pre>
<p>题外话一句，php中关于date的函数很多，各种的格式不同，小心使用。好比这个新浪博客，就有一个小问题，如果你半夜写博客，过了零点以后发表，会提示错误；甚至如果你原先是10点发表的，隔了几天半月的哪天下午14点来修改保存，也会提示错误。非得要你改成当前分钟之前才行……</p>
      <a href="/2009/11/21/intro-if-modified-since" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2009/11/21/intro-etag" title="cache驻留时间（五、Etag）" rel="bookmark">cache驻留时间（五、Etag）</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2009-11-21 00:00:00 +0800">21 Nov 2009</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cdn-ref" title="cdn" rel="category tag">cdn</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>浏览器的请求中，除了用If-Modified-Since去比对Last-Modified以外，还有另一个标签Etag，这个东东是web服务器比较有用的，squid倒没什么。不过大文件下载加速也有采用apache的系统，一并算在cache缓存里头讲吧：</p>
<p>Etag是为了更好的区分文件过期的标签。比如Last-Modified吧，如果我在一秒钟内更新两次这个文件，他的Last-Modified时间还是一样的。但Etag值不一样。听起来很浪费的样子，呵呵~~</p>
<p>Etag是由文件的inode、mtime、size三个数据通过计算得出来的字符串。这三个都可以通过stat命令查看得到。但问题就来了——一个LVS下挂了七八台RealServer，size固然得一样，mtime只要同步没有问题，也是一样，可这个inode，几乎就不太可能一样了——也就是说，当浏览器的请求被LVS转发到A服务器上时，取得了一个Etag值，一旦刷新重复请求，可能LVS又转发到B服务器，而这个文件在B服务器上计算出的Etag值是另一个。浏览器将判断文件不一致，重新下载！</p>
<p>这种情况，于网民，是用户体验度下降；于网站，是带宽重复占用；于服务器，是无效负载……</p>
<p>不过我们既然知道了原理，解决起来也很简单，只需要在apache的配置中，规定Etag的计算来源就行了。</p>
<p>默认的Etag计算是：FileETag INode MTime Size，如果改全局，只要改成FileETag MTime Size就可以了。如果是下面的某一部分，则写成FileETag -INode也行。
header信息就说到这里吧，最后提供一个<a href="http://en.wikipedia.org/wiki/List_of_HTTP_headers">wiki</a></p>
      <a href="/2009/11/21/intro-etag" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="/page13">Previous</a>
    </li>
    <li class="page">
      <a href="/">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page active">
      <a href="#">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li>
      <a href="/page15">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.icylife.net/blog/" title="">心路</a></li>
              <li><a href="http://dbahacker.com/" title="TB 杨德华">DBA Hacker</a></li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.laird-sa.com/" title="">Laird-SA</a></li>
              <li><a href="http://www.linuxsee.com/" title="">LinuxSEE</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://www.puppeter.cn/" title="">piol</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.sanote.org/" title="">sa note</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://blog.ops.tudou.com/wp/" title="">土豆运营团队</a></li>
              <li><a href="http://www.91tuanfang.com/" title="安居客运维">家欣的天空</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://www.opboy.com" title="">运维小子</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://l09.me/" title="风声">风声</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://mooser.me/" title="牛氓">牛氓</a></li>
              <li><a href="http://http://www.yinwang.org/" title="当然我在扯淡">当然我在扯淡</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://muxueqz.laou.me" title="muxueqz">聊逍遥兮容与</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://paperplane.ruhoh.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.sectop.org/" title="">kindle</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
          </ul>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
