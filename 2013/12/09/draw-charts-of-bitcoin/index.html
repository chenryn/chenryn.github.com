<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>为比特币绘制 MACD、BOLL、KDJ 指标图</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/archive/">归档</a></li>
      	<li><a href="/categories/">分类</a></li>
      	<li><a href="/elk-errata/">《ELK stack权威指南》勘误</a></li>
      	<li><a href="/errata/">《网站运维技术与实践》勘误</a></li>
      	<li><a href="/pages/">Pages</a></li>
      	<li><a href="/projects/">学习记录</a></li>
      	<li><a href="/tags/">标签</a></li>
            <li><a href="http://chenlinux.com/poetry/index.html" />诗文集</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="page-header">
    <h1>为比特币绘制 MACD、BOLL、KDJ 指标图 <small></small></h1>
    <div class="date"><span>09 December 2013</span></div>
    <ul class="tag_box pull-right">
    	<li><a href="/tags.html#highcharts-ref">highcharts <span>1</span></a></li>
    	<li><a href="/tags.html#bitcoin-ref">bitcoin <span>1</span></a></li>
    </ul>
  </div>
  <div style='background-color: #FFF;'>
    <p>比特币是最近相当火爆的一个金融衍生品(瞧咱这口径)。比特币中国提供了一系列 API 来获取和操纵其市场内的比特币。我的小伙伴们基于其 API，完成了一套交易程序。为了提高操作的有效性和技术性，同时作为 python 学习需要，我也参与进来，仿造股票交易软件，为比特币中国绘制了一系列指标图，包括 MACD、BOLL、KDJ 等。截止上周，btc123 也开始提供了 MACD 指标图，所以把自己的实现贴到博客。</p>
<p>首先是获取数据，比特币中国的 API 是个很鬼怪的东西，实时交易数据的接口，返回的数据中最高最低和成交量都是基于过去24小时的，要知道比特币交易是没有休市的啊。所以获取数据过程中需要自己计算这些。这里考虑到股市一般一天实际交易4小时，所以整个设计也是默认4小时的图形展示。</p>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/usr/bin/env python3</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># query price data from BTCChina.</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'config.yaml'</span><span class="p">))</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'host'</span><span class="p">],</span><span class="n">user</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'username'</span><span class="p">],</span><span class="n">passwd</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'password'</span><span class="p">],</span><span class="n">db</span> <span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'databasename'</span><span class="p">],</span><span class="n">charset</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'encoding'</span><span class="p">]</span> <span class="p">)</span>
<span class="k">def</span> <span class="nf">write_db</span><span class="p">(</span><span class="n">datas</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cur_write</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span>  <span class="s">"insert into ticker(sell, buy, last, vol, high, low) values( </span><span class="si">%</span><span class="s">s, </span><span class="si">%</span><span class="s">s, </span><span class="si">%</span><span class="s">s,</span><span class="si">%</span><span class="s">s,</span><span class="si">%</span><span class="s">s,</span><span class="si">%</span><span class="s">s)"</span>
        <span class="n">cur_write</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">datas</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">cur_write</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"Mysql error </span><span class="si">%</span><span class="s">d : </span><span class="si">%</span><span class="s">s."</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_tid</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">vol_url</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'btcchina'</span><span class="p">][</span><span class="s">'vol_url'</span><span class="p">]</span>
        <span class="n">remote_file</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">vol_url</span><span class="p">)</span>
        <span class="n">remote_data</span> <span class="o">=</span> <span class="n">remote_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">remote_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">remote_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">remote_data</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">remote_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'tid'</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"Mysql error </span><span class="si">%</span><span class="s">d : </span><span class="si">%</span><span class="s">s."</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_ohlc</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">read</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">hlvsql</span> <span class="o">=</span> <span class="s">"select max(last),min(last) from ticker where time between date_add(now(),interval -</span><span class="si">%</span><span class="s">s minute) and now()"</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">hlvsql</span><span class="p">)</span>
        <span class="n">high</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">closesql</span> <span class="o">=</span> <span class="s">"select last from ticker where time between date_add(now(),interval -</span><span class="si">%</span><span class="s">s minute) and now() order by time desc limit 1"</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">closesql</span><span class="p">)</span>
        <span class="n">close</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">opensql</span> <span class="o">=</span> <span class="s">"select last from ticker where time between date_add(now(),interval -</span><span class="si">%</span><span class="s">s minute) and now() order by time asc limit 1"</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">opensql</span><span class="p">)</span>
        <span class="n">opend</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">opend</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"Mysql error </span><span class="si">%</span><span class="s">d : </span><span class="si">%</span><span class="s">s."</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">write_ohlc</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cur_write</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">ohlcsql</span> <span class="o">=</span>  <span class="s">'insert into ohlc(open, high, low, close, vol) values( </span><span class="si">%</span><span class="s">s, </span><span class="si">%</span><span class="s">s, </span><span class="si">%</span><span class="s">s, </span><span class="si">%</span><span class="s">s, </span><span class="si">%</span><span class="s">s)'</span>
        <span class="n">cur_write</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ohlcsql</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">cur_write</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"Mysql error </span><span class="si">%</span><span class="s">d : </span><span class="si">%</span><span class="s">s."</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"执行Mysql写入数据时出错: </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span>  <span class="n">e</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">instance</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
    <span class="c"># returns something like {"high":738.88,"low":689.10,"buy":713.50,"sell":717.30,"last":717.41,"vol":4797.32000000}</span>
        <span class="n">remote_file</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">'btcchina'</span><span class="p">][</span><span class="s">'ticker_url'</span><span class="p">])</span>
        <span class="n">remote_data</span> <span class="o">=</span> <span class="n">remote_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">remote_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">remote_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">remote_data</span><span class="p">))[</span><span class="s">'ticker'</span><span class="p">]</span>
    <span class="c">#   remote_data = {key:literal_eval(remote_data[key]) for key in remote_data}</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">remote_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">remote_data</span><span class="p">:</span>
        <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remote_data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">datas</span>
<span class="n">lastid</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ohlc_period</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">next_ohlc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">/</span> <span class="n">ohlc_period</span> <span class="o">*</span> <span class="n">ohlc_period</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">datas</span> <span class="o">=</span> <span class="n">instance</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">datas</span><span class="p">:</span>
        <span class="n">write_db</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">next_ohlc</span><span class="p">):</span>
        <span class="n">next_ohlc</span> <span class="o">+=</span> <span class="n">ohlc_period</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_ohlc</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">latestid</span> <span class="o">=</span> <span class="n">get_tid</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">latestid</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastid</span><span class="p">))</span>
        <span class="n">lastid</span> <span class="o">=</span> <span class="n">latestid</span>
        <span class="n">write_ohlc</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
</div>
<p>这里主要把实时数据存入ticker表，分钟统计数据存入ohlc表。然后是各指标算法。首先是 MACD ：</p>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#/*******************************************************************************</span>
<span class="c"># * Author: Chenlin Rao | Renren inc.</span>
<span class="c"># * Email: rao.chenlin@gmail.com</span>
<span class="c"># * Last modified: 2013-11-26 22:02</span>
<span class="c"># * Filename: macd.py</span>
<span class="c"># * Description: </span>
<span class="c">#       EMA(12)=LastEMA(12)* 11/13 + Close * 2/13</span>
<span class="c">#       EMA(26)=LastEMA(26)* 25/27 + Close * 2/27</span>
<span class="c">#       </span>
<span class="c">#       DIF=EMA(12)-EMA(26)</span>
<span class="c">#       DEA=LastDEA * 8/10 + DIF * 2/10</span>
<span class="c">#       MACD=(DIF-DEA) * 2</span>
<span class="c"># * *****************************************************************************/</span>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="k">class</span> <span class="nc">MACD</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'config.yml'</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sleep_time</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'btcchina'</span><span class="p">][</span><span class="s">'trade_option'</span><span class="p">][</span><span class="s">'sleep_time'</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'host'</span><span class="p">],</span><span class="n">user</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'username'</span><span class="p">],</span><span class="n">passwd</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'password'</span><span class="p">],</span><span class="n">db</span> <span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'databasename'</span><span class="p">],</span><span class="n">charset</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'encoding'</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_getclose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">"select close,time from ohlc order by id desc limit </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_ema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="s">"""
        returns an n period exponential moving average for
        the time series s
        s is a list ordered from oldest (index 0) to most
        recent (index -1)
        n is an integer
        returns a numeric array of the exponential
        moving average
        """</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"No enough item in </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">s</span>
        <span class="n">ema</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c">#get n sma first and calculate the next n period ema</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span> <span class="o">/</span> <span class="n">n</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">ema</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sma</span><span class="p">)</span>
        <span class="c">#EMA(current) = ( (Price(current) - EMA(prev) ) x Multiplier) + EMA(prev)</span>
        <span class="n">ema</span><span class="o">.</span><span class="n">append</span><span class="p">((</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">sma</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span> <span class="o">+</span> <span class="n">sma</span><span class="p">)</span>
        <span class="c">#now calculate the rest of the values</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">ema</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span> <span class="o">+</span> <span class="n">ema</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">ema</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ema</span>
    <span class="k">def</span> <span class="nf">getMACD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getclose</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">array</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span>
        <span class="n">short_ema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ema</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">long_ema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ema</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">short_ema</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">long_ema</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">diff</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">dea</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ema</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">diff</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dea</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">33</span><span class="p">:],</span> <span class="n">diff</span><span class="p">[</span><span class="mi">8</span><span class="p">:]),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">33</span><span class="p">:],</span> <span class="n">dea</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">33</span><span class="p">:],</span> <span class="n">bar</span><span class="p">)</span>
</code></pre>
</div>
<p>然后是 BOLL ：</p>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#/*******************************************************************************</span>
<span class="c"># * Author: Chenlin Rao | Renren inc.</span>
<span class="c"># * Email: rao.chenlin@gmail.com</span>
<span class="c"># * Last modified: 2013-11-26 22:02</span>
<span class="c"># * Filename: macd.py</span>
<span class="c"># * Description: </span>
<span class="c">#       MA=avg(close(20))</span>
<span class="c">#       MD=std(close(20))</span>
<span class="c">#       </span>
<span class="c">#       MB=MA(20)</span>
<span class="c">#       UP=MB + 2*MD</span>
<span class="c">#       DN=MB - 2*MD</span>
<span class="c"># * *****************************************************************************/</span>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="k">class</span> <span class="nc">BOLL</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'config.yml'</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sleep_time</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'btcchina'</span><span class="p">][</span><span class="s">'trade_option'</span><span class="p">][</span><span class="s">'sleep_time'</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'host'</span><span class="p">],</span><span class="n">user</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'username'</span><span class="p">],</span><span class="n">passwd</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'password'</span><span class="p">],</span><span class="n">db</span> <span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'databasename'</span><span class="p">],</span><span class="n">charset</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'encoding'</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_getMA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
    <span class="k">def</span> <span class="nf">_getMD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
        <span class="n">average</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">array</span><span class="p">:</span> <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">average</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="n">length</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">def</span> <span class="nf">getOHLC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">"select time,open,high,low,close,vol from ohlc order by id desc limit </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span> <span class="n">results</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">_getCur</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fromtime</span><span class="p">):</span>
        <span class="n">curread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursql</span> <span class="o">=</span> <span class="s">"select last,vol from ticker where time between date_add('</span><span class="si">%</span><span class="s">s', interval -0 minute) and now()"</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">F </span><span class="si">%</span><span class="s">T'</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">fromtime</span><span class="p">))</span>
        <span class="n">curread</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cursql</span><span class="p">)</span>
        <span class="n">curlist</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curread</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="n">vollist</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">curread</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="n">curlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="p">(</span><span class="n">curlist</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">curlist</span><span class="p">),</span> <span class="n">curlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vollist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">_getClose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="n">close</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">matrix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">close</span>
    <span class="k">def</span> <span class="nf">getBOLL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOHLC</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCur</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
        <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getClose</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="n">up</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">days</span>
        <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
            <span class="n">curmb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMA</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">days</span><span class="p">:</span><span class="n">x</span><span class="p">])</span>
            <span class="n">curmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMD</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">days</span><span class="p">:</span><span class="n">x</span><span class="p">])</span>
            <span class="n">mb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">matrix</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">curmb</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">up</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">matrix</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">curmb</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">curmd</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">dn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">matrix</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">curmb</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">curmd</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">matrix</span><span class="p">[</span><span class="n">days</span><span class="p">:],</span> <span class="n">up</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">dn</span>
</code></pre>
</div>
<p>最后是 KDJ ：</p>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#/*******************************************************************************</span>
<span class="c"># * Author: Chenlin Rao | Renren inc.</span>
<span class="c"># * Email: rao.chenlin@gmail.com</span>
<span class="c"># * Last modified: 2013-11-26 22:02</span>
<span class="c"># * Filename: macd.py</span>
<span class="c"># * Description: </span>
<span class="c">#       RSV=(close-low(9))/(high(9)-low(9))*100</span>
<span class="c">#       K=SMA(RSV(3), 1)</span>
<span class="c">#       D=SMA(K(3), 1)</span>
<span class="c">#       J=3*K-2*D</span>
<span class="c"># * *****************************************************************************/</span>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="k">class</span> <span class="nc">KDJ</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'config.yml'</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sleep_time</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'btcchina'</span><span class="p">][</span><span class="s">'trade_option'</span><span class="p">][</span><span class="s">'sleep_time'</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'host'</span><span class="p">],</span><span class="n">user</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'username'</span><span class="p">],</span><span class="n">passwd</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'password'</span><span class="p">],</span><span class="n">db</span> <span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'databasename'</span><span class="p">],</span><span class="n">charset</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'database'</span><span class="p">][</span><span class="s">'encoding'</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_getHLC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">"select high,low,close,time from ohlc order by id desc limit </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_avg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
    <span class="k">def</span> <span class="nf">_getMA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
        <span class="n">array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">window</span>
        <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="n">curmb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">window</span><span class="p">:</span><span class="n">x</span><span class="p">])</span>
            <span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">curmb</span> <span class="p">)</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">array</span>
    <span class="k">def</span> <span class="nf">_getRSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrays</span><span class="p">):</span>
        <span class="n">rsv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">):</span>
            <span class="n">high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arrays</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">9</span><span class="p">:</span><span class="n">x</span><span class="p">]))</span>
            <span class="n">low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">arrays</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">9</span><span class="p">:</span><span class="n">x</span><span class="p">]))</span>
            <span class="n">close</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">rsv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">close</span><span class="o">-</span><span class="n">low</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">high</span><span class="o">-</span><span class="n">low</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">times</span><span class="p">,</span> <span class="n">rsv</span>
    <span class="k">def</span> <span class="nf">getKDJ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="n">hlc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getHLC</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">rsv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getRSV</span><span class="p">(</span><span class="n">hlc</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMA</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMA</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">3</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">d</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">k</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">d</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">j</span><span class="p">)</span>
</code></pre>
</div>
<p>最后通过一个简单的python web框架完成界面展示，这个叫 bottle.py 的框架是个单文件，相当方便。</p>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">macd</span> <span class="kn">import</span> <span class="n">MACD</span>
<span class="kn">from</span> <span class="nn">boll</span> <span class="kn">import</span> <span class="n">BOLL</span>
<span class="kn">from</span> <span class="nn">kdj</span> <span class="kn">import</span> <span class="n">KDJ</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">static_file</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">template</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'config.yml'</span><span class="p">))</span>
<span class="n">color</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'cn'</span><span class="p">:{</span><span class="s">'up'</span><span class="p">:</span><span class="s">'#ff0000'</span><span class="p">,</span><span class="s">'dn'</span><span class="p">:</span><span class="s">'#00ff00'</span><span class="p">},</span>
    <span class="s">'us'</span><span class="p">:{</span><span class="s">'dn'</span><span class="p">:</span><span class="s">'#ff0000'</span><span class="p">,</span><span class="s">'up'</span><span class="p">:</span><span class="s">'#00ff00'</span><span class="p">},</span>
<span class="p">}</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">redirect</span><span class="p">(</span><span class="s">'/mkb/240'</span><span class="p">)</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">'/mkb/&lt;ago:int&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mkb</span><span class="p">(</span><span class="n">ago</span><span class="p">):</span>
    <span class="n">like</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'webui'</span><span class="p">][</span><span class="s">'color'</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s">'webui'</span><span class="p">,</span> <span class="n">ago</span> <span class="o">=</span> <span class="n">ago</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="n">like</span><span class="p">])</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">'/js/&lt;filename&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">js</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">static_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s">'./js/'</span><span class="p">)</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">'/boll'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">boll</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">"boll"</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">'/macd/&lt;day:int&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">macd</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">MACD</span><span class="p">()</span>
    <span class="n">dif</span><span class="p">,</span> <span class="n">dea</span><span class="p">,</span> <span class="n">bar</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">getMACD</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">'dif'</span><span class="p">:</span><span class="n">dif</span><span class="p">,</span> <span class="s">'dea'</span><span class="p">:</span><span class="n">dea</span><span class="p">,</span> <span class="s">'bar'</span><span class="p">:</span><span class="n">bar</span><span class="p">})</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">'/boll/&lt;day:int&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">boll</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">BOLL</span><span class="p">()</span>
    <span class="n">ohlc</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">dn</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">getBOLL</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">'ohlc'</span><span class="p">:</span><span class="n">ohlc</span><span class="p">,</span> <span class="s">'up'</span><span class="p">:</span><span class="n">up</span><span class="p">,</span> <span class="s">'md'</span><span class="p">:</span><span class="n">md</span><span class="p">,</span> <span class="s">'dn'</span><span class="p">:</span><span class="n">dn</span><span class="p">})</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">'/kdj/&lt;day:int&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">kdj</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
    <span class="n">kdj</span> <span class="o">=</span> <span class="n">KDJ</span><span class="p">()</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">kdj</span><span class="o">.</span><span class="n">getKDJ</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">'k'</span><span class="p">:</span><span class="n">k</span><span class="p">,</span> <span class="s">'d'</span><span class="p">:</span><span class="n">d</span><span class="p">,</span> <span class="s">'j'</span><span class="p">:</span><span class="n">j</span><span class="p">})</span>
<span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre>
</div>
<p>唯一的一个 html 就是具体用 highcharts 画图的地方，如下：</p>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
   <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"refresh"</span> <span class="na">content=</span><span class="s">"60"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
   <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"/js/highstock.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
   <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"/js/highcharts.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
   <span class="nt">&lt;script&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">Highcharts</span><span class="p">.</span><span class="nx">setOptions</span><span class="p">({</span>  
            <span class="na">global</span><span class="p">:</span> <span class="p">{</span>  
                <span class="na">useUTC</span><span class="p">:</span> <span class="kc">false</span>  
            <span class="p">}</span>  
        <span class="p">});</span> 
        <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">'/boll/'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bolldata</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ohlc</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="nx">volume</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="nx">dataLength</span> <span class="o">=</span> <span class="nx">bolldata</span><span class="p">[</span><span class="s1">'ohlc'</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dataLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">ohlc</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">'ohlc'</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">'ohlc'</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">'ohlc'</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">'ohlc'</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">'ohlc'</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span>
                <span class="p">]);</span>
                <span class="nx">volume</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">'ohlc'</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">'ohlc'</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span>
                <span class="p">])</span>
            <span class="p">};</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">'/kdj/'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">kdjdata</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">'/macd/'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">macddata</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">'#container'</span><span class="p">).</span><span class="nx">highcharts</span><span class="p">(</span><span class="s1">'StockChart'</span><span class="p">,</span> <span class="p">{</span>
                        <span class="na">rangeSelector</span><span class="p">:</span> <span class="p">{</span>
                            <span class="na">enabled</span><span class="p">:</span> <span class="mi">0</span>
                        <span class="p">},</span>
                        <span class="na">chart</span><span class="p">:</span> <span class="p">{</span>
                            <span class="na">backgroundColor</span><span class="p">:</span> <span class="s1">'#333333'</span><span class="p">,</span>
                        <span class="p">},</span>
                	    <span class="na">tooltip</span><span class="p">:</span> <span class="p">{</span>
                	    	<span class="na">formatter</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                				<span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="s1">'&lt;b&gt;'</span><span class="o">+</span> <span class="nx">Highcharts</span><span class="p">.</span><span class="nx">dateFormat</span><span class="p">(</span><span class="s1">'%A, %b %e, %H:%M'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span><span class="s1">'&lt;/b&gt;'</span><span class="p">;</span>
                				<span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">points</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">point</span><span class="p">)</span> <span class="p">{</span>
                					<span class="nx">s</span> <span class="o">+=</span> <span class="s1">'&lt;br/&gt;'</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">series</span><span class="p">.</span><span class="nx">name</span><span class="o">+</span><span class="s1">': '</span><span class="o">+</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">point</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
                				<span class="p">});</span>
                				<span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
                			<span class="p">}</span>
                	    <span class="p">},</span>
                        <span class="na">plotOptions</span><span class="p">:</span> <span class="p">{</span>
                            <span class="na">series</span><span class="p">:</span> <span class="p">{</span>
                                <span class="na">marker</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="na">enabled</span><span class="p">:</span> <span class="kc">false</span>
                                <span class="p">},</span>
                                <span class="na">lineWidth</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">},</span>
                        <span class="na">yAxis</span><span class="p">:</span> <span class="p">[{</span>
                          <span class="na">title</span><span class="p">:</span> <span class="p">{</span>
                              <span class="na">text</span><span class="p">:</span> <span class="s1">'MACD(12,26,9)'</span>
                          <span class="p">},</span>
                          <span class="na">height</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                          <span class="na">title</span><span class="p">:</span> <span class="p">{</span>
                              <span class="na">text</span><span class="p">:</span> <span class="s1">'KDJ(9,3,3)'</span>
                          <span class="p">},</span>
                          <span class="na">top</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
                          <span class="na">height</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span>
                          <span class="na">offset</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="na">gridLineDashStyle</span><span class="p">:</span> <span class="s1">'Dash'</span><span class="p">,</span>
                          <span class="na">tickPositions</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="na">title</span><span class="p">:</span> <span class="p">{</span>
                                <span class="na">text</span><span class="p">:</span> <span class="s1">'BOLL(20)'</span>
                            <span class="p">},</span>
                            <span class="na">top</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span>
                            <span class="na">height</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                            <span class="na">offset</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="na">title</span><span class="p">:</span> <span class="p">{</span>
                                <span class="na">text</span><span class="p">:</span> <span class="s1">'VOL'</span>
                            <span class="p">},</span>
                            <span class="na">top</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
                            <span class="na">height</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                            <span class="na">offset</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">}],</span>
                        <span class="na">series</span><span class="p">:</span> <span class="p">[{</span>
                            <span class="na">name</span><span class="p">:</span> <span class="s1">'BAR'</span><span class="p">,</span>
                            <span class="na">color</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
                            <span class="na">negativeColor</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
                            <span class="na">borderColor</span><span class="p">:</span> <span class="s1">'#333333'</span><span class="p">,</span>
                            <span class="na">type</span><span class="p">:</span> <span class="s1">'column'</span><span class="p">,</span>
                            <span class="na">data</span><span class="p">:</span> <span class="nx">macddata</span><span class="p">[</span><span class="s1">'bar'</span><span class="p">],</span>
                            <span class="na">yAxis</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="na">name</span><span class="p">:</span> <span class="s1">'DIFF'</span><span class="p">,</span>
                            <span class="na">color</span><span class="p">:</span> <span class="s1">'#ffffff'</span><span class="p">,</span>
                            <span class="na">type</span><span class="p">:</span> <span class="s1">'line'</span><span class="p">,</span>
                            <span class="na">data</span><span class="p">:</span> <span class="nx">macddata</span><span class="p">[</span><span class="s1">'dif'</span><span class="p">],</span>
                            <span class="na">lineWidth</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="na">yAxis</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="na">name</span><span class="p">:</span> <span class="s1">'DEA'</span><span class="p">,</span>
                            <span class="na">color</span><span class="p">:</span> <span class="s1">'#ffff00'</span><span class="p">,</span>
                            <span class="na">type</span><span class="p">:</span> <span class="s1">'line'</span><span class="p">,</span>
                            <span class="na">data</span><span class="p">:</span> <span class="nx">macddata</span><span class="p">[</span><span class="s1">'dea'</span><span class="p">],</span>
                            <span class="na">lineWidth</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="na">yAxis</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="na">name</span><span class="p">:</span> <span class="s1">'K'</span><span class="p">,</span>
                            <span class="na">color</span><span class="p">:</span> <span class="s1">'#ffffff'</span><span class="p">,</span>
                            <span class="na">type</span><span class="p">:</span> <span class="s1">'line'</span><span class="p">,</span>
                            <span class="na">data</span><span class="p">:</span> <span class="nx">kdjdata</span><span class="p">[</span><span class="s1">'k'</span><span class="p">],</span>
                            <span class="na">yAxis</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="na">name</span><span class="p">:</span> <span class="s1">'D'</span><span class="p">,</span>
                            <span class="na">color</span><span class="p">:</span> <span class="s1">'#ffff00'</span><span class="p">,</span>
                            <span class="na">type</span><span class="p">:</span> <span class="s1">'line'</span><span class="p">,</span>
                            <span class="na">data</span><span class="p">:</span> <span class="nx">kdjdata</span><span class="p">[</span><span class="s1">'d'</span><span class="p">],</span>
                            <span class="na">yAxis</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="na">name</span><span class="p">:</span> <span class="s1">'J'</span><span class="p">,</span>
                            <span class="na">color</span><span class="p">:</span> <span class="s1">'#cc99cc'</span><span class="p">,</span>
                            <span class="na">type</span><span class="p">:</span> <span class="s1">'line'</span><span class="p">,</span>
                            <span class="na">data</span><span class="p">:</span> <span class="nx">kdjdata</span><span class="p">[</span><span class="s1">'j'</span><span class="p">],</span>
                            <span class="na">yAxis</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="na">type</span><span class="p">:</span> <span class="s1">'candlestick'</span><span class="p">,</span>
                            <span class="na">name</span><span class="p">:</span> <span class="s1">'ohlc'</span><span class="p">,</span>
                            <span class="na">data</span><span class="p">:</span> <span class="nx">ohlc</span><span class="p">,</span>
                            <span class="na">upColor</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
                            <span class="na">upLineColor</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
                            <span class="na">color</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
                            <span class="na">lineColor</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
                            <span class="na">yAxis</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="na">type</span><span class="p">:</span> <span class="s1">'spline'</span><span class="p">,</span>
                            <span class="na">name</span><span class="p">:</span> <span class="s1">'up'</span><span class="p">,</span>
                            <span class="na">data</span><span class="p">:</span> <span class="nx">bolldata</span><span class="p">[</span><span class="s1">'up'</span><span class="p">],</span>
                            <span class="na">color</span><span class="p">:</span> <span class="s1">'#ffff00'</span><span class="p">,</span>
                            <span class="na">lineWidth</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="na">yAxis</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="na">type</span><span class="p">:</span> <span class="s1">'spline'</span><span class="p">,</span>
                            <span class="na">name</span><span class="p">:</span> <span class="s1">'md'</span><span class="p">,</span>
                            <span class="na">data</span><span class="p">:</span> <span class="nx">bolldata</span><span class="p">[</span><span class="s1">'md'</span><span class="p">],</span>
                            <span class="na">color</span><span class="p">:</span> <span class="s1">'#ffffff'</span><span class="p">,</span>
                            <span class="na">lineWidth</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="na">yAxis</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="na">type</span><span class="p">:</span> <span class="s1">'spline'</span><span class="p">,</span>
                            <span class="na">name</span><span class="p">:</span> <span class="s1">'dn'</span><span class="p">,</span>
                            <span class="na">data</span><span class="p">:</span> <span class="nx">bolldata</span><span class="p">[</span><span class="s1">'dn'</span><span class="p">],</span>
                            <span class="na">color</span><span class="p">:</span> <span class="s1">'#cc99cc'</span><span class="p">,</span>
                            <span class="na">lineWidth</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="na">yAxis</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="na">name</span><span class="p">:</span> <span class="s1">'VOL'</span><span class="p">,</span>
                            <span class="na">borderColor</span><span class="p">:</span> <span class="s1">'#333333'</span><span class="p">,</span>
                            <span class="na">type</span><span class="p">:</span> <span class="s1">'column'</span><span class="p">,</span>
                            <span class="na">data</span><span class="p">:</span> <span class="nx">volume</span><span class="p">,</span>
                            <span class="na">yAxis</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="p">}]</span>
                    <span class="p">});</span>
                <span class="p">});</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span> 
   <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
   <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"container"</span> <span class="na">style=</span><span class="s">"min-width:800px;height:1000px;"</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>
<p>highcharts 有个问题，就是不能跟 amcharts 或者 echarts 那样提供一个画笔工具，让用户自己在生成的图形上再涂抹线条，这个功能其实在蜡烛图上判断压力位支撑位的时候很有用。不过蜡烛图 btc123 也提供了，我也就懒得再用 amcharts 重写一遍。</p>
<p>效果如下：</p>
<p><img src="/images/uploads//btc.png" alt="" /></p>
    <hr>
    <div class="pagination">
      <ul>
        <li class="prev"><a href="/2013/12/09/add-mailinglist-command-to-gitolite/" title="为 gitolite 实现 mailinglist 命令行操控">&larr; Previous</a></li>
        <li><a href="/archive.html">Archive</a></li>
        <li class="next"><a href="/2013/12/31/report-of-this-year/" title="2013 年度个人总结">Next &rarr;</a></li>
      </ul>
    </div>
    <hr>
  <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_renren">人人网</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_gmail">Gmail邮箱</a>
<a class="jiathis_button_twitter">Twitter</a>
<a class="jiathis_button_googleplus">Google+</a>
<a class="jiathis_button_hi">百度空间</a>
<a class="jiathis_button_fb">Facebook</a>
<a class="jiathis_button_douban">豆瓣</a>
<a href="http://www.jiathis.com/share?uid=1589850" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	ralateuid:{
		"tsina":"1035836154"
	},
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1589850" charset="utf-8"></script>
<!-- JiaThis Button END -->
<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" id="UYScript" src="http://v1.uyan.cc/js/iframe.js?UYUserId=1589850" async=""></script>
<!-- UY END -->
  </div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
                 <li><a href="/2016/04/04/lucene-proximity-querystring/">Lucene 查询中的距离查询(proximity query)</a></li>
                 <li><a href="/2016/04/01/javaflamegraph/">用火焰图看 elasticsearch 的资源占用</a></li>
                 <li><a href="/2016/03/19/machine-vs-ops/">机器战胜人类了，伺候机器的运维呢？</a></li>
                 <li><a href="/2016/03/16/juttle-viz-intro/">juttle 可视化界面介绍</a></li>
                 <li><a href="/2016/03/16/juttle-intro/">juttle 介绍</a></li>
                 <li><a href="/2016/01/27/kibana-server-plugin-develop/">Kibana4 服务器端插件开发</a></li>
                 <li><a href="/2015/12/27/report-of-this-year/">2015 年度个人总结</a></li>
                 <li><a href="/2015/11/25/rsyslog-mmnormalize/">Rsyslog 的 mmnormalize 模块用法</a></li>
                 <li><a href="/2015/10/29/siren/">SIREn 插件试用</a></li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
              <li><a href="http://showmetheco.de/" title="Viacheslav Tykhanovskyi(PocketIO/Text::Haml)">No time to wait</a></li>
              <li><a href="http://blog.dataloop.io/" title="A new SaaS monitoring tool for DevOps & Operations">Dataloop.IO</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://planeteria.org/perl6/" title="Perl6 文集">Planet Perl 6</a></li>
              <li><a href="http://www.metaforsoftware.com/blog/" title="">metafor</a></li>
              <li><a href="http://blog.kablamo.org/" title="Eric Johnson，一个游走在伦敦和北京的 Perler">kablamo</a></li>
              <li><a href="http://aphyr.com/posts" title="call me maybe 吐槽系列">Aphyr</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://timo.piqiu.me/" title="TIMO IS MY OASIS">Timo</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.lark.net.cn/" title="王剑">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://junqili.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://blog.l8ii.com/" title="刘侨">LairdNote</a></li>
              <li><a href="http://flw.tools/" title="">flw的工具箱</a></li>
              <li><a href="http://blog.mcshell.org/" title="">mcshell</a></li>
              <li><a href="http://novoland.github.io/" title="">克鲁斯卡尔的博客</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="booklists" class="nav nav-list">
          <li class="nav-header">我写的技术书籍</li>
          <li><a href='http://product.china-pub.com/3769604'><img src='http://images.china-pub.com/ebook3765001-3770000/3769604/shupi.jpg' border='0' alt='网站运维技术与实践'/></a></li>
          <li><a href='http://product.china-pub.com/64005'><img src='http://images.china-pub.com/ebook60001-65000/64005/shupi.jpg' border='0' alt='ELK Stack权威指南'/></a></li>
          <li class="nav-header">我参与翻译的技术书籍</li>
          <li><a href='http://product.china-pub.com/4582714'><img src='http://images.china-pub.com/ebook4580001-4585000/4582714/shupi.jpg' border='0' alt='Puppet 实战手册'/></a></li>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2015 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
  </body>
</html>
