
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
            
            
            


  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">归档</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories.html">分类</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/errata.html">《网站运维技术与实践》勘误</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/projects.html">学习记录</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">标签</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  




            <li><a href="http://chenlinux.com/poetry/index.html" />诗文集</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
        
<div class="row">
  

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/12/15/learning_dancer_plugin_simplecrud" title="Dancer::Plugin::SimpleCRUD模块学习" rel="bookmark">Dancer::Plugin::SimpleCRUD模块学习</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-12-15 00:00:00 +0800">15 Dec 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>Dancer圣临历中介绍了一个新插件Dancer::Plugin::SimpleCRUD。可以很快的生成对数据库表的create/read/update/delete。大概阅读了一下代码。主要就是使用HTML::FromDatabase模块生成read的页面，用CGI::FormBuilder模块生成create/update/delete的页面，用Dancer::Plugin::Database::Handle模块操作数据库。因为是Simple，所以html代码都是固定的，不甚美观。但是思路可以学习，通过这两个模块，可以自己结合Dancer的template系统做CRUD了。
先来说HTML::FromDatabase模块，这个只涉及select，所以特别简单：

      <a href="/2011/12/15/learning_dancer_plugin_simplecrud" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/12/12/nginx_perl_demo" title="nginx_perl试用" rel="bookmark">nginx_perl试用</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-12-12 00:00:00 +0800">12 Dec 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>因为空闲时间比较多，所以在CPAN上乱翻，看到了nginx_perl这个项目(原名Nginx::Engine)，现在托管在github.com上。地址见：
<a href="https://github.com/zzzcpan/nginx-perl">https://github.com/zzzcpan/nginx-perl</a>

      <a href="/2011/12/12/nginx_perl_demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/11/04/test_websocket_with_dancer" title="websocket体验" rel="bookmark">websocket体验</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-11-04 00:00:00 +0800">04 Nov 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>因为看到mojo在宣传其内置websocket支持，去CPAN上search了一下，发现Dancer也有plugin做websocket用。稍微看了一下，很显然没看mojo的内嵌代码，而dancer的plugin代码倒是相当简单。
简单的说，就是通过AnyMQ、Plack和Web::Hippie的组合完成。注意的是，因为Web::Hippie使用了AnyEvent::Handle管理websocket的fh，AnyMQ也使用AnyEvent管理message queue，所以在启动plackup的时候，必须使用AnyEvent核心的Twiggy服务器。
Plugin里硬编码很多。比较重要的地方就是&rdquo;set plack_middlewares_map&rdquo;，plack_middlewares_map是dancer新加的功能，这里用URLMap来mount &lsquo;/_hippie&rsquo;到Web::Hippie::Pipe和AnyMQ上。也就是说，使用websocket的访问路径，必须固定为&rsquo;^/_hippie/.*&lsquo;这样。
然后像两个get方法，&rsquo;/new_listener&rsquo;和&rsquo;/message&rsquo;，这两个访问路径是Web::Hippie里写死的，不能改。好在一般应用也不会直接访问这个。
最后有三个register到Dancer的方法，&rsquo;ws_on_message&rsquo;、&rsquo;ws_on_new_listener&rsquo;和&rsquo;ws_send&rsquo;，前两个用来覆盖上面提到的get的两个route的具体信息，一般不用前面两个，因为这样就意味着页面的js里无法控制websocket了（个人理解，不知道对否？）后面那个类似把websocket改成普通的params方式请求响应（用curl/wget可以请求的那种）。

      <a href="/2011/11/04/test_websocket_with_dancer" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/11/04/perl_oauth_to_weibo_api" title="用perl调用新浪微博API小实验" rel="bookmark">用perl调用新浪微博API小实验</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-11-04 00:00:00 +0800">04 Nov 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>新浪微博API是通过OAuth方式的。perl上有现成的模块，只需要稍微调一下参数就行了。下午比较闲，试试看。。。
一般网上说的，都还是Net::OAuth模块，这个是1.0a版本的，一看perldoc那个长篇就头疼。这里我用Net::OAuth2模块，简单方便，而且正好配合dancer框架，方便做外部网站应用。
首先是安装模块：

      <a href="/2011/11/04/perl_oauth_to_weibo_api" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/10/26/a_perl_extended_regex" title="一个perl扩展正则表达式" rel="bookmark">一个perl扩展正则表达式</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-10-26 00:00:00 +0800">26 Oct 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>今天傍晚，莫言在Q群里贴了一个他写的正则表达式，回来翻了翻perlre文档，基本算是看懂，赶紧记录下来：

      <a href="/2011/10/26/a_perl_extended_regex" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/10/25/rewrite_template_for_squid-conf" title="用Template::Tookit给squid.conf写模板" rel="bookmark">用Template::Tookit给squid.conf写模板</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-10-25 00:00:00 +0800">25 Oct 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>本文纯属练习Template模块使用，是否可以运用到生产，是否有必要运用到生产，都是未知数……
包括如下文件：

      <a href="/2011/10/25/rewrite_template_for_squid-conf" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/10/24/backup-script-4-my-blog" title="blog备份脚本" rel="bookmark">blog备份脚本</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-10-24 00:00:00 +0800">24 Oct 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>之前总不重视自己的博客，上回一丢才心疼，现在重视起来，决定定期备份sql。写个小脚本如下：

      <a href="/2011/10/24/backup-script-4-my-blog" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/10/20/screenshot-4-cloudhosting-down" title="博客恢复了，截图纪念一下" rel="bookmark">博客恢复了，截图纪念一下</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-10-20 00:00:00 +0800">20 Oct 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>这两天折腾博客宕机问题啊~原本对阿里云的看好大幅下降……几次挂掉，甚至电话告知说数据恢复不了请自行重置……崩溃原因居然解释说“因为你没有修改grub再重启”这种解释，拜托，我要重启还不是因为突然ssh报密码错误而你们“重置密码必须重启”？死循环啊！
对了，我人格保证，作为一个用xen当工作环境一年多的运维，绝对没有犯自行升级内核导致重启失败这种错误的可能。阿里云客服能不能不要把一个客户的缘由安到别的客户头上……
不管如何，结局还是好的。截个监控宝的告警图纪念一下：
<img src="/images/uploads/20111020192305.png" alt="" title="aliyunOS" width="856" height="332" class="alignnone size-full wp-image-2647" />

      <a href="/2011/10/20/screenshot-4-cloudhosting-down" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/10/17/notes-about-probind" title="ProBIND体验笔记" rel="bookmark">ProBIND体验笔记</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-10-17 00:00:00 +0800">17 Oct 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#dns-ref" title="dns" rel="category tag">dns</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>闲的无聊，继续研究DNS周边产品，这次盯上了Probind。这是搜索结果中比较常见的bind的web管理工具。其实我是比较希望有个中文的东东方便我偷懒，可惜看sina之前的xbayDNS一直停留在了只支持FreeBSD/MAC的阶段没有更新，汗，不支持linux的项目偶见过的还真不多……
probind最近一次更新也是2003/05/24的事情了。所以也没期待它能多么适应现在的bind体系，不过作为代码看看还是可以的。
创建mysql用户和库，然后把程序解压到webroot目录，然后执行mysql -u named -p named &lt; etc/mktables.sql，这就是install的步骤。但是这个时候访问首页是有一堆报错的，提示你dns服务器的默认配置（外部检测用dns，管理员邮箱等等）没配置。这个需要通过./tools/settings.php去添加——但是首页上没有链接点击，得自己手敲url，汗……
然后，probind更新的时候，估计php还是以version4为主，所以里头用的还是$HTTP_GET_VARS和$HTTP_POST_VARS等全局变量。奇怪的是我把php.ini里的register_global改成On后重启httpd了，页面依然没变，不得已在./inc/lib.inc文件的开头加上了两句

      <a href="/2011/10/17/notes-about-probind" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/09/30/dynamic-dns-demo" title="一个ddns的demo" rel="bookmark">一个ddns的demo</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-30 00:00:00 +0800">30 Sep 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>上回分析lbnamed的时候，开玩笑说自己也可以试试在模块基础上加点啥功能。国庆节前最后一天，没啥事情做，就写个小demo续貂。代码如下：

      <a href="/2011/09/30/dynamic-dns-demo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/09/29/dancing-website-for-sync-dist-3" title="写个同步分发系统(三)" rel="bookmark">写个同步分发系统(三)</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-29 00:00:00 +0800">29 Sep 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>上篇写的页面上，留下一个超链接，查看每条任务的具体情况。现在完成这部分。
首先修改数据库结构，上篇已经建了websync.websync_peer表，现在继续：

      <a href="/2011/09/29/dancing-website-for-sync-dist-3" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/09/26/dancing-website-for-sync-dist-2" title="写个同步分发系统(二)" rel="bookmark">写个同步分发系统(二)</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-26 00:00:00 +0800">26 Sep 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>接上篇，加上分发过程查看的页面。这应该是一个很典型的翻页处理。
首先创建一个数据库表如下：

      <a href="/2011/09/26/dancing-website-for-sync-dist-2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/09/20/get-ip-address-by-perl-on-linux" title="linux上获取本机ip的各种perl写法" rel="bookmark">linux上获取本机ip的各种perl写法</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-20 00:00:00 +0800">20 Sep 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>大家讨论使用 Gearman 做分布式处理时，各机需要注册一个独立的 job 作为信息反馈，但是为了方便，<code>Gearman::Worker</code> 脚本 <code>register_function</code> 代码又要通用，于是想到了使用各自的 ip 地址作为 job 命名~

      <a href="/2011/09/20/get-ip-address-by-perl-on-linux" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/09/16/dancing-website-for-sync-dist-1" title="写个同步分发系统(一)" rel="bookmark">写个同步分发系统(一)</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-16 00:00:00 +0800">16 Sep 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#dancer-ref" title="dancer" rel="category tag">dancer</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>写程序这个事情，其实规划最麻烦。比方我其实并没留意过一个完整的同步分发系统都有哪些功能。权做练手，想到哪些写哪些好了。
最基础的部分:一个提交文件列表的页面，自动分析文件列表然后从源下载文件，中心下载完成后通知边缘节点开始；
其次：文件完整性的校验，同步和分发的进度报表页面，失败报表的重试选择和报警；
再次：系统分用户，不同用户可选节点指定分发，只查看当前用户的报表。
以上。
今天先完成最基础的部分。还是用dancer -a websync创建应用。然后创建views/websync.tt如下：

      <a href="/2011/09/16/dancing-website-for-sync-dist-1" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/09/08/lbnamed-code-reading" title="lbnamed代码浅读" rel="bookmark">lbnamed代码浅读</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-09-08 00:00:00 +0800">08 Sep 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>群里听说lbnamed这么个东东，用perl实现的动态DNS服务器。程序包括三个perl模块：Stanford::DNSserver模块、Stanford::DNS模块、LBCD模块；三个perl程序：lbnamed主程序、poller探测程序、slbcd监控程序（这个有C语言的版本）。

      <a href="/2011/09/08/lbnamed-code-reading" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/08/25/nginx-diff-response-via-filesize" title="用nginx区分文件大小做出不同响应" rel="bookmark">用nginx区分文件大小做出不同响应</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-25 00:00:00 +0800">25 Aug 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#nginx-ref" title="nginx" rel="category tag">nginx</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>昨晚和前21v的同事聊天，说到我离职后一些技术上的更新。其中有个给某大客户(游戏下载类)的特殊需求设计，因为文件大小差距很大——估计是大版本和补丁的区别——又走的是同一个域名，而squid在响应比较大的文件时，尤其是初次下载的时候，性能比较差，所以拆成两组服务器，squid服务于较小的文件，通过pull方式从peer层获取，nginx服务于较大的文件，通过push方式由peer层分发同步。外部发布域名一律解析到squid服务器组上，请求透传到peer层的nginx，nginx分析这个url的content-length，如果大于阈值，则不返回文件，而是302到nginx服务器组的独立域名下的相应url去。

      <a href="/2011/08/25/nginx-diff-response-via-filesize" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/08/18/learning-cloudfarecast-3" title="CloudForecast学习笔记(三)" rel="bookmark">CloudForecast学习笔记(三)</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-18 00:00:00 +0800">18 Aug 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>第三篇，看web部分。主程序cloudforecast_web里主要就是调用CloudForecast::Web的run()函数，接下来去看CloudForecast::Web。
照例还是加载配置，然后这里主要多了两个accessor：allowfrom和front_proxy。用来定制acl和代理的。从下文可以看到，分别是采用了Plack::Middleware::Access和Plack::Middleware::ReverseProxy两个模块进行控制。
然后是主要部分，通过Plack::Builder建立$app：
1、初始化:&rdquo;my $app = $self-&gt;psgi;&rdquo;，这里是调用父层&rdquo;use Shirahata -base;&rdquo;的psgi()函数完成的。稍后再看这个。
2、包装:取出前面说的allowfrom和front_proxy部分后，代码如下：

      <a href="/2011/08/18/learning-cloudfarecast-3" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/08/18/learning-cloudfarecast-2" title="CloudForecast学习笔记(二)" rel="bookmark">CloudForecast学习笔记(二)</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-18 00:00:00 +0800">18 Aug 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>接下来看radar部分，也就是探测主程序cloudforecast_radar，其中主要就是调用CloudForecast::Radar中的run()函数。
首先还是惯例，调用ConfigLoader模块加载配置文件；
然后是%SIG信号的定义，用来之后自动重运行的；
然后一个while true死循环：
1、循环里用select(undef,undef,undef,0.5)实现一个0.5秒的sleep；
2、第一个if语句，用来判断是否是父进程，并使用无阻塞的waitpid($pid,WNOHANG)等待子进程完成——即$kid==-1；
3、第二个if语句，用来强制退出死循环，条件是收到%SIG信号；
4、第三个if语句，确认当前时间超过计划中的执行时间（即离上次执行时间最近的整5分钟点），开始执行探测——采用fork()派生子进程。
5、子进程内容是从之前获取的配置文件内，轮询每一台设备，最终调用run_host()函数执行。
然后又是两个if语句，接在while里的last之后，等待子进程全部完成的。

      <a href="/2011/08/18/learning-cloudfarecast-2" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/08/17/learning-cloudfarecast-1" title="CloudForecast学习笔记(一)" rel="bookmark">CloudForecast学习笔记(一)</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-17 00:00:00 +0800">17 Aug 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>近三天学习cloudforecast，这是一个日本SA写的分布式监控的perl项目。日本的运维水平和perl水平，都让人羡慕啊……
项目介绍：
http://blog.riywo.com/2011/02/27/043646
demo网址:
http://editnuki.info:5000/
下载地址：
https://github.com/kazeburo/cloudforecast
粗略的看了主要文件，主要是用Class::<em>完成的OO，Plack::MiddleWare::</em>完成的web，Gearman::Worker调用Data::*里的具体模块完成对服务器的监控抓取，然后调用RRDs完成监控数据图像的更新，在启动分布式的情况下，则用Gearman::Client传输监控数据给调用RRDs的worker。

      <a href="/2011/08/17/learning-cloudfarecast-1" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/08/02/calendar-select-html-for-self-monitor" title="cdn自主监控(六):数据展示页面" rel="bookmark">cdn自主监控(六):数据展示页面</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-02 00:00:00 +0800">02 Aug 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>接下来进入我不擅长的页面部分了。规划页面分为side和main，side中提供时间选择框/类型下拉选择框和提交按钮；main中展示最后形成的chart。
时间选择框是用js和css完成的，这个网上有很多，不过要同时支持多浏览器和分钟级别的选项的，目前就发现一个好用的。下载地址如下：<a href="http://chenlinux.com/images/uploads/Calendar.zip">http://chenlinux.com/images/uploads/Calendar.zip</a>
然后创建cachemoni/public/cdn.html如下：

      <a href="/2011/08/02/calendar-select-html-for-self-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/08/01/fusioncharts-for-self-monitor" title="cdn自主监控(五):生成charts图像" rel="bookmark">cdn自主监控(五):生成charts图像</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-08-01 00:00:00 +0800">01 Aug 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>上篇完成了xml的输出，这篇开始说charts图像的生成。我们采用fusioncharts的免费版，之前博客有提到另一个amcharts，不过amcharts的免费版会在图像左上角加上自己amcharts.com的广告标识……
从fusioncharts官网下载free版的压缩包，有20MB大，不过其中对我们这个小项目有用的只有MSLine.swf/MSBar2D.swf/fusioncharts.js等。
说明：
1、官网介绍上写了支持perl，不过下载包里只有php/asp/jsp/rails的class，没有perl的。所以还是得采用js的方式；
2、js下有setDataURL和setDataXML两个方法，不过官方强烈建议使用setDataURL方法，这种方法可接受的数据量比setDataXML大很多。
页面html很简单，加如下js代码即可：

      <a href="/2011/08/01/fusioncharts-for-self-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/07/28/output-xml-for-funsioncharts" title="cdn自主监控(四):输出xml数据" rel="bookmark">cdn自主监控(四):输出xml数据</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-28 00:00:00 +0800">28 Jul 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>准备使用funsioncharts绘图，其采用xml数据，在绘制line图的时候，就要从mysql里读取数据，并输出成xml格式，相关配置如下：

      <a href="/2011/07/28/output-xml-for-funsioncharts" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/07/27/prepare-mysql-for-self-monitor" title="cdn自主监控(三):数据库准备工作" rel="bookmark">cdn自主监控(三):数据库准备工作</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-27 00:00:00 +0800">27 Jul 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>准备两个表，一个存储原始数据，另一个存储每5分钟归总一次的数据。之后根据时间段绘制省份运营商性能图的时候，就直接从汇总表里获取数据；原始表留给详细查询。
数据库准备脚本如下：

      <a href="/2011/07/27/prepare-mysql-for-self-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/07/26/seek-iplist-for-self-monitor" title="cdn自主监控(二):快速查找ip对应信息" rel="bookmark">cdn自主监控(二):快速查找ip对应信息</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-26 00:00:00 +0800">26 Jul 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>话接上篇，ip整理出来，然后就是接一个ip地址，快速定位查找到它属于哪个ip段，然后返回具体的省份和运营商。因为之前的ip已经转换成数字，而且是顺序排列的，所以可以采用折半算法(二分法)。perl脚本如下：

      <a href="/2011/07/26/seek-iplist-for-self-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full" style='background-color: #FFF;'>
    <h2 class="entry-title">
      <a href="/2011/07/25/overwrite-qqwry-for-self-monitor" title="cdn自主监控(一):整理一个可用范围内的尽可能小的ip库" rel="bookmark">cdn自主监控(一):整理一个可用范围内的尽可能小的ip库</a>
    </h2>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2011-07-25 00:00:00 +0800">25 Jul 2011</abbr>
      </span>
        
      <span>
      </span>
      Posted in&nbsp;
      
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
      
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>

    <p>为了跟第三方监控做对比和作为备用，准备自己通过页面js返回数据做个监控。首先第一步，整理一个足够自己用的ip库。
首先，考虑调用会比较频繁，打算把内容尽可能归并，到省级运营商即可；
其次，未知归并完会有多大的情况下，考虑到qqwry的地区都是中文，打算统一使用电话区号代替地区，运营商也有一位数字代替，ip采用inet-aton网络值代替；这样每条记录的字节数固定，可以方便采用seek和sysread提高读取某条记录的速度。

      <a href="/2011/07/25/overwrite-qqwry-for-self-monitor" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>


  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
  
    <li>
    
      <a href="/page6">Previous</a>
    
    </li>
  
  
    <li class="page">
      <a href="/">1</a>
    </li>
  
  
    
    <li class="page">
      <a href="/page2">2</a>
    </li>
    
  
    
    <li class="page">
      <a href="/page3">3</a>
    </li>
    
  
    
    <li class="page">
      <a href="/page4">4</a>
    </li>
    
  
    
    <li class="page">
      <a href="/page5">5</a>
    </li>
    
  
    
    <li class="page">
      <a href="/page6">6</a>
    </li>
    
  
    
    <li class="page active">
      <a href="#">7</a>
    </li>
    
  
    
    <li class="page">
      <a href="/page8">8</a>
    </li>
    
  
    
    <li class="page">
      <a href="/page9">9</a>
    </li>
    
  
    
    <li class="page">
      <a href="/page10">10</a>
    </li>
    
  
    
    <li class="page">
      <a href="/page11">11</a>
    </li>
    
  
    
    <li class="page">
      <a href="/page12">12</a>
    </li>
    
  
    
    <li class="page">
      <a href="/page13">13</a>
    </li>
    
  
    
    <li class="page">
      <a href="/page14">14</a>
    </li>
    
  
    
    <li class="page">
      <a href="/page15">15</a>
    </li>
    
  
    
    <li class="page">
      <a href="/page16">16</a>
    </li>
    
  
    
    <li class="page">
      <a href="/page17">17</a>
    </li>
    
  
  
    <li>
      <a href="/page8">Next</a>
    </li>
  
  </ul>
</div>



</div>


      </div>
      <div class="span4">
          
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
               
            </ul>
          </div>
        
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
            
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
            
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
            
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
            
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
            
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
            
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
            
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
            
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
            
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
            
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
            
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
            
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
            
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
            
              <li><a href="http://showmetheco.de/" title="Viacheslav Tykhanovskyi(PocketIO/Text::Haml)">No time to wait</a></li>
            
              <li><a href="http://blog.dataloop.io/" title="A new SaaS monitoring tool for DevOps & Operations">Dataloop.IO</a></li>
            
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
            
              <li><a href="http://planeteria.org/perl6/" title="Perl6 文集">Planet Perl 6</a></li>
            
              <li><a href="http://www.metaforsoftware.com/blog/" title="">metafor</a></li>
            
              <li><a href="http://blog.kablamo.org/" title="Eric Johnson，一个游走在伦敦和北京的 Perler">kablamo</a></li>
            
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
            
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
            
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
            
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
            
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
            
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
            
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
            
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
            
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
            
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
            
              <li><a href="http://www.lark.net.cn/" title="王剑">lark's cloud</a></li>
            
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
            
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
            
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
            
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
            
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
            
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
            
              <li><a href="http://junqili.com/" title="深入研究puppet">纸飞机</a></li>
            
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
            
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
            
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
            
              <li><a href="http://blog.l8ii.com/" title="刘侨">LairdNote</a></li>
            
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="booklists" class="nav nav-list">
          <li class="nav-header">我写的第一本技术书籍</li>
          <li><a href='http://product.china-pub.com/3769604'><img src='http://images.china-pub.com/ebook3765001-3770000/3769604/shupi.jpg' border='0' alt='网站运维技术与实践'/></a></li>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    

    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>

