<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/01/06/staticperl-and-upx" title="利用 staticperl 和 upx 生成 单个可执行 perl" rel="bookmark">利用 staticperl 和 upx 生成 单个可执行 perl</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-01-06 00:00:00 +0800">06 Jan 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Perl 程序打包的问题由来已久。</p>
<p>最早是 perlcc，但是从5.10版本以后，B::CC 等一系列模块跟不上开发脚本导致 perlcc 也无法使用。</p>
<p>然后是PAR::Packer，唐凤大神的作品。</p>
<p>今天介绍另一个模块，App::Staticperl，同样是大神级作品，作者是Marc Lehmann。他的 AnyEvent、Coro、EV 无不大名鼎鼎。而staticperl，就是他开发出来用以方便自己部署程序的。</p>
<p>staticperl 官网上有一句很霸气的描述：“perl, libc, 100 modules, all in one standalone 500kb file”。</p>
<p>不过经我测试，按照官网上的步骤是做不出来这么小的单文件的！幸运的是我在 Perlmonks 上的<a href="http://www.perlmonks.org/?node_id=1065912">发问</a>很快收到了答案，这个还要用上另一个工具：upx。</p>
<p>测试过程如下：</p>
<div class="highlight"><pre><code class="bash"><span class="c"># cpanm App::Staticperl</span>
<span class="c"># staticperl install</span>
<span class="c"># staticperl instcpan AnyEvent AnyEvent::HTTP</span>
<span class="c"># staticperl mkperl -MAnyEvent -MAnyEvent::HTTP</span>
<span class="c"># staticperl mkapp myapp --boot myapp.pl -MAnyEvent -MAnyEvent::HTTP</span>
</code></pre></div>
<p>而如果是官网说的 <a href="http://staticperl.schmorp.de/smallperl.html">smallperl</a>，则是采用 <code>mkbundle</code> 的方法。</p>
<p>除了使用单独的<a href="http://staticperl.schmorp.de/smallperl.bundle">配置文件</a>存放太长的参数，其他和 <code>mkapp</code> / <code>mkperl</code> 一致。</p>
<p>不过运行结果是：生成的单个文件有3.5MB大小。</p>
<p>然后使用 upx：</p>
<div class="highlight"><pre><code class="bash"><span class="c"># apt-get install upx</span>
<span class="c"># upx --best smallperl.bin</span>
</code></pre></div>
<p>就得到压缩后的超小型perl了。这个perl内含了AE、Socket、common::sense、List::Util 等一系列常用模块可以直接使用。不过大小依然有 1.7MB 。看来是 Perl5.14 本身大小也变大了。</p>
      <a href="/2014/01/06/staticperl-and-upx" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/01/05/run-perl-code-from-webpage" title="通过网页运行 Perl 代码的安全实现" rel="bookmark">通过网页运行 Perl 代码的安全实现</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-01-05 00:00:00 +0800">05 Jan 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>这几天折腾<a href="http://www.perl-china.com">Perl中国用户组网站</a>，觉得类似 Ruby 的 tryruby，Scala 的 scala-tour 这样的新手入门教程非常好玩。于是准备自己也尝试一下。</p>
<p>理论上，通过 Ajax 传递代码到服务器上，直接 <code>eval {}</code> 即可。不过这样会导致一个安全问题。如何防止用户执行错误代码导致严重后果呢？</p>
<p>我想到了最近一直在跟踪看的 Docker 容器。如果我们把代码放在 Docker 里运行，不就不怕了么。</p>
<p>首先要构建一个可以运行大多数示例代码的 Docker 镜像。</p>
<h3 id="section">首先打开一个终端运行初始镜像：</h3>
<div class="highlight"><pre><code class="bash"><span class="c"># docker run -i -t ubuntu /bin/sh</span>
<span class="c"># apt-get install -y wget gcc make</span>
<span class="c"># useradd tour</span>
<span class="c"># echo &#39;tour hard nproc 8&#39; &gt;&gt; /etc/security/limits.conf</span>
<span class="c"># wget http://cpanmin.us -O bin/cpanm</span>
<span class="c"># cpanm List::AllUtils Moo Path::Tiny DBD::SQLite AnyEvent::HTTP DateTime</span>
</code></pre></div>
<h3 id="section-1">然后打开另一个终端保存前一个终端的变更：</h3>
<div class="highlight"><pre><code class="bash"><span class="c"># docker ps</span>
CONTAINER ID ...
<span class="c"># docker commit &lt;ID&gt; perl-tour</span>
</code></pre></div>
<p>注意一定要在之前 <code>cpanm</code> 已经成功执行完毕后保存，但是前面登录进 docker 的会话千万不要退出，否则后面的 <code>docker ps</code> 就查看不到 id 了。退出时这些临时变更都毁掉了。</p>
<p><strong>2014 年 1 月 7 日补充</strong></p>
<p>被莫莫用死循环 <code>fork()</code> 轰炸了一回，发现 docker 容器的一个问题，容器技术本身没有对用户最大进程数的限制。因为其实际运行的是 <code>docker -d</code> 服务进程的子进程。</p>
<p>直接在镜像里编辑 <code>/etc/security/limits.conf</code> 实测没有作用。而主机上限定普通用户的 nproc 也没用(因为普通用户运行不了 docker )。</p>
<p>最后想到的办法，是启动 <code>docker -d</code> 的时候，先 <code>ulimit -HSu 16</code>，这样这个 docker 下一共也跑不了多少 fork 了。</p>
<p>顺带提一句，查阅系统日志可以发现，在 fork 的时候，其实触发了主机的 OOM-killer，但是这个机制在死循环这个变态攻击下挽救不了主机……</p>
<p><strong>END</strong></p>
<p>现在我们已经有了一个安装好很多常用 CPAN 模块的镜像了。可以取构建网站了。</p>
<p>网站里添加下面一段：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">Ajax</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Temp</span> <span class="sx">qw(tempfile)</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">IPC::</span><span class="n">Run</span> <span class="sx">qw(run timeout)</span><span class="p">;</span>
<span class="n">ajax</span> <span class="s">&#39;/run&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$code</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="s">&#39;code&#39;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">@cmd</span> <span class="o">=</span> <span class="sx">qw(docker run -m 128m -u tour -v /tmp/:/tmp:ro perl-tour perl)</span><span class="p">;</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="nv">$temp</span><span class="p">)</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">();</span>
    <span class="nb">binmode</span><span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="s">&#39;:utf8&#39;</span><span class="p">);</span>
    <span class="k">print</span> <span class="nv">$fh</span> <span class="nv">$code</span><span class="p">;</span>
    <span class="nb">push</span> <span class="nv">@cmd</span><span class="p">,</span> <span class="nv">$temp</span><span class="p">;</span>
    <span class="n">run</span> <span class="o">\</span><span class="nv">@cmd</span><span class="p">,</span> <span class="o">\</span><span class="nv">$in</span><span class="p">,</span> <span class="o">\</span><span class="nv">$out</span><span class="p">,</span> <span class="o">\</span><span class="nv">$err</span><span class="p">,</span> <span class="n">timeout</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="n">debug</span><span class="p">(</span><span class="vg">$?</span><span class="p">);</span>
    <span class="nb">unlink</span> <span class="nv">$temp</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">to_json</span><span class="p">({</span>
        <span class="n">Errors</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">,</span> <span class="nv">$err</span><span class="p">)</span> <span class="p">],</span>
        <span class="n">Events</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">,</span> <span class="nv">$out</span><span class="p">)</span> <span class="p">],</span>
    <span class="p">});</span>
<span class="p">};</span>
</code></pre></div>
<p>页面上通过 Ajax 请求交互：</p>
<div class="highlight"><pre><code class="javascript">  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="s2">&quot;/run?code=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">codeStr</span><span class="p">),</span> <span class="p">{</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
    <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">Errors</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">setOutput</span><span class="p">(</span><span class="nx">outputDiv</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">Errors</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">setOutput</span><span class="p">(</span><span class="nx">outputDiv</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">Events</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">ErrEvents</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">outputDiv</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span>
        <span class="s2">&quot;Error communicating with remote server.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
</code></pre></div>
<p>静态页面部分严重参考了 Scala 的 Tour 页。趁机学习了 impress.js 制作幻灯片效果、codemirror 实现代码高亮效果。</p>
<p>最终效果见 <a href="http://www.perl-china.com/tour.html">少年 Perl 的魔法世界</a>。欢迎大家莅临指导~</p>
<p>最后，阅读了 Golang Tour 关于 <a href="http://play.golang.org">Go Playground</a> 的原理说明，发现它们是在 Google App Engine 上运行实例，然后走消息队列把代码发送给后台实例运行结果。</p>
<p>当然，Go Playground 不单单是支持 Tour，而且还包括社区各式第三方模块的测试和使用。把角色拆分出来也是正常的。</p>
      <a href="/2014/01/05/run-perl-code-from-webpage" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/01/05/future-with-anyevent" title="Future模块和AnyEvent事件驱动的结合" rel="bookmark">Future模块和AnyEvent事件驱动的结合</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-01-05 00:00:00 +0800">05 Jan 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上个月的 advent calendar 活动中，有一个新的模块进入我们视野，这就是 IO::Async 模块作者写的 <a href="https://metacpan.org/pod/Future">Future</a> 模块。通过 Future 模块，我们可以做到对异步请求的各种控制，比如：</p>
<ul>
  <li><code>needs_all</code> / <code>needs_any</code> / <code>wait_any</code> / <code>wait_all</code></li>
  <li><code>then</code> / <code>else</code> / <code>and_then</code> / <code>or_else</code> / <code>followed_by</code></li>
  <li><code>on_ready</code> / <code>on_done</code> / <code>on_fail</code> / <code>on_cancel</code></li>
</ul>
<p>目前来说，IO::Async 是原生支持 Future 了的。但是 AnyEvent 框架才是目前 Perl 社区事件驱动编程的主流选择。还好 Future 源码目录下 <a href="https://metacpan.org/source/PEVANS/Future-0.21/examples">examples/</a> 里有关于 AnyEvent 和 POE 如何跟 Future 一起运行的示例。</p>
<p>示例统一举例的是 timer 事件。而我更看好的是 <a href="https://metacpan.org/pod/Future::Utils">Future::Utils</a> 提供的一些关于循环的函数，比如 <code>fmap</code> 可以很简单的控制住异步的并发数。稍微试验，得到脚本如下：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">Future::</span><span class="n">AnyEvent</span><span class="p">;</span>
<span class="k">use</span> <span class="n">base</span> <span class="sx">qw( Future )</span><span class="p">;</span>
<span class="k">use</span> <span class="n">AnyEvent</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">HTTP</span><span class="p">;</span> 
<span class="k">sub </span><span class="nf">await</span> <span class="p">{</span>
   <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
   <span class="k">my</span> <span class="nv">$cv</span> <span class="o">=</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">condvar</span><span class="p">;</span>
   <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">on_ready</span><span class="p">(</span><span class="k">sub </span><span class="p">{</span> <span class="nv">$cv</span><span class="o">-&gt;</span><span class="nb">send</span> <span class="p">});</span>
   <span class="nv">$cv</span><span class="o">-&gt;</span><span class="nb">recv</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">httpget</span> <span class="p">{</span>
   <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
   <span class="n">http_get</span><span class="p">(</span><span class="nb">shift</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
      <span class="k">my</span> <span class="p">(</span><span class="nv">$content</span><span class="p">,</span> <span class="nv">$headers</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
      <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="nv">$content</span><span class="p">);</span>
   <span class="p">});</span>
   <span class="k">return</span> <span class="nv">$self</span><span class="p">;</span>
<span class="p">}</span>
<span class="nb">package</span> <span class="n">main</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Future::</span><span class="n">Utils</span> <span class="sx">qw/fmap/</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@urls</span> <span class="o">=</span> <span class="sx">qw(</span>
<span class="sx">    http://www.sina.com.cn</span>
<span class="sx">    http://www.baidu.com</span>
<span class="sx">    http://www.sohu.com</span>
<span class="sx">#    ...</span>
<span class="sx">)</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$f</span> <span class="o">=</span> <span class="n">fmap</span> <span class="p">{</span>
    <span class="nn">Future::</span><span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">httpget</span><span class="p">(</span> <span class="nb">shift</span> <span class="p">);</span>
<span class="p">}</span> <span class="k">foreach</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@urls</span><span class="p">,</span> <span class="n">concurrent</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@res</span> <span class="o">=</span> <span class="nv">$f</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">;</span>
<span class="k">print</span> <span class="nv">@res</span><span class="p">;</span>
</code></pre></div>
<p>看起来稍显复杂。这里其实最关键的就是几个接口函数：</p>
<ul>
  <li>await / on_ready</li>
</ul>
<p>Future 对象到实际执行时(即-&gt;get调用处)，会寻找 <code>await</code> 方法。所以必须给自己选用的事件驱动实现这个 <code>await</code> 方法。</p>
<p>ready 状态即一个 Future 执行完成，注意执行完成不意味着执行成功，ready 状态包括 success 和 fail 两种，其实是可以分别定义 <code>on_success</code> 和 <code>on_failure</code> 回调的。
<code>on_ready</code> 回调的作用是：在该 Future 对象达到 ready 状态的时候，执行这步调用。</p>
<p>在本例使用 AnyEvent 的时候，也就是一般来说都会在每步操作结束的 <code>$cv-&gt;send</code> 改到这里来等待调用。</p>
<ul>
  <li>done / done_cb</li>
</ul>
<p>那 Future 对象的 ready 状态是怎么来的呢？就是这步了：<code>$f-&gt;done</code> 一旦被调用，就意味着该 Future 对象进入了 ready and success 状态。</p>
<p>同样，如果你要详细控制 Future 对象进入具体的 ready but failure 状态，就使用 <code>$f-&gt;fail</code> 好了。</p>
<p>调用 <code>-&gt;done|fail()</code> 的时候，你可以选择传递具体哪些数据。比如本例中，就只传递了抓取的 <code>$content</code> 而没有 <code>$headers</code>。</p>
<p>Future 提供了 <code>-&gt;done_cb</code> 和 <code>-&gt;fail_cb</code> 两个回调函数，默认传递回当前全部数据。本例如果要传回全部，就可以直接写成<code>http_get shift, $self-&gt;done_cb</code>。</p>
<p>好了，就到这里。这个例子虽然比 Future 自带的 <code>anyevent.pl</code> 示例稍微复杂一点，但是依然很简单。如果能引起大家的兴趣，请直接阅读官方文档。</p>
      <a href="/2014/01/05/future-with-anyevent" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/12/31/report-of-this-year" title="2013 年度个人总结" rel="bookmark">2013 年度个人总结</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-12-31 00:00:00 +0800">31 Dec 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>又到了一年年底。照例(虽然这个例也就是去年开始的)开始年度总结。</p>
<p>在一年前写总结时，我决然想不到今年会是这样。事实上，当初的计划是往底层深入学习，在 Linux 或者 TCP/IP 方面有所得。但是一年后现在看，今年的工作依然集中在 Puppet 和 监控两方面。所以今年盘点，可能能让自己记忆深刻的，大多“功夫在课外”了。</p>
<p>年初，在编辑鼓励下开始尝试整理过去的知识体系，准备写一本网站运维相关的书籍。感谢这几年坚持记录博客，大几百的 Word 文档最后还比原计划提前写完了。写书的几个月中，我总是开玩笑的说“赚点钱买的起沙发就满足了”，虽然书还没出版，但其实这个过程中本身的收获已然很多。网上很多大神们说写书没意义，或许我还没到那种举重若轻的层次吧，我觉得这真的是一个不错的提升自我修养的手段。（当然，即便是现在回想，也觉得这过程中犯傻不断，给我一个重来的机会，绝对不选这么大话题动笔）</p>
<p>年中，参与 Perl 中国社区大会的举办。和其他老手不同，我本身只在三年前听过一次 Perl Beijing Workshop 而已，这次直接就被“骗上贼船”，作为报名网站的管理员维护一点信息发布，邀请还不算很熟的朋友一同演讲，当然也贡献了自己的第一次公开演讲。演讲前一晚，特意在家试讲让老婆帮忙提意见，毫不意外的被老婆批为乱七八糟。最后临场刚好卡在45分钟结束，但是从反响来看，依然选题有些宽泛，要在一个演讲里同时展示 Elasticsearch 的知识、logstash 的知识、Message::Passing 的知识，只能让听众更加迷惑。意外之喜是这次演讲的 slide 后来发到网上，倒是被不少外国人 like 甚至转到 twitter 上，赢得不少关注。</p>
<p>原本在 ChinaUnix 论坛上答应在大会的 lighting talk 上稍微讲一下 autobox 的运用，结果有事提前退场了，感觉失约这种事情真是超级不好意思，但愿明年还有 Perl Workshop 来给我弥补！</p>
<p>会上见到了 90 后的 Perler，会后没多久读到 stevan little 收回他《Perl isn&rsquo;t dead, Perl is dead end》一文并重启 MOP 计划的通告，让我对 Perl 的未来依然有信心多了。</p>
<p>话题之外，参加了 RubyConfChina2013，Rubist 普遍比 Perl Monger 土豪多了。我们演讲人清一色小黑，他们清一色苹果……</p>
<p>年底读了许式伟的《Go 语言编程》，完全不是给我们这些非科班的运维人员读的东西，看完以后一点对 golang 的兴趣都没有增加，虽然本人依然坚持“能够在运维社区火起来的东西肯定是比较靠谱的”。</p>
<p>博客方面，欠了两篇一直没时间写，关于 docker 如何自己作image，以及 staticperl 的使用。</p>
<p>工作之外，花了点时间在一些开源社区：</p>
<ol>
  <li>
    <p>logstash</p>
    <p>logstash 在今年渐成气候，连它的竞争对手 fluentd 在年度报告中都承认 logstash 在美国已经势不可挡(fluentd的主阵地是日本)。个人在 logstash 代码方面只是保持跟踪阅读，因为没有业务需求推动，所以不再跟去年那样大肆修改代码。倒是通过weibo、QQ等方式回答了应该有好几十个人的问题，最后在各方鼓励下开设了 logstash 的QQ群(315428175)，欢迎爱好者加入～</p>
    <p>另一个惊喜的事情，两位 logstash 同好在问完问题之后，主动送了《Elasticsearch Server》和《thelogstashbook》给我。</p>
  </li>
  <li>
    <p>Rexify</p>
    <p>Rexify 是德国2012年度最佳开源软件。不过受国内 Perl 社区总体不给力的影响，不可能如 Python 的 SaltStack 那样突然窜起。去年提交的 krb5 认证的 patch 在今年终于被作者合并，年中翻译完成了 <a href="http://rex.perl-china.com">Rexify 中文站</a> 后，有一段时间没有进展了。</p>
  </li>
  <li>
    <p>Docker</p>
    <p>这是今年下半年重点看好的项目。博客中从 8 月开始就有好几篇关于这个内容，甚至专门订阅了 DockerWeekly。Docker 文档非常全，使用非常简单，实在爱不释手，最近老琢磨如何用在工作中去。最后这周，配合 pstuifzand 改进 Docker 的 <a href="https://github.com/chenryn/docker-perl">Perl 客户端</a>，主要是他写的时候 docker 默认还是监听在本地的 4243 端口，现在已经改成 <code>/var/run/docker.sock</code> 了。于是把 <code>Net::Docker</code> 里 <code>LWP::UserAgent</code> 和 <code>AnyEvent::HTTP</code> 的 Unix-Socket 支持都实现出来。</p>
    <p>另一方面，也给 Rexify 项目实现了 <code>Rex::Virtualization::Docker</code> 的支持，不过这个则是调用 docker 命令行的方式。</p>
    <p>最后，强烈谴责 GFW 屏蔽 Docker 的 CDN 边缘节点 IP 地址的行为。我本来提议让官方提供镜像方式，让我们在国内作镜像服务。结果官方表示 <code>docker pull</code> 的过程中连接了多个 api 服务，不是单单搞镜像可以解决的。目前只能是通过绑定 /etc/hosts 的方式直接访问官方的源站 IP，不走 CDN 了。</p>
  </li>
  <li>
    <p>Perl</p>
    <p>Perl5 社区今年发起了一系列活动，激发社区活跃性。其中包括一项挽救濒死模块。根据自己的情况，花了 3 个月时间走流程，最终成功认领了 <code>HTML::TagHelper</code> 模块。这个模块的原作者是个北欧妹纸，后来写 php 去了，看 linkedin 信息都已经是 CTO 了。</p>
    <p>因为工作中用到 MooseFS，所以仿造 moosefs.cgi 里的接口写了 Perl 版的模块发到 CPAN，结果 moosefs 的作者之一 peter aNeutrino 主动发邮件来问是否需要更多帮助。只能说大神们真的好热情……</p>
    <p>和氓氓等一起试图给 PerlChina 增加活跃气氛，申请了 <a href="http://weibo.com/perldaily">@perldaily</a> 帐号专门发技术内容，创建了 <a href="http://www.perl-china.com">www.perl-china.com</a> 网站。总的来说，努力过，成效就不在能力范围内了。</p>
  </li>
</ol>
<p>再说一些跟国外的事情，虽然都是小事，但迈出第一步，总是值得纪念的：</p>
<ol>
  <li>Perl 社区每年12月会发起 advent calendar 活动。今年主动去日本的 Qiita 技术社区投稿，写了一篇文章讲 Rex::Box 的运用。虽然写不来日语，不过代码就是最好的语言～～</li>
  <li>被 facebook 的 tech recruiter 找上来聊天，算是见识了一下除了美剧以外的英语，嗯，也就如此了。</li>
</ol>
<p>最后一项不得不记的，关于比特币。我个人其实没有资金投入到这场狂欢中，不过暴赚几十万的同事、步步踩空的同事历历在目。一方面也回顾了一下当初的股票分析知识，通过程序作出了一些“不负责任的”指导意见，没有被同事们暴揍，算是一件很值得娱乐的事情～
从严肃意义上来说，这件事情提醒了已经迈向26岁的自己，你已经不年轻了，Perl 之外，请考虑人生和理财的问题。</p>
<p>&ldquo;Yes, sir!&rdquo;</p>
      <a href="/2013/12/31/report-of-this-year" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/12/09/draw-charts-of-bitcoin" title="为比特币绘制 MACD、BOLL、KDJ 指标图" rel="bookmark">为比特币绘制 MACD、BOLL、KDJ 指标图</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-12-09 00:00:00 +0800">09 Dec 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#python-ref" title="python" rel="category tag">python</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>比特币是最近相当火爆的一个金融衍生品(瞧咱这口径)。比特币中国提供了一系列 API 来获取和操纵其市场内的比特币。我的小伙伴们基于其 API，完成了一套交易程序。为了提高操作的有效性和技术性，同时作为 python 学习需要，我也参与进来，仿造股票交易软件，为比特币中国绘制了一系列指标图，包括 MACD、BOLL、KDJ 等。截止上周，btc123 也开始提供了 MACD 指标图，所以把自己的实现贴到博客。</p>
<p>首先是获取数据，比特币中国的 API 是个很鬼怪的东西，实时交易数据的接口，返回的数据中最高最低和成交量都是基于过去24小时的，要知道比特币交易是没有休市的啊。所以获取数据过程中需要自己计算这些。这里考虑到股市一般一天实际交易4小时，所以整个设计也是默认4小时的图形展示。</p>
<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/env python3</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># query price data from BTCChina.</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;config.yaml&#39;</span><span class="p">))</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;host&#39;</span><span class="p">],</span><span class="n">user</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;username&#39;</span><span class="p">],</span><span class="n">passwd</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;password&#39;</span><span class="p">],</span><span class="n">db</span> <span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;databasename&#39;</span><span class="p">],</span><span class="n">charset</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;encoding&#39;</span><span class="p">]</span> <span class="p">)</span>
<span class="k">def</span> <span class="nf">write_db</span><span class="p">(</span><span class="n">datas</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cur_write</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span>  <span class="s">&quot;insert into ticker(sell, buy, last, vol, high, low) values( </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;</span>
        <span class="n">cur_write</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">datas</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">cur_write</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Mysql error </span><span class="si">%d</span><span class="s"> : </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_tid</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">vol_url</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;btcchina&#39;</span><span class="p">][</span><span class="s">&#39;vol_url&#39;</span><span class="p">]</span>
        <span class="n">remote_file</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">vol_url</span><span class="p">)</span>
        <span class="n">remote_data</span> <span class="o">=</span> <span class="n">remote_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">remote_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">remote_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">remote_data</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">remote_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;tid&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Mysql error </span><span class="si">%d</span><span class="s"> : </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_ohlc</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">read</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">hlvsql</span> <span class="o">=</span> <span class="s">&quot;select max(last),min(last) from ticker where time between date_add(now(),interval -</span><span class="si">%s</span><span class="s"> minute) and now()&quot;</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">hlvsql</span><span class="p">)</span>
        <span class="n">high</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">closesql</span> <span class="o">=</span> <span class="s">&quot;select last from ticker where time between date_add(now(),interval -</span><span class="si">%s</span><span class="s"> minute) and now() order by time desc limit 1&quot;</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">closesql</span><span class="p">)</span>
        <span class="n">close</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">opensql</span> <span class="o">=</span> <span class="s">&quot;select last from ticker where time between date_add(now(),interval -</span><span class="si">%s</span><span class="s"> minute) and now() order by time asc limit 1&quot;</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">opensql</span><span class="p">)</span>
        <span class="n">opend</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">opend</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Mysql error </span><span class="si">%d</span><span class="s"> : </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">write_ohlc</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cur_write</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">ohlcsql</span> <span class="o">=</span>  <span class="s">&#39;insert into ohlc(open, high, low, close, vol) values( </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&#39;</span>
        <span class="n">cur_write</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ohlcsql</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">cur_write</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Mysql error </span><span class="si">%d</span><span class="s"> : </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;执行Mysql写入数据时出错: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>  <span class="n">e</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">instance</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
    <span class="c"># returns something like {&quot;high&quot;:738.88,&quot;low&quot;:689.10,&quot;buy&quot;:713.50,&quot;sell&quot;:717.30,&quot;last&quot;:717.41,&quot;vol&quot;:4797.32000000}</span>
        <span class="n">remote_file</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;btcchina&#39;</span><span class="p">][</span><span class="s">&#39;ticker_url&#39;</span><span class="p">])</span>
        <span class="n">remote_data</span> <span class="o">=</span> <span class="n">remote_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">remote_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">remote_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">remote_data</span><span class="p">))[</span><span class="s">&#39;ticker&#39;</span><span class="p">]</span>
    <span class="c">#   remote_data = {key:literal_eval(remote_data[key]) for key in remote_data}</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">remote_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">remote_data</span><span class="p">:</span>
        <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remote_data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">datas</span>
<span class="n">lastid</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ohlc_period</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">next_ohlc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">/</span> <span class="n">ohlc_period</span> <span class="o">*</span> <span class="n">ohlc_period</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">datas</span> <span class="o">=</span> <span class="n">instance</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">datas</span><span class="p">:</span>
        <span class="n">write_db</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">next_ohlc</span><span class="p">):</span>
        <span class="n">next_ohlc</span> <span class="o">+=</span> <span class="n">ohlc_period</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_ohlc</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">latestid</span> <span class="o">=</span> <span class="n">get_tid</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">latestid</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastid</span><span class="p">))</span>
        <span class="n">lastid</span> <span class="o">=</span> <span class="n">latestid</span>
        <span class="n">write_ohlc</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p>这里主要把实时数据存入ticker表，分钟统计数据存入ohlc表。然后是各指标算法。首先是 MACD ：</p>
<div class="highlight"><pre><code class="python"><span class="c">#/*******************************************************************************</span>
<span class="c"># * Author: Chenlin Rao | Renren inc.</span>
<span class="c"># * Email: rao.chenlin@gmail.com</span>
<span class="c"># * Last modified: 2013-11-26 22:02</span>
<span class="c"># * Filename: macd.py</span>
<span class="c"># * Description: </span>
<span class="c">#       EMA(12)=LastEMA(12)* 11/13 + Close * 2/13</span>
<span class="c">#       EMA(26)=LastEMA(26)* 25/27 + Close * 2/27</span>
<span class="c">#       </span>
<span class="c">#       DIF=EMA(12)-EMA(26)</span>
<span class="c">#       DEA=LastDEA * 8/10 + DIF * 2/10</span>
<span class="c">#       MACD=(DIF-DEA) * 2</span>
<span class="c"># * *****************************************************************************/</span>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="k">class</span> <span class="nc">MACD</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;config.yml&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sleep_time</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;btcchina&#39;</span><span class="p">][</span><span class="s">&#39;trade_option&#39;</span><span class="p">][</span><span class="s">&#39;sleep_time&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;host&#39;</span><span class="p">],</span><span class="n">user</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;username&#39;</span><span class="p">],</span><span class="n">passwd</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;password&#39;</span><span class="p">],</span><span class="n">db</span> <span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;databasename&#39;</span><span class="p">],</span><span class="n">charset</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;encoding&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_getclose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;select close,time from ohlc order by id desc limit </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_ema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns an n period exponential moving average for</span>
<span class="sd">        the time series s</span>
<span class="sd">        s is a list ordered from oldest (index 0) to most</span>
<span class="sd">        recent (index -1)</span>
<span class="sd">        n is an integer</span>
<span class="sd">        returns a numeric array of the exponential</span>
<span class="sd">        moving average</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;No enough item in </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">s</span>
        <span class="n">ema</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c">#get n sma first and calculate the next n period ema</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span> <span class="o">/</span> <span class="n">n</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">ema</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sma</span><span class="p">)</span>
        <span class="c">#EMA(current) = ( (Price(current) - EMA(prev) ) x Multiplier) + EMA(prev)</span>
        <span class="n">ema</span><span class="o">.</span><span class="n">append</span><span class="p">((</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">sma</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span> <span class="o">+</span> <span class="n">sma</span><span class="p">)</span>
        <span class="c">#now calculate the rest of the values</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">ema</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span> <span class="o">+</span> <span class="n">ema</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">ema</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ema</span>
    <span class="k">def</span> <span class="nf">getMACD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getclose</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">array</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span>
        <span class="n">short_ema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ema</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">long_ema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ema</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">short_ema</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">long_ema</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">diff</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">dea</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ema</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">diff</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dea</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">33</span><span class="p">:],</span> <span class="n">diff</span><span class="p">[</span><span class="mi">8</span><span class="p">:]),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">33</span><span class="p">:],</span> <span class="n">dea</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">33</span><span class="p">:],</span> <span class="n">bar</span><span class="p">)</span>
</code></pre></div>
<p>然后是 BOLL ：</p>
<div class="highlight"><pre><code class="python"><span class="c">#/*******************************************************************************</span>
<span class="c"># * Author: Chenlin Rao | Renren inc.</span>
<span class="c"># * Email: rao.chenlin@gmail.com</span>
<span class="c"># * Last modified: 2013-11-26 22:02</span>
<span class="c"># * Filename: macd.py</span>
<span class="c"># * Description: </span>
<span class="c">#       MA=avg(close(20))</span>
<span class="c">#       MD=std(close(20))</span>
<span class="c">#       </span>
<span class="c">#       MB=MA(20)</span>
<span class="c">#       UP=MB + 2*MD</span>
<span class="c">#       DN=MB - 2*MD</span>
<span class="c"># * *****************************************************************************/</span>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="k">class</span> <span class="nc">BOLL</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;config.yml&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sleep_time</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;btcchina&#39;</span><span class="p">][</span><span class="s">&#39;trade_option&#39;</span><span class="p">][</span><span class="s">&#39;sleep_time&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;host&#39;</span><span class="p">],</span><span class="n">user</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;username&#39;</span><span class="p">],</span><span class="n">passwd</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;password&#39;</span><span class="p">],</span><span class="n">db</span> <span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;databasename&#39;</span><span class="p">],</span><span class="n">charset</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;encoding&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_getMA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
    <span class="k">def</span> <span class="nf">_getMD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
        <span class="n">average</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">array</span><span class="p">:</span> <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">average</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="n">length</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">def</span> <span class="nf">getOHLC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;select time,open,high,low,close,vol from ohlc order by id desc limit </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span> <span class="n">results</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">_getCur</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fromtime</span><span class="p">):</span>
        <span class="n">curread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursql</span> <span class="o">=</span> <span class="s">&quot;select last,vol from ticker where time between date_add(&#39;</span><span class="si">%s</span><span class="s">&#39;, interval -0 minute) and now()&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%F</span><span class="s"> %T&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">fromtime</span><span class="p">))</span>
        <span class="n">curread</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cursql</span><span class="p">)</span>
        <span class="n">curlist</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curread</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="n">vollist</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">curread</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="n">curlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="p">(</span><span class="n">curlist</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">curlist</span><span class="p">),</span> <span class="n">curlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vollist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">_getClose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="n">close</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">matrix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">close</span>
    <span class="k">def</span> <span class="nf">getBOLL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOHLC</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCur</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
        <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getClose</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="n">up</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">days</span>
        <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
            <span class="n">curmb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMA</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">days</span><span class="p">:</span><span class="n">x</span><span class="p">])</span>
            <span class="n">curmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMD</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">days</span><span class="p">:</span><span class="n">x</span><span class="p">])</span>
            <span class="n">mb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">matrix</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">curmb</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">up</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">matrix</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">curmb</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">curmd</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">dn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">matrix</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">curmb</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">curmd</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">matrix</span><span class="p">[</span><span class="n">days</span><span class="p">:],</span> <span class="n">up</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">dn</span>
</code></pre></div>
<p>最后是 KDJ ：</p>
<div class="highlight"><pre><code class="python"><span class="c">#/*******************************************************************************</span>
<span class="c"># * Author: Chenlin Rao | Renren inc.</span>
<span class="c"># * Email: rao.chenlin@gmail.com</span>
<span class="c"># * Last modified: 2013-11-26 22:02</span>
<span class="c"># * Filename: macd.py</span>
<span class="c"># * Description: </span>
<span class="c">#       RSV=(close-low(9))/(high(9)-low(9))*100</span>
<span class="c">#       K=SMA(RSV(3), 1)</span>
<span class="c">#       D=SMA(K(3), 1)</span>
<span class="c">#       J=3*K-2*D</span>
<span class="c"># * *****************************************************************************/</span>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="k">class</span> <span class="nc">KDJ</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;config.yml&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sleep_time</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;btcchina&#39;</span><span class="p">][</span><span class="s">&#39;trade_option&#39;</span><span class="p">][</span><span class="s">&#39;sleep_time&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;host&#39;</span><span class="p">],</span><span class="n">user</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;username&#39;</span><span class="p">],</span><span class="n">passwd</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;password&#39;</span><span class="p">],</span><span class="n">db</span> <span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;databasename&#39;</span><span class="p">],</span><span class="n">charset</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;encoding&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_getHLC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;select high,low,close,time from ohlc order by id desc limit </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_avg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
    <span class="k">def</span> <span class="nf">_getMA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
        <span class="n">array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">window</span>
        <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="n">curmb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">window</span><span class="p">:</span><span class="n">x</span><span class="p">])</span>
            <span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">curmb</span> <span class="p">)</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">array</span>
    <span class="k">def</span> <span class="nf">_getRSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrays</span><span class="p">):</span>
        <span class="n">rsv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">):</span>
            <span class="n">high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arrays</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">9</span><span class="p">:</span><span class="n">x</span><span class="p">]))</span>
            <span class="n">low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">arrays</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">9</span><span class="p">:</span><span class="n">x</span><span class="p">]))</span>
            <span class="n">close</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">rsv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">close</span><span class="o">-</span><span class="n">low</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">high</span><span class="o">-</span><span class="n">low</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">times</span><span class="p">,</span> <span class="n">rsv</span>
    <span class="k">def</span> <span class="nf">getKDJ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="n">hlc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getHLC</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">rsv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getRSV</span><span class="p">(</span><span class="n">hlc</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMA</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMA</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">3</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">d</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">k</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">d</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">j</span><span class="p">)</span>
</code></pre></div>
<p>最后通过一个简单的python web框架完成界面展示，这个叫 bottle.py 的框架是个单文件，相当方便。</p>
<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">macd</span> <span class="kn">import</span> <span class="n">MACD</span>
<span class="kn">from</span> <span class="nn">boll</span> <span class="kn">import</span> <span class="n">BOLL</span>
<span class="kn">from</span> <span class="nn">kdj</span> <span class="kn">import</span> <span class="n">KDJ</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">static_file</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">template</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;config.yml&#39;</span><span class="p">))</span>
<span class="n">color</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;cn&#39;</span><span class="p">:{</span><span class="s">&#39;up&#39;</span><span class="p">:</span><span class="s">&#39;#ff0000&#39;</span><span class="p">,</span><span class="s">&#39;dn&#39;</span><span class="p">:</span><span class="s">&#39;#00ff00&#39;</span><span class="p">},</span>
    <span class="s">&#39;us&#39;</span><span class="p">:{</span><span class="s">&#39;dn&#39;</span><span class="p">:</span><span class="s">&#39;#ff0000&#39;</span><span class="p">,</span><span class="s">&#39;up&#39;</span><span class="p">:</span><span class="s">&#39;#00ff00&#39;</span><span class="p">},</span>
<span class="p">}</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/mkb/240&#39;</span><span class="p">)</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">&#39;/mkb/&lt;ago:int&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mkb</span><span class="p">(</span><span class="n">ago</span><span class="p">):</span>
    <span class="n">like</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;webui&#39;</span><span class="p">][</span><span class="s">&#39;color&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s">&#39;webui&#39;</span><span class="p">,</span> <span class="n">ago</span> <span class="o">=</span> <span class="n">ago</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="n">like</span><span class="p">])</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">&#39;/js/&lt;filename&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">js</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">static_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s">&#39;./js/&#39;</span><span class="p">)</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">&#39;/boll&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">boll</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">&quot;boll&quot;</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">&#39;/macd/&lt;day:int&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">macd</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">MACD</span><span class="p">()</span>
    <span class="n">dif</span><span class="p">,</span> <span class="n">dea</span><span class="p">,</span> <span class="n">bar</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">getMACD</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;dif&#39;</span><span class="p">:</span><span class="n">dif</span><span class="p">,</span> <span class="s">&#39;dea&#39;</span><span class="p">:</span><span class="n">dea</span><span class="p">,</span> <span class="s">&#39;bar&#39;</span><span class="p">:</span><span class="n">bar</span><span class="p">})</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">&#39;/boll/&lt;day:int&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">boll</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">BOLL</span><span class="p">()</span>
    <span class="n">ohlc</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">dn</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">getBOLL</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;ohlc&#39;</span><span class="p">:</span><span class="n">ohlc</span><span class="p">,</span> <span class="s">&#39;up&#39;</span><span class="p">:</span><span class="n">up</span><span class="p">,</span> <span class="s">&#39;md&#39;</span><span class="p">:</span><span class="n">md</span><span class="p">,</span> <span class="s">&#39;dn&#39;</span><span class="p">:</span><span class="n">dn</span><span class="p">})</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">&#39;/kdj/&lt;day:int&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">kdj</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
    <span class="n">kdj</span> <span class="o">=</span> <span class="n">KDJ</span><span class="p">()</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">kdj</span><span class="o">.</span><span class="n">getKDJ</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;k&#39;</span><span class="p">:</span><span class="n">k</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span> <span class="s">&#39;j&#39;</span><span class="p">:</span><span class="n">j</span><span class="p">})</span>
<span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div>
<p>唯一的一个 html 就是具体用 highcharts 画图的地方，如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
   <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;refresh&quot;</span> <span class="na">content=</span><span class="s">&quot;60&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
   <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;/js/highstock.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
   <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;/js/highcharts.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
   <span class="nt">&lt;script&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">Highcharts</span><span class="p">.</span><span class="nx">setOptions</span><span class="p">({</span>  
            <span class="nx">global</span><span class="o">:</span> <span class="p">{</span>  
                <span class="nx">useUTC</span><span class="o">:</span> <span class="kc">false</span>  
            <span class="p">}</span>  
        <span class="p">});</span> 
        <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;/boll/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bolldata</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ohlc</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="nx">volume</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="nx">dataLength</span> <span class="o">=</span> <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dataLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">ohlc</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span>
                <span class="p">]);</span>
                <span class="nx">volume</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span>
                <span class="p">])</span>
            <span class="p">};</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;/kdj/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">kdjdata</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;/macd/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">macddata</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#container&#39;</span><span class="p">).</span><span class="nx">highcharts</span><span class="p">(</span><span class="s1">&#39;StockChart&#39;</span><span class="p">,</span> <span class="p">{</span>
                        <span class="nx">rangeSelector</span><span class="o">:</span> <span class="p">{</span>
                            <span class="nx">enabled</span><span class="o">:</span> <span class="mi">0</span>
                        <span class="p">},</span>
                        <span class="nx">chart</span><span class="o">:</span> <span class="p">{</span>
                            <span class="nx">backgroundColor</span><span class="o">:</span> <span class="s1">&#39;#333333&#39;</span><span class="p">,</span>
                        <span class="p">},</span>
                	    <span class="nx">tooltip</span><span class="o">:</span> <span class="p">{</span>
                	    	<span class="nx">formatter</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                				<span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="s1">&#39;&lt;b&gt;&#39;</span><span class="o">+</span> <span class="nx">Highcharts</span><span class="p">.</span><span class="nx">dateFormat</span><span class="p">(</span><span class="s1">&#39;%A, %b %e, %H:%M&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;&lt;/b&gt;&#39;</span><span class="p">;</span>
                				<span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">points</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">point</span><span class="p">)</span> <span class="p">{</span>
                					<span class="nx">s</span> <span class="o">+=</span> <span class="s1">&#39;&lt;br/&gt;&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">series</span><span class="p">.</span><span class="nx">name</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="o">+</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">point</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
                				<span class="p">});</span>
                				<span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
                			<span class="p">}</span>
                	    <span class="p">},</span>
                        <span class="nx">plotOptions</span><span class="o">:</span> <span class="p">{</span>
                            <span class="nx">series</span><span class="o">:</span> <span class="p">{</span>
                                <span class="nx">marker</span><span class="o">:</span> <span class="p">{</span>
                                    <span class="nx">enabled</span><span class="o">:</span> <span class="kc">false</span>
                                <span class="p">},</span>
                                <span class="nx">lineWidth</span><span class="o">:</span> <span class="mf">1.1</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">},</span>
                        <span class="nx">yAxis</span><span class="o">:</span> <span class="p">[{</span>
                          <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
                              <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;MACD(12,26,9)&#39;</span>
                          <span class="p">},</span>
                          <span class="nx">height</span><span class="o">:</span> <span class="mi">200</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                          <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
                              <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;KDJ(9,3,3)&#39;</span>
                          <span class="p">},</span>
                          <span class="nx">top</span><span class="o">:</span> <span class="mi">250</span><span class="p">,</span>
                          <span class="nx">height</span><span class="o">:</span> <span class="mi">150</span><span class="p">,</span>
                          <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="nx">gridLineDashStyle</span><span class="o">:</span> <span class="s1">&#39;Dash&#39;</span><span class="p">,</span>
                          <span class="nx">tickPositions</span><span class="o">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
                                <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;BOLL(20)&#39;</span>
                            <span class="p">},</span>
                            <span class="nx">top</span><span class="o">:</span> <span class="mi">450</span><span class="p">,</span>
                            <span class="nx">height</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
                            <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
                                <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;VOL&#39;</span>
                            <span class="p">},</span>
                            <span class="nx">top</span><span class="o">:</span> <span class="mi">800</span><span class="p">,</span>
                            <span class="nx">height</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
                            <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">}],</span>
                        <span class="nx">series</span><span class="o">:</span> <span class="p">[{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;BAR&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="nx">negativeColor</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="nx">borderColor</span><span class="o">:</span> <span class="s1">&#39;#333333&#39;</span><span class="p">,</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;column&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">macddata</span><span class="p">[</span><span class="s1">&#39;bar&#39;</span><span class="p">],</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;DIFF&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">,</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">macddata</span><span class="p">[</span><span class="s1">&#39;dif&#39;</span><span class="p">],</span>
                            <span class="nx">lineWidth</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;DEA&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#ffff00&#39;</span><span class="p">,</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">macddata</span><span class="p">[</span><span class="s1">&#39;dea&#39;</span><span class="p">],</span>
                            <span class="nx">lineWidth</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">,</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">kdjdata</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#ffff00&#39;</span><span class="p">,</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">kdjdata</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">],</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#cc99cc&#39;</span><span class="p">,</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">kdjdata</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">],</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;candlestick&#39;</span><span class="p">,</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;ohlc&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">ohlc</span><span class="p">,</span>
                            <span class="nx">upColor</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="nx">upLineColor</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="nx">lineColor</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;spline&#39;</span><span class="p">,</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;up&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">],</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#ffff00&#39;</span><span class="p">,</span>
                            <span class="nx">lineWidth</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;spline&#39;</span><span class="p">,</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;md&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;md&#39;</span><span class="p">],</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">,</span>
                            <span class="nx">lineWidth</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;spline&#39;</span><span class="p">,</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;dn&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;dn&#39;</span><span class="p">],</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#cc99cc&#39;</span><span class="p">,</span>
                            <span class="nx">lineWidth</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;VOL&#39;</span><span class="p">,</span>
                            <span class="nx">borderColor</span><span class="o">:</span> <span class="s1">&#39;#333333&#39;</span><span class="p">,</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;column&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">volume</span><span class="p">,</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="p">}]</span>
                    <span class="p">});</span>
                <span class="p">});</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span> 
   <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
   <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;container&quot;</span> <span class="na">style=</span><span class="s">&quot;min-width:800px;height:1000px;&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>highcharts 有个问题，就是不能跟 amcharts 或者 echarts 那样提供一个画笔工具，让用户自己在生成的图形上再涂抹线条，这个功能其实在蜡烛图上判断压力位支撑位的时候很有用。不过蜡烛图 btc123 也提供了，我也就懒得再用 amcharts 重写一遍。</p>
<p>效果如下：</p>
<p><img src="/images/uploads//btc.png" alt="" /></p>
      <a href="/2013/12/09/draw-charts-of-bitcoin" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/12/09/add-mailinglist-command-to-gitolite" title="为 gitolite 实现 mailinglist 命令行操控" rel="bookmark">为 gitolite 实现 mailinglist 命令行操控</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-12-09 00:00:00 +0800">09 Dec 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>&lt;embed src=&rsquo;http://www.docin.com/DocinViewer-737880351-144.swf&rsquo; width=&rsquo;100%&rsquo; height=&rsquo;600&rsquo; type=application/x-shockwave-flash ALLOWFULLSCREEN=&rsquo;true&rsquo; ALLOWSCRIPTACCESS=&rsquo;always&rsquo;&gt;&lt;/embed&gt;</p>
<p>或者上微盘下载
<a href="http://vdisk.weibo.com/s/CW3E1ZROXE9g">http://vdisk.weibo.com/s/CW3E1ZROXE9g</a></p>
      <a href="/2013/12/09/add-mailinglist-command-to-gitolite" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/11/04/puppet-class-parameter" title="Puppet 的类参数传递" rel="bookmark">Puppet 的类参数传递</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-11-04 00:00:00 +0800">04 Nov 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#puppet-ref" title="puppet" rel="category tag">puppet</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前使用 ENC 管理 puppet，尽量保持了输出 yaml 内容的简单，只提供了一个统一的全局参数定义 node 的 role。(题外话，puppetlabs 推荐了另一个通过继承关系实现 role 的示例，见：<a href="http://www.craigdunn.org/2012/05/239/">Designing Puppet - Roles and Profiles</a>。)</p>
<p>但是 puppet 中有些配置确实修改比较频繁，文件操作不得不说是一件不甚方便的事情，于是重新考虑通过类参数的方式来灵活化某些配置的操作。</p>
<h1 id="section">修改前</h1>
<h3 id="nginxmanifestsinitpp">nginx/manifests/init.pp</h3>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="n">nginx</span> <span class="p">{</span>
    <span class="kp">include</span> <span class="s2">&quot;nginx::${::role}&quot;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="nginxmanifestsloadbalancerpp">nginx/manifests/loadbalancer.pp</h3>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="ss">nginx</span><span class="p">:</span><span class="ss">:loadbalancer</span> <span class="p">{</span>
    <span class="vg">$iplist</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;192.168.0.2:80&#39;</span><span class="o">]</span>
    <span class="n">file</span> <span class="p">{</span> <span class="s1">&#39;nginx.conf&#39;</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;nginx/nginx.conf.erb&#39;</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="enc-nginxhostname">enc nginxhostname</h3>
<div class="highlight"><pre><code class="yaml"><span class="nn">---</span>
<span class="l-Scalar-Plain">classes</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">nginx</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">base</span>
<span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">production</span>
<span class="l-Scalar-Plain">parameters</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">loadbalancer</span>
</code></pre></div>
<h1 id="section-1">修改后</h1>
<h3 id="nginxmanifestsinitpp-1">nginx/manifests/init.pp</h3>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="n">nginx</span> <span class="p">(</span><span class="vg">$iplist</span> <span class="o">=</span> <span class="o">[]</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">class</span> <span class="p">{</span> <span class="s2">&quot;nginx::${::role}&quot;</span><span class="p">:</span>
        <span class="n">iplist</span> <span class="o">=&gt;</span> <span class="vg">$iplist</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="nginxmanifestsloadbalancerpp-1">nginx/manifests/loadbalancer.pp</h3>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="ss">nginx</span><span class="p">:</span><span class="ss">:loadbalancer</span> <span class="p">(</span><span class="vg">$iplist</span> <span class="o">=</span> <span class="o">[]</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">file</span> <span class="p">{</span> <span class="s1">&#39;nginx.conf&#39;</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;nginx/nginx.conf.erb&#39;</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="enc-nginxhostname-1">enc nginxhostname</h3>
<div class="highlight"><pre><code class="yaml"><span class="nn">---</span>
<span class="l-Scalar-Plain">classes</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">nginx</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">iplist</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">192.168.0.2:80</span>
  <span class="l-Scalar-Plain">base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~</span>
<span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">production</span>
<span class="l-Scalar-Plain">parameters</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">loadbalancer</span>
</code></pre></div>
<h1 id="section-2">要点</h1>
<ol>
  <li>虽然真正需要 $iplist 的是下面的一个子类，但是 ENC 传值是给的父类，所以需要一层层传递下去；</li>
  <li>ENC 中给类传参，类就要写成哈希形式，否则是数组形式；</li>
  <li>有参数的类，在调用的时候无法使用 <code>include</code> 形式的写法，只能用资源调用形式的写法。</li>
</ol>
<p>修改中出现了一个很搞笑的错误，因为是在 vim 里批量转换，结果子类名字后面多了一个空格，成了<code>class { "nginx::${::role} ":</code>这样。结果 puppet 一直返回报错说 &ldquo;Invalid Parameter&rdquo;。这时候一个习惯性的思维造成了误会：我们一般会认为<code>:</code>后面的那一行行键值对才是 parameter，但其实这里子类名也是 <code>class</code> 这个资源调用的 parameter。当然，如果可以在这里报一个 <code>Class Not Found</code> 就更好了。</p>
      <a href="/2013/11/04/puppet-class-parameter" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/11/04/perl-unpack-tongdaxin" title="用 Perl 读取通达信日线数据" rel="bookmark">用 Perl 读取通达信日线数据</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-11-04 00:00:00 +0800">04 Nov 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前看 skyline 的报警机制的时候，为了寻找测试数据，曾经想到是不是可以用股价走势。其实股价走势分析也是一个很深的编程领域，有些选股软件一份就好几千的卖。当然我这里没兴趣和时间搞那么复杂了。简单的说一下如何从通达信的存档里读取日线数据，说到底还是 <code>pack/unpack</code> 的运用：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!perl</span>
<span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&#39;C:\new_sxzq_v6\vipdoc\sh\lday\sh000001.day&#39;</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span> <span class="nb">sysread</span> <span class="nv">$fh</span><span class="p">,</span> <span class="k">my</span> <span class="nv">$buf</span><span class="p">,</span> <span class="mi">32</span> <span class="p">)</span> <span class="p">{</span>
<span class="c1"># 日期，开盘，最高，最低，收盘，成交金额，成交量，预留位</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$date</span><span class="p">,</span> <span class="nv">$open</span><span class="p">,</span> <span class="nv">$high</span><span class="p">,</span> <span class="nv">$low</span><span class="p">,</span> <span class="nv">$close</span><span class="p">,</span> <span class="nv">$amount</span><span class="p">,</span> <span class="nv">$vol</span><span class="p">,</span> <span class="nv">$reserved</span> <span class="p">)</span> <span class="o">=</span>
      <span class="nb">unpack</span><span class="p">(</span> <span class="s">&#39;Ii4fi2&#39;</span><span class="p">,</span> <span class="nv">$buf</span> <span class="p">);</span>
    <span class="nb">printf</span> <span class="s">&quot;%s %.2f %.2f %.2f %.2f %d %d\n&quot;</span><span class="p">,</span> <span class="nv">$date</span><span class="p">,</span> <span class="nv">$open</span> <span class="sr">/ 100, $high /</span> <span class="mi">100</span><span class="p">,</span>
      <span class="nv">$low</span> <span class="sr">/ 100, $close /</span> <span class="mi">100</span><span class="p">,</span> <span class="nv">$amount</span><span class="p">,</span> <span class="nv">$vol</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>注意这里一定要一边 <code>sysread</code> 一边 <code>while</code>，否则一只股票的历史(上例中是上证指数)都没读完就会内存溢出的。</p>
      <a href="/2013/11/04/perl-unpack-tongdaxin" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/10/26/selinux-affect-to-apache-documentroot" title="selinux 对 webserver 文件发布的影响" rel="bookmark">selinux 对 webserver 文件发布的影响</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-10-26 00:00:00 +0800">26 Oct 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>SELinux 在国内是一个很少有人用的东西，一般来说，服务器上手第一件事情就是把 SELinux 关掉，以至于有问题的时候排查思路里都压根没检查 SELinux 这步。</p>
<p>昨天在个人电脑的 Fedora 上搭建一个 webserver 发布几个文件，本来想着简单任务越快越好，几行命令完成：</p>
<div class="highlight"><pre><code class="bash">sudo yum install httpd
sudo mv ~/src /var/www/html/
sudo service httpd start
</code></pre></div>
<p>结果居然一直返回 <code>403 Denied</code>！</p>
<p>看 httpd 的 error.log ，一直报这么一行错误：</p>
<pre><code>[core:error] [pid 3806] (13)Permission denied: [client 127.0.0.1:59180] AH00035: access to /src/master.zip denied (filesystem path '/var/www/html/src') because search permissions are missing on a component of the path
</code></pre>
<p>很奇怪吧，于是我先去确认了 httpd.conf 里关于 <code>&lt;Directory "/var/www/html"&gt;</code> 的配置(因为 Fedora19 的 httpd 版本是 2.4.6，我以为新版本有变化了)，然后去确认了 <code>/var/www/html/src</code> 的权限是不是 755，其他用户可读的。都没问题！</p>
<p>最后还是在 apache 的 httpd 官方文档上找到了关于这个错误码的详细解释，原来还有一种可能性，就是 SELinux 的安全控制！这个可以通过下面这个命令看到：</p>
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>ls -lZ /var/www /var/www/html
/var/www:
drwxr-xr-x. root   root   system_u:object_r:httpd_sys_script_exec_t:s0 cgi-bin
drwxr-xr-x. apache apache system_u:object_r:httpd_sys_content_t:s0 html
/var/www/html:
drwxr-xr-x. chenlin.rao chenlin.rao unconfined_u:object_r:user_home_t:s0 src
</code></pre></div>
<p>看到没有，这里这些文件的 SELinux 类型是不一样的，默认的 <code>/var/www/html</code> 是 <code>httpd_sys_content_t</code>，<code>/var/www/cgi-bin</code> 是 <code>httpd_sys_script_exec_t</code>，而从我家目录移过去的 <code>/var/www/html/src</code> 是 <code>user_home_t</code>！</p>
<p>解决办法也很简单，把这个类型也改过来就好了：</p>
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>chcon -R -t httpd_sys_content_t /var/www/html/src
</code></pre></div>
<p>这是第一次接触 SELinux 的安全管理，真的是好细致！</p>
      <a href="/2013/10/26/selinux-affect-to-apache-documentroot" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/10/25/intro-plenv" title="用 plenv 代替 perlbrew 管理 Perl5" rel="bookmark">用 plenv 代替 perlbrew 管理 Perl5</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-10-25 00:00:00 +0800">25 Oct 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>我们都知道有 virtualenv 啊，rvm 啊之类的工具来管理 python，ruby的多版本问题，后来台湾的朋友也引入到了 Perl 世界，这就是 perlbrew。</p>
<p>不过 perlbrew 在使用的时候，有个非常让我不理解的地方，就是切换 Perl 版本后，整个终端的环境变量都被清空了。后来发现了一个新项目，叫 plenv，没错，一眼就可以看出来这是 rlenv 工具的 Perl 版。</p>
<p>和 perlbrew 不一样，目前版本的 plenv 已经是一个纯粹的 shell 工具。说起来原先一直是 shell 工具的 rvm，这周却在募捐准备改用 Ruby 重写了(据说是因为已经 2 万行的 bash 代码，作者快控制不住了)。</p>
<p>用法非常简单：</p>
<div class="highlight"><pre><code class="bash">git clone git://github.com/tokuhirom/plenv.git ~/.plenv
<span class="nb">echo</span> <span class="s1">&#39;export PATH=&quot;$HOME/.plenv/bin:$PATH&quot;&#39;</span> &gt;&gt; ~/.bash_profile
<span class="nb">echo</span> <span class="s1">&#39;eval &quot;$(plenv init -)&quot;&#39;</span> &gt;&gt; ~/.bash_profile
<span class="nb">exec</span> <span class="nv">$SHELL</span> -l <span class="c"># 这步相当于退出重登录终端</span>
git clone git://github.com/tokuhirom/Perl-Build.git ~/.plenv/plugins/perl-build/
plenv install 5.18.0
plenv rehash <span class="c"># 每次在 $HOME/.plenv/bin 下安装了新的命令后都要执行一次这个</span>
plenv install-cpanm
plenv rehash
plenv shell 5.18.0 <span class="c"># 还有 global 和 local 两者可设</span>
</code></pre></div>
<p>目前我已经用 plenv 管理自己电脑上的 Perl5 了，你们呢？</p>
      <a href="/2013/10/25/intro-plenv" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/10/16/perl-overload" title="Perl 的 overload 妙用" rel="bookmark">Perl 的 overload 妙用</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-10-16 00:00:00 +0800">16 Oct 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在使用 Mojolicious 的时候，通常我们会发现一个很有趣的现象。</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">ojo</span><span class="p">;</span>
<span class="n">say</span> <span class="n">g</span><span class="p">(</span><span class="s">&#39;http://www.baidu.com&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dom</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="s">&#39;script&#39;</span><span class="p">);</span>
<span class="n">say</span> <span class="n">g</span><span class="p">(</span><span class="s">&#39;http://www.baidu.com&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dom</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="s">&#39;script&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">;</span>
</code></pre></div>
<p>这里可以看到，在用 <code>at()</code> 方法之后得到的结果，如果从上一行解读，似乎应该是一个字符串；但是从下一行解读，又还是一个对象，可以继续调用 <code>-&gt;text</code> 属性。</p>
<p>Perl 本身不是一个纯对象式的语言，字符串本身是没有对象属性的。而直接打印对象的话，应该输出的是类似 <code>Mojo::DOM-&gt;HASH(0x1234567)</code> 的效果。那这个效果是怎么实现的呢？</p>
<p>翻了 Mojo 的代码之后，发现原来 Mojo 里是把字符串、数组等都实现成了对象，分别是 <code>Mojo::ByteStream</code> 和 <code>Mojo::Collection</code> 两个类。然后再实现中，运用了 <code>overload</code> 来实现这个效果。代码很简单，<code>Mojo::ByteStream</code> 里是这样的：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">overload</span> <span class="s">&#39;&quot;&quot;&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="nb">shift</span><span class="o">-&gt;</span><span class="n">to_string</span> <span class="p">},</span> <span class="n">fallback</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">to_string</span> <span class="p">{</span> <span class="nv">$</span><span class="p">{</span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span> <span class="p">}</span>
</code></pre></div>
<p>此外， <code>Mojo::DOM</code>，<code>Mojo::URL</code>，<code>Mojo::JSON</code> 等十多个类中都用了这个方法。</p>
<p>看起来似乎还不是很明了，再贴两段 <a href="http://perldoc.perl.org/overload.html">overload 的 POD</a> 就清楚了：</p>
<pre><code>It also defines an anonymous subroutine to implement stringification: this is called whenever an object blessed into the package Number is used in a string context...
For example, the subroutine for '""' (stringify) may be used where the overloaded object is passed as an argument to print,...
</code></pre>
<p>这下清楚了吧。一旦在某个类里 <code>overload</code> 了双引号，那么这个类的对象在标量环境下调用的时候就会先调用这个函数。最典型的例子就是用在 <code>print</code> 的时候。</p>
<p>下面我们可以自己也试试：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="n">Test</span> <span class="mf">0.01</span> <span class="p">{</span>
    <span class="k">use</span> <span class="n">overload</span> <span class="s">&#39;&quot;&quot;&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="nb">join</span> <span class="s">&quot; overloaded.\n&quot;</span><span class="p">,</span> <span class="nv">@</span><span class="p">{</span><span class="o">+</span><span class="nb">shift</span><span class="p">}</span> <span class="p">};</span>
    <span class="k">sub </span><span class="nf">new</span> <span class="p">{</span> <span class="nb">bless</span> <span class="p">[</span><span class="nv">@_</span><span class="p">[</span><span class="mi">1</span> <span class="o">..</span> <span class="nv">$#_</span><span class="p">]],</span> <span class="nb">shift</span> <span class="p">};</span>
<span class="p">}</span>
<span class="k">my</span> <span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Test</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">print</span> <span class="nv">$obj</span><span class="p">;</span>
</code></pre></div>
<p>输出结果：</p>
<pre><code>1 overloaded.
3 overloaded.
2
</code></pre>
      <a href="/2013/10/16/perl-overload" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/10/09/using-elasticsearch-and-logstash-to-serve-billions-of-searchable-events-for-customers" title="【翻译】用 elasticsearch 和 logstash 为数十亿次客户搜索提供服务" rel="bookmark">【翻译】用 elasticsearch 和 logstash 为数十亿次客户搜索提供服务</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-10-09 00:00:00 +0800">09 Oct 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>原文地址：<a href="http://www.elasticsearch.org/blog/using-elasticsearch-and-logstash-to-serve-billions-of-searchable-events-for-customers/">http://www.elasticsearch.org/blog/using-elasticsearch-and-logstash-to-serve-billions-of-searchable-events-for-customers/</a></p>
<hr />
<p><em>今天非常高兴的欢迎我们的第一个外来博主，Rackspace软件开发工程师，目前为Mailgun工作的 <a href="https://twitter.com/ralphm">Ralph Meijer</a>。我们在 <a href="http://monitorama.eu/">Monitorama EU</a> 会面后，Ralph 提出可以给我们写一篇 Mailgun 里如何使用 Elasticsearch 的文章。他本人也早就活跃在 Elasticsearch 社区，经常参加我们在荷兰的聚会了。</em></p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/09/mailgun_150-300x85.png" alt="" /></p>
<p><a href="http://www.mailgun.com/">Mailgun</a> 收发大量电子邮件，我们跟踪和存储每封邮件发生的每个事件。每个月会新增数十亿事件，我们都要展示给我们的客户，方便他们很容易的分析数据，也就是全文搜索。下文是我们利用Elasticsearch和Logstash技术完成这个需求的技术细节（很高兴刚写完这篇文章就听说《<a href="http://elasticsearch.com/blog/welcome-jordan-logstash/">Logstash加入Elasticsearch</a>》了）。</p>
<h1 id="section">事件</h1>
<p>在 Mailgun 里，event可能是如下几种：进来一条信息，可能被接收可能被拒绝；出去一条信息，可能被投递可能被拒绝(垃圾信息或者反弹)；信息是直接打开还是通过链接点击打开；收件人要求退订。所有这些事件，都有一些元信息可以帮助我们客户找出他们的信息什么时候，为什么，发生了什么。这个元信息包括：信息的发送者，收件人地址，信息id，SMTP错误码，链接URL，geo地理位置等等。</p>
<p>每个事件都是由一个时间戳和一系列字段构成的。一个典型的事件就是一个关联数组，或者叫字典、哈希表。</p>
<h1 id="section-1">事件访问设计</h1>
<p>假设我们已经有了各种事件，现在需要一个办法来给客户使用。在Mailgun的控制面板里，有一个日志标签，可以以时间倒序展示事件日志，并且还可以通过域名和级别来过滤日志，示例如下：</p>
<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/mailgun_log_sample.png" alt="" /></p>
<p>在这个示例里，这个事件的级别是&rdquo;warn&rdquo;，因为SMTP错误码说明这是一个临时性问题，我们稍后会重试投递。这里有两个字段，一个时间戳，一个还没格式化的非结构化文本信息。为了醒目，这里我们会根据级别的不同给事件上不同的底色。</p>
<p>在这个网页之后，我还有一个接收日志的API，一个设置触发报警的hook页面。后面的报警完全是结构化了的带有很多元数据字段的JSON文档。比如，SMTP错误码有自己的字段，收件人地址和邮件标题等也都有。</p>
<p>不幸的是，原有的日志API非常有限。他只能返回邮件投递时间和控制面板里展示的非结构化的文本内容。没办法获取或者搜索多个字段(像报警页面里那样)，更不要说全文搜索了。简单说，就是控制面板缺乏全文搜索。</p>
<h1 id="elasticsearch">用elasticsearch存储和响应请求</h1>
<p>要给控制面板提供API和访问，我们需要一个新的后端来弥补前面提到的短板，包括下面几个新需求：</p>
<ul>
  <li>允许大多数属性的过滤。</li>
  <li>允许全文搜索。</li>
  <li>支持存储至少30天数据，可以有限度的轮滚。</li>
  <li>添加节点即可轻松扩展。</li>
  <li>节点失效无影响。</li>
</ul>
<p>而Elasticsearch，是一个可以“准”实时入库、实时请求的搜索引擎。它基于Apache Lucene，由存储索引的节点组成一个分布式高可用的集群。单个节点离线，集群会自动把索引(的分片)均衡到剩余节点上。你可以配置具体每个索引有多少分片，以及这些分片该有多少副本。如果一个主分片离线，就从副本中选一个出来提升为主分片。</p>
<p>Elasticsearch 是面向文档的，某种层度上可以说也是无模式的。这意味着你可以传递任意JSON文档然后就可以索引成字段。对我们的事件来说完全符合要求。</p>
<p>Elasticsearch 同样还有一个非常强大的请求/过滤接口，可以对特定字段搜索，也可以做全文搜索。</p>
<h1 id="elasticsearch-1">事件存入elasticsearch</h1>
<p>有很多工具或者服务可以用来记录事件。我们最终选择了 <a href="http://logstash.net/">Logstash</a>，一个搜集、分析、管理和传输日志的工具。</p>
<p>在内部，通过webhooks推送来的event同时在我们系统的其他部分也有使用，目前我们是用Redis来完成这个功能。Logstash有一个Redis输入插件来从Redis列表里接收日志事件。通过几个小过滤器后，事件通过一个输出插件输出。最常用的输出插件就是 Elasticsearch 插件。</p>
<p>利用 Elasticsearch 丰富的 API 最好的办法就是使用 Kibana，这个工具的口号是“让海量日志有意义”。目前最新的 <a href="http://three.kibana.org/">Kibana 3</a> 是一个纯粹的 JavaScript 客户端版，随后也会成为 Logstash 的默认界面。和之前的版本不同的是，它不在依赖于一个类Logstash模式，而是可以用于任意Elasticsearch索引。</p>
<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/kibana%20events%202.png" alt="" /></p>
<h1 id="section-2">认证</h1>
<p>到这步，我们已经解决了事件集中的问题，也有了丰富的API来深入解析日志。但是我们不想把所有日志都公开给每个人，所以我们需要一个认证，目前Elasticsearch 和 Kibana 都没提供认证功能，所以寄希望于 Elasticsearch API 是不可能的了。</p>
<p>我们选择了构建双层代理。一层代理用来做认证和流量限速，一层用来转义我们的事件 API 成 Elasticsearch 请求。前面这层代理我们已经以 Apache 2.0 开原协议发布在Github上，叫 <a href="https://github.com/mailgun/vulcan">vulcan</a> 。我们还把我们原来的那套日志 API 也转移到了 Elasticsearch 系统上。</p>
<h1 id="section-3">索引设计</h1>
<p>有很多种方法来确定你如何组织自己的索引，基于文档的数目(每个时间段内)，以及查询模式。</p>
<p>Logstash 默认每天创建一个新索引，包括当天收到的全部时间。你可以通过配置修改这个时间，或者采用其他属性来区分索引，比如每个用户一个，或者用事件类型等等。</p>
<p>我们这里每秒有1500个时间，而且我们希望每个账户的轮转时间段都是可配置的。可选项有：</p>
<ul>
  <li>一个大索引。</li>
  <li>每天一个索引。</li>
  <li>每个用户账户一个索引。</li>
</ul>
<p>当然，如果需要的话，这些都可以在未来进一步切分，比如根据事件类型。</p>
<p>管理轮滚的一个办法是在 Elasticsearch 中给每个文档设定 <a href="http://www.elasticsearch.org/guide/reference/mapping/ttl-field/">TTLs</a> 。到了时间  Elasticsearch 就会批量删除过期文档。这种做法使得定制每个账户的轮转时间变得很简单，但是也带来了更多的 IO 操作。</p>
<p>另一个轻量级的办法是直接删除整个索引。这也是 Logstash 默认以天创建索引的原因。过了这天你直接通过 crontab 任务删除索引即可。</p>
<p>不过后面这个办法就没法定制轮转了。我们有很多用户账户，给每个用户每天保持一个索引是不切实际的。当然，给所有用户每天存一个索引又意味着我们要把所有数据都存磁盘上。如果一个账户是保持两天数据的轮转，那么在缓存中的数据就是有限的。在查询多天的垃圾邮件时，处理性能也就受限了。所以，我们需要保留更多的日志以供Kibana访问。</p>
<h1 id="section-4">映射</h1>
<p>为了定义文档(中的字段)如何压缩、索引和存储在索引里，Elasticsearch 有一个叫做 <a href="http://www.elasticsearch.org/guide/reference/mapping/">mapping</a> 的概念。所以为每个字段它都定义了类型，定义了如何分析和标记字段的值以便索引和查询，定义了值是否需要存储，以及其他各种设置。默认的情况，mapping是动态的，也就是说 Elasticsearch 会从它获得的第一个值来尝试猜测字段的类型，然后正式应用这个设置到索引。</p>
<p>如果你的数据来源单一，这样就很好了。但实际可能来源很复杂，或者日志类型根本就不一样，比如我们这，同一个名字的字段的数据类型可能都不一样。 Elasticsearch 会拒绝索引一个类型不匹配的文档，所以我们需要自定义 mapping 。</p>
<p>通过我们的 <a href="http://documentation.mailgun.com/api-events.html">Events API</a> ，我给日志事件的类型定义了一个映射。不是所有的事件都有所有这些字段，不过相同名字的字段肯定是一致的。</p>
<h1 id="section-5">分析器</h1>
<p>默认情况下，字段的 mapping 中就带有 标准分析器。简单的说，就是字符串会被转成小写，然后分割成一个一个单词。然后这些标记化的单词再写入银锁，并指向具体的字段。</p>
<p>有些情况，你可能想要些别的东西来完成不同的效果。比如说账户 ID，电子邮件地址或者网页链接 URL之类的，默认标记器会以斜线分割，而不考虑把整个域名作为一个单独的标记。当你通过 facet 统计域名字段的时候，你得到的会是域名中一段一段标签的细分结果。</p>
<p>要解决这个问题，可以设置索引属性，给对应字段设置成 <code>not_analyzed</code>。这样在插入索引的时候，这个字段不再经过映射或者标记器。比如对 <code>domain.name</code> 字段应用这个设置后，每个域名都会完整的作为同一个标签统计 facet 了。</p>
<p>如果你还想在这个字段内通过部分内容查找，你可以使用 <a href="http://www.elasticsearch.org/guide/reference/mapping/multi-field-type/">multi-field type</a>。这个类型可以映射相同的值到不同的核心类型或者属性，然后在不同名称下使用。我们对 IP 地址就使用了这个技术。默认的字段(比如叫<code>sending-ip</code>)的类型就是 ip，而另一个非默认字段(比如叫 <code>sending-ip.untouched</code>)则配置成 <code>not_analyzed</code> 而且类型为字符串。这样，默认字段可以做 IP 地址专有的范围查询，而 <code>.untouched</code> 字段则可以做 facet 查询。</p>
<p>除此以外，绝大多数字段我们都没用分析器和标记器。不过我们正在考虑未来可以结合上面的多字段类型技巧，应用 <a href="http://www.elasticsearch.org/guide/reference/index-modules/analysis/pattern-capture-tokenfilter/">pattern capture tokenfilter</a> 到某些字段(比如电子邮件地址)上。</p>
<h1 id="section-6">监控</h1>
<p>要知道你的集群怎么样，你就必须要监控它。 Elasticsearch 有非常棒的 API 来获取 <a href="http://www.elasticsearch.org/guide/reference/api/admin-cluster-state/">cluster state</a> 和 <a href="http://www.elasticsearch.org/guide/reference/api/admin-cluster-nodes-stats/">node statistics</a>。我们可以用 <a href="http://graphite.wikidot.com/">Graphite</a> 来存储这些指标并且做出综合表盘，下面就是其中一个面板：</p>
<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/graphite%20monitoring.png" alt="" /></p>
<p>为了收集这些数据并且传输到 Graphite，我创建了 <a href="http://github.com/mochi/vor">Vör</a>，已经在 <a href="http://www.mochimedia.com/">Mochi Media</a> 下用 MIT/X11 协议开源了。另外一个保证 Redis 列表大小的收集器也在开发中。</p>
<p>除此以外，我们还统计很多东西，比如邮件的收发、点击数，API调用和耗时等等，这些是通过 <a href="https://github.com/etsy/statsd">StatsD</a> 收集的，同样也添加到我们的 Graphite 表盘。</p>
<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/graphite%20events.png" alt="" /></p>
<p>这绝对是好办法来观察发生了什么。Graphite 有一系列函数可以用来在绘图前作处理，也可以直接返回JSON文档。比如，我们可以很容易的创建一个图片展示 API 请求的数量与服务器负载或者索引速度的联系。</p>
<h1 id="section-7">当前状况</h1>
<p>我们的一些数据：</p>
<ul>
  <li>每天大概4kw 到 6kw 个日志事件。</li>
  <li>30天轮转一次日志。</li>
  <li>30个索引。 </li>
  <li>每个索引5个分片。 </li>
  <li>每个分片一个1副本。 </li>
  <li>每个索引占 2 * 50 到 80 GB空间(因为有副本所以乘2)。</li>
</ul>
<p>为此，我们启动了一共 9 台 Rackspace 云主机，具体配置是这样的：</p>
<ul>
  <li>6x 30GB RAM, 8 vCPUs, 1TB disk: Elasticsearch 数据节点。</li>
  <li>2x 8GB RAM, 4 vCPUs: Elasticsearch 代理节点， Logstash， Graphite 和 StatsD。</li>
  <li>2x 4GB RAM, 2 core: Elasticsearch 代理节点， Vulcan 和 API 服务器</li>
</ul>
<p>大多数主机最终会迁移到专属的平台上，同时保留有扩展新云主机的能力。</p>
<p>Elasticsearch 数据节点都配置了 16GB 内存给 JVM heap。其余都是标准配置。此外还设置了 fieldcache 最大大小为 heap 的 40%，以保证集群不会在 facet 和 sort 内容很多的字段时挂掉。我们同时也增加了一点 <a href="http://www.elasticsearch.org/guide/reference/api/admin-cluster-update-settings/">cluster wide settings</a> 来加速数据恢复和重均衡。另外，相对于我们存储的文档数量来说，<code>indices.recovery.max_bytes_per_sec</code> 的默认设置实在太低了。</p>
<h1 id="section-8">总结</h1>
<p>我们非常高兴用 Elasticsearch 来保存我们的事件，也得到了试用新 API 和新控制面板中新日志页面的客户们非常积极的反馈。任意字段的可搜索对日志挖掘绝对是一种显著的改善，而 Elasticsearch 正提供了这种高效无痛的改进。当然，Logstash，Elasticsearch 和 Kibana 这整条工具链也非常适合内部应用日志处理。</p>
<p>如果你想了解更多详情或者对我们的 API 有什么疑问，尽管留言。也可以在 Mailgun 博客上<a href="http://blog.mailgun.com/post/new-events-api-detailed-email-tracking-and-search/">阅读更多关于事件 API 的细节</a>。</p>
<p>开心处理日志，开心发送邮件！</p>
      <a href="/2013/10/09/using-elasticsearch-and-logstash-to-serve-billions-of-searchable-events-for-customers" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/09/14/elasticsearch-for-rexify-website" title="用 ElasticSearch 支持 Rexify 网站的搜索功能" rel="bookmark">用 ElasticSearch 支持 Rexify 网站的搜索功能</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-09-14 00:00:00 +0800">14 Sep 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>最近给 Rexify 官网做<a href="http://rex.perl-china.com">中文化</a>工作，除了文字翻译之外，还要负责把服务正常跑起来。网站本身就是一个 <code>Mojolicious</code> 写的小东西，用 <code>morbo html/website.pl</code> 命令直接运行就可以监听在 3000 端口，然后通过 nginx 代理发布即可。</p>
<p>不过官网上还有一个高级功能需要另外支持，那就是搜索。</p>
<p>Rexify 官网的搜索功能是通过 ElasticSearch 提供的。这里需要注意一点，官方提供的 <code>create_index.pl</code> 中，并不是直接把文件内容本身存入 ES 索引的(之前介绍过的 <code>devopsweekly_index.pl</code> 脚本就是这样做的)，而是编码成 Base64 之后再以附件形式存储。</p>
<p>一开始我没注意到这点，结果搜索结果里一直只有标题和链接，没有高亮内容。后来发现是存的 base64 编码后又很疑惑 Rexify 官网是如何把 base64 再解码回来到网页上显示的。幸亏后来想到去 ElasticSearch 官网搜索一下 base64 关键词，然后发现了专门的<a href="https://github.com/elasticsearch/elasticsearch-mapper-attachments">介绍页面</a>。原来是有一个<a href="https://github.com/elasticsearch/elasticsearch-mapper-attachments">插件</a>实现的附件解析，调用了 Apache Tika 库，也就意味着支持 HTML/XML/Office/ODF/PDF/Epub/RTF/TXT/ZIP/MP3/JPG/FLV/Mbox/JAR 等等各种格式的文件。</p>
<p>所以，安装这个插件，然后重建索引，就可以正常提供搜索功能了：</p>
<pre><code>/usr/share/elasticsearch/bin/plugin -install elasticsearch/elasticsearch-mapper-attachments/1.9.0
rexify-website/create_index.pl localhost 9200 html/templates
</code></pre>
<p>脚本本身超级简单，欢迎大家自行阅读。</p>
      <a href="/2013/09/14/elasticsearch-for-rexify-website" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/09/10/different-format-character-of-pack-between-python-and-perl" title="Perl 和 Python 的 pack 函数格式字符的区别" rel="bookmark">Perl 和 Python 的 pack 函数格式字符的区别</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-09-10 00:00:00 +0800">10 Sep 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>MooseFS 是运用很广泛的一个分布式文件系统，其自带有一个 python 写的 CGI 页面，可以查看集群状态。不过对于运维来说，这就不太方便纳入 nagios 等其他现有的监控体系中。好在既然它的 CGI 是 python 写的，那么自己照样临摹出一个监控脚本也不是太复杂。</p>
<p>其实整个数据是由 master 的 9421 端口进行 TCP 交互获取的，不过比较麻烦的是并不是普通文本流。CGI 中采用了 pack/unpack 函数来处理 TCP 包。根据数据的前 8 字节确定数据总长度和 MooseFS 的版本，然后依照不同版本的 pack 方式来 unpack 剩余内容。</p>
<p>笔者熟悉 Perl，所以就准备将这个处理流程改用 Perl 完成。结果发现原来 pack/unpack 在 Perl 和 Python 中，写法是不一样的。以 MooseFS 的 info 信息读取代码为例，Python 版如下：</p>
<div class="highlight"><pre><code class="python"><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">masterhost</span><span class="p">,</span> <span class="n">masterport</span><span class="p">))</span>
<span class="n">mysend</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&gt;LL&quot;</span><span class="p">,</span> <span class="mi">510</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">myrecv</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">cmd</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;&gt;LL&quot;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
<span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="mi">511</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">76</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">myrecv</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">memusage</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">avail</span><span class="p">,</span> <span class="n">trspace</span><span class="p">,</span> <span class="n">trfiles</span><span class="p">,</span> <span class="n">respace</span><span class="p">,</span> <span class="n">refiles</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">allcopies</span><span class="p">,</span> <span class="n">tdcopies</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;&gt;HBBQQQQLQLLLLLLL&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">ver</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">v3</span><span class="p">)])</span>
</code></pre></div>
<p>而 Perl 版最终写完是这样的：</p>
<div class="highlight"><pre><code class="perl"><span class="k">my</span> <span class="nv">$s</span> <span class="o">=</span> <span class="nn">IO::Socket::</span><span class="n">INET</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
    <span class="n">PeerAddr</span> <span class="o">=&gt;</span> <span class="nv">$host</span><span class="p">,</span>
    <span class="n">PeerPort</span> <span class="o">=&gt;</span> <span class="nv">$port</span><span class="p">,</span>
    <span class="n">Proto</span>    <span class="o">=&gt;</span> <span class="s">&#39;tcp&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
<span class="k">print</span> <span class="nv">$s</span> <span class="nb">pack</span><span class="p">(</span><span class="s">&#39;(LL)&gt;&#39;</span><span class="p">,</span> <span class="mi">510</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nb">sysread</span> <span class="nv">$s</span><span class="p">,</span> <span class="nv">$header</span><span class="p">,</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$cmd</span><span class="p">,</span> <span class="nv">$length</span><span class="p">)</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s">&#39;(LL)&gt;&#39;</span><span class="p">,</span> <span class="nv">$header</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span> <span class="nv">$cmd</span> <span class="o">==</span> <span class="mi">511</span> <span class="ow">and</span> <span class="nv">$length</span> <span class="o">==</span> <span class="mi">76</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nb">sysread</span> <span class="nv">$s</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$length</span><span class="p">;</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$v1</span><span class="p">,</span> <span class="nv">$v2</span><span class="p">,</span> <span class="nv">$v3</span><span class="p">,</span> <span class="nv">$memusage</span><span class="p">,</span> <span class="nv">$total</span><span class="p">,</span> <span class="nv">$avail</span><span class="p">,</span> <span class="nv">$trspace</span><span class="p">,</span> <span class="nv">$trfiles</span><span class="p">,</span> <span class="nv">$respace</span><span class="p">,</span> <span class="nv">$refiles</span><span class="p">,</span> <span class="nv">$nodes</span><span class="p">,</span> <span class="nv">$dirs</span><span class="p">,</span> <span class="nv">$files</span><span class="p">,</span> <span class="nv">$chunks</span><span class="p">,</span> <span class="nv">$allcopies</span><span class="p">,</span> <span class="nv">$tdcopies</span><span class="p">)</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s">&#39;(SCCQQQQLQLLLLLLL)&gt;&#39;</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$ver</span> <span class="o">=</span> <span class="s">&quot;$v1.$v2.$v3&quot;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>不同处主要有两点：</p>
<ol>
  <li>关于 <code>big-endian</code> 定义的 <code>&gt;</code> 符号位置不同，Python 里写在起首一次性全部生效；Perl 里需要每个格式符单独定义，或者采用括号合起来总定义；</li>
  <li>Python 里的 <code>H</code> 格式符表示 <code>unsigned short</code>，在 Perl 里应该是 <code>S</code>；Python 里的 <code>B</code> 格式符表示 <code>unsigned char</code>，在 Perl 里应该是 <code>C</code>。</li>
</ol>
<p>翻看了一下，在 PHP 和 Ruby 中，格式符定义和 Perl 是一样的，不清楚为什么 Python 这么特殊==!</p>
<p>各语言关于 <code>pack</code> 格式符的文档链接如下：</p>
<ol>
  <li><a href="http://www.w3school.com.cn/php/func_misc_pack.asp">http://www.w3school.com.cn/php/func_misc_pack.asp</a></li>
  <li><a href="http://www.kuqin.com/rubycndocument/man/pack_template_string.html">http://www.kuqin.com/rubycndocument/man/pack_template_string.html</a></li>
  <li><a href="http://docs.python.org/2/library/struct.html">http://docs.python.org/2/library/struct.html</a></li>
  <li><a href="http://perldoc.perl.org/functions/pack.html">http://perldoc.perl.org/functions/pack.html</a></li>
</ol>
      <a href="/2013/09/10/different-format-character-of-pack-between-python-and-perl" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/08/27/using-docker-on-rhel6-the-hard-way" title="编译最新 3.10 内核在 RHEL6 上支持 Docker" rel="bookmark">编译最新 3.10 内核在 RHEL6 上支持 Docker</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-08-27 00:00:00 +0800">27 Aug 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cloud-ref" title="cloud" rel="category tag">cloud</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前在 Fedora19 上试图自己通过编译 3.10 内核的方式来完成 aufs 的支持，但是一直有问题，哪怕同样的步骤，github 上其他人都可以，只能怀疑是我个人电脑问题了。不过后来通过 SPEC 方式完成了最终测试，感谢 sciurus 童鞋的<a href="https://github.com/sciurus/docker-rhel-rpm">项目</a>。</p>
<p>部署过程如下：</p>
<div class="highlight"><pre><code class="bash"><span class="c"># 安装这个包以便使用 mock 命令在 chroot 环境下打包</span>
yum install -y fedora-packager
<span class="c"># 下载我的而不是原作者的，因为里面 aufs 和 lxc 的下载链接都已经更新了，原来的404了</span>
git clone https://github.com/chenryn/docker-rhel-rpm.git
spectool -g -C docker docker/docker.spec 
mock -r epel-6-x86_64 --buildsrpm --spec docker/docker.spec --sources docker --resultdir output
mock -r epel-6-x86_64 --rebuild --resultdir output output/docker-0.6.0-1.el6.src.rpm 
spectool -g -C lxc lxc/lxc.spec
mock -r epel-6-x86_64 --buildsrpm --spec lxc/lxc.spec --sources lxc --resultdir output
mock -r epel-6-x86_64 --rebuild --resultdir output output/lxc-0.8.0-3.el6.src.rpm
spectool -g -C kernel-ml-aufs kernel-ml-aufs/kernel-ml-aufs-3.10.spec
mock -r epel-6-x86_64 --buildsrpm --spec kernel-ml-aufs/kernel-ml-aufs-3.10.spec --sources kernel-ml-aufs --resultdir output
mock -r epel-6-x86_64 --rebuild --resultdir output output/kernel-ml-aufs-3.10.5-1.el6.src.rpm
<span class="nb">cd </span>output
yum localinstall --nogpgcheck kernel-ml-aufs-3.10.5-1.el6.x86_64.rpm lxc-0.8.0-3.el6.x86_64.rpm lxc-libs-0.8.0-3.el6.x86_64.rpm docker-0.6.0-1.el6.x86_64.rpm
<span class="nb">echo</span> <span class="s1">&#39;none                    /sys/fs/cgroup          cgroup  defaults        0 0&#39;</span> &gt; /etc/fstab
reboot
</code></pre></div>
<p>kernel 文件来自 RHEL，不过我试了下，在我的Fedora19上也正常可用。3.10.5 和 3.2 相比，第一 3.10 将会是未来一段时间内 kernel 的主线支持；第二 docker 官方说在 3.8 之前有点小 bug 可能会被触发。</p>
      <a href="/2013/08/27/using-docker-on-rhel6-the-hard-way" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/08/26/running-perldancer-on-docker" title="在 Docker 上运行 PerlDancer 示例" rel="bookmark">在 Docker 上运行 PerlDancer 示例</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-08-26 00:00:00 +0800">26 Aug 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cloud-ref" title="cloud" rel="category tag">cloud</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>搭建好了 docker 环境后，就可以来试试用 docker 跑一个应用实例来看看了。和 Vagrant 比较类似，docker 也是用一个配置文件来规划其基础镜像内的部署，不过值得注意的是，在 <code>Dockerfile</code> 里的每一个指令成功执行后，docker 默认都会 commit 一次，这样就节省了一些空间和时间。</p>
<p>构建失败的镜像，在 <code>docker images</code> 命令输出中显示为 <code>&lt;none&gt;</code> 可以根据具体的 commit id，调用 <code>docker rmi &lt;id&gt;</code> 命令清除。</p>
<p>一个比较简单的 <code>Dockerfile</code> 示例是这样的：</p>
<div class="highlight"><pre><code class="ruby"><span class="no">FROM</span> <span class="ss">centos</span><span class="p">:</span><span class="mi">6</span><span class="o">.</span><span class="mi">4</span>
<span class="no">RUN</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">make</span> <span class="n">gcc</span> <span class="n">wget</span> <span class="n">perl</span> <span class="n">perl</span><span class="o">-</span><span class="n">devel</span> <span class="n">perl</span><span class="o">-</span><span class="no">Time</span><span class="o">-</span><span class="no">HiRes</span> <span class="n">perl</span><span class="o">-</span><span class="no">CGI</span> <span class="n">perl</span><span class="o">-</span><span class="n">libwww</span><span class="o">-</span><span class="n">perl</span> <span class="n">perl</span><span class="o">-</span><span class="no">Module</span><span class="o">-</span><span class="no">Build</span> <span class="n">perl</span><span class="o">-</span><span class="no">Test</span><span class="o">-</span><span class="no">Simple</span> <span class="n">perl</span><span class="o">-</span><span class="no">Test</span><span class="o">-</span><span class="no">Deep</span> <span class="n">perl</span><span class="o">-</span><span class="no">YAML</span>
<span class="no">RUN</span> <span class="n">wget</span> <span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="n">cpanmin</span><span class="o">.</span><span class="n">us</span>
<span class="no">RUN</span> <span class="n">perl</span> <span class="n">cpanm</span> <span class="no">Dancer</span>
<span class="no">ADD</span> <span class="sr">/var/</span><span class="n">www</span><span class="o">/</span><span class="n">dancerapp</span> <span class="n">app</span>
<span class="no">EXPOSE</span> <span class="mi">3000</span>
<span class="no">CMD</span> <span class="n">perl</span> <span class="n">app</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">pl</span>
</code></pre></div>
<p>然后运行如下命令构建镜像：</p>
<pre><code>docker build -t chenryn/perldancer
</code></pre>
<p>如果构建都成功的话，那就是正式运行了：</p>
<pre><code>docker run -p 8080:3000 -d chenryn/perldancer
</code></pre>
<p>运行起来以后，可以通过 <code>docker ps</code> 命令看到本机上运行着的容器状态信息。同样，也可以通过映射的 8080 端口访问到页面了。</p>
<p>正在测试通过 <code>plenv</code> 来使用高版本的 perl，目前比较郁闷的是因为 <code>plenv</code> 是通过 <code>~/.profile</code> 来在每次登陆的时候自动切换到指定版本的，而 <code>docker</code> 里的 <code>RUN</code> 调用 <code>/bin/sh -c</code> 不会调用到这些文件，所以一直还是使用系统自带版本。而在 <code>RUN</code> 指令里每行都写一个 <code>source $HOME/.profile</code> 也很难看的。</p>
      <a href="/2013/08/26/running-perldancer-on-docker" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/08/24/using-docker-on-centos6" title="快速在 CentOS6 上运行 docker" rel="bookmark">快速在 CentOS6 上运行 docker</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-08-24 00:00:00 +0800">24 Aug 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cloud-ref" title="cloud" rel="category tag">cloud</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>docker 是由著名 PAAS 公司 dotcloud 开源的 linux 容器项目，在此之前，只有 cloudfoundry 下属的 warden 半死不活的慢慢前进着。</p>
<p>不管是 docker 还是 warden，其原理大多是通过 LXC( 即 CGroup 和 namespace 的结合)以及 AUFS 的结合，完成比较彻底的容器虚拟化。这里有个问题：AUFS 不是 linux 官版内核支持的文件系统。所以到现在，各种 PAAS 都是运行在 Ubuntu 系统上，因为只有这个系列的发行版默认打了 AUFS 的补丁。这也严重影响了 PAAS 开源社区的扩容：</p>
<ol>
  <li>RedHat 发行版系列才是企业用户最多的 linux 发行版；</li>
  <li>Debian 社区已经宣布在未来会放弃默认打 AUFS 补丁的做法。</li>
</ol>
<p>docker 目前已经在积极准备将代码 port 到 BtrFS 上以备未来，不过在此之前，我们还是可以通过自己打补丁的方式，在 RedHat 系列上尝试 docker 的。目前社区已经有很多尝试：</p>
<ol>
  <li><a href="http://neh.al/?p=1">Installing Docker on Fedora 18</a></li>
  <li><a href="http://blog.rage.net/2013/08/04/installing-docker-on-centos-6/">Installing Docker on Centos 6</a></li>
  <li><a href="https://github.com/sciurus/docker-rhel-rpm">files needed to build RPMs for the dependencies of docker</a></li>
  <li><a href="https://github.com/failshell/chef-docker">chef-docker</a></li>
  <li><a href="http://nareshv.blogspot.in/2013/08/installing-dockerio-on-centos-64-64-bit.html">Installing Dockerio on Centos6.4-64bit</a></li>
</ol>
<p>其中，包括有三种内核，源代码编译支持3.8的，spec编译支持3.10的，以及已经打包完成的3.2的。</p>
<p>我已经尝试过在 Fedora19 上通过源代码编译，似乎内核从3.8到3.10有些变化，编译失败了。(但是尝试过编译3.8的确实没问题)</p>
<p>下面通过最简单的已经打包完成的3.2内核来快速部署 docker 到 CentOS6 上，以便尝鲜：</p>
<div class="highlight"><pre><code class="bash">rpm -e kernel-firmware
rpm -i http://get.docker.io/kernels/kernel-3.2.40_grsec_dotcloud-4.x86_64.rpm
/sbin/dracut --add-drivers dm-mod --add-drivers linear <span class="s2">&quot;&quot;</span> 3.2.40-grsec-dotcloud
grub-install /dev/sda1
<span class="nb">echo</span> <span class="s2">&quot;blacklist evbug&quot;</span> &gt;&gt; /etc/modprobe.d/blacklist.conf
<span class="nb">echo</span> <span class="s2">&quot;kernel.grsecurity.chroot_caps = 0&quot;</span> &gt;&gt; /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">&quot;sysctl kernel.grsecurity.chroot_caps=1&quot;</span> &gt;&gt; /etc/rc.local
<span class="nb">echo</span> <span class="s2">&quot;net.ipv4.ip_forward = 1&quot;</span> &gt;&gt; /etc/sysctl.conf
mkdir /cgroup
<span class="nb">echo</span> <span class="s2">&quot;none /cgroup cgroup defaults 0 0&quot;</span> &gt;&gt; /etc/fstab
cat &gt;&gt; /boot/grub/grub.conf<span class="s">&lt;&lt;EOF</span>
<span class="s">title CentOS (3.2.40_grsec_dotcloud-4.x86_64)</span>
<span class="s">	root (hd0,0)</span>
<span class="s">	kernel /boot/vmlinuz-3.2.40-grsec-dotcloud ro root=LABEL=/ rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM selinux=0</span>
<span class="s">	initrd /boot/initramfs-3.2.40-grsec-dotcloud.img</span>
<span class="s">EOF</span>
reboot
</code></pre></div>
<p>内核的更新就是这些，记住这个包不支持 selinux，所以启动项里要加上 <code>selinux=0</code>。</p>
<p>然后重启登录重启并选择了新内核的主机，继续安装一些依赖工具：</p>
<div class="highlight"><pre><code class="bash">wget <span class="s2">&quot;ftp://ftp.pbone.net/mirror/ftp5.gwdg.de/pub/opensuse/repositories/home%3A/awk2007%3A/fixes/Fedora_17/src/aufs-util-9999-14.1.src.rpm&quot;</span>
sudo yum install glibc-static
rpmbuild --rebuild aufs-util-9999-14.1.src.rpm
rpm -U /root/rpmbuild/RPMS/x86_64/aufs-util-9999-14.1.x86_64.rpm
wget ftp://ftp.univie.ac.at/systems/linux/dag/redhat/el6/en/x86_64/dag/RPMS/lxc-0.8.0-1.el6.rf.x86_64.rpm
wget http://apt.sw.be/redhat/el6/en/x86_64/dag/RPMS/lxc-libs-0.8.0-1.el6.rf.x86_64.rpm
rpm -U lxc-0.8.0-1.el6.rf.x86_64.rpm lxc-libs-0.8.0-1.el6.rf.x86_64.rpm
</code></pre></div>
<p>然后下载 docker 的二进制文件运行，用源代码的话比较麻烦，docker 是用 golang 写的……</p>
<div class="highlight"><pre><code class="bash">wget http://get.docker.io/builds/Linux/x86_64/docker-latest.tgz
tar xzf docker-latest.tgz
<span class="nb">cd </span>docker-latest
</code></pre></div>
<p>启动 docker 进程，输出如下：</p>
<pre><code>[root@localhost docker-latest]# ./docker -d &amp;
2013/08/24 18:24:18 WARNING: You are running linux kernel version 3.2.40-grsec-dotcloud, which might be unstable running docker. Please upgrade your kernel to 3.8.0.
2013/08/24 18:24:18 Listening for HTTP on /var/run/docker.sock (unix)
</code></pre>
<p>然后就可以通过 docker 命令运行了，示例及输出如下所示：</p>
<pre><code>[root@localhost docker-latest]# ./docker run -i -t busybox /bin/sh
2013/08/24 18:24:30 POST /v1.4/containers/create
2013/08/24 18:24:30 POST /v1.4/images/create?fromImage=busybox&amp;tag=
Pulling repository busybox
Pulling image e9aa60c60128cad1 (latest) from busybox
Pulling e9aa60c60128cad1 metadata
Pulling e9aa60c60128cad1 fs layer
Downloading 2.284 MB/2.284 MB (100%)
2013/08/24 18:28:37 POST /v1.4/containers/create
2013/08/24 18:28:37 POST /v1.4/containers/cdf0feaf24a9/start
2013/08/24 18:28:37 POST /v1.4/containers/cdf0feaf24a9/resize?h=27&amp;w=121
2013/08/24 18:28:37 POST /v1.4/containers/cdf0feaf24a9/attach?logs=1&amp;stderr=1&amp;stdin=1&amp;stdout=1&amp;stream=1
BusyBox v1.19.3 (Ubuntu 1:1.19.3-7ubuntu1.1) built-in shell (ash)
Enter 'help' for a list of built-in commands.
/ # 
/ # ls
bin    dev    etc    lib    lib64  proc   sbin   sys    tmp    usr
/ # cd /root
/bin/sh: cd: can't cd to /root
</code></pre>
<p>可以看到，现在登录进来是不能切换目录到 root 家目录的。</p>
<p>docker 已经运行起来了，更多实例，就可以看着 docker.io 上的<a href="http://docs.docker.io/en/latest/examples/">文档</a>慢慢进行了</p>
      <a href="/2013/08/24/using-docker-on-centos6" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/08/14/my-perl-workshop-experience" title="BeiJing Perl Workshop 2013 参会总结" rel="bookmark">BeiJing Perl Workshop 2013 参会总结</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-08-14 00:00:00 +0800">14 Aug 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上周六在万通会议中心参加了 BeiJing Perl Workshop 2013 ，并做了 40 分钟长的关于 ElasticSearch 的演讲。上届 2011 作为一个看客，两年后作为一个积极参与和演讲者，真的有必要记录一下。</p>
<p>一天中最让大家惊奇和感兴趣的无疑是胡松涛带来的 3D 打印机以及每人都有的 Perl 小挂件 —— 没错，就是用 3D 打印出来的小东西。</p>
<p><img src="/images/uploads/3d_perlchina.jpg" alt="large" /></p>
<p><img src="/images/uploads/3d_perl.jpg" alt="small" /></p>
<p>最遗憾的是来自alibaba的两位演讲者因为公司问题临时退出。</p>
<p>DeNA 的演讲者是一位由程序员转职的产品经理，明显演讲的技巧水平是要高过我们这些纯码农的，节奏控制完全值得学习。
不知道对于其他 perler 来说，测试是否会主动去做，但是我是蛮习惯使用 <code>Dancer::Test</code> 的，包括其他项目用 <code>Test::More</code>，我觉得都是蛮好的习惯。所以对董余康在演讲中比较重点的提到测试的便捷我是比较有爱的，但是从 QQ 群上的反应来看，大家更期待的功能和开发便捷上的介绍？
总的来说，演讲题目偏于 PerlDancer 的 hello world，我个人本身对 Dancer 有一定了解，所以内容上没太注意。如果以后发现大家对 <code>Dancer</code> 有进一步的兴趣，我考虑可以在 YY 频道上介绍一下用 <code>Dancer::Plugin</code> 实现一个自己喜欢的keyword？</p>
<p>扶凯的 <code>Mojolicious</code> 演讲应该就比较符合大众的期待。我是不太喜欢单独定义 route 的方式，不管是 RoR 还是 mojo，除此以外，mojo 另一个不错的就是 <code>TagHelper</code> 了。我觉得将 <code>Dancer</code> 和 <code>Mojolicious::Lite</code> 相比是不厚道的，<code>Dancer</code> 也可以多文件使用，<code>dancer -a web_app</code> 命令就生成了完整的项目层次。
关于 mojo 的演讲，牛氓同学说没有关于 <code>Mojo</code> 的 OO 实现的内容，我也觉得比较遗憾，不过这个内容是否适合在面对上百听众的时候分享，也是一个问题？</p>
<p>李瑞彬演讲中提到的 <code>cpanspec</code> 和 <code>yum search perl(LWP::Simple)</code> 两个小技巧很不错～</p>
<p>刘刊和大家不同，采用了直接 code 解读和 shell 演示的办法介绍了他的 <code>pantheon</code> 里面的一些思想和简单用法。其实我去年就见过这个的使用，不过似乎到现在依然没有完整的文档？作为一个在雅虎超大环境下经过实践的自动化运维平台项目，如果配上完善的文档，应该可以成为一个可以对 Perl 普及有很不错推动力的好项目。<strong>真心希望刘刊和 <code>pantheon</code> 的其他使用者可以花点时间，整理一份快速入手的 cookbook，迁移代码到github，独立域名发布，完成从内部项目到社区项目的转身～</strong>
目前只能通过 CPAN 安装，安装很方便，但是没人演示教导，真的不知道怎么用……</p>
<p>也来说说我自己的演讲。这个话题其实比较尴尬，前三分之一介绍 <code>ElasticSearch</code>，中间还有一部分是 <code>logstash</code>，都是 Perl 无关的内容。演讲完后其实发现很多人依然不清楚到底是可以用来干吗……或许我直接只讲 <code>Message::Passing</code> ，每个插件如何用，效果应该更好一些吧？唯一高兴的，是演讲刚好控制到了40分钟内讲完。</p>
<p>许大师提到一个大计划，要把 <code>AnyEvent</code> 和 <code>nginx</code> 无缝结合。这个好是好，能不能出来是另一回事……</p>
<p>闪电演讲依然火爆，不过我有事情先走了，不知道后来还有几位超时被敲锣的～～
对了，第一个闪电提到的 <code>$obj-&gt;can($func_name)-&gt;()</code> 这个用法很帅，记录一下。</p>
<p>原本在 CU 上答应网友在闪电上分享一下 <code>autobox</code> 的用法，也没法做了，有点违约的小羞愧。以后也争取在 YY 频道上说说。</p>
<p>作为演讲者，还另外免费领了一本《HBase管理指南》，实在其他几本 Perl 的都已经有了——而且大多数演讲者都是～～</p>
<p>BJPW 之后第二天就开始 YAPC::EU，国外大神基本都在欧洲讨论 Future Perl，北京的朋友们自娱自乐也还是比较成功了～</p>
<p>最后吐槽一个，全天没有 Perl6 的演讲，结果文化衫上是 Perl6 的蝴蝶。。。其实如果能让广州那个 <code>MoarVM</code> 的开发者叫来讲讲也挺好的。</p>
<p><img src="/images/uploads/T-shirt.jpg" alt="大会T恤衫" /></p>
<p>附另外两位同仁的大会感受博文：</p>
<ol>
  <li><a href="http://www.weibo.com/alickzhao">@赵涛Alick</a> 的 《<a href="http://wp-awesome.rhcloud.com/2013/08/18/perl-china-2013-notes/">Perl China 2013 活动后记</a>》</li>
  <li>Aka.Why 的 《<a href="http://blog.aka-cool.net/blog/2013/08/12/learn-from-beijing-perl-workshop-2013/">参加Beijing Perl Workshop 2013后感</a>》</li>
</ol>
      <a href="/2013/08/14/my-perl-workshop-experience" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/07/22/intro-selenium-remote-driver" title="Selenium 测试框架介绍" rel="bookmark">Selenium 测试框架介绍</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-07-22 00:00:00 +0800">22 Jul 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Selenium 是一个自动化网站测试框架，包括 IDE、WebDriver 和 Grid 三个套件。其官网地址见：<a href="http://docs.seleniumhq.org/projects/">http://docs.seleniumhq.org/projects/</a>。其中 Grid 用以跨主机的集群测试，今天就不讲了。而 WebDriver 则是用以控制 Selenium Server(Server 上可以接受并启动的浏览器包括Firefox、IE、Chrome、Safari、Android、IPhone、PhantomJS 等等)进行具体测试动作的客户端，其早期版本叫做 Remote Control。</p>
<p>最有特色和帮助的，是 IDE 部分，这是一个 Firefox 的 xpi 插件。通过下载安装，就可以启用，然后就是最简单不过的浏览器操作录制，结束动作后就可以自动导出各种支持的语言版本的 WebDriver 程序。</p>
<p>注意在安装好 xpi 后，在 IDE 上并不能同步看到生成的程序内容，并不是说没有录制，而是默认不显示 <code>options/format</code> 的内容。在 <code>options/options</code> 里把 <code>active developer tools</code> 选项激活就可以了。</p>
<p>Selenium 是一个 java 项目，官方支持的客户端程序包括 Java、C#、Ruby 和 Python2。社区支持的包括 Perl、PHP 和 Haskell 等等。</p>
<p>注意 Selenium 的 WebDriver 和 Remote Control 两个版本之间 API 已经完全不一样，所以在 IDE 录制的时候，format 已经要选 WebDriver API 的才能用——除非你还找得到老版本的 Selenium Server，反正我是没找到。</p>
<p>不巧的是目前官网上的插件列表中，只有官方支持的四个更新了 WebDriver 的 IDE 支持。所以直接从官网上安装的 Perl plugin 其实是没用的。不过不要紧，我很容易就找到了支持 WebDriver 的 Perl 模块，并且还使用 Perl 模块完成了对 Selenium Server 的管理。</p>
<p>这里要用到两个 CPAN 模块：<a href="https://metacpan.org/module/Selenium::Server">Selenium::Server</a> 和 <a href="https://metacpan.org/module/Selenium::Remote::Driver">Selenium::Remote::Driver</a>。</p>
<p>由于 Firefox addons 网站上的 <a href="https://addons.mozilla.org/zh-CN/firefox/addon/selenium-ide-perl-formatter/?src=search">Selenium IDE: Perl Formatter</a> 还是老版本的，即 <a href="https://metacpan.org/module/Test::WWW::Selenium">Test::WWW::Selenium</a> 配套的，所以我们需要自行安装新版本插件。</p>
<p>新版本插件也就是一段 javascript 代码，在 <a href="https://metacpan.org/module/Selenium::Remote::Driver">Selenium::Remote::Driver</a> 代码库目录中已经存在，即 <a href="https://github.com/aivaturi/Selenium-Remote-Driver/blob/master/ide-plugin.js">https://github.com/aivaturi/Selenium-Remote-Driver/blob/master/ide-plugin.js</a>。</p>
<p>按照 js 文件开头注释中的介绍，在 Selenium IDE 的 <code>options/options</code> 菜单的 <code>Formats</code> 选项卡上点击 <code>Add</code> 按钮，给新的 format 取名为 <code>Perl-WebDriver</code>，然后把整个 js 文件内容贴进文本框内保存即可。</p>
<p>现在，录制操作只需选择使用 <code>Perl-WebDriver</code> 格式，就可以生成 Perl 测试脚本使用了。</p>
<p>下一个问题，就是 Selenium Server 的运行。IDE 生成的脚本只负责连接 server 并发送命令。server 的 状况在 IDE 中是在 <code>options/formats</code> 中定义的变量，即 Selenium RC host 、Selenium RC port 和 environment。默认是 <code>localhost</code>、<code>4444</code> 和 <code>firefox</code>。在生成脚本的时候会自动替换。</p>
<p>也就是说，我们需要自己部署程序，再运行一个脚本，启用 java 程序，来运行 Selenium Server。</p>
<p>这里就可以用上 <a href="https://metacpan.org/module/Selenium::Server">Selenium::Server</a> 了。程序的下载、启用、参数配置和停止，都有该模块完成。</p>
<p>最后一步，我们可以把 <a href="https://metacpan.org/module/Selenium::Server">Selenium::Server</a> 的相关代码，也贴进 IDE 的 <code>options/formats</code> 的 <code>Header</code> 和 <code>Footer</code> 模板里。这样不用每次自己粘贴了——自己粘贴代码还不如直接自己启用一个固定监听 4444 端口的 java 程序得了。</p>
<p>IDE 截图如下：</p>
<p><img src="/images/uploads/selenium-ide.png" alt="selenium-ide" /></p>
<p>生成脚本如下所示：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
    <span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Selenium::</span><span class="n">Server</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Selenium::Remote::</span><span class="n">Driver</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">Test::</span><span class="n">More</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$server</span> <span class="o">=</span> <span class="nn">Selenium::</span><span class="n">Server</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
    <span class="nv">$server</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$driver</span> <span class="o">=</span> <span class="nn">Selenium::Remote::</span><span class="n">Driver</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="n">remote_server_addr</span> <span class="o">=&gt;</span> <span class="nv">$server</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
        <span class="n">port</span>               <span class="o">=&gt;</span> <span class="nv">$server</span><span class="o">-&gt;</span><span class="n">port</span>
    <span class="p">);</span>
    <span class="nv">$driver</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://10.2.21.100:8081/?results=88ceefac3c0c588d14f579d0c47f74fc&quot;</span><span class="p">);</span>
    <span class="nv">$driver</span><span class="o">-&gt;</span><span class="n">find_element</span><span class="p">(</span><span class="s">&quot;DNS可用性测试&quot;</span><span class="p">,</span> <span class="s">&quot;link&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">click</span><span class="p">;</span>
    <span class="n">like</span><span class="p">(</span><span class="sx">qr/^[\s\S]*各地测试可用性[\s\S]*$/</span><span class="p">,</span><span class="nv">$driver</span><span class="o">-&gt;</span><span class="n">find_element</span><span class="p">(</span><span class="s">&quot;BODY&quot;</span><span class="p">,</span> <span class="s">&quot;css&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">get_text</span><span class="p">);</span>
    <span class="nv">$driver</span><span class="o">-&gt;</span><span class="n">quit</span><span class="p">();</span>
    <span class="n">done_testing</span><span class="p">();</span>
    <span class="nv">$server</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span>
</code></pre></div>
<p>脚本中这个 <code>click</code> 操作显然是直接根据动作录制的，那么 <code>find_element()-&gt;get_text</code> 是怎么来的呢？其实 Selenium IDE 已经修改了浏览器内鼠标右键菜单的选项。在选中的任意网页元素上单击鼠标右键，菜单中就有 <code>Show All Available Commands</code> 子菜单，只需要选择就可以了。方便吧！</p>
<p>生成的脚本直接运行，就可以完成测试了。</p>
<p>和 <code>Selenium</code> 类似的，还有 <a href="https://metacpan.org/module/WWW::WebKit">WWW::WebKit</a> 模块，它是调用 <a href="https://metacpan.org/module/Gtk3::WebKit">Gtk3::WebKit</a> 作为后端浏览器支持，不过经过我个人电脑测试，要安装好 <a href="https://metacpan.org/module/Gtk3::WebKit">Gtk3::WebKit</a> 本身就是一件很复杂的事情。加上有时候我们也需要比较不同浏览器的效果是不是有所不同。所以，还是用 Selenium 吧。</p>
<p>注：在最近一期 PerlWeekly 对 Perl 社区创业公司 Lokku/Nestoria 的<a href="http://blogs.perl.org/user/ovid/2013/07/perl-startups-lokkunestoria.html">访谈</a>中，Lokku 公司 CTO，Alex Balhatchet 也提到准备使用 Selenium 改造公司的自动化测试。</p>
<p>补：刚发现 Selenium 的 PHP 客户端，是 Facebook 写的。</p>
<p><strong>2013 年 07 月 25 日补</strong></p>
<p><code>Selenium</code> 的另一个功能是自己插入 <code>javascript</code> 到页面里执行。比如我们可以利用 HTML5 的 <code>WebTiming</code> 特性测试页面的下载时间：</p>
<div class="highlight"><pre><code class="perl">    <span class="k">my</span> <span class="nv">$webtiming</span> <span class="o">=</span> <span class="sx">q{</span>
<span class="sx">        var performance = window.performance</span>
<span class="sx">                       || window.webkitPerformance</span>
<span class="sx">                       || window.mozPerformance</span>
<span class="sx">                       || window.msPerformance</span>
<span class="sx">                       || {};</span>
<span class="sx">        var timings     = performance.timing || {};</span>
<span class="sx">        return timings;</span>
<span class="sx">    }</span><span class="p">;</span>
    <span class="nv">$driver</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://stackoverflow.com/&quot;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$driver</span><span class="o">-&gt;</span><span class="n">execute_script</span><span class="p">(</span><span class="nv">$webtiming</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%$res</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nb">printf</span> <span class="s">&quot;%s %s\n&quot;</span><span class="p">,</span> <span class="nv">$_</span><span class="p">,</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$_</span><span class="p">}</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
    <span class="p">};</span>
</code></pre></div>
<p><code>WebTiming</code> 详细列出了每个阶段的时间。如果 js 写的好，可以写具体某个点触发，就更好了。</p>
<p><strong>2013 年 07 月 26 日补</strong></p>
<p><code>Selenium::Remote::Driver</code> 只发送操作命令到远端服务器，不具有操作本地浏览器功能。所以无法像 Ruby 的 <code>Selenium::WebDriver</code> 那样控制本地浏览器，甚至包括插入 <code>.xpi</code> 插件到自定义的 profile 里完成更复杂的功能：比如用 <code>Firebug</code>。有一个 Ruby 模块叫 <a href="https://github.com/jfirebaugh/capybara-firebug">capybara-firebug</a>，就是利用这个办法扩展了 <code>capybara</code> 测试框架。</p>
      <a href="/2013/07/22/intro-selenium-remote-driver" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/07/11/howto-filter-count-in-logstash" title="【Logstash 系列】根据事件统计值报警" rel="bookmark">【Logstash 系列】根据事件统计值报警</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-07-11 00:00:00 +0800">11 Jul 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前已经用很多博文说过了 logstash 如何配合 elasticsearch 以及 kibana 来做日子分析和实时搜索。其实 logstash 上百个插件还有很多其他的玩法，绝不是局限在日志搜索统计方面的。今天就展示另一个做法。根据日志中的异常值出现频率报警。</p>
<p>在 logstash 的官网上，针对这个问题采用的办法是讲异常值计数 output 到 <code>statsd</code> 中，然后可以用通过观测 <code>graphite</code> 图形变化来判断异常。(或者配合 nagios 的 <code>check_graphite</code> 插件？) 官网说明见：<a href="http://logstash.net/docs/1.1.13/tutorials/metrics-from-logs">http://logstash.net/docs/1.1.13/tutorials/metrics-from-logs</a></p>
<p>如果不想一直盯着页面看的话，可以利用另外几个插件来实现类似的做法，比如我要监控访问日志，如果其中 504 状态码每分钟超过 100 次，就报警出来。logstash 配置如下：</p>
<div class="highlight"><pre><code class="ruby">    <span class="n">input</span> <span class="p">{</span>
        <span class="n">stdin</span> <span class="p">{</span>
            <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;apache&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">filter</span> <span class="p">{</span>
        <span class="n">grok</span> <span class="p">{</span>
            <span class="n">pattern</span> <span class="o">=&gt;</span> <span class="s2">&quot;\[%{HTTPDATE:ts}\] %{NUMBER:status} %{IPORHOST:remotehost} %{URIHOST} %{WORD} %{URIPATHPARAM:url} HTTP/%{NUMBER} %{URIHOST:oh} %{NUMBER:responsetime:float} %{NUMBER:upstreamtime:float} (?:%{NUMBER:bytes:float}|-)&quot;</span>
            <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;apache&quot;</span>
        <span class="p">}</span>
        <span class="n">metrics</span> <span class="p">{</span>
            <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;apache&quot;</span>
            <span class="n">meter</span> <span class="o">=&gt;</span> <span class="s2">&quot;error.%{status}&quot;</span>
            <span class="n">add_tag</span> <span class="o">=&gt;</span> <span class="s2">&quot;metric&quot;</span>
            <span class="n">ignore_older_than</span> <span class="o">=&gt;</span> <span class="mi">10</span>
        <span class="p">}</span>
        <span class="n">ruby</span> <span class="p">{</span>
            <span class="n">tags</span> <span class="o">=&gt;</span> <span class="s2">&quot;metric&quot;</span>
            <span class="n">code</span> <span class="o">=&gt;</span> <span class="s2">&quot;event.cancel if event[&#39;@fields&#39;][&#39;error.504.rate_1m&#39;] &lt; 100&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">output</span> <span class="p">{</span>
        <span class="nb">exec</span> <span class="p">{</span>
            <span class="n">tags</span> <span class="o">=&gt;</span> <span class="s2">&quot;metric&quot;</span>
            <span class="n">command</span> <span class="o">=&gt;</span> <span class="s2">&quot;sendsms.pl -m &#39;%{error\.504\.rate_1m}&#39;&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
<p>其中关键在两个 filter。 metrics 插件可以每5秒(前天刚更新了源码，这个值可以自己指定了)更新一次统计值，支持 <code>meter</code> 和 <code>timer</code> 两种，<code>timer</code> 除了 <code>count</code> 和 <code>rate_1|5|15m</code> 外，还可以统计 <code>min|max|stddev|mean</code> 和 <code>p1|5|10|90|95|99</code> 等详细数据。</p>
<p>ruby 插件则是直接 <code>eval</code> 写在 <code>code</code> 配置里的代码。</p>
<p>需要注意的是： <code>output</code> 里使用的时候，需要用 <code>\</code> 转义 <code>.</code>。否则配置解析后会认为变量不存在。这是目前官网文档上写的有问题的地方。我已經跟作者提过，或许过些天会修改。</p>
<p>值得一提的是：metrics 插件的输出是一个全新的 event，而不会去改变原先 grok 生成的 event。</p>
      <a href="/2013/07/11/howto-filter-count-in-logstash" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/06/28/howto-get-peer-ipaddr-in-http-get" title="获取 Perl 程序中 GET 请求发向的具体 IP" rel="bookmark">获取 Perl 程序中 GET 请求发向的具体 IP</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-06-28 00:00:00 +0800">28 Jun 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在运维工作中我们经常需要检测用户访问是否正常，一般来说，直接通过 DNS 客户端获取 A 记录就可以满足需要。不过如果我们可以获得具体连接的 IP 地址，那么就可以缩小问题的判断范围，因为 DNS 的 A 记录通常是有多个的。</p>
<p>AE::HTTP 模块可以返回 sock 给用户进行具体操作，我们可以通过 sock 接口很简单的获得对端的 IP 地址：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">Web::Checker::Util::</span><span class="n">HTTP</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Moo</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">MooX::Types::MooseLike::</span><span class="n">Base</span> <span class="sx">qw/Str Num/</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">HTTP</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">Socket</span><span class="p">;</span>
<span class="k">use</span> <span class="n">AnyEvent</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Time::</span><span class="n">HiRes</span> <span class="sx">qw/time/</span><span class="p">;</span>
<span class="n">has</span> <span class="n">peer</span>    <span class="o">=&gt;</span> <span class="p">(</span> <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;rw&#39;</span><span class="p">,</span> <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span> <span class="p">);</span>
<span class="n">has</span> <span class="n">reptime</span> <span class="o">=&gt;</span> <span class="p">(</span> <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;rw&#39;</span><span class="p">,</span> <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Num</span> <span class="p">);</span>
<span class="n">has</span> <span class="n">clength</span> <span class="o">=&gt;</span> <span class="p">(</span> <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;rw&#39;</span><span class="p">,</span> <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Num</span> <span class="p">);</span>
<span class="n">has</span> <span class="n">body</span>    <span class="o">=&gt;</span> <span class="p">(</span> <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span> <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span> <span class="p">);</span>
<span class="n">has</span> <span class="n">proxy</span>   <span class="o">=&gt;</span> <span class="p">(</span> <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span> <span class="n">isa</span> <span class="o">=&gt;</span> <span class="n">Str</span><span class="p">,</span> <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="nb">undef</span> <span class="p">}</span> <span class="p">);</span>
<span class="n">has</span> <span class="n">cv</span> <span class="o">=&gt;</span> <span class="p">(</span> <span class="n">is</span> <span class="o">=&gt;</span> <span class="s">&#39;ro&#39;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">condvar</span> <span class="p">}</span> <span class="p">);</span>
<span class="k">sub </span><span class="nf">get</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$self</span><span class="p">,</span> <span class="nv">$url</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">cv</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$begin</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
    <span class="n">http_get</span> <span class="nv">$url</span><span class="p">,</span>
      <span class="n">proxy</span>            <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">,</span>
      <span class="c1"># 就是这里发挥了作用，默认应该是直接返回 body 字符串的</span>
      <span class="n">want_body_handle</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
      <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$hdl</span><span class="p">,</span> <span class="nv">$headers</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
        <span class="k">my</span> <span class="p">(</span> <span class="nv">$port</span><span class="p">,</span> <span class="nv">$peer</span> <span class="p">)</span> <span class="o">=</span>
          <span class="nn">AnyEvent::Socket::</span><span class="n">unpack_sockaddr</span> <span class="nb">getpeername</span> <span class="nv">$hdl</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">fh</span><span class="p">};</span>
        <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">(</span> <span class="nn">AnyEvent::Socket::</span><span class="n">format_address</span> <span class="nv">$peer</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$headers</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">Status</span><span class="p">}</span> <span class="o">=~</span><span class="sr"> /^2/</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$end</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
            <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">reptime</span><span class="p">(</span> <span class="nv">$end</span> <span class="o">-</span> <span class="nv">$begin</span> <span class="p">);</span>
            <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">clength</span><span class="p">(</span> <span class="nv">$headers</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;content-length&#39;</span><span class="p">}</span> <span class="p">);</span>
            <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">cv</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">cv</span><span class="o">-&gt;</span><span class="nb">recv</span><span class="p">;</span>
<span class="p">}</span>
<span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>其实 AE::HTTP 还可以在 <code>tcp_connect</code> 的时候获取 sock，这时候就需要自己用 <code>AnyEvent::Handle</code> 写一遍 <code>AnyEvent::HTTP::tcp_connect</code> 已经写过的东西了(当然如果你本来就打算干点别的事情，那就是另外一回事情了)~~</p>
      <a href="/2013/06/28/howto-get-peer-ipaddr-in-http-get" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/06/24/who-to-calculate-days-between-two-date" title="计算两个时间点之间隔了几天" rel="bookmark">计算两个时间点之间隔了几天</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-06-24 00:00:00 +0800">24 Jun 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>两个时间点字符串，像这样：<code>2013-06-21</code>，怎么计算相距多少天呢？</p>
<p>有两种办法。</p>
<h2 id="datetime-">DateTime 模块</h2>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">DateTime</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">List::</span><span class="n">MoreUtils</span> <span class="sx">qw(zip)</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Data::</span><span class="n">Dumper</span><span class="p">;</span>
<span class="k">print</span> <span class="n">Dumper</span><span class="p">(</span>
    <span class="n">DateTime</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">zip</span> <span class="nv">@</span><span class="p">{</span> <span class="p">[</span><span class="sx">qw/year month day/</span><span class="p">]</span> <span class="p">},</span>
        <span class="nv">@</span><span class="p">{</span> <span class="p">[</span> <span class="nb">split</span> <span class="sr">/-/</span><span class="p">,</span> <span class="s">&#39;2013-06-21&#39;</span> <span class="p">]</span> <span class="p">}</span> <span class="p">)</span><span class="o">-&gt;</span><span class="n">subtract_datetime</span><span class="p">(</span>
        <span class="n">DateTime</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
            <span class="n">zip</span> <span class="nv">@</span><span class="p">{</span> <span class="p">[</span><span class="sx">qw/year month day/</span><span class="p">]</span> <span class="p">},</span>
            <span class="nv">@</span><span class="p">{</span> <span class="p">[</span> <span class="nb">split</span> <span class="sr">/-/</span><span class="p">,</span> <span class="s">&#39;2012-05-20&#39;</span> <span class="p">]</span> <span class="p">}</span>
        <span class="p">)</span>
        <span class="p">)</span><span class="o">-&gt;</span><span class="n">deltas</span>
<span class="p">);</span>
</code></pre></div>
<p>缺点是 <code>DateTime::Duration</code> 的 <code>days()</code> 只能返回进位 <code>months()</code> 之后剩余的天数。所以这里只能输出整个 <code>deltas()</code> 来看。</p>
<h2 id="timestamp-">timestamp 时间戳</h2>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">POSIX</span> <span class="sx">qw(mktime)</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">trans</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">@str</span> <span class="o">=</span> <span class="nb">split</span> <span class="sr">/-/</span><span class="p">,</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="n">mktime</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$str</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="nv">$str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nv">$str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1900</span><span class="p">,</span>
    <span class="p">);</span>
<span class="p">}</span>
<span class="k">my</span> <span class="nv">$dt1</span> <span class="o">=</span> <span class="n">trans</span><span class="p">(</span><span class="s">&#39;1999-05-21&#39;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$dt2</span> <span class="o">=</span> <span class="n">trans</span><span class="p">(</span><span class="s">&#39;2013-06-26&#39;</span><span class="p">);</span>
<span class="k">print</span><span class="p">(</span> <span class="p">(</span> <span class="nv">$dt2</span> <span class="o">-</span> <span class="nv">$dt1</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="p">)</span> <span class="p">);</span>
</code></pre></div>
<p>这里就是要注意，<code>mktime</code> 里的 <code>month</code> 是以 0 开始的，<code>year</code> 是从 1900 开始的。</p>
      <a href="/2013/06/24/who-to-calculate-days-between-two-date" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/06/21/remove-auto-deps-from-rpmbuild" title="如何去除 rpmbuild 自动发现的依赖关系" rel="bookmark">如何去除 rpmbuild 自动发现的依赖关系</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-06-21 00:00:00 +0800">21 Jun 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>同事在用简单的 SPEC 配置打包 nagios 套件的时候，发现最后生成的 RPM 包附加了很多依赖关系。其中 <code>perl-Net-SNMP</code> 这个包，是服务器默认安装中没有的。这也不是什么大问题。不过这个出现还是蛮奇怪的。值得研究一下。</p>
<p>后来在 <code>/usr/lib/rpm/</code> 目录下发现了一系列脚本，诸如<code>javadeps</code>/<code>perl.req</code>/<code>pythondeps</code>/<code>find-requires</code>/<code>mono-find-requires</code>等等。</p>
<p>这些脚本的作用是，用 <code>file</code> 命令判断文件，如果是二进制的，用ldd判断依赖；如果是脚本，过滤文件中对应的 <code>use</code>/<code>requires</code>/<code>import</code> 语句。这样就可以找出来源代码的内部依赖了。</p>
<p>那么怎么才能跳过这段逻辑呢？</p>
<p>最暴力的办法，这些文件都是 bash 或者 perl 脚本，直接修改。</p>
<p>但是还可以文明一点，像下面这段，添加在 SPEC 文件中：</p>
<div class="highlight"><pre><code class="bash">    %setup
    %prep
    cat <span class="s">&lt;&lt; \EOF &gt; %{name}-req</span>
<span class="s">    #!/bin/sh</span>
<span class="s">    %{__perl_requires} $* |\</span>
<span class="s">    sed -e &#39;/perl(Net::SNMP)/d&#39;</span>
<span class="s">    EOF</span>
    %define __perl_requires %<span class="o">{</span>_builddir<span class="o">}</span>/%<span class="o">{</span>name<span class="o">}</span>-%<span class="o">{</span>version<span class="o">}</span>/%<span class="o">{</span>name<span class="o">}</span>-req
    chmod 755 %<span class="o">{</span>__perl_requires<span class="o">}</span>
</code></pre></div>
<p>这里重定义了一个脚本，原先的定义在 <code>/usr/lib/rpm/macros</code> 中，是：</p>
<div class="highlight"><pre><code class="bash">    <span class="c">#%__find_provides       /usr/lib/rpm/rpmdeps --provides</span>
    <span class="c">#%__find_requires       /usr/lib/rpm/rpmdeps --requires</span>
    %__find_provides        /usr/lib/rpm/find-provides
    %__find_requires        /usr/lib/rpm/find-requires
    <span class="c">#%__perl_provides       /usr/lib/rpm/perldeps.pl --provides</span>
    <span class="c">#%__perl_requires       /usr/lib/rpm/perldeps.pl --requires</span>
    %__perl_provides        /usr/lib/rpm/perl.prov
    %__perl_requires        /usr/lib/rpm/perl.req
    %__python_provides      /usr/lib/rpm/pythondeps.sh --provides
    %__python_requires      /usr/lib/rpm/pythondeps.sh --requires
    %__mono_provides        /usr/lib/rpm/mono-find-provides %<span class="o">{</span>_builddir<span class="o">}</span>/%<span class="o">{</span>?buildsubdir<span class="o">}</span> %<span class="o">{</span>buildroot<span class="o">}</span> %<span class="o">{</span>_libdir<span class="o">}</span>
    %__mono_requires        /usr/lib/rpm/mono-find-requires %<span class="o">{</span>_builddir<span class="o">}</span>/%<span class="o">{</span>?buildsubdir<span class="o">}</span> %<span class="o">{</span>buildroot<span class="o">}</span> %<span class="o">{</span>_libdir<span class="o">}</span>
</code></pre></div>
<p>然后将加入了 <code>sed</code> 命令的新脚本定位为新的 MACROS 变量给 <code>rpmbuild</code> 后续使用。</p>
      <a href="/2013/06/21/remove-auto-deps-from-rpmbuild" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/06/20/rex-task-params-for-dynamic-server-group" title="通过 Rex 命令行参数向动态服务器组发起任务" rel="bookmark">通过 Rex 命令行参数向动态服务器组发起任务</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-06-20 00:00:00 +0800">20 Jun 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#devops-ref" title="devops" rel="category tag">devops</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Rex 默认的服务器组定义方式有三种，直接写在 <code>Rexfile</code> 文件中；每行一个写成 IP 列表保存成文件，然后通过 <code>lookup_file</code> 读取；把组名和 IP 写成 <code>.ini</code> 格式文件，通过 <code>groups_file "$name.ini"</code> 一次性获取。</p>
<p>如果服务器信息存在数据库里，那么可以通过 <code>Rex::Commands::DB</code> 来快速读取数据库信息，构建服务器组。不过，如果我们是想从数据库中根据查询条件，动态获取服务器列表完成指定任务的话，就没法提前定义好 <code>group</code> 了。这个时候，怎么办呢？</p>
<p>我们可以利用 <code>task</code> 可以接受命令行参数这个特点，完成这个功能：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Rex::Commands::</span><span class="n">DB</span> <span class="p">{</span>
    <span class="n">dsn</span>      <span class="o">=&gt;</span> <span class="s">&quot;dbi:SQLite:dbname=/etc/puppet/webui/node.db&quot;</span><span class="p">,</span>
    <span class="n">user</span>     <span class="o">=&gt;</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
    <span class="n">password</span> <span class="o">=&gt;</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">task</span> <span class="s">&quot;sqlite&quot;</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$param</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$role</span>  <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">role</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$class</span> <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">class</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$todo</span>  <span class="o">=</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">todo</span><span class="p">};</span>
    <span class="nb">grep</span> <span class="p">{</span> <span class="n">run_task</span> <span class="nv">$todo</span><span class="p">,</span> <span class="n">on</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">ip</span><span class="p">}</span> <span class="p">}</span> <span class="n">db</span> <span class="nb">select</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="n">fields</span> <span class="o">=&gt;</span> <span class="s">&quot;ip&quot;</span><span class="p">,</span>
        <span class="n">from</span>   <span class="o">=&gt;</span> <span class="s">&quot;node_info&quot;</span><span class="p">,</span>
        <span class="n">where</span>  <span class="o">=&gt;</span> <span class="s">&quot;role like &#39;$role\%&#39; and classes like &#39;\%${class}\%&#39;&quot;</span><span class="p">,</span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="n">task</span> <span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">say</span> <span class="n">run</span> <span class="s">&quot;w&quot;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>然后这样运行命令即可：</p>
<div class="highlight"><pre><code class="bash">rex sqlite --role<span class="o">=</span>cdn --class<span class="o">=</span>nginx --todo<span class="o">=</span>hello
</code></pre></div>
      <a href="/2013/06/20/rex-task-params-for-dynamic-server-group" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/06/19/skyline-algorithms-intro" title="【Etsy 的 Kale 系统】skyline 的过滤算法" rel="bookmark">【Etsy 的 Kale 系统】skyline 的过滤算法</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-06-19 00:00:00 +0800">19 Jun 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#monitor-ref" title="monitor" rel="category tag">monitor</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>监控大户 Etsy 最近有公布了一个全新的监控分析系统，叫 Kale，博客地址：<a href="http://codeascraft.com/2013/06/11/introducing-kale/">http://codeascraft.com/2013/06/11/introducing-kale/</a>。</p>
<p>上一篇博客介绍了安装部署和数据导入的方法。但是对 <code>skyline</code> 组件的过滤原理没有做研究。今天花了点时间看 wiki 和源码，大概搞清楚了 <code>skyline</code> 的工作方式。很有趣，值得记录一下。</p>
<p>同样作为时间序列存储的 <code>rrdtool</code> 和 <code>graphite</code>，都偏重在预测算法，也就是说根据现有数据推测下一个数据应该是多少；而 <code>skyline</code> 则是根据现有数据统计最新数据是否异常。</p>
<p>目前，<code>skyline</code> 一共提供了 7  个异常检测算法，如果有 5 个以上认为是异常，那么 <code>skyline</code> 就认为这个序列异常了。(当然，这都是可以修改的)</p>
<p>异常检测算法实际写在了 <code>src/analyzer/algorithms.py</code> 里，包括有：</p>
<h3 id="firsthouraverage">first_hour_average</h3>
<p>这是最简单的。先求本周期内最前面的第一个小时的平均值和标准差，然后和最新的三个值的平均值(<code>tail_avg()</code>，这是后面多数算法都通用的做法)做比较。如果 <code>tail_avg</code> 和 第一小时平均值的差距大于 3 倍的标准差，那么认定为异常。</p>
<h3 id="simplestddevfrommovingaverage">simple_stddev_from_moving_average</h3>
<p>把上面算法的范围扩大化，求的是整个周期内全部数据的平均值和标准差。</p>
<h3 id="stddevfrommovingaverage">stddev_from_moving_average</h3>
<p>在上面算法的基础上，采用指数加权移动平均值。对周期内采点数量较少的情况更好一些。</p>
<h3 id="meansubtractioncumulation">mean_subtraction_cumulation</h3>
<p>做法是这样的：</p>
<ol>
  <li>排除最后一个值；</li>
  <li>求剩余序列的平均值；</li>
  <li>全序列减去上面这个平均值；</li>
  <li>求剩余序列的标准差；</li>
  <li>判断全序列最后一个值是否大于 3 倍的标准差</li>
</ol>
<p>在代码中本来还计算了一次序列的指数加权移动平均值，但是算完了却没用，感觉怪怪的。</p>
<h3 id="leastsquares">least_squares</h3>
<p>采用最小二乘法拟近时间序列，然后用实际值减去拟近值得到新序列。然后判断新序列的最后三个值的平均值是否大于 3 倍的新序列标准差。</p>
<p>所谓最小二乘法，简单说就是对一个 [x, y] 序列，会有一对常数 [m, c]，让 <code>Y = mx + c</code> 等式中的 Y 和 y 在全序列上最接近。</p>
<h3 id="histogrambins">histogram_bins</h3>
<p>将整个周期序列的数据按照直方图统计法归入 15 个直方中，然后看最后三个值的平均值属于这 15 个直方的具体哪个。如果这个直方中包含的数据小于 20 个，判断为异常。</p>
<p>从算法中可以知道，如果周期内数据量不够，很容易被判断为异常的。</p>
<h3 id="grubbs">grubbs</h3>
<p>将整个周期序列的数据按照格拉布斯法求异常值。</p>
<p>标准的格拉布斯法是这样的：</p>
<ol>
  <li>从小到大排序；</li>
  <li>求序列的平均值和标准差；</li>
  <li>计算最小值和最大值与平均值的差距，更大的那个为可疑值；</li>
  <li>可疑值减去平均值，再除以标准差，如果大于格拉布斯临界值，那么就是异常值；</li>
  <li>排除异常值，对剩余序列循环做 1-5 步骤。</li>
</ol>
<p>这里只用判断时间序列的最后是否异常，所以直接将最后三个值的平均值作为可疑值判断是否异常即可。</p>
<p><strong>2013 年 07 月 23 日更新</strong></p>
<p>新增了一个异常算法，现在有 8 个了，要通过 6 个才算真异常。</p>
<p>新增的是&rdquo;绝对中值偏差法&rdquo;</p>
<h3 id="medianabsolutedeviation">median_absolute_deviation</h3>
<p>具体实现是：序列的最后一个值，比该序列的绝对中值大 6 倍以上，即判断为异常。</p>
<p>注意这里是中值，不是平均值。</p>
<p><strong>2013 年 08 月 14 日更新</strong></p>
<p>新增一个异常算法，现在有 9 个了。</p>
<p>新增的是&rdquo;柯尔莫诺夫-斯米尔诺夫检验法&rdquo;</p>
<h3 id="kolmogorov-smirnovtest">Kolmogorov-Smirnov_test</h3>
<p>具体实现是：计算序列内最近十分钟的数值的ks测试分布，然后计算序列中最近一个小时前到十分钟前这 50 分钟的数值的ks测试分布；如果两个分布相差较大，即判断为异常。</p>
      <a href="/2013/06/19/skyline-algorithms-intro" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="#">Previous</a>
    </li>
    <li class="page active">
      <a href="#">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li>
      <a href="/page2">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.icylife.net/blog/" title="">心路</a></li>
              <li><a href="http://dbahacker.com/" title="TB 杨德华">DBA Hacker</a></li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.laird-sa.com/" title="">Laird-SA</a></li>
              <li><a href="http://www.linuxsee.com/" title="">LinuxSEE</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://www.puppeter.cn/" title="">piol</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.sanote.org/" title="">sa note</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://blog.ops.tudou.com/wp/" title="">土豆运营团队</a></li>
              <li><a href="http://www.91tuanfang.com/" title="安居客运维">家欣的天空</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://www.opboy.com" title="">运维小子</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://l09.me/" title="风声">风声</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://mooser.me/" title="牛氓">牛氓</a></li>
              <li><a href="http://http://www.yinwang.org/" title="当然我在扯淡">当然我在扯淡</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://muxueqz.laou.me" title="muxueqz">聊逍遥兮容与</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://paperplane.ruhoh.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.sectop.org/" title="">kindle</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
          </ul>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
