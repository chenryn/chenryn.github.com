<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>三斗室</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/03/07/genarate-fig-from-diagramo" title="转换 diagramo 绘制的拓扑图成 fig.yml 格式" rel="bookmark">转换 diagramo 绘制的拓扑图成 fig.yml 格式</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-03-07 00:00:00 +0800">07 Mar 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#docker-ref" title="docker" rel="category tag">docker</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>前几天在微博上跟 <a href="http://weibo.com/panjunyong">@易度-潘俊勇</a> 在评论里提到，已经有了 <a href="http://orchardup.github.io/fig/">Fig</a> 工具可以通过写一个 <code>fig.yml</code> 来快速定义主机上各 docker 容器的配置和角色。如果再进一步，可以通过绘图的方式，直接拖拽生成整个 docker 集群，那就更好了。</p>
<blockquote>
  <p>这个FIG挺有趣的，我自己写了一个类似的脚本。
不过我觉得终极的解决方案是画个关系图，就配置好了。
这个图的存储形式应该就是这个FIG，或者FIG可以转换为图。然后又可以转换为systemd的配置文件。</p>
</blockquote>
<p>画关系图，桌面上肯定是 visio，visio保存成 XML 后分析 XML 就可以了。不过 visio 本身也算笨重的了，如果可以在浏览器中完成这个工作，才算够 cool！</p>
<p>网页上的 visio 已经有些产品，不过有名的几个都是有限免费试用的。好在找到一个叫做 <a href="http://diagramo.com">diagramo</a> 的项目，虽然提供的元素图表不多，但是也够用了。</p>
<p>下载源码包，在 LAMP/LEMP 环境下就直接跑起来，首次访问会要求注册一个用户名。环境配置中有一点必须重点点出来的：</p>
<p><em>Apache/Nginx 上配置的 <code>server_name</code> 必须跟你浏览器访问的完全一致</em></p>
<p>我曾经因为测试，所以写了个 localhost 做 server_name，然后用服务器 IP 地址来访问页面，结果在绘图完成保存的时候会出错！<em>因为这是一个 HTML5 项目，保存这步是调用的 <code>canvas.toDataURL()</code> 函数，这个函数有强制性安全限定，以保证调用这个函数的页面，跟生成的图片路径必须是同一个域名！否则跨域抓图太方便了。</em></p>
<p>(写到这里感慨一下，chrome的调试工具不会用，这问题最后还是在 IE开发者工具的帮助下发现的 ==！)</p>
<p>然后就可以画关系图了，比如下图这样：</p>
<p><img src="/images/uploads/dia.png" alt="sample of diagramo" /></p>
<p>点击保存后，就会在服务器上的 <code>$document_root/editor/data/diagrams</code> 目录下生成对应的 <code>.dia</code> 和 <code>.png</code> 文件。这个所谓的 <code>.dia</code> 文件，其实内容就是 JSON数据。下面我们只要抽取 JSON 里有关的数据就可以了：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">File::</span><span class="n">Slurp</span><span class="p">;</span>
<span class="k">use</span> <span class="n">JSON</span><span class="p">;</span>
<span class="k">use</span> <span class="n">YAML</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Test::Deep::</span><span class="n">NoTest</span><span class="p">;</span>
<span class="k">use</span> <span class="mf">5.010</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$hash</span> <span class="o">=</span> <span class="n">from_json</span><span class="p">(</span> <span class="n">read_file</span><span class="p">(</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">);</span>
<span class="k">my</span> <span class="nv">$hostinfo</span><span class="p">;</span>
<span class="k">for</span> <span class="k">my</span> <span class="nv">$host</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">s</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">figures</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nv">$hostinfo</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$host</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">id</span><span class="p">}</span> <span class="p">}</span> <span class="o">=</span> <span class="n">Load</span><span class="p">(</span> <span class="nv">$host</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">primitives</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">str</span><span class="p">}</span> <span class="p">);</span>
<span class="p">}</span>
<span class="k">for</span> <span class="k">my</span> <span class="nv">$conn</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">m</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">connectors</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$connid</span> <span class="o">=</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">id</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$start</span>  <span class="o">=</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">turningPoints</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">my</span> <span class="nv">$end</span>    <span class="o">=</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">turningPoints</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">endStyle</span><span class="p">}</span> <span class="ow">eq</span> <span class="s">&#39;Normal&#39;</span> <span class="ow">and</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">startStyle</span><span class="p">}</span> <span class="ow">eq</span> <span class="s">&#39;Arrow&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span> <span class="nv">$start</span><span class="p">,</span> <span class="nv">$end</span> <span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="nv">$end</span><span class="p">,</span> <span class="nv">$start</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$startid</span><span class="p">,</span> <span class="nv">$endid</span> <span class="p">);</span>
    <span class="k">for</span> <span class="k">my</span> <span class="nv">$point</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$hash</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">m</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">connectionPoints</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span>    <span class="n">eq_deeply</span><span class="p">(</span> <span class="nv">$point</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">point</span><span class="p">},</span> <span class="nv">$start</span> <span class="p">)</span>
            <span class="ow">and</span> <span class="nv">$point</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">parentId</span><span class="p">}</span> <span class="o">!=</span> <span class="nv">$connid</span>
            <span class="ow">and</span> <span class="nb">exists</span> <span class="nv">$hostinfo</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$point</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">parentId</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="nv">$startid</span> <span class="o">=</span> <span class="nv">$point</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">parentId</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">elsif</span> <span class="p">(</span> <span class="n">eq_deeply</span><span class="p">(</span> <span class="nv">$point</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">point</span><span class="p">},</span> <span class="nv">$end</span> <span class="p">)</span>
            <span class="ow">and</span> <span class="nv">$point</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">parentId</span><span class="p">}</span> <span class="o">!=</span> <span class="nv">$connid</span>
            <span class="ow">and</span> <span class="nb">exists</span> <span class="nv">$hostinfo</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$point</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">parentId</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="nv">$endid</span> <span class="o">=</span> <span class="nv">$point</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">parentId</span><span class="p">};</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$startname</span><span class="p">)</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span> <span class="nv">$hostinfo</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$startid</span><span class="p">}</span> <span class="p">};</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$endname</span><span class="p">)</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span> <span class="nv">$hostinfo</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$endid</span><span class="p">}</span> <span class="p">};</span>
    <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$hostinfo</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$startid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$startname</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="nb">link</span><span class="p">}</span> <span class="p">},</span> <span class="nv">$endname</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">say</span> <span class="n">Dump</span> <span class="p">{</span> <span class="nb">map</span> <span class="p">{</span> <span class="k">my</span> <span class="p">(</span><span class="nv">$k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">$_</span><span class="p">;</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$y</span><span class="p">}</span> <span class="p">}</span> <span class="nb">values</span> <span class="nv">$hostinfo</span><span class="p">};</span>
</code></pre></div>
<p>生成的 <code>fig.yml</code> 如下：</p>
<div class="highlight"><pre><code class="yaml"><span class="nn">---</span>
<span class="l-Scalar-Plain">Haproxy</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">link</span><span class="p-Indicator">:</span>
   <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Serf</span>
<span class="l-Scalar-Plain">Nginx1</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">link</span><span class="p-Indicator">:</span>
   <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Serf</span>
<span class="l-Scalar-Plain">Serf</span><span class="p-Indicator">:</span>
<span class="l-Scalar-Plain">Nginx2</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">link</span><span class="p-Indicator">:</span>
   <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Serf</span>
<span class="l-Scalar-Plain">MySQL</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">link</span><span class="p-Indicator">:</span>
   <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Serf</span>
</code></pre></div>
<p>只是根据关系图生成了 link，其他配置都在图里的 Text 里照样写 yaml 格式，会自动带入。当然，示例另一个意思是：大家尽量都只 link 像 serf/etcd 这样的服务自动发现服务器。在 docker 层面就简洁明了。</p>
      <a href="/2014/03/07/genarate-fig-from-diagramo" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/02/20/gearman-task-priority" title="Gearman 任务的优先级" rel="bookmark">Gearman 任务的优先级</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-02-20 00:00:00 +0800">20 Feb 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>今天同事跟我说 Gearman 客户端添加任务的时候似乎设置优先级没有效果，于是去实现了一下，发现 Gearman 的任务优先级只有在任务本身属性完全一致的时候才能起到作用。比如说：新提交的 background 任务优先级虽然是 high，也不会在已经提交的<em>非</em> background、优先级是 low 的任务之前执行。</p>
<p>考虑到之前没用过优先级，这里贴一下测试代码当做笔记：</p>
<h1 id="worker">worker</h1>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Gearman::XS::</span><span class="n">Worker</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Gearman::XS::</span><span class="n">Worker</span><span class="p">;</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;10.4.1.21&#39;</span><span class="p">,</span> <span class="mi">4730</span><span class="p">);</span> 
<span class="k">my</span> <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$worker</span><span class="o">-&gt;</span><span class="n">add_server</span><span class="p">(</span><span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$worker</span><span class="o">-&gt;</span><span class="n">add_function</span><span class="p">(</span><span class="s">&quot;reverse&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">\&amp;</span><span class="nb">reverse</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">my</span> <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$worker</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">reverse</span> <span class="p">{</span>
  <span class="k">my</span> <span class="nv">$job</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
  <span class="k">my</span> <span class="nv">$workload</span> <span class="o">=</span> <span class="nv">$job</span><span class="o">-&gt;</span><span class="n">workload</span><span class="p">();</span>
  <span class="k">my</span> <span class="nv">$result</span>   <span class="o">=</span> <span class="nv">$workload</span><span class="p">;</span>
  <span class="nb">printf</span><span class="p">(</span><span class="s">&quot;Job=%s Function_Name=%s Workload=%s Result=%s\n&quot;</span><span class="p">,</span>
          <span class="nv">$job</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">(),</span> <span class="nv">$job</span><span class="o">-&gt;</span><span class="n">function_name</span><span class="p">(),</span> <span class="nv">$job</span><span class="o">-&gt;</span><span class="n">workload</span><span class="p">(),</span> <span class="nv">$result</span><span class="p">);</span>
  <span class="nb">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
  <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h1 id="client">client</h1>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Gearman::XS::</span><span class="n">Client</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Time::</span><span class="n">HiRes</span> <span class="sx">qw/time/</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Gearman::XS::</span><span class="n">Client</span><span class="p">;</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;10.4.1.21&#39;</span><span class="p">,</span> <span class="mi">4730</span><span class="p">);</span> 
<span class="k">my</span> <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="n">add_server</span><span class="p">(</span><span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$ret</span><span class="p">,</span> <span class="nv">$job_handle</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="n">do_background</span><span class="p">(</span><span class="s">&quot;reverse&quot;</span><span class="p">,</span> <span class="s">&#39;low&#39;</span><span class="o">.</span><span class="nb">time</span><span class="p">()</span> <span class="p">);</span>
<span class="p">}</span> 
</code></pre></div>
<h1 id="high-client">high-client</h1>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Gearman::XS::</span><span class="n">Client</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Time::</span><span class="n">HiRes</span> <span class="sx">qw/time/</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Gearman::XS::</span><span class="n">Client</span><span class="p">;</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;10.4.1.21&#39;</span><span class="p">,</span> <span class="mi">4730</span><span class="p">);</span> 
<span class="k">my</span> <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="n">add_server</span><span class="p">(</span><span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$ret</span><span class="p">,</span> <span class="nv">$job_handle</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="n">do_high_background</span><span class="p">(</span><span class="s">&quot;reverse&quot;</span><span class="p">,</span> <span class="s">&#39;high&#39;</span><span class="o">.</span><span class="nb">time</span><span class="p">()</span> <span class="p">);</span>
<span class="p">}</span> 
</code></pre></div>
<p>同时运行三个脚本，可以看到 worker 的输出，一直都是这样：</p>
<p>Job=H:YZSJHL1-21.opi.com:29434227 Function_Name=reverse Workload=high:1392887687.87583 Result=high:1392887687.87583
Job=H:YZSJHL1-21.opi.com:29434228 Function_Name=reverse Workload=high:1392887687.87594 Result=high:1392887687.87594
Job=H:YZSJHL1-21.opi.com:29434229 Function_Name=reverse Workload=high:1392887687.87605 Result=high:1392887687.87605</p>
<p>全都是高优先级的任务</p>
      <a href="/2014/02/20/gearman-task-priority" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/02/20/diff-between-lsddistid-and-operatingsystem-facts-variables" title="Facts 变量中 lsbdistid 和 operatingsystem 的区别" rel="bookmark">Facts 变量中 lsbdistid 和 operatingsystem 的区别</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-02-20 00:00:00 +0800">20 Feb 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Facts 变量是 puppet 里广泛使用的东西。在多种操作系统的混合环境中，通过 Facts 变量灵活定义不同的 package 名称、file 路径等应该是非常好用的办法。</p>
<p>不过关于操作系统，存在两类 Facts 变量，分别是 <code>lsbdistid</code> 和 <code>operatingsystem</code>。一般情况下，这两者结果基本一致，大家(至少我周围是)习惯采用 <code>operatingsystem</code> 这个一目了然的变量。</p>
<p>但是前两天发现有些机器的 puppet agent 运行失败，debug 后发现，居然是 <code>operatingsystem</code> 变量匹配不上！这台 CentOS 的服务器的 <code>operatingsystem</code> 结果是 OracleLinux！</p>
<p>翻看这两个变量的获取代码，他们的获取办法并不一致。</p>
<ul>
  <li><code>lsbdistid</code> 是通过运行 <code>lsb_release -i -s</code> 命令获取的；</li>
  <li><code>operatingsystem</code> 是通过一串超长的 if-elif-else 逻辑来判断的。恰好其中探测 <code>/etc/oracle-release</code> 是否存在的步骤优先于探测 <code>/etc/redhat-release</code> 的步骤。</li>
</ul>
<p>而这台服务器上，不知道怎么被人安装了一个 <code>oraclelinux-release-5-8.0.2</code> 的软件包，这个包里只有一个文件，就是 <code>/etc/oracle-release</code>！</p>
<p>这个软件包怎么出现的可以慢慢追查，但是这件事情本身提醒我们，<code>operatingsystem</code> 变量的获取方式过于简单，这些文本文件稍有问题可能就会导致错误。所以在只有 Linux 类服务器的情况，还是尽量确保所有节点都安装有 <code>lsb_release</code> 命令然后使用 <code>lsbdistid</code> 变量吧。</p>
      <a href="/2014/02/20/diff-between-lsddistid-and-operatingsystem-facts-variables" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/02/19/ngx-accounting-to-logstash" title="用 logstash 统计 Nginx 的 http_accounting 模块输出" rel="bookmark">用 logstash 统计 Nginx 的 http_accounting 模块输出</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-02-19 00:00:00 +0800">19 Feb 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>继续捡宝贝~</p>
<p>http_accounting 是 Nginx 的一个第三方模块，会每隔5分钟自动统计 Nginx 所服务的流量，然后发送给 syslog。</p>
<p>流量以 <code>accounting_id</code> 为标签来统计，这个标签可以设置在 <code>server {}</code> 级别，也可以设置在 <code>location /urlpath {}</code> 级别，非常灵活。
统计的内容包括响应字节数，各种状态码的响应个数。</p>
<p>公司原先是有一套基于 rrd 的<a href="https://github.com/Lax/ngx_http_accounting_module-utils">系统</a>，来收集处理这些 syslog 数据并作出预警判断、异常报警。不过今天不讨论这个，而是试图用最简单的方式，快速的搞定类似的中心平台。</p>
<p>这里当然是 logstash 的最佳用武之地。</p>
<p><code>logstash.conf</code> 示例如下：</p>
<pre><code>input {
    syslog {
        port =&gt; 29124
    }
}
filter {
    grok {
        match =&gt; [ "message", "^%{SYSLOGTIMESTAMP:timestamp}\|\| pid:\d+\|from:\d{10}\|to:\d{10}\|accounting_id:%{WORD:accounting}\|requests:%{NUMBER:req:int}\|bytes_out:%{NUMBER:size:int}\|(?:200:%{NUMBER:count.200:int}\|?)?(?:206:%{NUMBER:count.206:int}\|?)?(?:301:%{NUMBER:count.301:int}\|?)?(?:302:%{NUMBER:count.302:int}\|?)?(?:304:%{NUMBER:count.304:int}\|?)?(?:400:%{NUMBER:count.400:int}\|?)?(?:401:%{NUMBER:count.401:int}\|?)?(?:403:%{NUMBER:count.403:int}\|?)?(?:404:%{NUMBER:count.404:int}\|?)?(?:499:%{NUMBER:count.499:int}\|?)?(?:500:%{NUMBER:count.500:int}\|?)?(?:502:%{NUMBER:count.502:int}\|?)?(?:503:%{NUMBER:count.503:int}\|?)?"
    }
    date {
        match =&gt; [ "timestamp", "MMM dd YYY HH:mm:ss", "MMM  d YYY HH:mm:ss", "ISO8601" ]
    }
}
output {
    elasticsearch {
        embedded =&gt; true
    }
}
</code></pre>
<p>然后运行 <code>java -jar logstash-1.3.3-flatjar.jar agent -f logstash.conf</code> 即可完成收集入库！
再运行 <code>java -jar logstash-1.3.3-flatjar.jar web</code> 即可在9292端口访问到 Kibana 界面。</p>
<p>然后我们开始配置界面成自己需要的样子：</p>
<ol>
  <li>Top-N 的流量图</li>
</ol>
<p>点击 Query 搜索栏左边的有色圆点，弹出搜索栏配置框，默认是 <code>lucene</code> 搜索方式，改成 <code>topN</code> 搜索方式。然后填入分析字段为 accounting。</p>
<p>点击 Event Over Time 柱状图右上角第二个的 <code>Configure</code> 小图标，弹出图表配置框：</p>
<ul>
  <li>在 <code>Panel</code> 选项卡中修改 <code>Chart value</code> 的 <code>count</code> 为 <code>total</code>，<code>Value Field</code> 设置为 size；</li>
  <li>在 <code>Style</code> 选项卡中修改 <code>Chart Options</code> 的 <code>Bars</code> 勾选项为 <code>Lines</code>，<code>Y Format</code> 为 bytes；</li>
  <li>在 <code>Queries</code> 选项卡中修改 <code>Charted Queries</code> 为 <code>selected</code>，然后点中右侧列出的请求中所需要的那项(当前只有一个，就是<code>*</code>)。</li>
</ul>
<p>保存退出配置框，即可看到该图表开始自动更新。</p>
<ol>
  <li>50x 错误的技术图</li>
</ol>
<p>点击 Query 搜索栏右边的 + 号，添加新的 Query 搜索栏，然后在新搜索栏里输入需要搜索的内容，比如 <code>count.500</code>；</p>
<p>鼠标移动到流量图最左侧，会移出 Panel 快捷选项，点击最底下的 + 号选项添加新的 Panel：</p>
<ul>
  <li>选择 Panel 类型为 <code>histogram</code>；</li>
  <li>选择 Queries 类型为 <code>selected</code>，然后点中右侧列出的请求中所需要的那项(现在出现两个了，选中我们刚添加的 <code>count.500</code>)。</li>
</ul>
<p>保存退出，即可看到新多出来一行，左侧三分之一(默认是span4，添加的时候可以选择)的位置有了一个柱状图。</p>
<p>重复这个步骤，添加 502/503 的柱状图。</p>
<ol>
  <li>仪表盘设置存档</li>
</ol>
<p>页面右上角选择 <code>Save</code> 小图标保存即可。之后再上界面后，就可以点击右上角的 <code>Load</code> 小图标自动加载。</p>
<p><img src="/images/uploads/logstash-ngx-accounting.png" alt="" /></p>
<p>==================================</p>
<p>上面这个 grok 写的很难看，不过似乎也没有更好的办法～下一步会研究在这个基础上合并 skyline 预警。</p>
      <a href="/2014/02/19/ngx-accounting-to-logstash" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/02/18/diff-between-squid-ssd-and-ats-interim" title="squid-ssd方案和trafficserver的interim层的异同" rel="bookmark">squid-ssd方案和trafficserver的interim层的异同</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-02-18 00:00:00 +0800">18 Feb 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cache-ref" title="cache" rel="category tag">cache</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>最近重新捡起来两年前做的 cache 软件测试对比，把原先的 trafficserver 淘宝分支升级到了现在的社区主分支，主要区别就是配置文件里不再直接叫 <code>ssd.storage</code>，而是正规化的起了一个名字叫<code>interim cache layer</code>。</p>
<p>运行结果和当初类似，SATA 盘的 ioutil% 依然是远高于鄙司自创的 squid-ssd 方案。</p>
<p>于是沉下心来思考了一下为什么会有这么大的差距。</p>
<p>首先，squid-ssd 的设计其实非常简单，参照 Facebook 的 flashcache 原理扩展了 squid 原有的 COSS 存储引擎而已。所以我们先回忆一下 flashcache 的原理：</p>
<p>flashcache 是利用了 Linux 的 device-mapper 机制来虚拟逻辑块设备，在 ssd 和 sata 设备之间，flashcache 设计了三种模式：</p>
<ol>
  <li>Writethrough 模式，<strong>数据同时写到 ssd 和 sata 硬盘</strong>，官方文档的说明是：</li>
</ol>
<blockquote>
  <p>safest, all writes are cached to ssd but also written to disk
immediately. If your ssd has slower write performance than your disk (likely
for early generation SSDs purchased in 2008-2010), this may limit your system
write performance. All disk reads are cached (tunable).</p>
</blockquote>
<ol>
  <li>Writearound 模式，<strong>数据绕过 ssd，直接写到 sata 设备上</strong>，官方文档的说明是：</li>
</ol>
<blockquote>
  <p>again, very safe, writes are not written to ssd but directly to
disk. Disk blocks will only be cached after they are read. All disk reads
are cached (tunable).</p>
</blockquote>
<ol>
  <li>Writeback 模式，<strong>数据一开始只写到 ssd 上，然后根据缓存策略再移到 sata 设备上</strong>，官方文档的说明是：</li>
</ol>
<blockquote>
  <p>fastest but less safe. Writes only go to the ssd initially, and
based on various policies are written to disk later. All disk reads are
cached (tunable).</p>
</blockquote>
<p>squid-ssd 方案，学习的是 Writeback 模式，这种模式极大的缓解了普通 sata 设备的读写压力，牺牲了一定的数据安全。但是作为 CDN 缓存软件，本身就不需要保证这点 —— 这应该是源站来保证的。</p>
<p>相反，阅读了 ats 的文档说明后，发现 ats 的 interim 方案学习的是 Writearound 模式，而且默认的 tunable 那点还设的比较高， sata 设备上一个缓存对象要累积 2 次读取请求(最低可以修改到1，不能到0)后，才会缓存到 ssd 设备里去。</p>
<p>这一点从另一个细节上也可以反映出来：ats 的监控数据中，<code>proxy.process.cache.bytes_total</code> 是只计算了 <code>storage.config</code> 里写的那些 sata 设备容量的，不包括 interim 在的 ssd 设备容量。</p>
      <a href="/2014/02/18/diff-between-squid-ssd-and-ats-interim" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/02/08/whats-cooking-kibana-20140127" title="【翻译】Kibana 发生什么事了？" rel="bookmark">【翻译】Kibana 发生什么事了？</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-02-08 00:00:00 +0800">08 Feb 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>注：本文是 Elasticsearch 官方博客 2014 年 1 月 27 日《what’s cooking in kibana》的翻译，原文地址见：<a href="http://www.elasticsearch.org/blog/whats-cooking-kibana/">http://www.elasticsearch.org/blog/whats-cooking-kibana/</a></p>
<hr />
<p>Elasticsearch 1.0 即将发布， Kibana 团队也准备发布自己的新版。除了一些常见的 bug 修复和小调整，下一个版本中还有一些超棒的特性：</p>
<h1 id="section">面板组</h1>
<p>面板现在可以组织成组的形式，组内可以容纳你乐意加入的任意多的面板。每行的删减都很干净，隐藏面板也不会消耗任何资源。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2014/01/rows_as_groups.png" alt="" /></p>
<h1 id="section-1">图表标记</h1>
<p>变更部署，用户登录以及其他危险性事件导致的流量、内存消耗或者平均负载的变动，图表标记让你可以输入自定义的查询来将这些重要事件标记到时间轴图表上。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2014/01/chart_markers.png" alt="" /></p>
<h1 id="section-2">即时过滤器</h1>
<p>创建你自己的请求过滤器然后保存下来以备后用。过滤器将和仪表盘一起保存，而且可以在对比你定义的数据子集的时候菜单式展开或收缩。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2014/01/adhoc_filters.png" alt="" /></p>
<h1 id="top-n-">top-n 查询</h1>
<p>单击某个查询旁边的带色的点，就可以设置这个查询的颜色。新版的top-N 查询会找出一个字段 最流行的结果，然后用他们来完成新的查询。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2014/01/top_n_queries.png" alt="" /></p>
<h1 id="stats-">stats 面板</h1>
<p>Stats 面板最后都将把搜索归总成一个单独的有意义的数值。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2014/01/stats_panel.png" alt="" /></p>
<h1 id="termsstats-">terms_stats 模式</h1>
<p>按国家统计流量？每个用户的收入？每页的内存使用？terms面板的terms_stat模式正是你想要的。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2014/01/Screen-Shot-2014-01-27-at-9.14.42-AM.png" alt="" /></p>
      <a href="/2014/02/08/whats-cooking-kibana-20140127" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/01/22/explain-mojo-ioloop-delay-testing" title="Mojo::IOLoop::Delay 模块测试代码解释" rel="bookmark">Mojo::IOLoop::Delay 模块测试代码解释</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-01-22 00:00:00 +0800">22 Jan 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>昨天有人在群里问起<a href="https://metacpan.org/source/SRI/Mojolicious-4.68/t/mojo/delay.t">Mojolicious/t/mojo/delay.t</a> 中一段代码的执行原理。代码如下：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Mojo::</span><span class="n">Base</span> <span class="o">-</span><span class="n">strict</span><span class="p">;</span>
<span class="k">BEGIN</span> <span class="p">{</span>
  <span class="nv">$ENV</span><span class="p">{</span><span class="n">MOJO_NO_IPV6</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="nv">$ENV</span><span class="p">{</span><span class="n">MOJO_REACTOR</span><span class="p">}</span> <span class="o">=</span> <span class="s">&#39;Mojo::Reactor::Poll&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">use</span> <span class="nn">Test::</span><span class="n">More</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Mojo::</span><span class="n">IOLoop</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Mojo::IOLoop::</span><span class="n">Delay</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$delay</span> <span class="o">=</span> <span class="nn">Mojo::IOLoop::</span><span class="n">Delay</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$finished</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$result</span> <span class="o">=</span> <span class="nb">undef</span><span class="p">;</span>
<span class="nv">$delay</span><span class="o">-&gt;</span><span class="n">on</span><span class="p">(</span><span class="n">finish</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="nv">$finished</span><span class="o">++</span> <span class="p">});</span>
<span class="nv">$delay</span><span class="o">-&gt;</span><span class="n">steps</span><span class="p">(</span>
  <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$delay</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$end</span>   <span class="o">=</span> <span class="nv">$delay</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">;</span>
    <span class="nv">$delay</span><span class="o">-&gt;</span><span class="n">begin</span><span class="o">-&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="nn">Mojo::</span><span class="n">IOLoop</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">(</span><span class="mi">0</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="nv">$end</span><span class="o">-&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">});</span>
  <span class="p">},</span>
  <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$delay</span><span class="p">,</span> <span class="nv">@numbers</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$end</span> <span class="o">=</span> <span class="nv">$delay</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">;</span>
    <span class="nn">Mojo::</span><span class="n">IOLoop</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">(</span><span class="mi">0</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="nv">$end</span><span class="o">-&gt;</span><span class="p">(</span><span class="nb">undef</span><span class="p">,</span> <span class="nv">@numbers</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">});</span>
  <span class="p">},</span>
  <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$delay</span><span class="p">,</span> <span class="nv">@numbers</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="o">\</span><span class="nv">@numbers</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">);</span>
<span class="n">is_deeply</span> <span class="p">[</span><span class="nv">$delay</span><span class="o">-&gt;</span><span class="nb">wait</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="s">&#39;right return values&#39;</span><span class="p">;</span>
<span class="n">is</span> <span class="nv">$finished</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;finish event has been emitted once&#39;</span><span class="p">;</span>
<span class="n">is_deeply</span> <span class="nv">$result</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="s">&#39;right results&#39;</span><span class="p">;</span>
<span class="n">done_testing</span><span class="p">();</span>
</code></pre></div>
<p>首先介绍一下这个 <code>Mojo::IOLoop::Delay</code> 模块，这是异步编程中很火很实用的一个概念，一般叫 <code>Promise</code> / <code>Deferred</code> 。你可以按照顺序编程的思路组合那些异步函数，比如在这个例子里主要就体现了 <code>steps</code> 方法和 <code>finish</code> 事件。</p>
<p><code>steps</code> 方法中可以传递任意多个异步函数。第一个函数立刻执行，然后等 <code>$delay</code> 信号量(由 <code>begin</code> 方法控制)释放(即重新等于0)后逐次执行后面的函数，直到碰到一个不调用 <code>begin</code> 控制信号量的函数，或者触发 <code>error</code> 或者 <code>finish</code> 事件。</p>
<p><code>begin</code> 方法返回的回调函数 <code>$end-&gt;()</code> 用来减信号量。如果传递了参数给这个回调函数，那么第一个参数会被忽略，剩下的参数会 <code>push</code> 进下一个顺序或者事件触发函数的参数列表里，同时推送到 <code>wait</code> 方法。</p>
<p>所以上面这段测试的数据执行结果是这样的：</p>
<ol>
  <li><code>$delay-&gt;wait</code> 开始整个 <code>ioloop</code>, <code>steps</code> 方法首先执行 sub1 ，首先通过 <code>$delay-&gt;begin()</code>给信号量加1；</li>
  <li>随即触发 <code>timer</code> 事件，<code>$end-&gt;(1, 2, 3)</code> 将 <code>(2, 3)</code> 推入下一个函数 sub2 的 <code>@_</code> 里，同时把信号量减1；</li>
  <li>信号量变成0，继续执行，这一行 <code>$delay-&gt;begin()-&gt;(3, 2, 1)</code>，将 <code>(2, 1)</code> 推入下一个函数 sub2 的 <code>@_</code> 里，注意这里信号量实际也加减过一次，只是这里的回调函数直接匿名调用了；</li>
  <li>sub1 执行完成，信号量为0，那么开始下一个sub2，sub2 传入的参数列表其实是 <code>($delay, (2, 3), (2, 1))</code>，也就是说这时候的 <code>@numbers</code> 是 <code>(2, 3, 2, 1)</code>；</li>
  <li>sub2 执行流程类似 sub1 ，信号量加1，触发 <code>timer</code> 事件，然后 <code>$end-&gt;(undef, @numbers, 4)</code> 把 <code>((2, 3, 2, 1), 4)</code> 推入下一个函数 sub3 的 <code>@_</code> 里，同时信号量减1；</li>
  <li>sub2 执行完成，信号量为0，那么开始下一个sub3，sub3 传入的参数列表就是 <code>($delay, (2, 3, 2, 1, 4))</code>，也就是说这时候的 <code>@numbers</code> 是 <code>(2, 3, 2, 1, 4)</code>；</li>
  <li>sub3 将 <code>@numbers</code> 的引用赋值给 <code>$result</code>，因为 sub3 里没有对信号量的操作，而且也是最后一个了，<code>steps</code> 完成，触发 <code>finish</code> 事件；</li>
  <li>注册的 <code>finish</code> 事件回调函数把 <code>$finish</code> 变量加1；</li>
  <li><code>$delay-&gt;wait</code> 这时候也收集完毕前面每个 <code>$end-&gt;()</code> 的参数列表，和每步 <code>@numbers</code> 是同步的，同时因为 <code>finish</code> 事件被触发，就此停止 <code>ioloop</code>，程序完成，返回整个列表。</li>
</ol>
<p>如上。</p>
      <a href="/2014/01/22/explain-mojo-ioloop-delay-testing" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/01/15/kibana3-milestone4-20131105" title="【翻译】Kibana3 里程碑 4" rel="bookmark">【翻译】Kibana3 里程碑 4</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-01-15 00:00:00 +0800">15 Jan 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>本文来自Elasticsearch官方博客，2013年11月5日的文章<a href="http://www.elasticsearch.org/blog/kibana-3-milestone-4/">Kibana 3: mileston 4</a>，作为kibana3 Milestone 4重要的使用说明，翻译如下：</p>
<p>Kibana 3: Milestone 4 已经发布，带来了一系列性能、易用性和可视化上的提升。让我们来看看这些重大改变。如果你还在Milestone 3上，先看看之前<a href="http://chenlinux.com/2014/01/14/this-week-in-kibana-20130919">这篇博客</a>里的新特性介绍。</p>
<h1 id="section">一个全新的界面</h1>
<p>Kibana 面板改造成了一个标签更突出，按键和链接更易用，风格全新的样子。改造结果提高了可用度，因为有了更高效的空间利用设计，来支持更大的数据密度和更一致的UI。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/11/Screen-Shot-2013-10-31-at-3.45.06-PM.png" alt="Kibana的新界面" /></p>
<h1 id="section-1">一致性查询和过滤布局</h1>
<p>为了改善UI，查询和过滤面板现在有自己的可折叠、下拉的区域，具体位置在导航栏的下方。以后不再需要你自己摆放这些基本面板的布局了，它们默认会包含在每一个仪表盘里。和很多Kibana的特性一样，你也可以在仪表盘配置对话框里禁用这个一致性布局。</p>
<h1 id="section-2">100%全新的时间范围选择器</h1>
<p>如果你熟悉Kibana这两年来的历史，你可能知道曾经存在过好几个时间选择器方案。新的时间选择器经过了完全的重写，不仅占用空间比原来的小，也更容易使用。把这个重要组件移出主仪表盘后，Kibana 现在有更多空间专注于重要数据和图表。还有，新的过滤格式实现了Elasticsearch的<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-date-format.html#date-math">时间运算</a>，所以不用每次重新选择一个时间范围来移动你的时间窗口了，每个搜索都能自动更新这个窗口。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/11/Screen-Shot-2013-10-31-at-3.44.17-PM.png" alt="全新的时间选择器" /></p>
<h1 id="section-3">可过滤的字段列表</h1>
<p>利用表格的&rdquo;即输即过滤&rdquo;特性，可以简单而快速的找到字段。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/11/Screen-Shot-2013-10-31-at-3.46.52-PM.png" alt="可过滤的字段列表" /></p>
<h1 id="ad-hoc-facets">即时(ad-hoc) facets</h1>
<p>然后，当你找到了这些字段，就可以利用即时 facets 快速分析他们。只需要点击一个字段然后选择可视化即可查看到前10个匹配该字段的term。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/11/Screen-Shot-2013-10-31-at-3.45.42-PM.png" alt="" /></p>
<p>研究起来也更加简单了</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/11/Screen-Shot-2013-10-31-at-3.45.57-PM.png" alt="" /></p>
<p>不需要添加面板，饼图可以直接悬浮出现！</p>
<h1 id="url">动态的仪表盘和url参数</h1>
<p>Kibana 3: Milestone 4现在可以通过URL参数获取输入！这个备受期待的特性体现为两个方式：模板化的仪表盘和脚本化的仪表盘。Kibana 3: Milestone 4附带两个可以和Logstash完美配合的示例，在此基础上你可以构建自己的仪表盘。模板化仪表盘的创建非常简单，导出当前仪表盘结构成文件，编辑文件然后保存添加进你的 app/dashboards 目录既可以了。比如，从 <a href="https://github.com/elasticsearch/kibana/blob/v3.0.0milestone4/src/app/dashboards/logstash.json">logstash.json</a> 里摘录下面一段：</p>
<div class="highlight"><pre><code class="json">  <span class="s2">&quot;0&quot;</span><span class="err">:</span> <span class="p">{</span>
    <span class="nt">&quot;query&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;alias&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;#7EB26D&quot;</span><span class="p">,</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&quot;pin&quot;</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">}</span>
</code></pre></div>
<p>模板化仪表盘用&rdquo;handlebar 语法&rdquo;添加动态区段到基于JSON的仪表盘结构里。比如这里我们就用一个表达式替换掉了查询键的内容：<em>使用URL里的请求参数，如果不存在，使用&rsquo;*&lsquo;。</em> 现在我们可以用下面这条URL访问这个仪表盘了：</p>
<pre><code>http://kibana.example.com/index.html#/dashboard/file/logstash.json?query=extension:zip
</code></pre>
<h1 id="section-4">更灵活的脚本化仪表盘</h1>
<p>脚本化仪表盘在处理URL参数的时候更加强大，它能运用上Javascript的全部威力构建一个完整的仪表盘对象。同样用 app/dashboards 里的 <a href="https://github.com/elasticsearch/kibana/blob/v3.0.0milestone4/src/app/dashboards/logstash.js">logstash.js</a> 举例。因为脚本化仪表盘完全就是javascript，我们可以执行复杂的操作，比如切割URL参数。如下URL中，我们搜索_最近2天内的<code>HTML</code>, <code>CSS</code> 或者 <code>PHP</code>，然后在表格里显示 <code>request</code>, <code>response</code> 和 <code>user agent</code>。_注意URL本身路径从 <strong>file__变成了__script</strong>：</p>
<pre><code>http://localhost:8000/index.html#/dashboard/script/logstash.js?query=html,css,php&amp;from=2d&amp;fields=request,response,agent
</code></pre>
<h1 id="section-5">立刻下载</h1>
<p>Milestone 4对作者和使用者都是一个飞跃。它功能更强大，当然使用也更简单。Kibana 继续集成在 Logstash 里，最新发布的 <a href="http://logstash.net/docs/1.2.2/">Logstash 1.2.2</a> 中就带有。Kibana现在也可以直接用elasticsearch.org官网下载，地址见：<a href="http://www.elasticsearch.org/overview/kibana/installation/">http://www.elasticsearch.org/overview/kibana/installation/</a>。</p>
      <a href="/2014/01/15/kibana3-milestone4-20131105" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/01/14/this-week-in-kibana-20130919" title="【翻译】2013 年 9 月的 kibana 周报" rel="bookmark">【翻译】2013 年 9 月的 kibana 周报</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-01-14 00:00:00 +0800">14 Jan 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>本文来自Elasticsearch官方博客，2013年9月19日的文章<a href="http://www.elasticsearch.org/blog/this-week-in-kibana/">this week in kibana</a>，作为kibana3 Milestone 3重要的使用说明，翻译如下：</p>
<h1 id="section">直方图零填充</h1>
<p>直方图面板经过了一番改造，实现了正确的零填充。也就是说，当一个间隔内查询收到0个结果的时候，就显示为0，而不是绘制一条斜线连接到下一个点。零填充也意味着堆叠式直方图从顶端到底部的次序将保持不变。</p>
<p>此外，堆叠提示栏现在允许你在累积和个人模式之间自由选择。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/09/Screen-Shot-2013-09-18-at-3.13.27-PM.png" alt="" /></p>
<h1 id="section-1">数组字段的微分析</h1>
<p>数组字段现在可以在微分析面板上单独或者分组处理。比如，如果我有一个tags数组，我即可以看到前10个最常见的tags，也可以看到前10个最常见的tags组合。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/09/Screen-Shot-2013-09-18-at-3.16.07-PM.png" alt="" />
<img src="http://www.elasticsearch.org/content/uploads/2013/09/Screen-Shot-2013-09-18-at-3.16.21-PM.png" alt="" /></p>
<h1 id="source-"><code>_source</code> 作为默认的表字段</h1>
<p>如果你没有给你的表选择任何字段，Kibana现在默认会给你显示 <code>_source</code> 里的 json 数据，直到你选择了具体的字段。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/09/Screen-Shot-2013-09-18-at-3.14.00-PM.png" alt="" /></p>
<h1 id="section-2">可配置的字段截取</h1>
<p>注意到下面截图中 <code>_source</code> 字段末尾的&rdquo;&hellip;&ldquo;了吗？表格字段能被一个可以配置的&rdquo;因子&rdquo;截断。所谓因子就是，表格的列数除以它，得到一个字段的最大长度，然后各字段会被很好的截断成刚好符合这个长度。比如，如果我的截断因子是300，而表格有3列，那么每个字段会被截断成最大100个字符，然后后面跟上&rsquo;&hellip;&lsquo;。当然，字段的完整内容还是可以在细节扩展视图里看到的。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/09/Screen-Shot-2013-09-18-at-3.17.19-PM.png" alt="" /></p>
<h1 id="section-3">关于细节视图</h1>
<p>你可能已经知道单击表格某行后可以看到包含这个事件的字段的表格。现在你可以选择你希望如何观察这个事件的细节了，包括有语法高亮的JSON以及原始的未高亮的JSON。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/09/Screen-Shot-2013-09-18-at-3.17.47-PM.png" alt="" /></p>
<h1 id="section-4">更轻，更快，更小，更好</h1>
<p>Kibana有了一个全新的构建系统！新的系统允许我们构建一个优化的，小巧的，漂亮的新Kibana。当你升级的时候它还可以自动清除原来的缓存，定期构建的Kibana发布在 <a href="http://download.elasticsearch.org/kibana/kibana/kibana-latest.zip">http://download.elasticsearch.org/kibana/kibana/kibana-latest.zip</a> ，zip包可以直接解压到你的web服务器里。</p>
<p>如果愿意，你也可以从 <a href="https://github.com/elasticsearch/kibana">Github repository</a> 开始运行。不用复制整个项目，只需要上传 src/ 目录到服务器就可以了。不过我们强烈建议使用构建好的版本，因为这样性能好很多。</p>
      <a href="/2014/01/14/this-week-in-kibana-20130919" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/01/14/kibana-what-happened" title="【翻译】kibana发生什么变化了？" rel="bookmark">【翻译】kibana发生什么变化了？</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-01-14 00:00:00 +0800">14 Jan 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>本文来自Elasticsearch官方博客，2013年8月21日的文章<a href="http://www.elasticsearch.org/blog/kibana-whats-cooking/">kibana: what’s cooking</a>，作为kibana3重要的使用说明，翻译如下：</p>
<p>还没有升级Kibana么？那你可错过了一个好技术！Kibana 发生了翻天覆地的变化，新面板只是这个故事中的一部分。整个系统都被重构，给表盘提供统一的颜色和图例方案选择。接口也经过了标准化，很多函数都修改成提供更简单，快速和功能更强大的方式。让我们进一步看看现在的样子。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/BQIielHCAAAs2So.png" alt="" /></p>
<p>Terms 面板；全局色彩；别名和查询；过滤器。</p>
<h1 id="section">新的查询输入</h1>
<p>新的查询面板替代了原来的“字符串查询”面板作为你输入查询的方式。每个面板都有自己独立的请求输入。你也还可以为特殊的面板定制请求，不过你要先在这里输入他们，包括可以有别名和颜色设置，然后再在面板编辑器里选取。在没有被激活修改的时候， 查询也可以被固定在一个可折叠的区域。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/Screen-Shot-2013-08-20-at-11.48.43-AM.png" alt="" /></p>
<h1 id="section-1">分配查询到具体面板</h1>
<p>分配查询到具体面板非常非常简单。面板编辑器里就可以直接打开或关闭查询，哪怕这个查询已经更新或者过滤掉，它的别名是保持全局一致性的。你还会注意到配置窗口被分割成了选项卡形式，已提供更清晰的配置界面。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/Screen-Shot-2013-08-20-at-1.34.08-PM.png" alt="" /></p>
<h1 id="section-2">自定义颜色和别名</h1>
<p>当你给一个查询分配某个颜色的时候，它会立刻反映到所有的面板上。通常用于做图例值的别名也一样。这样，我们可以很简单的通过在一个逻辑组里分配颜色变化，调节整个仪表盘和数据的意义。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/Screen-Shot-2013-07-11-at-5.00.28-PM.png" alt="" /></p>
<h1 id="terms">你好，terms!</h1>
<p>引入了一个新的terms面板，可以使用3种不同的格式展示顶层字段数据：饼图、柱状图和表格。而且都可以点击进入新的过滤器面板。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/Screen-Shot-2013-08-20-at-1.47.56-PM.png" alt="" /></p>
<h1 id="section-3">过滤器面板?</h1>
<p>刚刚提到过滤器面板，对吧？没错，过滤器！过滤器允许你深入分解数据集而不用你去修改查询本身。然后，过滤器也可以被删除、隐藏和编辑。过滤器有三种模式：</p>
<ul>
  <li><strong>must</strong>: 记录必须匹配这个过滤器；</li>
  <li><strong>mustNot</strong>: 记录必须不能匹配这个过滤器；</li>
  <li><strong>either</strong>: 记录必须匹配这些过滤器中的一个。</li>
</ul>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/Screen-Shot-2013-08-20-at-1.55.54-PM.png" alt="" /></p>
<h1 id="section-4">字段列表和微面板</h1>
<p>字段面板集成在表格面板里。字段列表现在会通过访问Elasticsearch的<code>/_mapping</code>API来自动填充。注意你可能需要更新自己的代理服务器配置来适应这个变更。为了节约空间，这个字段列表现在也是可折叠的，而新的图形也添加到了微面板。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/Screen-Shot-2013-08-20-at-7.56.02-AM.png" alt="" /></p>
<h1 id="section-5">嗨，那配色方案呢?!</h1>
<p>对，你在我解释之前已经发现这个变化了！Kibana现在允许你在黑白两个配色方案之间切换以刚好的匹配你自己的环境和偏好。</p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/BQjv-50CcAAyazu.png" alt="" /></p>
<p>汇报完毕！当然kibana一直在更新，注意继续关注这里，给我们的<a href="https://github.com/elasticsearch/kibana/">github项目</a>加星，然后上推特fo <a href="https://twitter.com/rashidkpc/">@rashidkpc</a> 和 <a href="https://twitter.com/elasticsearch/">@elasticsearch</a>。</p>
      <a href="/2014/01/14/kibana-what-happened" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/01/08/run-docker-registry" title="私有 docker 仓库部署测试" rel="bookmark">私有 docker 仓库部署测试</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-01-08 00:00:00 +0800">08 Jan 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#cloud-ref" title="cloud" rel="category tag">cloud</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>docker 的官方仓库 CDN 的ip 总是被 GFW 认证。为了更好的使用 docker ，有必要在自己内部搭建一个私有仓库。方法很简单：</p>
<div class="highlight"><pre><code class="python"><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">dotcloud</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">registry</span><span class="o">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">docker</span><span class="o">-</span><span class="n">registry</span>
<span class="c"># 安装依赖</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">devel</span> <span class="n">libevent</span><span class="o">-</span><span class="n">devel</span> <span class="n">python</span><span class="o">-</span><span class="n">pip</span> <span class="n">openssl</span><span class="o">-</span><span class="n">devel</span> <span class="n">xz</span><span class="o">-</span><span class="n">devel</span> <span class="o">--</span><span class="n">enablerepo</span><span class="o">=</span><span class="n">epel</span>
<span class="n">python</span><span class="o">-</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
<span class="c"># 默认读取config/config.yml里的dev配置</span>
<span class="n">WORKER_SECRET_KEY</span><span class="o">=</span><span class="s">&quot;${WORKER_SECRET_KEY:-$(&lt; /dev/urandom tr -dc A-Za-z0-9 | head -c 32)}&quot;</span>
<span class="n">cat</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">/</span><span class="n">config</span><span class="o">.</span><span class="n">yml</span><span class="o">&lt;</span><span class="n">EOF</span>
<span class="n">dev</span><span class="p">:</span>
    <span class="n">storage</span><span class="p">:</span> <span class="n">local</span>
    <span class="n">storage_path</span><span class="p">:</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">registry</span>
    <span class="n">secret_key</span><span class="p">:</span> <span class="err">$</span><span class="p">{</span><span class="n">WORKER_SECRET_KEY</span><span class="p">}</span>
<span class="n">EOF</span>
<span class="c"># 默认的镜像存储位置，可以在 config.yml 里更改 storage_path</span>
<span class="n">mkdir</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">registry</span>
<span class="c"># 默认监听5000端口，前台运行，可以加入daemontools、supervisor、ubic之类的来负责</span>
<span class="n">sh</span> <span class="n">run</span><span class="o">.</span><span class="n">sh</span>
</code></pre></div>
<p>这就完成了。如果想用 nginx 作代理和加速镜像下载性能的，代码里也提供了 nginx.conf 可用。不过注意要求 nginx 版本在 1.3.9 以上，同时编译的时候还要加上 chunkin 模块。否则镜像上传的时候会出错。</p>
<p>然后就是客户端如何指定镜像推送到私有仓库里：</p>
<div class="highlight"><pre><code class="bash"><span class="c"># 在私有仓库注册用户</span>
docker login 127.0.0.1:5000
<span class="c"># 给要提交的镜像打标签</span>
docker tag &lt;CONTAINER ID&gt; 127.0.0.1:5000/tagname
<span class="c"># 推送到私有仓库</span>
docker push 127.0.0.1:5000/tagname
</code></pre></div>
<p>注意这里推送的时候使用的是REPOSITORY，也就是说不能是 <code>127.0.0.1:5000/ubuntu:12.04</code> 这样的格式。</p>
<p>现在就可以在其他地方用了：</p>
<div class="highlight"><pre><code class="bash">docker pull 192.168.0.2:5000/tagname
</code></pre></div>
      <a href="/2014/01/08/run-docker-registry" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/01/06/staticperl-and-upx" title="利用 staticperl 和 upx 生成 单个可执行 perl" rel="bookmark">利用 staticperl 和 upx 生成 单个可执行 perl</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-01-06 00:00:00 +0800">06 Jan 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>Perl 程序打包的问题由来已久。</p>
<p>最早是 perlcc，但是从5.10版本以后，B::CC 等一系列模块跟不上开发脚本导致 perlcc 也无法使用。</p>
<p>然后是PAR::Packer，唐凤大神的作品。</p>
<p>今天介绍另一个模块，App::Staticperl，同样是大神级作品，作者是Marc Lehmann。他的 AnyEvent、Coro、EV 无不大名鼎鼎。而staticperl，就是他开发出来用以方便自己部署程序的。</p>
<p>staticperl 官网上有一句很霸气的描述：“perl, libc, 100 modules, all in one standalone 500kb file”。</p>
<p>不过经我测试，按照官网上的步骤是做不出来这么小的单文件的！幸运的是我在 Perlmonks 上的<a href="http://www.perlmonks.org/?node_id=1065912">发问</a>很快收到了答案，这个还要用上另一个工具：upx。</p>
<p>测试过程如下：</p>
<div class="highlight"><pre><code class="bash"><span class="c"># cpanm App::Staticperl</span>
<span class="c"># staticperl install</span>
<span class="c"># staticperl instcpan AnyEvent AnyEvent::HTTP</span>
<span class="c"># staticperl mkperl -MAnyEvent -MAnyEvent::HTTP</span>
<span class="c"># staticperl mkapp myapp --boot myapp.pl -MAnyEvent -MAnyEvent::HTTP</span>
</code></pre></div>
<p>而如果是官网说的 <a href="http://staticperl.schmorp.de/smallperl.html">smallperl</a>，则是采用 <code>mkbundle</code> 的方法。</p>
<p>除了使用单独的<a href="http://staticperl.schmorp.de/smallperl.bundle">配置文件</a>存放太长的参数，其他和 <code>mkapp</code> / <code>mkperl</code> 一致。</p>
<p>不过运行结果是：生成的单个文件有3.5MB大小。</p>
<p>然后使用 upx：</p>
<div class="highlight"><pre><code class="bash"><span class="c"># apt-get install upx</span>
<span class="c"># upx --best smallperl.bin</span>
</code></pre></div>
<p>就得到压缩后的超小型perl了。这个perl内含了AE、Socket、common::sense、List::Util 等一系列常用模块可以直接使用。不过大小依然有 1.7MB 。看来是 Perl5.14 本身大小也变大了。</p>
<p><strong>补充</strong></p>
<p>按照评论里的建议，改用 <code>--lzma</code> 选项再压缩一次：</p>
<div class="highlight"><pre><code class="bash"><span class="c"># upx -d smallperl.bin</span>
<span class="c"># upx --lzma smallperl.bin</span>
</code></pre></div>
<p>结果到 1.4MB 大小。</p>
      <a href="/2014/01/06/staticperl-and-upx" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/01/05/run-perl-code-from-webpage" title="通过网页运行 Perl 代码的安全实现" rel="bookmark">通过网页运行 Perl 代码的安全实现</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-01-05 00:00:00 +0800">05 Jan 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>这几天折腾<a href="http://www.perl-china.com">Perl中国用户组网站</a>，觉得类似 Ruby 的 tryruby，Scala 的 scala-tour 这样的新手入门教程非常好玩。于是准备自己也尝试一下。</p>
<p>理论上，通过 Ajax 传递代码到服务器上，直接 <code>eval {}</code> 即可。不过这样会导致一个安全问题。如何防止用户执行错误代码导致严重后果呢？</p>
<p>我想到了最近一直在跟踪看的 Docker 容器。如果我们把代码放在 Docker 里运行，不就不怕了么。</p>
<p>首先要构建一个可以运行大多数示例代码的 Docker 镜像。</p>
<h3 id="section">首先打开一个终端运行初始镜像：</h3>
<div class="highlight"><pre><code class="bash"><span class="c"># docker run -i -t ubuntu /bin/sh</span>
<span class="c"># apt-get install -y wget gcc make</span>
<span class="c"># useradd tour</span>
<span class="c"># echo &#39;tour hard nproc 8&#39; &gt;&gt; /etc/security/limits.conf</span>
<span class="c"># wget http://cpanmin.us -O bin/cpanm</span>
<span class="c"># cpanm List::AllUtils Moo Path::Tiny DBD::SQLite AnyEvent::HTTP DateTime</span>
</code></pre></div>
<h3 id="section-1">然后打开另一个终端保存前一个终端的变更：</h3>
<div class="highlight"><pre><code class="bash"><span class="c"># docker ps</span>
CONTAINER ID ...
<span class="c"># docker commit &lt;ID&gt; perl-tour</span>
</code></pre></div>
<p>注意一定要在之前 <code>cpanm</code> 已经成功执行完毕后保存，但是前面登录进 docker 的会话千万不要退出，否则后面的 <code>docker ps</code> 就查看不到 id 了。退出时这些临时变更都毁掉了。</p>
<p><strong>2014 年 1 月 7 日补充</strong></p>
<p>被莫莫用死循环 <code>fork()</code> 轰炸了一回，发现 docker 容器的一个问题，容器技术本身没有对用户最大进程数的限制。因为其实际运行的是 <code>docker -d</code> 服务进程的子进程。</p>
<p>直接在镜像里编辑 <code>/etc/security/limits.conf</code> 实测没有作用。而主机上限定普通用户的 nproc 也没用(因为普通用户运行不了 docker )。</p>
<p>最后想到的办法，是启动 <code>docker -d</code> 的时候，先 <code>ulimit -HSu 16</code>，这样这个 docker 下一共也跑不了多少 fork 了。</p>
<p>顺带提一句，查阅系统日志可以发现，在 fork 的时候，其实触发了主机的 OOM-killer，但是这个机制在死循环这个变态攻击下挽救不了主机……</p>
<p><strong>END</strong></p>
<p>现在我们已经有了一个安装好很多常用 CPAN 模块的镜像了。可以取构建网站了。</p>
<p>网站里添加下面一段：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">Ajax</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Temp</span> <span class="sx">qw(tempfile)</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">IPC::</span><span class="n">Run</span> <span class="sx">qw(start harness timeout)</span><span class="p">;</span>
<span class="n">ajax</span> <span class="s">&#39;/run&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$code</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="s">&#39;code&#39;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">@cmd</span> <span class="o">=</span> <span class="sx">qw(docker run -m 128m -u tour -v /tmp/:/tmp:ro perl-tour perl)</span><span class="p">;</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="nv">$temp</span><span class="p">)</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">();</span>
    <span class="nb">binmode</span><span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="s">&#39;:utf8&#39;</span><span class="p">);</span>
    <span class="k">print</span> <span class="nv">$fh</span> <span class="nv">$code</span><span class="p">;</span>
    <span class="nb">push</span> <span class="nv">@cmd</span><span class="p">,</span> <span class="nv">$temp</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$h</span><span class="p">;</span>
    <span class="nb">eval</span> <span class="p">{</span>
        <span class="nv">$h</span> <span class="o">=</span> <span class="n">harness</span> <span class="o">\</span><span class="nv">@cmd</span><span class="p">,</span> <span class="o">\</span><span class="nv">$in</span><span class="p">,</span> <span class="o">\</span><span class="nv">$out</span><span class="p">,</span> <span class="o">\</span><span class="nv">$err</span><span class="p">,</span> <span class="n">timeout</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
        <span class="n">start</span> <span class="nv">$h</span><span class="p">;</span>
        <span class="nv">$h</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">if</span><span class="p">(</span><span class="vg">$@</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$x</span> <span class="o">=</span> <span class="vg">$@</span><span class="p">;</span>
        <span class="nv">$h</span><span class="o">-&gt;</span><span class="n">kill_kill</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$x</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nb">unlink</span> <span class="nv">$temp</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">to_json</span><span class="p">({</span>
        <span class="n">Errors</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">,</span> <span class="nv">$err</span><span class="p">)</span> <span class="p">],</span>
        <span class="n">Events</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">,</span> <span class="nv">$out</span><span class="p">)</span> <span class="p">],</span>
    <span class="p">});</span>
<span class="p">};</span>
</code></pre></div>
<p>页面上通过 Ajax 请求交互：</p>
<div class="highlight"><pre><code class="javascript">  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="s2">&quot;/run?code=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">codeStr</span><span class="p">),</span> <span class="p">{</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
    <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">Errors</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">setOutput</span><span class="p">(</span><span class="nx">outputDiv</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">Errors</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">setOutput</span><span class="p">(</span><span class="nx">outputDiv</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">Events</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">ErrEvents</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">outputDiv</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span>
        <span class="s2">&quot;Error communicating with remote server.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
</code></pre></div>
<p>静态页面部分严重参考了 Scala 的 Tour 页。趁机学习了 impress.js 制作幻灯片效果、codemirror 实现代码高亮效果。</p>
<p>最终效果见 <a href="http://www.perl-china.com/tour.html">少年 Perl 的魔法世界</a>。欢迎大家莅临指导~</p>
<p>最后，阅读了 Golang Tour 关于 <a href="http://play.golang.org">Go Playground</a> 的原理说明，发现它们是在 Google App Engine 上运行实例，然后走消息队列把代码发送给后台实例运行结果。</p>
<p>当然，Go Playground 不单单是支持 Tour，而且还包括社区各式第三方模块的测试和使用。把角色拆分出来也是正常的。</p>
      <a href="/2014/01/05/run-perl-code-from-webpage" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2014/01/05/future-with-anyevent" title="Future模块和AnyEvent事件驱动的结合" rel="bookmark">Future模块和AnyEvent事件驱动的结合</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2014-01-05 00:00:00 +0800">05 Jan 2014</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>上个月的 advent calendar 活动中，有一个新的模块进入我们视野，这就是 IO::Async 模块作者写的 <a href="https://metacpan.org/pod/Future">Future</a> 模块。通过 Future 模块，我们可以做到对异步请求的各种控制，比如：</p>
<ul>
  <li><code>needs_all</code> / <code>needs_any</code> / <code>wait_any</code> / <code>wait_all</code></li>
  <li><code>then</code> / <code>else</code> / <code>and_then</code> / <code>or_else</code> / <code>followed_by</code></li>
  <li><code>on_ready</code> / <code>on_done</code> / <code>on_fail</code> / <code>on_cancel</code></li>
</ul>
<p>目前来说，IO::Async 是原生支持 Future 了的。但是 AnyEvent 框架才是目前 Perl 社区事件驱动编程的主流选择。还好 Future 源码目录下 <a href="https://metacpan.org/source/PEVANS/Future-0.21/examples">examples/</a> 里有关于 AnyEvent 和 POE 如何跟 Future 一起运行的示例。</p>
<p>示例统一举例的是 timer 事件。而我更看好的是 <a href="https://metacpan.org/pod/Future::Utils">Future::Utils</a> 提供的一些关于循环的函数，比如 <code>fmap</code> 可以很简单的控制住异步的并发数。稍微试验，得到脚本如下：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">Future::</span><span class="n">AnyEvent</span><span class="p">;</span>
<span class="k">use</span> <span class="n">base</span> <span class="sx">qw( Future )</span><span class="p">;</span>
<span class="k">use</span> <span class="n">AnyEvent</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">HTTP</span><span class="p">;</span> 
<span class="k">sub </span><span class="nf">await</span> <span class="p">{</span>
   <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
   <span class="k">my</span> <span class="nv">$cv</span> <span class="o">=</span> <span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">condvar</span><span class="p">;</span>
   <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">on_ready</span><span class="p">(</span><span class="k">sub </span><span class="p">{</span> <span class="nv">$cv</span><span class="o">-&gt;</span><span class="nb">send</span> <span class="p">});</span>
   <span class="nv">$cv</span><span class="o">-&gt;</span><span class="nb">recv</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">sub </span><span class="nf">httpget</span> <span class="p">{</span>
   <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
   <span class="n">http_get</span><span class="p">(</span><span class="nb">shift</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
      <span class="k">my</span> <span class="p">(</span><span class="nv">$content</span><span class="p">,</span> <span class="nv">$headers</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
      <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="nv">$content</span><span class="p">);</span>
   <span class="p">});</span>
   <span class="k">return</span> <span class="nv">$self</span><span class="p">;</span>
<span class="p">}</span>
<span class="nb">package</span> <span class="n">main</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Future::</span><span class="n">Utils</span> <span class="sx">qw/fmap/</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@urls</span> <span class="o">=</span> <span class="sx">qw(</span>
<span class="sx">    http://www.sina.com.cn</span>
<span class="sx">    http://www.baidu.com</span>
<span class="sx">    http://www.sohu.com</span>
<span class="sx">#    ...</span>
<span class="sx">)</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$f</span> <span class="o">=</span> <span class="n">fmap</span> <span class="p">{</span>
    <span class="nn">Future::</span><span class="n">AnyEvent</span><span class="o">-&gt;</span><span class="n">httpget</span><span class="p">(</span> <span class="nb">shift</span> <span class="p">);</span>
<span class="p">}</span> <span class="k">foreach</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@urls</span><span class="p">,</span> <span class="n">concurrent</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@res</span> <span class="o">=</span> <span class="nv">$f</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">;</span>
<span class="k">print</span> <span class="nv">@res</span><span class="p">;</span>
</code></pre></div>
<p>看起来稍显复杂。这里其实最关键的就是几个接口函数：</p>
<ul>
  <li>await / on_ready</li>
</ul>
<p>Future 对象到实际执行时(即-&gt;get调用处)，会寻找 <code>await</code> 方法。所以必须给自己选用的事件驱动实现这个 <code>await</code> 方法。</p>
<p>ready 状态即一个 Future 执行完成，注意执行完成不意味着执行成功，ready 状态包括 success 和 fail 两种，其实是可以分别定义 <code>on_success</code> 和 <code>on_failure</code> 回调的。
<code>on_ready</code> 回调的作用是：在该 Future 对象达到 ready 状态的时候，执行这步调用。</p>
<p>在本例使用 AnyEvent 的时候，也就是一般来说都会在每步操作结束的 <code>$cv-&gt;send</code> 改到这里来等待调用。</p>
<ul>
  <li>done / done_cb</li>
</ul>
<p>那 Future 对象的 ready 状态是怎么来的呢？就是这步了：<code>$f-&gt;done</code> 一旦被调用，就意味着该 Future 对象进入了 ready and success 状态。</p>
<p>同样，如果你要详细控制 Future 对象进入具体的 ready but failure 状态，就使用 <code>$f-&gt;fail</code> 好了。</p>
<p>调用 <code>-&gt;done|fail()</code> 的时候，你可以选择传递具体哪些数据。比如本例中，就只传递了抓取的 <code>$content</code> 而没有 <code>$headers</code>。</p>
<p>Future 提供了 <code>-&gt;done_cb</code> 和 <code>-&gt;fail_cb</code> 两个回调函数，默认传递回当前全部数据。本例如果要传回全部，就可以直接写成<code>http_get shift, $self-&gt;done_cb</code>。</p>
<p>好了，就到这里。这个例子虽然比 Future 自带的 <code>anyevent.pl</code> 示例稍微复杂一点，但是依然很简单。如果能引起大家的兴趣，请直接阅读官方文档。</p>
      <a href="/2014/01/05/future-with-anyevent" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/12/31/report-of-this-year" title="2013 年度个人总结" rel="bookmark">2013 年度个人总结</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-12-31 00:00:00 +0800">31 Dec 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>又到了一年年底。照例(虽然这个例也就是去年开始的)开始年度总结。</p>
<p>在一年前写总结时，我决然想不到今年会是这样。事实上，当初的计划是往底层深入学习，在 Linux 或者 TCP/IP 方面有所得。但是一年后现在看，今年的工作依然集中在 Puppet 和 监控两方面。所以今年盘点，可能能让自己记忆深刻的，大多“功夫在课外”了。</p>
<p>年初，在编辑鼓励下开始尝试整理过去的知识体系，准备写一本网站运维相关的书籍。感谢这几年坚持记录博客，大几百的 Word 文档最后还比原计划提前写完了。写书的几个月中，我总是开玩笑的说“赚点钱买的起沙发就满足了”，虽然书还没出版，但其实这个过程中本身的收获已然很多。网上很多大神们说写书没意义，或许我还没到那种举重若轻的层次吧，我觉得这真的是一个不错的提升自我修养的手段。（当然，即便是现在回想，也觉得这过程中犯傻不断，给我一个重来的机会，绝对不选这么大话题动笔）</p>
<p>年中，参与 Perl 中国社区大会的举办。和其他老手不同，我本身只在三年前听过一次 Perl Beijing Workshop 而已，这次直接就被“骗上贼船”，作为报名网站的管理员维护一点信息发布，邀请还不算很熟的朋友一同演讲，当然也贡献了自己的第一次公开演讲。演讲前一晚，特意在家试讲让老婆帮忙提意见，毫不意外的被老婆批为乱七八糟。最后临场刚好卡在45分钟结束，但是从反响来看，依然选题有些宽泛，要在一个演讲里同时展示 Elasticsearch 的知识、logstash 的知识、Message::Passing 的知识，只能让听众更加迷惑。意外之喜是这次演讲的 slide 后来发到网上，倒是被不少外国人 like 甚至转到 twitter 上，赢得不少关注。</p>
<p>原本在 ChinaUnix 论坛上答应在大会的 lighting talk 上稍微讲一下 autobox 的运用，结果有事提前退场了，感觉失约这种事情真是超级不好意思，但愿明年还有 Perl Workshop 来给我弥补！</p>
<p>会上见到了 90 后的 Perler，会后没多久读到 stevan little 收回他《Perl isn&rsquo;t dead, Perl is dead end》一文并重启 MOP 计划的通告，让我对 Perl 的未来依然有信心多了。</p>
<p>话题之外，参加了 RubyConfChina2013，Rubist 普遍比 Perl Monger 土豪多了。我们演讲人清一色小黑，他们清一色苹果……</p>
<p>年底读了许式伟的《Go 语言编程》，完全不是给我们这些非科班的运维人员读的东西，看完以后一点对 golang 的兴趣都没有增加，虽然本人依然坚持“能够在运维社区火起来的东西肯定是比较靠谱的”。</p>
<p>博客方面，欠了两篇一直没时间写，关于 docker 如何自己作image，以及 staticperl 的使用。</p>
<p>工作之外，花了点时间在一些开源社区：</p>
<ol>
  <li>
    <p>logstash</p>
    <p>logstash 在今年渐成气候，连它的竞争对手 fluentd 在年度报告中都承认 logstash 在美国已经势不可挡(fluentd的主阵地是日本)。个人在 logstash 代码方面只是保持跟踪阅读，因为没有业务需求推动，所以不再跟去年那样大肆修改代码。倒是通过weibo、QQ等方式回答了应该有好几十个人的问题，最后在各方鼓励下开设了 logstash 的QQ群(315428175)，欢迎爱好者加入～</p>
    <p>另一个惊喜的事情，两位 logstash 同好在问完问题之后，主动送了《Elasticsearch Server》和《thelogstashbook》给我。</p>
  </li>
  <li>
    <p>Rexify</p>
    <p>Rexify 是德国2012年度最佳开源软件。不过受国内 Perl 社区总体不给力的影响，不可能如 Python 的 SaltStack 那样突然窜起。去年提交的 krb5 认证的 patch 在今年终于被作者合并，年中翻译完成了 <a href="http://rex.perl-china.com">Rexify 中文站</a> 后，有一段时间没有进展了。</p>
  </li>
  <li>
    <p>Docker</p>
    <p>这是今年下半年重点看好的项目。博客中从 8 月开始就有好几篇关于这个内容，甚至专门订阅了 DockerWeekly。Docker 文档非常全，使用非常简单，实在爱不释手，最近老琢磨如何用在工作中去。最后这周，配合 pstuifzand 改进 Docker 的 <a href="https://github.com/chenryn/docker-perl">Perl 客户端</a>，主要是他写的时候 docker 默认还是监听在本地的 4243 端口，现在已经改成 <code>/var/run/docker.sock</code> 了。于是把 <code>Net::Docker</code> 里 <code>LWP::UserAgent</code> 和 <code>AnyEvent::HTTP</code> 的 Unix-Socket 支持都实现出来。</p>
    <p>另一方面，也给 Rexify 项目实现了 <code>Rex::Virtualization::Docker</code> 的支持，不过这个则是调用 docker 命令行的方式。</p>
    <p>最后，强烈谴责 GFW 屏蔽 Docker 的 CDN 边缘节点 IP 地址的行为。我本来提议让官方提供镜像方式，让我们在国内作镜像服务。结果官方表示 <code>docker pull</code> 的过程中连接了多个 api 服务，不是单单搞镜像可以解决的。目前只能是通过绑定 /etc/hosts 的方式直接访问官方的源站 IP，不走 CDN 了。</p>
  </li>
  <li>
    <p>Perl</p>
    <p>Perl5 社区今年发起了一系列活动，激发社区活跃性。其中包括一项挽救濒死模块。根据自己的情况，花了 3 个月时间走流程，最终成功认领了 <code>HTML::TagHelper</code> 模块。这个模块的原作者是个北欧妹纸，后来写 php 去了，看 linkedin 信息都已经是 CTO 了。</p>
    <p>因为工作中用到 MooseFS，所以仿造 moosefs.cgi 里的接口写了 Perl 版的模块发到 CPAN，结果 moosefs 的作者之一 peter aNeutrino 主动发邮件来问是否需要更多帮助。只能说大神们真的好热情……</p>
    <p>和氓氓等一起试图给 PerlChina 增加活跃气氛，申请了 <a href="http://weibo.com/perldaily">@perldaily</a> 帐号专门发技术内容，创建了 <a href="http://www.perl-china.com">www.perl-china.com</a> 网站。总的来说，努力过，成效就不在能力范围内了。</p>
  </li>
</ol>
<p>再说一些跟国外的事情，虽然都是小事，但迈出第一步，总是值得纪念的：</p>
<ol>
  <li>Perl 社区每年12月会发起 advent calendar 活动。今年主动去日本的 Qiita 技术社区投稿，写了一篇文章讲 Rex::Box 的运用。虽然写不来日语，不过代码就是最好的语言～～</li>
  <li>被 facebook 的 tech recruiter 找上来聊天，算是见识了一下除了美剧以外的英语，嗯，也就如此了。</li>
</ol>
<p>最后一项不得不记的，关于比特币。我个人其实没有资金投入到这场狂欢中，不过暴赚几十万的同事、步步踩空的同事历历在目。一方面也回顾了一下当初的股票分析知识，通过程序作出了一些“不负责任的”指导意见，没有被同事们暴揍，算是一件很值得娱乐的事情～
从严肃意义上来说，这件事情提醒了已经迈向26岁的自己，你已经不年轻了，Perl 之外，请考虑人生和理财的问题。</p>
<p>&ldquo;Yes, sir!&rdquo;</p>
      <a href="/2013/12/31/report-of-this-year" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/12/09/draw-charts-of-bitcoin" title="为比特币绘制 MACD、BOLL、KDJ 指标图" rel="bookmark">为比特币绘制 MACD、BOLL、KDJ 指标图</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-12-09 00:00:00 +0800">09 Dec 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#python-ref" title="python" rel="category tag">python</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>比特币是最近相当火爆的一个金融衍生品(瞧咱这口径)。比特币中国提供了一系列 API 来获取和操纵其市场内的比特币。我的小伙伴们基于其 API，完成了一套交易程序。为了提高操作的有效性和技术性，同时作为 python 学习需要，我也参与进来，仿造股票交易软件，为比特币中国绘制了一系列指标图，包括 MACD、BOLL、KDJ 等。截止上周，btc123 也开始提供了 MACD 指标图，所以把自己的实现贴到博客。</p>
<p>首先是获取数据，比特币中国的 API 是个很鬼怪的东西，实时交易数据的接口，返回的数据中最高最低和成交量都是基于过去24小时的，要知道比特币交易是没有休市的啊。所以获取数据过程中需要自己计算这些。这里考虑到股市一般一天实际交易4小时，所以整个设计也是默认4小时的图形展示。</p>
<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/env python3</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># query price data from BTCChina.</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;config.yaml&#39;</span><span class="p">))</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;host&#39;</span><span class="p">],</span><span class="n">user</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;username&#39;</span><span class="p">],</span><span class="n">passwd</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;password&#39;</span><span class="p">],</span><span class="n">db</span> <span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;databasename&#39;</span><span class="p">],</span><span class="n">charset</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;encoding&#39;</span><span class="p">]</span> <span class="p">)</span>
<span class="k">def</span> <span class="nf">write_db</span><span class="p">(</span><span class="n">datas</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cur_write</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span>  <span class="s">&quot;insert into ticker(sell, buy, last, vol, high, low) values( </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;</span>
        <span class="n">cur_write</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">datas</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">cur_write</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Mysql error </span><span class="si">%d</span><span class="s"> : </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_tid</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">vol_url</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;btcchina&#39;</span><span class="p">][</span><span class="s">&#39;vol_url&#39;</span><span class="p">]</span>
        <span class="n">remote_file</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">vol_url</span><span class="p">)</span>
        <span class="n">remote_data</span> <span class="o">=</span> <span class="n">remote_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">remote_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">remote_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">remote_data</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">remote_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;tid&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Mysql error </span><span class="si">%d</span><span class="s"> : </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_ohlc</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">read</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">hlvsql</span> <span class="o">=</span> <span class="s">&quot;select max(last),min(last) from ticker where time between date_add(now(),interval -</span><span class="si">%s</span><span class="s"> minute) and now()&quot;</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">hlvsql</span><span class="p">)</span>
        <span class="n">high</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">closesql</span> <span class="o">=</span> <span class="s">&quot;select last from ticker where time between date_add(now(),interval -</span><span class="si">%s</span><span class="s"> minute) and now() order by time desc limit 1&quot;</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">closesql</span><span class="p">)</span>
        <span class="n">close</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">opensql</span> <span class="o">=</span> <span class="s">&quot;select last from ticker where time between date_add(now(),interval -</span><span class="si">%s</span><span class="s"> minute) and now() order by time asc limit 1&quot;</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">opensql</span><span class="p">)</span>
        <span class="n">opend</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">opend</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Mysql error </span><span class="si">%d</span><span class="s"> : </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">write_ohlc</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cur_write</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">ohlcsql</span> <span class="o">=</span>  <span class="s">&#39;insert into ohlc(open, high, low, close, vol) values( </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&#39;</span>
        <span class="n">cur_write</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ohlcsql</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">cur_write</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Mysql error </span><span class="si">%d</span><span class="s"> : </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;执行Mysql写入数据时出错: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>  <span class="n">e</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">instance</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
    <span class="c"># returns something like {&quot;high&quot;:738.88,&quot;low&quot;:689.10,&quot;buy&quot;:713.50,&quot;sell&quot;:717.30,&quot;last&quot;:717.41,&quot;vol&quot;:4797.32000000}</span>
        <span class="n">remote_file</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;btcchina&#39;</span><span class="p">][</span><span class="s">&#39;ticker_url&#39;</span><span class="p">])</span>
        <span class="n">remote_data</span> <span class="o">=</span> <span class="n">remote_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">remote_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">remote_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">remote_data</span><span class="p">))[</span><span class="s">&#39;ticker&#39;</span><span class="p">]</span>
    <span class="c">#   remote_data = {key:literal_eval(remote_data[key]) for key in remote_data}</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">remote_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">remote_data</span><span class="p">:</span>
        <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remote_data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">datas</span>
<span class="n">lastid</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ohlc_period</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">next_ohlc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">/</span> <span class="n">ohlc_period</span> <span class="o">*</span> <span class="n">ohlc_period</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">datas</span> <span class="o">=</span> <span class="n">instance</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">datas</span><span class="p">:</span>
        <span class="n">write_db</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">next_ohlc</span><span class="p">):</span>
        <span class="n">next_ohlc</span> <span class="o">+=</span> <span class="n">ohlc_period</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_ohlc</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">latestid</span> <span class="o">=</span> <span class="n">get_tid</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">latestid</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastid</span><span class="p">))</span>
        <span class="n">lastid</span> <span class="o">=</span> <span class="n">latestid</span>
        <span class="n">write_ohlc</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p>这里主要把实时数据存入ticker表，分钟统计数据存入ohlc表。然后是各指标算法。首先是 MACD ：</p>
<div class="highlight"><pre><code class="python"><span class="c">#/*******************************************************************************</span>
<span class="c"># * Author: Chenlin Rao | Renren inc.</span>
<span class="c"># * Email: rao.chenlin@gmail.com</span>
<span class="c"># * Last modified: 2013-11-26 22:02</span>
<span class="c"># * Filename: macd.py</span>
<span class="c"># * Description: </span>
<span class="c">#       EMA(12)=LastEMA(12)* 11/13 + Close * 2/13</span>
<span class="c">#       EMA(26)=LastEMA(26)* 25/27 + Close * 2/27</span>
<span class="c">#       </span>
<span class="c">#       DIF=EMA(12)-EMA(26)</span>
<span class="c">#       DEA=LastDEA * 8/10 + DIF * 2/10</span>
<span class="c">#       MACD=(DIF-DEA) * 2</span>
<span class="c"># * *****************************************************************************/</span>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="k">class</span> <span class="nc">MACD</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;config.yml&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sleep_time</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;btcchina&#39;</span><span class="p">][</span><span class="s">&#39;trade_option&#39;</span><span class="p">][</span><span class="s">&#39;sleep_time&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;host&#39;</span><span class="p">],</span><span class="n">user</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;username&#39;</span><span class="p">],</span><span class="n">passwd</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;password&#39;</span><span class="p">],</span><span class="n">db</span> <span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;databasename&#39;</span><span class="p">],</span><span class="n">charset</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;encoding&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_getclose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;select close,time from ohlc order by id desc limit </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_ema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns an n period exponential moving average for</span>
<span class="sd">        the time series s</span>
<span class="sd">        s is a list ordered from oldest (index 0) to most</span>
<span class="sd">        recent (index -1)</span>
<span class="sd">        n is an integer</span>
<span class="sd">        returns a numeric array of the exponential</span>
<span class="sd">        moving average</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;No enough item in </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">s</span>
        <span class="n">ema</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c">#get n sma first and calculate the next n period ema</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span> <span class="o">/</span> <span class="n">n</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">ema</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sma</span><span class="p">)</span>
        <span class="c">#EMA(current) = ( (Price(current) - EMA(prev) ) x Multiplier) + EMA(prev)</span>
        <span class="n">ema</span><span class="o">.</span><span class="n">append</span><span class="p">((</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">sma</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span> <span class="o">+</span> <span class="n">sma</span><span class="p">)</span>
        <span class="c">#now calculate the rest of the values</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">ema</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span> <span class="o">+</span> <span class="n">ema</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">ema</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ema</span>
    <span class="k">def</span> <span class="nf">getMACD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getclose</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">array</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span>
        <span class="n">short_ema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ema</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">long_ema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ema</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">short_ema</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">long_ema</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">diff</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">dea</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ema</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">diff</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dea</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">33</span><span class="p">:],</span> <span class="n">diff</span><span class="p">[</span><span class="mi">8</span><span class="p">:]),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">33</span><span class="p">:],</span> <span class="n">dea</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">33</span><span class="p">:],</span> <span class="n">bar</span><span class="p">)</span>
</code></pre></div>
<p>然后是 BOLL ：</p>
<div class="highlight"><pre><code class="python"><span class="c">#/*******************************************************************************</span>
<span class="c"># * Author: Chenlin Rao | Renren inc.</span>
<span class="c"># * Email: rao.chenlin@gmail.com</span>
<span class="c"># * Last modified: 2013-11-26 22:02</span>
<span class="c"># * Filename: macd.py</span>
<span class="c"># * Description: </span>
<span class="c">#       MA=avg(close(20))</span>
<span class="c">#       MD=std(close(20))</span>
<span class="c">#       </span>
<span class="c">#       MB=MA(20)</span>
<span class="c">#       UP=MB + 2*MD</span>
<span class="c">#       DN=MB - 2*MD</span>
<span class="c"># * *****************************************************************************/</span>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="k">class</span> <span class="nc">BOLL</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;config.yml&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sleep_time</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;btcchina&#39;</span><span class="p">][</span><span class="s">&#39;trade_option&#39;</span><span class="p">][</span><span class="s">&#39;sleep_time&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;host&#39;</span><span class="p">],</span><span class="n">user</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;username&#39;</span><span class="p">],</span><span class="n">passwd</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;password&#39;</span><span class="p">],</span><span class="n">db</span> <span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;databasename&#39;</span><span class="p">],</span><span class="n">charset</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;encoding&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_getMA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
    <span class="k">def</span> <span class="nf">_getMD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
        <span class="n">average</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">array</span><span class="p">:</span> <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">average</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="n">length</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">def</span> <span class="nf">getOHLC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;select time,open,high,low,close,vol from ohlc order by id desc limit </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span> <span class="n">results</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">_getCur</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fromtime</span><span class="p">):</span>
        <span class="n">curread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursql</span> <span class="o">=</span> <span class="s">&quot;select last,vol from ticker where time between date_add(&#39;</span><span class="si">%s</span><span class="s">&#39;, interval -0 minute) and now()&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%F</span><span class="s"> %T&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">fromtime</span><span class="p">))</span>
        <span class="n">curread</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cursql</span><span class="p">)</span>
        <span class="n">curlist</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curread</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="n">vollist</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">curread</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="n">curlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="p">(</span><span class="n">curlist</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">curlist</span><span class="p">),</span> <span class="n">curlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vollist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">_getClose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="n">close</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">matrix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">close</span>
    <span class="k">def</span> <span class="nf">getBOLL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOHLC</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCur</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
        <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getClose</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="n">up</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">days</span>
        <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
            <span class="n">curmb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMA</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">days</span><span class="p">:</span><span class="n">x</span><span class="p">])</span>
            <span class="n">curmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMD</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">days</span><span class="p">:</span><span class="n">x</span><span class="p">])</span>
            <span class="n">mb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">matrix</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">curmb</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">up</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">matrix</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">curmb</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">curmd</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">dn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">matrix</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">curmb</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">curmd</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">matrix</span><span class="p">[</span><span class="n">days</span><span class="p">:],</span> <span class="n">up</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">dn</span>
</code></pre></div>
<p>最后是 KDJ ：</p>
<div class="highlight"><pre><code class="python"><span class="c">#/*******************************************************************************</span>
<span class="c"># * Author: Chenlin Rao | Renren inc.</span>
<span class="c"># * Email: rao.chenlin@gmail.com</span>
<span class="c"># * Last modified: 2013-11-26 22:02</span>
<span class="c"># * Filename: macd.py</span>
<span class="c"># * Description: </span>
<span class="c">#       RSV=(close-low(9))/(high(9)-low(9))*100</span>
<span class="c">#       K=SMA(RSV(3), 1)</span>
<span class="c">#       D=SMA(K(3), 1)</span>
<span class="c">#       J=3*K-2*D</span>
<span class="c"># * *****************************************************************************/</span>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="k">class</span> <span class="nc">KDJ</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;config.yml&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sleep_time</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;btcchina&#39;</span><span class="p">][</span><span class="s">&#39;trade_option&#39;</span><span class="p">][</span><span class="s">&#39;sleep_time&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;host&#39;</span><span class="p">],</span><span class="n">user</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;username&#39;</span><span class="p">],</span><span class="n">passwd</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;password&#39;</span><span class="p">],</span><span class="n">db</span> <span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;databasename&#39;</span><span class="p">],</span><span class="n">charset</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;database&#39;</span><span class="p">][</span><span class="s">&#39;encoding&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_getHLC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;select high,low,close,time from ohlc order by id desc limit </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">num</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_avg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
    <span class="k">def</span> <span class="nf">_getMA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
        <span class="n">array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">window</span>
        <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="n">curmb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">window</span><span class="p">:</span><span class="n">x</span><span class="p">])</span>
            <span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">curmb</span> <span class="p">)</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">array</span>
    <span class="k">def</span> <span class="nf">_getRSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrays</span><span class="p">):</span>
        <span class="n">rsv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">):</span>
            <span class="n">high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arrays</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">9</span><span class="p">:</span><span class="n">x</span><span class="p">]))</span>
            <span class="n">low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">arrays</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">9</span><span class="p">:</span><span class="n">x</span><span class="p">]))</span>
            <span class="n">close</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">rsv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">close</span><span class="o">-</span><span class="n">low</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">high</span><span class="o">-</span><span class="n">low</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">times</span><span class="p">,</span> <span class="n">rsv</span>
    <span class="k">def</span> <span class="nf">getKDJ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="n">hlc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getHLC</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">rsv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getRSV</span><span class="p">(</span><span class="n">hlc</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMA</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMA</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">3</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">d</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">k</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">d</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">j</span><span class="p">)</span>
</code></pre></div>
<p>最后通过一个简单的python web框架完成界面展示，这个叫 bottle.py 的框架是个单文件，相当方便。</p>
<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">macd</span> <span class="kn">import</span> <span class="n">MACD</span>
<span class="kn">from</span> <span class="nn">boll</span> <span class="kn">import</span> <span class="n">BOLL</span>
<span class="kn">from</span> <span class="nn">kdj</span> <span class="kn">import</span> <span class="n">KDJ</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">static_file</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">template</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;config.yml&#39;</span><span class="p">))</span>
<span class="n">color</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;cn&#39;</span><span class="p">:{</span><span class="s">&#39;up&#39;</span><span class="p">:</span><span class="s">&#39;#ff0000&#39;</span><span class="p">,</span><span class="s">&#39;dn&#39;</span><span class="p">:</span><span class="s">&#39;#00ff00&#39;</span><span class="p">},</span>
    <span class="s">&#39;us&#39;</span><span class="p">:{</span><span class="s">&#39;dn&#39;</span><span class="p">:</span><span class="s">&#39;#ff0000&#39;</span><span class="p">,</span><span class="s">&#39;up&#39;</span><span class="p">:</span><span class="s">&#39;#00ff00&#39;</span><span class="p">},</span>
<span class="p">}</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/mkb/240&#39;</span><span class="p">)</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">&#39;/mkb/&lt;ago:int&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mkb</span><span class="p">(</span><span class="n">ago</span><span class="p">):</span>
    <span class="n">like</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;webui&#39;</span><span class="p">][</span><span class="s">&#39;color&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s">&#39;webui&#39;</span><span class="p">,</span> <span class="n">ago</span> <span class="o">=</span> <span class="n">ago</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="n">like</span><span class="p">])</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">&#39;/js/&lt;filename&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">js</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">static_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s">&#39;./js/&#39;</span><span class="p">)</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">&#39;/boll&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">boll</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">&quot;boll&quot;</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">&#39;/macd/&lt;day:int&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">macd</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">MACD</span><span class="p">()</span>
    <span class="n">dif</span><span class="p">,</span> <span class="n">dea</span><span class="p">,</span> <span class="n">bar</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">getMACD</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;dif&#39;</span><span class="p">:</span><span class="n">dif</span><span class="p">,</span> <span class="s">&#39;dea&#39;</span><span class="p">:</span><span class="n">dea</span><span class="p">,</span> <span class="s">&#39;bar&#39;</span><span class="p">:</span><span class="n">bar</span><span class="p">})</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">&#39;/boll/&lt;day:int&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">boll</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">BOLL</span><span class="p">()</span>
    <span class="n">ohlc</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">dn</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">getBOLL</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;ohlc&#39;</span><span class="p">:</span><span class="n">ohlc</span><span class="p">,</span> <span class="s">&#39;up&#39;</span><span class="p">:</span><span class="n">up</span><span class="p">,</span> <span class="s">&#39;md&#39;</span><span class="p">:</span><span class="n">md</span><span class="p">,</span> <span class="s">&#39;dn&#39;</span><span class="p">:</span><span class="n">dn</span><span class="p">})</span>
<span class="nd">@route</span><span class="p">(</span><span class="s">&#39;/kdj/&lt;day:int&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">kdj</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
    <span class="n">kdj</span> <span class="o">=</span> <span class="n">KDJ</span><span class="p">()</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">kdj</span><span class="o">.</span><span class="n">getKDJ</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;k&#39;</span><span class="p">:</span><span class="n">k</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span> <span class="s">&#39;j&#39;</span><span class="p">:</span><span class="n">j</span><span class="p">})</span>
<span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div>
<p>唯一的一个 html 就是具体用 highcharts 画图的地方，如下：</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
   <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;refresh&quot;</span> <span class="na">content=</span><span class="s">&quot;60&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
   <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;/js/highstock.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
   <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;/js/highcharts.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
   <span class="nt">&lt;script&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">Highcharts</span><span class="p">.</span><span class="nx">setOptions</span><span class="p">({</span>  
            <span class="nx">global</span><span class="o">:</span> <span class="p">{</span>  
                <span class="nx">useUTC</span><span class="o">:</span> <span class="kc">false</span>  
            <span class="p">}</span>  
        <span class="p">});</span> 
        <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;/boll/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bolldata</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ohlc</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="nx">volume</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="nx">dataLength</span> <span class="o">=</span> <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dataLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">ohlc</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span>
                <span class="p">]);</span>
                <span class="nx">volume</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;ohlc&#39;</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span>
                <span class="p">])</span>
            <span class="p">};</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;/kdj/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">kdjdata</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;/macd/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">macddata</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#container&#39;</span><span class="p">).</span><span class="nx">highcharts</span><span class="p">(</span><span class="s1">&#39;StockChart&#39;</span><span class="p">,</span> <span class="p">{</span>
                        <span class="nx">rangeSelector</span><span class="o">:</span> <span class="p">{</span>
                            <span class="nx">enabled</span><span class="o">:</span> <span class="mi">0</span>
                        <span class="p">},</span>
                        <span class="nx">chart</span><span class="o">:</span> <span class="p">{</span>
                            <span class="nx">backgroundColor</span><span class="o">:</span> <span class="s1">&#39;#333333&#39;</span><span class="p">,</span>
                        <span class="p">},</span>
                	    <span class="nx">tooltip</span><span class="o">:</span> <span class="p">{</span>
                	    	<span class="nx">formatter</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                				<span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="s1">&#39;&lt;b&gt;&#39;</span><span class="o">+</span> <span class="nx">Highcharts</span><span class="p">.</span><span class="nx">dateFormat</span><span class="p">(</span><span class="s1">&#39;%A, %b %e, %H:%M&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;&lt;/b&gt;&#39;</span><span class="p">;</span>
                				<span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">points</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">point</span><span class="p">)</span> <span class="p">{</span>
                					<span class="nx">s</span> <span class="o">+=</span> <span class="s1">&#39;&lt;br/&gt;&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">series</span><span class="p">.</span><span class="nx">name</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="o">+</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">point</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
                				<span class="p">});</span>
                				<span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
                			<span class="p">}</span>
                	    <span class="p">},</span>
                        <span class="nx">plotOptions</span><span class="o">:</span> <span class="p">{</span>
                            <span class="nx">series</span><span class="o">:</span> <span class="p">{</span>
                                <span class="nx">marker</span><span class="o">:</span> <span class="p">{</span>
                                    <span class="nx">enabled</span><span class="o">:</span> <span class="kc">false</span>
                                <span class="p">},</span>
                                <span class="nx">lineWidth</span><span class="o">:</span> <span class="mf">1.1</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">},</span>
                        <span class="nx">yAxis</span><span class="o">:</span> <span class="p">[{</span>
                          <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
                              <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;MACD(12,26,9)&#39;</span>
                          <span class="p">},</span>
                          <span class="nx">height</span><span class="o">:</span> <span class="mi">200</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                          <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
                              <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;KDJ(9,3,3)&#39;</span>
                          <span class="p">},</span>
                          <span class="nx">top</span><span class="o">:</span> <span class="mi">250</span><span class="p">,</span>
                          <span class="nx">height</span><span class="o">:</span> <span class="mi">150</span><span class="p">,</span>
                          <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="nx">gridLineDashStyle</span><span class="o">:</span> <span class="s1">&#39;Dash&#39;</span><span class="p">,</span>
                          <span class="nx">tickPositions</span><span class="o">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
                                <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;BOLL(20)&#39;</span>
                            <span class="p">},</span>
                            <span class="nx">top</span><span class="o">:</span> <span class="mi">450</span><span class="p">,</span>
                            <span class="nx">height</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
                            <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
                                <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;VOL&#39;</span>
                            <span class="p">},</span>
                            <span class="nx">top</span><span class="o">:</span> <span class="mi">800</span><span class="p">,</span>
                            <span class="nx">height</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
                            <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">}],</span>
                        <span class="nx">series</span><span class="o">:</span> <span class="p">[{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;BAR&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="nx">negativeColor</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="nx">borderColor</span><span class="o">:</span> <span class="s1">&#39;#333333&#39;</span><span class="p">,</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;column&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">macddata</span><span class="p">[</span><span class="s1">&#39;bar&#39;</span><span class="p">],</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;DIFF&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">,</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">macddata</span><span class="p">[</span><span class="s1">&#39;dif&#39;</span><span class="p">],</span>
                            <span class="nx">lineWidth</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;DEA&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#ffff00&#39;</span><span class="p">,</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">macddata</span><span class="p">[</span><span class="s1">&#39;dea&#39;</span><span class="p">],</span>
                            <span class="nx">lineWidth</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">,</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">kdjdata</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#ffff00&#39;</span><span class="p">,</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">kdjdata</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">],</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#cc99cc&#39;</span><span class="p">,</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">kdjdata</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">],</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;candlestick&#39;</span><span class="p">,</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;ohlc&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">ohlc</span><span class="p">,</span>
                            <span class="nx">upColor</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="nx">upLineColor</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="nx">lineColor</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;spline&#39;</span><span class="p">,</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;up&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">],</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#ffff00&#39;</span><span class="p">,</span>
                            <span class="nx">lineWidth</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;spline&#39;</span><span class="p">,</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;md&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;md&#39;</span><span class="p">],</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">,</span>
                            <span class="nx">lineWidth</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;spline&#39;</span><span class="p">,</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;dn&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">bolldata</span><span class="p">[</span><span class="s1">&#39;dn&#39;</span><span class="p">],</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#cc99cc&#39;</span><span class="p">,</span>
                            <span class="nx">lineWidth</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;VOL&#39;</span><span class="p">,</span>
                            <span class="nx">borderColor</span><span class="o">:</span> <span class="s1">&#39;#333333&#39;</span><span class="p">,</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;column&#39;</span><span class="p">,</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">volume</span><span class="p">,</span>
                            <span class="nx">yAxis</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="p">}]</span>
                    <span class="p">});</span>
                <span class="p">});</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span> 
   <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
   <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;container&quot;</span> <span class="na">style=</span><span class="s">&quot;min-width:800px;height:1000px;&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>highcharts 有个问题，就是不能跟 amcharts 或者 echarts 那样提供一个画笔工具，让用户自己在生成的图形上再涂抹线条，这个功能其实在蜡烛图上判断压力位支撑位的时候很有用。不过蜡烛图 btc123 也提供了，我也就懒得再用 amcharts 重写一遍。</p>
<p>效果如下：</p>
<p><img src="/images/uploads//btc.png" alt="" /></p>
      <a href="/2013/12/09/draw-charts-of-bitcoin" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/12/09/add-mailinglist-command-to-gitolite" title="为 gitolite 实现 mailinglist 命令行操控" rel="bookmark">为 gitolite 实现 mailinglist 命令行操控</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-12-09 00:00:00 +0800">09 Dec 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <div>&lt;embed src='http://www.docin.com/DocinViewer-737880351-144.swf' width='100%' height='600' type=application/x-shockwave-flash ALLOWFULLSCREEN='true' ALLOWSCRIPTACCESS='always'&gt;</div>
<p>或者上微盘下载
<a href="http://vdisk.weibo.com/s/CW3E1ZROXE9g">http://vdisk.weibo.com/s/CW3E1ZROXE9g</a></p>
      <a href="/2013/12/09/add-mailinglist-command-to-gitolite" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/11/04/puppet-class-parameter" title="Puppet 的类参数传递" rel="bookmark">Puppet 的类参数传递</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-11-04 00:00:00 +0800">04 Nov 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#puppet-ref" title="puppet" rel="category tag">puppet</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前使用 ENC 管理 puppet，尽量保持了输出 yaml 内容的简单，只提供了一个统一的全局参数定义 node 的 role。(题外话，puppetlabs 推荐了另一个通过继承关系实现 role 的示例，见：<a href="http://www.craigdunn.org/2012/05/239/">Designing Puppet - Roles and Profiles</a>。)</p>
<p>但是 puppet 中有些配置确实修改比较频繁，文件操作不得不说是一件不甚方便的事情，于是重新考虑通过类参数的方式来灵活化某些配置的操作。</p>
<h1 id="section">修改前</h1>
<h3 id="nginxmanifestsinitpp">nginx/manifests/init.pp</h3>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="n">nginx</span> <span class="p">{</span>
    <span class="kp">include</span> <span class="s2">&quot;nginx::${::role}&quot;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="nginxmanifestsloadbalancerpp">nginx/manifests/loadbalancer.pp</h3>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="ss">nginx</span><span class="p">:</span><span class="ss">:loadbalancer</span> <span class="p">{</span>
    <span class="vg">$iplist</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;192.168.0.2:80&#39;</span><span class="o">]</span>
    <span class="n">file</span> <span class="p">{</span> <span class="s1">&#39;nginx.conf&#39;</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;nginx/nginx.conf.erb&#39;</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="enc-nginxhostname">enc nginxhostname</h3>
<div class="highlight"><pre><code class="yaml"><span class="nn">---</span>
<span class="l-Scalar-Plain">classes</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">nginx</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">base</span>
<span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">production</span>
<span class="l-Scalar-Plain">parameters</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">loadbalancer</span>
</code></pre></div>
<h1 id="section-1">修改后</h1>
<h3 id="nginxmanifestsinitpp-1">nginx/manifests/init.pp</h3>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="n">nginx</span> <span class="p">(</span><span class="vg">$iplist</span> <span class="o">=</span> <span class="o">[]</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">class</span> <span class="p">{</span> <span class="s2">&quot;nginx::${::role}&quot;</span><span class="p">:</span>
        <span class="n">iplist</span> <span class="o">=&gt;</span> <span class="vg">$iplist</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="nginxmanifestsloadbalancerpp-1">nginx/manifests/loadbalancer.pp</h3>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="ss">nginx</span><span class="p">:</span><span class="ss">:loadbalancer</span> <span class="p">(</span><span class="vg">$iplist</span> <span class="o">=</span> <span class="o">[]</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">file</span> <span class="p">{</span> <span class="s1">&#39;nginx.conf&#39;</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;nginx/nginx.conf.erb&#39;</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="enc-nginxhostname-1">enc nginxhostname</h3>
<div class="highlight"><pre><code class="yaml"><span class="nn">---</span>
<span class="l-Scalar-Plain">classes</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">nginx</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">iplist</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">192.168.0.2:80</span>
  <span class="l-Scalar-Plain">base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~</span>
<span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">production</span>
<span class="l-Scalar-Plain">parameters</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">loadbalancer</span>
</code></pre></div>
<h1 id="section-2">要点</h1>
<ol>
  <li>虽然真正需要 $iplist 的是下面的一个子类，但是 ENC 传值是给的父类，所以需要一层层传递下去；</li>
  <li>ENC 中给类传参，类就要写成哈希形式，否则是数组形式；</li>
  <li>有参数的类，在调用的时候无法使用 <code>include</code> 形式的写法，只能用资源调用形式的写法。</li>
</ol>
<p>修改中出现了一个很搞笑的错误，因为是在 vim 里批量转换，结果子类名字后面多了一个空格，成了<code>class { "nginx::${::role} ":</code>这样。结果 puppet 一直返回报错说 &ldquo;Invalid Parameter&rdquo;。这时候一个习惯性的思维造成了误会：我们一般会认为<code>:</code>后面的那一行行键值对才是 parameter，但其实这里子类名也是 <code>class</code> 这个资源调用的 parameter。当然，如果可以在这里报一个 <code>Class Not Found</code> 就更好了。</p>
      <a href="/2013/11/04/puppet-class-parameter" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/11/04/perl-unpack-tongdaxin" title="用 Perl 读取通达信日线数据" rel="bookmark">用 Perl 读取通达信日线数据</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-11-04 00:00:00 +0800">04 Nov 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>之前看 skyline 的报警机制的时候，为了寻找测试数据，曾经想到是不是可以用股价走势。其实股价走势分析也是一个很深的编程领域，有些选股软件一份就好几千的卖。当然我这里没兴趣和时间搞那么复杂了。简单的说一下如何从通达信的存档里读取日线数据，说到底还是 <code>pack/unpack</code> 的运用：</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!perl</span>
<span class="nb">open</span> <span class="k">my</span> <span class="nv">$fh</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&#39;C:\new_sxzq_v6\vipdoc\sh\lday\sh000001.day&#39;</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span> <span class="nb">sysread</span> <span class="nv">$fh</span><span class="p">,</span> <span class="k">my</span> <span class="nv">$buf</span><span class="p">,</span> <span class="mi">32</span> <span class="p">)</span> <span class="p">{</span>
<span class="c1"># 日期，开盘，最高，最低，收盘，成交金额，成交量，预留位</span>
    <span class="k">my</span> <span class="p">(</span> <span class="nv">$date</span><span class="p">,</span> <span class="nv">$open</span><span class="p">,</span> <span class="nv">$high</span><span class="p">,</span> <span class="nv">$low</span><span class="p">,</span> <span class="nv">$close</span><span class="p">,</span> <span class="nv">$amount</span><span class="p">,</span> <span class="nv">$vol</span><span class="p">,</span> <span class="nv">$reserved</span> <span class="p">)</span> <span class="o">=</span>
      <span class="nb">unpack</span><span class="p">(</span> <span class="s">&#39;Ii4fi2&#39;</span><span class="p">,</span> <span class="nv">$buf</span> <span class="p">);</span>
    <span class="nb">printf</span> <span class="s">&quot;%s %.2f %.2f %.2f %.2f %d %d\n&quot;</span><span class="p">,</span> <span class="nv">$date</span><span class="p">,</span> <span class="nv">$open</span> <span class="sr">/ 100, $high /</span> <span class="mi">100</span><span class="p">,</span>
      <span class="nv">$low</span> <span class="sr">/ 100, $close /</span> <span class="mi">100</span><span class="p">,</span> <span class="nv">$amount</span><span class="p">,</span> <span class="nv">$vol</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>注意这里一定要一边 <code>sysread</code> 一边 <code>while</code>，否则一只股票的历史(上例中是上证指数)都没读完就会内存溢出的。</p>
      <a href="/2013/11/04/perl-unpack-tongdaxin" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/10/26/selinux-affect-to-apache-documentroot" title="selinux 对 webserver 文件发布的影响" rel="bookmark">selinux 对 webserver 文件发布的影响</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-10-26 00:00:00 +0800">26 Oct 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#linux-ref" title="linux" rel="category tag">linux</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>SELinux 在国内是一个很少有人用的东西，一般来说，服务器上手第一件事情就是把 SELinux 关掉，以至于有问题的时候排查思路里都压根没检查 SELinux 这步。</p>
<p>昨天在个人电脑的 Fedora 上搭建一个 webserver 发布几个文件，本来想着简单任务越快越好，几行命令完成：</p>
<div class="highlight"><pre><code class="bash">sudo yum install httpd
sudo mv ~/src /var/www/html/
sudo service httpd start
</code></pre></div>
<p>结果居然一直返回 <code>403 Denied</code>！</p>
<p>看 httpd 的 error.log ，一直报这么一行错误：</p>
<pre><code>[core:error] [pid 3806] (13)Permission denied: [client 127.0.0.1:59180] AH00035: access to /src/master.zip denied (filesystem path '/var/www/html/src') because search permissions are missing on a component of the path
</code></pre>
<p>很奇怪吧，于是我先去确认了 httpd.conf 里关于 <code>&lt;Directory "/var/www/html"&gt;</code> 的配置(因为 Fedora19 的 httpd 版本是 2.4.6，我以为新版本有变化了)，然后去确认了 <code>/var/www/html/src</code> 的权限是不是 755，其他用户可读的。都没问题！</p>
<p>最后还是在 apache 的 httpd 官方文档上找到了关于这个错误码的详细解释，原来还有一种可能性，就是 SELinux 的安全控制！这个可以通过下面这个命令看到：</p>
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>ls -lZ /var/www /var/www/html
/var/www:
drwxr-xr-x. root   root   system_u:object_r:httpd_sys_script_exec_t:s0 cgi-bin
drwxr-xr-x. apache apache system_u:object_r:httpd_sys_content_t:s0 html
/var/www/html:
drwxr-xr-x. chenlin.rao chenlin.rao unconfined_u:object_r:user_home_t:s0 src
</code></pre></div>
<p>看到没有，这里这些文件的 SELinux 类型是不一样的，默认的 <code>/var/www/html</code> 是 <code>httpd_sys_content_t</code>，<code>/var/www/cgi-bin</code> 是 <code>httpd_sys_script_exec_t</code>，而从我家目录移过去的 <code>/var/www/html/src</code> 是 <code>user_home_t</code>！</p>
<p>解决办法也很简单，把这个类型也改过来就好了：</p>
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>chcon -R -t httpd_sys_content_t /var/www/html/src
</code></pre></div>
<p>这是第一次接触 SELinux 的安全管理，真的是好细致！</p>
      <a href="/2013/10/26/selinux-affect-to-apache-documentroot" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/10/25/intro-plenv" title="用 plenv 代替 perlbrew 管理 Perl5" rel="bookmark">用 plenv 代替 perlbrew 管理 Perl5</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-10-25 00:00:00 +0800">25 Oct 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>我们都知道有 virtualenv 啊，rvm 啊之类的工具来管理 python，ruby的多版本问题，后来台湾的朋友也引入到了 Perl 世界，这就是 perlbrew。</p>
<p>不过 perlbrew 在使用的时候，有个非常让我不理解的地方，就是切换 Perl 版本后，整个终端的环境变量都被清空了。后来发现了一个新项目，叫 plenv，没错，一眼就可以看出来这是 rlenv 工具的 Perl 版。</p>
<p>和 perlbrew 不一样，目前版本的 plenv 已经是一个纯粹的 shell 工具。说起来原先一直是 shell 工具的 rvm，这周却在募捐准备改用 Ruby 重写了(据说是因为已经 2 万行的 bash 代码，作者快控制不住了)。</p>
<p>用法非常简单：</p>
<div class="highlight"><pre><code class="bash">git clone git://github.com/tokuhirom/plenv.git ~/.plenv
<span class="nb">echo</span> <span class="s1">&#39;export PATH=&quot;$HOME/.plenv/bin:$PATH&quot;&#39;</span> &gt;&gt; ~/.bash_profile
<span class="nb">echo</span> <span class="s1">&#39;eval &quot;$(plenv init -)&quot;&#39;</span> &gt;&gt; ~/.bash_profile
<span class="nb">exec</span> <span class="nv">$SHELL</span> -l <span class="c"># 这步相当于退出重登录终端</span>
git clone git://github.com/tokuhirom/Perl-Build.git ~/.plenv/plugins/perl-build/
plenv install 5.18.0
plenv rehash <span class="c"># 每次在 $HOME/.plenv/bin 下安装了新的命令后都要执行一次这个</span>
plenv install-cpanm
plenv rehash
plenv shell 5.18.0 <span class="c"># 还有 global 和 local 两者可设</span>
</code></pre></div>
<p>目前我已经用 plenv 管理自己电脑上的 Perl5 了，你们呢？</p>
      <a href="/2013/10/25/intro-plenv" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/10/16/perl-overload" title="Perl 的 overload 妙用" rel="bookmark">Perl 的 overload 妙用</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-10-16 00:00:00 +0800">16 Oct 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>在使用 Mojolicious 的时候，通常我们会发现一个很有趣的现象。</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">ojo</span><span class="p">;</span>
<span class="n">say</span> <span class="n">g</span><span class="p">(</span><span class="s">&#39;http://www.baidu.com&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dom</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="s">&#39;script&#39;</span><span class="p">);</span>
<span class="n">say</span> <span class="n">g</span><span class="p">(</span><span class="s">&#39;http://www.baidu.com&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dom</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="s">&#39;script&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">;</span>
</code></pre></div>
<p>这里可以看到，在用 <code>at()</code> 方法之后得到的结果，如果从上一行解读，似乎应该是一个字符串；但是从下一行解读，又还是一个对象，可以继续调用 <code>-&gt;text</code> 属性。</p>
<p>Perl 本身不是一个纯对象式的语言，字符串本身是没有对象属性的。而直接打印对象的话，应该输出的是类似 <code>Mojo::DOM-&gt;HASH(0x1234567)</code> 的效果。那这个效果是怎么实现的呢？</p>
<p>翻了 Mojo 的代码之后，发现原来 Mojo 里是把字符串、数组等都实现成了对象，分别是 <code>Mojo::ByteStream</code> 和 <code>Mojo::Collection</code> 两个类。然后再实现中，运用了 <code>overload</code> 来实现这个效果。代码很简单，<code>Mojo::ByteStream</code> 里是这样的：</p>
<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">overload</span> <span class="s">&#39;&quot;&quot;&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="nb">shift</span><span class="o">-&gt;</span><span class="n">to_string</span> <span class="p">},</span> <span class="n">fallback</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">to_string</span> <span class="p">{</span> <span class="nv">$</span><span class="p">{</span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span> <span class="p">}</span>
</code></pre></div>
<p>此外， <code>Mojo::DOM</code>，<code>Mojo::URL</code>，<code>Mojo::JSON</code> 等十多个类中都用了这个方法。</p>
<p>看起来似乎还不是很明了，再贴两段 <a href="http://perldoc.perl.org/overload.html">overload 的 POD</a> 就清楚了：</p>
<pre><code>It also defines an anonymous subroutine to implement stringification: this is called whenever an object blessed into the package Number is used in a string context...
For example, the subroutine for '""' (stringify) may be used where the overloaded object is passed as an argument to print,...
</code></pre>
<p>这下清楚了吧。一旦在某个类里 <code>overload</code> 了双引号，那么这个类的对象在标量环境下调用的时候就会先调用这个函数。最典型的例子就是用在 <code>print</code> 的时候。</p>
<p>下面我们可以自己也试试：</p>
<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="n">Test</span> <span class="mf">0.01</span> <span class="p">{</span>
    <span class="k">use</span> <span class="n">overload</span> <span class="s">&#39;&quot;&quot;&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span> <span class="nb">join</span> <span class="s">&quot; overloaded.\n&quot;</span><span class="p">,</span> <span class="nv">@</span><span class="p">{</span><span class="o">+</span><span class="nb">shift</span><span class="p">}</span> <span class="p">};</span>
    <span class="k">sub </span><span class="nf">new</span> <span class="p">{</span> <span class="nb">bless</span> <span class="p">[</span><span class="nv">@_</span><span class="p">[</span><span class="mi">1</span> <span class="o">..</span> <span class="nv">$#_</span><span class="p">]],</span> <span class="nb">shift</span> <span class="p">};</span>
<span class="p">}</span>
<span class="k">my</span> <span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Test</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">print</span> <span class="nv">$obj</span><span class="p">;</span>
</code></pre></div>
<p>输出结果：</p>
<pre><code>1 overloaded.
3 overloaded.
2
</code></pre>
      <a href="/2013/10/16/perl-overload" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/10/09/using-elasticsearch-and-logstash-to-serve-billions-of-searchable-events-for-customers" title="【翻译】用 elasticsearch 和 logstash 为数十亿次客户搜索提供服务" rel="bookmark">【翻译】用 elasticsearch 和 logstash 为数十亿次客户搜索提供服务</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-10-09 00:00:00 +0800">09 Oct 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#logstash-ref" title="logstash" rel="category tag">logstash</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>原文地址：<a href="http://www.elasticsearch.org/blog/using-elasticsearch-and-logstash-to-serve-billions-of-searchable-events-for-customers/">http://www.elasticsearch.org/blog/using-elasticsearch-and-logstash-to-serve-billions-of-searchable-events-for-customers/</a></p>
<hr />
<p><em>今天非常高兴的欢迎我们的第一个外来博主，Rackspace软件开发工程师，目前为Mailgun工作的 <a href="https://twitter.com/ralphm">Ralph Meijer</a>。我们在 <a href="http://monitorama.eu/">Monitorama EU</a> 会面后，Ralph 提出可以给我们写一篇 Mailgun 里如何使用 Elasticsearch 的文章。他本人也早就活跃在 Elasticsearch 社区，经常参加我们在荷兰的聚会了。</em></p>
<p><img src="http://www.elasticsearch.org/content/uploads/2013/09/mailgun_150-300x85.png" alt="" /></p>
<p><a href="http://www.mailgun.com/">Mailgun</a> 收发大量电子邮件，我们跟踪和存储每封邮件发生的每个事件。每个月会新增数十亿事件，我们都要展示给我们的客户，方便他们很容易的分析数据，也就是全文搜索。下文是我们利用Elasticsearch和Logstash技术完成这个需求的技术细节（很高兴刚写完这篇文章就听说《<a href="http://elasticsearch.com/blog/welcome-jordan-logstash/">Logstash加入Elasticsearch</a>》了）。</p>
<h1 id="section">事件</h1>
<p>在 Mailgun 里，event可能是如下几种：进来一条信息，可能被接收可能被拒绝；出去一条信息，可能被投递可能被拒绝(垃圾信息或者反弹)；信息是直接打开还是通过链接点击打开；收件人要求退订。所有这些事件，都有一些元信息可以帮助我们客户找出他们的信息什么时候，为什么，发生了什么。这个元信息包括：信息的发送者，收件人地址，信息id，SMTP错误码，链接URL，geo地理位置等等。</p>
<p>每个事件都是由一个时间戳和一系列字段构成的。一个典型的事件就是一个关联数组，或者叫字典、哈希表。</p>
<h1 id="section-1">事件访问设计</h1>
<p>假设我们已经有了各种事件，现在需要一个办法来给客户使用。在Mailgun的控制面板里，有一个日志标签，可以以时间倒序展示事件日志，并且还可以通过域名和级别来过滤日志，示例如下：</p>
<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/mailgun_log_sample.png" alt="" /></p>
<p>在这个示例里，这个事件的级别是&rdquo;warn&rdquo;，因为SMTP错误码说明这是一个临时性问题，我们稍后会重试投递。这里有两个字段，一个时间戳，一个还没格式化的非结构化文本信息。为了醒目，这里我们会根据级别的不同给事件上不同的底色。</p>
<p>在这个网页之后，我还有一个接收日志的API，一个设置触发报警的hook页面。后面的报警完全是结构化了的带有很多元数据字段的JSON文档。比如，SMTP错误码有自己的字段，收件人地址和邮件标题等也都有。</p>
<p>不幸的是，原有的日志API非常有限。他只能返回邮件投递时间和控制面板里展示的非结构化的文本内容。没办法获取或者搜索多个字段(像报警页面里那样)，更不要说全文搜索了。简单说，就是控制面板缺乏全文搜索。</p>
<h1 id="elasticsearch">用elasticsearch存储和响应请求</h1>
<p>要给控制面板提供API和访问，我们需要一个新的后端来弥补前面提到的短板，包括下面几个新需求：</p>
<ul>
  <li>允许大多数属性的过滤。</li>
  <li>允许全文搜索。</li>
  <li>支持存储至少30天数据，可以有限度的轮滚。</li>
  <li>添加节点即可轻松扩展。</li>
  <li>节点失效无影响。</li>
</ul>
<p>而Elasticsearch，是一个可以“准”实时入库、实时请求的搜索引擎。它基于Apache Lucene，由存储索引的节点组成一个分布式高可用的集群。单个节点离线，集群会自动把索引(的分片)均衡到剩余节点上。你可以配置具体每个索引有多少分片，以及这些分片该有多少副本。如果一个主分片离线，就从副本中选一个出来提升为主分片。</p>
<p>Elasticsearch 是面向文档的，某种层度上可以说也是无模式的。这意味着你可以传递任意JSON文档然后就可以索引成字段。对我们的事件来说完全符合要求。</p>
<p>Elasticsearch 同样还有一个非常强大的请求/过滤接口，可以对特定字段搜索，也可以做全文搜索。</p>
<h1 id="elasticsearch-1">事件存入elasticsearch</h1>
<p>有很多工具或者服务可以用来记录事件。我们最终选择了 <a href="http://logstash.net/">Logstash</a>，一个搜集、分析、管理和传输日志的工具。</p>
<p>在内部，通过webhooks推送来的event同时在我们系统的其他部分也有使用，目前我们是用Redis来完成这个功能。Logstash有一个Redis输入插件来从Redis列表里接收日志事件。通过几个小过滤器后，事件通过一个输出插件输出。最常用的输出插件就是 Elasticsearch 插件。</p>
<p>利用 Elasticsearch 丰富的 API 最好的办法就是使用 Kibana，这个工具的口号是“让海量日志有意义”。目前最新的 <a href="http://three.kibana.org/">Kibana 3</a> 是一个纯粹的 JavaScript 客户端版，随后也会成为 Logstash 的默认界面。和之前的版本不同的是，它不在依赖于一个类Logstash模式，而是可以用于任意Elasticsearch索引。</p>
<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/kibana%20events%202.png" alt="" /></p>
<h1 id="section-2">认证</h1>
<p>到这步，我们已经解决了事件集中的问题，也有了丰富的API来深入解析日志。但是我们不想把所有日志都公开给每个人，所以我们需要一个认证，目前Elasticsearch 和 Kibana 都没提供认证功能，所以寄希望于 Elasticsearch API 是不可能的了。</p>
<p>我们选择了构建双层代理。一层代理用来做认证和流量限速，一层用来转义我们的事件 API 成 Elasticsearch 请求。前面这层代理我们已经以 Apache 2.0 开原协议发布在Github上，叫 <a href="https://github.com/mailgun/vulcan">vulcan</a> 。我们还把我们原来的那套日志 API 也转移到了 Elasticsearch 系统上。</p>
<h1 id="section-3">索引设计</h1>
<p>有很多种方法来确定你如何组织自己的索引，基于文档的数目(每个时间段内)，以及查询模式。</p>
<p>Logstash 默认每天创建一个新索引，包括当天收到的全部时间。你可以通过配置修改这个时间，或者采用其他属性来区分索引，比如每个用户一个，或者用事件类型等等。</p>
<p>我们这里每秒有1500个时间，而且我们希望每个账户的轮转时间段都是可配置的。可选项有：</p>
<ul>
  <li>一个大索引。</li>
  <li>每天一个索引。</li>
  <li>每个用户账户一个索引。</li>
</ul>
<p>当然，如果需要的话，这些都可以在未来进一步切分，比如根据事件类型。</p>
<p>管理轮滚的一个办法是在 Elasticsearch 中给每个文档设定 <a href="http://www.elasticsearch.org/guide/reference/mapping/ttl-field/">TTLs</a> 。到了时间  Elasticsearch 就会批量删除过期文档。这种做法使得定制每个账户的轮转时间变得很简单，但是也带来了更多的 IO 操作。</p>
<p>另一个轻量级的办法是直接删除整个索引。这也是 Logstash 默认以天创建索引的原因。过了这天你直接通过 crontab 任务删除索引即可。</p>
<p>不过后面这个办法就没法定制轮转了。我们有很多用户账户，给每个用户每天保持一个索引是不切实际的。当然，给所有用户每天存一个索引又意味着我们要把所有数据都存磁盘上。如果一个账户是保持两天数据的轮转，那么在缓存中的数据就是有限的。在查询多天的垃圾邮件时，处理性能也就受限了。所以，我们需要保留更多的日志以供Kibana访问。</p>
<h1 id="section-4">映射</h1>
<p>为了定义文档(中的字段)如何压缩、索引和存储在索引里，Elasticsearch 有一个叫做 <a href="http://www.elasticsearch.org/guide/reference/mapping/">mapping</a> 的概念。所以为每个字段它都定义了类型，定义了如何分析和标记字段的值以便索引和查询，定义了值是否需要存储，以及其他各种设置。默认的情况，mapping是动态的，也就是说 Elasticsearch 会从它获得的第一个值来尝试猜测字段的类型，然后正式应用这个设置到索引。</p>
<p>如果你的数据来源单一，这样就很好了。但实际可能来源很复杂，或者日志类型根本就不一样，比如我们这，同一个名字的字段的数据类型可能都不一样。 Elasticsearch 会拒绝索引一个类型不匹配的文档，所以我们需要自定义 mapping 。</p>
<p>通过我们的 <a href="http://documentation.mailgun.com/api-events.html">Events API</a> ，我给日志事件的类型定义了一个映射。不是所有的事件都有所有这些字段，不过相同名字的字段肯定是一致的。</p>
<h1 id="section-5">分析器</h1>
<p>默认情况下，字段的 mapping 中就带有 标准分析器。简单的说，就是字符串会被转成小写，然后分割成一个一个单词。然后这些标记化的单词再写入银锁，并指向具体的字段。</p>
<p>有些情况，你可能想要些别的东西来完成不同的效果。比如说账户 ID，电子邮件地址或者网页链接 URL之类的，默认标记器会以斜线分割，而不考虑把整个域名作为一个单独的标记。当你通过 facet 统计域名字段的时候，你得到的会是域名中一段一段标签的细分结果。</p>
<p>要解决这个问题，可以设置索引属性，给对应字段设置成 <code>not_analyzed</code>。这样在插入索引的时候，这个字段不再经过映射或者标记器。比如对 <code>domain.name</code> 字段应用这个设置后，每个域名都会完整的作为同一个标签统计 facet 了。</p>
<p>如果你还想在这个字段内通过部分内容查找，你可以使用 <a href="http://www.elasticsearch.org/guide/reference/mapping/multi-field-type/">multi-field type</a>。这个类型可以映射相同的值到不同的核心类型或者属性，然后在不同名称下使用。我们对 IP 地址就使用了这个技术。默认的字段(比如叫<code>sending-ip</code>)的类型就是 ip，而另一个非默认字段(比如叫 <code>sending-ip.untouched</code>)则配置成 <code>not_analyzed</code> 而且类型为字符串。这样，默认字段可以做 IP 地址专有的范围查询，而 <code>.untouched</code> 字段则可以做 facet 查询。</p>
<p>除此以外，绝大多数字段我们都没用分析器和标记器。不过我们正在考虑未来可以结合上面的多字段类型技巧，应用 <a href="http://www.elasticsearch.org/guide/reference/index-modules/analysis/pattern-capture-tokenfilter/">pattern capture tokenfilter</a> 到某些字段(比如电子邮件地址)上。</p>
<h1 id="section-6">监控</h1>
<p>要知道你的集群怎么样，你就必须要监控它。 Elasticsearch 有非常棒的 API 来获取 <a href="http://www.elasticsearch.org/guide/reference/api/admin-cluster-state/">cluster state</a> 和 <a href="http://www.elasticsearch.org/guide/reference/api/admin-cluster-nodes-stats/">node statistics</a>。我们可以用 <a href="http://graphite.wikidot.com/">Graphite</a> 来存储这些指标并且做出综合表盘，下面就是其中一个面板：</p>
<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/graphite%20monitoring.png" alt="" /></p>
<p>为了收集这些数据并且传输到 Graphite，我创建了 <a href="http://github.com/mochi/vor">Vör</a>，已经在 <a href="http://www.mochimedia.com/">Mochi Media</a> 下用 MIT/X11 协议开源了。另外一个保证 Redis 列表大小的收集器也在开发中。</p>
<p>除此以外，我们还统计很多东西，比如邮件的收发、点击数，API调用和耗时等等，这些是通过 <a href="https://github.com/etsy/statsd">StatsD</a> 收集的，同样也添加到我们的 Graphite 表盘。</p>
<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/graphite%20events.png" alt="" /></p>
<p>这绝对是好办法来观察发生了什么。Graphite 有一系列函数可以用来在绘图前作处理，也可以直接返回JSON文档。比如，我们可以很容易的创建一个图片展示 API 请求的数量与服务器负载或者索引速度的联系。</p>
<h1 id="section-7">当前状况</h1>
<p>我们的一些数据：</p>
<ul>
  <li>每天大概4kw 到 6kw 个日志事件。</li>
  <li>30天轮转一次日志。</li>
  <li>30个索引。 </li>
  <li>每个索引5个分片。 </li>
  <li>每个分片一个1副本。 </li>
  <li>每个索引占 2 * 50 到 80 GB空间(因为有副本所以乘2)。</li>
</ul>
<p>为此，我们启动了一共 9 台 Rackspace 云主机，具体配置是这样的：</p>
<ul>
  <li>6x 30GB RAM, 8 vCPUs, 1TB disk: Elasticsearch 数据节点。</li>
  <li>2x 8GB RAM, 4 vCPUs: Elasticsearch 代理节点， Logstash， Graphite 和 StatsD。</li>
  <li>2x 4GB RAM, 2 core: Elasticsearch 代理节点， Vulcan 和 API 服务器</li>
</ul>
<p>大多数主机最终会迁移到专属的平台上，同时保留有扩展新云主机的能力。</p>
<p>Elasticsearch 数据节点都配置了 16GB 内存给 JVM heap。其余都是标准配置。此外还设置了 fieldcache 最大大小为 heap 的 40%，以保证集群不会在 facet 和 sort 内容很多的字段时挂掉。我们同时也增加了一点 <a href="http://www.elasticsearch.org/guide/reference/api/admin-cluster-update-settings/">cluster wide settings</a> 来加速数据恢复和重均衡。另外，相对于我们存储的文档数量来说，<code>indices.recovery.max_bytes_per_sec</code> 的默认设置实在太低了。</p>
<h1 id="section-8">总结</h1>
<p>我们非常高兴用 Elasticsearch 来保存我们的事件，也得到了试用新 API 和新控制面板中新日志页面的客户们非常积极的反馈。任意字段的可搜索对日志挖掘绝对是一种显著的改善，而 Elasticsearch 正提供了这种高效无痛的改进。当然，Logstash，Elasticsearch 和 Kibana 这整条工具链也非常适合内部应用日志处理。</p>
<p>如果你想了解更多详情或者对我们的 API 有什么疑问，尽管留言。也可以在 Mailgun 博客上<a href="http://blog.mailgun.com/post/new-events-api-detailed-email-tracking-and-search/">阅读更多关于事件 API 的细节</a>。</p>
<p>开心处理日志，开心发送邮件！</p>
      <a href="/2013/10/09/using-elasticsearch-and-logstash-to-serve-billions-of-searchable-events-for-customers" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/09/14/elasticsearch-for-rexify-website" title="用 ElasticSearch 支持 Rexify 网站的搜索功能" rel="bookmark">用 ElasticSearch 支持 Rexify 网站的搜索功能</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-09-14 00:00:00 +0800">14 Sep 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>最近给 Rexify 官网做<a href="http://rex.perl-china.com">中文化</a>工作，除了文字翻译之外，还要负责把服务正常跑起来。网站本身就是一个 <code>Mojolicious</code> 写的小东西，用 <code>morbo html/website.pl</code> 命令直接运行就可以监听在 3000 端口，然后通过 nginx 代理发布即可。</p>
<p>不过官网上还有一个高级功能需要另外支持，那就是搜索。</p>
<p>Rexify 官网的搜索功能是通过 ElasticSearch 提供的。这里需要注意一点，官方提供的 <code>create_index.pl</code> 中，并不是直接把文件内容本身存入 ES 索引的(之前介绍过的 <code>devopsweekly_index.pl</code> 脚本就是这样做的)，而是编码成 Base64 之后再以附件形式存储。</p>
<p>一开始我没注意到这点，结果搜索结果里一直只有标题和链接，没有高亮内容。后来发现是存的 base64 编码后又很疑惑 Rexify 官网是如何把 base64 再解码回来到网页上显示的。幸亏后来想到去 ElasticSearch 官网搜索一下 base64 关键词，然后发现了专门的<a href="https://github.com/elasticsearch/elasticsearch-mapper-attachments">介绍页面</a>。原来是有一个<a href="https://github.com/elasticsearch/elasticsearch-mapper-attachments">插件</a>实现的附件解析，调用了 Apache Tika 库，也就意味着支持 HTML/XML/Office/ODF/PDF/Epub/RTF/TXT/ZIP/MP3/JPG/FLV/Mbox/JAR 等等各种格式的文件。</p>
<p>所以，安装这个插件，然后重建索引，就可以正常提供搜索功能了：</p>
<pre><code>/usr/share/elasticsearch/bin/plugin -install elasticsearch/elasticsearch-mapper-attachments/1.9.0
rexify-website/create_index.pl localhost 9200 html/templates
</code></pre>
<p>脚本本身超级简单，欢迎大家自行阅读。</p>
      <a href="/2013/09/14/elasticsearch-for-rexify-website" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div class="full" style='background-color: #FFF;'>
    <h1 class="entry-title">
      <a href="/2013/09/10/different-format-character-of-pack-between-python-and-perl" title="Perl 和 Python 的 pack 函数格式字符的区别" rel="bookmark">Perl 和 Python 的 pack 函数格式字符的区别</a>
    </h1>
    <p class="alt-font tight">
      <span class="date full-date">
        <abbr class="published" title="2013-09-10 00:00:00 +0800">10 Sep 2013</abbr>
      </span>
      <span>
      </span>
      Posted in&nbsp;
      <a href="/categories.html#perl-ref" title="perl" rel="category tag">perl</a>
    </p>
    <div class="entry-content full-content" style='background-color: #FFF; margin-left: 24px; padding: 10px;'>
      <p>MooseFS 是运用很广泛的一个分布式文件系统，其自带有一个 python 写的 CGI 页面，可以查看集群状态。不过对于运维来说，这就不太方便纳入 nagios 等其他现有的监控体系中。好在既然它的 CGI 是 python 写的，那么自己照样临摹出一个监控脚本也不是太复杂。</p>
<p>其实整个数据是由 master 的 9421 端口进行 TCP 交互获取的，不过比较麻烦的是并不是普通文本流。CGI 中采用了 pack/unpack 函数来处理 TCP 包。根据数据的前 8 字节确定数据总长度和 MooseFS 的版本，然后依照不同版本的 pack 方式来 unpack 剩余内容。</p>
<p>笔者熟悉 Perl，所以就准备将这个处理流程改用 Perl 完成。结果发现原来 pack/unpack 在 Perl 和 Python 中，写法是不一样的。以 MooseFS 的 info 信息读取代码为例，Python 版如下：</p>
<div class="highlight"><pre><code class="python"><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">masterhost</span><span class="p">,</span> <span class="n">masterport</span><span class="p">))</span>
<span class="n">mysend</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&gt;LL&quot;</span><span class="p">,</span> <span class="mi">510</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">myrecv</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">cmd</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;&gt;LL&quot;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
<span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="mi">511</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">76</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">myrecv</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">memusage</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">avail</span><span class="p">,</span> <span class="n">trspace</span><span class="p">,</span> <span class="n">trfiles</span><span class="p">,</span> <span class="n">respace</span><span class="p">,</span> <span class="n">refiles</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">allcopies</span><span class="p">,</span> <span class="n">tdcopies</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;&gt;HBBQQQQLQLLLLLLL&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">ver</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">v3</span><span class="p">)])</span>
</code></pre></div>
<p>而 Perl 版最终写完是这样的：</p>
<div class="highlight"><pre><code class="perl"><span class="k">my</span> <span class="nv">$s</span> <span class="o">=</span> <span class="nn">IO::Socket::</span><span class="n">INET</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
    <span class="n">PeerAddr</span> <span class="o">=&gt;</span> <span class="nv">$host</span><span class="p">,</span>
    <span class="n">PeerPort</span> <span class="o">=&gt;</span> <span class="nv">$port</span><span class="p">,</span>
    <span class="n">Proto</span>    <span class="o">=&gt;</span> <span class="s">&#39;tcp&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
<span class="k">print</span> <span class="nv">$s</span> <span class="nb">pack</span><span class="p">(</span><span class="s">&#39;(LL)&gt;&#39;</span><span class="p">,</span> <span class="mi">510</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nb">sysread</span> <span class="nv">$s</span><span class="p">,</span> <span class="nv">$header</span><span class="p">,</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$cmd</span><span class="p">,</span> <span class="nv">$length</span><span class="p">)</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s">&#39;(LL)&gt;&#39;</span><span class="p">,</span> <span class="nv">$header</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span> <span class="nv">$cmd</span> <span class="o">==</span> <span class="mi">511</span> <span class="ow">and</span> <span class="nv">$length</span> <span class="o">==</span> <span class="mi">76</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nb">sysread</span> <span class="nv">$s</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$length</span><span class="p">;</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$v1</span><span class="p">,</span> <span class="nv">$v2</span><span class="p">,</span> <span class="nv">$v3</span><span class="p">,</span> <span class="nv">$memusage</span><span class="p">,</span> <span class="nv">$total</span><span class="p">,</span> <span class="nv">$avail</span><span class="p">,</span> <span class="nv">$trspace</span><span class="p">,</span> <span class="nv">$trfiles</span><span class="p">,</span> <span class="nv">$respace</span><span class="p">,</span> <span class="nv">$refiles</span><span class="p">,</span> <span class="nv">$nodes</span><span class="p">,</span> <span class="nv">$dirs</span><span class="p">,</span> <span class="nv">$files</span><span class="p">,</span> <span class="nv">$chunks</span><span class="p">,</span> <span class="nv">$allcopies</span><span class="p">,</span> <span class="nv">$tdcopies</span><span class="p">)</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s">&#39;(SCCQQQQLQLLLLLLL)&gt;&#39;</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$ver</span> <span class="o">=</span> <span class="s">&quot;$v1.$v2.$v3&quot;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>不同处主要有两点：</p>
<ol>
  <li>关于 <code>big-endian</code> 定义的 <code>&gt;</code> 符号位置不同，Python 里写在起首一次性全部生效；Perl 里需要每个格式符单独定义，或者采用括号合起来总定义；</li>
  <li>Python 里的 <code>H</code> 格式符表示 <code>unsigned short</code>，在 Perl 里应该是 <code>S</code>；Python 里的 <code>B</code> 格式符表示 <code>unsigned char</code>，在 Perl 里应该是 <code>C</code>。</li>
</ol>
<p>翻看了一下，在 PHP 和 Ruby 中，格式符定义和 Perl 是一样的，不清楚为什么 Python 这么特殊==!</p>
<p>各语言关于 <code>pack</code> 格式符的文档链接如下：</p>
<ol>
  <li><a href="http://www.w3school.com.cn/php/func_misc_pack.asp">http://www.w3school.com.cn/php/func_misc_pack.asp</a></li>
  <li><a href="http://www.kuqin.com/rubycndocument/man/pack_template_string.html">http://www.kuqin.com/rubycndocument/man/pack_template_string.html</a></li>
  <li><a href="http://docs.python.org/2/library/struct.html">http://docs.python.org/2/library/struct.html</a></li>
  <li><a href="http://perldoc.perl.org/functions/pack.html">http://perldoc.perl.org/functions/pack.html</a></li>
</ol>
      <a href="/2013/09/10/different-format-character-of-pack-between-python-and-perl" class="read_more span2 pull-right">继续阅读……</a>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>
  <div id="post-pagination" class="pagination pagination-centered">
  <ul class="pages nav nav-pills">
    <li>
      <a href="#">Previous</a>
    </li>
    <li class="page active">
      <a href="#">1</a>
    </li>
    <li class="page">
      <a href="/page2">2</a>
    </li>
    <li class="page">
      <a href="/page3">3</a>
    </li>
    <li class="page">
      <a href="/page4">4</a>
    </li>
    <li class="page">
      <a href="/page5">5</a>
    </li>
    <li class="page">
      <a href="/page6">6</a>
    </li>
    <li class="page">
      <a href="/page7">7</a>
    </li>
    <li class="page">
      <a href="/page8">8</a>
    </li>
    <li class="page">
      <a href="/page9">9</a>
    </li>
    <li class="page">
      <a href="/page10">10</a>
    </li>
    <li class="page">
      <a href="/page11">11</a>
    </li>
    <li class="page">
      <a href="/page12">12</a>
    </li>
    <li class="page">
      <a href="/page13">13</a>
    </li>
    <li class="page">
      <a href="/page14">14</a>
    </li>
    <li class="page">
      <a href="/page15">15</a>
    </li>
    <li class="page">
      <a href="/page16">16</a>
    </li>
    <li>
      <a href="/page2">Next</a>
    </li>
  </ul>
</div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
              <li><a href="http://showmetheco.de/" title="Viacheslav Tykhanovskyi(PocketIO/Text::Haml)">No time to wait</a></li>
              <li><a href="http://blog.dataloop.io/" title="A new SaaS monitoring tool for DevOps & Operations">Dataloop.IO</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://junqili.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.sectop.org/" title="">kindle</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
          </ul>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
