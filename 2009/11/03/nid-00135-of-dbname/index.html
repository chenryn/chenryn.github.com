<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>修改dbname常见的一个错误NID-00135及解决…</title>
    
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
            
            
            
  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://feed.feedsky.com/chenlinux" rel="alternate" /><a href="http://feed.feedsky.com/chenlinux" target="_blank">RSS订阅</a></li>
            <li><a href="/links.html">友情链接</a></li>
            <li><a href="/projects.html">学习记录</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
        
<div class="row">
  <div class="page-header">
    <h1>修改dbname常见的一个错误NID-00135及解决… <small></small></h1>
    <div class="date"><span>03 November 2009</span></div>
  
    <ul class="tag_box pull-right">
    
    
  
     
    	<li><a href="/tags.html#oracle-ref">oracle <span>1</span></a></li>
    
  
    </ul>
    
  </div>
  <div style='background-color: #FFF;'>
    <p>oracle自带有nid用以修改dbname。查看其命令语法如下表所示：</p>
<pre><code>DBNEWID: Release 10.2.0.4.0 - Production on Wed Jun 24 20:06:08 2009
Copyright (c) 1982, 2007,
Oracle.    All
rights reserved.
Keyword
Description                                        (Default)
----------------------------------------------------
TARGET            Username/Password                            (NONE)
DBNAME            New
database name                            (NONE)
LOGFILE
Output Log
(NONE)
REVERT            Revert
failed
change
NO
SETNAME
Set a new database name
only
NO
APPEND            Append
to output log
NO
HELP                Displays
these
messages                NO 其动作描述用“=”表示。
</code></pre>
<p>假设某oracle数据库sys密码为123456，欲更名dbname为aaa，则其修改dbname的命令应如下行所示：</p>
<p>nid target=sys/123456 dbname=aaa</p>
<p>网上关于修改dbname的博客文章和论坛问答，基本都是在windows平台上的操作。其提示要点，在于运行nid系统命令之前，必须将数据库置于mount状态下。以此类推，在linux下的操作步骤，应该如下：</p>
<div class="highlight"><pre><code class="sql"><span class="k">sql</span> <span class="o">&gt;</span> <span class="n">shutdown</span>
<span class="k">immediate</span><span class="p">;</span>
<span class="k">sql</span> <span class="o">&gt;</span> <span class="n">startup</span> <span class="n">mount</span><span class="p">;</span>
<span class="k">sql</span> <span class="o">&gt;</span> <span class="k">host</span> <span class="n">nid</span> <span class="n">target</span><span class="o">=</span><span class="n">sys</span><span class="o">/</span><span class="mi">123456</span> <span class="n">dbname</span><span class="o">=</span><span class="n">aaa</span>
</code></pre></div>
<p>但我按此步骤进行之后，却提示如下字段：
    NID-00135: There are 1 active threads
    Change of database name failed during validation - database is
    intact.
    DBNEWID - Completed with validation errors.
经过多机试验，发现这个错误并非偶然出现一两次而已，至于windows平台下，为何无人提起，就有待日后研究了。
关于这个错误，关键是检查两个地方。
第一是表空间与数据文件的状态：
    SQL&gt; select
    file#,status,name from
    v$datafile;
    FILE#
    STATUS    NAME
    &mdash;&mdash;&mdash;- &mdash;&mdash;-
    &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;
    1
    SYSTEM    /u01/app/oracle/oradata/db1/system01.dbf
    2
    ONLINE    /u01/app/oracle/oradata/db1/undotbs01.dbf
    3
    ONLINE    /u01/app/oracle/oradata/db1/sysaux01.dbf
    4
    ONLINE    /u01/app/oracle/oradata/db1/usertbs.dbf
    5
    ONLINE    /u01/app/oracle/oradata/db1/raocl.dbf
正常情况下，其状态应该是online或者offline。但如果因为历史操作的原因，导致某数据文件的状态变成了recovery，那么就会出问题了。
解决方法也简单，drop掉出错的数据文件就行了。
第二是归档文件的设置：
    SQL&gt; archive log
    list
    Database log
    mode                            Archive
    Mode
    Automatic
    archival
    Enabled
    Archive
    destination                        /u01/app/oracle/product/10.2.0/db1/dbs/arch
    Oldest online log
    sequence
    31
    Next log sequence to
    archive
    33
    Current log
    sequence
    33
    SQL&gt; host ls $ORACLE_HOME/dbs
    alert_db1.log
    arch1<em>29</em>689269707.dbf    control01.ctl
    initdw.ora    spfiledb1.ora.bak
    arch1<em>25</em>689269707.dbf    arch1<em>30</em>689269707.dbf    control02.ctl
    init.ora
    arch1<em>26</em>689269707.dbf    arch1<em>31</em>689269707.dbf    db1<em>ora</em>4704.trc    lkAAA
    arch1<em>27</em>689269707.dbf    arch1<em>32</em>689269707.dbf    hc_db1.dat                lkDB1
    arch1<em>28</em>689269707.dbf    cntrldb1.dbf                        initdb1.ora
    orapwdb1
如果没有设置归档文件路径或者没有归档文件存在，nid也会出错。
设置归档文件模式、路径并手工归档的命令分别如下：
    SQL&gt; alter database archivelog;
    SQL&gt; alter system
    set log_archive_dest_1=&rsquo;location=/u01/app/oracle/oradata/db1/arch&rsquo;;
    SQL&gt; alter system
    archive log current;
注意：归档文件模式也要在mount下设置。
确认完成这两步以后，在重新运行nid系统命令，出现如下字段，即可成功更改dbname了。
    Control Files in database:
    /u01/app/oracle/product/10.2.0/db1/dbs/control01.ctl
    /u01/app/oracle/product/10.2.0/db1/dbs/control02.ctl
    Change database ID and database
    name DB1 to AAA? (Y/[N]) =&gt; Y
    Proceeding with operation
    Changing database ID from 1283133323 to
    1845742016
    Changing database name from DB1
    to AAA
    Control
    File
    /u01/app/oracle/product/10.2.0/db1/dbs/control01.ctl -
    modified
    Control
    File
    /u01/app/oracle/product/10.2.0/db1/dbs/control02.ctl -
    modified
    Datafile
    /u01/app/oracle/oradata/db1/system01.dbf - dbid changed, wrote new
    name
    Datafile
    /u01/app/oracle/oradata/db1/undotbs01.dbf - dbid changed, wrote new
    name
    Datafile
    /u01/app/oracle/oradata/db1/sysaux01.dbf - dbid changed, wrote new
    name
    Datafile
    /u01/app/oracle/oradata/db1/usertbs.dbf - dbid changed, wrote new
    name
    Datafile
    /u01/app/oracle/oradata/db1/raocl.dbf - dbid changed, wrote new
    name
    Datafile
    /u01/app/oracle/oradata/db1/temp01.dbf - dbid changed, wrote new
    name
    Control
    File
    /u01/app/oracle/product/10.2.0/db1/dbs/control01.ctl - dbid
    changed, wrote new name
    Control
    File
    /u01/app/oracle/product/10.2.0/db1/dbs/control02.ctl - dbid
    changed, wrote new name
    Instance
    shut down
    Database name changed to
    AAA.
    Modify parameter file and generate a new password file before restarting.
    Database ID for database AAA
    changed to 1845742016.
    All previous backups and archived redo logs for this database are
    unusable.
    Database has been shutdown, open
    database with RESETLOGS option.
    Succesfully changed database
    name and
    ID.
    DBNEWID - Completed succesfully.
至于引起这个错误的深层次原因，从之前有过的其他操作猜测，会不会是scn不一致的原因？？如果是这个原因，那或许只要很简单的CKPT就可以了。找时间试验一下。</p>
    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2009/11/03/learning-sed" title="sed使用">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2009/11/03/priority-of-squid-domain-resolve" title="squid问题-域名解析">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    
  <!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" id="UYScript" src="http://v1.uyan.cc/js/iframe.js?UYUserId=1589850" async=""></script>
<!-- UY END -->
  </div>
</div>
  
      </div>
      <div class="span4">
          
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
               
                 <li> <a href="/2013/03/18/logrotate-configuration-files-mode">logrotate 配置文件强制为 0644 属性</a></li>
               
                 <li> <a href="/2013/03/15/puppet-provider-development">Puppet 自定义 Provider</a></li>
               
                 <li> <a href="/2013/03/14/JPush-example">极光推送demo</a></li>
               
                 <li> <a href="/2013/02/25/nginx-testing-10Gibps">Nginx 万兆网络环境测试</a></li>
               
                 <li> <a href="/2013/02/22/setup-stf2">STF 2.0 安装测试</a></li>
               
                 <li> <a href="/2013/01/31/puppet-define-type-and-custom-function">Puppet 自定义 type 和 function</a></li>
               
                 <li> <a href="/2013/01/11/systemtap-to-debug-kmsg-dump">用 systemtap 调试 kmsg dump</a></li>
               
                 <li> <a href="/2013/01/10/update-puppet-to-3.0">升级 Puppet 到 3.0 及其他附件简介</a></li>
               
                 <li> <a href="/2013/01/10/rspec-puppet-intro">给 puppet 写 Rspec 测试用例</a></li>
               
            </ul>
          </div>
        
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
