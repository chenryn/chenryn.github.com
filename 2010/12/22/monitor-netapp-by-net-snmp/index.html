<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>通过snmp协议监控NetApp</title>
    <meta name="author" content="陈子">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments/default.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">三斗室</a>
          <ul class="nav">
      	<li><a href="/tags.html">Tags</a></li>
      	<li><a href="/archive.html">Archive</a></li>
      	<li><a href="/categories.html">Categories</a></li>
      	<li><a href="/pages.html">Pages</a></li>
            <li><link title="RSS 2.0" type="application/rss+xml" href="http://chenlinux.com/feed.xml" rel="alternate" /><a href="http://chenlinux.com/feed.xml" target="_blank">RSS订阅</a></li>
            <li><a href="/projects.html">学习记录</a></li>
            <li><a href="/errata.html">《网站运维技术与实践》勘误</a></li>
          </ul>
          <ul class="nav pull-right"><li><a href="/about.html">有关我</a></li></ul>
        </div>
      </div>
    </div>
    <div class="container">
    <div class="row">
      <div class="span7">
<div class="row">
  <div class="page-header">
    <h1>通过snmp协议监控NetApp <small></small></h1>
    <div class="date"><span>22 December 2010</span></div>
    <ul class="tag_box pull-right">
    	<li><a href="/tags.html#snmp-ref">snmp <span>5</span></a></li>
    	<li><a href="/tags.html#NetApp-ref">NetApp <span>2</span></a></li>
    </ul>
  </div>
  <div style='background-color: #FFF;'>
    <p>NetApp作为专业存储，用起来还是比较让人放心的，不过放心不代表放手不管，一些重要的监控还是要做的。比如基本的CPU负载、网卡流量、磁盘使用率，作为数据存储特别关注的IOPS、DiskIO（因为有cache的原因，所以NetIO和DiskIO是不同时的，单从网卡进出不能判定磁盘的真实读写）。</p>
<p>从google中找到了NetApp的MIBtree，见<a href="https://support.ipmonitor.com/mibs/NETWORK-APPLIANCE-MIB/tree.aspx">https://support.ipmonitor.com/mibs/NETWORK-APPLIANCE-MIB/tree.aspx</a>或<a href="http://www.mibdepot.com/cgi-bin/getmib3.cgi?abc=0&amp;n=NETWORK-APPLIANCE-MIB&amp;r=netapp&amp;f=netapp_1_4.mib&amp;t=tree&amp;v=v1&amp;i=0&amp;obj=cp">http://www.mibdepot.com/cgi-bin/getmib3.cgi?abc=0&amp;n=NETWORK-APPLIANCE-MIB&amp;r=netapp&amp;f=netapp<em>1</em>4.mib&amp;t=tree&amp;v=v1&amp;i=0&amp;obj=cp</a></p>
<p>（多贴一个，省的万一哪个站挂了……）</p>
<p>CPU等项没什么问题，问题在于IO的获取。
与普通服务器的流量一样，很明显的看到了miscNfsOps、miscNetRcvdKB和miscNetSentKB三个值。我们可以很简单的通过后个值的差值运算出速率。但如果单取一个值的时候，会发现一个很诡异的情况，见下：</p>
<h1 id="snmpwalk--v-1--c-public-101010118-1361417891223--awk-print-nf">snmpwalk -v 1 -c public 10.10.10.118 .1.3.6.1.4.1.789.1.2.2.3 | awk &lsquo;{print $NF}&rsquo;</h1>
<p>-1948753579</p>
<p>居然是个负值！</p>
<p>难道是对这个MIB的理解有问题？可通过如下命令计算的结果，和通过交换机端口获取的流量却基本符合了：</p>
<p>a=<code>snmpwalk -v 1 -c public 10.10.10.118 .1.3.6.1.4.1.789.1.2.2.3 | awk '{print $NF}'</code>;sleep 10;snmpwalk -v 1 -c public 10.10.10.118 .1.3.6.1.4.1.789.1.2.2.3 | awk &lsquo;{print ($NF-&ldquo;&lsquo;$a&rsquo;&rdquo;)*8/10&rdquo;Kbps&rdquo;}&rsquo;
12364.8Kbps</p>
<p>虽然数值都变负了，但差量还是对的……汗，如果通过AVERAGE方式取这个差值绘图，倒不要紧，如果通过普通的流量Counter方式，这个图全反过X轴去了应该~</p>
<p>这个情况很容易让我想到用cacti获取网卡流量时的配置，如果选用默认的32bits绘图时，在流量较大时也会出现这类负值或者干脆画不出来的情况。</p>
<p>其次，DiskIO没有和Net一样的MIB；但net、disk和ops都有一对miscHigh<strong><em>/miscLow</em></strong>的数值。</p>
<p>这对值怎么用？MIB上的解释看起来超级茫然：
miscLowNfsOps：The total number of Server side NFS calls since the last boot.  This object returns the least significant 32 bits of the value.
miscHighNfsOps：The total number of Server side NFS calls since the last boot.  This object returns the most significant 32 bits of the value.</p>
<p>通过度娘了解了一下least significant bit和most significant bit的概念，原来LSB和MSB是在底层开发时的概念，因为2进制的字串比较长，所以通过MSB和LSB的命名方式来标明字串的高位（普通PC和MAC在存数据的时候顺序是反的，所以必须标记，还有其他原因，比如用MSB的1、0来表示正负数等）</p>
<p>那么这个most significant 32bits也就理解了~~就是从高位开始往低算的32位。least反过来……合并起来就是64位的完成数据了……2进制数的合并，也就是说用$MSBs * 2**32 + $LSBs。My God~</p>
<p>最后在zenoss的maillist上看到了相同的问题，其中网友的回答是：NetApp使用的snmp协议是v1版本，无法直接提供64bits的计数，只能变通一下，改用这种拆分方式了。</p>
<p>最后，举例一个监控ops的perl脚本。原脚本是centreon项目提供的，删除了一些和ops无关的语句。从中也可以学到Net::SNMP模块的使用，hash的解引用等~</p>
<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/perl -w</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Net::</span><span class="n">SNMP</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Long</span><span class="p">;</span>
<span class="k">use</span> <span class="n">lib</span> <span class="s">&quot;/usr/local/nagios/libexec&quot;</span><span class="p">;</span>
<span class="k">use</span> <span class="n">utils</span> <span class="sx">qw(%ERRORS $TIMEOUT)</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$o_host</span> <span class="o">=</span> <span class="err"> </span> <span class="err"> </span><span class="nb">undef</span><span class="p">;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="c1"># hostname</span>
<span class="k">my</span> <span class="nv">$o_community</span> <span class="o">=</span> <span class="nb">undef</span><span class="p">;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="c1"># community</span>
<span class="k">my</span> <span class="nv">$o_port</span> <span class="o">=</span> <span class="err"> </span> <span class="err"> </span><span class="mi">161</span><span class="p">;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="c1"># port</span>
<span class="k">my</span> <span class="nv">$o_warn</span> <span class="o">=</span> <span class="err"> </span> <span class="err"> </span><span class="nb">undef</span><span class="p">;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="c1"># warning limit</span>
<span class="k">my</span> <span class="nv">$o_crit</span><span class="o">=</span> <span class="err"> </span> <span class="err"> </span> <span class="nb">undef</span><span class="p">;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="c1"># critical limit</span>
<span class="k">my</span> <span class="nv">$o_timeout</span><span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$exit_code</span> <span class="o">=</span> <span class="nb">undef</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$o_type</span><span class="o">=</span><span class="nb">undef</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$output</span><span class="o">=</span><span class="nb">undef</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$o_perf</span><span class="o">=</span> <span class="nb">undef</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%oids</span> <span class="o">=</span> <span class="p">(</span>
<span class="s">&#39;cpuUsage&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.1.3.0&quot;</span><span class="p">,</span>
<span class="s">&#39;globalStatus&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.4.0&quot;</span><span class="p">,</span>
<span class="s">&#39;nfsHighOps&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.5.0&quot;</span><span class="p">,</span>
<span class="s">&#39;nfsLowOps&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.6.0&quot;</span><span class="p">,</span>
<span class="s">&#39;netRecHighBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.11.0&quot;</span><span class="p">,</span>
<span class="s">&#39;netRecLowBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.12.0&quot;</span><span class="p">,</span>
<span class="s">&#39;netSentHighBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.13.0&quot;</span><span class="p">,</span>
<span class="s">&#39;netSentLowBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.14.0&quot;</span><span class="p">,</span>
<span class="s">&#39;diskReadHighBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.15.0&quot;</span><span class="p">,</span>
<span class="s">&#39;diskReadLowBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.16.0&quot;</span><span class="p">,</span>
<span class="s">&#39;diskWriteHighBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.17.0&quot;</span><span class="p">,</span>
<span class="s">&#39;diskWriteLowBytes&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="s">&quot;.1.3.6.1.4.1.789.1.2.2.18.0&quot;</span><span class="p">,</span>
<span class="p">);</span>
<span class="k">my</span> <span class="nv">@oidlist</span><span class="o">=</span><span class="p">(</span><span class="nv">$oids</span><span class="p">{</span><span class="n">nfsHighOps</span><span class="p">},</span><span class="nv">$oids</span><span class="p">{</span><span class="n">nfsLowOps</span><span class="p">});</span>
<span class="k">sub </span><span class="nf">check_options</span> <span class="p">{</span>
<span class="nn">Getopt::Long::</span><span class="n">Configure</span> <span class="p">(</span><span class="s">&quot;bundling&quot;</span><span class="p">);</span>
<span class="n">GetOptions</span><span class="p">(</span>
<span class="s">&#39;H:s&#39;</span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_host</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="s">&#39;hostname:s&#39;</span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_host</span><span class="p">,</span>
<span class="s">&#39;p:i&#39;</span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_port</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="s">&#39;port:i&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_port</span><span class="p">,</span>
<span class="s">&#39;C:s&#39;</span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_community</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="s">&#39;community:s&#39;</span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_community</span><span class="p">,</span>
<span class="s">&#39;c:s&#39;</span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_crit</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="s">&#39;critical:s&#39;</span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_crit</span><span class="p">,</span>
<span class="s">&#39;w:s&#39;</span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_warn</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="s">&#39;warn:s&#39;</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$o_warn</span><span class="p">,</span>
<span class="c1">#       &#39;T:s&#39;   =&gt; \$o_type,</span>
<span class="p">);</span>
<span class="p">}</span>
<span class="c1">########## MAIN #######</span>
<span class="n">check_options</span><span class="p">();</span>
<span class="c1"># Connect to host</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$session</span><span class="p">,</span><span class="nv">$error</span><span class="p">);</span>
<span class="c1">#关键点：创建一个session连接被监控主机</span>
<span class="p">(</span><span class="nv">$session</span><span class="p">,</span> <span class="nv">$error</span><span class="p">)</span> <span class="o">=</span> <span class="nn">Net::</span><span class="n">SNMP</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">(</span>
<span class="o">-</span><span class="n">hostname</span> <span class="err"> </span><span class="o">=&gt;</span> <span class="nv">$o_host</span><span class="p">,</span>
<span class="o">-</span><span class="n">community</span> <span class="o">=&gt;</span> <span class="nv">$o_community</span><span class="p">,</span>
<span class="o">-</span><span class="n">port</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span><span class="o">=&gt;</span> <span class="nv">$o_port</span><span class="p">,</span>
<span class="o">-</span><span class="n">timeout</span> <span class="err"> </span> <span class="o">=&gt;</span> <span class="nv">$o_timeout</span>
<span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$session</span><span class="p">))</span> <span class="p">{</span>
<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;ERROR: %s.\n&quot;</span><span class="p">,</span> <span class="nv">$error</span><span class="p">);</span>
<span class="nb">exit</span> <span class="nv">$ERRORS</span><span class="p">{</span><span class="s">&quot;UNKNOWN&quot;</span><span class="p">};</span>
<span class="p">}</span>
<span class="k">my</span> <span class="nv">$resultat</span><span class="o">=</span><span class="nb">undef</span><span class="p">;</span>
<span class="c1"># Get rid of UTF8 translation in case of accentuated caracters (thanks to Dimo Velev).</span>
<span class="c1">#这里没太看懂perldoc，猜测是不开启MIB和oid的转换，这样输出结果比较简洁，不过注释掉这句运行结果毫无影响</span>
<span class="nv">$session</span><span class="o">-&gt;</span><span class="n">translate</span><span class="p">(</span><span class="nn">Net::</span><span class="n">SNMP</span><span class="o">-&gt;</span><span class="n">TRANSLATE_NONE</span><span class="p">);</span>
<span class="c1">#取值的关键，get_request返回一个hash的引用。</span>
<span class="c1">#perldoc的原文是：“A reference to a hash is returned in blocking mode which contains the contents of the VarBindList.  In non-blocking mode, a true value is returned when no error has occurred.”</span>
<span class="c1">#get_request()中-callback和-delay是non-blocking模式的，而\@oids是blocking模式。</span>
<span class="c1">#也就是说这个脚本里返回的是一个引用。</span>
<span class="k">if</span> <span class="p">(</span><span class="nn">Net::</span><span class="n">SNMP</span><span class="o">-&gt;</span><span class="n">VERSION</span> <span class="o">&amp;</span><span class="ow">lt</span><span class="p">;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
<span class="nv">$resultat</span> <span class="o">=</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="n">get_request</span><span class="p">(</span><span class="nv">@oidlist</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="nv">$resultat</span> <span class="o">=</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="n">get_request</span><span class="p">(</span><span class="o">-</span><span class="n">varbindlist</span> <span class="err"> </span><span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@oidlist</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$resultat</span><span class="p">))</span> <span class="p">{</span>
<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;ERROR: Description/Type table : %s.\n&quot;</span><span class="p">,</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
<span class="nv">$session</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">;</span>
<span class="nb">exit</span> <span class="nv">$ERRORS</span><span class="p">{</span><span class="s">&quot;UNKNOWN&quot;</span><span class="p">};</span>
<span class="p">}</span>
<span class="nv">$session</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$new_nfs_ops</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$left_shift</span><span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$last_nfs_ops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$row</span> <span class="p">;</span>
<span class="k">my</span> <span class="err"> </span><span class="nv">$last_check_time</span> <span class="p">;</span>
<span class="k">my</span> <span class="err"> </span><span class="nv">$update_time</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@last_values</span><span class="o">=</span><span class="nb">undef</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$flg_created</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">#解引用关键点：对%$resultat的解引用$$resultat{$oids{nfsHighOps}}，其中$oids{nfsHighOps}是另一个hash——%oids中的值。</span>
<span class="c1">#可以采用foreach my $value ( values %$resultat ) { print &quot;$value\n&quot;; }的方式列出hash中的各个值。</span>
<span class="c1">#按照MSBs和LSBs的划分方法，通过2**32的方式合并得到64bits计数。</span>
<span class="nv">$new_nfs_ops</span><span class="o">=</span> <span class="nv">$$resultat</span><span class="p">{</span><span class="nv">$oids</span><span class="p">{</span><span class="n">nfsHighOps</span><span class="p">}}</span> <span class="o">*</span> <span class="err"> </span><span class="nv">$left_shift</span> <span class="err"> </span><span class="o">+</span> <span class="err"> </span><span class="nv">$$resultat</span><span class="p">{</span><span class="nv">$oids</span><span class="p">{</span><span class="n">nfsLowOps</span><span class="p">}};</span>
<span class="c1">#输出到文本文件，因为是给nagios做监控脚本，所以必须通过差值的方式计算average型数值，而不像cacti绘图时那样可以直接传递counter型数值。</span>
<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">e</span> <span class="s">&quot;/tmp/traffic_ops_&quot;</span><span class="o">.</span><span class="nv">$o_host</span><span class="p">)</span> <span class="p">{</span>
<span class="nb">open</span><span class="p">(</span><span class="n">FILE</span><span class="p">,</span><span class="s">&quot;&amp;lt;&quot;</span><span class="o">.</span><span class="s">&quot;/tmp/traffic_ops_&quot;</span><span class="o">.</span><span class="nv">$o_host</span><span class="p">);</span>
<span class="k">while</span><span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="ow">lt</span><span class="p">;</span><span class="n">FILE</span><span class="o">&gt;</span><span class="p">){</span>
<span class="nv">@last_values</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="nv">$row</span><span class="p">);</span>
<span class="nv">$last_check_time</span> <span class="o">=</span> <span class="nv">$last_values</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="nv">$last_nfs_ops</span> <span class="o">=</span> <span class="nv">$last_values</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="nv">$flg_created</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="nb">close</span><span class="p">(</span><span class="n">FILE</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="nv">$flg_created</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$update_time</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<span class="k">unless</span> <span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">FILE</span><span class="p">,</span><span class="s">&quot;&gt;&quot;</span><span class="o">.</span><span class="s">&quot;/tmp/traffic_ops_&quot;</span><span class="o">.</span><span class="nv">$o_host</span><span class="p">)){</span>
<span class="k">print</span> <span class="s">&quot;Check mod for temporary file : /tmp/traffic_ops_&quot;</span><span class="o">.</span><span class="nv">$o_host</span><span class="o">.</span> <span class="s">&quot; !\n&quot;</span><span class="p">;</span>
<span class="nb">exit</span> <span class="nv">$ERRORS</span><span class="p">{</span><span class="s">&quot;UNKNOWN&quot;</span><span class="p">};</span>
<span class="p">}</span>
<span class="k">print</span> <span class="n">FILE</span> <span class="s">&quot;$update_time:$new_nfs_ops:$new_cifs_ops&quot;</span><span class="p">;</span>
<span class="nb">close</span><span class="p">(</span><span class="n">FILE</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$flg_created</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
<span class="k">print</span> <span class="s">&quot;First execution : Buffer in creation.... \n&quot;</span><span class="p">;</span>
<span class="nb">exit</span><span class="p">(</span><span class="nv">$ERRORS</span><span class="p">{</span><span class="s">&quot;UNKNOWN&quot;</span><span class="p">});</span>
<span class="p">}</span>
<span class="k">my</span> <span class="nv">$nfs_diff</span><span class="o">=</span><span class="nv">$new_nfs_ops</span> <span class="o">-</span> <span class="nv">$last_nfs_ops</span><span class="p">;</span>
<span class="nv">$nfs_diff</span><span class="o">=</span><span class="nv">$new_nfs_ops</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$nfs_diff</span> <span class="o">&amp;</span><span class="ow">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$time_diff</span><span class="o">=</span><span class="nv">$update_time</span> <span class="o">-</span> <span class="nv">$last_check_time</span><span class="p">;</span>
<span class="nv">$time_diff</span><span class="o">=</span><span class="nv">$update_time</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$time_diff</span> <span class="o">&amp;</span><span class="ow">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$nfs_ops</span> <span class="o">=</span> <span class="nv">$nfs_diff</span> <span class="o">/</span> <span class="p">(</span> <span class="nv">$time_diff</span> <span class="p">);</span>
<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;Nfs ops : %.2f ops/sec &quot;</span><span class="p">,</span> <span class="nv">$nfs_ops</span><span class="p">);</span>
<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;|nfsOps=&quot;</span><span class="o">.</span><span class="nv">$nfs_ops</span><span class="o">.</span><span class="s">&quot;\n&quot;</span><span class="p">);</span>
<span class="nb">exit</span><span class="p">(</span><span class="nv">$ERRORS</span><span class="p">{</span><span class="s">&quot;OK&quot;</span><span class="p">});</span>
</code></pre></div>
    <hr>
    <div class="pagination">
      <ul>
        <li class="prev"><a href="/2010/12/16/diff-between-for-while" title="for/while循环的区别">&larr; Previous</a></li>
        <li><a href="/archive.html">Archive</a></li>
        <li class="next"><a href="/2010/12/23/diff-between-wget-curl" title="wget和curl测试时的小区别">Next &rarr;</a></li>
      </ul>
    </div>
    <hr>
  <!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" id="UYScript" src="http://v1.uyan.cc/js/iframe.js?UYUserId=1589850" async=""></script>
<!-- UY END -->
  </div>
</div>
      </div>
      <div class="span4">
          <div class="well sidebar-nav">
             <ul id="relate_blog" class="nav nav-list">
               <li class="nav-header">最近文章</li>
                 <li><a href="/2014/04/16/tcp-fastopen">TCP Fast Open 测试(1)</a></li>
                 <li><a href="/2014/04/07/perlchina-mini-workshop-with-larry-wall">Larry Wall 来中国参加 OSTC 和 PerlChina Workshop</a></li>
                 <li><a href="/2014/03/30/qcloud-tech">腾讯云技术沙龙笔记</a></li>
                 <li><a href="/2014/03/10/source-filter-in-perl5">Perl5 的 Source Filter 功能</a></li>
                 <li><a href="/2014/03/09/thoughts-after-docker-meetup">Docker Meetup 参会总结</a></li>
                 <li><a href="/2014/03/07/howto-search-dynamic-url-in-elasticsearch">如何搜索 Elasticsearch 中存储的动态请求 URL</a></li>
                 <li><a href="/2014/03/07/genarate-fig-from-diagramo">转换 diagramo 绘制的拓扑图成 fig.yml 格式</a></li>
                 <li><a href="/2014/02/20/gearman-task-priority">Gearman 任务的优先级</a></li>
                 <li><a href="/2014/02/20/diff-between-lsddistid-and-operatingsystem-facts-variables">Facts 变量中 lsbdistid 和 operatingsystem 的区别</a></li>
            </ul>
          </div>
        <div class="well sidebar-nav">
          <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1035836154&verifier=a26926d5&dpc=1"></iframe>
        </div>
        <div class="well sidebar-nav">
            <!--以下是QQ邮件列表订阅嵌入代码-->
            <script >var nId = "86cca8e03c1002936e00aaa28bd933c15c4a437a5e63cafd",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅logstash/ElasticSearch相关讨论：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
        </div>
        <div class="well sidebar-nav">
            <div id="uyan_list_time_frame"></div>
            <script type="text/javascript" id="UYScriptTime" src="http://v1.uyan.cc/js/iframe_time_list.js?UYUserId=1589850&rankType=time" async=""></script>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(英文)</li>
              <li><a href="http://codeascraft.com/" title="Etsy 运维团队博客">Code as Craft</a></li>
              <li><a href="http://blog.dotcloud.com/" title="dotCloud 官方博客">dotCloud-Blog</a></li>
              <li><a href="http://devopsanywhere.blogspot.jp/" title="">devopsanywhere</a></li>
              <li><a href="http://www.jedi.be/blog/" title="">Jong En Dynamische Informatica</a></li>
              <li><a href="http://www.planetdevops.net/" title="">planetdevops</a></li>
              <li><a href="http://www.kitchensoap.com/" title="《网站运维》作者，Etsy 运维">Kitchen Soap</a></li>
              <li><a href="http://blog.johngoulah.com" title="Musings of linux, open source, cloud computing and systems">John Goulah</a></li>
              <li><a href="http://serverfault.com/" title="stackexchange下属的系统工程师问答网站">serverfault</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://neilb.org/" title="The good,the bad,and the beautiful">neilb</a></li>
              <li><a href="http://blog.aka-cool.net/" title="">Aka.Why</a></li>
              <li><a href="http://www.reddit.com/r/perl/" title="">reddit perl 频道</a></li>
              <li><a href="http://jpetazzo.github.io/" title="">~jpetazzo</a></li>
              <li><a href="http://www.perfplanet.com/" title="News and views from the web performance blogosphere">Performance Planet</a></li>
              <li><a href="http://cuddletech.com/blog/" title="Use UNIX or die">Cuddle Tech</a></li>
              <li><a href="http://showmetheco.de/" title="Viacheslav Tykhanovskyi(PocketIO/Text::Haml)">No time to wait</a></li>
              <li><a href="http://blog.dataloop.io/" title="A new SaaS monitoring tool for DevOps & Operations">Dataloop.IO</a></li>
              <li><a href="http://www.ducea.com/" title="">MDLog:/sysadmin</a></li>
              <li><a href="http://www.thegeekstuff.com/" title="各种超酷Linux命令用法">TheGeekStuff</a></li>
              <li><a href="http://planeteria.org/perl6/" title="Perl6 文集">Planet Perl 6</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="linklists" class="nav nav-list">
            <li class="nav-header">友情链接(中文)</li>
              <li><a href="http://www.nginxs.com/" title="">eric</a></li>
              <li><a href="http://www.hellodb.net/" title="Ali DBA 张瑞">Hello DBA</a></li>
              <li><a href="http://blog.nosqlfan.com/" title="not only sql信息集散地">NoSQLfan</a></li>
              <li><a href="http://ourmysql.com/" title="">OurMySQL</a></li>
              <li><a href="http://zauc.wordpress.com/" title="">Timo</a></li>
              <li><a href="http://julyclyde.org/" title="新浪系统工程师">七月的夏天</a></li>
              <li><a href="http://www.liurongxing.com/" title="">刘荣星</a></li>
              <li><a href="http://blog.s135.com/" title="金山·张宴">回忆未来</a></li>
              <li><a href="http://www.cnadn.net/" title="F5工程师">应用交付学习之路</a></li>
              <li><a href="http://scmbob.org/" title="杭州NSN工程师，shell高人~">扛一肩记忆</a></li>
              <li><a href="http://www.php-oa.com/" title="音悦台技术经理">扶凯</a></li>
              <li><a href="http://www.wenzizone.cn/" title="">蚊子世界</a></li>
              <li><a href="http://blog.liuts.com/" title="前天涯SA 刘天斯">运维进行时</a></li>
              <li><a href="http://www.lark.net.cn/" title="lark's cloud">lark's cloud</a></li>
              <li><a href="http://log.heartoutside.com/" title="HeartOutSide">HeartOutside</a></li>
              <li><a href="http://blog.liulantao.com/" title="刘兰涛">Lax</a></li>
              <li><a href="http://niubie.me/" title="莫言">莫言</a></li>
              <li><a href="http://noops.me/" title="小米运维部">NoOps</a></li>
              <li><a href="http://www.searchtech.pro/" title="">云端分布式搜索技术</a></li>
              <li><a href="http://www.usefulshare.com" title="当当网安全运维">UsefulShare</a></li>
              <li><a href="http://junqili.com/" title="深入研究puppet">纸飞机</a></li>
              <li><a href="http://www.chinaxing.org/" title="">ChinaXing</a></li>
              <li><a href="http://blog.sectop.org/" title="">kindle</a></li>
              <li><a href="http://bubbyroom.com/" title="守住每一天">Liuyu's blog</a></li>
          </ul>
        </div>
        <div class="well sidebar-nav">
          <ul id="booklists" class="nav nav-list">
          <li class="nav-header">我写的第一本技术书籍</li>
          <li><a href='http://product.china-pub.com/3769604'><img src='http://images.china-pub.com/ebook3765001-3770000/3769604/shupi.jpg' border='0' alt='网站运维技术与实践'/></a></li>
        </div>
      </div>
    </div> <!-- row -->
      <footer>
        <p>&copy; 陈子 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
    <!-- JiaThis Button BEGIN -->
    <script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1589850" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <!-- UJian Button BEGIN -->
    <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&uid=1589850"></script>
    <!-- UJian Button END -->
  </body>
</html>
